<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Street Training Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --text--dark--50: #19191e;
    --brand--black: #242326;
    --text--dark--40: #4c4d57;
    --text--dark--30: #777989;
    --card-light-grey: #f8f8f8;
    --text--white--30: #979797;
    --text--light--40: #b2b2b2;
    --accent--blue--300: #527dff;
    --accent-blue--200: #7a9cff;
    --text--dark--20: #a8aabb;
    --action-primary-blue: #2147f4;
    --light-grey: #ccc;
    --text-dark-10: #dfe0ec;
    --ui--underline--light-grey: #e5e5e5;
    --success-green: #bde4b9;
    --brand--yellow: #f1c238;
    --brand-accent--mandarin-light: #f6be9d;
    --accent-blue--100: #a3baff;
    --brand-accent--dusty-red-light: #f9b4bc;
    --brand--secondary--lightgreen: #beffd8;
    --accent-blue--50: #b8caff;
    --white-smoke: #fde8eb;
    --brand-accent--cream: #f5ede5;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: Arial, "Helvetica Neue", Helvetica, sans-serif; font-size: 14px; line-height: 20px; color: #333; background-color: #fff; min-height: 100vh; }
  .header { background: var(--brand--black); color: #fff; height: 52px; display: flex; align-items: center; padding: 0 24px; gap: 16px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #3a3a3a; }
  .hamburger-btn { background: none; border: none; cursor: pointer; padding: 6px; display: flex; flex-direction: column; gap: 4px; border-radius: 4px; transition: background 0.15s; }
  .hamburger-btn:hover { background: rgba(255,255,255,0.1); }
  .hamburger-btn span { display: block; width: 18px; height: 2px; background: #fff; border-radius: 1px; transition: all 0.2s; }
  .hamburger-btn.open span:nth-child(1) { transform: rotate(45deg) translate(4px, 4px); }
  .hamburger-btn.open span:nth-child(2) { opacity: 0; }
  .hamburger-btn.open span:nth-child(3) { transform: rotate(-45deg) translate(4px, -4px); }
  .street-logo { display: flex; align-items: center; gap: 6px; text-decoration: none; }
  .street-logo-mark { font-size: 15px; font-weight: 700; letter-spacing: -0.5px; color: #fff; font-family: Arial, sans-serif; line-height: 1; }
  .street-logo-mark .logo-dot { color: var(--brand--yellow); }
  .header-title { font-size: 15px; font-weight: 600; color: #fff; letter-spacing: -0.2px; flex: 1; }
  .header-right { display: flex; align-items: center; gap: 12px; }
  .refresh-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15); color: #fff; padding: 5px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; transition: background 0.15s; font-family: Arial, sans-serif; }
  .refresh-btn:hover { background: rgba(255,255,255,0.2); }
  .last-updated { font-size: 11px; color: var(--text--light--40); }
  .nav-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
  .nav-overlay.open { opacity: 1; pointer-events: all; }
  .nav-drawer { position: fixed; top: 0; left: -280px; width: 260px; height: 100vh; background: var(--brand--black); z-index: 201; transition: left 0.22s ease; display: flex; flex-direction: column; box-shadow: 2px 0 8px rgba(0,0,0,0.3); }
  .nav-drawer.open { left: 0; }
  .nav-drawer-header { padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: space-between; height: 52px; }
  .nav-drawer-title { font-size: 12px; font-weight: 600; color: var(--text--light--40); letter-spacing: 1px; text-transform: uppercase; }
  .nav-close { background: none; border: none; color: var(--text--light--40); cursor: pointer; font-size: 18px; line-height: 1; padding: 2px 6px; border-radius: 4px; transition: color 0.15s; }
  .nav-close:hover { color: #fff; }
  .nav-section-label { font-size: 10px; font-weight: 600; letter-spacing: 1.2px; text-transform: uppercase; color: var(--text--dark--30); padding: 16px 20px 8px; }
  .nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 20px; color: #ccc; text-decoration: none; font-size: 13px; transition: background 0.12s, color 0.12s; border-left: 3px solid transparent; }
  .nav-item:hover { background: rgba(255,255,255,0.06); color: #fff; border-left-color: var(--accent--blue--300); }
  .nav-item.active { background: rgba(33,71,244,0.15); color: var(--accent-blue--200); border-left-color: var(--action-primary-blue); }
  .nav-item-icon { font-size: 15px; width: 20px; text-align: center; }
  .nav-divider { height: 1px; background: rgba(255,255,255,0.08); margin: 8px 20px; }
  .main { padding: 24px; max-width: 1400px; margin: 0 auto; }
  .loading-bar { height: 3px; background: linear-gradient(90deg, var(--action-primary-blue), var(--accent--blue--300)); animation: loading 1.2s ease infinite; display: none; }
  .loading-bar.active { display: block; }
  @keyframes loading { 0% { transform: translateX(-100%); } 100% { transform: translateX(200%); } }
  .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
  .section-title { font-size: 15px; font-weight: 600; color: var(--text--dark--50); display: flex; align-items: center; gap: 8px; }
  .section-title .badge { background: var(--brand-accent--dusty-red-light); color: #c0303d; font-size: 11px; font-weight: 700; padding: 1px 7px; border-radius: 10px; min-width: 20px; text-align: center; }
  .section-title .badge.green { background: var(--success-green); color: #2a7a26; }
  .requests-panel { border: 1px solid var(--ui--underline--light-grey); border-radius: 4px; margin-bottom: 24px; overflow: hidden; }
  .requests-panel-header { background: var(--card-light-grey); padding: 12px 16px; border-bottom: 1px solid var(--ui--underline--light-grey); display: flex; align-items: center; justify-content: space-between; }
  .requests-panel-header-left { display: flex; align-items: center; gap: 10px; }
  .alert-dot { width: 8px; height: 8px; border-radius: 50%; background: #e53935; animation: pulse-dot 1.5s ease infinite; }
  @keyframes pulse-dot { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.8); } }
  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  thead tr { background: var(--card-light-grey); }
  th { padding: 10px 14px; text-align: left; font-weight: 600; font-size: 11px; letter-spacing: 0.5px; text-transform: uppercase; color: var(--text--dark--30); border-bottom: 1px solid var(--ui--underline--light-grey); white-space: nowrap; }
  td { padding: 10px 14px; border-bottom: 1px solid var(--ui--underline--light-grey); color: var(--text--dark--40); vertical-align: middle; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: #fafafa; }
  .option-badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; white-space: nowrap; }
  .opt-1 { background: var(--accent-blue--50); color: #2147f4; }
  .opt-2 { background: var(--brand-accent--cream); color: #8a5a2a; }
  .opt-3 { background: var(--brand-accent--mandarin-light); color: #a04010; }
  .opt-4 { background: var(--success-green); color: #2a7a26; }
  .opt-5 { background: var(--brand--secondary--lightgreen); color: #1a6a40; }
  .status-badge { padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
  .status-new { background: var(--white-smoke); color: #c0303d; }
  .status-unassigned { background: var(--white-smoke); color: #c0303d; }
  .status-assigned { background: var(--brand-accent--cream); color: #8a5a2a; }
  .status-booked { background: var(--accent-blue--50); color: #2147f4; }
  .status-pending { background: var(--brand--secondary--lightgreen); color: #1a6a40; }
  .status-cancelled { background: #f0f0f0; color: #999; text-decoration: line-through; }
  .status-complete { background: var(--success-green); color: #2a7a26; }
  .assign-row { display: flex; align-items: center; gap: 8px; }
  select.trainer-select { border: 1px solid var(--light-grey); border-radius: 4px; padding: 4px 8px; font-size: 12px; font-family: Arial, sans-serif; color: #333; background: #fff; cursor: pointer; }
  select.trainer-select:focus { outline: none; border-color: var(--action-primary-blue); }
  .btn { padding: 5px 12px; border-radius: 4px; font-size: 12px; font-family: Arial, sans-serif; cursor: pointer; border: none; font-weight: 600; transition: background 0.15s; }
  .btn-primary { background: var(--action-primary-blue); color: #fff; }
  .btn-primary:hover { background: #1a39d4; }
  .btn-primary:disabled { background: var(--text--dark--20); cursor: not-allowed; }
  .btn-sm { padding: 4px 10px; font-size: 11px; }
  .btn-ghost { background: none; border: 1px solid var(--light-grey); color: var(--text--dark--30); }
  .btn-ghost:hover { background: var(--card-light-grey); color: #333; }
  .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
  .kpi-card { border: 1px solid var(--ui--underline--light-grey); border-radius: 4px; padding: 16px 20px; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
  .kpi-card-label { font-size: 11px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; color: var(--text--dark--30); margin-bottom: 8px; }
  .kpi-card-value { font-size: 28px; font-weight: 700; color: var(--text--dark--50); line-height: 1.1; letter-spacing: -0.5px; }
  .kpi-card-sub { font-size: 11px; color: var(--text--dark--30); margin-top: 4px; }
  .kpi-card-delta { display: inline-flex; align-items: center; gap: 3px; font-size: 11px; font-weight: 600; padding: 1px 6px; border-radius: 4px; margin-top: 6px; }
  .delta-up { background: var(--success-green); color: #2a7a26; }
  .delta-down { background: var(--white-smoke); color: #c0303d; }
  .kpi-accent-left { border-left: 3px solid var(--action-primary-blue); padding-left: 14px; }
  .kpi-accent-yellow { border-left-color: var(--brand--yellow); }
  .kpi-accent-green { border-left-color: #4caf50; }
  .kpi-accent-orange { border-left-color: #ff7043; }
  .charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; margin-bottom: 24px; }
  @media (max-width: 900px) { .charts-grid { grid-template-columns: 1fr; } }
  .chart-card { border: 1px solid var(--ui--underline--light-grey); border-radius: 4px; padding: 20px; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
  .chart-title { font-size: 13px; font-weight: 600; color: var(--text--dark--50); margin-bottom: 4px; }
  .chart-subtitle { font-size: 11px; color: var(--text--dark--30); margin-bottom: 16px; }
  .chart-container { position: relative; }
  .trainer-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 24px; }
  .trainer-card { border: 1px solid var(--ui--underline--light-grey); border-radius: 4px; padding: 14px 16px; background: #fff; }
  .trainer-name { font-size: 13px; font-weight: 600; color: var(--text--dark--50); margin-bottom: 10px; }
  .trainer-stat { display: flex; justify-content: space-between; font-size: 11px; color: var(--text--dark--30); margin-bottom: 4px; }
  .trainer-stat-val { font-weight: 600; color: var(--text--dark--40); }
  .workload-bar-wrap { height: 4px; background: var(--ui--underline--light-grey); border-radius: 2px; margin-top: 8px; overflow: hidden; }
  .workload-bar { height: 100%; border-radius: 2px; background: var(--action-primary-blue); transition: width 0.4s ease; }
  .workload-bar.busy { background: #ff7043; }
  .workload-bar.medium { background: var(--brand--yellow); }
  .suggested-tag { display: inline-block; font-size: 10px; font-weight: 600; background: var(--brand--secondary--lightgreen); color: #1a6a40; padding: 1px 6px; border-radius: 4px; margin-top: 6px; }
  .all-bookings { border: 1px solid var(--ui--underline--light-grey); border-radius: 4px; margin-bottom: 24px; overflow: hidden; }
  .empty-state { text-align: center; padding: 40px 20px; color: var(--text--dark--30); }
  .empty-state-icon { font-size: 32px; margin-bottom: 8px; }
  .empty-state-text { font-size: 13px; }
  .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 999; display: flex; flex-direction: column; gap: 8px; }
  .toast { background: var(--brand--black); color: #fff; padding: 10px 16px; border-radius: 4px; font-size: 13px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); animation: slideIn 0.2s ease; border-left: 3px solid var(--action-primary-blue); }
  .toast.success { border-left-color: #4caf50; }
  .toast.error { border-left-color: #e53935; }
  @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: none; opacity: 1; } }
  .compare-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
  .compare-card { background: var(--card-light-grey); border-radius: 4px; padding: 12px 14px; text-align: center; }
  .compare-card-label { font-size: 10px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; color: var(--text--dark--30); margin-bottom: 4px; }
  .compare-card-value { font-size: 22px; font-weight: 700; color: var(--text--dark--50); }
  .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid var(--text-dark-10); border-top-color: var(--action-primary-blue); border-radius: 50%; animation: spin 0.6s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .pagination { display: flex; align-items: center; gap: 8px; padding: 12px 16px; border-top: 1px solid var(--ui--underline--light-grey); background: var(--card-light-grey); font-size: 12px; color: var(--text--dark--30); }
  .page-btn { background: #fff; border: 1px solid var(--light-grey); border-radius: 4px; padding: 3px 10px; font-size: 12px; cursor: pointer; font-family: Arial, sans-serif; transition: background 0.12s; }
  .page-btn:hover:not(:disabled) { background: var(--card-light-grey); }
  .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .filter-bar { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  select.filter-select, input.filter-input { border: 1px solid var(--light-grey); border-radius: 4px; padding: 5px 10px; font-size: 12px; font-family: Arial, sans-serif; color: #333; background: #fff; }
  select.filter-select:focus, input.filter-input:focus { outline: none; border-color: var(--action-primary-blue); }
  .data-note { font-size: 11px; color: var(--text--dark--20); padding: 8px 16px; background: var(--card-light-grey); border-top: 1px solid var(--ui--underline--light-grey); }
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 300; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal { background: #fff; border-radius: 8px; width: 380px; max-width: 95vw; box-shadow: 0 8px 32px rgba(0,0,0,0.2); overflow: hidden; }
  .modal-header { background: var(--brand--black); color: #fff; padding: 16px 20px; display: flex; align-items: center; justify-content: space-between; }
  .modal-title { font-size: 14px; font-weight: 600; }
  .modal-close { background: none; border: none; color: #aaa; cursor: pointer; font-size: 18px; line-height: 1; padding: 2px 6px; border-radius: 4px; }
  .modal-close:hover { color: #fff; }
  .modal-body { padding: 20px; }
  .trainer-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
  .trainer-list-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: var(--card-light-grey); border-radius: 4px; border: 1px solid var(--ui--underline--light-grey); font-size: 13px; font-weight: 600; }
  .trainer-delete-btn { background: none; border: none; color: var(--text--dark--20); cursor: pointer; font-size: 16px; line-height: 1; padding: 2px 6px; border-radius: 4px; transition: color 0.12s, background 0.12s; }
  .trainer-delete-btn:hover { color: #e53935; background: var(--white-smoke); }
  .trainer-add-input { flex: 1; border: 1px solid var(--light-grey); border-radius: 4px; padding: 7px 10px; font-size: 13px; font-family: Arial, sans-serif; }
  .trainer-add-input:focus { outline: none; border-color: var(--action-primary-blue); }
  .kpi-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.55); z-index: 400; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
  .kpi-modal-overlay.open { opacity: 1; pointer-events: all; }
  .kpi-modal { background: #fff; border-radius: 8px; width: 860px; max-width: 96vw; max-height: 88vh; display: flex; flex-direction: column; box-shadow: 0 12px 48px rgba(0,0,0,0.25); overflow: hidden; }
  .kpi-modal-header { padding: 18px 24px 14px; border-bottom: 1px solid var(--ui--underline--light-grey); display: flex; align-items: flex-start; justify-content: space-between; gap: 16px; flex-shrink: 0; }
  .kpi-modal-header-left { flex: 1; }
  .kpi-modal-title { font-size: 16px; font-weight: 700; color: var(--text--dark--50); margin-bottom: 2px; }
  .kpi-modal-subtitle { font-size: 12px; color: var(--text--dark--30); }
  .kpi-modal-headline { font-size: 28px; font-weight: 700; color: var(--text--dark--50); letter-spacing: -0.5px; margin-top: 8px; }
  .kpi-modal-close { background: var(--card-light-grey); border: 1px solid var(--ui--underline--light-grey); color: var(--text--dark--30); cursor: pointer; font-size: 18px; line-height: 1; padding: 6px 10px; border-radius: 4px; transition: background 0.12s, color 0.12s; flex-shrink: 0; }
  .kpi-modal-close:hover { background: var(--white-smoke); color: #c0303d; }
  .kpi-modal-stats { display: flex; gap: 24px; padding: 14px 24px; background: var(--card-light-grey); border-bottom: 1px solid var(--ui--underline--light-grey); flex-wrap: wrap; flex-shrink: 0; }
  .kpi-modal-stat { display: flex; flex-direction: column; gap: 2px; }
  .kpi-modal-stat-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.6px; color: var(--text--dark--30); }
  .kpi-modal-stat-value { font-size: 16px; font-weight: 700; color: var(--text--dark--50); }
  .kpi-modal-stat-sub { font-size: 10px; color: var(--text--dark--30); }
  .kpi-modal-body { overflow-y: auto; flex: 1; }
  .kpi-modal-table { width: 100%; border-collapse: collapse; font-size: 12px; }
  .kpi-modal-table thead tr { background: var(--card-light-grey); position: sticky; top: 0; z-index: 1; }
  .kpi-modal-table th { padding: 9px 14px; text-align: left; font-weight: 600; font-size: 10px; letter-spacing: 0.6px; text-transform: uppercase; color: var(--text--dark--30); border-bottom: 2px solid var(--ui--underline--light-grey); white-space: nowrap; }
  .kpi-modal-table td { padding: 10px 14px; border-bottom: 1px solid var(--ui--underline--light-grey); color: var(--text--dark--40); vertical-align: middle; }
  .kpi-modal-table tr:last-child td { border-bottom: none; }
  .kpi-modal-table tr:hover td { background: #fafbff; }
  .kpi-modal-table .col-money { font-weight: 600; color: var(--text--dark--50); }
  .kpi-modal-table .col-highlight { font-weight: 600; color: var(--action-primary-blue); }
  .kpi-modal-footer { padding: 12px 24px; border-top: 1px solid var(--ui--underline--light-grey); background: var(--card-light-grey); display: flex; justify-content: flex-end; flex-shrink: 0; }
  .kpi-card.clickable { cursor: pointer; transition: box-shadow 0.15s, border-color 0.15s, background 0.15s; border: 1px solid var(--ui--underline--light-grey); position: relative; }
  .kpi-card.clickable:hover { box-shadow: 0 4px 16px rgba(33,71,244,0.10); border-color: rgba(33,71,244,0.35); background: #f6f8ff; }
  .kpi-card.clickable:active { background: #eef1ff; }
  .trainer-pill { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; background: var(--accent-blue--50); color: var(--action-primary-blue); }
  #reassignModalOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.55); z-index: 500; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
  #reassignModalOverlay.open { opacity: 1; pointer-events: all; }
  .reassign-enquiry-row { display: flex; align-items: center; gap: 8px; padding: 5px 0; border-bottom: 1px solid var(--ui--underline--light-grey); font-size: 12px; }
  .reassign-enquiry-row:last-child { border-bottom: none; }
  .reassign-enquiry-company { font-weight: 600; color: var(--text--dark--50); flex: 1; }
  .activity-btn { position: relative; display: flex; align-items: center; gap: 6px; padding: 5px 12px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 5px; color: #ccc; cursor: pointer; font-size: 12px; font-weight: 600; font-family: Arial, sans-serif; transition: background 0.15s, color 0.15s; white-space: nowrap; }
  .activity-btn:hover { background: rgba(255,255,255,0.15); color: #fff; }
  .activity-btn-dot { position: absolute; top: -3px; right: -3px; width: 8px; height: 8px; border-radius: 50%; background: #f59e0b; border: 2px solid var(--text--dark--50); display: none; }
  .activity-btn-dot.visible { display: block; }
  .activity-panel { position: fixed; top: 0; right: 0; width: 380px; max-width: 95vw; height: 100vh; background: #fff; box-shadow: -4px 0 32px rgba(0,0,0,0.18); z-index: 600; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.28s cubic-bezier(0.4,0,0.2,1); }
  .activity-panel.open { transform: translateX(0); }
  .activity-panel-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); z-index: 599; opacity: 0; pointer-events: none; transition: opacity 0.25s; }
  .activity-panel-overlay.open { opacity: 1; pointer-events: all; }
  .activity-panel-header { padding: 16px 20px; border-bottom: 1px solid var(--ui--underline--light-grey); display: flex; align-items: center; justify-content: space-between; background: var(--text--dark--50); color: #fff; flex-shrink: 0; }
  .activity-panel-title { font-size: 14px; font-weight: 700; letter-spacing: 0.2px; }
  .activity-panel-sub { font-size: 11px; color: rgba(255,255,255,0.55); margin-top: 2px; }
  .activity-close { background: rgba(255,255,255,0.1); border: none; color: rgba(255,255,255,0.7); cursor: pointer; font-size: 16px; padding: 5px 9px; border-radius: 4px; transition: background 0.12s, color 0.12s; }
  .activity-close:hover { background: rgba(255,255,255,0.2); color: #fff; }
  .activity-user-bar { padding: 12px 16px; background: #f6f8ff; border-bottom: 1px solid var(--ui--underline--light-grey); display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
  .activity-user-avatar { width: 30px; height: 30px; border-radius: 50%; background: var(--action-primary-blue); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; flex-shrink: 0; }
  .activity-user-name { font-size: 12px; font-weight: 600; color: var(--text--dark--50); flex: 1; }
  .activity-toolbar { padding: 8px 14px; border-bottom: 1px solid var(--ui--underline--light-grey); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; gap: 8px; }
  .activity-count { font-size: 11px; font-weight: 600; color: var(--text--dark--30); }
  .activity-clear-btn { font-size: 11px; color: #c0303d; background: none; border: none; cursor: pointer; padding: 3px 7px; border-radius: 4px; font-family: Arial, sans-serif; transition: background 0.12s; }
  .activity-clear-btn:hover { background: #fde8eb; }
  .activity-feed-body { flex: 1; overflow-y: auto; padding: 8px 0; }
  .activity-empty { padding: 48px 24px; text-align: center; color: var(--text--dark--30); font-size: 13px; }
  .activity-empty-icon { font-size: 32px; margin-bottom: 10px; }
  .activity-item { display: flex; gap: 12px; padding: 11px 16px; border-bottom: 1px solid #f3f4f6; transition: background 0.1s; }
  .activity-item:hover { background: #fafbff; }
  .activity-item:last-child { border-bottom: none; }
  .activity-item-icon { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; margin-top: 1px; }
  .activity-item-body { flex: 1; min-width: 0; }
  .activity-item-text { font-size: 12px; color: var(--text--dark--50); line-height: 1.45; }
  .activity-item-text .act-company { color: var(--action-primary-blue); font-weight: 600; }
  .activity-item-meta { display: flex; align-items: center; gap: 8px; margin-top: 4px; }
  .activity-item-user { font-size: 10px; font-weight: 700; color: var(--text--dark--30); letter-spacing: 0.4px; text-transform: uppercase; }
  .activity-item-time { font-size: 10px; color: var(--text--dark--20); }
  .activity-date-divider { padding: 6px 16px 3px; font-size: 10px; font-weight: 700; letter-spacing: 0.8px; text-transform: uppercase; color: var(--text--dark--20); background: var(--card-light-grey); border-bottom: 1px solid var(--ui--underline--light-grey); border-top: 1px solid var(--ui--underline--light-grey); }
  .username-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 700; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
  .username-modal-overlay.open { opacity: 1; pointer-events: all; }
  .username-modal { background: #fff; border-radius: 10px; width: 360px; max-width: 94vw; padding: 28px 28px 22px; box-shadow: 0 12px 48px rgba(0,0,0,0.25); text-align: center; }
  .username-modal-icon { font-size: 36px; margin-bottom: 10px; }
  .username-modal-title { font-size: 17px; font-weight: 700; color: var(--text--dark--50); margin-bottom: 6px; }
  .username-modal-sub { font-size: 12px; color: var(--text--dark--30); margin-bottom: 20px; line-height: 1.5; }
  .username-modal input { width: 100%; box-sizing: border-box; border: 1.5px solid var(--ui--underline--light-grey); border-radius: 6px; padding: 10px 14px; font-size: 14px; font-family: Arial, sans-serif; color: var(--text--dark--50); margin-bottom: 14px; transition: border-color 0.15s; }
  .username-modal input:focus { outline: none; border-color: var(--action-primary-blue); }
  .login-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #0d1526 0%, #1a2a4a 50%, #0d1526 100%); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 0; }
  .login-screen.hidden { display: none; }
  .login-card { background: #fff; border-radius: 14px; padding: 36px 36px 28px; width: 480px; max-width: 96vw; box-shadow: 0 24px 80px rgba(0,0,0,0.4); }
  .login-logo { font-size: 13px; font-weight: 800; letter-spacing: 2px; color: var(--text--dark--50); text-transform: uppercase; margin-bottom: 4px; }
  .login-logo span { color: var(--action-primary-blue); }
  .login-title { font-size: 22px; font-weight: 700; color: var(--text--dark--50); margin-bottom: 4px; margin-top: 20px; }
  .login-sub { font-size: 13px; color: var(--text--dark--30); margin-bottom: 28px; }
  .login-user-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; max-height: 320px; overflow-y: auto; }
  .login-user-btn { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 16px 12px; border: 1.5px solid var(--ui--underline--light-grey); border-radius: 10px; background: #fff; cursor: pointer; transition: border-color 0.15s, background 0.15s, box-shadow 0.15s; font-family: Arial, sans-serif; text-align: center; }
  .login-user-btn:hover { border-color: var(--action-primary-blue); background: #f6f8ff; box-shadow: 0 2px 12px rgba(33,71,244,0.12); }
  .login-user-avatar { width: 44px; height: 44px; border-radius: 50%; background: var(--action-primary-blue); color: #fff; font-size: 16px; font-weight: 700; display: flex; align-items: center; justify-content: center; }
  .login-user-name { font-size: 13px; font-weight: 600; color: var(--text--dark--50); }
  .login-user-role { font-size: 10px; color: var(--text--dark--30); text-transform: uppercase; letter-spacing: 0.6px; }
  .login-user-badge { display: inline-flex; align-items: center; gap: 3px; font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 8px; letter-spacing: 0.5px; text-transform: uppercase; }
  .login-user-badge.admin { background: #fde8eb; color: #c0303d; }
  .login-user-badge.editor { background: #e8f0ff; color: #2147f4; }
  .login-user-badge.viewer { background: #f0f0f0; color: #888; }
  .login-no-users { grid-column: 1/-1; text-align: center; padding: 24px; color: var(--text--dark--30); font-size: 13px; }
  .perm-section { margin-bottom: 16px; }
  .perm-section-title { font-size: 10px; font-weight: 700; letter-spacing: 0.8px; text-transform: uppercase; color: var(--text--dark--30); margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid var(--ui--underline--light-grey); }
  .perm-row { display: flex; align-items: flex-start; justify-content: space-between; padding: 7px 0; gap: 12px; border-bottom: 1px solid #f3f4f6; }
  .perm-row:last-child { border-bottom: none; }
  .perm-row-left { flex: 1; }
  .perm-row-label { font-size: 12px; font-weight: 600; color: var(--text--dark--50); }
  .perm-row-desc { font-size: 11px; color: var(--text--dark--30); margin-top: 1px; }
  .perm-toggle { position: relative; width: 36px; height: 20px; flex-shrink: 0; margin-top: 1px; }
  .perm-toggle input { opacity: 0; width: 0; height: 0; }
  .perm-toggle-slider { position: absolute; inset: 0; background: #ccc; border-radius: 20px; cursor: pointer; transition: background 0.2s; }
  .perm-toggle-slider::before { content: ''; position: absolute; width: 14px; height: 14px; left: 3px; top: 3px; background: #fff; border-radius: 50%; transition: transform 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
  .perm-toggle input:checked + .perm-toggle-slider { background: var(--action-primary-blue); }
  .perm-toggle input:checked + .perm-toggle-slider::before { transform: translateX(16px); }
  .perm-preset-row { display: flex; gap: 6px; margin-bottom: 14px; }
  .perm-preset-btn { flex: 1; padding: 6px 4px; border-radius: 5px; border: 1.5px solid var(--ui--underline--light-grey); background: #fff; font-size: 11px; font-weight: 600; cursor: pointer; font-family: Arial, sans-serif; transition: all 0.12s; }
  .perm-preset-btn:hover { border-color: var(--action-primary-blue); background: #f0f4ff; }
  .perm-preset-btn.active { border-color: var(--action-primary-blue); background: var(--action-primary-blue); color: #fff; }
  .perm-hidden { display: none !important; }
  .perm-disabled { opacity: 0.45; pointer-events: none; cursor: not-allowed; }
  .pin-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #0d1526 0%, #1a2a4a 50%, #0d1526 100%); z-index: 9998; display: flex; align-items: center; justify-content: center; flex-direction: column; }
  .pin-screen.hidden { display: none; }
  .pin-card { background: #fff; border-radius: 14px; padding: 32px 32px 26px; width: 340px; max-width: 96vw; box-shadow: 0 24px 80px rgba(0,0,0,0.4); text-align: center; }
  .pin-avatar { width: 56px; height: 56px; border-radius: 50%; background: var(--action-primary-blue); color: #fff; font-size: 20px; font-weight: 700; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; }
  .pin-user-name { font-size: 18px; font-weight: 700; color: var(--text--dark--50); margin-bottom: 4px; }
  .pin-label { font-size: 13px; color: var(--text--dark--30); margin-bottom: 20px; }
  .pin-dots { display: flex; justify-content: center; gap: 12px; margin-bottom: 24px; }
  .pin-dot { width: 16px; height: 16px; border-radius: 50%; border: 2px solid #ccc; background: transparent; transition: all 0.15s; }
  .pin-dot.filled { background: var(--action-primary-blue); border-color: var(--action-primary-blue); }
  .pin-dot.error { background: #c0303d; border-color: #c0303d; }
  .pin-keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 14px; }
  .pin-key { padding: 14px 0; border: 1.5px solid #e5e7eb; border-radius: 8px; background: #fff; font-size: 18px; font-weight: 600; color: var(--text--dark--50); cursor: pointer; font-family: Arial, sans-serif; transition: background 0.1s, border-color 0.1s, transform 0.08s; user-select: none; }
  .pin-key:hover { background: #f0f4ff; border-color: var(--action-primary-blue); }
  .pin-key:active { transform: scale(0.94); background: #e0e8ff; }
  .pin-key.del { font-size: 15px; color: #888; }
  .pin-error-msg { font-size: 12px; color: #c0303d; min-height: 18px; margin-bottom: 6px; }
  .pin-back-btn { background: none; border: none; color: var(--text--dark--30); font-size: 12px; cursor: pointer; font-family: Arial, sans-serif; padding: 4px 8px; border-radius: 4px; transition: color 0.12s; text-decoration: underline; }
  .pin-back-btn:hover { color: var(--action-primary-blue); }
  .pin-setup-info { font-size: 11px; color: var(--text--dark--30); margin-bottom: 18px; line-height: 1.5; padding: 8px 10px; background: #f6f8ff; border-radius: 6px; border: 1px solid #e0e8ff; }
  .shadow-banner { display: none; position: fixed; top: 0; left: 0; right: 0; z-index: 950; background: linear-gradient(90deg, #7c3aed, #5b21b6); color: #fff; padding: 9px 20px; font-size: 12px; font-weight: 600; align-items: center; justify-content: space-between; gap: 12px; box-shadow: 0 2px 12px rgba(124,58,237,0.4); letter-spacing: 0.2px; }
  .shadow-banner.active { display: flex; }
  .shadow-banner-left { display: flex; align-items: center; gap: 10px; }
  .shadow-banner-pill { background: rgba(255,255,255,0.18); border-radius: 20px; padding: 2px 10px; font-size: 11px; letter-spacing: 0.4px; text-transform: uppercase; }
  .shadow-banner-name { font-size: 13px; font-weight: 700; }
  .shadow-banner-right { display: flex; align-items: center; gap: 8px; }
  .shadow-exit-btn { background: rgba(255,255,255,0.15); border: 1.5px solid rgba(255,255,255,0.35); color: #fff; border-radius: 6px; padding: 5px 14px; font-size: 11px; font-weight: 700; cursor: pointer; font-family: Arial, sans-serif; transition: background 0.12s; letter-spacing: 0.3px; }
  .shadow-exit-btn:hover { background: rgba(255,255,255,0.28); }
  .shadow-save-btn { background: #fff; border: none; color: #5b21b6; border-radius: 6px; padding: 5px 14px; font-size: 11px; font-weight: 700; cursor: pointer; font-family: Arial, sans-serif; transition: background 0.12s; letter-spacing: 0.3px; }
  .shadow-save-btn:hover { background: #ede9fe; }
  body.shadow-mode .header, body.shadow-mode .loading-bar, body.shadow-mode .main { margin-top: 37px; }
  .cal-section { margin-bottom: 24px; }
  .cal-grid { display: grid; grid-template-columns: minmax(0, 1fr) 300px; gap: 16px; align-items: start; min-width: 0; width: 100%; }
  @media (max-width: 900px) { .cal-grid { grid-template-columns: 1fr; } }
  .cal-month-card { background: #fff; border: 1px solid var(--ui--underline--light-grey); border-radius: 8px; overflow: hidden; min-width: 0; width: 100%; }
  .cal-month-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: var(--text--dark--50); color: #fff; }
  .cal-month-title { font-size: 14px; font-weight: 700; }
  .cal-nav-btn { background: rgba(255,255,255,0.12); border: none; color: #fff; cursor: pointer; padding: 4px 10px; border-radius: 4px; font-size: 14px; font-family: Arial, sans-serif; transition: background 0.12s; }
  .cal-nav-btn:hover { background: rgba(255,255,255,0.22); }
  .cal-dow-row { display: flex; width: 100%; box-sizing: border-box; background: var(--card-light-grey); border-bottom: 1px solid var(--ui--underline--light-grey); }
  .cal-dow { flex: 0 0 calc(100% / 7); width: calc(100% / 7); text-align: center; font-size: 10px; font-weight: 700; color: var(--text--dark--30); padding: 6px 0; letter-spacing: 0.5px; text-transform: uppercase; box-sizing: border-box; overflow: hidden; }
  .cal-days { display: flex; flex-wrap: wrap; width: 100%; box-sizing: border-box; border-top: 1px solid #f3f4f6; border-left: 1px solid #f3f4f6; }
  .cal-day { flex: 0 0 calc(100% / 7); width: calc(100% / 7); box-sizing: border-box; min-height: 90px; padding: 5px 4px 4px; border-right: 1px solid #f3f4f6; border-bottom: 1px solid #f3f4f6; cursor: default; transition: background 0.1s; overflow: hidden; }
  .cal-day:hover:not(.cal-day-empty) { background: #f6f8ff; }
  .cal-day-empty { background: #fafafa; }
  .cal-day-num { font-size: 11px; font-weight: 600; color: var(--text--dark--30); display: block; margin-bottom: 3px; line-height: 1; }
  .cal-day-today .cal-day-num { background: var(--action-primary-blue); color: #fff; width: 20px; height: 20px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 10px; margin-bottom: 3px; }
  .cal-day-past { opacity: 0.5; }
  .cal-event { display: block; font-size: 9px; font-weight: 600; padding: 2px 5px; border-radius: 3px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; max-width: 100%; box-sizing: border-box; }
  .cal-event-booking { background: #b8caff; color: #1838c0; }
  .cal-event-blocked { background: #fde8eb; color: #c0303d; }
  .cal-event-gcal { background: #beffd8; color: #1a6a40; }
  .cal-event-more { display: block; font-size: 9px; color: var(--text--dark--30); padding: 1px 4px; cursor: pointer; }
  .cal-upcoming-card { background: #fff; border: 1px solid var(--ui--underline--light-grey); border-radius: 8px; overflow: hidden; max-height: 520px; display: flex; flex-direction: column; }
  .cal-upcoming-header { padding: 12px 16px; background: var(--card-light-grey); border-bottom: 1px solid var(--ui--underline--light-grey); font-size: 12px; font-weight: 700; color: var(--text--dark--40); display: flex; align-items: center; justify-content: space-between; }
  .cal-upcoming-body { flex: 1; overflow-y: auto; }
  .cal-upcoming-item { padding: 10px 14px; border-bottom: 1px solid #f3f4f6; display: flex; gap: 10px; align-items: flex-start; }
  .cal-upcoming-item:last-child { border-bottom: none; }
  .cal-upcoming-date { min-width: 38px; text-align: center; background: var(--card-light-grey); border-radius: 6px; padding: 4px 6px; flex-shrink: 0; }
  .cal-upcoming-date-day { font-size: 16px; font-weight: 700; color: var(--text--dark--50); line-height: 1; }
  .cal-upcoming-date-mon { font-size: 9px; font-weight: 600; color: var(--text--dark--30); text-transform: uppercase; letter-spacing: 0.5px; }
  .cal-upcoming-body-text { flex: 1; min-width: 0; }
  .cal-upcoming-company { font-size: 12px; font-weight: 600; color: var(--text--dark--50); }
  .cal-upcoming-meta { font-size: 11px; color: var(--text--dark--30); margin-top: 2px; }
  .cal-upcoming-empty { padding: 32px 20px; text-align: center; color: var(--text--dark--30); font-size: 12px; }
  .trainer-availability { margin-top: 8px; padding: 6px 8px; background: #f0fdf4; border-radius: 5px; border: 1px solid #bbf7d0; font-size: 11px; color: #1a6a40; font-weight: 600; display: flex; align-items: center; gap: 5px; }
  .trainer-availability.loading { background: var(--card-light-grey); border-color: var(--ui--underline--light-grey); color: var(--text--dark--30); }
  .trainer-availability.busy { background: #fde8eb; border-color: #fecaca; color: #c0303d; }
  .trainer-availability.unknown { background: var(--card-light-grey); border-color: var(--ui--underline--light-grey); color: var(--text--dark--30); }
  .cal-filter-row { display: flex; align-items: center; gap: 8px; padding: 10px 14px; background: var(--card-light-grey); border-bottom: 1px solid var(--ui--underline--light-grey); flex-wrap: wrap; }
  .cal-legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
  .cal-legend-label { font-size: 11px; color: var(--text--dark--40); }
  .nav-jump-item { display: flex; align-items: center; gap: 10px; padding: 7px 20px; font-size: 12px; color: var(--text--dark--40); cursor: pointer; text-decoration: none; transition: background 0.15s, color 0.15s; border: none; background: none; width: 100%; text-align: left; font-family: Arial, sans-serif; }
  .nav-jump-item:hover { background: rgba(33,71,244,0.06); color: var(--action-primary-blue); }
  .nav-jump-icon { font-size: 13px; width: 20px; text-align: center; flex-shrink: 0; }
  .nav-jump-label { flex: 1; }
  .nav-jump-arrow { font-size: 10px; color: var(--text--dark--20); }
  .nav-section-label-sub { padding: 8px 20px 4px; font-size: 9px; font-weight: 700; letter-spacing: 0.8px; text-transform: uppercase; color: var(--text--dark--20); }
  .booked-date-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 1200; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.15s; }
  .booked-date-modal-overlay.open { opacity: 1; pointer-events: all; }
  .booked-date-modal { background: #fff; border-radius: 12px; width: 400px; max-width: 94vw; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.25); transform: translateY(12px); transition: transform 0.15s; }
  .booked-date-modal-overlay.open .booked-date-modal { transform: translateY(0); }
  .booked-date-modal-header { padding: 18px 22px 14px; background: var(--action-primary-blue); color: #fff; }
  .booked-date-modal-title { font-size: 15px; font-weight: 700; margin-bottom: 3px; }
  .booked-date-modal-company { font-size: 12px; opacity: 0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .booked-date-modal-body { padding: 22px; }
  .booked-date-modal-body label { display: block; font-size: 12px; font-weight: 600; color: var(--text--dark--40); margin-bottom: 8px; }
  .booked-date-modal-input { width: 100%; box-sizing: border-box; border: 2px solid var(--action-primary-blue); border-radius: 7px; padding: 10px 12px; font-size: 14px; font-family: Arial, sans-serif; color: var(--text--dark--50); margin-bottom: 10px; outline: none; }
  .booked-date-modal-input:focus { border-color: #1236d4; box-shadow: 0 0 0 3px rgba(33,71,244,0.12); }
  .booked-date-modal-hint { font-size: 11px; color: var(--text--dark--30); margin-bottom: 4px; line-height: 1.5; }
  .booked-date-modal-footer { padding: 14px 22px; border-top: 1px solid var(--ui--underline--light-grey); background: var(--card-light-grey); display: flex; justify-content: flex-end; gap: 8px; align-items: center; }
  .booked-date-modal-footer-left { flex: 1; font-size: 11px; color: #c0303d; display: none; }
  .booked-date-modal-footer-left.show { display: block; }
  .bd-days-btn { flex: 1; padding: 8px 4px; border: 2px solid var(--ui--underline--light-grey); border-radius: 6px; background: #fff; color: var(--text--dark--40); font-size: 12px; font-weight: 600; font-family: Arial, sans-serif; cursor: pointer; transition: all 0.12s; }
  .bd-days-btn:hover { border-color: var(--action-primary-blue); color: var(--action-primary-blue); }
  .bd-days-btn.active { border-color: var(--action-primary-blue); background: var(--action-primary-blue); color: #fff; }
</style>
</head>
<body>

<div class="nav-overlay" id="navOverlay" onclick="closeNav()"></div>

<!-- LOGIN SCREEN -->
<div class="login-screen" id="loginScreen">
  <div class="login-card">
    <div class="login-logo">STREET<span>.</span>CO.UK</div>
    <div class="login-title">Training Dashboard</div>
    <div class="login-sub">Select your name to continue</div>
    <div class="login-user-grid" id="loginUserGrid">
      <div class="login-no-users">No users set up yet.<br>An admin needs to add trainers first.</div>
    </div>
    <div style="text-align:center;font-size:11px;color:var(--text--dark--20);margin-top:8px;">Permissions are managed in the Trainer settings</div>
  </div>
</div>

<!-- PIN ENTRY SCREEN -->
<div class="pin-screen hidden" id="pinScreen">
  <div class="pin-card">
    <div class="pin-avatar" id="pinAvatar">?</div>
    <div class="pin-user-name" id="pinUserName">\u2014</div>
    <div class="pin-label" id="pinLabel">Enter your 4-digit passcode</div>
    <div id="pinSetupInfo" class="pin-setup-info" style="display:none;">Choose a 4-digit passcode to protect your account.<br>You'll need this every time you log in.</div>
    <div class="pin-dots">
      <div class="pin-dot" id="pd0"></div><div class="pin-dot" id="pd1"></div>
      <div class="pin-dot" id="pd2"></div><div class="pin-dot" id="pd3"></div>
    </div>
    <div class="pin-error-msg" id="pinError"></div>
    <div class="pin-keypad">
      <button class="pin-key" onclick="pinKey('1')">1</button>
      <button class="pin-key" onclick="pinKey('2')">2</button>
      <button class="pin-key" onclick="pinKey('3')">3</button>
      <button class="pin-key" onclick="pinKey('4')">4</button>
      <button class="pin-key" onclick="pinKey('5')">5</button>
      <button class="pin-key" onclick="pinKey('6')">6</button>
      <button class="pin-key" onclick="pinKey('7')">7</button>
      <button class="pin-key" onclick="pinKey('8')">8</button>
      <button class="pin-key" onclick="pinKey('9')">9</button>
      <button class="pin-key" onclick="pinKey('0')" style="grid-column:2;">0</button>
      <button class="pin-key del" onclick="pinDel()">\u232b</button>
    </div>
    <div id="pinForgotWrap" style="margin-top:4px;"><button class="pin-back-btn" onclick="pinForgot()">Forgot passcode?</button></div>
    <div style="margin-top:10px;"><button class="pin-back-btn" onclick="pinBack()">\u2190 Back to user select</button></div>
  </div>
</div>

<!-- SHADOW MODE BANNER -->
<div class="shadow-banner" id="shadowBanner">
  <div class="shadow-banner-left">
    <span class="shadow-banner-pill">\ud83d\udc41 Preview Mode</span>
    <span>Viewing dashboard as</span>
    <span class="shadow-banner-name" id="shadowBannerName">\u2014</span>
  </div>
  <div class="shadow-banner-right">
    <span style="font-size:11px;opacity:0.75;">Changes to permissions apply live \u2014 exit to save</span>
    <button class="shadow-exit-btn" onclick="exitShadowMode()">\u2190 Exit Preview</button>
    <button class="shadow-save-btn" onclick="saveShadowAndExit()">\u2713 Save &amp; Back to Edit</button>
  </div>
</div>

<!-- SIDE DRAWER -->
<nav class="nav-drawer" id="navDrawer">
  <div class="nav-drawer-header">
    <span class="nav-drawer-title">Navigation</span>
    <button class="nav-close" onclick="closeNav()">\u2715</button>
  </div>
  <div class="nav-section-label">Dashboard</div>
  <a href="#" class="nav-item active" onclick="closeNav()"><span class="nav-item-icon">\ud83d\udcca</span> Training Dashboard</a>
  <div class="nav-divider"></div>
  <div class="nav-section-label-sub">Jump to section</div>
  <button class="nav-jump-item" id="navJumpWorkload" onclick="scrollToSection('sectionWorkload')"><span class="nav-jump-icon">\ud83d\udc64</span><span class="nav-jump-label">Trainer Workload</span><span class="nav-jump-arrow">\u2193</span></button>
  <button class="nav-jump-item" id="navJumpUnassigned" onclick="scrollToSection('sectionUnassigned')"><span class="nav-jump-icon">\ud83d\udd14</span><span class="nav-jump-label">Unassigned Requests</span><span class="nav-jump-arrow">\u2193</span></button>
  <button class="nav-jump-item" id="navJumpCalendar" onclick="scrollToSection('calSection')"><span class="nav-jump-icon">\ud83d\udcc5</span><span class="nav-jump-label">Training Calendar</span><span class="nav-jump-arrow">\u2193</span></button>
  <button class="nav-jump-item" id="navJumpNeedsAction" onclick="scrollToSection('sectionNeedsAction')"><span class="nav-jump-icon">\u26a0\ufe0f</span><span class="nav-jump-label">Needs Action</span><span class="nav-jump-arrow">\u2193</span></button>
  <button class="nav-jump-item" id="navJumpPerformance" onclick="scrollToSection('sectionPerformance')"><span class="nav-jump-icon">\ud83d\udcc8</span><span class="nav-jump-label">Performance Review</span><span class="nav-jump-arrow">\u2193</span></button>
  <button class="nav-jump-item" id="navJumpAllBookings" onclick="scrollToSection('sectionAllBookings')"><span class="nav-jump-icon">\ud83d\udccb</span><span class="nav-jump-label">All Bookings</span><span class="nav-jump-arrow">\u2193</span></button>
  <div class="nav-divider"></div>
  <div class="nav-section-label">Tools</div>
  <a href="https://amydawber-del.github.io/TrainingCSAT/dashboard.html" class="nav-item" target="_blank" id="navFeedback"><span class="nav-item-icon">\u2b50</span> Training Feedback Dashboard</a>
  <a href="https://amydawber-del.github.io/TilTracker/" class="nav-item" target="_blank" id="navTil"><span class="nav-item-icon">\ud83d\udcda</span> TIL Tracker</a>
  <a href="https://amydawber-del.github.io/TrainingCSAT/" class="nav-item" target="_blank" id="navSurvey"><span class="nav-item-icon">\ud83d\udccb</span> Client Feedback Survey</a>
  <div class="nav-divider"></div>
  <div class="nav-section-label">Resources</div>
  <a href="https://docs.google.com/spreadsheets/d/1r_HODYw7kIMpWm8TNcXwJmZQuk0lsjVR6SEl2teytJM/edit" class="nav-item" target="_blank" id="navSpreadsheet"><span class="nav-item-icon">\ud83d\udcc4</span> Bookings Spreadsheet</a>
  <a href="https://docs.google.com/forms/d/e/1FAIpQLSe-s3SWoPSaIanCZLMLYNnVmu3NU-LY4Lm7Db12gHLv6LzVuQ/viewform" class="nav-item" target="_blank" id="navRequestForm"><span class="nav-item-icon">\ud83d\udcdd</span> Training Request Form</a>
</nav>

<!-- HEADER -->
<header class="header">
  <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleNav()" aria-label="Menu">
    <span></span><span></span><span></span>
  </button>
  <a href="#" class="street-logo">
    <div class="street-logo-mark">STREET<span class="logo-dot">.</span><span style="font-size:9px;font-weight:400;letter-spacing:0;">CO.UK</span></div>
  </a>
  <div class="header-title">Training Dashboard</div>
  <div class="header-right">
    <span class="last-updated" id="lastUpdated">\u2014</span>
    <div id="headerUserChip" style="display:none;align-items:center;gap:7px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:20px;padding:4px 12px 4px 6px;">
      <div id="headerUserAvatar" style="width:24px;height:24px;border-radius:50%;background:var(--action-primary-blue);color:#fff;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;">?</div>
      <span id="headerUserName" style="font-size:12px;font-weight:600;color:#ddd;">\u2014</span>
    </div>
    <button class="activity-btn" onclick="openActivityPanel()" title="Activity Feed" id="activityNavBtn">
      <span>\ud83d\udd50</span> Activity
      <span class="activity-btn-dot" id="activityBtnDot"></span>
    </button>
    <button class="activity-btn" onclick="logout()" id="logoutBtn" style="display:none;border-color:rgba(192,48,61,0.4);color:#f88;background:rgba(192,48,61,0.15);" title="Log out">\u23cf Log out</button>
    <button class="refresh-btn" onclick="testConnection(this)" style="background:rgba(255,200,0,0.15);border-color:rgba(255,200,0,0.3);">\ud83d\udd0d Test</button>
    <button class="refresh-btn" onclick="loadData()">\u21bb Refresh</button>
  </div>
</header>

<div class="loading-bar" id="loadingBar"></div>

<main class="main">

  <!-- TRAINER WORKLOAD -->
  <div id="sectionWorkload" style="margin-bottom:24px;">
    <div class="section-header">
      <div class="section-title">\ud83d\udc64 Trainer Workload</div>
      <div style="display:flex;align-items:center;gap:10px;">
        <span style="font-size:11px;color:var(--text--dark--30);">Last 30 days + upcoming</span>
        <button class="refresh-btn" onclick="openTrainerModal()" style="background:rgba(33,71,244,0.1);border-color:rgba(33,71,244,0.3);color:var(--action-primary-blue);font-size:11px;">+ Manage Trainers</button>
      </div>
    </div>
    <div class="trainer-grid" id="trainerGrid">
      <div class="kpi-card" style="text-align:center;color:var(--text--dark--30);font-size:12px;grid-column:1/-1;">Loading trainer data...</div>
    </div>
  </div>

  <!-- UNASSIGNED REQUESTS -->
  <div id="sectionUnassigned" style="margin-bottom:24px;">
    <div class="section-header">
      <div class="section-title">\ud83d\udd14 Unassigned Requests <span class="badge" id="unassignedBadge">0</span></div>
      <div class="filter-bar">
        <input class="filter-input" id="searchInput" type="text" placeholder="Search client, option..." oninput="filterRequests()" style="width:200px;">
      </div>
    </div>
    <div class="requests-panel">
      <div class="requests-panel-header">
        <div class="requests-panel-header-left">
          <div class="alert-dot" id="alertDot" style="display:none;"></div>
          <span style="font-size:12px;font-weight:600;color:var(--text--dark--40);">New training requests awaiting trainer assignment</span>
        </div>
        <span style="font-size:11px;color:var(--text--dark--30);">Round-robin suggestion shown in blue</span>
      </div>
      <div class="table-wrap">
        <table id="newRequestsTable">
          <thead><tr><th>Submitted</th><th>Company</th><th>Contact</th><th>Training Option</th><th>Preferred Dates</th><th colspan="2">Actions</th></tr></thead>
          <tbody id="newRequestsBody"><tr><td colspan="7" style="padding:20px;text-align:center;color:var(--text--dark--30);">Connecting\u2026</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- CALENDAR SECTION -->
  <div class="cal-section" id="calSection">
    <div class="section-header">
      <div class="section-title">\ud83d\udcc5 Training Calendar</div>
      <div style="display:flex;align-items:center;gap:10px;">
        <span style="font-size:11px;color:var(--text--dark--30);" id="calGcalStatus">
          <span id="calGcalDot" style="display:inline-block;width:7px;height:7px;border-radius:50%;background:#ccc;margin-right:4px;vertical-align:middle;"></span>Calendar not connected
        </span>
        <button class="refresh-btn" onclick="loadCalendarData(true)" style="font-size:11px;">\u21bb Sync Calendar</button>
        <button class="refresh-btn" onclick="openCalSettings()" style="font-size:11px;background:rgba(33,71,244,0.1);border-color:rgba(33,71,244,0.3);color:var(--action-primary-blue);">\u2699 Calendar Settings</button>
      </div>
    </div>
    <div class="cal-grid">
      <div class="cal-month-card">
        <div class="cal-month-header">
          <button class="cal-nav-btn" onclick="calChangeMonth(-1)">\u2039</button>
          <div class="cal-month-title" id="calMonthTitle">\u2014</div>
          <button class="cal-nav-btn" onclick="calChangeMonth(1)">\u203a</button>
        </div>
        <div class="cal-filter-row">
          <div style="display:flex;align-items:center;gap:5px;"><div class="cal-legend-dot" style="background:#b8caff;"></div><span class="cal-legend-label">Bookings</span></div>
          <div style="display:flex;align-items:center;gap:5px;"><div class="cal-legend-dot" style="background:#beffd8;"></div><span class="cal-legend-label">Google Calendar</span></div>
          <div style="display:flex;align-items:center;gap:5px;"><div class="cal-legend-dot" style="background:#fde8eb;"></div><span class="cal-legend-label">Blocked / Busy</span></div>
          <div style="display:flex;align-items:center;gap:5px;"><div class="cal-legend-dot" style="background:#e3f0ff;border:1px solid #b8d4f5;"></div><span class="cal-legend-label">&#9992;&#65039; Travel</span></div>
          <div style="display:flex;align-items:center;gap:5px;"><div class="cal-legend-dot" style="background:#f3e5f5;border:1px solid #ce93d8;"></div><span class="cal-legend-label">&#128203; Admin</span></div>
          <div style="display:flex;align-items:center;gap:5px;"><div class="cal-legend-dot" style="background:#fffbe6;border:1px solid #ffe082;"></div><span class="cal-legend-label">&#127468;&#127463; Bank Hol</span></div>
          <div style="margin-left:auto;">
            <select id="calFilterTrainer" onchange="renderCalendar()" style="font-size:11px;border:1px solid var(--ui--underline--light-grey);border-radius:4px;padding:3px 7px;font-family:Arial,sans-serif;background:#fff;">
              <option value="">All Trainers</option>
            </select>
          </div>
        </div>
        <div class="cal-dow-row">
          <div class="cal-dow">Mon</div><div class="cal-dow">Tue</div><div class="cal-dow">Wed</div>
          <div class="cal-dow">Thu</div><div class="cal-dow">Fri</div><div class="cal-dow">Sat</div><div class="cal-dow">Sun</div>
        </div>
        <div class="cal-days" id="calDays"></div>
      </div>
      <div class="cal-upcoming-card">
        <div class="cal-upcoming-header"><span>Upcoming Sessions</span><span id="calUpcomingCount" style="font-size:10px;color:var(--text--dark--30);">\u2014</span></div>
        <div class="cal-upcoming-body" id="calUpcomingBody"><div class="cal-upcoming-empty">Loading...</div></div>
      </div>
    </div>
  </div>

  <!-- NEEDS ACTION PANEL -->
  <div id="sectionNeedsAction" style="margin-bottom:24px;">
    <div class="section-header">
      <div class="section-title" style="color:#8a5a2a;">\u26a0\ufe0f Needs Action \u2014 Assigned &amp; Pending <span class="badge" id="actionBadge" style="background:var(--brand-accent--mandarin-light);color:#a04010;">0</span></div>
      <span style="font-size:11px;color:var(--text--dark--30);">Change status to Booked (opens booking modal) or Cancelled</span>
    </div>
    <div class="requests-panel" style="border-color:var(--brand-accent--mandarin-light);">
      <div class="requests-panel-header" style="background:var(--brand-accent--cream);">
        <div class="requests-panel-header-left">
          <div class="alert-dot" id="actionDot" style="display:none;background:#f59e0b;"></div>
          <span style="font-size:12px;font-weight:600;color:var(--text--dark--40);">Assigned or pending bookings awaiting confirmation</span>
        </div>
        <span style="font-size:11px;color:var(--text--dark--30);">Update status directly from this panel</span>
      </div>
      <div class="table-wrap">
        <table id="actionRequestsTable">
          <thead><tr><th>Submitted</th><th>Company</th><th>Contact</th><th>Training Option</th><th>Value</th><th>Trainer</th><th>Status</th></tr></thead>
          <tbody id="actionRequestsBody"><tr><td colspan="7" style="padding:20px;text-align:center;color:var(--text--dark--30);">Connecting\u2026</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- KPI CARDS -->
  <div id="sectionPerformance" style="margin-bottom:16px;">
    <div class="section-title" style="margin-bottom:14px;">\ud83d\udcc8 Performance Overview</div>
  </div>
  <div class="kpi-grid">
    <div class="kpi-card kpi-accent-left clickable" onclick="openKpiModal('revYear')" title="Click for breakdown">
      <div class="kpi-card-label">Total Revenue This Year <span style="font-weight:400;color:var(--accent--blue--300);">(Booked)</span></div>
      <div class="kpi-card-value" id="kpiRevYear">\u00a3\u2014</div>
      <div class="kpi-card-sub">Exc. VAT \u00b7 click for detail</div>
    </div>
    <div class="kpi-card kpi-accent-left kpi-accent-yellow clickable" onclick="openKpiModal('revMonth')" title="Click for breakdown">
      <div class="kpi-card-label">Revenue This Month <span style="font-weight:400;color:var(--accent--blue--300);">(Booked)</span></div>
      <div class="kpi-card-value" id="kpiRevMonth">\u00a3\u2014</div>
      <div id="kpiRevMonthDelta"></div>
    </div>
    <div class="kpi-card kpi-accent-left kpi-accent-green clickable" onclick="openKpiModal('avgFee')" title="Click for breakdown">
      <div class="kpi-card-label">Avg Training Fee (Year) <span style="font-weight:400;color:var(--accent--blue--300);">(Booked)</span></div>
      <div class="kpi-card-value" id="kpiAvgFee">\u00a3\u2014</div>
      <div class="kpi-card-sub">Per booking \u00b7 click for detail</div>
    </div>
    <div class="kpi-card kpi-accent-left kpi-accent-orange clickable" onclick="openKpiModal('days')" title="Click for breakdown">
      <div class="kpi-card-label">Training Days This Year</div>
      <div class="kpi-card-value" id="kpiDaysYear">\u2014</div>
      <div class="kpi-card-sub" id="kpiDaysMonth">\u2014 this month</div>
    </div>
    <div class="kpi-card kpi-accent-left clickable" style="border-left-color:#9c27b0;" onclick="openKpiModal('bookings')" title="Click for breakdown">
      <div class="kpi-card-label">Total Bookings (Year)</div>
      <div class="kpi-card-value" id="kpiBookingsYear">\u2014</div>
      <div class="kpi-card-sub" id="kpiBookingsMonth">\u2014 this month</div>
    </div>
  </div>

  <!-- CHARTS -->
  <div class="charts-grid">
    <div class="chart-card">
      <div class="chart-title">Monthly Revenue</div>
      <div class="chart-subtitle">This year vs last year (exc. VAT)</div>
      <div class="chart-container" style="height:240px;"><canvas id="revenueChart"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">Month Comparison</div>
      <div class="chart-subtitle">This month vs last month</div>
      <div class="compare-cards">
        <div class="compare-card"><div class="compare-card-label" id="thisMonthLabel">This Month</div><div class="compare-card-value" id="thisMonthRev">\u00a3\u2014</div></div>
        <div class="compare-card"><div class="compare-card-label" id="lastMonthLabel">Last Month</div><div class="compare-card-value" id="lastMonthRev">\u00a3\u2014</div></div>
      </div>
      <div class="chart-container" style="height:150px;"><canvas id="optionChart"></canvas></div>
      <div class="chart-subtitle" style="margin-top:10px;margin-bottom:0;">Bookings by training option (this year)</div>
    </div>
  </div>

  <!-- ALL BOOKINGS -->
  <div id="sectionAllBookings">
    <div class="section-header" style="flex-wrap:wrap;gap:10px;">
      <div class="section-title">\ud83d\udccb All Bookings <span class="badge green" id="allBadge">0</span></div>
      <div class="filter-bar" style="flex-wrap:wrap;gap:6px;">
        <div style="position:relative;display:flex;align-items:center;">
          <span style="position:absolute;left:9px;font-size:13px;color:var(--text--dark--30);pointer-events:none;">\ud83d\udd0d</span>
          <input class="filter-input" id="bookingSearch" type="text" placeholder="Search company or contact\u2026" oninput="resetPageAndRender()" style="width:210px;padding-left:30px;">
        </div>
        <select class="filter-select" id="filterStatus" onchange="resetPageAndRender()">
          <option value="">All Statuses</option>
          <option value="Unassigned">Unassigned</option>
          <option value="Assigned">Assigned</option>
          <option value="Booked">Booked</option>
          <option value="Pending">Pending</option>
          <option value="Cancelled">Cancelled</option>
        </select>
        <select class="filter-select" id="filterTrainer" onchange="resetPageAndRender()"><option value="">All Trainers</option></select>
        <select class="filter-select" id="filterOption" onchange="resetPageAndRender()">
          <option value="">All Options</option>
          <option value="1">Option 1</option><option value="2">Option 2</option>
          <option value="3">Option 3</option><option value="4">Option 4</option><option value="5">Option 5</option>
        </select>
        <div style="display:flex;align-items:center;gap:4px;">
          <label style="font-size:11px;color:var(--text--dark--30);white-space:nowrap;">From</label>
          <input class="filter-input" id="filterDateFrom" type="date" onchange="resetPageAndRender()" style="width:130px;">
        </div>
        <div style="display:flex;align-items:center;gap:4px;">
          <label style="font-size:11px;color:var(--text--dark--30);white-space:nowrap;">To</label>
          <input class="filter-input" id="filterDateTo" type="date" onchange="resetPageAndRender()" style="width:130px;">
        </div>
        <button class="btn btn-ghost btn-sm" id="clearFiltersBtn" onclick="clearBookingFilters()" style="display:none;white-space:nowrap;">\u2715 Clear</button>
      </div>
    </div>
    <div class="all-bookings">
      <div class="table-wrap">
        <table id="allBookingsTable">
          <thead><tr><th>Submitted</th><th>Company</th><th>Contact</th><th>Training Option</th><th>Value</th><th>Trainer</th><th>Status</th></tr></thead>
          <tbody id="allBookingsBody"><tr><td colspan="7"><div class="empty-state"><div class="spinner"></div><div class="empty-state-text" style="margin-top:8px;color:var(--text--dark--30);">Connecting to sheet\u2026</div></div></td></tr></tbody>
        </table>
      </div>
      <div class="pagination" id="paginationBar">
        <button class="page-btn" id="prevBtn" onclick="changePage(-1)">\u2190 Prev</button>
        <span id="pageInfo">Page 1</span>
        <button class="page-btn" id="nextBtn" onclick="changePage(1)">Next \u2192</button>
        <span style="margin-left:auto;" id="rowCount"></span>
      </div>
      <div class="data-note">Data pulled from Google Sheets via Apps Script. Click Refresh to get latest data.</div>
    </div>
  </div>

</main>

<!-- TRAINER MANAGEMENT MODAL -->
<div class="modal-overlay" id="trainerModalOverlay" onclick="closeTrainerModal(event)">
  <div class="modal" style="max-width:600px;width:96vw;">
    <div class="modal-header"><span class="modal-title">\ud83d\udc64 Manage Trainers &amp; Permissions</span><button class="modal-close" onclick="closeTrainerModal()">\u2715</button></div>
    <div class="modal-body" style="padding:0;">
      <div style="padding:16px 20px 0;"><div class="trainer-list" id="trainerModalList"></div></div>
      <div style="padding:16px 20px;border-top:1px solid var(--ui--underline--light-grey);background:var(--card-light-grey);">
        <div style="font-size:11px;font-weight:700;letter-spacing:0.6px;text-transform:uppercase;color:var(--text--dark--30);margin-bottom:10px;">Add New Trainer</div>
        <div style="display:flex;gap:8px;margin-bottom:12px;">
          <input class="trainer-add-input" id="newTrainerInput" type="text" placeholder="Trainer name\u2026" style="flex:1;" onkeydown="if(event.key==='Enter') addTrainer()">
        </div>
        <div style="font-size:11px;font-weight:600;color:var(--text--dark--40);margin-bottom:6px;">Permission Preset</div>
        <div class="perm-preset-row" id="presetBtns">
          <button class="perm-preset-btn" onclick="applyPreset('admin')">\ud83d\udc51 Admin</button>
          <button class="perm-preset-btn" onclick="applyPreset('editor')">\u270f\ufe0f Editor</button>
          <button class="perm-preset-btn" onclick="applyPreset('viewer')">\ud83d\udc41 View Only</button>
        </div>
        <div id="newTrainerPermissions" style="background:#fff;border:1px solid var(--ui--underline--light-grey);border-radius:6px;padding:10px 14px;margin-bottom:12px;max-height:260px;overflow-y:auto;"></div>
        <button class="btn btn-primary" onclick="addTrainer()" style="width:100%;justify-content:center;">+ Add Trainer</button>
      </div>
    </div>
  </div>
</div>

<!-- REASSIGN TRAINER MODAL -->
<div class="modal-overlay" id="reassignModalOverlay">
  <div class="modal" style="max-width:480px;">
    <div class="modal-header" style="background:#fef3f2;border-bottom:1px solid #fecaca;">
      <span class="modal-title" style="color:#c0303d;">\u26a0\ufe0f Trainer Has Active Enquiries</span>
    </div>
    <div class="modal-body">
      <div id="reassignWarningText" style="font-size:13px;color:var(--text--dark--50);margin-bottom:16px;line-height:1.5;"></div>
      <div style="background:var(--card-light-grey);border-radius:6px;padding:12px;margin-bottom:16px;">
        <div id="reassignEnquiryList" style="font-size:12px;max-height:180px;overflow-y:auto;"></div>
      </div>
      <div style="margin-bottom:6px;">
        <label style="font-size:12px;font-weight:600;color:var(--text--dark--40);display:block;margin-bottom:6px;">Reassign all enquiries to:</label>
        <select id="reassignTargetSelect" style="width:100%;border:1px solid var(--ui--underline--light-grey);border-radius:6px;padding:8px 10px;font-size:13px;font-family:Arial,sans-serif;background:#fff;">
          <option value="">\u2014 Select a trainer \u2014</option>
        </select>
      </div>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;padding:14px 20px;border-top:1px solid var(--ui--underline--light-grey);background:var(--card-light-grey);">
      <button class="btn btn-ghost" onclick="closeReassignModal()">Cancel</button>
      <button class="btn" id="confirmReassignBtn" onclick="confirmReassignAndDelete()" style="background:#c0303d;color:#fff;border:none;">Reassign &amp; Remove Trainer</button>
    </div>
  </div>
</div>

<!-- KPI DETAIL MODAL -->
<div class="kpi-modal-overlay" id="kpiModalOverlay" onclick="closeKpiModal(event)">
  <div class="kpi-modal">
    <div class="kpi-modal-header">
      <div class="kpi-modal-header-left">
        <div class="kpi-modal-title" id="kpiModalTitle">\u2014</div>
        <div class="kpi-modal-subtitle" id="kpiModalSubtitle">\u2014</div>
        <div class="kpi-modal-headline" id="kpiModalHeadline">\u2014</div>
      </div>
      <button class="kpi-modal-close" onclick="closeKpiModal()">\u2715 Close</button>
    </div>
    <div class="kpi-modal-stats" id="kpiModalStats"></div>
    <div class="kpi-modal-body"><table class="kpi-modal-table"><thead id="kpiModalTableHead"></thead><tbody id="kpiModalTableBody"></tbody></table></div>
    <div class="kpi-modal-footer"><button class="btn btn-ghost" onclick="closeKpiModal()">\u2715 Close</button></div>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<!-- ACTIVITY PANEL OVERLAY -->
<div class="activity-panel-overlay" id="activityPanelOverlay" onclick="closeActivityPanel()"></div>

<!-- ACTIVITY PANEL -->
<div class="activity-panel" id="activityPanel">
  <div class="activity-panel-header">
    <div><div class="activity-panel-title">\ud83d\udd50 Activity Feed</div><div class="activity-panel-sub">All changes made on this dashboard</div></div>
    <button class="activity-close" onclick="closeActivityPanel()">\u2715</button>
  </div>
  <div class="activity-user-bar">
    <div class="activity-user-avatar" id="activityAvatar">?</div>
    <div class="activity-user-name" id="activityUserDisplay">Not set</div>
    <button onclick="changeSelfPin()" style="font-size:11px;background:none;border:none;color:var(--action-primary-blue);cursor:pointer;font-family:Arial,sans-serif;padding:0;text-decoration:underline;">Change PIN</button>
  </div>
  <div class="activity-toolbar">
    <span class="activity-count" id="activityCount">0 events</span>
    <button class="activity-clear-btn" onclick="clearActivityLog()">\ud83d\uddd1 Clear log</button>
  </div>
  <div class="activity-feed-body" id="activityFeedBody">
    <div class="activity-empty"><div class="activity-empty-icon">\ud83d\udccb</div>No activity yet \u2014 changes you make will appear here</div>
  </div>
</div>

<!-- USERNAME PROMPT MODAL -->
<div class="username-modal-overlay" id="usernameModalOverlay">
  <div class="username-modal">
    <div class="username-modal-icon">\ud83d\udc64</div>
    <div class="username-modal-title">Who are you?</div>
    <div class="username-modal-sub">Your name will be recorded in the activity feed whenever you make a change.</div>
    <input type="text" id="usernameInput" placeholder="Enter your name\u2026" maxlength="40" onkeydown="if(event.key==='Enter') saveUsername()">
    <button class="btn btn-primary" style="width:100%;justify-content:center;" onclick="saveUsername()">Set Name &amp; Continue</button>
  </div>
</div>

<!-- EDIT PERMISSIONS MODAL -->
<div class="username-modal-overlay" id="editPermOverlay" style="z-index:800;">
  <div class="username-modal" style="width:520px;max-width:96vw;padding:0;text-align:left;border-radius:10px;overflow:hidden;">
    <div style="padding:18px 22px 14px;background:var(--text--dark--50);color:#fff;display:flex;align-items:center;justify-content:space-between;">
      <div><div style="font-size:14px;font-weight:700;">Edit Permissions</div><div style="font-size:11px;color:rgba(255,255,255,0.6);margin-top:2px;" id="editPermName">\u2014</div></div>
      <button onclick="closeEditPermModal()" style="background:rgba(255,255,255,0.1);border:none;color:#fff;cursor:pointer;padding:5px 9px;border-radius:4px;font-size:16px;">\u2715</button>
    </div>
    <div style="padding:10px 20px;background:#f6f8ff;border-bottom:1px solid #e0e8ff;display:flex;align-items:center;gap:10px;">
      <span style="font-size:12px;color:var(--text--dark--40);flex:1;">Adjust toggles below, then preview the dashboard exactly as this user would see it.</span>
      <button class="btn" id="shadowPreviewBtn" onclick="enterShadowMode()" style="background:#7c3aed;color:#fff;border:none;font-size:12px;padding:6px 14px;gap:6px;">
        \ud83d\udc41 Preview as <span id="shadowBtnName">\u2014</span>
      </button>
    </div>
    <div id="editPermBody" style="padding:16px 20px;max-height:340px;overflow-y:auto;"></div>
    <div style="padding:12px 20px;border-top:1px solid var(--ui--underline--light-grey);background:var(--card-light-grey);display:flex;justify-content:flex-end;gap:8px;">
      <button class="btn btn-ghost" onclick="closeEditPermModal()">Cancel</button>
      <button class="btn btn-primary" id="editPermSaveBtn">Save Permissions</button>
    </div>
  </div>
</div>

<!-- CALENDAR SETTINGS MODAL -->
<div class="username-modal-overlay" id="calSettingsOverlay" onclick="if(event.target===this)closeCalSettings()">
  <div class="username-modal" style="width:480px;max-width:96vw;padding:0;text-align:left;border-radius:10px;overflow:hidden;">
    <div style="padding:18px 22px 14px;background:var(--text--dark--50);color:#fff;display:flex;align-items:center;justify-content:space-between;">
      <div><div style="font-size:14px;font-weight:700;">\ud83d\udcc5 Google Calendar Settings</div><div style="font-size:11px;color:rgba(255,255,255,0.6);margin-top:2px;">Connect your shared team calendar</div></div>
      <button onclick="closeCalSettings()" style="background:rgba(255,255,255,0.1);border:none;color:#fff;cursor:pointer;padding:5px 9px;border-radius:4px;font-size:16px;">\u2715</button>
    </div>
    <div style="padding:20px;">
      <div style="font-size:12px;color:var(--text--dark--40);margin-bottom:16px;line-height:1.6;background:#f6f8ff;padding:10px 12px;border-radius:6px;border:1px solid #e0e8ff;">
        <strong>How to find your Calendar ID:</strong><br>Google Calendar \u2192 Settings \u2192 Click your calendar \u2192 Scroll to "Integrate calendar" \u2192 Copy the Calendar ID
      </div>
      <label style="font-size:12px;font-weight:600;color:var(--text--dark--40);display:block;margin-bottom:6px;">Shared Team Calendar ID</label>
      <input type="text" id="calIdInput" placeholder="e.g. abc123@group.calendar.google.com" style="width:100%;box-sizing:border-box;border:1.5px solid var(--ui--underline--light-grey);border-radius:6px;padding:9px 12px;font-size:13px;font-family:Arial,sans-serif;margin-bottom:16px;">
      <div style="font-size:11px;color:var(--text--dark--30);margin-bottom:10px;">\ud83d\udca1 The calendar must be accessible from your Apps Script (the script owner must be shared on the calendar).</div>
      <div id="calSettingsPerTrainer" style="margin-bottom:16px;"></div>
    </div>
    <div style="padding:12px 20px;border-top:1px solid var(--ui--underline--light-grey);background:var(--card-light-grey);display:flex;justify-content:space-between;gap:8px;align-items:center;">
      <span id="calSettingsStatus" style="font-size:11px;color:var(--text--dark--30);"></span>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-ghost" onclick="closeCalSettings()">Cancel</button>
        <button class="btn btn-primary" onclick="saveCalSettings()">Save &amp; Sync</button>
      </div>
    </div>
  </div>
</div>

<!-- ASSIGN ENQUIRY MODAL -->
<div class="booked-date-modal-overlay" id="assignModal" style="z-index:600;">
  <div class="booked-date-modal" style="max-width:480px;">
    <div class="booked-date-modal-header" style="background:linear-gradient(135deg,#1a3a8f,#2147f4);">
      <div class="booked-date-modal-title">&#128101; Assign Enquiry</div>
      <div class="booked-date-modal-company" id="assignModalCompany"></div>
    </div>
    <div class="booked-date-modal-body">
      <label style="font-size:12px;font-weight:600;color:var(--text--dark--40);display:block;margin-bottom:6px;">Training Option <span style="color:#c0303d;">*</span></label>
      <select id="assignModalOption" onchange="assignModalAutoFillValue()" style="width:100%;border:1.5px solid var(--ui--underline--light-grey);border-radius:6px;padding:9px 12px;font-size:13px;font-family:Arial,sans-serif;margin-bottom:14px;background:#fff;">
        <option value="">-- Select option --</option>
        <option value="1">Option 1 -- On Demand + Help Centre</option>
        <option value="2">Option 2 -- Personalised 1 Day</option>
        <option value="3">Option 3 -- Personalised 2 Day</option>
        <option value="4">Option 4 -- Accounting + Go Live</option>
        <option value="5">Option 5 -- Live HQ Session</option>
      </select>
      <label style="font-size:12px;font-weight:600;color:var(--text--dark--40);display:block;margin-bottom:6px;">Assign Trainer <span style="color:#c0303d;">*</span></label>
      <div id="assignModalSuggest" style="display:none;margin-bottom:8px;padding:7px 10px;background:#e8eeff;border:1px solid #b8caff;border-radius:6px;font-size:11px;color:#2147f4;">
        &#128161; <strong>Suggested (lowest workload):</strong> <span id="assignModalSuggestName"></span>
        &nbsp;<button type="button" onclick="useAssignSuggestion()" style="background:#2147f4;color:#fff;border:none;border-radius:4px;padding:2px 8px;font-size:11px;cursor:pointer;font-family:Arial,sans-serif;">Use this</button>
      </div>
      <select id="assignModalTrainer" style="width:100%;border:1.5px solid var(--ui--underline--light-grey);border-radius:6px;padding:9px 12px;font-size:13px;font-family:Arial,sans-serif;margin-bottom:14px;background:#fff;">
        <option value="">-- Select trainer --</option>
      </select>
      <label style="font-size:12px;font-weight:600;color:var(--text--dark--40);display:block;margin-bottom:6px;">Invoice Value <span style="color:#c0303d;">*</span></label>
      <div style="display:flex;align-items:center;margin-bottom:8px;">
        <span style="background:var(--card-light-grey);border:1.5px solid var(--ui--underline--light-grey);border-right:none;border-radius:6px 0 0 6px;padding:9px 12px;font-size:14px;font-weight:700;color:var(--text--dark--40);">&#163;</span>
        <input type="number" id="assignModalValue" min="0" step="50" placeholder="e.g. 1100" style="flex:1;border:1.5px solid var(--ui--underline--light-grey);border-left:none;border-radius:0 6px 6px 0;padding:9px 12px;font-size:13px;font-family:Arial,sans-serif;">
      </div>
      <div style="font-size:11px;color:var(--text--dark--30);margin-bottom:4px;">All fields required. Status will be set to <strong>Pending</strong> and the enquiry will move to the Needs Action panel.</div>
      <div id="assignModalError" style="display:none;color:#c0303d;font-size:12px;font-weight:600;margin-top:8px;padding:7px 10px;background:#fde8eb;border-radius:5px;"></div>
    </div>
    <div class="booked-date-modal-footer">
      <button class="btn btn-ghost" onclick="closeAssignModal()">Cancel</button>
      <button class="btn btn-primary" onclick="confirmAssignModal()">&#10003; Assign &amp; Set Pending</button>
    </div>
  </div>
</div>

<!-- BOOKED DATE MODAL -->
<div class="booked-date-modal-overlay" id="bookedDateModal">
  <div class="booked-date-modal" style="max-width:520px;">
    <div class="booked-date-modal-header">
      <div class="booked-date-modal-title">&#128197; Confirm Training Booking</div>
      <div class="booked-date-modal-company" id="bdModalCompany"></div>
    </div>
    <div class="booked-date-modal-body">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px;">
        <div>
          <label style="font-size:12px;font-weight:600;color:var(--text--dark--40);display:block;margin-bottom:6px;">Assign Trainer <span style="color:#c0303d;">*</span></label>
          <select id="bdModalTrainerSelect" onchange="bdUpdateSummary()" style="width:100%;border:1.5px solid var(--ui--underline--light-grey);border-radius:6px;padding:8px 10px;font-size:13px;font-family:Arial,sans-serif;background:#fff;"></select>
        </div>
        <div>
          <label style="font-size:12px;font-weight:600;color:var(--text--dark--40);display:block;margin-bottom:6px;">Invoice Value <span style="color:#c0303d;">*</span></label>
          <div style="display:flex;align-items:center;">
            <span style="background:var(--card-light-grey);border:1.5px solid var(--ui--underline--light-grey);border-right:none;border-radius:6px 0 0 6px;padding:8px 10px;font-size:13px;font-weight:700;color:var(--text--dark--40);">&#163;</span>
            <input type="number" id="bdModalValueInput" min="0" step="50" placeholder="0" style="flex:1;border:1.5px solid var(--ui--underline--light-grey);border-left:none;border-radius:0 6px 6px 0;padding:8px 10px;font-size:13px;font-family:Arial,sans-serif;">
          </div>
        </div>
      </div>
      <label style="font-size:12px;font-weight:600;color:var(--text--dark--40);display:block;margin-bottom:6px;">Number of training days <span style="color:#c0303d;">*</span></label>
      <div style="display:flex;gap:8px;margin-bottom:14px;" id="bdModalDaysBtns">
        <button type="button" class="bd-days-btn active" onclick="bdSelectDays(1)">1 Day</button>
        <button type="button" class="bd-days-btn" onclick="bdSelectDays(2)">2 Days</button>
        <button type="button" class="bd-days-btn" onclick="bdSelectDays(3)">3 Days</button>
        <button type="button" class="bd-days-btn" onclick="bdSelectDays(4)">4 Days</button>
        <button type="button" class="bd-days-btn" onclick="bdSelectDays(5)">5 Days</button>
      </div>
      <label style="font-size:12px;font-weight:600;color:var(--text--dark--40);display:block;margin-bottom:6px;">First day of training <span style="color:#c0303d;">*</span></label>
      <input type="date" id="bdModalDateInput" class="booked-date-modal-input" onchange="bdUpdateSummary()" style="margin-bottom:10px;">
      <div id="bdModalSummary" style="display:none;background:#f6f8ff;border:1px solid #dde6ff;border-radius:7px;padding:12px;margin-bottom:8px;font-size:12px;line-height:1.8;color:var(--text--dark--40);"></div>
    </div>
    <div class="booked-date-modal-footer">
      <span class="booked-date-modal-footer-left" id="bdModalError" style="color:#c0303d;font-size:12px;font-weight:600;"></span>
      <button class="btn btn-ghost" onclick="cancelBookedDateModal()">Cancel</button>
      <button class="btn btn-primary" onclick="confirmBookedDateModal()">&#10003; Confirm Booking</button>
    </div>
  </div>
</div>

<script>
// =============================================
// CONFIG
// =============================================
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzCvBhFSPyyoaVsui0DCxvGQQa0V7e_UCJ5LfqvcSysTHTFlNRcx4ewlET5TyouJ0ZYow/exec';
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSvPvb_WzFGr6SKflZEob3RFpuh44lKckD4DcsoAXxKUwtYBGCtGGEqA9YkSnvBKh3pQc9nwdbfh9B2/pub?gid=1792679763&single=true&output=csv';

const OPTION_PRICES = { '1': 0, '2': 1100, '3': 1850, '4': 1000, '5': 220 };
const OPTION_LABELS = {
  '1': 'On Demand + Help Centre', '2': 'Personalised 1 Day',
  '3': 'Personalised 2 Day', '4': 'Accounting + Go Live', '5': 'Live HQ Session'
};
const OPTION_DAYS = { '1': 0, '2': 1, '3': 2, '4': 1, '5': 1 };

// =============================================
// PERMISSIONS SYSTEM
// =============================================
const USERS_KEY   = 'streetDashboardUsers_v2';
const SESSION_KEY = 'streetDashboardSession';

const ALL_PERMISSIONS = {
  edit_status:       { label: 'Edit Booking Status',          desc: 'Change status on any booking',                      group: 'Bookings'   },
  edit_trainer:      { label: 'Edit Trainer Assignment',      desc: 'Assign or change the trainer on a booking',         group: 'Bookings'   },
  edit_value:        { label: 'Edit Invoice Value',           desc: 'Change the \u00a3 value of any booking',                 group: 'Bookings'   },
  edit_booked_date:  { label: 'Edit Booked Date',             desc: 'Set or change the confirmed training date',         group: 'Bookings'   },
  view_workload:     { label: 'View Trainer Workload',        desc: 'See trainer workload cards and availability',       group: 'Sections'   },
  view_calendar:     { label: 'View Training Calendar',       desc: 'See the training calendar and sync Google Calendar',group: 'Sections'   },
  view_unassigned:   { label: 'View Unassigned Requests',     desc: 'See and action new unassigned booking requests',    group: 'Sections'   },
  view_needs_action: { label: 'View Needs Action',            desc: 'See assigned/pending bookings awaiting confirmation',group: 'Sections'  },
  view_performance:  { label: 'View Performance Overview',    desc: 'See KPI cards and revenue charts',                  group: 'Sections'   },
  view_all_bookings: { label: 'View All Bookings',            desc: 'See and filter the full bookings table',            group: 'Sections'   },
  manage_trainers:   { label: 'Manage Trainers',              desc: 'Add, remove trainers and edit their permissions',   group: 'Admin'      },
  reassign_trainers: { label: 'Reassign Enquiries',           desc: 'Bulk-reassign enquiries between trainers',          group: 'Admin'      },
  refresh_data:      { label: 'Refresh Data',                 desc: 'Reload data from Google Sheets',                   group: 'Admin'      },
  clear_activity:    { label: 'Clear Activity Log',           desc: 'Permanently delete the activity feed history',      group: 'Admin'      },
  view_activity:     { label: 'View Activity Feed',           desc: 'See the log of all dashboard changes',              group: 'Admin'      },
  nav_feedback:      { label: 'Training Feedback Dashboard',  desc: 'Access to Training CSAT/Feedback Dashboard link',   group: 'Navigation' },
  nav_til:           { label: 'TIL Tracker',                  desc: 'Access to TIL Tracker link',                       group: 'Navigation' },
  nav_survey:        { label: 'Client Feedback Survey',       desc: 'Access to Client Feedback Survey link',             group: 'Navigation' },
  nav_spreadsheet:   { label: 'Bookings Spreadsheet',         desc: 'Access to Google Sheets bookings spreadsheet',      group: 'Navigation' },
  nav_request_form:  { label: 'Training Request Form',        desc: 'Access to the training request form link',          group: 'Navigation' },
};

const PERMISSION_PRESETS = {
  admin: {
    edit_status:true, edit_trainer:true, edit_value:true, edit_booked_date:true,
    view_workload:true, view_calendar:true, view_unassigned:true, view_needs_action:true,
    view_performance:true, view_all_bookings:true,
    manage_trainers:true, reassign_trainers:true, refresh_data:true,
    clear_activity:true, view_activity:true,
    nav_feedback:true, nav_til:true, nav_survey:true, nav_spreadsheet:true, nav_request_form:true,
  },
  editor: {
    edit_status:true, edit_trainer:true, edit_value:true, edit_booked_date:true,
    view_workload:true, view_calendar:true, view_unassigned:true, view_needs_action:true,
    view_performance:true, view_all_bookings:true,
    manage_trainers:false, reassign_trainers:true, refresh_data:true,
    clear_activity:false, view_activity:true,
    nav_feedback:true, nav_til:true, nav_survey:true, nav_spreadsheet:true, nav_request_form:true,
  },
  viewer: {
    edit_status:false, edit_trainer:false, edit_value:false, edit_booked_date:false,
    view_workload:false, view_calendar:false, view_unassigned:false, view_needs_action:false,
    view_performance:false, view_all_bookings:false,
    manage_trainers:false, reassign_trainers:false, refresh_data:false,
    clear_activity:false, view_activity:false,
    nav_feedback:false, nav_til:false, nav_survey:false, nav_spreadsheet:false, nav_request_form:true,
  },
};

const BOOKINGS_ONLY_PRESET = {
  edit_status:true, edit_trainer:true, edit_value:true, edit_booked_date:true,
  view_workload:true, view_calendar:true, view_unassigned:true, view_needs_action:true,
  view_performance:false, view_all_bookings:true,
  manage_trainers:false, reassign_trainers:true, refresh_data:true,
  clear_activity:false, view_activity:false,
  nav_feedback:true, nav_til:true, nav_survey:false, nav_spreadsheet:false, nav_request_form:true,
};

function getUsers() {
  let users = [];
  try { const saved = JSON.parse(localStorage.getItem(USERS_KEY) || 'null'); if (Array.isArray(saved)) users = saved; } catch(e) {}
  let amy = users.find(u => u.name === 'Amy');
  if (!amy) { amy = { name: 'Amy', permissions: {} }; users.unshift(amy); }
  amy.permissions = { ...PERMISSION_PRESETS.admin };
  let max = users.find(u => u.name === 'Max');
  if (!max) { max = { name: 'Max', permissions: {} }; const ai = users.findIndex(u => u.name === 'Amy'); users.splice(ai + 1, 0, max); }
  max.permissions = { ...BOOKINGS_ONLY_PRESET };
  try { localStorage.setItem(USERS_KEY, JSON.stringify(users)); } catch(e) {}
  return users;
}
function saveUsers(arr) { try { localStorage.setItem(USERS_KEY, JSON.stringify(arr)); } catch(e) {} }
function getCurrentUser() { try { const s = localStorage.getItem(SESSION_KEY); return s ? JSON.parse(s) : null; } catch(e) { return null; } }
function setCurrentUser(u) { try { localStorage.setItem(SESSION_KEY, JSON.stringify(u)); localStorage.setItem('streetDashboardUser', u.name); } catch(e) {} }
function hasPerm(key) { const u = getCurrentUser(); return u && u.permissions && u.permissions[key] === true; }

let USERS    = getUsers();
let TRAINERS = USERS.map(u => u.name);

function syncTrainersFromUsers() { USERS = getUsers(); TRAINERS = USERS.map(u => u.name); }

function migrateUsers() {
  let changed = false;
  let amy = USERS.find(u => u.name === 'Amy');
  if (!amy) { USERS.unshift({ name: 'Amy', permissions: { ...PERMISSION_PRESETS.admin } }); changed = true; }
  else { const allOn = Object.keys(PERMISSION_PRESETS.admin).every(k => amy.permissions[k] === true); if (!allOn) { amy.permissions = { ...PERMISSION_PRESETS.admin }; changed = true; } }
  let max = USERS.find(u => u.name === 'Max');
  if (!max) { const ai = USERS.findIndex(u => u.name === 'Amy'); USERS.splice(ai+1, 0, { name:'Max', permissions:{...BOOKINGS_ONLY_PRESET} }); changed = true; }
  else { const ok = Object.keys(BOOKINGS_ONLY_PRESET).every(k => max.permissions[k] === BOOKINGS_ONLY_PRESET[k]); if (!ok) { max.permissions = { ...BOOKINGS_ONLY_PRESET }; changed = true; } }
  if (changed) { saveUsers(USERS); syncTrainersFromUsers(); }
  const cur = getCurrentUser();
  if (cur && (cur.name === 'Amy' || cur.name === 'Max')) { const fresh = USERS.find(u => u.name === cur.name); if (fresh) setCurrentUser(fresh); }
}

// =============================================
// STATE
// =============================================
let allData = [];
let currentPage = 1;
const PAGE_SIZE = 15;
let revenueChart = null;
let optionChart = null;

const OVERRIDE_KEY = 'streetDashboardOverrides';
function getOverrides() { try { return JSON.parse(sessionStorage.getItem(OVERRIDE_KEY) || '{}'); } catch(e) { return {}; } }
function saveOverride(rowIndex, fields) { const o = getOverrides(); o[rowIndex] = Object.assign(o[rowIndex] || {}, fields); try { sessionStorage.setItem(OVERRIDE_KEY, JSON.stringify(o)); } catch(e) {} }
function applyOverrides(rows) { const o = getOverrides(); return rows.map(r => { const ov = o[r.rowIndex]; return ov ? Object.assign({}, r, ov) : r; }); }

// =============================================
// NAV
// =============================================
function toggleNav() { const d = document.getElementById('navDrawer'); d.classList.contains('open') ? closeNav() : (d.classList.add('open'), document.getElementById('navOverlay').classList.add('open'), document.getElementById('hamburgerBtn').classList.add('open')); }
function closeNav() { document.getElementById('navDrawer').classList.remove('open'); document.getElementById('navOverlay').classList.remove('open'); document.getElementById('hamburgerBtn').classList.remove('open'); }
document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeNav(); document.getElementById('kpiModalOverlay').classList.remove('open'); } });

// =============================================
// TOAST
// =============================================
function showToast(msg, type='') { const t = document.createElement('div'); t.className = `toast ${type}`; t.textContent = msg; document.getElementById('toastContainer').appendChild(t); setTimeout(() => t.remove(), 3500); }

// =============================================
// LOADING
// =============================================
function setLoading(on) { document.getElementById('loadingBar').classList.toggle('active', on); }

// =============================================
// DATA FETCHING \u2014 with hard 10s timeouts
// =============================================
async function testConnection(btn) {
  btn = btn || (event && event.target);
  btn.textContent = '\u23f3 Testing\u2026';
  btn.disabled = true;
  try {
    const res  = await fetch(APPS_SCRIPT_URL + '?action=getData');
    const text = await res.text();
    const isJSON = text.trim().startsWith('{');
    const lines = ['\u2500\u2500 Connection Test \u2500\u2500', 'HTTP status: ' + res.status];
    if (!isJSON) {
      if (text.includes('<html') || text.includes('<!DOCTYPE')) {
        lines.push('\u274c Got HTML back \u2014 script needs redeploying');
        lines.push('   Fix: Apps Script \u2192 Deploy \u2192 New Deployment');
        lines.push('   Execute as: Me  |  Who has access: Anyone');
      } else { lines.push('\u274c Non-JSON response:'); lines.push(text.slice(0, 300)); }
    } else {
      let json; try { json = JSON.parse(text); } catch(pe) { lines.push('\u274c JSON parse error: ' + pe.message); }
      if (json) {
        lines.push('\u2713 JSON received');
        lines.push('success: ' + json.success);
        lines.push('Total rows (incl header): ' + (json.data ? json.data.length : 0));
        lines.push('Columns: ' + json.cols);
        if (json.error) lines.push('\u274c Error: ' + json.error);
        if (json.data && json.data.length >= 1) {
          lines.push(''); lines.push('\u2500\u2500 Header row (first 10 cols) \u2500\u2500');
          json.data[0].slice(0, 23).forEach((h, i) => { if (h) lines.push('  Col ' + String.fromCharCode(65+i) + ' (' + (i+1) + '): ' + h); });
        }
        if (json.data && json.data.length > 1) {
          const firstRow = json.data[1];
          lines.push(''); lines.push('\u2500\u2500 First data row \u2500\u2500');
          json.data[0].slice(0, 23).forEach((h, i) => { const val = firstRow[i]; if (h || val) lines.push('  ' + h + ': "' + String(val||'').slice(0,60) + '"'); });
        }
      }
    }
    alert(lines.join('
'));
  } catch(e) {
    alert('\u274c FAILED: ' + e.message + '

Make sure Apps Script is deployed as:
\u2022 Execute as: Me
\u2022 Who has access: Anyone');
  }
  btn.textContent = '\ud83d\udd0d Test';
  btn.disabled = false;
}

async function loadData() {
  setLoading(true);
  document.getElementById('lastUpdated').textContent = 'Loading\u2026';

  async function _fetch(url, ms) {
    const ctrl = new AbortController();
    const timer = setTimeout(() => ctrl.abort(), ms);
    try { const res = await fetch(url, { signal: ctrl.signal }); clearTimeout(timer); return res; }
    catch(e) { clearTimeout(timer); throw e; }
  }

  function finish(data, label) {
    allData = applyOverrides(data);
    try { processData(); } catch(e) { console.error('[Dashboard] processData error:', e); }
    document.getElementById('lastUpdated').textContent = label;
    setLoading(false);
    try { applyPermissions(); } catch(e) {}
  }

  // \u2500\u2500 1. Apps Script (10s timeout) \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
  try {
    document.getElementById('lastUpdated').textContent = 'Connecting to sheet\u2026';
    const res  = await _fetch(APPS_SCRIPT_URL + '?action=getData', 10000);
    const text = await res.text();
    console.log('[Dashboard] Response start:', text.slice(0, 80));
    if (text && text.trim().startsWith('{')) {
      const json = JSON.parse(text);
      if (json && json.data && json.data.length >= 1) {
        const parsed = parseAppsScriptData(json.data);
        console.log('[Dashboard] Parsed', parsed.length, 'rows from Apps Script');
        finish(parsed, '\u2713 Live \u2014 ' + parsed.length + ' rows \u2014 ' + new Date().toLocaleTimeString('en-GB'));
        return;
      }
      if (json && json.error) { console.warn('[Dashboard] Apps Script error:', json.error); }
    } else if (text.includes('<!DOCTYPE') || text.includes('<html')) {
      console.warn('[Dashboard] Got HTML \u2014 Apps Script needs redeploying');
    }
  } catch(e) {
    console.warn('[Dashboard] Apps Script fetch failed:', e.name === 'AbortError' ? 'Timed out (10s)' : e.message);
  }

  // \u2500\u2500 2. CSV fallback (10s timeout) \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
  try {
    document.getElementById('lastUpdated').textContent = 'Trying CSV fallback\u2026';
    const res2  = await _fetch(CSV_URL, 10000);
    const text2 = await res2.text();
    if (text2 && text2.length > 200 && text2.includes(',')) {
      const parsed2 = parseCSV(text2);
      console.log('[Dashboard] Parsed', parsed2.length, 'rows from CSV');
      if (parsed2.length > 0) {
        finish(parsed2, '\u26a0 CSV mode \u2014 ' + parsed2.length + ' rows \u2014 ' + new Date().toLocaleTimeString('en-GB'));
        showToast('Loaded via CSV. Apps Script write-back limited \u2014 check deployment.', '');
        return;
      }
    }
  } catch(e) {
    console.warn('[Dashboard] CSV failed:', e.name === 'AbortError' ? 'Timed out' : e.message);
  }

  // \u2500\u2500 3. Demo data \u2014 always resolves \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
  console.warn('[Dashboard] Falling back to demo data');
  finish(generateDemoData(), '\u26a0 Demo data \u2014 sheet unreachable');
  showToast('Could not reach the sheet. Showing demo data. Click \ud83d\udd0d Test to diagnose.', 'error');
}

// =============================================
// PARSING \u2014 Apps Script JSON
// =============================================
function parseAppsScriptData(rows) {
  if (!rows || rows.length < 2) return [];
  const headers = rows[0].map(h => String(h).trim().toLowerCase());
  return rows.slice(1).map((row, i) => {
    const obj = {};
    headers.forEach((h, j) => { obj[h] = row[j] !== undefined && row[j] !== null ? String(row[j]) : ''; });
    return normaliseRow(obj, i + 2);
  }).filter(r => r.company || r.contact || r.email || r.trainer);
}

function parseCSV(text) {
  const lines = text.split('
').filter(l => l.trim());
  if (lines.length < 2) return [];
  const headers = parseCSVRow(lines[0]).map(h => h.trim().toLowerCase());
  return lines.slice(1).map((line, i) => {
    const vals = parseCSVRow(line);
    const obj = {};
    headers.forEach((h, j) => { obj[h] = (vals[j] || '').trim(); });
    return normaliseRow(obj, i + 2);
  }).filter(r => r.company || r.contact || r.email || r.trainer);
}

function parseCSVRow(line) {
  const result = []; let cur = ''; let inQ = false;
  for (let i = 0; i < line.length; i++) {
    const c = line[i];
    if (c === '"') { inQ = !inQ; }
    else if (c === ',' && !inQ) { result.push(cur); cur = ''; }
    else { cur += c; }
  }
  result.push(cur);
  return result;
}

function normaliseRow(obj, rowIndex) {
  const get = (...keys) => {
    for (const k of keys) { for (const ok of Object.keys(obj)) { if (ok === k) return obj[ok]; } }
    for (const k of keys) { for (const ok of Object.keys(obj)) { if (ok.includes(k)) return obj[ok]; } }
    return '';
  };

  // Keys ordered most-specific first to avoid greedy partial matches
  const company      = get('company / business name:', 'company / business name', 'company name', 'company', 'organisation', 'business', 'agency');
  const contact      = get('client stakeholder name and phone number (authorising training)', 'client stakeholder name', 'stakeholder', 'authorising training', 'contact', 'name');
  const email        = get('email address', 'email');
  const optionRaw    = get('what type of training are you interested in?', 'what type of training', 'training option', 'type of training', 'option', 'training type', 'package');
  const preferredDate = get('preferred training date(s)', 'preferred training date', 'preferred date');
  const attendees    = get('attendees', 'delegates', 'number of');
  const trainer      = get('assigned trainer', 'trainer');
  const status       = get('status');
  const notes        = get('are there specific features or workflows', 'specific features', 'notes', 'additional', 'comments');
  const invoiceValue = get('invoice value', 'invoice');
  const timestamp    = get('timestamp');

  // \u2500\u2500 Option detection: keywords FIRST, never rely on first digit \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
  let option = '2';
  const _optL = String(optionRaw).toLowerCase();
  if (_optL.includes('account') || _optL.includes('go-live') || _optL.includes('go live') || _optL.includes('lettings accounting')) {
    option = '4';
  } else if (_optL.includes('hq') || _optL.includes('manchester') || (_optL.includes('live') && _optL.includes('street'))) {
    option = '5';
  } else if (_optL.includes('2 day') || _optL.includes('2 days') || _optL.includes('back to back') || _optL.includes('two day')) {
    option = '3';
  } else if (_optL.includes('on demand') || _optL.includes('help centre') || _optL.includes('online sales') || _optL.includes('video tutorial')) {
    option = '1';
  } else if (_optL.includes('1 day') || _optL.includes('1/2 day') || _optL.includes('personalised') || _optL.includes('in office')) {
    option = '2';
  } else {
    const optNumMatch = String(optionRaw).match(/option\\s*([1-5])/i);
    if (optNumMatch) option = optNumMatch[1];
  }

  const numAttendees  = parseInt(attendees) || 1;
  const basePrice     = parseInt(OPTION_PRICES[option]) || 0;
  const parsedInvoice = invoiceValue ? parseFloat(String(invoiceValue).replace(/[\u00a3,\\s]/g, '')) : NaN;
  const revenue       = !isNaN(parsedInvoice) && parsedInvoice > 0
    ? parsedInvoice
    : (option === '5' ? basePrice * numAttendees : basePrice);

  const parsedDate = parseDate(timestamp || preferredDate);

  return {
    rowIndex,
    timestamp: timestamp || '',
    date:        parsedDate,
    company:     company || '',
    contact:     contact || '',
    email:       email   || '',
    option,
    optionLabel: OPTION_LABELS[option] || 'Option ' + option,
    preferredDate: preferredDate || '',
    attendees:   numAttendees,
    trainer:     trainer || '',
    status:      status  || (trainer ? 'Assigned' : 'Unassigned'),
    notes:       notes   || '',
    bookedOn:    formatDateInput(get('booked on date', 'booked on', 'date booked')) || '',
    revenue
  };
}

// \u2500\u2500 parseDate \u2014 handles DD/MM/YYYY (UK/Google Sheets) and ISO \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function parseDate(str) {
  if (!str) return null;
  const s = String(str).trim();
  const dmyMatch = s.match(/^(\\d{1,2})\\/(\\d{1,2})\\/(\\d{4})/);
  if (dmyMatch) {
    const d = new Date(Number(dmyMatch[3]), Number(dmyMatch[2]) - 1, Number(dmyMatch[1]));
    return isNaN(d.getTime()) ? null : d;
  }
  const d = new Date(s);
  return isNaN(d.getTime()) ? null : d;
}

function formatDateInput(val) {
  if (!val) return '';
  const s = String(val).trim();
  if (/^\\d{4}-\\d{2}-\\d{2}/.test(s)) return s.slice(0, 10);
  const m = s.match(/^(\\d{1,2})\\/(\\d{1,2})\\/(\\d{4})/);
  if (m) return m[3] + '-' + m[2].padStart(2,'0') + '-' + m[1].padStart(2,'0');
  const d = new Date(s);
  if (!isNaN(d.getTime())) return d.toISOString().slice(0, 10);
  return '';
}

// =============================================
// DEMO DATA
// =============================================
function generateDemoData() {
  const now = new Date(), year = now.getFullYear(), lastYear = year - 1;
  const rows = [];
  let rowIdx = 2;
  const companies = ['Acorn Estates','Bridgewater Properties','Chapman & Co','Dalton Lettings','Elara Homes','Foxcroft Realty','Grange Lettings','Harfield & Sons','Ivory Keys','Jameson Agents','Keystone Lettings','Lakewood Homes'];
  const contacts  = ['James Wilson','Sarah Brown','Michael Davies','Emma Jones','Oliver Smith','Charlotte Taylor','Harry White','Amelia Harris','George Clark','Lily Walker','Noah Robinson','Sophia Lewis'];
  for (let m = 0; m <= now.getMonth(); m++) {
    const count = 3 + Math.floor(Math.random() * 5);
    for (let i = 0; i < count; i++) {
      const day = 1 + Math.floor(Math.random() * 28);
      const dateObj = new Date(year, m, day);
      if (dateObj > now) continue;
      const opt = ['2','2','3','3','4','5','1'][Math.floor(Math.random() * 7)];
      const ci = (m * 3 + i) % companies.length;
      const ti = Math.floor(Math.random() * TRAINERS.length);
      const isNew = (m === now.getMonth() && i >= 2);
      const na = opt === '5' ? (2 + Math.floor(Math.random() * 4)) : 1;
      rows.push({ rowIndex: rowIdx++, timestamp: dateObj.toISOString(), date: dateObj, company: companies[ci], contact: contacts[ci], email: '', option: opt, optionLabel: OPTION_LABELS[opt], preferredDate: '', attendees: na, trainer: isNew ? '' : TRAINERS[ti], status: isNew ? 'New' : (Math.random() > 0.3 ? 'Booked' : 'Assigned'), notes: '', bookedOn: isNew ? '' : dateObj.toISOString().slice(0,10), revenue: opt === '5' ? OPTION_PRICES[opt] * na : OPTION_PRICES[opt] });
    }
  }
  for (let m = 0; m < 12; m++) {
    const count = 2 + Math.floor(Math.random() * 4);
    for (let i = 0; i < count; i++) {
      const day = 1 + Math.floor(Math.random() * 28);
      const dateObj = new Date(lastYear, m, day);
      const opt = ['2','2','3','4','5'][Math.floor(Math.random() * 5)];
      const ci = (m * 2 + i) % companies.length;
      const ti = Math.floor(Math.random() * TRAINERS.length);
      const na = opt === '5' ? (2 + Math.floor(Math.random() * 3)) : 1;
      rows.push({ rowIndex: rowIdx++, timestamp: dateObj.toISOString(), date: dateObj, company: companies[ci]+' (LY)', contact: contacts[ci], email: '', option: opt, optionLabel: OPTION_LABELS[opt], preferredDate: '', attendees: na, trainer: TRAINERS[ti], status: 'Booked', notes: '', bookedOn: dateObj.toISOString().slice(0,10), revenue: opt === '5' ? OPTION_PRICES[opt] * na : OPTION_PRICES[opt] });
    }
  }
  return rows;
}

// =============================================
// PROCESS & RENDER
// =============================================
function processData() {
  renderUnassigned();
  renderActionPanel();
  renderKPIs();
  renderCharts();
  renderTrainerWorkload();
  renderAllBookings();
  populateTrainerFilter();
  populateCalTrainerFilter();
  renderCalendar();
  renderUpcoming();
  updateTrainerAvailability();
}

// =============================================
// UNASSIGNED REQUESTS
// =============================================
function renderUnassigned() {
  const unassigned = allData.filter(r => {
    if (['Booked','Cancelled','Complete','Pending','Assigned'].includes(r.status)) return false;
    if (r.trainer && r.trainer.trim()) return false;
    if (r.date && r.date < new Date('2025-01-01')) return false;
    return true;
  });
  const search = (document.getElementById('searchInput')?.value || '').toLowerCase();
  const filtered = search ? unassigned.filter(r =>
    (r.company+r.contact+r.option+r.optionLabel).toLowerCase().includes(search)
  ) : unassigned;
  document.getElementById('unassignedBadge').textContent = filtered.length;
  document.getElementById('alertDot').style.display = filtered.length > 0 ? 'block' : 'none';
  const tbody = document.getElementById('newRequestsBody');
  if (filtered.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon">\u2705</div><div class="empty-state-text">No unassigned requests \u2014 all up to date!</div></div></td></tr>';
    return;
  }
  const suggested = getSuggestedTrainer();
  tbody.innerHTML = filtered.map(r => {
    const suggestChip = suggested
      ? '<div style="margin-top:4px;"><span style="font-size:10px;color:#2147f4;background:#e8eeff;border:1px solid #b8caff;border-radius:12px;padding:2px 8px;white-space:nowrap;">\u1F4A1 Suggest: '+esc(suggested)+'</span></div>'
      : '';
    const preferred = r.preferredDate ? '<span style="font-size:11px;color:var(--text--dark--30);">'+esc(r.preferredDate)+'</span>' : '<span style="font-size:11px;color:var(--text--dark--20);">\u2014</span>';
    return '<tr id="req-row-'+r.rowIndex+'">'
      +'<td style="white-space:nowrap;font-size:12px;">'+formatDate(r.date||r.timestamp)+'</td>'
      +'<td><strong>'+esc(r.company)+'</strong><br><span style="color:var(--text--dark--30);font-size:11px;">'+esc(r.email||'')+'</span></td>'
      +'<td style="font-size:12px;">'+esc(r.contact||'')+'</td>'
      +'<td><span class="option-badge opt-'+r.option+'">Opt '+r.option+' \u2014 '+esc(r.optionLabel)+'</span></td>'
      +'<td>'+preferred+'</td>'
      +'<td><div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">'
      +'<button class="action-btn-assign" onclick="openAssignModal('+r.rowIndex+',''+esc(suggested||'')+'')">\u{1F4CB} Assign</button>'
      +'<button class="action-btn-cancel" onclick="cancelEnquiry('+r.rowIndex+')">\u2715 Cancel</button>'
      +'</div>'+suggestChip+'</td>'
      +'</tr>';
  }).join('');
}
function filterRequests() { renderUnassigned(); }
function getSuggestedTrainer() {
  if (!TRAINERS.length) return '';
  const cutoff = new Date(); cutoff.setDate(cutoff.getDate()-30);
  const counts = {}; TRAINERS.forEach(t => { counts[t] = 0; });
  allData.forEach(r => { if (r.trainer && counts.hasOwnProperty(r.trainer) && (!r.date || r.date >= cutoff)) counts[r.trainer]++; });
  return TRAINERS.reduce((a,b) => counts[a] <= counts[b] ? a : b);
}

//  ASSIGN MODAL 
let _assignRowIndex = null;
function openAssignModal(rowIndex, suggested) {
  _assignRowIndex = rowIndex;
  const row = allData.find(r => r.rowIndex === rowIndex);
  if (!row) return;
  document.getElementById('assignModalCompany').textContent = row.company + (row.contact ? ' \u2014 ' + row.contact : '');
  // Pre-select option from row
  const optSel = document.getElementById('assignModalOption');
  optSel.value = row.option || '';
  // Value auto-fill
  document.getElementById('assignModalValue').value = row.revenue || (OPTION_PRICES[row.option] || '');
  // Trainer options
  const trainerSel = document.getElementById('assignModalTrainer');
  trainerSel.innerHTML = '<option value="">-- Select trainer --</option>'
    + TRAINERS.map(t => '<option value="'+esc(t)+'">'+esc(t)+'</option>').join('');
  // Suggestion chip
  const sug = suggested || getSuggestedTrainer();
  const sugDiv = document.getElementById('assignModalSuggest');
  const sugName = document.getElementById('assignModalSuggestName');
  if (sug) { sugDiv.style.display = 'block'; sugName.textContent = sug; }
  else { sugDiv.style.display = 'none'; }
  document.getElementById('assignModalError').style.display = 'none';
  document.getElementById('assignModalError').textContent = '';
  document.getElementById('assignModal').classList.add('open');
}
function closeAssignModal() {
  document.getElementById('assignModal').classList.remove('open');
  _assignRowIndex = null;
}
function useAssignSuggestion() {
  const name = document.getElementById('assignModalSuggestName').textContent;
  document.getElementById('assignModalTrainer').value = name;
}
function assignModalAutoFillValue() {
  const opt = document.getElementById('assignModalOption').value;
  const valInp = document.getElementById('assignModalValue');
  if (opt && OPTION_PRICES[opt] !== undefined) valInp.value = OPTION_PRICES[opt];
}
async function confirmAssignModal() {
  const errEl = document.getElementById('assignModalError');
  errEl.style.display = 'none';
  const option  = document.getElementById('assignModalOption').value;
  const trainer = document.getElementById('assignModalTrainer').value;
  const value   = parseFloat(document.getElementById('assignModalValue').value) || 0;
  const errors = [];
  if (!option)  errors.push('Please select a training option.');
  if (!trainer) errors.push('Please select a trainer.');
  if (!value)   errors.push('Please enter an invoice value.');
  if (errors.length) { errEl.textContent = errors.join(' '); errEl.style.display = 'block'; return; }
  const row = allData.find(r => r.rowIndex === _assignRowIndex);
  if (!row) { closeAssignModal(); return; }
  row.option      = option;
  row.optionLabel = OPTION_LABELS[option] || '';
  row.trainer     = trainer;
  row.revenue     = value;
  row.status      = 'Pending';
  saveOverride(_assignRowIndex, { option, trainer, revenue: value, status: 'Pending' });
  showToast('Saving\u2026', '');
  const url = APPS_SCRIPT_URL+'?action=assign&row='+_assignRowIndex
    +'&status=Pending&trainer='+encodeURIComponent(trainer)
    +'&value='+value+'&option='+encodeURIComponent(option);
  try { await fetch(url, {mode:'no-cors'}); } catch(e){}
  logActivity('trainer', row.company, 'Assigned \u2192 Pending', trainer);
  logActivity('value',   row.company, 'Value set', '\u00a3'+value.toLocaleString());
  closeAssignModal();
  processData();
  showToast('\u2713 Assigned to '+trainer+' \u2014 Pending', 'success');
}

//  CANCEL FROM UNASSIGNED 
async function cancelEnquiry(rowIndex) {
  if (!confirm('Cancel this enquiry? It will be moved to All Bookings with status Cancelled.')) return;
  const row = allData.find(r => r.rowIndex === rowIndex);
  if (!row) return;
  row.status  = 'Cancelled';
  row.trainer = '';
  saveOverride(rowIndex, { status: 'Cancelled', trainer: '' });
  const url = APPS_SCRIPT_URL+'?action=assign&row='+rowIndex+'&status=Cancelled&trainer=';
  try { await fetch(url, {mode:'no-cors'}); } catch(e){}
  logActivity('status', row.company, 'Cancelled from Unassigned', '');
  processData();
  showToast('Enquiry cancelled', '');
}

// =============================================
// KPIs
// =============================================
function kpiDate(r) {
  if (r.bookedOn) { const d = parseDate(r.bookedOn); if (d && !isNaN(d)) return d; }
  return r.date || null;
}
function renderKPIs() {
  const now = new Date(), year = now.getFullYear(), month = now.getMonth();
  const lastMonth = month === 0 ? 11 : month - 1, lastMonthYear = month === 0 ? year-1 : year;
  const thisYearRows  = allData.filter(r => { const d = kpiDate(r); return d && d.getFullYear()===year && r.option!=='1' && r.status==='Booked'; });
  const thisMonthRows = allData.filter(r => { const d = kpiDate(r); return d && d.getFullYear()===year && d.getMonth()===month && r.option!=='1' && r.status==='Booked'; });
  const lastMonthRows = allData.filter(r => { const d = kpiDate(r); return d && d.getFullYear()===lastMonthYear && d.getMonth()===lastMonth && r.option!=='1' && r.status==='Booked'; });
  const revYear = thisYearRows.reduce((s,r) => s+r.revenue, 0);
  const revMonth = thisMonthRows.reduce((s,r) => s+r.revenue, 0);
  const revLastMonth = lastMonthRows.reduce((s,r) => s+r.revenue, 0);
  const avgFee = thisYearRows.filter(r=>r.revenue>0).length ? Math.round(revYear / thisYearRows.filter(r=>r.revenue>0).length) : 0;
  const daysYear = thisYearRows.reduce((s,r) => s+(OPTION_DAYS[r.option]||0), 0);
  const daysMonth = thisMonthRows.reduce((s,r) => s+(OPTION_DAYS[r.option]||0), 0);
  document.getElementById('kpiRevYear').textContent = '\u00a3'+revYear.toLocaleString();
  document.getElementById('kpiRevMonth').textContent = '\u00a3'+revMonth.toLocaleString();
  document.getElementById('kpiAvgFee').textContent = avgFee ? '\u00a3'+avgFee.toLocaleString() : '\u2014';
  document.getElementById('kpiDaysYear').textContent = daysYear;
  document.getElementById('kpiDaysMonth').textContent = daysMonth+' this month';
  document.getElementById('kpiBookingsYear').textContent = thisYearRows.length;
  document.getElementById('kpiBookingsMonth').textContent = thisMonthRows.length+' this month';
  const deltaEl = document.getElementById('kpiRevMonthDelta');
  if (revLastMonth > 0) { const pct = Math.round(((revMonth-revLastMonth)/revLastMonth)*100); const up = pct>=0; deltaEl.innerHTML = '<span class="kpi-card-delta '+(up?'delta-up':'delta-down')+'">'+(up?'\u25b2':'\u25bc')+' '+Math.abs(pct)+'% vs last month</span>'; }
  const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  document.getElementById('thisMonthLabel').textContent = MONTHS[month];
  document.getElementById('lastMonthLabel').textContent = MONTHS[lastMonth];
  document.getElementById('thisMonthRev').textContent = '\u00a3'+revMonth.toLocaleString();
  document.getElementById('lastMonthRev').textContent = '\u00a3'+revLastMonth.toLocaleString();
}

// =============================================
// CHARTS
// =============================================
function renderCharts() { renderRevenueChart(); renderOptionChart(); }


// =============================================
// CHARTS
// =============================================
function renderCharts() { renderRevenueChart(); renderOptionChart(); }

function renderRevenueChart() {
  const now = new Date(), year = now.getFullYear(), lastYear = year-1;
  const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const thisYearByMonth = Array(12).fill(0), lastYearByMonth = Array(12).fill(0);
  allData.forEach(r => {
    if (r.option==='1') return; const d = kpiDate(r); if (!d) return;
    const y = d.getFullYear(), m = d.getMonth();
    if (y===year) thisYearByMonth[m]+=r.revenue;
    else if (y===lastYear) lastYearByMonth[m]+=r.revenue;
  });
  const ctx = document.getElementById('revenueChart');
  if (!ctx) return;
  if (window._revChart) { window._revChart.destroy(); }
  window._revChart = new Chart(ctx, {
    type:'line',
    data:{ labels: MONTHS,
      datasets:[
        { label: year+' Revenue', data: thisYearByMonth, borderColor:'#2147f4', backgroundColor:'rgba(33,71,244,0.08)', tension:0.35, fill:true, pointBackgroundColor:'#2147f4', pointRadius:3 },
        { label: lastYear+' Revenue', data: lastYearByMonth, borderColor:'#bbb', backgroundColor:'rgba(0,0,0,0.03)', tension:0.35, fill:false, borderDash:[4,3], pointBackgroundColor:'#bbb', pointRadius:2 }
      ]
    },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ labels:{ font:{ size:11 } } } },
      scales:{ y:{ ticks:{ callback: v => ''+v.toLocaleString(), font:{size:10} }, grid:{color:'#f0f0f0'} }, x:{ ticks:{font:{size:10}}, grid:{display:false} } }
    }
  });
}

function renderOptionChart() {
  const counts = {'1':0,'2':0,'3':0,'4':0,'5':0};
  allData.filter(r=>r.status==='Booked').forEach(r=>{ if(counts[r.option]!==undefined) counts[r.option]++; });
  const ctx = document.getElementById('optionChart');
  if (!ctx) return;
  if (window._optChart) { window._optChart.destroy(); }
  window._optChart = new Chart(ctx, {
    type:'doughnut',
    data:{ labels: Object.values(OPTION_LABELS), datasets:[{ data: Object.values(counts), backgroundColor:['#b8caff','#2147f4','#7a9cff','#beffd8','#f6be9d'], borderWidth:2, borderColor:'#fff' }] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom', labels:{ font:{size:10}, padding:8 } } } }
  });
}

// =============================================
// TRAINER WORKLOAD
// =============================================
function renderTrainerWorkload() {
  const container = document.getElementById('trainerWorkloadContainer');
  if (!container) return;
  const now = new Date(); now.setHours(0,0,0,0);
  const in30 = new Date(now); in30.setDate(in30.getDate()+30);
  container.innerHTML = TRAINERS.map(t => {
    const upcoming = allData.filter(r => r.trainer===t && r.bookedOn && !['Cancelled'].includes(r.status) && new Date(r.bookedOn) >= now && new Date(r.bookedOn) <= in30);
    const total = allData.filter(r => r.trainer===t && r.status==='Booked').length;
    const thisMonth = allData.filter(r => { const d=kpiDate(r); return r.trainer===t && r.status==='Booked' && d && d.getFullYear()===now.getFullYear() && d.getMonth()===now.getMonth(); }).length;
    return '<div class="workload-card"><div class="workload-trainer">'+esc(t)+'</div>'
      +'<div class="workload-stats"><span class="workload-stat"><strong>'+upcoming.length+'</strong><br><span style="font-size:10px;color:var(--text--dark--30);">next 30d</span></span>'
      +'<span class="workload-stat"><strong>'+thisMonth+'</strong><br><span style="font-size:10px;color:var(--text--dark--30);">this month</span></span>'
      +'<span class="workload-stat"><strong>'+total+'</strong><br><span style="font-size:10px;color:var(--text--dark--30);">total booked</span></span></div></div>';
  }).join('');
}

// =============================================
// STATUS STYLING
// =============================================
const STATUS_COLOURS = {
  'Unassigned': { bg:'#fde8eb', color:'#c0303d', border:'#c0303d' },
  'Assigned':   { bg:'#f5ede5', color:'#8a5a2a', border:'#8a5a2a' },
  'Booked':     { bg:'#b8caff', color:'#2147f4', border:'#2147f4' },
  'Pending':    { bg:'#beffd8', color:'#1a6a40', border:'#1a6a40' },
  'Cancelled':  { bg:'#f0f0f0', color:'#999',    border:'#ccc'    },
  'Complete':   { bg:'#e8f5e9', color:'#2e7d32', border:'#2e7d32' },
};
function applyStatusStyle(sel, status) {
  if (!sel) return;
  const c = STATUS_COLOURS[status] || STATUS_COLOURS['Unassigned'];
  sel.style.background = c.bg; sel.style.color = c.color; sel.style.borderColor = c.border;
}

function makeStatusSelect(rowIndex, current, onchange) {
  const opts = ['Unassigned','Assigned','Booked','Pending','Cancelled','Complete']
    .map(s => '<option value="'+s+'"'+(current===s?' selected':'')+'>'+s+'</option>').join('');
  return '<select id="sel-status-'+rowIndex+'" onchange="'+onchange+'('+rowIndex+')" '
    +'style="border:1px solid #ccc;border-radius:4px;padding:4px 7px;font-size:12px;font-family:Arial,sans-serif;font-weight:600;cursor:pointer;min-width:105px;">'+opts+'</select>';
}
function makeTrainerSelect(rowIndex, current, onchange) {
  const opts = '<option value=""> Unassigned </option>'
    + TRAINERS.map(t=>'<option value="'+t+'"'+(current===t?' selected':'')+'>'+t+'</option>').join('');
  return '<select id="sel-trainer-'+rowIndex+'" onchange="'+onchange+'('+rowIndex+')" '
    +'style="border:1px solid #ccc;border-radius:4px;padding:4px 7px;font-size:12px;font-family:Arial,sans-serif;min-width:90px;">'+opts+'</select>';
}
function makeValueInput(rowIndex, current, onchange) {
  return '<div style="display:flex;align-items:center;gap:4px;">'
    +'<span style="color:var(--text--dark--30);font-size:12px;">\u00a3</span>'
    +'<input type="number" id="sel-value-'+rowIndex+'" value="'+(current||'')+'" placeholder="0" min="0" step="50" '
    +'oninput="'+onchange+'('+rowIndex+')" '
    +'style="width:75px;border:1px solid #ccc;border-radius:4px;padding:4px 6px;font-size:12px;font-family:Arial,sans-serif;color:#333;"></div>';
}

// =============================================
// NEEDS ACTION PANEL  (status-only editable: Pending  Booked or Cancelled)
// =============================================
function renderActionPanel() {
  const actionRows = allData.filter(r => {
    if (!r.date && !r.timestamp) return false;
    const d = r.date || new Date(r.timestamp||0);
    if (d && d < new Date('2024-01-01')) return false;
    return (r.status === 'Assigned' || r.status === 'Pending') && r.trainer && r.trainer.trim();
  });
  document.getElementById('actionBadge').textContent = actionRows.length;
  const dot = document.getElementById('actionDot');
  if (dot) dot.style.display = actionRows.length > 0 ? 'block' : 'none';
  const tbody = document.getElementById('actionRequestsBody');
  if (!tbody) return;
  if (actionRows.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">\u2705</div><div class="empty-state-text">Nothing needs action \u2014 all up to date!</div></div></td></tr>';
    return;
  }
  tbody.innerHTML = actionRows.map(r => {
    const cur = r.status || 'Pending';
    const statusColor = cur === 'Pending' ? 'background:#beffd8;color:#1a6a40;' : 'background:#f5ede5;color:#8a5a2a;';
    // Status select: only Pending  Booked or Cancelled
    const statusOpts = ['Pending','Booked','Cancelled']
      .map(s => '<option value="'+s+'"'+(cur===s?' selected':'')+'>'+s+'</option>').join('');
    const statusSel = '<select class="na-status-select" id="na-status-'+r.rowIndex+'" onchange="onActionStatusChange('+r.rowIndex+')" style="'+statusColor+'">'+statusOpts+'</select>';
    const valFmt = r.revenue ? '\u00a3'+Number(r.revenue).toLocaleString() : '\u2014';
    return '<tr id="action-row-'+r.rowIndex+'">'
      +'<td style="white-space:nowrap;font-size:12px;">'+formatDate(r.date||r.timestamp)+'</td>'
      +'<td><strong>'+esc(r.company)+'</strong><br><span style="font-size:11px;color:var(--text--dark--30);">'+esc(r.contact||'')+'</span></td>'
      +'<td style="font-size:12px;color:var(--text--dark--30);">'+esc(r.contact||'')+'</td>'
      +'<td><span class="option-badge opt-'+r.option+'">Opt '+r.option+' \u2014 '+esc(r.optionLabel)+'</span></td>'
      +'<td style="font-size:13px;font-weight:600;color:var(--text--dark--50);">'+valFmt+'</td>'
      +'<td><span style="font-size:12px;font-weight:600;color:var(--action-primary-blue);">'+esc(r.trainer||'Unassigned')+'</span></td>'
      +'<td><div style="display:flex;flex-direction:column;gap:4px;">'
      +statusSel
      +'<div style="font-size:10px;color:var(--text--dark--30);">Booked opens booking modal</div>'
      +'</div></td>'
      +'</tr>';
  }).join('');
  actionRows.forEach(r => {
    const sel = document.getElementById('na-status-'+r.rowIndex);
    if (sel) applyNaStatusStyle(sel, r.status||'Pending');
  });
}

function applyNaStatusStyle(sel, status) {
  if (!sel) return;
  if (status === 'Pending') { sel.style.background='#beffd8'; sel.style.color='#1a6a40'; sel.style.borderColor='#4caf50'; }
  else if (status === 'Assigned') { sel.style.background='#f5ede5'; sel.style.color='#8a5a2a'; sel.style.borderColor='#e09060'; }
  else if (status === 'Booked') { sel.style.background='#b8caff'; sel.style.color='#2147f4'; sel.style.borderColor='#2147f4'; }
  else if (status === 'Cancelled') { sel.style.background='#f0f0f0'; sel.style.color='#999'; sel.style.borderColor='#ccc'; }
}

async function onActionStatusChange(rowIndex) {
  const sel = document.getElementById('na-status-'+rowIndex);
  const newStatus = sel ? sel.value : '';
  if (!newStatus) return;
  const row = allData.find(r => r.rowIndex === rowIndex);
  if (!row) return;

  if (newStatus === 'Booked') {
    // Revert dropdown (modal will confirm the change)
    sel.value = row.status || 'Pending';
    applyNaStatusStyle(sel, row.status || 'Pending');
    openBookedDateModal(rowIndex);
    return;
  }

  if (newStatus === 'Cancelled') {
    if (!confirm('Cancel this booking? Trainer will be unassigned and it will move to All Bookings.')) {
      sel.value = row.status || 'Pending';
      applyNaStatusStyle(sel, row.status || 'Pending');
      return;
    }
    row.status  = 'Cancelled';
    row.trainer = '';
    saveOverride(rowIndex, { status: 'Cancelled', trainer: '' });
    try { await fetch(APPS_SCRIPT_URL+'?action=assign&row='+rowIndex+'&status=Cancelled&trainer=', {mode:'no-cors'}); } catch(e){}
    logActivity('status', row.company, 'Cancelled from Needs Action', '');
    processData();
    showToast('Booking cancelled', '');
    return;
  }

  row.status = newStatus;
  applyNaStatusStyle(sel, newStatus);
  saveOverride(rowIndex, { status: newStatus });
  try { await fetch(APPS_SCRIPT_URL+'?action=assign&row='+rowIndex+'&status='+encodeURIComponent(newStatus), {mode:'no-cors'}); } catch(e){}
  logActivity('status', row.company, 'Status \u2192 '+newStatus, '');
  showToast('Status \u2192 '+newStatus, 'success');
  renderActionPanel(); renderUnassigned(); renderKPIs();
}

// =============================================
// ALL BOOKINGS TABLE
// =============================================
let _currentPage = 1;
const _pageSize = 20;
let _filteredBookings = [];

function renderAllBookings() {
  const filterTrainer = (document.getElementById('filterTrainer')||{}).value || '';
  const filterStatus  = (document.getElementById('filterStatus')||{}).value  || '';
  const search = ((document.getElementById('searchAllBookings')||{}).value||'').toLowerCase();

  _filteredBookings = allData.filter(r => {
    if (filterTrainer && r.trainer !== filterTrainer) return false;
    if (filterStatus  && r.status  !== filterStatus)  return false;
    if (search && !(r.company+r.contact+r.email+r.optionLabel).toLowerCase().includes(search)) return false;
    return true;
  }).sort((a,b) => {
    const da = a.date || new Date(a.timestamp||0);
    const db = b.date || new Date(b.timestamp||0);
    return db - da;
  });

  const totalPages = Math.max(1, Math.ceil(_filteredBookings.length / _pageSize));
  if (_currentPage > totalPages) _currentPage = totalPages;
  const pageRows = _filteredBookings.slice((_currentPage-1)*_pageSize, _currentPage*_pageSize);

  const pageEl = document.getElementById('allBookingsPage');
  if (pageEl) pageEl.textContent = 'Page '+_currentPage+' of '+totalPages+' ('+_filteredBookings.length+' rows)';

  const tbody = document.getElementById('allBookingsBody');
  if (!tbody) return;

  if (pageRows.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">\ud83d\udccb</div><div class="empty-state-text">No bookings match your filters</div></div></td></tr>';
    return;
  }

  tbody.innerHTML = pageRows.map(r => {
    const statusSel  = makeStatusSelect(r.rowIndex,  r.status||'Unassigned', 'onAllStatusChange');
    const trainerSel = makeTrainerSelect(r.rowIndex, r.trainer, 'onAllTrainerChange');
    const valueInp   = makeValueInput(r.rowIndex, r.revenue, 'onAllValueInput');
    return '<tr id="all-row-'+r.rowIndex+'">'
      +'<td style="white-space:nowrap;font-size:12px;">'+formatDate(r.date||r.timestamp)+'</td>'
      +'<td><strong>'+esc(r.company)+'</strong><br><span style="font-size:10px;color:var(--text--dark--30);">'+esc(r.email||'')+'</span></td>'
      +'<td style="font-size:12px;">'+esc(r.contact||'')+'</td>'
      +'<td><span class="option-badge opt-'+r.option+'">Opt '+r.option+' \u2014 '+esc(r.optionLabel)+'</span></td>'
      +'<td>'+valueInp+'</td>'
      +'<td>'+trainerSel+'</td>'
      +'<td>'+statusSel+'</td>'
      +'</tr>';
  }).join('');

  pageRows.forEach(r => {
    applyStatusStyle(document.getElementById('sel-status-'+r.rowIndex), r.status||'Unassigned');
  });
}

async function onAllStatusChange(rowIndex) {
  const sel = document.getElementById('sel-status-'+rowIndex);
  const newStatus = sel ? sel.value : '';
  if (!newStatus) return;
  if (newStatus === 'Booked') {
    const row = allData.find(r=>r.rowIndex===rowIndex);
    if (sel && row) { sel.value = row.status||'Unassigned'; applyStatusStyle(sel, row.status||'Unassigned'); }
    openBookedDateModal(rowIndex);
    return;
  }
  const row = allData.find(r=>r.rowIndex===rowIndex);
  if (row) row.status = newStatus;
  if (sel) applyStatusStyle(sel, newStatus);
  saveOverride(rowIndex, { status: newStatus });
  showToast('Status \u2192 '+newStatus, 'success');
  try { await fetch(APPS_SCRIPT_URL+'?action=assign&row='+rowIndex+'&status='+encodeURIComponent(newStatus), {mode:'no-cors'}); } catch(e){}
  if (row) logActivity('status', row.company, 'Status \u2192 '+newStatus, '');
  renderAllBookings(); renderActionPanel(); renderKPIs();
}
async function onAllTrainerChange(rowIndex) {
  const sel = document.getElementById('sel-trainer-'+rowIndex);
  const trainer = sel ? sel.value : '';
  const row = allData.find(r=>r.rowIndex===rowIndex);
  if (row) row.trainer = trainer;
  saveOverride(rowIndex, { trainer });
  try { await fetch(APPS_SCRIPT_URL+'?action=assign&row='+rowIndex+'&trainer='+encodeURIComponent(trainer), {mode:'no-cors'}); } catch(e){}
  if (row) logActivity('trainer', row.company, 'Trainer changed', trainer||'Unassigned');
  showToast('\u2713 Trainer updated', 'success');
  renderAllBookings(); renderActionPanel();
}
function onAllValueInput(rowIndex) {
  const inp = document.getElementById('sel-value-'+rowIndex);
  const row = allData.find(r=>r.rowIndex===rowIndex);
  if (row && inp) row.revenue = parseFloat(inp.value)||0;
  clearTimeout(inp._t); inp._t = setTimeout(async () => {
    const val = parseFloat(inp.value)||0;
    saveOverride(rowIndex, { revenue: val });
    try { await fetch(APPS_SCRIPT_URL+'?action=assign&row='+rowIndex+'&value='+val, {mode:'no-cors'}); } catch(e){}
    showToast('\u2713 Value saved', 'success');
    renderKPIs();
  }, 1200);
}

function changePage(dir) {
  const totalPages = Math.max(1, Math.ceil(_filteredBookings.length / _pageSize));
  _currentPage = Math.max(1, Math.min(totalPages, _currentPage + dir));
  renderAllBookings();
}
function populateTrainerFilter() {
  ['filterTrainer'].forEach(id => {
    const sel = document.getElementById(id); if (!sel) return;
    const cur = sel.value;
    sel.innerHTML = '<option value="">All Trainers</option>' + TRAINERS.map(t=>'<option value="'+esc(t)+'"'+(cur===t?' selected':'')+'>'+esc(t)+'</option>').join('');
  });
}

// =============================================
// UTILS
// =============================================
function formatDate(d) {
  if (!d) return '\u2014';
  const dt = d instanceof Date ? d : new Date(d);
  if (isNaN(dt.getTime())) return String(d).slice(0,10);
  return dt.toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'2-digit' });
}
function esc(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// =============================================
// ACTIVITY LOG
// =============================================
const ACTIVITY_KEY = 'streetDashboardActivity_v2';
function getActivityLog() { try { return JSON.parse(localStorage.getItem(ACTIVITY_KEY)||'[]'); } catch(e) { return []; } }
function saveActivityLog(log) { try { localStorage.setItem(ACTIVITY_KEY, JSON.stringify(log.slice(-200))); } catch(e) {} }
function logActivity(type, company, action, detail) {
  const u = getCurrentUser();
  const log = getActivityLog();
  log.push({ type, company, action, detail, user: u ? u.name : 'Unknown', ts: new Date().toISOString() });
  saveActivityLog(log);
  renderActivityFeed();
}
function renderActivityFeed() {
  const body = document.getElementById('activityFeedBody'); if (!body) return;
  const log = getActivityLog().slice().reverse();
  if (log.length === 0) { body.innerHTML = '<div class="activity-empty"><div class="activity-empty-icon">\ud83d\udcec</div>No activity yet</div>'; return; }
  const TYPE_ICONS = { status:'\ud83d\udfe1', trainer:'\ud83d\udc64', value:'\ud83d\udcb0', date:'\ud83d\udcc5', default:'\ud83d\udcdd' };
  const fmt = ts => { const d=new Date(ts); return d.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'})+' '+d.toLocaleDateString('en-GB',{day:'2-digit',month:'short'}); };
  let last = ''; let html = '';
  log.forEach(e => {
    const day = new Date(e.ts).toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long'});
    if (day !== last) { html += '<div class="activity-date-divider">'+day+'</div>'; last = day; }
    const icon = TYPE_ICONS[e.type]||TYPE_ICONS.default;
    html += '<div class="activity-item"><div class="activity-item-icon" style="background:#f0f4ff;">'+icon+'</div>'
      +'<div class="activity-item-body"><div class="activity-item-text"><span class="act-company">'+esc(e.company)+'</span> \u2014 '+esc(e.action)+(e.detail?' ('+esc(e.detail)+')':'')+'</div>'
      +'<div class="activity-item-meta"><span class="activity-item-user">'+esc(e.user)+'</span><span class="activity-item-time">'+fmt(e.ts)+'</span></div></div></div>';
  });
  body.innerHTML = html;
}
function openActivityPanel() { document.getElementById('activityPanel').classList.add('open'); document.getElementById('activityOverlay').classList.add('open'); renderActivityFeed(); }
function closeActivityPanel() { document.getElementById('activityPanel').classList.remove('open'); document.getElementById('activityOverlay').classList.remove('open'); }
function clearActivityLog() { saveActivityLog([]); renderActivityFeed(); showToast('Activity log cleared', ''); }

// =============================================
// CALENDAR
// =============================================
let calCurrentYear  = new Date().getFullYear();
let calCurrentMonth = new Date().getMonth();
let calEvents = [];
let _calLastFetch = 0;
const CAL_KEY = 'streetDashboardCalSettings';
const DEFAULT_CALENDAR_ID = 'c_3fd39a8ba7d9ea4668342113318a617caa454a9711a6dc697448fedc4467f3cd@group.calendar.google.com';

function getCalSettings() {
  try { const s = JSON.parse(localStorage.getItem(CAL_KEY)||'{}'); if (!s.calendarId) s.calendarId = DEFAULT_CALENDAR_ID; return s; } catch(e) { return { calendarId: DEFAULT_CALENDAR_ID }; }
}

const UK_BANK_HOLIDAYS = {
  '2024':['2024-01-01','2024-03-29','2024-04-01','2024-05-06','2024-05-27','2024-08-26','2024-12-25','2024-12-26'],
  '2025':['2025-01-01','2025-04-18','2025-04-21','2025-05-05','2025-05-26','2025-08-25','2025-12-25','2025-12-26'],
  '2026':['2026-01-01','2026-04-03','2026-04-06','2026-05-04','2026-05-25','2026-08-31','2026-12-25','2026-12-26'],
  '2027':['2027-01-01','2027-03-26','2027-03-29','2027-05-03','2027-05-31','2027-08-30','2027-12-27','2027-12-28'],
};
const BH_NAMES = {
  '2026-01-01':"New Year's Day",'2026-04-03':'Good Friday','2026-04-06':'Easter Monday',
  '2026-05-04':'Early May BH','2026-05-25':'Spring BH','2026-08-31':'Summer BH','2026-12-25':'Christmas Day','2026-12-26':'Boxing Day',
  '2025-01-01':"New Year's Day",'2025-04-18':'Good Friday','2025-04-21':'Easter Monday',
  '2025-05-05':'Early May BH','2025-05-26':'Spring BH','2025-08-25':'Summer BH','2025-12-25':'Christmas Day','2025-12-26':'Boxing Day',
  '2027-01-01':"New Year's Day",'2027-03-26':'Good Friday','2027-03-29':'Easter Monday',
  '2027-05-03':'Early May BH','2027-05-31':'Spring BH','2027-08-30':'Summer BH','2027-12-27':'Christmas Day (sub)','2027-12-28':'Boxing Day (sub)',
};
function isUKBankHoliday(ds) { const yr=ds.slice(0,4); return (UK_BANK_HOLIDAYS[yr]||[]).includes(ds); }
function isWorkday(d) { const dow=d.getDay(); if(dow===0||dow===6) return false; return !isUKBankHoliday(d.toISOString().slice(0,10)); }
function addWorkdays(start, n) { const r=[],d=new Date(start); while(r.length<n){if(isWorkday(d))r.push(new Date(d));d.setDate(d.getDate()+1);} return r; }
function getBlockedDatesForBooking(firstDay, numDays) {
  const before=new Date(firstDay); before.setDate(before.getDate()-1);
  const trainingDays=addWorkdays(firstDay,numDays);
  const lastDay=trainingDays[trainingDays.length-1];
  const after=new Date(lastDay); after.setDate(after.getDate()+1);
  return { before, trainingDays, after };
}

async function loadCalendarData(force) {
  const now = Date.now();
  if (!force && now - _calLastFetch < 5*60*1000) { renderCalendar(); renderUpcoming(); return; }
  const s = getCalSettings();
  updateCalStatus(false);
  if (!s.calendarId) { renderCalendar(); renderUpcoming(); return; }
  const start = new Date(calCurrentYear, calCurrentMonth-1, 1).toISOString().slice(0,10);
  const end   = new Date(calCurrentYear, calCurrentMonth+2, 0).toISOString().slice(0,10);
  try {
    const url = APPS_SCRIPT_URL+'?action=getCalendarEvents&calendarId='+encodeURIComponent(s.calendarId)+'&start='+start+'&end='+end;
    const res = await fetch(url);
    const json = await res.json();
    if (json.success && json.events) { calEvents = json.events; _calLastFetch = now; updateCalStatus(true); }
    else { updateCalStatus(false, json.error||'No events'); }
  } catch(e) { updateCalStatus(false, e.message); }
  renderCalendar(); renderUpcoming();
}
function updateCalStatus(ok, err) {
  const dot = document.getElementById('calStatusDot');
  if (dot) { dot.style.background = ok ? '#4caf50' : '#ccc'; dot.title = err||''; }
}
function calChangeMonth(dir) {
  calCurrentMonth += dir;
  if (calCurrentMonth>11){calCurrentMonth=0;calCurrentYear++;}
  if (calCurrentMonth<0){calCurrentMonth=11;calCurrentYear--;}
  renderCalendar();
}
function populateCalTrainerFilter() {
  const sel = document.getElementById('calFilterTrainer'); if(!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">All Trainers</option>'+TRAINERS.map(t=>'<option value="'+esc(t)+'"'+(cur===t?' selected':'')+'>'+esc(t)+'</option>').join('');
}
function renderCalendar() {
  const MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];
  const el = document.getElementById('calMonthTitle'); if(el) el.textContent = MONTHS[calCurrentMonth]+' '+calCurrentYear;
  const filterTrainer = (document.getElementById('calFilterTrainer')||{}).value||'';
  const today = new Date(); today.setHours(0,0,0,0);
  const eventMap = {};
  const addEv = (ds,ev) => { (eventMap[ds]=eventMap[ds]||[]).push(ev); };
  // Populate event map from booking data
  allData.forEach(r => {
    if (!r.bookedOn || r.status === 'Cancelled') return;
    if (filterTrainer && r.trainer !== filterTrainer) return;
    const numDays = r.trainingDays || OPTION_DAYS[r.option] || 1;
    const fd = new Date(r.bookedOn.slice(0,10));
    const { before, trainingDays: tDays, after } = getBlockedDatesForBooking(fd, numDays);
    const trainer = r.trainer || '';
    const shortCompany = r.company.slice(0,16);
    // Travel day
    const bds = before.toISOString().slice(0,10);
    const [by,bm] = bds.split('-').map(Number);
    if (by===calCurrentYear && bm-1===calCurrentMonth) addEv(bds, {type:'travel', label:'\u2708\uFE0F Travel: '+trainer, title:r.company+' \u2014 Travel day'});
    // Training days (may span multiple days)
    tDays.forEach((td, i) => {
      const tds = td.toISOString().slice(0,10);
      const [ty,tm] = tds.split('-').map(Number);
      if (ty===calCurrentYear && tm-1===calCurrentMonth) addEv(tds, {type:'booking', label:'\uD83D\uDCDA '+(numDays>1?'Day '+(i+1)+': ':'')+shortCompany, title:r.company+' \u2014 Training Day '+(i+1)+(trainer?' ('+trainer+')':'')});
    });
    // Admin day
    const ads = after.toISOString().slice(0,10);
    const [ay,am] = ads.split('-').map(Number);
    if (ay===calCurrentYear && am-1===calCurrentMonth) addEv(ads, {type:'admin', label:'\uD83D\uDCCB Admin: '+trainer, title:r.company+' \u2014 Admin day'});
  });
  // Google Calendar events
  calEvents.forEach(e => {
    if (filterTrainer && e.trainer && e.trainer !== filterTrainer) return;
    const ds = e.start.slice(0,10);
    const [y,m] = ds.split('-').map(Number);
    if (y!==calCurrentYear || m-1!==calCurrentMonth) return;
    addEv(ds, {type: e.blocked ? 'blocked' : 'gcal', label: e.title.slice(0,22), title: e.title});
  });

  const first = new Date(calCurrentYear, calCurrentMonth, 1);
  const startDow = (first.getDay() + 6) % 7;
  const daysInMonth = new Date(calCurrentYear, calCurrentMonth+1, 0).getDate();
  let html = '';
  for (let i = 0; i < startDow; i++) html += '<div class="cal-day cal-day-empty"></div>';
  for (let d = 1; d <= daysInMonth; d++) {
    const dt = new Date(calCurrentYear, calCurrentMonth, d);
    const ds = dt.toISOString().slice(0,10);
    const isToday  = dt.getTime() === today.getTime();
    const isPast   = dt < today;
    const dow      = dt.getDay();
    const isWeekend = dow === 0 || dow === 6;
    const isBH     = isUKBankHoliday(ds);
    const events   = eventMap[ds] || [];
    const cls = ['cal-day', isToday?'cal-day-today':'', isPast?'cal-day-past':'', isBH?'cal-day-bankHol':(isWeekend?'cal-day-weekend':'')].filter(Boolean).join(' ');
    // Bank holiday badge
    const bhName = BH_NAMES[ds] || 'Bank Holiday';
    const bhLabel = isBH ? '<span class="cal-bh-label">\uD83C\uDDEC\uD83C\uDDE7 '+bhName+'</span>' : '';
    const evHtml = events.slice(0,3).map(e => {
      let ec = 'cal-event ';
      if (e.type === 'booking')  ec += 'cal-event-booking';
      else if (e.type === 'travel') ec += 'cal-event-travel';
      else if (e.type === 'admin')  ec += 'cal-event-admin';
      else if (e.type === 'gcal')   ec += 'cal-event-gcal';
      else                          ec += 'cal-event-blocked';
      return '<span class="'+ec+'" title="'+(e.title||e.label)+'">'+e.label+'</span>';
    }).join('');
    const more = events.length > 3 ? '<span class="cal-event-more">+' + (events.length-3) + ' more</span>' : '';
    html += '<div class="'+cls+'"><span class="cal-day-num">'+d+'</span>'+bhLabel+evHtml+more+'</div>';
  }
  const grid = document.getElementById('calDays');
  if (grid) grid.innerHTML = html;
}
function renderUpcoming() {
  const now=new Date(); now.setHours(0,0,0,0);
  const filterTrainer=(document.getElementById('calFilterTrainer')||{}).value||'';
  const upcoming=allData.filter(r=>r.bookedOn&&r.status!=='Cancelled'&&(!filterTrainer||r.trainer===filterTrainer))
    .map(r=>({...r,_d:new Date(r.bookedOn)})).filter(r=>r._d>=now).sort((a,b)=>a._d-b._d).slice(0,20);
  const countEl=document.getElementById('calUpcomingCount'); if(countEl) countEl.textContent=upcoming.length+' upcoming';
  const body=document.getElementById('calUpcomingBody'); if(!body) return;
  if(!upcoming.length){body.innerHTML='<div style="padding:32px 20px;text-align:center;color:var(--text--dark--30);font-size:12px;">No upcoming sessions</div>';return;}
  const MS=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  body.innerHTML=upcoming.map(r=>{
    const d=r._d;
    return '<div class="cal-upcoming-item"><div class="cal-upcoming-date"><div style="font-size:16px;font-weight:700;color:var(--text--dark--50);line-height:1;">'+d.getDate()+'</div><div style="font-size:9px;font-weight:600;color:var(--text--dark--30);text-transform:uppercase;">'+MS[d.getMonth()]+'</div></div>'
      +'<div style="flex:1;min-width:0;"><div style="font-size:12px;font-weight:600;color:var(--text--dark--50);">'+esc(r.company)+'</div>'
      +'<div style="font-size:11px;color:var(--text--dark--30);margin-top:2px;">'+r.optionLabel+(r.trainer?' \u00b7 '+esc(r.trainer):'')+'</div></div></div>';
  }).join('');
}
function openCalSettings() {
  const s=getCalSettings();
  const inp=document.getElementById('calIdInput'); if(inp) inp.value=s.calendarId||'';
  const el=document.getElementById('calSettingsOverlay'); if(el) el.classList.add('open');
}
function closeCalSettings() { const el=document.getElementById('calSettingsOverlay'); if(el) el.classList.remove('open'); }
function saveCalSettings() {
  const calId=(document.getElementById('calIdInput')||{}).value||'';
  const s=getCalSettings(); s.calendarId=calId;
  try { localStorage.setItem(CAL_KEY,JSON.stringify(s)); } catch(e){}
  closeCalSettings(); if(calId) loadCalendarData(true);
}

// =============================================
// BOOKED DATE MODAL  with full validation + trainer clash detection
// =============================================
let _bdRowIndex = null, _bdNumDays = 1;

function openBookedDateModal(rowIndex) {
  const row = allData.find(r => r.rowIndex === rowIndex);
  if (!row) return;
  _bdRowIndex = rowIndex;
  _bdNumDays  = OPTION_DAYS[row.option] || 1;

  document.getElementById('bdModalCompany').textContent = row.company + (row.contact ? ' \u2014 ' + row.contact : '');
  document.getElementById('bdModalDateInput').value  = row.bookedOn ? formatDateInput(row.bookedOn) : '';
  document.getElementById('bdModalValueInput').value = row.revenue || (OPTION_PRICES[row.option] || '');

  const errEl = document.getElementById('bdModalError');
  if (errEl) { errEl.textContent = ''; errEl.className = 'booked-date-modal-footer-left'; }

  // Trainer select  pre-select existing trainer
  const trainerSel = document.getElementById('bdModalTrainerSelect');
  if (trainerSel) {
    trainerSel.innerHTML = '<option value="">-- Select trainer --</option>'
      + TRAINERS.map(t => '<option value="'+esc(t)+'"'+(row.trainer===t?' selected':'')+'>'+esc(t)+'</option>').join('');
  }

  // Days buttons
  document.querySelectorAll('#bdModalDaysBtns .bd-days-btn').forEach(b => {
    const n = parseInt(b.textContent);
    b.className = 'bd-days-btn' + (n === _bdNumDays ? ' active' : '');
  });

  bdUpdateSummary();
  document.getElementById('bookedDateModal').classList.add('open');
}

function cancelBookedDateModal() {
  document.getElementById('bookedDateModal').classList.remove('open');
  _bdRowIndex = null;
}

function bdSelectDays(n) {
  _bdNumDays = n;
  document.querySelectorAll('#bdModalDaysBtns .bd-days-btn').forEach(b => {
    b.className = 'bd-days-btn' + (parseInt(b.textContent) === n ? ' active' : '');
  });
  bdUpdateSummary();
}

// Returns array of clash descriptions for all dates in a booking block
function getTrainerClashes(trainer, firstDay, numDays, excludeRowIndex) {
  if (!trainer) return [];
  const { before, trainingDays, after } = getBlockedDatesForBooking(firstDay, numDays);
  const allBlockedDates = [before, ...trainingDays, after].map(d => d.toISOString().slice(0,10));
  const clashes = [];
  allData.forEach(r => {
    if (r.rowIndex === excludeRowIndex) return;
    if (r.trainer !== trainer) return;
    if (r.status === 'Cancelled') return;
    if (!r.bookedOn) return;
    const rFirst = new Date(r.bookedOn.slice(0,10));
    const rDays  = OPTION_DAYS[r.option] || 1;
    const { before: rb, trainingDays: rt, after: ra } = getBlockedDatesForBooking(rFirst, rDays);
    const rDates = [rb, ...rt, ra].map(d => d.toISOString().slice(0,10));
    allBlockedDates.forEach(d => {
      if (rDates.includes(d)) {
        const alreadyReported = clashes.find(c => c.company === r.company);
        if (!alreadyReported) {
          clashes.push({ company: r.company, date: d, existingBookedOn: r.bookedOn.slice(0,10) });
        }
      }
    });
  });
  return clashes;
}

function bdUpdateSummary() {
  const dateVal    = document.getElementById('bdModalDateInput').value;
  const trainerVal = (document.getElementById('bdModalTrainerSelect') || {}).value || '';
  const sumEl      = document.getElementById('bdModalSummary');
  const errEl      = document.getElementById('bdModalError');

  if (errEl) { errEl.textContent = ''; errEl.className = 'booked-date-modal-footer-left'; }
  if (!dateVal) { sumEl.style.display = 'none'; return; }
  const first = new Date(dateVal);
  if (isNaN(first.getTime())) { sumEl.style.display = 'none'; return; }

  const { before, trainingDays, after } = getBlockedDatesForBooking(first, _bdNumDays);
  const fmt = d => d.toLocaleDateString('en-GB', { weekday:'short', day:'numeric', month:'short' });
  const ds  = d => d.toISOString().slice(0,10);

  function weekendBankClash(d) {
    const dow = d.getDay(); const r = [];
    if (dow === 0 || dow === 6) r.push(dow === 6 ? '\uD83D\uDCC5 Saturday' : '\uD83D\uDCC5 Sunday');
    if (isUKBankHoliday(ds(d))) r.push('\uD83C\uDDEC\uD83C\uDDE7 ' + (BH_NAMES[ds(d)] || 'UK Bank Holiday'));
    return r.join(' + ');
  }

  // Build schedule summary
  let html = '<div style="margin-bottom:8px;">';
  html += '<div style="font-size:11px;font-weight:700;color:var(--text--dark--30);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Booking Schedule</div>';
  html += '<div style="display:flex;flex-direction:column;gap:4px;">';
  html += '<div style="display:flex;align-items:baseline;gap:8px;"><span style="font-size:16px;">\u2708\uFE0F</span><div><span style="font-size:11px;font-weight:600;color:var(--text--dark--40);">Travel Day</span><br><span style="font-size:12px;color:var(--text--dark--50);">'+fmt(before)+'</span></div></div>';
  trainingDays.forEach((d, i) => {
    html += '<div style="display:flex;align-items:baseline;gap:8px;"><span style="font-size:16px;">\uD83D\uDCDA</span><div><span style="font-size:11px;font-weight:600;color:var(--action-primary-blue);">Training Day '+(i+1)+'</span><br><span style="font-size:12px;color:var(--text--dark--50);">'+fmt(d)+'</span></div></div>';
  });
  html += '<div style="display:flex;align-items:baseline;gap:8px;"><span style="font-size:16px;">\uD83D\uDCCB</span><div><span style="font-size:11px;font-weight:600;color:var(--text--dark--40);">Admin Day</span><br><span style="font-size:12px;color:var(--text--dark--50);">'+fmt(after)+'</span></div></div>';
  html += '</div></div>';

  // Weekend / bank holiday soft warnings
  const softAlerts = [];
  trainingDays.forEach(d => { const r = weekendBankClash(d); if (r) softAlerts.push({ type: 'Training', date: fmt(d), reason: r }); });
  const br = weekendBankClash(before); if (br) softAlerts.push({ type: 'Travel', date: fmt(before), reason: br });
  const ar = weekendBankClash(after);  if (ar) softAlerts.push({ type: 'Admin',  date: fmt(after),  reason: ar });

  if (softAlerts.length > 0) {
    html += '<div style="margin-top:8px;padding:10px 12px;background:#fff8e1;border:1px solid #ffcc02;border-radius:6px;">';
    html += '<div style="font-weight:700;color:#e65100;margin-bottom:4px;">\u26A0\uFE0F Date Warning</div>';
    softAlerts.forEach(a => {
      html += '<div style="color:#bf360c;font-size:11px;margin-top:2px;">\u2022 <strong>'+a.type+'</strong> ('+a.date+') \u2014 '+a.reason+'</div>';
    });
    html += '</div>';
  }

  // HARD BLOCKER: trainer double-booking
  if (trainerVal) {
    const clashes = getTrainerClashes(trainerVal, first, _bdNumDays, _bdRowIndex);
    if (clashes.length > 0) {
      html += '<div class="bd-trainer-clash-block">';
      html += '<div class="clash-title">\uD83D\uDEAB Trainer Conflict \u2014 Cannot Book</div>';
      html += '<div style="font-size:11px;margin-top:4px;">'+esc(trainerVal)+' is already booked during this period:</div>';
      clashes.forEach(c => {
        html += '<div style="font-size:11px;margin-top:4px;padding:4px 8px;background:#fff;border-radius:4px;">\u2022 <strong>'+esc(c.company)+'</strong> (booked: '+c.existingBookedOn+')</div>';
      });
      html += '<div style="font-size:11px;margin-top:6px;font-weight:700;">Please choose a different trainer or date.</div>';
      html += '</div>';
      if (errEl) { errEl.textContent = '\u26D4 Trainer conflict  cannot confirm booking.'; errEl.className = 'booked-date-modal-footer-left show'; }
    } else if (softAlerts.length === 0) {
      html += '<div style="margin-top:8px;padding:8px 12px;background:#e8f5e9;border:1px solid #a5d6a7;border-radius:6px;font-size:11px;color:#1a6a40;font-weight:600;">\u2705 No conflicts detected \u2014 ready to confirm!</div>';
    }
  }

  sumEl.innerHTML = html;
  sumEl.style.display = 'block';
  sumEl.style.background = '#f6f8ff';
  sumEl.style.borderColor = '#dde6ff';
}

async function confirmBookedDateModal() {
  const errEl     = document.getElementById('bdModalError');
  const dateVal   = document.getElementById('bdModalDateInput').value;
  const trainerSel = document.getElementById('bdModalTrainerSelect');
  const newTrainer = trainerSel ? trainerSel.value : '';
  const newValue   = parseFloat(document.getElementById('bdModalValueInput').value) || 0;
  const errors     = [];

  if (!dateVal)     errors.push('First day of training is required.');
  if (!newTrainer)  errors.push('Trainer is required.');
  if (!newValue)    errors.push('Invoice value is required.');

  if (errors.length) {
    if (errEl) { errEl.textContent = errors.join(' '); errEl.className = 'booked-date-modal-footer-left show'; }
    return;
  }

  // Check trainer clash (hard blocker)
  const first   = new Date(dateVal);
  const clashes = getTrainerClashes(newTrainer, first, _bdNumDays, _bdRowIndex);
  if (clashes.length > 0) {
    if (errEl) { errEl.textContent = '\u26D4 Trainer is already booked during this period. Change trainer or date.'; errEl.className = 'booked-date-modal-footer-left show'; }
    return;
  }

  const row = allData.find(r => r.rowIndex === _bdRowIndex);
  if (!row) return;

  row.bookedOn     = dateVal;
  row.status       = 'Booked';
  row.trainer      = newTrainer;
  row.revenue      = newValue;
  row.trainingDays = _bdNumDays;

  saveOverride(_bdRowIndex, { bookedOn: dateVal, status: 'Booked', trainer: newTrainer, revenue: newValue, trainingDays: _bdNumDays });

  let url = APPS_SCRIPT_URL + '?action=assign&row=' + _bdRowIndex
    + '&status=Booked&bookedOn=' + encodeURIComponent(dateVal)
    + '&trainer=' + encodeURIComponent(newTrainer)
    + '&value=' + newValue
    + '&trainingDays=' + _bdNumDays;
  try { await fetch(url, { mode:'no-cors' }); } catch(e) {}

  logActivity('date',    row.company, 'Booking confirmed', dateVal);
  logActivity('trainer', row.company, 'Trainer confirmed', newTrainer);
  logActivity('value',   row.company, 'Value confirmed', '\u00a3' + newValue.toLocaleString());

  cancelBookedDateModal();
  processData();
  showToast('\u2713 Booking confirmed: ' + row.company, 'success');
}

// =============================================
// PERMISSIONS / LOGIN STUBS
// =============================================
function applyPermissions() {
  const u = getCurrentUser(); if(!u) return;
  const p = u.permissions||{};
  ['sectionWorkload','sectionUnassigned','calSection','sectionNeedsAction','sectionPerformance','sectionAllBookings'].forEach(id=>{
    const el=document.getElementById(id); if(el){ el.style.display=''; }
  });
}
function scrollToSection(id){const el=document.getElementById(id);if(el)el.scrollIntoView({behavior:'smooth',block:'start'});closeNav();}
function updateTrainerAvailability(){}

// =============================================
// INIT
// =============================================
loadData();
setInterval(loadData, 5*60*1000);
window.addEventListener('DOMContentLoaded', () => {
  renderActivityFeed();
  loadCalendarData(false);
});
</script>
</body>
</html>
