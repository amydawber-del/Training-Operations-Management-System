<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Street Training Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root {
  --text--dark--50: #19191e; --brand--black: #242326; --text--dark--40: #4c4d57;
  --text--dark--30: #777989; --card-light-grey: #f8f8f8; --text--light--40: #b2b2b2;
  --accent--blue--300: #527dff; --text--dark--20: #a8aabb; --action-primary-blue: #2147f4;
  --light-grey: #ccc; --text-dark-10: #dfe0ec; --ui--underline--light-grey: #e5e5e5;
  --success-green: #bde4b9; --brand--yellow: #f1c238; --brand-accent--mandarin-light: #f6be9d;
  --accent-blue--100: #a3baff; --brand-accent--dusty-red-light: #f9b4bc;
  --brand--secondary--lightgreen: #beffd8; --accent-blue--50: #b8caff;
  --white-smoke: #fde8eb; --brand-accent--cream: #f5ede5;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: Arial, "Helvetica Neue", Helvetica, sans-serif; font-size: 14px; line-height: 20px; color: #333; background: #fff; min-height: 100vh; }

.header { background: var(--brand--black); color: #fff; height: 52px; display: flex; align-items: center; padding: 0 20px; gap: 10px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #3a3a3a; }
.hamburger-btn { background: none; border: none; cursor: pointer; padding: 6px; display: flex; flex-direction: column; gap: 4px; border-radius: 4px; transition: background 0.15s; flex-shrink: 0; }
.hamburger-btn:hover { background: rgba(255,255,255,0.1); }
.hamburger-btn span { display: block; width: 18px; height: 2px; background: #fff; border-radius: 1px; transition: all 0.2s; }
.hamburger-btn.open span:nth-child(1) { transform: rotate(45deg) translate(4px,4px); }
.hamburger-btn.open span:nth-child(2) { opacity: 0; }
.hamburger-btn.open span:nth-child(3) { transform: rotate(-45deg) translate(4px,-4px); }
.street-logo-mark { font-size: 15px; font-weight: 700; letter-spacing: -0.5px; color: #fff; font-family: Arial, sans-serif; line-height: 1; flex-shrink: 0; }
.street-logo-mark .logo-dot { color: var(--brand--yellow); }
.header-title { font-size: 15px; font-weight: 600; color: #fff; letter-spacing: -0.2px; flex: 1; min-width: 0; }
.header-right { display: flex; align-items: center; gap: 7px; flex-shrink: 0; }
.last-updated { font-size: 11px; color: var(--text--light--40); white-space: nowrap; }
.header-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15); color: #fff; padding: 5px 11px; border-radius: 4px; font-size: 12px; cursor: pointer; transition: background 0.15s; font-family: Arial, sans-serif; white-space: nowrap; }
.header-btn:hover { background: rgba(255,255,255,0.2); }
.header-signout { background: rgba(248,113,113,0.15); border-color: rgba(248,113,113,0.3); color: #fca5a5; }
.header-signout:hover { background: rgba(248,113,113,0.25); }
.user-info-wrap { display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 20px; padding: 3px 10px 3px 6px; }
.user-avatar { width: 24px; height: 24px; border-radius: 50%; background: var(--action-primary-blue); color: #fff; font-size: 10px; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.admin-badge { font-size: 9px; font-weight: 700; background: var(--brand--yellow); color: #333; padding: 1px 5px; border-radius: 3px; }
.req-training-btn { background: var(--brand--yellow); color: #1a1a1a; border: none; border-radius: 6px; padding: 6px 13px; font-size: 12px; font-weight: 700; cursor: pointer; font-family: Arial, sans-serif; display: flex; align-items: center; gap: 5px; white-space: nowrap; }

.nav-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
.nav-overlay.open { opacity: 1; pointer-events: all; }
.nav-drawer { position: fixed; top: 0; left: -280px; width: 260px; height: 100vh; background: var(--brand--black); z-index: 201; transition: left 0.22s ease; display: flex; flex-direction: column; box-shadow: 2px 0 8px rgba(0,0,0,0.3); overflow-y: auto; }
.nav-drawer.open { left: 0; }
.nav-drawer-header { padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: space-between; height: 52px; flex-shrink: 0; }
.nav-drawer-title { font-size: 12px; font-weight: 600; color: var(--text--light--40); letter-spacing: 1px; text-transform: uppercase; }
.nav-close { background: none; border: none; color: var(--text--light--40); cursor: pointer; font-size: 18px; line-height: 1; padding: 2px 6px; border-radius: 4px; }
.nav-close:hover { color: #fff; }
.nav-section-label { font-size: 10px; font-weight: 600; letter-spacing: 1.2px; text-transform: uppercase; color: var(--text--dark--30); padding: 16px 20px 8px; }
.nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 20px; color: #ccc; text-decoration: none; font-size: 13px; transition: background 0.12s,color 0.12s; border-left: 3px solid transparent; cursor: pointer; }
.nav-item:hover { background: rgba(255,255,255,0.06); color: #fff; border-left-color: var(--accent--blue--300); }
.nav-item-icon { font-size: 15px; width: 20px; text-align: center; }
.nav-divider { height: 1px; background: rgba(255,255,255,0.08); margin: 8px 20px; }

.loading-bar { height: 3px; background: linear-gradient(90deg,var(--action-primary-blue),var(--accent--blue--300)); animation: loading 1.2s ease infinite; display: none; }
.loading-bar.active { display: block; }
@keyframes loading { 0%{transform:translateX(-100%)} 100%{transform:translateX(200%)} }

.main { padding: 24px; max-width: 1400px; margin: 0 auto; }
.section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; flex-wrap: wrap; gap: 8px; }
.section-title { font-size: 15px; font-weight: 600; color: var(--text--dark--50); display: flex; align-items: center; gap: 8px; }
.section-title .badge { background: var(--brand-accent--dusty-red-light); color: #c0303d; font-size: 11px; font-weight: 700; padding: 1px 7px; border-radius: 10px; min-width: 20px; text-align: center; }
.section-title .badge.green { background: var(--success-green); color: #2a7a26; }
.section-title .badge.orange { background: var(--brand-accent--mandarin-light); color: #a04010; }
.section-title .badge.blue { background: var(--accent-blue--50); color: #2147f4; }

.requests-panel { border: 1px solid var(--ui--underline--light-grey); border-radius: 4px; margin-bottom: 24px; overflow: hidden; }
.requests-panel-header { background: var(--card-light-grey); padding: 12px 16px; border-bottom: 1px solid var(--ui--underline--light-grey); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px; }
.alert-dot { width: 8px; height: 8px; border-radius: 50%; background: #e53935; animation: pulse-dot 1.5s ease infinite; }
@keyframes pulse-dot { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.5;transform:scale(0.8)} }
.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: 13px; }
thead tr { background: var(--card-light-grey); }
th { padding: 10px 14px; text-align: left; font-weight: 600; font-size: 11px; letter-spacing: 0.5px; text-transform: uppercase; color: var(--text--dark--30); border-bottom: 1px solid var(--ui--underline--light-grey); white-space: nowrap; }
td { padding: 10px 14px; border-bottom: 1px solid var(--ui--underline--light-grey); color: var(--text--dark--40); vertical-align: middle; }
tr:last-child td { border-bottom: none; }
tr:hover td { background: #fafafa; }
th.sortable { cursor: pointer; user-select: none; transition: color 0.12s, background 0.12s; }
th.sortable:hover { color: var(--action-primary-blue); background: #f0f3ff; }
th.sort-active { color: var(--action-primary-blue); background: #eef1ff; }
.sort-icon { display: inline-block; margin-left: 4px; font-size: 10px; opacity: 0.5; }
th.sort-active .sort-icon { opacity: 1; }
.row-stale { background: #fffbf0 !important; }
.row-stale td { background: #fffbf0 !important; }
.stale-badge { display: inline-flex; align-items: center; gap: 3px; font-size: 10px; font-weight: 600; background: #fef3c7; color: #92400e; padding: 1px 6px; border-radius: 4px; border: 1px solid #fde68a; white-space: nowrap; }
.option-badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; white-space: nowrap; }
.opt-1 { background: var(--accent-blue--50); color: #2147f4; }
.opt-2 { background: var(--brand-accent--cream); color: #8a5a2a; }
.opt-3 { background: var(--brand-accent--mandarin-light); color: #a04010; }
.opt-4 { background: var(--success-green); color: #2a7a26; }
.opt-5 { background: var(--brand--secondary--lightgreen); color: #1a6a40; }
.status-badge { padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
.status-unassigned { background: var(--white-smoke); color: #c0303d; }
.status-pending { background: var(--brand--secondary--lightgreen); color: #1a6a40; }
.status-booked { background: var(--accent-blue--50); color: #2147f4; }
.status-cancelled { background: #f0f0f0; color: #999; text-decoration: line-through; }
.trainer-pill { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }

.btn { padding: 5px 12px; border-radius: 4px; font-size: 12px; font-family: Arial, sans-serif; cursor: pointer; border: none; font-weight: 600; transition: background 0.15s; display: inline-flex; align-items: center; gap: 4px; }
.btn-primary { background: var(--action-primary-blue); color: #fff; }
.btn-primary:hover { background: #1a39d4; }
.btn-primary:disabled { background: var(--text--dark--20); cursor: not-allowed; }
.btn-sm { padding: 4px 10px; font-size: 11px; }
.btn-ghost { background: none; border: 1px solid var(--light-grey); color: var(--text--dark--30); }
.btn-ghost:hover { background: var(--card-light-grey); color: #333; }
.btn-danger { background: #c0303d; color: #fff; }
.btn-danger:hover { background: #a02030; }
.btn-success { background: #22a06b; color: #fff; }
.btn-success:hover { background: #1a8055; }
.btn-edit { background: rgba(139,92,246,0.1); border: 1px solid rgba(139,92,246,0.35); color: #7c3aed; }
.btn-edit:hover { background: rgba(139,92,246,0.18); color: #6d28d9; }

.kpi-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap: 16px; margin-bottom: 24px; }
.kpi-card { border: 1px solid var(--ui--underline--light-grey); border-radius: 4px; padding: 16px 20px; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
.kpi-card.clickable { cursor: pointer; transition: box-shadow 0.15s; }
.kpi-card.clickable:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.08); }
.kpi-card-label { font-size: 11px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; color: var(--text--dark--30); margin-bottom: 8px; }
.kpi-card-value { font-size: 28px; font-weight: 700; color: var(--text--dark--50); line-height: 1.1; letter-spacing: -0.5px; }
.kpi-card-sub { font-size: 11px; color: var(--text--dark--30); margin-top: 4px; }
.kpi-card-delta { display: inline-flex; align-items: center; gap: 3px; font-size: 11px; font-weight: 600; padding: 1px 6px; border-radius: 4px; margin-top: 6px; }
.delta-up { background: var(--success-green); color: #2a7a26; }
.delta-down { background: var(--white-smoke); color: #c0303d; }
.kpi-accent-left { border-left: 3px solid var(--action-primary-blue); padding-left: 14px; }
.kpi-accent-yellow { border-left-color: var(--brand--yellow); }
.kpi-accent-green { border-left-color: #4caf50; }
.kpi-accent-orange { border-left-color: #ff7043; }

.charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; margin-bottom: 24px; }
@media (max-width: 900px) { .charts-grid { grid-template-columns: 1fr; } }
.chart-card { border: 1px solid var(--ui--underline--light-grey); border-radius: 4px; padding: 20px; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
.chart-title { font-size: 13px; font-weight: 600; color: var(--text--dark--50); margin-bottom: 4px; }
.chart-subtitle { font-size: 11px; color: var(--text--dark--30); margin-bottom: 16px; }
.compare-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
.compare-card { background: var(--card-light-grey); border-radius: 4px; padding: 12px 14px; text-align: center; }
.compare-card-label { font-size: 10px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; color: var(--text--dark--30); margin-bottom: 4px; }
.compare-card-value { font-size: 22px; font-weight: 700; color: var(--text--dark--50); }

.trainer-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); gap: 12px; margin-bottom: 24px; }
.trainer-card { border: 1px solid var(--ui--underline--light-grey); border-radius: 4px; padding: 14px 16px; background: #fff; }
.trainer-name { font-size: 13px; font-weight: 600; color: var(--text--dark--50); margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
.trainer-color-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.trainer-stat { display: flex; justify-content: space-between; font-size: 11px; color: var(--text--dark--30); margin-bottom: 4px; }
.trainer-stat-val { font-weight: 600; color: var(--text--dark--40); }
.workload-bar-wrap { height: 4px; background: var(--ui--underline--light-grey); border-radius: 2px; margin-top: 8px; overflow: hidden; }
.workload-bar { height: 100%; border-radius: 2px; transition: width 0.4s ease; }
.next-free-tag { margin-top: 8px; padding: 5px 8px; background: #f0fdf4; border-radius: 5px; border: 1px solid #bbf7d0; font-size: 11px; color: #1a6a40; font-weight: 600; }
.next-free-tag.busy { background: #fde8eb; border-color: #fecaca; color: #c0303d; }

.cal-grid { display: grid; grid-template-columns: 1fr 280px; gap: 16px; margin-bottom: 24px; }
@media (max-width: 900px) { .cal-grid { grid-template-columns: 1fr; } }
.cal-month-card { background: #fff; border: 1px solid var(--ui--underline--light-grey); border-radius: 8px; overflow: hidden; }
.cal-month-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: var(--text--dark--50); color: #fff; gap: 8px; flex-wrap: wrap; }
.cal-month-title { font-size: 14px; font-weight: 700; }
.cal-nav-btn { background: rgba(255,255,255,0.12); border: none; color: #fff; cursor: pointer; padding: 4px 10px; border-radius: 4px; font-size: 14px; font-family: Arial, sans-serif; transition: background 0.12s; }
.cal-nav-btn:hover { background: rgba(255,255,255,0.22); }
.cal-filter-row { display: flex; align-items: center; gap: 8px; padding: 8px 14px; background: var(--card-light-grey); border-bottom: 1px solid var(--ui--underline--light-grey); flex-wrap: wrap; }
.cal-legend-item { display: flex; align-items: center; gap: 4px; }
.cal-legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.cal-legend-label { font-size: 10px; color: var(--text--dark--40); }
.cal-dow-row { display: flex; width: 100%; background: var(--card-light-grey); border-bottom: 1px solid var(--ui--underline--light-grey); }
.cal-dow { flex: 0 0 calc(100%/7); text-align: center; font-size: 10px; font-weight: 700; color: var(--text--dark--30); padding: 6px 0; letter-spacing: 0.5px; text-transform: uppercase; }
.cal-days { display: flex; flex-wrap: wrap; width: 100%; border-top: 1px solid #f3f4f6; border-left: 1px solid #f3f4f6; }
.cal-day { flex: 0 0 calc(100%/7); min-height: 80px; padding: 4px 3px 3px; border-right: 1px solid #f3f4f6; border-bottom: 1px solid #f3f4f6; overflow: hidden; transition: background 0.1s; }
.cal-day:hover:not(.cal-day-empty) { background: #f6f8ff; cursor: pointer; }
.cal-day-empty { background: #fafafa; }
.cal-day-weekend { background: #fafbff; }
.cal-day-today .cal-day-num { background: var(--action-primary-blue); color: #fff; width: 20px; height: 20px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 10px; }
.cal-day-holiday { background: #fffbf0; }
.cal-day-num { font-size: 11px; font-weight: 600; color: var(--text--dark--30); display: block; margin-bottom: 2px; line-height: 1; }
.cal-day-past { opacity: 0.55; }
.cal-event { display: block; font-size: 9px; font-weight: 600; padding: 2px 5px; border-radius: 3px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; max-width: 100%; }
.cal-event.provisional { border: 1.5px dashed #f59e0b !important; background: #fffbeb !important; color: #92400e !important; opacity: 0.85; }
.cal-event-more { display: block; font-size: 9px; color: var(--text--dark--30); padding: 1px 4px; cursor: pointer; }
.cal-upcoming-card { background: #fff; border: 1px solid var(--ui--underline--light-grey); border-radius: 8px; overflow: hidden; max-height: 520px; display: flex; flex-direction: column; }
.cal-upcoming-header { padding: 12px 16px; background: var(--card-light-grey); border-bottom: 1px solid var(--ui--underline--light-grey); font-size: 12px; font-weight: 700; color: var(--text--dark--40); display: flex; align-items: center; justify-content: space-between; }
.cal-upcoming-body { flex: 1; overflow-y: auto; }
.cal-upcoming-item { padding: 10px 14px; border-bottom: 1px solid #f3f4f6; display: flex; gap: 10px; align-items: flex-start; }
.cal-upcoming-item:last-child { border-bottom: none; }
.cal-upcoming-date { min-width: 38px; text-align: center; background: var(--card-light-grey); border-radius: 6px; padding: 4px 6px; flex-shrink: 0; }
.cal-upcoming-date-day { font-size: 16px; font-weight: 700; color: var(--text--dark--50); line-height: 1; }
.cal-upcoming-date-mon { font-size: 9px; font-weight: 600; color: var(--text--dark--30); text-transform: uppercase; letter-spacing: 0.5px; }
.cal-upcoming-body-text { flex: 1; min-width: 0; }
.cal-upcoming-company { font-size: 12px; font-weight: 600; color: var(--text--dark--50); }
.cal-upcoming-meta { font-size: 11px; color: var(--text--dark--30); margin-top: 2px; }
.cal-upcoming-empty { padding: 32px 20px; text-align: center; color: var(--text--dark--30); font-size: 12px; }

.all-bookings { border: 1px solid var(--ui--underline--light-grey); border-radius: 4px; overflow: hidden; }
.filter-bar { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
select.filter-select, input.filter-input { border: 1px solid var(--light-grey); border-radius: 4px; padding: 5px 10px; font-size: 12px; font-family: Arial, sans-serif; color: #333; background: #fff; }
select.filter-select:focus, input.filter-input:focus { outline: none; border-color: var(--action-primary-blue); }
.pagination { display: flex; align-items: center; gap: 8px; padding: 12px 16px; border-top: 1px solid var(--ui--underline--light-grey); background: var(--card-light-grey); font-size: 12px; color: var(--text--dark--30); }
.page-btn { background: #fff; border: 1px solid var(--light-grey); border-radius: 4px; padding: 3px 10px; font-size: 12px; cursor: pointer; font-family: Arial, sans-serif; transition: background 0.12s; }
.page-btn:hover:not(:disabled) { background: var(--card-light-grey); }
.page-btn:disabled { opacity: 0.4; cursor: not-allowed; }
.empty-state { text-align: center; padding: 40px 20px; color: var(--text--dark--30); }
.empty-state-icon { font-size: 32px; margin-bottom: 8px; }
.empty-state-text { font-size: 13px; }

.toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 999; display: flex; flex-direction: column; gap: 8px; }
.toast { background: var(--brand--black); color: #fff; padding: 10px 16px; border-radius: 4px; font-size: 13px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); animation: slideIn 0.2s ease; border-left: 3px solid var(--action-primary-blue); }
.toast.success { border-left-color: #4caf50; }
.toast.error { border-left-color: #e53935; }
@keyframes slideIn { from{transform:translateX(20px);opacity:0} to{transform:none;opacity:1} }

.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.55); z-index: 400; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
.modal-overlay.open { opacity: 1; pointer-events: all; }
.modal { background: #fff; border-radius: 10px; width: 480px; max-width: 96vw; box-shadow: 0 12px 48px rgba(0,0,0,0.25); overflow: hidden; max-height: 90vh; display: flex; flex-direction: column; }
.modal-lg { width: 560px; }
.modal-header { background: var(--brand--black); color: #fff; padding: 16px 20px; display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; flex-shrink: 0; }
.modal-title { font-size: 14px; font-weight: 600; }
.modal-subtitle { font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 3px; }
.modal-close { background: rgba(255,255,255,0.12); border: none; color: rgba(255,255,255,0.7); cursor: pointer; font-size: 16px; padding: 5px 9px; border-radius: 4px; line-height: 1; transition: background 0.12s; flex-shrink: 0; }
.modal-close:hover { background: rgba(255,255,255,0.2); color: #fff; }
.modal-body { padding: 20px; overflow-y: auto; flex: 1; }
.modal-footer { padding: 14px 20px; border-top: 1px solid var(--ui--underline--light-grey); background: var(--card-light-grey); display: flex; justify-content: flex-end; gap: 8px; flex-shrink: 0; align-items: center; }
.form-row { margin-bottom: 16px; }
.form-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; color: var(--text--dark--30); margin-bottom: 6px; display: block; }
.form-label.required::after { content: ' *'; color: #c0303d; }
.form-input, .form-select { width: 100%; box-sizing: border-box; border: 1.5px solid var(--ui--underline--light-grey); border-radius: 6px; padding: 9px 12px; font-size: 13px; font-family: Arial, sans-serif; color: var(--text--dark--50); background: #fff; transition: border-color 0.15s; }
.form-input:focus, .form-select:focus { outline: none; border-color: var(--action-primary-blue); }
.form-input.error, .form-select.error { border-color: #c0303d; background: #fff5f5; }
.form-hint { font-size: 11px; color: var(--text--dark--30); margin-top: 4px; }
.form-2col { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.warning-box { padding: 10px 14px; border-radius: 6px; font-size: 12px; margin-bottom: 12px; display: flex; gap: 8px; align-items: flex-start; }
.warning-box.warn { background: #fffbeb; border: 1px solid #fde68a; color: #92400e; }
.warning-box.error { background: #fff5f5; border: 1px solid #fecaca; color: #991b1b; }
.warning-box.info { background: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af; }
.status-preview { display: inline-flex; align-items: center; gap: 6px; padding: 5px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; border: 1px solid transparent; margin-top: 8px; }
.status-preview.pending { background: var(--brand--secondary--lightgreen); color: #1a6a40; border-color: #a8f0c8; }
.status-preview.booked { background: var(--accent-blue--50); color: #2147f4; border-color: #93c5fd; }
.company-link { font-weight: 600; cursor: pointer; color: var(--text--dark--50); text-decoration: none; border-bottom: 1px dashed var(--text--dark--20); transition: color 0.12s, border-color 0.12s; }
.company-link:hover { color: var(--action-primary-blue); border-color: var(--action-primary-blue); }

/* PROFILE SIDEBAR */
.profile-overlay { position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:350;opacity:0;pointer-events:none;transition:opacity 0.2s; }
.profile-overlay.open { opacity:1;pointer-events:all; }
.profile-panel { position:fixed;top:0;right:-520px;width:480px;max-width:97vw;height:100vh;background:#fff;z-index:351;transition:right 0.25s ease;box-shadow:-4px 0 24px rgba(0,0,0,0.14);display:flex;flex-direction:column; }
.profile-panel.open { right:0; }
.profile-panel-hdr { padding:16px 20px;background:var(--brand--black);color:#fff;display:flex;align-items:flex-start;justify-content:space-between;flex-shrink:0;gap:12px; }
.profile-panel-title { font-size:15px;font-weight:700;color:#fff;line-height:1.3; }
.profile-close-btn { background:rgba(255,255,255,0.12);border:none;color:rgba(255,255,255,0.7);cursor:pointer;font-size:16px;padding:5px 9px;border-radius:4px;line-height:1;flex-shrink:0; }
.profile-close-btn:hover { background:rgba(255,255,255,0.22);color:#fff; }
.profile-panel-body { flex:1;overflow-y:auto; }
.profile-section { border-bottom:1px solid var(--ui--underline--light-grey); }
.profile-section-hdr { cursor:pointer;padding:12px 20px;display:flex;align-items:center;justify-content:space-between;transition:background 0.1s;user-select:none; }
.profile-section-hdr:hover { background:#f6f8ff; }
.profile-section-title { font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--text--dark--40);display:flex;align-items:center;gap:6px; }
.profile-chevron { font-size:11px;color:var(--text--dark--30);transition:transform 0.2s; }
.profile-chevron.open { transform:rotate(180deg); }
.profile-section-body { display:none;padding:0 20px 14px; }
.profile-section-body.open { display:block; }
.profile-field { display:flex;gap:10px;margin-bottom:7px;font-size:12px;line-height:1.5; }
.profile-field-label { min-width:110px;font-weight:600;color:var(--text--dark--30);flex-shrink:0;font-size:11px; }
.profile-field-value { color:var(--text--dark--50);flex:1;word-break:break-word;white-space:pre-wrap;font-size:12px; }
.profile-notes-footer { padding:14px 20px;background:var(--card-light-grey);border-top:2px solid var(--ui--underline--light-grey);flex-shrink:0; }
.profile-note-item { background:#fff;border-radius:6px;padding:9px 12px;border-left:3px solid var(--action-primary-blue);margin-bottom:8px; }
.profile-note-meta { font-size:10px;color:var(--text--dark--30);margin-bottom:3px; }
.profile-note-text { font-size:12px;color:var(--text--dark--50); }

/* REFERRAL LEADERBOARD */
.referral-board { border:1px solid var(--ui--underline--light-grey);border-radius:8px;overflow:hidden;background:#fff;display:flex;align-items:stretch; }
.referral-board-left { flex:0 0 55%;min-width:0;border-right:1px solid var(--ui--underline--light-grey); }
.referral-board-right { flex:1;min-width:0;display:flex;flex-direction:column; }
.referral-board-right-header { padding:10px 16px 8px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.6px;color:var(--text--dark--30);border-bottom:1px solid var(--ui--underline--light-grey);background:var(--card-light-grey); }
.referral-board-right-scroll { overflow-y:auto;max-height:280px; }
.referral-board-empty-right { display:flex;align-items:center;justify-content:center;padding:32px 16px;font-size:11px;color:var(--text--dark--20);text-align:center; }
.referral-entry { display:flex;align-items:center;gap:14px;padding:11px 16px;border-bottom:1px solid var(--ui--underline--light-grey);cursor:pointer;transition:background 0.12s; }
.referral-entry:last-child { border-bottom:none; }
.referral-entry:hover { background:#f6f8ff; }
.referral-rank { width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0; }
.referral-rank-1 { background:var(--brand--yellow);color:#1a1a1a; }
.referral-rank-2 { background:#e5e7eb;color:#4b5563; }
.referral-rank-3 { background:#fde8c8;color:#92400e; }
.referral-rank-other { background:var(--card-light-grey);color:var(--text--dark--30); }

/* NOTIFICATION PANEL */
.notif-panel-overlay { position:fixed;inset:0;background:rgba(0,0,0,0.3);z-index:300;opacity:0;pointer-events:none;transition:opacity 0.2s; }
.notif-panel-overlay.open { opacity:1;pointer-events:all; }
.notif-panel { position:fixed;top:0;right:-420px;width:400px;height:100vh;background:#fff;z-index:301;transition:right 0.25s ease;box-shadow:-4px 0 24px rgba(0,0,0,0.12);display:flex;flex-direction:column; }
.notif-panel.open { right:0; }
.notif-panel-header { padding:14px 18px;background:var(--brand--black);color:#fff;display:flex;align-items:center;justify-content:space-between;flex-shrink:0; }
.notif-panel-title { font-size:14px;font-weight:700;display:flex;align-items:center;gap:8px; }
.notif-unread-badge { background:var(--brand--yellow);color:#1a1a1a;font-size:10px;font-weight:700;padding:1px 6px;border-radius:10px;min-width:18px;text-align:center; }
.notif-close { background:rgba(255,255,255,0.12);border:none;color:rgba(255,255,255,0.7);cursor:pointer;font-size:16px;padding:5px 9px;border-radius:4px; }
.notif-close:hover { background:rgba(255,255,255,0.2);color:#fff; }
.notif-tabs { display:flex;border-bottom:1px solid var(--ui--underline--light-grey);background:#f8f9fa;flex-shrink:0; }
.notif-tab { flex:1;padding:10px;font-size:12px;font-weight:600;border:none;background:none;cursor:pointer;color:var(--text--dark--30);font-family:Arial,sans-serif;border-bottom:2px solid transparent;transition:all 0.15s; }
.notif-tab.active { color:var(--action-primary-blue);border-bottom-color:var(--action-primary-blue);background:#fff; }
.notif-tab-badge { background:#e53935;color:#fff;font-size:9px;font-weight:700;padding:1px 5px;border-radius:8px;margin-left:4px; }
.notif-toolbar { padding:8px 14px;background:var(--card-light-grey);border-bottom:1px solid var(--ui--underline--light-grey);display:flex;align-items:center;justify-content:space-between;flex-shrink:0; }
.notif-count { font-size:11px;font-weight:600;color:var(--text--dark--30); }
.notif-toolbar-btn { font-size:11px;background:none;border:none;cursor:pointer;font-family:Arial,sans-serif;padding:2px 6px;border-radius:4px; }
.notif-toolbar-btn.mark-all { color:var(--action-primary-blue); }
.notif-toolbar-btn.clear { color:#c0303d; }
.notif-feed-body { flex:1;overflow-y:auto; }
.notif-entry { padding:12px 14px 10px;border-bottom:1px solid var(--ui--underline--light-grey);position:relative;transition:background 0.1s; }
.notif-entry.unread { background:#f0f7ff;border-left:3px solid var(--action-primary-blue); }
.notif-entry.read { border-left:3px solid transparent; }
.notif-entry:hover { background:#f6f8ff; }
.notif-entry-top { display:flex;align-items:flex-start;justify-content:space-between;gap:8px; }
.notif-who { font-size:11px;font-weight:700;color:var(--action-primary-blue); }
.notif-what { font-size:12px;color:var(--text--dark--50);margin:2px 0;font-weight:600; }
.notif-where { font-size:12px;color:var(--text--dark--40); }
.notif-detail { font-size:11px;color:var(--text--dark--30);margin-top:2px;line-height:1.4; }
.notif-time { font-size:10px;color:var(--text--dark--20);margin-top:4px; }
.notif-mark-read-btn { background:none;border:none;cursor:pointer;font-size:10px;color:var(--text--dark--20);padding:2px 5px;border-radius:3px;white-space:nowrap;font-family:Arial,sans-serif;flex-shrink:0; }
.notif-mark-read-btn:hover { color:var(--action-primary-blue);background:#e8f0fe; }
.notif-type-dot { width:7px;height:7px;border-radius:50%;flex-shrink:0;margin-top:3px; }
.notif-type-dot.event { background:var(--action-primary-blue); }
.notif-type-dot.note { background:#22a06b; }
.notif-empty { padding:40px 20px;text-align:center;color:var(--text--dark--30);font-size:12px; }
/* Bell button in header */
.bell-btn { position:relative;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);color:rgba(255,255,255,0.8);cursor:pointer;font-size:16px;padding:5px 10px;border-radius:6px;display:flex;align-items:center;gap:0;font-family:Arial,sans-serif;transition:background 0.15s; }
.bell-btn:hover { background:rgba(255,255,255,0.15);color:#fff; }
.bell-dot { position:absolute;top:4px;right:4px;width:8px;height:8px;border-radius:50%;background:#e53935;border:1.5px solid var(--brand--black);display:none; }
.bell-count { position:absolute;top:-5px;right:-5px;background:#e53935;color:#fff;font-size:9px;font-weight:700;min-width:16px;height:16px;border-radius:8px;display:none;align-items:center;justify-content:center;padding:0 3px;border:1.5px solid var(--brand--black);font-family:Arial,sans-serif; }


/* PERMISSIONS PANEL */
.perm-overlay { position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:600;opacity:0;pointer-events:none;transition:opacity 0.2s; }
.perm-overlay.open { opacity:1;pointer-events:all; }
.perm-modal { background:#fff;border-radius:10px;width:780px;max-width:97vw;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 12px 48px rgba(0,0,0,0.25);overflow:hidden; }
.perm-header { background:var(--brand--black);color:#fff;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0; }
.perm-title { font-size:14px;font-weight:700;display:flex;align-items:center;gap:10px; }
.perm-user-dot { width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;flex-shrink:0; }
.perm-body { display:flex;flex:1;overflow:hidden; }
.perm-sidebar { width:220px;border-right:1px solid var(--ui--underline--light-grey);overflow-y:auto;flex-shrink:0;background:#fafafa; }
.perm-sidebar-header { padding:10px 14px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.6px;color:var(--text--dark--30);border-bottom:1px solid var(--ui--underline--light-grey); }
.perm-user-row { display:flex;align-items:center;gap:10px;padding:10px 14px;cursor:pointer;border-bottom:1px solid #f0f0f0;transition:background 0.12s; }
.perm-user-row:hover { background:#f0f4ff; }
.perm-user-row.active { background:#e8f0fe;border-left:3px solid var(--action-primary-blue); }
.perm-user-name { font-size:12px;font-weight:600;color:var(--text--dark--50); }
.perm-user-role-tag { font-size:10px;font-weight:600;padding:1px 6px;border-radius:6px; }
.perm-user-role-tag.admin { background:#fee2e2;color:#991b1b; }
.perm-user-role-tag.manager { background:#fef3c7;color:#92400e; }
.perm-user-role-tag.trainer { background:#dbeafe;color:#1e40af; }
.perm-user-role-tag.viewer { background:#f3f4f6;color:#6b7280; }
.perm-detail { flex:1;overflow-y:auto;padding:18px; }
.perm-section-title { font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.6px;color:var(--text--dark--30);margin:16px 0 8px;padding-bottom:4px;border-bottom:1px solid var(--ui--underline--light-grey); }
.perm-section-title:first-child { margin-top:0; }
.perm-grid { display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:4px; }
.perm-toggle-row { display:flex;align-items:center;justify-content:space-between;padding:7px 10px;border-radius:6px;background:var(--card-light-grey);border:1px solid #f0f0f0; }
.perm-toggle-label { font-size:12px;color:var(--text--dark--50); }
.perm-toggle-sub { font-size:10px;color:var(--text--dark--30);margin-top:1px; }
.perm-toggle { position:relative;width:32px;height:18px;flex-shrink:0; }
.perm-toggle input { opacity:0;width:0;height:0; }
.perm-toggle-slider { position:absolute;cursor:pointer;inset:0;background:#ccc;border-radius:10px;transition:.2s; }
.perm-toggle-slider:before { position:absolute;content:"";width:12px;height:12px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.2s; }
.perm-toggle input:checked + .perm-toggle-slider { background:var(--action-primary-blue); }
.perm-toggle input:checked + .perm-toggle-slider:before { transform:translateX(14px); }
.perm-footer { padding:12px 18px;border-top:1px solid var(--ui--underline--light-grey);display:flex;align-items:center;gap:10px;background:#fafafa; }
.shadow-btn { background:#f59e0b;color:#000;border:none;border-radius:6px;padding:6px 14px;font-size:12px;font-weight:700;cursor:pointer;font-family:Arial,sans-serif;display:flex;align-items:center;gap:6px; }
.shadow-btn:hover { background:#d97706; }

/* KPI MODAL */
.kpi-modal-overlay { position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:500;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity 0.2s; }
.kpi-modal-overlay.open { opacity:1;pointer-events:all; }
.kpi-modal { background:#fff;border-radius:10px;width:680px;max-width:97vw;max-height:88vh;display:flex;flex-direction:column;box-shadow:0 12px 48px rgba(0,0,0,0.25);overflow:hidden; }
.kpi-modal-header { background:var(--text--dark--50);color:#fff;padding:16px 20px;display:flex;align-items:flex-start;justify-content:space-between;flex-shrink:0; }
.kpi-modal-body { overflow-y:auto;flex:1;padding:0; }
.kpi-stat-grid { display:grid;grid-template-columns:repeat(4,1fr);gap:0;border-bottom:1px solid var(--ui--underline--light-grey); }
.kpi-stat { padding:14px 16px;border-right:1px solid var(--ui--underline--light-grey); }
.kpi-stat:last-child { border-right:none; }
.kpi-stat-label { font-size:10px;font-weight:600;letter-spacing:0.5px;text-transform:uppercase;color:var(--text--dark--30);margin-bottom:4px; }
.kpi-stat-value { font-size:20px;font-weight:700;color:var(--text--dark--50); }

/* TRAINER MODAL */
.perm-toggle { display:inline-flex;align-items:center;width:32px;height:18px;border-radius:9px;background:#d1d5db;cursor:pointer;transition:background 0.2s;flex-shrink:0;position:relative; }
.perm-toggle.on { background:#2147f4; }
.perm-thumb { position:absolute;left:2px;width:14px;height:14px;border-radius:50%;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,0.2);transition:left 0.2s; }
.perm-toggle.on .perm-thumb { left:16px; }

.ics-status { font-size:10px;color:var(--text--dark--30);display:flex;align-items:center;gap:4px; }
.ics-dot { width:6px;height:6px;border-radius:50%;background:#d1d5db;flex-shrink:0; }
.ics-dot.ok { background:#22a06b; }
.ics-dot.error { background:#e53935; }
.ics-dot.loading { background:#f59e0b;animation:pulse-dot 1s infinite; }

/* Login search */
.login-result-row:hover, .login-result-row:focus { background:#f0f4ff; outline:none; }
/* Request form user search */
.req-user-result-row:hover, .req-user-result-row:focus { background:#f0f4ff; outline:none; }
/* PIN */
.pin-key { display:flex;flex-direction:column;align-items:center;justify-content:center;border:none;border-radius:50%;width:72px;height:72px;margin:0 auto;background:#f3f4f6;cursor:pointer;font-family:Arial,sans-serif;transition:background 0.1s,transform 0.08s;user-select:none; }
.pin-key:hover { background:#e5e7eb; }
.pin-key:active { background:#d1d5db;transform:scale(0.93); }
.pin-key-num { font-size:22px;font-weight:300;color:var(--text--dark--50);line-height:1.1; }
.pin-key-sub { font-size:8px;font-weight:700;letter-spacing:1.2px;color:var(--text--dark--30);line-height:1;margin-top:1px; }
.pin-key-ghost { background:transparent; }
.pin-key-ghost:hover { background:rgba(0,0,0,0.04); }
.pin-key-ghost:active { background:rgba(0,0,0,0.08);transform:scale(0.93); }
.pin-key-action { background:var(--action-primary-blue);color:#fff;font-size:22px;font-weight:600; }
.pin-key-action:hover { background:#1a39d4; }
.pin-dot { width:13px;height:13px;border-radius:50%;border:2px solid var(--text--dark--30);background:transparent;transition:background 0.15s,border-color 0.15s,transform 0.12s; }
.pin-dot.filled { background:var(--text--dark--50);border-color:var(--text--dark--50);transform:scale(1.08); }
.pin-dot.error { background:#c0303d;border-color:#c0303d;animation:pin-shake 0.35s ease; }
@keyframes pin-shake { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-5px)} 40%{transform:translateX(5px)} 60%{transform:translateX(-4px)} 80%{transform:translateX(4px)} }

/* REQUEST FORM */
.req-modal-overlay { position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:600;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity 0.2s; }
.req-modal-overlay.open { opacity:1;pointer-events:all; }
.req-modal { background:#fff;border-radius:14px;width:620px;max-width:97vw;max-height:92vh;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.3);overflow:hidden; }
.req-header { background:linear-gradient(135deg,#19191e 0%,#2d2b31 100%);padding:20px 24px 16px;flex-shrink:0; }
.req-header-top { display:flex;align-items:flex-start;justify-content:space-between;gap:12px; }
.req-header-title { font-size:16px;font-weight:700;color:#fff;letter-spacing:-0.3px;display:flex;align-items:center;gap:8px; }
.req-header-desc { font-size:11px;color:rgba(255,255,255,0.5);margin-top:4px;line-height:1.5; }
.req-close { background:rgba(255,255,255,0.12);border:none;color:rgba(255,255,255,0.7);cursor:pointer;font-size:16px;padding:5px 9px;border-radius:6px;flex-shrink:0;transition:background 0.15s; }
.req-close:hover { background:rgba(255,255,255,0.22);color:#fff; }
.req-progress { display:flex;align-items:center;gap:0;margin-top:16px; }
.req-step-dot { width:22px;height:22px;border-radius:50%;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;background:rgba(255,255,255,0.15);color:rgba(255,255,255,0.5);border:2px solid rgba(255,255,255,0.2);transition:all 0.2s;position:relative;z-index:1; }
.req-step-dot.active { background:var(--brand--yellow);color:#1a1a1a;border-color:var(--brand--yellow); }
.req-step-dot.done { background:#22a06b;color:#fff;border-color:#22a06b; }
.req-step-line { flex:1;height:2px;background:rgba(255,255,255,0.15);transition:background 0.3s; }
.req-step-line.done { background:#22a06b; }
.req-step-label { position:absolute;top:26px;left:50%;transform:translateX(-50%);font-size:9px;color:rgba(255,255,255,0.45);white-space:nowrap;font-weight:600;letter-spacing:0.3px; }
.req-step-dot.active .req-step-label { color:var(--brand--yellow); }
.req-step-dot.done .req-step-label { color:#22a06b; }
.req-body { flex:1;overflow-y:auto;padding:24px; }
.req-step-pane { display:none; }
.req-step-pane.active { display:block;animation:fadeStepIn 0.18s ease; }
@keyframes fadeStepIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:none} }
.req-step-title { font-size:14px;font-weight:700;color:var(--text--dark--50);margin-bottom:4px; }
.req-step-sub { font-size:12px;color:var(--text--dark--30);margin-bottom:20px;line-height:1.5; }
.req-field { margin-bottom:16px; }
.req-label { font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.6px;color:var(--text--dark--30);margin-bottom:6px;display:block; }
.req-label.required::after { content:' *';color:#c0303d; }
.req-input, .req-select, .req-textarea { width:100%;box-sizing:border-box;border:1.5px solid var(--ui--underline--light-grey);border-radius:8px;padding:10px 13px;font-size:13px;font-family:Arial,sans-serif;color:var(--text--dark--50);background:#fff;transition:border-color 0.15s;resize:vertical; }
.req-input:focus, .req-select:focus, .req-textarea:focus { outline:none;border-color:var(--action-primary-blue); }
.req-input.err, .req-select.err, .req-textarea.err { border-color:#c0303d;background:#fff7f7; }
.req-hint { font-size:11px;color:var(--text--dark--30);margin-top:4px;line-height:1.4; }
.req-2col { display:grid;grid-template-columns:1fr 1fr;gap:12px; }
.req-check-group { display:flex;flex-direction:column;gap:8px; }
.req-check-item { display:flex;align-items:flex-start;gap:10px;padding:10px 12px;border:1.5px solid var(--ui--underline--light-grey);border-radius:8px;cursor:pointer;transition:border-color 0.12s,background 0.12s; }
.req-check-item:hover { border-color:var(--accent--blue--300);background:#f6f8ff; }
.req-check-item input[type=checkbox], .req-check-item input[type=radio] { margin-top:1px;flex-shrink:0;width:15px;height:15px;accent-color:var(--action-primary-blue);cursor:pointer; }
.req-check-item label { font-size:12px;color:var(--text--dark--50);cursor:pointer;font-weight:600;line-height:1.4; }
.req-check-item .req-check-sub { font-size:11px;color:var(--text--dark--30);font-weight:400;margin-top:2px; }
.req-radio-inline { display:flex;gap:8px;flex-wrap:wrap; }
.req-radio-chip { display:flex;align-items:center;gap:7px;padding:8px 14px;border:1.5px solid var(--ui--underline--light-grey);border-radius:20px;cursor:pointer;transition:all 0.12s;font-size:12px;font-weight:600;color:var(--text--dark--40); }
.req-radio-chip:hover { border-color:var(--accent--blue--300);color:var(--action-primary-blue); }
.req-radio-chip input[type=radio] { width:13px;height:13px;accent-color:var(--action-primary-blue); }
.req-section-heading { font-size:12px;font-weight:700;color:var(--text--dark--40);text-transform:uppercase;letter-spacing:0.7px;margin-bottom:14px;display:flex;align-items:center;gap:8px; }
.req-section-heading::after { content:'';flex:1;height:1px;background:var(--ui--underline--light-grey); }
.req-footer { padding:14px 24px;border-top:1px solid var(--ui--underline--light-grey);background:var(--card-light-grey);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;gap:8px; }
.req-footer-hint { font-size:11px;color:var(--text--dark--30);flex:1; }
.req-success { text-align:center;padding:40px 20px; }
.req-success-icon { font-size:52px;margin-bottom:16px; }
.req-success-title { font-size:18px;font-weight:700;color:var(--text--dark--50);margin-bottom:8px; }
.req-success-sub { font-size:13px;color:var(--text--dark--30);line-height:1.6; }
.req-loc-btn { display:flex;flex-direction:column;align-items:center;justify-content:center;gap:5px;padding:16px 12px;border:2px solid var(--ui--underline--light-grey);border-radius:10px;cursor:pointer;background:#fff;width:100%;transition:border-color 0.15s,background 0.15s;font-family:Arial,sans-serif; }
.req-loc-btn:hover { border-color:var(--accent--blue--300);background:#f6f8ff; }
.req-loc-btn.selected { border-color:var(--action-primary-blue);background:#eff3ff; }
.req-loc-btn-label { font-size:13px;font-weight:700;color:var(--text--dark--50); }
.req-loc-btn-sub { font-size:10px;color:var(--text--dark--30); }
.req-equip-chip { display:flex;align-items:center;gap:6px;padding:7px 12px;border:1.5px solid var(--ui--underline--light-grey);border-radius:20px;cursor:pointer;font-size:12px;font-weight:600;color:var(--text--dark--40);background:#fff;transition:all 0.12s;user-select:none; }
.req-equip-chip:hover { border-color:var(--accent--blue--300);color:var(--action-primary-blue); }
.req-equip-chip input[type=checkbox] { width:13px;height:13px;accent-color:var(--action-primary-blue);cursor:pointer; }
.req-equip-chip:has(input:checked) { border-color:var(--action-primary-blue);background:#eff3ff;color:var(--action-primary-blue); }
</style>
</head>
<body>

<!-- NAV OVERLAY -->
<div class="nav-overlay" id="navOverlay" onclick="closeNav()"></div>

<!-- SIDE DRAWER -->
<nav class="nav-drawer" id="navDrawer">
  <div class="nav-drawer-header">
    <span class="nav-drawer-title">Navigation</span>
    <button class="nav-close" onclick="closeNav()">&#10005;</button>
  </div>
  <div class="nav-section-label">Dashboard</div>
  <a href="#" class="nav-item" onclick="closeNav()"><span class="nav-item-icon">&#128202;</span> Training Dashboard</a>
  <div class="nav-divider"></div>
  <div class="nav-section-label">Resources</div>
  <a href="https://docs.google.com/spreadsheets/d/1r_HODYw7kIMpWm8TNcXwJmZQuk0lsjVR6SEl2teytJM/edit" class="nav-item" target="_blank"><span class="nav-item-icon">&#128196;</span> Bookings Spreadsheet</a>
  <a href="https://docs.google.com/forms/d/e/1FAIpQLSe-s3SWoPSaIanCZLMLYNnVmu3NU-LY4Lm7Db12gHLv6LzVuQ/viewform" class="nav-item" target="_blank"><span class="nav-item-icon">&#128221;</span> Training Request Form</a>
  <div class="nav-divider"></div>
  <div class="nav-section-label">Account</div>
  <a class="nav-item" onclick="closeNav();openNotifPanel()" id="navActivityBtn"><span class="nav-item-icon">&#128276;</span> Notifications <span id="navActivityDot" style="width:7px;height:7px;border-radius:50%;background:#e53935;display:none;margin-left:auto;flex-shrink:0;"></span></a>
  <a class="nav-item" onclick="closeNav();changeMyPin()"><span class="nav-item-icon">&#128272;</span> Change PIN</a>
  <div class="nav-divider admin-only"></div>
  <div class="nav-section-label admin-only">Admin</div>
  <a class="nav-item admin-only" onclick="closeNav();openTrainerModal()"><span class="nav-item-icon">&#128100;</span> Manage Users &amp; Permissions</a>
  <a class="nav-item admin-only" onclick="closeNav();openCalSettings()"><span class="nav-item-icon">&#128197;</span> Calendar Settings</a>
  <a class="nav-item admin-only" id="navTestBtn" onclick="closeNav();testConnection(document.getElementById('navTestBtn'))"><span class="nav-item-icon">&#128269;</span> Test Connection</a>
</nav>

<!-- LOGIN SCREEN -->
<div id="loginScreen" style="position:fixed;inset:0;z-index:9999;background:var(--brand--black);display:none;flex-direction:column;align-items:center;justify-content:center;">
  <div style="text-align:center;margin-bottom:32px;">
    <div style="font-size:22px;font-weight:700;letter-spacing:-0.5px;color:#fff;">STREET<span style="color:var(--brand--yellow);">.</span><span style="font-size:12px;font-weight:400;">CO.UK</span></div>
    <div style="font-size:13px;color:rgba(255,255,255,0.45);margin-top:4px;">Training Dashboard</div>
  </div>

  <!-- Step 1: Search for user -->
  <div id="loginStep1" style="background:#fff;border-radius:16px;padding:32px 28px;width:340px;max-width:95vw;box-shadow:0 24px 60px rgba(0,0,0,0.4);">
    <div style="font-size:16px;font-weight:700;color:var(--text--dark--50);margin-bottom:4px;">Welcome back</div>
    <div style="font-size:12px;color:var(--text--dark--30);margin-bottom:22px;">Search for your name to continue</div>
    <label style="font-size:11px;font-weight:600;color:var(--text--dark--40);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;display:block;">Your name</label>
    <div style="position:relative;">
      <input id="loginSearchInput" type="text" placeholder="Start typing your name..." autocomplete="off" spellcheck="false"
        style="width:100%;padding:10px 12px;border:1.5px solid var(--light-grey);border-radius:8px;font-size:13px;font-family:Arial,sans-serif;color:var(--text--dark--50);box-sizing:border-box;outline:none;"
        oninput="loginSearchFilter()" onkeydown="loginSearchKey(event)">
      <!-- Dropdown results -->
      <div id="loginSearchResults" style="display:none;position:absolute;top:calc(100% + 4px);left:0;right:0;background:#fff;border:1.5px solid var(--light-grey);border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.12);max-height:220px;overflow-y:auto;z-index:10;"></div>
    </div>
    <div id="loginSearchError" style="font-size:11px;color:#c0303d;margin-top:8px;display:none;">No matching users found.</div>
    <!-- Selected user chip -->
    <div id="loginSelectedUser" style="display:none;margin-top:14px;padding:10px 12px;border-radius:8px;background:#f0f4ff;border:1.5px solid #c7d4ff;display:none;align-items:center;gap:10px;">
      <div id="loginSelectedAvatar" style="width:32px;height:32px;border-radius:50%;background:#2147f4;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:#fff;flex-shrink:0;"></div>
      <div>
        <div id="loginSelectedName" style="font-size:13px;font-weight:600;color:var(--text--dark--50);"></div>
        <div id="loginSelectedRole" style="font-size:11px;color:var(--text--dark--30);margin-top:1px;"></div>
      </div>
      <button onclick="loginClearUser()" style="margin-left:auto;background:none;border:none;cursor:pointer;font-size:16px;color:var(--text--dark--30);padding:2px 6px;" title="Change">&#10005;</button>
    </div>
    <button id="loginNextBtn" onclick="loginNext()" style="display:none;width:100%;margin-top:16px;padding:11px;background:var(--action-primary-blue);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;font-family:Arial,sans-serif;">Continue &#8594;</button>
    <!-- Hidden select kept for backward compat -->
    <select id="loginUserSelect" style="display:none;"></select>
  </div>

  <!-- Step 2: PIN entry -->
  <div id="loginStep2" style="display:none;background:#fff;border-radius:16px;padding:32px 28px;width:340px;max-width:95vw;box-shadow:0 24px 60px rgba(0,0,0,0.4);">
    <button onclick="loginBackToSearch()" style="background:none;border:none;cursor:pointer;font-size:12px;color:var(--text--dark--30);padding:0;margin-bottom:18px;display:flex;align-items:center;gap:4px;font-family:Arial,sans-serif;">&#8592; Back</button>
    <!-- User identity -->
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:22px;">
      <div id="pinAvatar" style="width:40px;height:40px;border-radius:50%;background:#2147f4;display:flex;align-items:center;justify-content:center;font-size:17px;font-weight:700;color:#fff;flex-shrink:0;"></div>
      <div>
        <div id="pinName" style="font-size:15px;font-weight:700;color:var(--text--dark--50);"></div>
        <div id="pinSubtitle" style="font-size:12px;color:var(--text--dark--30);margin-top:1px;"></div>
      </div>
    </div>
    <!-- Dots -->
    <div style="display:flex;justify-content:center;gap:10px;margin-bottom:24px;">
      <div class="pin-dot" id="pd0"></div>
      <div class="pin-dot" id="pd1"></div>
      <div class="pin-dot" id="pd2"></div>
      <div class="pin-dot" id="pd3"></div>
    </div>
    <div id="pinError" style="text-align:center;font-size:12px;color:#c0303d;margin-bottom:10px;min-height:18px;"></div>
    <!-- Numpad -->
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;max-width:240px;margin:0 auto;">
      <button class="pin-key" onclick="pinPadPress('1')"><span class="pin-key-num">1</span></button>
      <button class="pin-key" onclick="pinPadPress('2')"><span class="pin-key-num">2</span><span class="pin-key-sub">ABC</span></button>
      <button class="pin-key" onclick="pinPadPress('3')"><span class="pin-key-num">3</span><span class="pin-key-sub">DEF</span></button>
      <button class="pin-key" onclick="pinPadPress('4')"><span class="pin-key-num">4</span><span class="pin-key-sub">GHI</span></button>
      <button class="pin-key" onclick="pinPadPress('5')"><span class="pin-key-num">5</span><span class="pin-key-sub">JKL</span></button>
      <button class="pin-key" onclick="pinPadPress('6')"><span class="pin-key-num">6</span><span class="pin-key-sub">MNO</span></button>
      <button class="pin-key" onclick="pinPadPress('7')"><span class="pin-key-num">7</span><span class="pin-key-sub">PQRS</span></button>
      <button class="pin-key" onclick="pinPadPress('8')"><span class="pin-key-num">8</span><span class="pin-key-sub">TUV</span></button>
      <button class="pin-key" onclick="pinPadPress('9')"><span class="pin-key-num">9</span><span class="pin-key-sub">WXYZ</span></button>
      <button class="pin-key pin-key-ghost" onclick="loginBackToSearch()"><span style="font-size:12px;color:var(--text--dark--30);">&#8592;</span></button>
      <button class="pin-key" onclick="pinPadPress('0')"><span class="pin-key-num">0</span></button>
      <button class="pin-key pin-key-ghost" onclick="pinPadBackspace()"><span style="font-size:18px;color:var(--text--dark--40);">&#9003;</span></button>
    </div>
  </div>
</div>

<header class="header" id="mainHeader" style="display:none;">
  <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleNav()"><span></span><span></span><span></span></button>
  <div class="street-logo-mark">STREET<span class="logo-dot">.</span><span style="font-size:9px;font-weight:400;">CO.UK</span></div>
  <div class="header-title">Training Dashboard</div>
  <div class="header-right">
    <span class="last-updated" id="lastUpdated">&#8212;</span>
    <button class="header-btn" onclick="loadData()">&#8635; Refresh</button>
    <button class="bell-btn" id="bellBtn" onclick="openNotifPanel()" title="Notifications">&#128276;<span class="bell-dot" id="bellDot"></span><span class="bell-count" id="bellCount"></span></button>
    <button class="req-training-btn" onclick="openRequestForm()">&#128203; Request Training</button>
    <button id="shadowBanner" onclick="exitShadow()" style="display:none;background:#f59e0b;color:#000;border:none;border-radius:6px;padding:4px 10px;font-size:11px;font-weight:700;cursor:pointer;font-family:Arial,sans-serif;">&#128065; Shadowing &#8212; Exit</button>
    <div class="user-info-wrap">
      <div class="user-avatar" id="headerAvatar">?</div>
      <span id="headerUserName" style="font-size:12px;font-weight:600;color:#ddd;"></span>
      <span class="admin-badge" id="adminBadge" style="display:none;">Admin</span>
    </div>
    <button class="header-btn" style="background:rgba(248,113,113,0.15);border-color:rgba(248,113,113,0.3);color:#fca5a5;" onclick="logout()">&#128682; Sign Out</button>
  </div>
</header>

<div class="loading-bar" id="loadingBar" style="display:none;"></div>

<main class="main" id="mainContent" style="display:none;">

  <!-- TRAINER WORKLOAD -->
  <div id="trainerWorkloadSection" style="margin-bottom:24px;">
    <div class="section-header">
      <div class="section-title">&#128100; Trainer Workload</div>
      <span style="font-size:11px;color:var(--text--dark--30);">Last 30 days + upcoming &middot; Next free = 14 working days min</span>
    </div>
    <div class="trainer-grid" id="trainerGrid"><div class="kpi-card" style="text-align:center;color:var(--text--dark--30);font-size:12px;grid-column:1/-1;">Loading&#8230;</div></div>
  </div>

  <!-- UNASSIGNED REQUESTS -->
  <div id="unassignedSection" style="margin-bottom:24px;">
    <div class="section-header">
      <div class="section-title">&#128276; Unassigned Requests<span class="badge" id="unassignedBadge">0</span></div>
    </div>
    <div class="requests-panel">
      <div class="requests-panel-header">
        <div style="display:flex;align-items:center;gap:8px;"><div class="alert-dot" id="unassignedDot" style="display:none;"></div><span style="font-size:12px;font-weight:600;color:var(--text--dark--40);">New training requests awaiting trainer assignment</span></div>
        <span style="font-size:11px;color:var(--text--dark--30);">Click company name to view full enquiry profile</span>
      </div>
      <div class="table-wrap">
        <table><thead><tr><th>Submitted</th><th>Company</th><th>Contact</th><th>Option</th><th>Preferred Date</th><th>Suggested</th><th>Actions</th></tr></thead>
        <tbody id="unassignedBody"><tr><td colspan="6" style="padding:20px;text-align:center;color:var(--text--dark--30);">Connecting&#8230;</td></tr></tbody></table>
      </div>
    </div>
  </div>

  <!-- NEEDS ACTION -->
  <div id="actionSection" style="margin-bottom:24px;">
    <div class="section-header">
      <div class="section-title" style="color:#8a5a2a;">&#9888;&#65039; Needs Action &#8212; Pending<span class="badge orange" id="actionBadge">0</span></div>
      <span style="font-size:11px;color:var(--text--dark--30);">Update status to Booked or Cancelled &#8212; admin only</span>
    </div>
    <div class="requests-panel" style="border-color:var(--brand-accent--mandarin-light);">
      <div class="requests-panel-header" style="background:var(--brand-accent--cream);">
        <div style="display:flex;align-items:center;gap:8px;"><div class="alert-dot" id="actionDot" style="display:none;background:#f59e0b;"></div><span style="font-size:12px;font-weight:600;color:var(--text--dark--40);">Pending bookings awaiting confirmation</span></div>
      </div>
      <div class="table-wrap">
        <table><thead><tr><th>Submitted</th><th>Company</th><th>Contact</th><th>Option</th><th>Preferred Date</th><th>Trainer</th><th>Actions</th></tr></thead>
        <tbody id="actionBody"><tr><td colspan="7" style="padding:20px;text-align:center;color:var(--text--dark--30);">Connecting&#8230;</td></tr></tbody></table>
      </div>
    </div>
  </div>

  <!-- CALENDAR -->
  <div id="calendarSection" style="margin-bottom:24px;">
    <div class="section-header">
      <div class="section-title">&#128197; Training Calendar</div>
      <div id="icsStatusBar" style="display:flex;align-items:center;gap:10px;font-size:11px;"></div>
    </div>
    <div class="cal-grid">
      <div class="cal-month-card">
        <div class="cal-month-header">
          <button class="cal-nav-btn" onclick="calChangeMonth(-1)">&#8592;</button>
          <span class="cal-month-title" id="calMonthTitle">&#8212;</span>
          <div style="display:flex;align-items:center;gap:8px;">
            <select id="calFilterTrainer" onchange="renderCalendar()" style="font-size:11px;border:1px solid rgba(255,255,255,0.3);border-radius:4px;padding:3px 7px;font-family:Arial,sans-serif;background:rgba(255,255,255,0.1);color:#fff;"><option value="">All Trainers</option></select>
            <button class="cal-nav-btn" onclick="calChangeMonth(1)">&#8594;</button>
          </div>
        </div>
        <div class="cal-filter-row">
          <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#fef3c7;border:1px solid #fde68a;"></div><span class="cal-legend-label">Travel</span></div>
          <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#2147f4;"></div><span class="cal-legend-label">Training</span></div>
          <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#e0e7ff;border:1px solid #a5b4fc;"></div><span class="cal-legend-label">Admin</span></div>
          <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#fef9c3;border:1px solid #fde047;"></div><span class="cal-legend-label">Bank Holiday</span></div>
          <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#f3e8ff;border:1px solid #d8b4fe;"></div><span class="cal-legend-label">Team Leave</span></div>
        </div>
        <div class="cal-dow-row"><div class="cal-dow">Mon</div><div class="cal-dow">Tue</div><div class="cal-dow">Wed</div><div class="cal-dow">Thu</div><div class="cal-dow">Fri</div><div class="cal-dow">Sat</div><div class="cal-dow">Sun</div></div>
        <div class="cal-days" id="calDays"></div>
      </div>
      <div class="cal-upcoming-card">
        <div class="cal-upcoming-header"><span>Upcoming Sessions</span><span id="calUpcomingCount" style="font-size:10px;color:var(--text--dark--30);">&#8212;</span></div>
        <div class="cal-upcoming-body" id="calUpcomingBody"><div class="cal-upcoming-empty">Loading&#8230;</div></div>
      </div>
    </div>
  </div>

  <!-- KPI CARDS -->
  <div id="kpiSection">
    <div style="margin-bottom:16px;"><div class="section-title" style="margin-bottom:14px;">&#128200; Performance Overview</div></div>
    <div class="kpi-grid">
      <div class="kpi-card kpi-accent-left clickable" onclick="openKpiModal('revYear')"><div class="kpi-card-label">Total Revenue This Year <span style="font-weight:400;color:var(--accent--blue--300);">(Booked)</span></div><div class="kpi-card-value" id="kpiRevYear">&#163;&#8212;</div><div class="kpi-card-sub">Exc. VAT &middot; click for detail</div></div>
      <div class="kpi-card kpi-accent-left kpi-accent-yellow clickable" onclick="openKpiModal('revMonth')"><div class="kpi-card-label">Revenue This Month <span style="font-weight:400;color:var(--accent--blue--300);">(Booked)</span></div><div class="kpi-card-value" id="kpiRevMonth">&#163;&#8212;</div><div id="kpiRevMonthDelta"></div></div>
      <div class="kpi-card kpi-accent-left kpi-accent-green clickable" onclick="openKpiModal('avgFee')"><div class="kpi-card-label">Avg Training Fee (Year)</div><div class="kpi-card-value" id="kpiAvgFee">&#163;&#8212;</div><div class="kpi-card-sub">Per booking &middot; click for detail</div></div>
      <div class="kpi-card kpi-accent-left kpi-accent-orange clickable" onclick="openKpiModal('days')"><div class="kpi-card-label">Training Days This Year</div><div class="kpi-card-value" id="kpiDaysYear">&#8212;</div><div class="kpi-card-sub" id="kpiDaysMonth">&#8212; this month</div></div>
      <div class="kpi-card kpi-accent-left clickable" style="border-left-color:#9c27b0;" onclick="openKpiModal('daysMonth')"><div class="kpi-card-label">Training Days This Month vs Last</div><div class="kpi-card-value" id="kpiDaysThisMonth">&#8212;</div><div class="kpi-card-sub" id="kpiDaysLastMonthSub">&#8212; last month</div></div>
    </div>
    <div class="charts-grid">
      <div class="chart-card"><div class="chart-title">Monthly Revenue</div><div class="chart-subtitle">This year vs last year (exc. VAT)</div><div style="height:240px;position:relative;"><canvas id="revenueChart"></canvas></div></div>
      <div class="chart-card"><div class="chart-title">Month Comparison</div><div class="chart-subtitle">This month vs last month</div><div class="compare-cards"><div class="compare-card"><div class="compare-card-label" id="thisMonthLabel">This Month</div><div class="compare-card-value" id="thisMonthRev">&#163;&#8212;</div></div><div class="compare-card"><div class="compare-card-label" id="lastMonthLabel">Last Month</div><div class="compare-card-value" id="lastMonthRev">&#163;&#8212;</div></div></div><div style="height:150px;position:relative;"><canvas id="optionChart"></canvas></div><div class="chart-subtitle" style="margin-top:10px;margin-bottom:0;">Bookings by training option (this year)</div></div>
    </div>
  </div>

  <!-- REFERRAL LEADERBOARD -->
  <div id="referralLeaderboardSection" style="margin-bottom:24px;">
    <div class="section-header">
      <div class="section-title">&#127942; Referral Leaderboard</div>
      <span style="font-size:11px;color:var(--text--dark--30);">Click a name to see their referred enquiries &middot; Logged via Request Training form</span>
    </div>
    <div class="referral-board" id="referralLeaderboard"><div style="text-align:center;padding:24px;color:var(--text--dark--30);font-size:12px;">Loading&#8230;</div></div>
  </div>

  <!-- ALL BOOKINGS: UPCOMING + COMPLETED -->
  <div id="allBookingsSection">
    <div class="section-header" style="flex-wrap:wrap;gap:10px;margin-bottom:14px;">
      <div class="section-title">&#128203; All Bookings</div>
      <div class="filter-bar">
        <input class="filter-input" id="bookingSearch" type="text" placeholder="Search company or contact&#8230;" oninput="resetPageAndRender()" style="width:200px;">
        <select class="filter-select" id="filterStatus" onchange="resetPageAndRender()"><option value="">All Statuses</option><option value="Pending">Pending</option><option value="Booked">Booked</option><option value="Cancelled">Cancelled</option></select>
        <select class="filter-select" id="filterTrainer" onchange="resetPageAndRender()"><option value="">All Trainers</option></select>
        <select class="filter-select" id="filterOption" onchange="resetPageAndRender()">
          <option value="">All Types</option>
          <option value="Personalised Onsite Training - 1 Day">1-Day Onsite</option>
          <option value="Personalised Onsite Training - 2 Days">2-Day Onsite</option>
          <option value="Lettings Accounting Training + Go-Live Support">Accounting</option>
          <option value="Live Training at Street HQ (Manchester)">HQ Manchester</option>
          <option value="Online Refresher">Online Refresher</option>
          <option value="Not sure yet - please help me choose">Help me choose</option>
        </select>
        <input class="filter-input" id="filterDateFrom" type="date" onchange="resetPageAndRender()" style="width:130px;">
        <input class="filter-input" id="filterDateTo" type="date" onchange="resetPageAndRender()" style="width:130px;">
        <button class="btn btn-ghost btn-sm" onclick="clearBookingFilters()">&#10005; Clear</button>
      </div>
    </div>

    <!-- UPCOMING -->
    <div style="margin-bottom:20px;">
      <div class="section-header" style="margin-bottom:10px;">
        <div class="section-title" style="font-size:13px;">&#128197; Upcoming Bookings<span class="badge blue" id="upcomingBadge">0</span></div>
        <span style="font-size:11px;color:var(--text--dark--30);">Active, pending &amp; future confirmed sessions</span>
      </div>
      <div class="all-bookings">
        <div class="table-wrap"><table><thead><tr id="upcomingBookingsHead"></tr></thead><tbody id="upcomingBookingsBody"><tr><td colspan="9" style="padding:20px;text-align:center;color:var(--text--dark--30);">Loading&#8230;</td></tr></tbody></table></div>
        <div class="pagination" id="upcomingPagination" style="display:none;">
          <button class="page-btn" id="upcomingPrevBtn" onclick="changeUpcomingPage(-1)">&#8592; Prev</button>
          <span id="upcomingPageInfo">Page 1</span>
          <button class="page-btn" id="upcomingNextBtn" onclick="changeUpcomingPage(1)">Next &#8594;</button>
          <span style="margin-left:auto;" id="upcomingRowCount">0 bookings</span>
        </div>
      </div>
    </div>

    <!-- COMPLETED -->
    <div>
      <div class="section-header" style="margin-bottom:10px;">
        <div class="section-title" style="font-size:13px;">&#9989; Completed &amp; Closed Bookings<span class="badge green" id="completedBadge">0</span></div>
        <span style="font-size:11px;color:var(--text--dark--30);">Past booked sessions &amp; cancelled enquiries</span>
      </div>
      <div class="all-bookings">
        <div class="table-wrap"><table><thead><tr id="completedBookingsHead"></tr></thead><tbody id="completedBookingsBody"><tr><td colspan="9" style="padding:20px;text-align:center;color:var(--text--dark--30);">Loading&#8230;</td></tr></tbody></table></div>
        <div class="pagination" id="completedPagination" style="display:none;">
          <button class="page-btn" id="completedPrevBtn" onclick="changeCompletedPage(-1)">&#8592; Prev</button>
          <span id="completedPageInfo">Page 1</span>
          <button class="page-btn" id="completedNextBtn" onclick="changeCompletedPage(1)">Next &#8594;</button>
          <span style="margin-left:auto;" id="completedRowCount">0 bookings</span>
        </div>
      </div>
    </div>
  </div>

</main>

<!-- MODALS -->
<!-- ASSIGN -->
<div class="modal-overlay" id="assignOverlay" onclick="if(event.target===this)closeAssignModal()">
  <div class="modal">
    <div class="modal-header"><div><div class="modal-title" id="assignModalCompany">Assign Trainer</div><div class="modal-subtitle" id="assignModalContact">&#8212;</div></div><button class="modal-close" onclick="closeAssignModal()">&#10005;</button></div>
    <div class="modal-body"><div id="assignModalOption" style="margin-bottom:14px;font-size:12px;color:var(--text--dark--30);"></div><div class="form-row"><label class="form-label required">Assign Trainer</label><select class="form-select" id="assignTrainerSel"><option value="">&#8212; Select trainer &#8212;</option></select></div><div class="status-preview pending">&#128203; Enquiry will move to <strong>Pending</strong> status</div></div>
    <div class="modal-footer"><button class="btn btn-ghost" onclick="closeAssignModal()">Cancel</button><button class="btn btn-primary" onclick="confirmAssign()">&#10003; Assign &amp; Set Pending</button></div>
  </div>
</div>

<!-- BOOK -->
<div class="modal-overlay" id="bookOverlay" onclick="if(event.target===this)closeBookModal()">
  <div class="modal modal-lg">
    <div class="modal-header"><div><div class="modal-title">&#128200; Confirm Booking</div><div class="modal-subtitle" id="bookModalCompany">&#8212;</div></div><button class="modal-close" onclick="closeBookModal()">&#10005;</button></div>
    <div class="modal-body">
      <div id="bookWarnings"></div>
      <!-- Training type  required before confirming; must not be "Help me choose" -->
      <div class="form-row" id="bookTypeRow">
        <label class="form-label required">Training Type</label>
        <select class="form-select" id="bookTrainingType" onchange="checkBookingWarnings()">
          <option value=""> Select training type </option>
          <option value="Personalised Onsite Training - 1 Day">1-Day Onsite</option>
          <option value="Personalised Onsite Training - 2 Days">2-Day Onsite</option>
          <option value="Lettings Accounting Training + Go-Live Support">Accounting + Go-Live Support</option>
          <option value="Live Training at Street HQ (Manchester)">HQ Manchester</option>
          <option value="Online Refresher">Online Refresher</option>
        </select>
        <div class="form-hint" id="bookTypeHint"></div>
      </div>
      <div class="form-2col">
        <div class="form-row"><label class="form-label required">Training Date</label><input type="date" class="form-input" id="bookDate" oninput="checkBookingWarnings()"><div class="form-hint">Date training takes place</div></div>
        <div class="form-row"><label class="form-label required">Training Days</label><input type="number" class="form-input" id="bookDays" min="1" max="14" value="1" oninput="checkBookingWarnings()"></div>
      </div>
      <div class="form-row"><label class="form-label required">Trainer</label><select class="form-select" id="bookTrainer" onchange="checkBookingWarnings()"><option value="">&#8212; Select trainer &#8212;</option></select></div>
      <div class="form-row"><label class="form-label">Invoice Value (&#163;) <span style="font-size:10px;color:var(--text--dark--30);font-weight:400;">optional</span></label><input type="number" class="form-input" id="bookValue" min="0" step="50" placeholder="e.g. 1100"><div class="form-hint" id="bookValueHint">&#8212;</div></div>
      <div class="status-preview booked">&#128200; Status will be set to <strong>Booked</strong></div>
    </div>
    <div id="bookingOverrideRow" style="display:none;padding:8px 20px;background:#fff8f0;border-top:1px solid #fde8c8;"><label style="display:flex;align-items:center;gap:8px;font-size:12px;color:#92400e;cursor:pointer;font-weight:600;"><input type="checkbox" id="bookingOverride" onchange="checkBookingWarnings()">&#9888;&#65039; Admin override &#8212; confirm despite double booking conflict</label></div>
    <div class="modal-footer"><span id="bookingBlockMsg" style="font-size:12px;color:#c0303d;font-weight:600;margin-right:auto;display:none;"></span><button class="btn btn-ghost" onclick="closeBookModal()">Cancel</button><button class="btn btn-success" id="confirmBookBtn" onclick="confirmBook()">&#10003; Confirm Booking</button></div>
  </div>
</div>

<!-- EDIT BOOKING -->
<div class="modal-overlay" id="editBookingOverlay" onclick="if(event.target===this)closeEditBookingModal()">
  <div class="modal modal-lg">
    <div class="modal-header" style="background:#6d28d9;"><div><div class="modal-title">&#9998; Edit Booking</div><div class="modal-subtitle" id="editBookingCompany">&#8212;</div></div><button class="modal-close" onclick="closeEditBookingModal()">&#10005;</button></div>
    <div class="modal-body">
      <div class="warning-box info" style="margin-bottom:16px;"><span>&#8505;&#65039;</span><span>Amend the training date, invoice value, trainer, or number of days.</span></div>
      <div id="editBookingWarnings"></div>
      <div class="form-2col">
        <div class="form-row"><label class="form-label required">Training Date</label><input type="date" class="form-input" id="editBookDate" oninput="checkEditWarnings()"></div>
        <div class="form-row"><label class="form-label required">Training Days</label><input type="number" class="form-input" id="editBookDays" min="1" max="14" value="1" oninput="checkEditWarnings()"></div>
      </div>
      <div class="form-row"><label class="form-label required">Trainer</label><select class="form-select" id="editBookTrainer" onchange="checkEditWarnings()"><option value="">&#8212; Select trainer &#8212;</option></select></div>
      <div class="form-row"><label class="form-label">Invoice Value (&#163;)</label><input type="number" class="form-input" id="editBookValue" min="0" step="50" placeholder="e.g. 1100"></div>
      <div class="form-row"><label class="form-label">Amendment Reason</label><input type="text" class="form-input" id="editBookReason" placeholder="e.g. Rescheduled by client, price negotiated"></div>
    </div>
    <div id="editBookingOverrideRow" style="display:none;padding:8px 20px;background:#fff8f0;border-top:1px solid #fde8c8;"><label style="display:flex;align-items:center;gap:8px;font-size:12px;color:#92400e;cursor:pointer;font-weight:600;"><input type="checkbox" id="editBookingOverride" onchange="checkEditWarnings()">&#9888;&#65039; Admin override</label></div>
    <div class="modal-footer"><span id="editBookingBlockMsg" style="font-size:12px;color:#c0303d;font-weight:600;margin-right:auto;display:none;"></span><button class="btn btn-ghost" onclick="closeEditBookingModal()">Cancel</button><button class="btn btn-edit" id="confirmEditBookBtn" onclick="confirmEditBooking()" style="background:#6d28d9;color:#fff;border:none;">&#9998; Save Changes</button></div>
  </div>
</div>

<!-- CANCEL -->
<div class="modal-overlay" id="cancelOverlay" onclick="if(event.target===this)closeCancelModal()">
  <div class="modal">
    <div class="modal-header"><div><div class="modal-title">&#10007; Cancel Enquiry</div><div class="modal-subtitle" id="cancelModalCompany">&#8212;</div></div><button class="modal-close" onclick="closeCancelModal()">&#10005;</button></div>
    <div class="modal-body"><div class="warning-box warn" style="margin-bottom:16px;"><span>&#9888;&#65039;</span><span>This will move the enquiry to Completed. Undoable by an admin.</span></div><div class="form-row"><label class="form-label required">Cancellation Reason</label><textarea class="form-input" id="cancelReason" rows="3" placeholder="Enter the reason for cancellation&#8230;" style="resize:vertical;"></textarea></div></div>
    <div class="modal-footer"><button class="btn btn-ghost" onclick="closeCancelModal()">Go Back</button><button class="btn btn-danger" onclick="confirmCancel()">&#10007; Confirm Cancellation</button></div>
  </div>
</div>

<!-- PROVISIONAL DATE -->
<div class="modal-overlay" id="provisionalOverlay" onclick="if(event.target===this)closeProvisionalModal()">
  <div class="modal">
    <div class="modal-header" style="background:#92400e;">
      <div>
        <div class="modal-title"> Set Provisional Date</div>
        <div class="modal-subtitle" id="provisionalModalCompany"></div>
      </div>
      <button class="modal-close" onclick="closeProvisionalModal()"></button>
    </div>
    <div class="modal-body">
      <div class="warning-box info" style="margin-bottom:16px;">
        <span></span>
        <span>A provisional date won't confirm the booking  it flags this date on the calendar so the team knows it's under discussion. Anyone trying to book the same trainer on this date will see a warning.</span>
      </div>
      <div class="form-2col">
        <div class="form-row">
          <label class="form-label required">Provisional Date</label>
          <input type="date" class="form-input" id="provisionalDate">
        </div>
        <div class="form-row">
          <label class="form-label required">Trainer Being Discussed</label>
          <select class="form-select" id="provisionalTrainer">
            <option value=""> Select trainer </option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <label class="form-label">Note <span style="font-size:10px;color:var(--text--dark--30);font-weight:400;">optional</span></label>
        <input type="text" class="form-input" id="provisionalNote" placeholder="e.g. Awaiting client confirmation of budget">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" id="provisionalClearBtn" onclick="clearProvisionalDate()" style="margin-right:auto;color:#c0303d;display:none;"> Remove Provisional Date</button>
      <button class="btn btn-ghost" onclick="closeProvisionalModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveProvisionalDate()" style="background:#92400e;"> Set Provisional</button>
    </div>
  </div>
</div>

<!-- CALENDAR EVENT -->
<div class="modal-overlay" id="calEventOverlay" onclick="if(event.target===this)closeCalEventModal()">
  <div class="modal">
    <div class="modal-header" id="calEventHeader"><div><div class="modal-title" id="calEventTitle">Booking Details</div><div class="modal-subtitle" id="calEventSubtitle">&#8212;</div></div><button class="modal-close" onclick="closeCalEventModal()">&#10005;</button></div>
    <div class="modal-body" id="calEventBody"></div>
    <div class="modal-footer" id="calEventFooter"><button class="btn btn-ghost" onclick="closeCalEventModal()">Close</button></div>
  </div>
</div>

<!-- MANAGE USERS & PERMISSIONS -->
<div class="perm-overlay" id="permOverlay" onclick="if(event.target===this)closePermModal()">
  <div class="perm-modal">
    <div class="perm-header">
      <div class="perm-title">&#128100; Manage Users &amp; Permissions</div>
      <button class="notif-close" onclick="closePermModal()">&#10005;</button>
    </div>
    <div class="perm-body">
      <div class="perm-sidebar">
        <div class="perm-sidebar-header">Users</div>
        <div id="permUserList"></div>
        <div style="padding:12px;">
          <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--text--dark--30);margin-bottom:8px;">Add User</div>
          <input type="text" class="form-input" id="newTrainerName" placeholder="Full name&#8230;" style="width:100%;margin-bottom:6px;font-size:12px;" onkeydown="if(event.key==='Enter')addTrainer()">
          <select class="form-input" id="permUserDept" style="width:100%;margin-bottom:6px;font-size:12px;"><option value=""> Department </option></select>
          <select class="form-input" id="newTrainerRole" style="width:100%;margin-bottom:6px;font-size:12px;"><option value="viewer">Viewer</option><option value="manager">Manager</option><option value="trainer">Trainer</option><option value="admin">Admin</option></select>
          <button class="btn btn-primary btn-sm" onclick="addTrainer()" style="width:100%;">+ Add User</button>
        </div>
      </div>
      <div class="perm-detail" id="permDetail">
        <div style="padding:40px;text-align:center;color:var(--text--dark--30);font-size:12px;">&#128100; Select a user to configure their permissions</div>
      </div>
    </div>
    <div class="perm-footer">
      <button class="btn btn-ghost" onclick="closePermModal()">Close</button>
      <button class="btn btn-primary btn-sm" onclick="savePermissions()" id="savePermBtn" style="display:none;">&#10003; Save Permissions</button>
      <button class="shadow-btn" onclick="startShadow()" id="shadowPermBtn" style="display:none;">&#128065; Shadow this user</button>
      <button class="btn btn-sm" onclick="toggleDeactivateUser()" id="deactivatePermBtn" style="display:none;margin-left:auto;"></button>
    </div>
  </div>
</div>
<!-- legacy id alias needed by other code -->
<div id="trainerModalOverlay" style="display:none;"></div>

<!-- CAL SETTINGS -->
<div class="modal-overlay" id="calSettingsOverlay" onclick="if(event.target===this)closeCalSettings()">
  <div class="modal">
    <div class="modal-header"><div><div class="modal-title">&#128197; Calendar Settings</div><div class="modal-subtitle">Humaans ICS feeds</div></div><button class="modal-close" onclick="closeCalSettings()">&#10005;</button></div>
    <div class="modal-body">
      <div class="warning-box info" style="margin-bottom:16px;"><span>&#8505;&#65039;</span><div>ICS feeds load automatically on startup. Update URLs here if needed.</div></div>
      <div class="form-row"><label class="form-label">Public Holidays ICS URL</label><input type="text" class="form-input" id="calHolidayIcsInput" placeholder="https://app.humaans.io/&#8230;"><div class="form-hint">Defaults to Humaans UK public holidays feed</div></div>
      <div class="form-row"><label class="form-label">Team Annual Leave ICS URL</label><input type="text" class="form-input" id="calLeaveIcsInput" placeholder="https://app.humaans.io/calendar-feeds/"><div class="form-hint">Humaans team leave feed  your onboarding team URL is pre-configured</div></div>
    </div>
    <div class="modal-footer"><span id="calSettingsStatus" style="font-size:11px;color:var(--text--dark--30);margin-right:auto;"></span><button class="btn btn-ghost" onclick="closeCalSettings()">Cancel</button><button class="btn btn-primary" onclick="saveCalSettings()">Save &amp; Sync</button></div>
  </div>
</div>

<!-- KPI MODAL -->
<div class="kpi-modal-overlay" id="kpiModalOverlay" onclick="if(event.target===this)document.getElementById('kpiModalOverlay').classList.remove('open')">
  <div class="kpi-modal">
    <div class="kpi-modal-header"><div><div class="modal-title" id="kpiModalTitle">&#8212;</div><div class="modal-subtitle" id="kpiModalSubtitle">&#8212;</div></div><button class="modal-close" onclick="document.getElementById('kpiModalOverlay').classList.remove('open')">&#10005;</button></div>
    <div class="kpi-modal-body"><div class="kpi-stat-grid" id="kpiStatGrid"></div><div style="padding:16px;"><table style="width:100%;font-size:12px;border-collapse:collapse;"><thead id="kpiModalTableHead"></thead><tbody id="kpiModalTableBody"></tbody></table></div></div>
  </div>
</div>

<!-- REFERRAL MODAL -->
<div class="modal-overlay" id="referralModalOverlay" onclick="if(event.target===this)closeReferralModal()">
  <div class="modal" style="width:700px;max-width:97vw;">
    <div class="modal-header"><div><div class="modal-title" id="referralModalTitle">Referral Detail</div><div class="modal-subtitle" id="referralModalSub">&#8212;</div></div><button class="modal-close" onclick="closeReferralModal()">&#10005;</button></div>
    <div class="modal-body" style="padding:0;">
      <div id="referralModalStats" style="padding:14px 16px;border-bottom:1px solid var(--ui--underline--light-grey);background:var(--card-light-grey);"></div>
      <div style="padding:10px 16px;border-bottom:1px solid var(--ui--underline--light-grey);display:flex;gap:8px;flex-wrap:wrap;">
        <input type="date" class="filter-input" id="referralFilterDateFrom" onchange="renderReferralModalTable()" style="width:130px;">
        <input type="date" class="filter-input" id="referralFilterDateTo" onchange="renderReferralModalTable()" style="width:130px;">
        <select class="filter-select" id="referralFilterStatus" onchange="renderReferralModalTable()"><option value="">All Statuses</option><option value="Unassigned">Unassigned</option><option value="Pending">Pending</option><option value="Booked">Booked</option><option value="Cancelled">Cancelled</option></select>
        <button class="btn btn-ghost btn-sm" onclick="clearReferralFilters()">&#10005; Clear</button>
      </div>
      <div style="overflow-x:auto;max-height:360px;overflow-y:auto;">
        <table style="width:100%;border-collapse:collapse;font-size:13px;">
          <thead><tr style="background:var(--card-light-grey);">
            <th style="padding:9px 12px;font-size:11px;font-weight:700;text-transform:uppercase;color:var(--text--dark--30);border-bottom:1px solid var(--ui--underline--light-grey);">Submitted</th>
            <th style="padding:9px 12px;font-size:11px;font-weight:700;text-transform:uppercase;color:var(--text--dark--30);border-bottom:1px solid var(--ui--underline--light-grey);">Company</th>
            <th style="padding:9px 12px;font-size:11px;font-weight:700;text-transform:uppercase;color:var(--text--dark--30);border-bottom:1px solid var(--ui--underline--light-grey);">Option</th>
            <th style="padding:9px 12px;font-size:11px;font-weight:700;text-transform:uppercase;color:var(--text--dark--30);border-bottom:1px solid var(--ui--underline--light-grey);">Booked Date</th>
            <th style="padding:9px 12px;font-size:11px;font-weight:700;text-transform:uppercase;color:var(--text--dark--30);border-bottom:1px solid var(--ui--underline--light-grey);">Value</th>
            <th style="padding:9px 12px;font-size:11px;font-weight:700;text-transform:uppercase;color:var(--text--dark--30);border-bottom:1px solid var(--ui--underline--light-grey);">Status</th>
          </tr></thead>
          <tbody id="referralModalBody"></tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-ghost" onclick="closeReferralModal()">Close</button></div>
  </div>
</div>

<!-- NOTIFICATION PANEL -->
<div class="notif-panel-overlay" id="notifPanelOverlay" onclick="closeNotifPanel()"></div>
<div class="notif-panel" id="notifPanel">
  <div class="notif-panel-header">
    <div class="notif-panel-title">&#128276; Notifications <span class="notif-unread-badge" id="notifUnreadBadge" style="display:none;">0</span></div>
    <button class="notif-close" onclick="closeNotifPanel()">&#10005;</button>
  </div>
  <div class="notif-tabs">
    <button class="notif-tab active" id="notifTabEvents" onclick="switchNotifTab('event')">Events <span class="notif-tab-badge" id="notifTabEventsBadge" style="display:none;">0</span></button>
    <button class="notif-tab" id="notifTabNotes" onclick="switchNotifTab('note')">Notes <span class="notif-tab-badge" id="notifTabNotesBadge" style="display:none;">0</span></button>
  </div>
  <div class="notif-toolbar">
    <span class="notif-count" id="notifCount">0 notifications</span>
    <div style="display:flex;gap:8px;">
      <button class="notif-toolbar-btn mark-all" onclick="markAllNotifRead()">&#10003; Mark all read</button>
      <button class="notif-toolbar-btn clear" onclick="clearNotifLog()">&#128465; Clear</button>
    </div>
  </div>
  <div class="notif-feed-body" id="notifFeedBody"><div class="notif-empty">&#128203; No notifications yet</div></div>
</div>

<!-- PROFILE SIDEBAR -->
<div class="profile-overlay" id="profileOverlay" onclick="closeProfileSidebar()"></div>
<div class="profile-panel" id="profilePanel">
  <div class="profile-panel-hdr">
    <div style="flex:1;min-width:0;"><div class="profile-panel-title" id="profileCompany">&#8212;</div><div id="profileMeta" style="font-size:11px;color:rgba(255,255,255,0.55);margin-top:5px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;"></div></div>
    <button class="profile-close-btn" onclick="closeProfileSidebar()">&#10005;</button>
  </div>
  <div class="profile-panel-body" id="profileSections"></div>
  <div class="profile-notes-footer">
    <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--text--dark--40);margin-bottom:10px;">&#128221; Progress Notes</div>
    <div id="profileNotesList" style="max-height:160px;overflow-y:auto;margin-bottom:10px;"></div>
    <div style="display:flex;gap:8px;" id="profileNoteInput">
      <textarea id="profileNewNote" rows="2" placeholder="Add a note&#8230;" style="flex:1;border:1.5px solid var(--ui--underline--light-grey);border-radius:6px;padding:8px 10px;font-size:12px;font-family:Arial,sans-serif;resize:none;color:var(--text--dark--50);"></textarea>
      <button class="btn btn-primary btn-sm" onclick="saveProfileNote()" style="align-self:flex-end;">Add</button>
    </div>
  </div>
</div>

<!-- REQUEST TRAINING MODAL -->
<div class="req-modal-overlay" id="reqOverlay" onclick="if(event.target===this)closeRequestForm()">
  <div class="req-modal">
    <div class="req-header">
      <div class="req-header-top"><div><div class="req-header-title">&#128203; Request a Training Day</div><div class="req-header-desc">Submit a training request on behalf of a client.</div></div><button class="req-close" onclick="closeRequestForm()">&#10005;</button></div>
      <div class="req-progress" id="reqProgress" style="margin-top:20px;padding-bottom:20px;"></div>
    </div>
    <div class="req-body" id="reqBody">
      <div class="req-step-pane" id="reqStep1">
        <div class="req-step-title">Your Details</div><div class="req-step-sub">Search for your name, or click <strong>Add me as a new user</strong> if you're not listed.</div>
        <div class="req-field">
          <label class="req-label required">Who is submitting this request?</label>
          <div style="position:relative;">
            <input id="reqUserSearch" type="text" class="req-input" placeholder="Start typing your name..." autocomplete="off" spellcheck="false"
              oninput="reqSearchFilter()" onkeydown="reqSearchKey(event)"
              style="padding-right:32px;">
            <span id="reqUserSearchClear" onclick="reqClearUser()" style="display:none;position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:16px;color:var(--text--dark--30);line-height:1;">&#10005;</span>
            <!-- Dropdown -->
            <div id="reqUserResults" style="display:none;position:absolute;top:calc(100% + 4px);left:0;right:0;background:#fff;border:1.5px solid var(--light-grey);border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.12);max-height:240px;overflow-y:auto;z-index:100;">
            </div>
          </div>
          <!-- Hidden field keeping actual name value for form submission -->
          <input type="hidden" id="reqUserPicker">
        </div>
        <!-- Selected user chip -->
        <div id="reqUserChip" style="display:none;margin-top:-4px;margin-bottom:8px;padding:10px 12px;border-radius:8px;background:#f0f4ff;border:1.5px solid #c7d4ff;align-items:center;gap:10px;">
          <div id="reqUserChipAvatar" style="width:30px;height:30px;border-radius:50%;background:#2147f4;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff;flex-shrink:0;"></div>
          <div style="flex:1;min-width:0;">
            <div id="reqUserChipName" style="font-size:13px;font-weight:600;color:var(--text--dark--50);"></div>
            <div id="reqUserChipSub" style="font-size:11px;color:var(--text--dark--30);margin-top:1px;"></div>
          </div>
        </div>

        <div id="reqNewUserFields" style="display:none;margin-top:4px;">
          <div class="warning-box info" style="margin-bottom:12px;"><span>&#8505;&#65039;</span><span>New users are added as <strong>Viewer</strong> by default. An admin can update their role later.</span></div>
          <div class="req-2col">
            <div class="req-field"><label class="req-label required">First Name</label><input type="text" class="req-input" id="reqNewFirstName" placeholder="e.g. Sarah"></div>
            <div class="req-field"><label class="req-label required">Last Name</label><input type="text" class="req-input" id="reqNewLastName" placeholder="e.g. Jones"></div>
          </div>
          <div class="req-field"><label class="req-label required">Department / Team</label><select class="req-input" id="reqNewDept"><option value=""> Select department </option></select></div>
        </div>
        <div id="reqExistingTeamRow" style="display:none;" class="req-field">
          <label class="req-label">Team / Department</label>
          <select class="req-input" id="reqReferredByTeam"><option value=""> Select department </option></select>
        </div>
        <input type="hidden" id="reqReferredByName">
        <div class="req-field"><label class="req-label">Invoice Value Quoted</label><div style="position:relative;"><span style="position:absolute;left:13px;top:50%;transform:translateY(-50%);font-size:13px;color:var(--text--dark--30);font-weight:600;">&#163;</span><input type="number" class="req-input" id="reqQuotedValue" placeholder="0.00" min="0" step="0.01" style="padding-left:28px;"></div><div class="req-hint">Leave blank if no value has been discussed yet.</div></div>
        <div class="req-field"><label class="req-label">Referral Notes</label><input type="text" class="req-input" id="reqReferralNotes" placeholder="e.g. Client mentioned during onboarding call, keen to book ASAP"></div>
      </div>
      <div class="req-step-pane" id="reqStep2">
        <div class="req-step-title">Contact &amp; Company Details</div><div class="req-step-sub">Tell us about the client and who will be authorising the training.</div>
        <div class="req-field"><label class="req-label required">Email Address</label><input type="email" class="req-input" id="reqEmail" placeholder="client@example.com"></div>
        <div class="req-field"><label class="req-label required">Company / Business Name</label><input type="text" class="req-input" id="reqCompany" placeholder="e.g. Acorn Estates"></div>
        <div class="req-field"><label class="req-label required">Client Stakeholder Name &amp; Phone</label><input type="text" class="req-input" id="reqStakeholder" placeholder="Full name + phone of the person authorising training &amp; costs"><div class="req-hint">The decision-maker who can approve training and costs.</div></div>
        <div class="req-field"><label class="req-label">Attendees</label><textarea class="req-textarea" id="reqAttendees" rows="3" placeholder="Names, job titles and roles of everyone attending."></textarea></div>
        <div class="req-field"><label class="req-label">Target Go-Live Date</label><input type="date" class="req-input" id="reqGoLive"><div class="req-hint">The date you're working towards going live with Street.</div></div>
        <div class="req-field"><label class="req-label">Preferred Training Date</label><input type="date" class="req-input" id="reqPreferredDate"></div>
      </div>
      <div class="req-step-pane" id="reqStep3">
        <div class="req-step-title">Training Package &amp; Goals</div><div class="req-step-sub">Help us understand what you need so we can tailor the session.</div>
        <div class="req-field"><label class="req-label required">What type of training are you interested in?</label><div class="req-check-group"><label class="req-check-item"><input type="radio" name="trainingType" value="Personalised Onsite Training - 1 Day"><div><label>Personalised Onsite Training &#8211; 1 Day</label><div class="req-check-sub">One full day at your offices covering core workflows</div></div></label><label class="req-check-item"><input type="radio" name="trainingType" value="Personalised Onsite Training - 2 Days"><div><label>Personalised Onsite Training &#8211; 2 Days</label><div class="req-check-sub">Two days for a deeper training programme</div></div></label><label class="req-check-item"><input type="radio" name="trainingType" value="Lettings Accounting Training + Go-Live Support"><div><label>Lettings Accounting + Go-Live Support</label><div class="req-check-sub">Specialist accounting training with hands-on go-live assistance</div></div></label><label class="req-check-item"><input type="radio" name="trainingType" value="Live Training at Street HQ (Manchester)"><div><label>Live Training at Street HQ &#8211; Manchester</label><div class="req-check-sub">Come to our Manchester office for an immersive session</div></div></label><label class="req-check-item"><input type="radio" name="trainingType" value="Online Refresher"><div><label>Online Refresher</label><div class="req-check-sub">A focused virtual session to refresh specific areas</div></div></label><label class="req-check-item"><input type="radio" name="trainingType" value="Not sure yet - please help me choose"><div><label>Not sure yet &#8212; please help me choose</label><div class="req-check-sub">Tell us your goals and we'll recommend the right package</div></div></label></div></div>
        <div class="req-field" style="margin-top:20px;"><label class="req-label required">How familiar is your team with Street?</label><div class="req-radio-inline"><label class="req-radio-chip"><input type="radio" name="teamFamiliarity" value="Complete Beginners"> Complete Beginners</label><label class="req-radio-chip"><input type="radio" name="teamFamiliarity" value="Mixed Experience"> Mixed Experience</label><label class="req-radio-chip"><input type="radio" name="teamFamiliarity" value="Experienced - need refresher"> Experienced &#8212; Need Refresher</label></div></div>
        <div class="req-field" style="margin-top:20px;"><label class="req-label required">Which areas of Street do you want to cover?</label><div class="req-check-group"><label class="req-check-item"><input type="checkbox" name="areas" value="Sales"> <label>Sales</label></label><label class="req-check-item"><input type="checkbox" name="areas" value="Lettings Front End"> <label>Lettings Front End</label></label><label class="req-check-item"><input type="checkbox" name="areas" value="Accounting"> <label>Accounting</label></label><label class="req-check-item"><input type="checkbox" name="areas" value="Property Management"> <label>Property Management</label></label></div></div>
      </div>
      <div class="req-step-pane" id="reqStep4">
        <div class="req-step-title">Priorities &amp; Logistics</div><div class="req-step-sub">Help us make the day run smoothly.</div>
        <div class="req-field"><label class="req-label required">Top 3 priorities for this training day</label><textarea class="req-textarea" id="reqPriorities" rows="3" placeholder="e.g. 1. Compliance workflows&#10;2. Sales progression tracking&#10;3. Report building"></textarea></div>
        <div class="req-field"><label class="req-label">Specific features or workflows to cover</label><textarea class="req-textarea" id="reqFeatures" rows="2" placeholder="e.g. sales progression, lettings compliance, accounting&#8230;"></textarea></div>
        <div class="req-field"><label class="req-label">Current challenges or frustrations</label><textarea class="req-textarea" id="reqChallenges" rows="2" placeholder="Anything your team struggles with day-to-day"></textarea></div>
        <div class="req-section-heading">Logistics</div>
        <div class="req-field"><label class="req-label">Training Location</label>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;"><button type="button" class="req-loc-btn" id="reqLocHQBtn" onclick="selectLocation('hq')"><span style="font-size:20px;">&#127970;</span><span class="req-loc-btn-label">Street HQ</span><span class="req-loc-btn-sub">North Square, Manchester</span></button><button type="button" class="req-loc-btn" id="reqLocOtherBtn" onclick="selectLocation('other')"><span style="font-size:20px;">&#128205;</span><span class="req-loc-btn-label">Other Location</span><span class="req-loc-btn-sub">I'll provide the details</span></button></div>
          <div id="reqLocHQConfirm" style="display:none;border-radius:10px;overflow:hidden;border:1.5px solid #86efac;"><div style="background:#f0fdf4;padding:12px 14px;border-bottom:1px solid #bbf7d0;"><div style="font-size:12px;font-weight:700;color:#166534;">&#10003; Street HQ &#8212; North Square, 11&#8211;13 Spear St, Manchester M1 1JU</div></div><div style="background:#fff;padding:12px 14px;"><label><div style="font-size:11px;font-weight:700;color:var(--text--dark--40);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Dietary Requirements</div><textarea class="req-textarea" id="reqDietaryReqs" rows="2" placeholder="List any dietary requirements&#8230; Leave blank if none."></textarea></label></div></div>
          <div id="reqLocOtherFields" style="display:none;margin-top:4px;"><div class="req-field"><label class="req-label required">Meeting Room Name &amp; Address</label><input type="text" class="req-input" id="reqLocAddress" placeholder="e.g. The Boardroom, 14 King Street, Leeds LS1 2AB"><div class="req-hint">Please include the full postcode.</div></div><div class="req-field"><label class="req-label">Parking &amp; Access Instructions</label><textarea class="req-textarea" id="reqLocParking" rows="2" placeholder="e.g. NCP car park on the right&#8230;"></textarea></div><div class="req-field" style="margin-bottom:0;"><label class="req-label">Available Equipment</label><div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:4px;" id="reqEquipGrid"><label class="req-equip-chip"><input type="checkbox" value="Projector"> Projector</label><label class="req-equip-chip"><input type="checkbox" value="Large Screen / TV"> Large Screen / TV</label><label class="req-equip-chip"><input type="checkbox" value="Wi-Fi"> Wi-Fi</label><label class="req-equip-chip"><input type="checkbox" value="HDMI Cable"> HDMI Cable</label><label class="req-equip-chip"><input type="checkbox" value="Extension Lead"> Extension Lead</label><label class="req-equip-chip"><input type="checkbox" value="Whiteboard"> Whiteboard</label><label class="req-equip-chip"><input type="checkbox" value="Video Conferencing"> Video Conferencing</label></div><div class="req-field" style="margin-top:10px;margin-bottom:0;"><input type="text" class="req-input" id="reqLocEquipOther" placeholder="Any other equipment&#8230;"></div></div></div>
        </div>
        <div class="req-section-heading">Follow-Up</div>
        <div class="req-field"><label class="req-label">How would you like post-training support?</label><div class="req-check-group"><label class="req-check-item"><input type="checkbox" name="followUp" value="Email recap & resources"> <label>Email recap &amp; resources</label></label><label class="req-check-item"><input type="checkbox" name="followUp" value="Follow-up call"> <label>Follow-up call</label></label><label class="req-check-item"><input type="checkbox" name="followUp" value="Additional training session"><label>Additional training session</label></label></div></div>
        <div class="req-field"><label class="req-label">Anything else we should know?</label><textarea class="req-textarea" id="reqAnythingElse" rows="2" placeholder="Any other context that'll help us make the session valuable"></textarea></div>
      </div>
      <div class="req-step-pane" id="reqStep5">
        <div class="req-success"><div class="req-success-icon">&#10003;&#65039;</div><div class="req-success-title">Request submitted!</div><div class="req-success-sub" id="reqSuccessMsg">Your training request has been sent. Our team will review it and be in touch.</div><div style="margin-top:24px;"><button class="btn btn-primary" onclick="closeRequestForm()" style="padding:10px 24px;font-size:13px;">Close</button></div></div>
      </div>
    </div>
    <div class="req-footer" id="reqFooter">
      <span class="req-footer-hint" id="reqFooterHint"></span>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn btn-ghost" id="reqBackBtn" onclick="reqPrevStep()" style="display:none;">&#8592; Back</button>
        <button class="btn btn-ghost" id="reqSkipBtn" onclick="reqSkipStep()" style="display:none;color:var(--text--dark--30);">Skip for now &#8594;</button>
        <button class="btn btn-primary" id="reqNextBtn" onclick="reqNextStep()">Continue &#8594;</button>
      </div>
    </div>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>
<script>
// ===================== CONFIGURATION =====================
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzCvBhFSPyyoaVsui0DCxvGQQa0V7e_UCJ5LfqvcSysTHTFlNRcx4ewlET5TyouJ0ZYow/exec';

//  Activity Log 
// Unique session ID generated once per page load
const SESSION_ID = 'S-' + Date.now().toString(36).toUpperCase() + '-' + Math.random().toString(36).slice(2,6).toUpperCase();

/**
 * writeActivityLog(entry)
 * Fire-and-forget write to the ACTIVITY LOG sheet.
 * Call this from any action that should be audited.
 *
 * @param {object} entry
 *   actionType   - "Status Change" | "Note Added" | "Login" | "Form Submission" |
 *                  "Button Click" | "User Management" | "Cancellation" | "Assignment"
 *   description  - human-readable summary, e.g. "Pending changed to Booked"
 *   module       - "Dashboard" | "Calendar" | "Training Requests" | "Settings" | "Client Profile"
 *   recordType   - "Booking" | "Enquiry" | "User" | "Note"
 *   recordId     - row number, company name, or other reference
 *   before       - value before change (or "")
 *   after        - value after change
 *   reason       - "Manual" | "Auto" | "Form Submit" | free text
 *   source       - "Dashboard Button" | "Google Form" | "Apps Script" | "System"
 *   company      - client / company name
 *   trainer      - affected trainer name
 *   notes        - any extra context
 */
function writeActivityLog(entry) {
  if(!SCRIPT_URL) return;
  const u = currentUser || {};
  const params = new URLSearchParams({
    action:      'logActivity',
    ts:          new Date().toISOString(),
    user:        u.name  || u.email || 'System',
    userRole:    u.role  || 'system',
    actionType:  entry.actionType  || '',
    description: entry.description || '',
    module:      entry.module      || 'Dashboard',
    recordType:  entry.recordType  || '',
    recordId:    entry.recordId    || '',
    before:      entry.before      || '',
    after:       entry.after       || '',
    reason:      entry.reason      || 'Manual',
    source:      entry.source      || 'Dashboard Button',
    company:     entry.company     || '',
    trainer:     entry.trainer     || '',
    notes:       entry.notes       || '',
    sessionId:   SESSION_ID,
  });
  // Fire and forget  never block UI for a log write
  fetch(SCRIPT_URL + '?' + params.toString(), { method:'GET', redirect:'follow' })
    .catch(e => console.warn('Activity log write failed:', e.message));
}

/**
 * writeNoteToSheet(rowRef, record, text, section)
 * Persists a progress note to the "Progress Notes" sheet.
 * Uses GET (same as all other API calls - POST gets stripped by Apps Script redirect).
 * Falls back to a localStorage retry queue if the request fails.
 */
async function writeNoteToSheet(rowRef, record, text, section) {
  if(!SCRIPT_URL || !text) return;
  const u = currentUser || {};
  const entry = {
    action:   'saveNote',
    rowRef:   String(rowRef),
    record:   record  || '',
    section:  section || 'Client Profile',
    text:     text,
    author:   u.name || u.email || 'Unknown',
    userRole: u.role || '',
    ts:       new Date().toISOString(),
  };
  const ok = await _trySaveNote(entry);
  if(!ok) {
    // Queue for retry on next loadData
    const queue = JSON.parse(localStorage.getItem('noteRetryQueue') || '[]');
    queue.push(entry);
    localStorage.setItem('noteRetryQueue', JSON.stringify(queue));
    console.warn('Note queued for retry:', entry.text.slice(0, 40));
  }
}

async function _trySaveNote(entry) {
  try {
    const params = new URLSearchParams(entry);
    const res  = await fetch(SCRIPT_URL + '?' + params.toString(), { method:'GET', redirect:'follow' });
    const json = await res.json();
    if(json.success) return true;
    console.warn('saveNote failed:', json.error);
    return false;
  } catch(e) {
    console.warn('saveNote fetch error:', e.message);
    return false;
  }
}

// Called at the start of loadData  flushes any queued notes that failed before
async function flushNoteQueue() {
  const queue = JSON.parse(localStorage.getItem('noteRetryQueue') || '[]');
  if(!queue.length) return;
  const remaining = [];
  for(const entry of queue) {
    const ok = await _trySaveNote(entry);
    if(!ok) remaining.push(entry);
  }
  localStorage.setItem('noteRetryQueue', JSON.stringify(remaining));
  if(remaining.length < queue.length) {
    console.log('Flushed', queue.length - remaining.length, 'queued note(s) to sheet');
  }
}
const HUMAANS_PUBLIC_HOLIDAYS_ICS = 'https://app.humaans.io/api/public-holidays/ical/QpA8bHDPGu0Ob5Vq?token=d8TLYjXLrRPMt8FI';
const HUMAANS_LEAVE_ICS = 'https://app.humaans.io/calendar-feeds/5GazIsnzjxJnLUPrls2lrPcs?filter=my-teams';
const STALE_DAYS = 5;
const UK_BANK_HOLIDAYS_API = 'https://www.gov.uk/bank-holidays.json';
const TRAINER_COLORS = ['#2147f4','#e53935','#22a06b','#f59e0b','#9c27b0','#00bcd4','#ff7043','#3f51b5'];

// ===================== STATE =====================
let allData = [];
let trainers = [];
let currentUser = null;
let currentCalMonth = new Date();
let calIcsEvents = [];
let calLeaveEvents = [];
let bankHolidays = [];

// ===================== PERMISSIONS =====================
const ROLE_DEFAULTS = {
  admin: {
    viewKpis:true, viewCalendar:true, viewUnassigned:true, viewPending:true,
    viewAllBookings:true, viewReferrals:true, viewTrainerWorkload:true,
    assignTrainer:true, confirmBooking:true, editBooking:true, cancelBooking:true,
    manageUsers:true, viewActivityFeed:true, requestTraining:true, addNotes:true
  },
  manager: {
    viewKpis:true, viewCalendar:true, viewUnassigned:true, viewPending:true,
    viewAllBookings:true, viewReferrals:true, viewTrainerWorkload:true,
    assignTrainer:false, confirmBooking:false, editBooking:true, cancelBooking:false,
    manageUsers:false, viewActivityFeed:true, requestTraining:true, addNotes:true
  },
  trainer: {
    viewKpis:false, viewCalendar:true, viewUnassigned:false, viewPending:false,
    viewAllBookings:false, viewReferrals:false, viewTrainerWorkload:false,
    assignTrainer:false, confirmBooking:false, editBooking:true, cancelBooking:false,
    manageUsers:false, viewActivityFeed:true, requestTraining:true, addNotes:true
  },
  viewer: {
    viewKpis:false, viewCalendar:true, viewUnassigned:true, viewPending:true,
    viewAllBookings:false, viewReferrals:false, viewTrainerWorkload:true,
    assignTrainer:false, confirmBooking:false, editBooking:false, cancelBooking:false,
    manageUsers:false, viewActivityFeed:true, requestTraining:true, addNotes:true
  }
};

const PERM_LABELS = {
  viewKpis:          { label:'View KPI Cards',          sub:'Revenue, training days overview' },
  viewCalendar:      { label:'View Calendar',            sub:'Training & booking calendar' },
  viewUnassigned:    { label:'View Unassigned Requests', sub:'New requests awaiting trainer' },
  viewPending:       { label:'View Needs Action',        sub:'Pending bookings panel' },
  viewAllBookings:   { label:'View All Bookings',        sub:'Upcoming + completed table' },
  viewReferrals:     { label:'View Referral Leaderboard',sub:'Referral stats' },
  viewTrainerWorkload:{ label:'View Trainer Workload',   sub:'Trainer cards' },
  assignTrainer:     { label:'Assign Trainer',           sub:'Assign button on requests' },
  confirmBooking:    { label:'Confirm Bookings',         sub:'Confirm button on pending' },
  editBooking:       { label:'Edit Bookings',            sub:'Edit date / trainer / value' },
  cancelBooking:     { label:'Cancel Bookings',          sub:'Cancel button on requests' },
  manageUsers:       { label:'Manage Users',             sub:'Access user permissions' },
  viewActivityFeed:  { label:'View Notifications',       sub:'Bell & activity panel' },
  requestTraining:   { label:'Request Training',         sub:'Submit training request form' },
  addNotes:          { label:'Add Notes',                sub:'Profile progress notes' }
};

const PERM_SECTIONS = {
  'Visible Widgets': ['viewKpis','viewCalendar','viewUnassigned','viewPending','viewAllBookings','viewReferrals','viewTrainerWorkload'],
  'Action Buttons':  ['assignTrainer','confirmBooking','editBooking','cancelBooking'],
  'Features':        ['manageUsers','viewActivityFeed','requestTraining','addNotes']
};

let selectedPermUserId = null;

// Get effective permissions for a user object
function userPerms(u) {
  const defaults = ROLE_DEFAULTS[u.role] || ROLE_DEFAULTS.viewer;
  return Object.assign({}, defaults, u.customPerms || {});
}

// Central permission check  use this everywhere instead of role checks
function canDo(perm) {
  if(!currentUser) return false;
  return userPerms(currentUser)[perm] === true;
}

let activityLog = JSON.parse(localStorage.getItem('dashActivityLog') || '[]');
// Migrate old log entries: ensure they all have a type field
activityLog = activityLog.map(e => ({ ...e, type: e.type || 'event' })); // ensure type field exists
let notifUnread = new Set(JSON.parse(localStorage.getItem('dashNotifUnread') || '[]'));
let notifCurrentTab = 'event';  // matches stored entry type: 'event' | 'note'
let currentAssignRow = null;
let currentBookRow = null;
let currentEditRow = null;
let currentCancelRow = null;
let currentProfileRow = null;
// Provisional dates: { [rowNum]: { date:'YYYY-MM-DD', trainer:'Name', company:'Name' } }
let provisionalDates = JSON.parse(localStorage.getItem('provisionalDates') || '{}');
let sortCol = null, sortDir = 1;
let upcomingPage = 1, completedPage = 1;
const PAGE_SIZE = 15;
let revenueChartInst = null, optionChartInst = null;
let calSettingsHolidayIcs = localStorage.getItem('calHolidayIcs') || HUMAANS_PUBLIC_HOLIDAYS_ICS;
let calSettingsLeaveIcs = localStorage.getItem('calLeaveIcs') || HUMAANS_LEAVE_ICS;
let currentReferralPerson = null;

// ===================== INIT =====================
window.addEventListener('DOMContentLoaded', () => {
  loadUsers();
  loadPermissions();
  loadDepartments();
  showLogin();
  loadBankHolidays();
  loadIcsData();
  renderActivityFeed();
  document.addEventListener('keydown', e => {
    if(e.key === 'Escape') {
      closeAllModals();
      closeNav();
      closeProfileSidebar();
    }
  });
});

// ---- CANONICAL USER LIST ----
const CANONICAL_USERS = [
  {id:'u1',  name:'Jack Cullen',        role:'viewer',  email:'jack.cullen@agentsoftware.net',        jobTitle:'Onboarding Specialist',    color:'#2147f4'},
  {id:'u2',  name:'Emma Cockcroft',     role:'viewer',  email:'emma.cockcroft@agentsoftware.net',     jobTitle:'Onboarding Specialist',    color:'#e53935'},
  {id:'u3',  name:'Sam Howat',          role:'viewer',  email:'sam.howat@agentsoftware.net',          jobTitle:'Onboarding Specialist',    color:'#22a06b'},
  {id:'u4',  name:'Liam Sorah',         role:'viewer',  email:'liam.sorah@agentsoftware.net',         jobTitle:'Onboarding Specialist',    color:'#f59e0b'},
  {id:'u5',  name:'Max Hornby',         role:'trainer', email:'max.hornby@agentsoftware.net',         jobTitle:'Product Trainer',          color:'#9c27b0'},
  {id:'u6',  name:'Saskia Kirkham',     role:'viewer',  email:'saskia.kirkham@agentsoftware.net',     jobTitle:'Onboarding Specialist',    color:'#00bcd4'},
  {id:'u7',  name:'Matt Hinawski',      role:'viewer',  email:'matthew.hinawski@agentsoftware.net',   jobTitle:'Onboarding Admin',         color:'#ff7043'},
  {id:'u8',  name:'Tracy Kettle',       role:'viewer',  email:'tracy.kettle@agentsoftware.net',       jobTitle:'Onboarding Specialist',    color:'#3f51b5'},
  {id:'u9',  name:'Lucie de Lison',     role:'viewer',  email:'lucie.delison@agentsoftware.net',      jobTitle:'Onboarding Specialist',    color:'#8bc34a'},
  {id:'u10', name:'Karolina Pawlowicz', role:'viewer',  email:'karolina.pawlowicz@agentsoftware.net', jobTitle:'Onboarding Specialist',    color:'#e91e63'},
  {id:'u11', name:'Amy Dawber',         role:'admin',   email:'amy.dawber@agentsoftware.net',         jobTitle:'Product Trainer',          color:'#f44336'},
  {id:'u12', name:'Rob Kenyon',         role:'viewer',  email:'rob.kenyon@agentsoftware.net',         jobTitle:'Head of Street Onboarding',color:'#607d8b'},
  {id:'u13', name:'Amy Lea',            role:'viewer',  email:'amy.lea@agentsoftware.net',            jobTitle:'Onboarding Specialist',    color:'#009688'},
  {id:'u14', name:'Stella Nicol',       role:'viewer',  email:'stella@agentsoftware.net',             jobTitle:'Head of Client Onboarding',color:'#795548'},
];

//  User/Department/Permission state 
let departments = [];  // loaded from Departments sheet

function loadUsers() {
  // Step 1: Populate immediately from cache or CANONICAL_USERS so the login
  // dropdown is never empty while any network request is in flight.
  const cached = JSON.parse(localStorage.getItem('dashUsersCache') || 'null');
  if (cached && cached.length) {
    trainers = cached;
  } else {
    const overrides = JSON.parse(localStorage.getItem('dashUserOverrides') || '{}');
    trainers = CANONICAL_USERS.map(u => Object.assign({}, u, { pin: '', icsUrl: '' }, overrides[u.id] || {}));
    const extra = JSON.parse(localStorage.getItem('dashExtraUsers') || '[]');
    trainers = trainers.concat(extra);
  }
  populateLoginSelect();

  // Step 2: Refresh from the sheet in the background. If we get live data,
  // update the dropdown immediately (deactivated users will be excluded).
  fetch(SCRIPT_URL + '?action=getUsers&t=' + Date.now(), { method:'GET', redirect:'follow' })
    .then(function(r) { return r.json(); })
    .then(function(json) {
      if (!json.success || !json.users || !json.users.length) return;
      const localPrefs = JSON.parse(localStorage.getItem('dashUserPrefs') || '{}');
      trainers = json.users.map(function(u) {
        return Object.assign({}, u, localPrefs[u.id] || {});
      });
      localStorage.setItem('dashUsersCache', JSON.stringify(trainers));
      populateLoginSelect();
    })
    .catch(function(e) { console.warn('getUsers background fetch failed:', e.message); });
}

// Save a single user back to the sheet (and keep local cache in sync)
async function saveUsers() {
  // Always persist to localStorage immediately so UI stays consistent
  localStorage.setItem('dashUsersCache', JSON.stringify(trainers));

  // Persist each changed user to the sheet
  const saves = trainers.map(u => {
    const [fn, ...rest] = (u.name || '').split(' ');
    const ln = rest.join(' ');
    const cp = (u.customPerms && Object.keys(u.customPerms).length)
      ? JSON.stringify(u.customPerms) : '';
    const params = new URLSearchParams({
      action: 'saveUser',
      userId: u.id || '',
      firstName: u.firstName || fn || u.name || '',
      lastName:  u.lastName  || ln || '',
      department: u.department || u.jobTitle || '',
      role: u.role || 'viewer',
      active: u.active === false ? 'false' : 'true',
      addedBy: currentUser?.name || '',
      notes: u.notes || '',
      customPerms: cp,
      color: u.color || '',
      pin:   u.pin   || '',
      email: u.email || '',
    });
    return fetch(SCRIPT_URL + '?' + params.toString(), { method:'GET', redirect:'follow' })
      .catch(e => console.warn('saveUser failed for', u.id, e.message));
  });
  await Promise.allSettled(saves);
}

// Remove a user from the sheet (soft-delete: Active = FALSE)
async function deleteUserFromSheet(userId) {
  try {
    await fetch(SCRIPT_URL + '?action=removeUser&userId=' + encodeURIComponent(userId), { method:'GET', redirect:'follow' });
  } catch(e) { console.warn('removeUser failed:', e.message); }
}

// Load role permission matrix from the sheet and merge into ROLE_DEFAULTS
async function loadPermissions() {
  const ALL_ROLES = ['admin', 'manager', 'trainer', 'viewer'];
  try {
    const res  = await fetch(SCRIPT_URL + '?action=getPermissions&t=' + Date.now(), { method:'GET', redirect:'follow' });
    const json = await res.json();
    if (json.success && json.permissions) {
      // Sheet is source of truth  merge into ROLE_DEFAULTS
      ALL_ROLES.forEach(role => {
        if (json.permissions[role]) {
          Object.assign(ROLE_DEFAULTS[role], json.permissions[role]);
        }
      });
      localStorage.setItem('dashPermCache', JSON.stringify(json.permissions));
      console.log('Permissions loaded from sheet');
    }
  } catch(e) {
    // Fall back to cached permissions if sheet is unreachable
    const cached = JSON.parse(localStorage.getItem('dashPermCache') || 'null');
    if (cached) {
      ALL_ROLES.forEach(role => {
        if (cached[role]) Object.assign(ROLE_DEFAULTS[role], cached[role]);
      });
      console.warn('getPermissions failed  using cache:', e.message);
    }
  }
}

// Load departments for use in the request form dropdown
async function loadDepartments() {
  try {
    const res  = await fetch(SCRIPT_URL + '?action=getDepartments&t=' + Date.now(), { method:'GET', redirect:'follow' });
    const json = await res.json();
    if (json.success && json.departments) {
      departments = json.departments;
      localStorage.setItem('dashDeptCache', JSON.stringify(departments));
      _populateDeptDropdowns();
      return;
    }
  } catch(e) { console.warn('getDepartments failed  using cache', e.message); }
  const cached = JSON.parse(localStorage.getItem('dashDeptCache') || 'null');
  if (cached) { departments = cached; _populateDeptDropdowns(); }
}

function _populateDeptDropdowns() {
  // IDs of every department <select> on the page
  const selIds = ['reqNewDept', 'reqReferredByTeam', 'permUserDept'];
  selIds.forEach(id => {
    const sel = document.getElementById(id);
    if (!sel || sel.tagName !== 'SELECT') return;
    // Remember current value so we can restore it after repopulating
    const prev = sel.value;
    sel.innerHTML = '<option value=""> Select department </option>';
    departments.forEach(d => {
      sel.innerHTML += `<option value="${escHtml(d.name)}">${escHtml(d.name)}</option>`;
    });
    sel.innerHTML += '<option value="__add__" style="color:var(--action-primary-blue);font-weight:600;">+ Add department...</option>';
    if (prev && prev !== '__add__') sel.value = prev;
    // Attach change listener to catch "+ Add" selection
    sel.onchange = function() {
      if (this.value === '__add__') {
        this.value = prev || '';
        openAddDeptModal(id);
      }
    };
  });
}

//  Add Department modal 
function openAddDeptModal(returnSelectId) {
  // Store which select to return focus to after adding
  window._addDeptReturnSelect = returnSelectId;
  let overlay = document.getElementById('addDeptOverlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'addDeptOverlay';
    overlay.className = 'modal-overlay';
    overlay.style.zIndex = '900';
    overlay.innerHTML = `
      <div class="modal" style="max-width:400px;">
        <div class="modal-header">
          <div><div class="modal-title">Add Department</div>
          <div class="modal-subtitle">New departments are saved to the sheet immediately</div></div>
          <button class="modal-close" onclick="closeAddDeptModal()">&#10005;</button>
        </div>
        <div class="modal-body">
          <div class="form-row">
            <label class="form-label required">Department Name</label>
            <input type="text" class="form-input" id="addDeptName" placeholder="e.g. Operations"
              onkeydown="if(event.key==='Enter')confirmAddDept()">
            <div class="form-hint" id="addDeptHint"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-ghost" onclick="closeAddDeptModal()">Cancel</button>
          <button class="btn btn-primary" onclick="confirmAddDept()">+ Add Department</button>
        </div>
      </div>`;
    overlay.onclick = function(e) { if(e.target === overlay) closeAddDeptModal(); };
    document.body.appendChild(overlay);
  }
  document.getElementById('addDeptName').value = '';
  document.getElementById('addDeptHint').textContent = '';
  overlay.classList.add('open');
  setTimeout(() => document.getElementById('addDeptName').focus(), 100);
}

function closeAddDeptModal() {
  const overlay = document.getElementById('addDeptOverlay');
  if (overlay) overlay.classList.remove('open');
}

async function confirmAddDept() {
  const name = document.getElementById('addDeptName').value.trim();
  const hint = document.getElementById('addDeptHint');
  if (!name) { hint.textContent = 'Please enter a department name.'; hint.style.color = '#c0303d'; return; }

  // Duplicate check client-side first
  if (departments.some(d => d.name.toLowerCase() === name.toLowerCase())) {
    hint.textContent = '"' + name + '" already exists.';
    hint.style.color = '#c0303d';
    return;
  }

  hint.textContent = 'Saving...';
  hint.style.color = 'var(--text--dark--30)';

  try {
    const res  = await fetch(SCRIPT_URL + '?action=addDepartment&name=' + encodeURIComponent(name), { method:'GET', redirect:'follow' });
    const json = await res.json();
    if (!json.success) throw new Error(json.error || 'Unknown error');
    departments.push({ name });
    localStorage.setItem('dashDeptCache', JSON.stringify(departments));
    _populateDeptDropdowns();
    // Set the value in the originating select
    const returnSel = document.getElementById(window._addDeptReturnSelect || 'reqNewDept');
    if (returnSel) returnSel.value = name;
    closeAddDeptModal();
    showToast('"' + name + '" added to Departments', 'success');
  } catch(e) {
    hint.textContent = 'Error: ' + e.message;
    hint.style.color = '#c0303d';
  }
}

function populateLoginSelect() {
  const sel = document.getElementById('loginUserSelect');
  sel.innerHTML = '<option value=""> Choose account </option>';
  trainers
    .filter(u => u.active !== false)   // only active users can log in
    .forEach(u => {
      const label = u.jobTitle ? `${u.name}  ${u.jobTitle}` : `${u.name} (${u.role})`;
      sel.innerHTML += `<option value="${u.id}">${label}</option>`;
    });
}

// ===================== LOGIN / AUTH =====================
// ===================== LOGIN  SEARCH + PIN =====================
let loginSelectedUserId = null;   // user chosen in step 1
let pinBuffer = '';                // digits entered on PIN pad
let pinMode   = 'verify';         // 'verify' | 'set' | 'confirm'
let pinFirst  = '';                // stores first entry during set flow

function showLogin() {
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('mainHeader').style.display = 'none';
  document.getElementById('mainContent').style.display = 'none';
  _showLoginStep1();
}

function _showLoginStep1() {
  document.getElementById('loginStep1').style.display = 'block';
  document.getElementById('loginStep2').style.display = 'none';
  document.getElementById('loginSearchInput').value = '';
  document.getElementById('loginSearchResults').style.display = 'none';
  document.getElementById('loginSearchError').style.display = 'none';
  document.getElementById('loginSelectedUser').style.display = 'none';
  document.getElementById('loginNextBtn').style.display = 'none';
  loginSelectedUserId = null;
  setTimeout(() => document.getElementById('loginSearchInput').focus(), 120);
}

function loginSearchFilter() {
  const q = document.getElementById('loginSearchInput').value.trim().toLowerCase();
  const results = document.getElementById('loginSearchResults');
  const errEl   = document.getElementById('loginSearchError');
  errEl.style.display = 'none';

  if(q.length < 1) { results.style.display = 'none'; return; }

  const matches = trainers
    .filter(u => u.active !== false && u.name.toLowerCase().includes(q))
    .slice(0, 8);

  if(!matches.length) {
    results.style.display = 'none';
    errEl.style.display = 'block';
    return;
  }

  results.innerHTML = matches.map((u, i) => {
    const initials = u.name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0,2);
    return `<div class="login-result-row" data-id="${u.id}" tabindex="0"
      style="display:flex;align-items:center;gap:10px;padding:9px 12px;cursor:pointer;border-radius:6px;"
      onmousedown="loginSelectUser('${u.id}')"
      onkeydown="if(event.key==='Enter')loginSelectUser('${u.id}')">
      <div style="width:28px;height:28px;border-radius:50%;background:${u.color||'#2147f4'};display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;flex-shrink:0;">${initials}</div>
      <div>
        <div style="font-size:13px;font-weight:600;color:var(--text--dark--50);">${escHtml(u.name)}</div>
        <div style="font-size:11px;color:var(--text--dark--30);">${escHtml(u.department||u.jobTitle||u.role)}</div>
      </div>
    </div>`;
  }).join('');
  results.style.display = 'block';
}

// Keyboard nav on the search input
function loginSearchKey(e) {
  const results = document.getElementById('loginSearchResults');
  const rows = results.querySelectorAll('.login-result-row');
  if(e.key === 'ArrowDown' && rows.length) { e.preventDefault(); rows[0].focus(); }
  if(e.key === 'Enter' && rows.length === 1) loginSelectUser(rows[0].dataset.id);
  if(e.key === 'Escape') { results.style.display = 'none'; }
}

function loginSelectUser(uid) {
  const u = trainers.find(t => t.id === uid);
  if(!u) return;
  loginSelectedUserId = uid;

  // Hide dropdown, show chip
  document.getElementById('loginSearchResults').style.display = 'none';
  document.getElementById('loginSearchInput').value = u.name;

  const chip    = document.getElementById('loginSelectedUser');
  const avatar  = document.getElementById('loginSelectedAvatar');
  const nameEl  = document.getElementById('loginSelectedName');
  const roleEl  = document.getElementById('loginSelectedRole');
  const initials = u.name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
  avatar.textContent   = initials;
  avatar.style.background = u.color || '#2147f4';
  nameEl.textContent   = u.name;
  roleEl.textContent   = (u.department||u.jobTitle||'') + (u.role ? '  ' + u.role : '');
  chip.style.display   = 'flex';
  document.getElementById('loginNextBtn').style.display = 'block';
}

function loginClearUser() {
  loginSelectedUserId = null;
  document.getElementById('loginSelectedUser').style.display = 'none';
  document.getElementById('loginNextBtn').style.display = 'none';
  document.getElementById('loginSearchInput').value = '';
  document.getElementById('loginSearchInput').focus();
}

function loginNext() {
  if(!loginSelectedUserId) return;
  const u = trainers.find(t => t.id === loginSelectedUserId);
  if(!u) return;

  // Populate step 2 identity
  const initials = u.name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
  document.getElementById('pinAvatar').textContent     = initials;
  document.getElementById('pinAvatar').style.background = u.color || '#2147f4';
  document.getElementById('pinName').textContent       = u.name;
  document.getElementById('loginStep1').style.display  = 'none';
  document.getElementById('loginStep2').style.display  = 'block';

  pinBuffer = '';
  pinFirst  = '';

  if(u.pin) {
    // PIN already set  verify it
    pinMode = 'verify';
    document.getElementById('pinSubtitle').textContent = 'Enter your PIN';
  } else {
    // No PIN set yet  first sign-in, ask them to create one
    pinMode = 'set';
    document.getElementById('pinSubtitle').textContent = 'Create a 4-digit PIN';
  }

  document.getElementById('pinError').textContent = '';
  renderPinDots();
}

function loginBackToSearch() {
  document.getElementById('loginStep2').style.display = 'none';
  _showLoginStep1();
}

function pinPadPress(digit) {
  if(pinBuffer.length >= 4) return;
  pinBuffer += digit;
  renderPinDots();
  if(pinBuffer.length === 4) {
    setTimeout(_pinSubmit, 180); // tiny delay so last dot animates
  }
}

function pinPadBackspace() {
  if(!pinBuffer.length) return;
  pinBuffer = pinBuffer.slice(0, -1);
  renderPinDots();
}

function renderPinDots() {
  for(let i = 0; i < 4; i++) {
    const d = document.getElementById('pd' + i);
    if(!d) continue;
    d.classList.toggle('filled', i < pinBuffer.length);
    d.classList.remove('error');
  }
}

function _pinError(msg) {
  for(let i=0;i<4;i++){const d=document.getElementById('pd'+i);if(d)d.classList.add('error');}
  document.getElementById('pinError').textContent = msg;
  pinBuffer = '';
  setTimeout(renderPinDots, 600);
}

function _pinSubmit() {
  const u = trainers.find(t => t.id === loginSelectedUserId);
  if(!u) return;

  if(pinMode === 'verify') {
    if(pinBuffer === String(u.pin)) {
      _loginSuccess(u);
    } else {
      _pinError('Incorrect PIN. Try again.');
    }

  } else if(pinMode === 'set') {
    // Store first entry, ask to confirm
    pinFirst = pinBuffer;
    pinBuffer = '';
    pinMode = 'confirm';
    document.getElementById('pinSubtitle').textContent = 'Confirm your PIN';
    document.getElementById('pinError').textContent = '';
    renderPinDots();

  } else if(pinMode === 'confirm') {
    if(pinBuffer === pinFirst) {
      // Save PIN to user object + sheet
      u.pin = pinBuffer;
      _savePinToSheet(u);
      _loginSuccess(u);
    } else {
      pinFirst = '';
      pinMode = 'set';
      _pinError("PINs didn't match. Let's try again.");
      document.getElementById('pinSubtitle').textContent = 'Create a 4-digit PIN';
    }
  }
}

async function _savePinToSheet(u) {
  try {
    const [fn, ...rest] = (u.name||'').split(' ');
    const params = new URLSearchParams({
      action:     'saveUser',
      userId:     u.id,
      firstName:  u.firstName || fn,
      lastName:   u.lastName  || rest.join(' '),
      department: u.department || u.jobTitle || '',
      role:       u.role || 'viewer',
      active:     'true',
      pin:        u.pin,
      color:      u.color || '',
      email:      u.email || '',
      customPerms: (u.customPerms && Object.keys(u.customPerms).length) ? JSON.stringify(u.customPerms) : '',
      addedBy:    'Self (first sign-in)',
    });
    await fetch(SCRIPT_URL + '?' + params.toString(), { method:'GET', redirect:'follow' });
    localStorage.setItem('dashUsersCache', JSON.stringify(trainers));
  } catch(e) { console.warn('PIN save failed:', e.message); }
}

function _loginSuccess(u) {
  currentUser = u;
  enterDashboard();
}

// legacy stubs
function loginDirect() {
  const uid = loginSelectedUserId || document.getElementById('loginUserSelect')?.value;
  const u = trainers.find(t => t.id === uid);
  if(u) { currentUser = u; enterDashboard(); }
}
function loginStepPin() { loginNext(); }
function loginBack()    { loginBackToSearch(); }
function loginConfirmPin() {}


function enterDashboard() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('mainHeader').style.display = 'flex';
  document.getElementById('mainContent').style.display = 'block';
  document.getElementById('headerAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
  document.getElementById('headerAvatar').style.background = currentUser.color || '#2147f4';
  document.getElementById('headerUserName').textContent = currentUser.name;
  document.getElementById('adminBadge').style.display = currentUser.role === 'admin' ? 'inline-flex' : 'none';
  document.querySelectorAll('.admin-only').forEach(el => el.style.display = currentUser.role === 'admin' ? '' : 'none');
  applyPermVisibility();
  updateCalTrainerFilter();
  loadData();
  setInterval(loadData, 5 * 60 * 1000);
  writeActivityLog({
    actionType: 'Login',
    description: currentUser.name + ' logged in',
    module: 'Dashboard',
    recordType: 'User',
    recordId: currentUser.id,
    after: 'Logged in',
    reason: 'Manual',
    source: 'Dashboard',
  });
}

function logout() {
  currentUser = null;
  showLogin();
}

function startShadow() {
  if(!selectedPermUserId) return;
  const target = trainers.find(u => u.id === selectedPermUserId);
  if(!target) return;
  closePermModal();
  const realUser = currentUser;
  currentUser = target;
  document.getElementById('shadowBanner').style.display = 'inline-flex';
  document.getElementById('shadowBanner').textContent = ' Shadowing ' + target.name + '  Exit Shadow';
  // Re-apply view for shadowed user
  document.getElementById('headerAvatar').textContent = target.name.charAt(0).toUpperCase();
  document.getElementById('headerAvatar').style.background = target.color || '#2147f4';
  document.getElementById('headerUserName').textContent = target.name;
  document.getElementById('adminBadge').style.display = target.role === 'admin' ? 'inline-flex' : 'none';
  document.querySelectorAll('.admin-only').forEach(el => el.style.display = target.role === 'admin' ? '' : 'none');
  applyPermVisibility();
  // Store real user for exit
  window._shadowRealUser = realUser;
  renderAll();
  showToast('Shadowing ' + target.name, 'info');
}

function exitShadow() {
  if(window._shadowRealUser) {
    currentUser = window._shadowRealUser;
    window._shadowRealUser = null;
  }
  document.getElementById('shadowBanner').style.display = 'none';
  document.getElementById('headerAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
  document.getElementById('headerAvatar').style.background = currentUser.color || '#2147f4';
  document.getElementById('headerUserName').textContent = currentUser.name;
  document.getElementById('adminBadge').style.display = currentUser.role === 'admin' ? 'inline-flex' : 'none';
  document.querySelectorAll('.admin-only').forEach(el => el.style.display = currentUser.role === 'admin' ? '' : 'none');
  applyPermVisibility();
  renderAll();
  showToast('Exited shadow mode', 'info');
}

// Apply section/widget visibility based on current user permissions
function applyPermVisibility() {
  const p = canDo;
  const sectionMap = {
    kpiSection:                p('viewKpis'),
    calendarSection:           p('viewCalendar'),
    unassignedSection:         p('viewUnassigned'),
    actionSection:             p('viewPending'),
    allBookingsSection:        p('viewAllBookings'),
    referralLeaderboardSection:p('viewReferrals'),
    trainerWorkloadSection:    p('viewTrainerWorkload'),
  };
  Object.entries(sectionMap).forEach(([id, show]) => {
    const el = document.getElementById(id);
    if(el) el.style.display = show ? '' : 'none';
  });
  // Bell/notifications
  const bellBtn = document.getElementById('bellBtn');
  if(bellBtn) bellBtn.style.display = p('viewActivityFeed') ? '' : 'none';
  // Request training button
  const reqBtn = document.querySelector('.req-training-btn');
  if(reqBtn) reqBtn.style.display = p('requestTraining') ? '' : 'none';
  // Admin-only elements
  document.querySelectorAll('.admin-only').forEach(el => el.style.display = currentUser.role === 'admin' ? '' : 'none');
}

// renderAll defined below

// ===================== NAV =====================
function toggleNav() {
  const open = document.getElementById('navDrawer').classList.toggle('open');
  document.getElementById('navOverlay').classList.toggle('open', open);
  document.getElementById('hamburgerBtn').classList.toggle('open', open);
}
function closeNav() {
  document.getElementById('navDrawer').classList.remove('open');
  document.getElementById('navOverlay').classList.remove('open');
  document.getElementById('hamburgerBtn').classList.remove('open');
}

// ===================== DATA LOADING =====================
async function loadData() {
  const bar = document.getElementById('loadingBar');
  bar.style.display = 'block';
  bar.classList.add('active');
  // Flush any notes that failed to save last time
  flushNoteQueue();
  try {
    const res = await fetch(SCRIPT_URL + '?action=getData&t=' + Date.now(), {
      method: 'GET',
      redirect: 'follow'
    });
    if(!res.ok) throw new Error('HTTP ' + res.status + ' ' + res.statusText);
    const json = await res.json();
    if(!json.success) {
      showToast('Apps Script error: ' + (json.error || 'Unknown error'), 'error');
      console.error('Apps Script error:', json);
      return;
    }
    const rawRows = json.data || [];
    allData = rawRows.slice(1).map((row, i) => parseAppsScriptData(row, i, i + 2)).filter(Boolean);
    const now = new Date();
    document.getElementById('lastUpdated').textContent = 'Updated ' + now.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
    // Load persisted notes and attach to records before rendering
    await loadNotes();
    renderAll();
    console.log('Loaded', allData.length, 'data rows.');
  } catch(e) {
    console.error('loadData error:', e);
    showToast('Could not load data: ' + e.message, 'error');
  } finally {
    bar.style.display = 'none';
    bar.classList.remove('active');
  }
}

const COL = {
  STATUS:0, TIMESTAMP:1, EMAIL:2, CONTACT:3, PREFERRED_DATE:4, OPTION:5,
  AREAS:6, FEATURES:7, ATTENDEES:8, LOCATION:9, PARKING:10, VENUE_SETUP:11,
  SCORE:12, COMPANY:13, TEAM_FAMILIARITY:14, PRIORITIES:15, FOLLOW_UP:16,
  ANYTHING_ELSE:17, GO_LIVE_DATE:18, REFERRED_BY:19,
  INVOICE_VALUE:20, TRAINER:21, BOOKED_DATE:22, TRAINING_DAYS:23
};

function parseAppsScriptData(row, arrayIdx, sheetRowNum) {
  if(!row || row.length === 0) return null;
  const status = (row[COL.STATUS] || '').trim();
  if(!status) return null;
  const ts = row[COL.TIMESTAMP] ? new Date(row[COL.TIMESTAMP]) : null;
  const rawPref = row[COL.PREFERRED_DATE] ? String(row[COL.PREFERRED_DATE]).trim() : '';
  let preferredDate = '';
  if(rawPref && rawPref !== '' && rawPref !== '--') {
    const d = new Date(rawPref);
    preferredDate = isNaN(d.getTime()) ? rawPref : d.toISOString().split('T')[0];
  }
  const rawInvoice = row[COL.INVOICE_VALUE] ? String(row[COL.INVOICE_VALUE]).replace(/[$,\s]/g,'') : '';
  const invoiceValue = rawInvoice ? parseFloat(rawInvoice) : null;
  const bookedOn = row[COL.BOOKED_DATE] ? new Date(row[COL.BOOKED_DATE]) : null;
  return {
    _idx:           arrayIdx,
    _rowNum:        sheetRowNum,
    status, ts,
    email:          row[COL.EMAIL]            || '',
    contact:        row[COL.CONTACT]          || '',
    company:        row[COL.COMPANY]          || '',
    preferredDate,
    trainingOption: row[COL.OPTION]           || '',
    areas:          row[COL.AREAS]            || '',
    features:       row[COL.FEATURES]         || '',
    attendeesRaw:   row[COL.ATTENDEES]        || '',
    locationRaw:    row[COL.LOCATION]         || '',
    parking:        row[COL.PARKING]          || '',
    venueSetup:     row[COL.VENUE_SETUP]      || '',
    teamFamiliarity:row[COL.TEAM_FAMILIARITY] || '',
    priorities:     row[COL.PRIORITIES]       || '',
    followUp:       row[COL.FOLLOW_UP]        || '',
    anythingElse:   row[COL.ANYTHING_ELSE]    || '',
    goLiveDate:     row[COL.GO_LIVE_DATE]     || '',
    referredBy:     parseReferredByField(row[COL.REFERRED_BY] || ''),
    invoiceValue,
    trainer:        row[COL.TRAINER]          || '',
    bookedOn,
    trainingDays:   row[COL.TRAINING_DAYS] ? parseInt(row[COL.TRAINING_DAYS]) || 1 : 1,
    notes:          [],   // populated by loadNotes() after fetch
    rawRow: row
  };
}

function tryParseNotes(val) {
  if(!val) return [];
  try { return JSON.parse(val); } catch(e) { return []; }
}

/**
 * loadNotes()
 * Fetches all rows from the "Progress Notes" sheet and attaches them
 * to the matching records in allData by sheet row number (rowRef).
 * Called automatically after loadData() rebuilds allData.
 */
async function loadNotes() {
  try {
    const res  = await fetch(SCRIPT_URL + '?action=getNotes&t=' + Date.now(), { method:'GET', redirect:'follow' });
    const json = await res.json();
    if(!json.success || !json.notes) return;
    // json.notes is { "75": [{text,author,ts,...}], "82": [...] }
    Object.entries(json.notes).forEach(([rowRef, notes]) => {
      const record = allData.find(r => String(r._rowNum) === String(rowRef));
      if(record) {
        // Normalise ts to milliseconds for consistent sorting with locally-added notes
        record.notes = notes.map(n => ({
          text:   n.text,
          author: n.author,
          role:   n.role,
          ts:     n.ts,  // stored as "dd/mm/yyyy, hh:mm:ss" string  keep as-is for display
        }));
      }
    });
  } catch(e) {
    console.warn('loadNotes failed:', e.message);
  }
}

function parseReferredByField(raw) {
  if(!raw || !raw.trim()) return null;
  const str = raw.trim();
  const m = str.match(/^(.+?)\s*\((.+?)\)(?:\s*[-]\s*(.*))?$/);
  if(m) return { name: m[1].trim(), team: m[2].trim(), notes: (m[3] || '').trim() };
  return { name: str, team: '', notes: '' };
}

// ===================== BANK HOLIDAYS =====================
// England & Wales bank holidays 2024-2027  used as fallback if the API is unreachable.
// Source: https://www.gov.uk/bank-holidays
const FALLBACK_BANK_HOLIDAYS = [
  // 2024
  '2024-01-01','2024-03-29','2024-04-01','2024-05-06','2024-05-27',
  '2024-08-26','2024-12-25','2024-12-26',
  // 2025
  '2025-01-01','2025-04-18','2025-04-21','2025-05-05','2025-05-26',
  '2025-08-25','2025-12-25','2025-12-26',
  // 2026
  '2026-01-01','2026-04-03','2026-04-06','2026-05-04','2026-05-25',
  '2026-08-31','2026-12-25','2026-12-28',
  // 2027
  '2027-01-01','2027-03-26','2027-03-29','2027-05-03','2027-05-31',
  '2027-08-30','2027-12-27','2027-12-28',
];

async function loadBankHolidays() {
  // Start with the hardcoded list so the calendar is never empty
  bankHolidays = [...FALLBACK_BANK_HOLIDAYS];
  try {
    const r = await fetch(UK_BANK_HOLIDAYS_API);
    const d = await r.json();
    const live = (d['england-wales']?.events || []).map(e => e.date);
    if (live.length) {
      // Merge: use live data as the authoritative set (covers future years too)
      bankHolidays = [...new Set([...FALLBACK_BANK_HOLIDAYS, ...live])];
    }
  } catch(e) {
    // Network unavailable  fallback list already set above, no action needed
  }
}

function isBankHoliday(date) {
  const s = date.toISOString().split('T')[0];
  return bankHolidays.includes(s);
}

function isWorkingDay(date) {
  const dow = date.getDay();
  return dow !== 0 && dow !== 6 && !isBankHoliday(date);
}

// Returns array of skipped section names for a row (from comma-separated string)
function getSkippedSections(r) {
  if(!r.skippedSections) return [];
  return r.skippedSections.split(',').map(s => s.trim()).filter(Boolean);
}

function skippedFlagHtml(r) {
  const skipped = getSkippedSections(r);
  if(!skipped.length) return '';
  return skipped.map(s =>
    `<span style="display:inline-flex;align-items:center;gap:3px;font-size:10px;font-weight:700;padding:2px 7px;border-radius:8px;background:#fef3c7;color:#92400e;border:1px solid #fde68a;" title="Trainer must complete before booking"> ${s}</span>`
  ).join(' ');
}

function addWorkingDays(fromDate, n) {
  const d = new Date(fromDate);
  let count = 0;
  while(count < n) {
    d.setDate(d.getDate() + 1);
    if(isWorkingDay(d)) count++;
  }
  return d;
}

// ===================== ICS / CALENDAR =====================

// CORS proxies tried in order until one works
const CORS_PROXIES = [
  url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
  url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
  url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
];

async function fetchIcs(url) {
  let lastErr = '';
  for(const proxy of CORS_PROXIES) {
    try {
      const res = await fetch(proxy(url), { cache: 'no-cache' });
      if(!res.ok) { lastErr = 'HTTP ' + res.status; continue; }
      const txt = await res.text();
      // Validate it looks like iCal data
      if(txt.includes('BEGIN:VCALENDAR') || txt.includes('BEGIN:VEVENT')) return txt;
      lastErr = 'Not valid iCal data';
    } catch(e) { lastErr = e.message; }
  }
  throw new Error('All proxies failed. Last error: ' + lastErr);
}

async function loadIcsData() {
  calIcsEvents   = [];
  calLeaveEvents = [];

  const holiday = calSettingsHolidayIcs;
  const leave   = calSettingsLeaveIcs;

  const [holResult, leaveResult] = await Promise.allSettled([
    holiday ? fetchIcs(holiday) : Promise.reject(new Error('No URL')),
    leave   ? fetchIcs(leave)   : Promise.reject(new Error('No URL')),
  ]);

  if(holResult.status === 'fulfilled')   calIcsEvents   = parseIcs(holResult.value,   'holiday');
  else if(holiday) console.warn('Holiday feed failed:', holResult.reason?.message);

  if(leaveResult.status === 'fulfilled') calLeaveEvents = parseIcs(leaveResult.value, 'leave');
  else if(leave)   console.warn('Leave feed failed:',   leaveResult.reason?.message);

  updateIcsStatusBar(
    holiday ? holResult   : null,
    leave   ? leaveResult : null,
  );
  if(allData.length) renderCalendar();
}

function parseIcs(text, type) {
  const events = [];
  // Unfold lines (RFC 5545: lines folded with CRLF + whitespace)
  const unfolded = text.replace(/\r?\n[ \t]/g, '');
  const blocks = unfolded.split(/BEGIN:VEVENT/);
  blocks.slice(1).forEach(block => {
    // Match DTSTART and DTEND regardless of VALUE=DATE or TZID params
    const getVal = key => {
      const m = block.match(new RegExp(key + '(?:;[^:]*)?:([^\\r\\n]+)'));
      return m ? m[1].trim() : '';
    };
    const summary  = getVal('SUMMARY');
    const dtstartRaw = getVal('DTSTART');
    const dtendRaw   = getVal('DTEND');
    if(!dtstartRaw) return;

    const parseD = s => {
      // Strip any non-numeric except T and Z
      const clean = s.replace(/[^0-9TZ]/g, '');
      if(clean.length === 8) {
        // All-day: YYYYMMDD
        return new Date(clean.slice(0,4) + '-' + clean.slice(4,6) + '-' + clean.slice(6,8) + 'T00:00:00');
      }
      // DateTime: 20260224T090000Z or 20260224T090000
      return new Date(
        clean.slice(0,4) + '-' + clean.slice(4,6) + '-' + clean.slice(6,8) + 'T' +
        clean.slice(9,11) + ':' + clean.slice(11,13) + ':' + (clean.slice(13,15)||'00') +
        (clean.endsWith('Z') ? 'Z' : '')
      );
    };

    const start = parseD(dtstartRaw);
    // DTEND for all-day events is exclusive (day after last day) per RFC 5545
    const end   = dtendRaw ? parseD(dtendRaw) : new Date(start.getTime() + 86400000);
    if(isNaN(start.getTime())) return;

    events.push({ summary, start, end, type });
  });
  return events;
}

//  Trainer leave helpers 

/**
 * Returns true if trainerName has a leave event covering the given date (YYYY-MM-DD string).
 */
function isTrainerOnLeave(trainerName, dateISO) {
  if(!trainerName || !calLeaveEvents.length) return false;
  const check = new Date(dateISO + 'T00:00:00');
  const nameLower = trainerName.trim().toLowerCase();
  return calLeaveEvents.some(ev => {
    if(!ev.summary) return false;
    if(!ev.summary.toLowerCase().includes(nameLower)) return false;
    const evStart = new Date(ev.start); evStart.setHours(0,0,0,0);
    const evEnd   = ev.end ? new Date(ev.end) : new Date(evStart.getTime() + 86400000);
    evEnd.setHours(0,0,0,0);
    return check >= evStart && check < evEnd;
  });
}

/**
 * Returns a Set of ISO date strings (YYYY-MM-DD) when trainerName is on leave.
 */
function getTrainerLeaveDates(trainerName) {
  const out = new Set();
  if(!trainerName || !calLeaveEvents.length) return out;
  const nameLower = trainerName.trim().toLowerCase();
  calLeaveEvents.forEach(ev => {
    if(!ev.summary || !ev.summary.toLowerCase().includes(nameLower)) return;
    const evStart = new Date(ev.start); evStart.setHours(0,0,0,0);
    const evEnd   = ev.end ? new Date(ev.end) : new Date(evStart.getTime() + 86400000);
    evEnd.setHours(0,0,0,0);
    for(let d = new Date(evStart); d < evEnd; d.setDate(d.getDate() + 1)) {
      out.add(d.toISOString().split('T')[0]);
    }
  });
  return out;
}

/** Returns true if the named user is a trainer or admin (i.e. has a training calendar). */
function isCalendarTrainer(name) {
  const t = trainers.find(u => u.name === name);
  return t && (t.role === 'trainer' || t.role === 'admin');
}

function updateIcsStatusBar(holResult, leaveResult) {
  const parts = [];

  if(holResult) {
    if(holResult.status === 'fulfilled' && calIcsEvents.length > 0) {
      parts.push(`<span class="ics-status"><span class="ics-dot ok"></span>${calIcsEvents.length} holidays loaded</span>`);
    } else {
      const msg = holResult.reason?.message || 'empty response';
      parts.push(`<span class="ics-status" title="${escHtml(msg)}"><span class="ics-dot error"></span>Holiday feed error</span>`);
    }
  }

  if(leaveResult) {
    if(leaveResult.status === 'fulfilled' && calLeaveEvents.length > 0) {
      parts.push(`<span class="ics-status"><span class="ics-dot ok"></span>${calLeaveEvents.length} leave events loaded</span>`);
    } else {
      const msg = leaveResult.reason?.message || 'empty response';
      parts.push(`<span class="ics-status" title="${escHtml(msg)}"><span class="ics-dot error"></span>Leave feed error  ${escHtml(msg)}</span>`);
    }
  }

  if(!holResult && !leaveResult) {
    parts.push(`<span class="ics-status"><span class="ics-dot"></span>No ICS feeds configured</span>`);
  }

  bar.innerHTML = parts.join('<span style="color:var(--text--dark--20);margin:0 4px;">|</span>');
}

// ===================== RENDER ALL =====================
function renderAll() {
  renderTrainerWorkload();
  renderUnassigned();
  renderActionNeeded();
  renderKpis();
  updateBellBadge();
  applyPermVisibility();
  renderReferralLeaderboard();
  renderUpcomingBookings();
  renderCompletedBookings();
  renderCalendar();
  populateFilterDropdowns();
}

function getFilteredData() {
  const search = (document.getElementById('bookingSearch')?.value || '').toLowerCase();
  const fStatus = document.getElementById('filterStatus')?.value || '';
  const fTrainer = document.getElementById('filterTrainer')?.value || '';
  const fOption = document.getElementById('filterOption')?.value || '';
  const fFrom = document.getElementById('filterDateFrom')?.value || '';
  const fTo = document.getElementById('filterDateTo')?.value || '';
  return allData.filter(r => {
    const company = getCompanyName(r);
    if(search && !company.toLowerCase().includes(search) && !r.contact.toLowerCase().includes(search)) return false;
    if(fStatus && r.status !== fStatus) return false;
    if(fTrainer && r.trainer !== fTrainer) return false;
    if(fOption && r.trainingOption !== fOption) return false;
    if(fFrom && r.bookedOn && r.bookedOn.toISOString().split('T')[0] < fFrom) return false;
    if(fTo && r.bookedOn && r.bookedOn.toISOString().split('T')[0] > fTo) return false;
    return true;
  });
}

function getCompanyName(r) {
  return r.company || r.contact || '(Unknown)';
}

function resetPageAndRender() {
  upcomingPage = 1; completedPage = 1;
  renderUpcomingBookings();
  renderCompletedBookings();
}

function clearBookingFilters() {
  ['bookingSearch','filterStatus','filterTrainer','filterOption','filterDateFrom','filterDateTo'].forEach(id => {
    const el = document.getElementById(id); if(el) el.value = '';
  });
  resetPageAndRender();
}

function populateFilterDropdowns() {
  const trainerSel = document.getElementById('filterTrainer');
  if(trainerSel) {
    const current = trainerSel.value;
    trainerSel.innerHTML = '<option value="">All Trainers</option>';
    const names = [...new Set(allData.map(r => r.trainer).filter(Boolean))].sort();
    names.forEach(n => trainerSel.innerHTML += `<option value="${n}">${n}</option>`);
    trainerSel.value = current;
  }
}

// ===================== COMPANY NAME / CELL =====================
function companyCell(r) {
  const name = getCompanyName(r);
  return `<span class="company-link" onclick='openProfileSidebar(${r._idx})'>${escHtml(name)}</span>`;
}

function escHtml(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function fmtDate(d) {
  if(!d) return '';
  const dt = d instanceof Date ? d : new Date(d);
  if(isNaN(dt.getTime())) return '';
  return dt.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});
}

function fmtMoney(v) {
  if(v === null || v === undefined || isNaN(v)) return '';
  return '' + Math.round(Number(v)).toLocaleString('en-GB',{minimumFractionDigits:0,maximumFractionDigits:0});
}

const TRAINING_OPTIONS = {
  'Personalised Onsite Training - 1 Day':             { short: '1-Day Onsite',   cls: 'opt-1' },
  'Personalised Onsite Training - 2 Days':            { short: '2-Day Onsite',   cls: 'opt-2' },
  'Lettings Accounting Training + Go-Live Support':   { short: 'Accounting',     cls: 'opt-3' },
  'Live Training at Street HQ (Manchester)':          { short: 'HQ Manchester',  cls: 'opt-4' },
  'Online Refresher':                                 { short: 'Online',         cls: 'opt-5' },
  'Not sure yet - please help me choose':             { short: 'Help me choose', cls: '' },
};

function optionBadge(opt) {
  const raw = (opt || '').trim();
  if(!raw) return `<span class="option-badge" style="background:#f3f4f6;color:#888;">N/A</span>`;
  // Exact match first
  if(TRAINING_OPTIONS[raw]) {
    const { short, cls } = TRAINING_OPTIONS[raw];
    return `<span class="option-badge ${cls}" title="${escHtml(raw)}">${escHtml(short)}</span>`;
  }
  // Legacy numeric (Option 15)  map to short label
  const n = raw.replace(/[^0-9]/g, '');
  const byIndex = Object.values(TRAINING_OPTIONS)[parseInt(n) - 1];
  if(n && byIndex) {
    return `<span class="option-badge opt-${n}" title="${escHtml(byIndex.short)}">${escHtml(byIndex.short)}</span>`;
  }
  // Fallback: show the raw value truncated
  const display = raw.length > 22 ? raw.slice(0, 20) + '' : raw;
  return `<span class="option-badge" style="background:#f3f4f6;color:#555;" title="${escHtml(raw)}">${escHtml(display)}</span>`;
}

function statusBadge(s) {
  const cls = {Unassigned:'status-unassigned',Pending:'status-pending',Booked:'status-booked',Cancelled:'status-cancelled'}[s] || '';
  return `<span class="status-badge ${cls}">${escHtml(s)}</span>`;
}

function trainerPill(name) {
  if(!name) return '<span style="color:var(--text--dark--20);font-size:11px;">Unassigned</span>';
  const t = trainers.find(u => u.name === name);
  const color = t ? t.color : '#888';
  return `<span class="trainer-pill" style="background:${color}22;color:${color};">${escHtml(name)}</span>`;
}

function staleBadge(r) {
  if(!r.ts) return '';
  const days = Math.floor((Date.now() - r.ts) / 86400000);
  if(days < STALE_DAYS) return '';
  return `<span class="stale-badge"> ${days}d</span>`;
}

// ===================== TRAINER WORKLOAD =====================
function renderTrainerWorkload() {
  const grid = document.getElementById('trainerGrid');
  const trainerUsers = trainers.filter(u => u.role === 'trainer' || u.role === 'admin');
  if(!trainerUsers.length) { grid.innerHTML = '<div style="padding:16px;color:var(--text--dark--30);">No trainers found.</div>'; return; }
  const today = new Date(); today.setHours(0,0,0,0);
  const y30 = new Date(today); y30.setDate(y30.getDate()-30);
  let html = '';
  trainerUsers.forEach((t, idx) => {
    const booked = allData.filter(r => r.trainer === t.name && r.status === 'Booked');
    const last30 = booked.filter(r => r.bookedOn && r.bookedOn >= y30 && r.bookedOn <= today);
    const upcoming = booked.filter(r => r.bookedOn && r.bookedOn > today);
    const daysLast30 = last30.reduce((s,r) => s + (r.trainingDays||1), 0);
    const maxLoad = 20;
    const pct = Math.min(100, Math.round((daysLast30/maxLoad)*100));
    const color = t.color || TRAINER_COLORS[idx % TRAINER_COLORS.length];
    const nextFree = getNextFreeDate(t.name);
    const nextFreeHtml = nextFree ? `<div class="next-free-tag">${nextFree}</div>` : `<div class="next-free-tag busy">No free slots in 90 days</div>`;
    html += `<div class="trainer-card">
      <div class="trainer-name"><div class="trainer-color-dot" style="background:${color};"></div>${escHtml(t.name)} <span class="status-badge" style="font-size:9px;padding:1px 5px;margin-left:auto;background:${color}22;color:${color};">${t.role}</span></div>
      <div class="trainer-stat"><span>Client Visits (Last 30 Days)</span><span class="trainer-stat-val">${last30.length}</span></div>
      <div class="trainer-stat"><span>Training Days in Total</span><span class="trainer-stat-val">${daysLast30}</span></div>
      <div class="trainer-stat"><span>Upcoming Client Visits</span><span class="trainer-stat-val">${upcoming.length}</span></div>
      <div class="workload-bar-wrap"><div class="workload-bar" style="width:${pct}%;background:${color};"></div></div>
      ${nextFreeHtml}
    </div>`;
  });
  grid.innerHTML = html;
}

// Returns the last working day strictly before `date`
function prevWorkingDay(date) {
  const d = new Date(date);
  do { d.setDate(d.getDate() - 1); } while (!isWorkingDay(d));
  return d;
}

// Returns the first working day strictly after `date`
function nextWorkingDay(date) {
  const d = new Date(date);
  do { d.setDate(d.getDate() + 1); } while (!isWorkingDay(d));
  return d;
}

function getNextFreeDate(trainerName) {
  const today = new Date(); today.setHours(0,0,0,0);
  const earliest = addWorkingDays(today, 14);
  const booked = allData.filter(r => r.trainer === trainerName && r.status === 'Booked' && r.bookedOn);
  const busyDates = new Set();

  booked.forEach(r => {
    const start = new Date(r.bookedOn); start.setHours(0,0,0,0);
    const days = r.trainingDays || 1;
    for (let i = 0; i < days; i++) {
      const d = new Date(start); d.setDate(d.getDate() + i);
      busyDates.add(d.toISOString().split('T')[0]);
    }
    const travel = prevWorkingDay(start);
    busyDates.add(travel.toISOString().split('T')[0]);
    const trainingEnd = new Date(start); trainingEnd.setDate(trainingEnd.getDate() + days - 1);
    const admin = nextWorkingDay(trainingEnd);
    busyDates.add(admin.toISOString().split('T')[0]);
  });

  // Also treat leave days as busy
  const leaveDates = getTrainerLeaveDates(trainerName);
  leaveDates.forEach(iso => busyDates.add(iso));

  for (let i = 0; i < 90; i++) {
    const d = new Date(earliest); d.setDate(d.getDate() + i);
    if (!isWorkingDay(d)) continue;
    if (!busyDates.has(d.toISOString().split('T')[0])) return 'Next free: ' + fmtDate(d);
  }
  return null;
}

// ===================== TRAINER SUGGESTION (round-robin by workload) =====================
// Returns the trainer object with the fewest upcoming booked training days.
// Ties are broken by the order trainers appear in the list (stable round-robin).
// Returns trainers sorted by ascending upcoming workload (fewest days first).
// Ties are broken by list order for stability.
function trainersByWorkload() {
  const today = new Date(); today.setHours(0,0,0,0);
  const eligible = trainers.filter(u => u.role === 'trainer' || u.role === 'admin');
  const load = {};
  eligible.forEach(t => { load[t.name] = 0; });
  allData.forEach(r => {
    if (r.status !== 'Booked' || !r.bookedOn || r.bookedOn < today) return;
    if (load[r.trainer] !== undefined) load[r.trainer] += (r.trainingDays || 1);
  });
  return [...eligible].sort((a, b) => load[a.name] - load[b.name]);
}

// Round-robin suggestion: position 0  lightest load, 1  second lightest, etc.
// Cycles back if there are more unassigned requests than trainers.
function suggestTrainer(position = 0) {
  const ranked = trainersByWorkload();
  if (!ranked.length) return null;
  return ranked[position % ranked.length];
}

// ===================== UNASSIGNED =====================
function renderUnassigned() {
  const rows = allData.filter(r => r.status === 'Unassigned');
  const badge = document.getElementById('unassignedBadge');
  const dot = document.getElementById('unassignedDot');
  badge.textContent = rows.length;
  dot.style.display = rows.length ? 'block' : 'none';
  const tbody = document.getElementById('unassignedBody');
  if(!rows.length) { tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon"></div><div class="empty-state-text">No unassigned requests</div></div></td></tr>'; return; }
  const today = new Date(); today.setHours(0,0,0,0);
  tbody.innerHTML = rows.map((r, rowPos) => {
    const suggested = suggestTrainer(rowPos);
    const pref = r.preferredDate ? fmtDate(new Date(r.preferredDate)) : '';
    const isStale = r.ts && (Date.now() - r.ts) >= STALE_DAYS*86400000;
    const suggColor = suggested ? (suggested.color || '#2147f4') : '#2147f4';
    const suggChip = suggested
      ? `<span style="display:inline-flex;align-items:center;gap:4px;font-size:11px;font-weight:600;padding:2px 8px;border-radius:10px;background:${suggColor}18;color:${suggColor};border:1px solid ${suggColor}33;"> ${escHtml(suggested.name)}</span>`
      : '';
    const skippedFlags = skippedFlagHtml(r);
    return `<tr class="${isStale?'row-stale':''}">
      <td>${fmtDate(r.ts)} ${staleBadge(r)}</td>
      <td>${companyCell(r)}</td>
      <td><span style="font-size:11px;">${escHtml(r.contact)}</span></td>
      <td>${optionBadge(r.trainingOption)}</td>
      <td>${pref}</td>
      <td>${skippedFlags ? skippedFlags : suggChip}</td>
      <td style="white-space:nowrap;display:flex;gap:6px;flex-wrap:wrap;">
        ${canDo('assignTrainer') ? `<button class="btn btn-primary btn-sm" onclick="openAssignModal(${r._idx})">Assign</button>` : ''}
        ${canDo('cancelBooking') ? `<button class="btn btn-danger btn-sm" onclick="openCancelModal(${r._idx})">Cancel</button>` : ''}
      </td>
    </tr>`;
  }).join('');
}

// ===================== ACTION NEEDED =====================
function renderActionNeeded() {
  const rows = allData.filter(r => r.status === 'Pending');
  const badge = document.getElementById('actionBadge');
  const dot = document.getElementById('actionDot');
  badge.textContent = rows.length;
  dot.style.display = rows.length ? 'block' : 'none';
  const tbody = document.getElementById('actionBody');
  if(!rows.length) { tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon"></div><div class="empty-state-text">No pending bookings</div></div></td></tr>'; return; }
  tbody.innerHTML = rows.map(r => {
    const pref = r.preferredDate ? fmtDate(new Date(r.preferredDate)) : '';
    return `<tr>
      <td>${fmtDate(r.ts)}</td>
      <td>${companyCell(r)}</td>
      <td><span style="font-size:11px;">${escHtml(r.contact)}</span></td>
      <td>${optionBadge(r.trainingOption)}</td>
      <td>${pref}</td>
      <td>${trainerPill(r.trainer)}</td>
      <td style="white-space:nowrap;display:flex;gap:6px;flex-wrap:wrap;">
        ${canDo('confirmBooking') ? `<button class="btn btn-success btn-sm" onclick="openBookModal(${r._idx})">Confirm Booking</button>` : ''}
        <button class="btn btn-ghost btn-sm" onclick="openProvisionalModal(${r._idx})" title="Set a provisional discussion date" style="border-color:#f59e0b;color:#92400e;"> ${provisionalDates[r._rowNum] ? '<span style="font-weight:700;">'+provisionalDates[r._rowNum].date+'</span>' : 'Provisional'}</button>
        ${canDo('cancelBooking') ? `<button class="btn btn-danger btn-sm" onclick="openCancelModal(${r._idx})">Cancel</button>` : ''}
      </td>
    </tr>`;
  }).join('');
}

// ===================== BOOKINGS TABLES =====================
function isUpcoming(r) {
  const today = new Date(); today.setHours(0,0,0,0);
  if(r.status === 'Cancelled') return false;
  if(r.status === 'Booked' && r.bookedOn && r.bookedOn < today) return false;
  return true;
}

function isCompleted(r) { return !isUpcoming(r); }

function bookingTableHead() {
  return `<th class="sortable" onclick="sortBookings('ts')">Submitted <span class="sort-icon"></span></th>
    <th class="sortable" onclick="sortBookings('company')">Company <span class="sort-icon"></span></th>
    <th>Contact</th>
    <th class="sortable" onclick="sortBookings('trainingOption')">Type <span class="sort-icon"></span></th>
    <th class="sortable" onclick="sortBookings('bookedOn')">Booked Date <span class="sort-icon"></span></th>
    <th class="sortable" onclick="sortBookings('trainer')">Trainer <span class="sort-icon"></span></th>
    <th class="sortable" onclick="sortBookings('invoiceValue')">Value <span class="sort-icon"></span></th>
    <th>Status</th>
    <th>Actions</th>`;
}

function renderUpcomingBookings() {
  const filtered = getFilteredData().filter(isUpcoming);
  document.getElementById('upcomingBadge').textContent = filtered.length;
  const sorted = sortData(filtered);
  const total = sorted.length;
  const pages = Math.max(1, Math.ceil(total/PAGE_SIZE));
  upcomingPage = Math.min(upcomingPage, pages);
  const slice = sorted.slice((upcomingPage-1)*PAGE_SIZE, upcomingPage*PAGE_SIZE);
  document.getElementById('upcomingBookingsHead').innerHTML = bookingTableHead();
  const tbody = document.getElementById('upcomingBookingsBody');
  if(!slice.length) { tbody.innerHTML = '<tr><td colspan="9"><div class="empty-state"><div class="empty-state-icon"></div><div class="empty-state-text">No upcoming bookings match your filters</div></div></td></tr>'; }
  else tbody.innerHTML = slice.map(r => bookingRow(r)).join('');
  const pg = document.getElementById('upcomingPagination');
  if(total > PAGE_SIZE) {
    pg.style.display = 'flex';
    document.getElementById('upcomingPageInfo').textContent = `Page ${upcomingPage} of ${pages}`;
    document.getElementById('upcomingPrevBtn').disabled = upcomingPage <= 1;
    document.getElementById('upcomingNextBtn').disabled = upcomingPage >= pages;
    document.getElementById('upcomingRowCount').textContent = `${total} bookings`;
  } else { pg.style.display = 'none'; }
}

function renderCompletedBookings() {
  const filtered = getFilteredData().filter(isCompleted);
  document.getElementById('completedBadge').textContent = filtered.length;
  const sorted = sortData(filtered);
  const total = sorted.length;
  const pages = Math.max(1, Math.ceil(total/PAGE_SIZE));
  completedPage = Math.min(completedPage, pages);
  const slice = sorted.slice((completedPage-1)*PAGE_SIZE, completedPage*PAGE_SIZE);
  document.getElementById('completedBookingsHead').innerHTML = bookingTableHead();
  const tbody = document.getElementById('completedBookingsBody');
  if(!slice.length) { tbody.innerHTML = '<tr><td colspan="9"><div class="empty-state"><div class="empty-state-icon"></div><div class="empty-state-text">No completed bookings match your filters</div></div></td></tr>'; }
  else tbody.innerHTML = slice.map(r => bookingRow(r)).join('');
  const pg = document.getElementById('completedPagination');
  if(total > PAGE_SIZE) {
    pg.style.display = 'flex';
    document.getElementById('completedPageInfo').textContent = `Page ${completedPage} of ${pages}`;
    document.getElementById('completedPrevBtn').disabled = completedPage <= 1;
    document.getElementById('completedNextBtn').disabled = completedPage >= pages;
    document.getElementById('completedRowCount').textContent = `${total} bookings`;
  } else { pg.style.display = 'none'; }
}

function bookingRow(r) {
  const completed = isCompleted(r); // past-dated Booked, or any Cancelled
  const actions = [];
  // Edit: allowed on Booked rows if user has editBooking permission
  if(canDo('editBooking') && r.status === 'Booked') actions.push(`<button class="btn btn-edit btn-sm" onclick="openEditBookingModal(${r._idx})"> Edit</button>`);
  // Confirm: upcoming Pending/Unassigned
  if(canDo('confirmBooking') && (r.status === 'Pending' || r.status === 'Unassigned')) actions.push(`<button class="btn btn-success btn-sm" onclick="openBookModal(${r._idx})">Confirm</button>`);
  // Cancel: only on upcoming non-Cancelled rows
  if(canDo('cancelBooking') && !completed && r.status !== 'Cancelled') actions.push(`<button class="btn btn-danger btn-sm" onclick="openCancelModal(${r._idx})">Cancel</button>`);
  return `<tr>
    <td>${fmtDate(r.ts)}</td>
    <td>${companyCell(r)}</td>
    <td style="font-size:11px;">${escHtml(r.contact)}</td>
    <td>${optionBadge(r.trainingOption)}</td>
    <td>${fmtDate(r.bookedOn)}</td>
    <td>${trainerPill(r.trainer)}</td>
    <td>${r.invoiceValue !== null ? fmtMoney(r.invoiceValue) : ''}</td>
    <td>${statusBadge(r.status)}</td>
    <td style="display:flex;gap:5px;flex-wrap:wrap;">${actions.join('')}</td>
  </tr>`;
}

function sortBookings(col) {
  if(sortCol === col) sortDir *= -1; else { sortCol = col; sortDir = 1; }
  renderUpcomingBookings(); renderCompletedBookings();
}

function sortData(rows) {
  if(!sortCol) return rows;
  return [...rows].sort((a, b) => {
    let av, bv;
    if(sortCol === 'company') { av = getCompanyName(a).toLowerCase(); bv = getCompanyName(b).toLowerCase(); }
    else if(sortCol === 'ts') { av = a.ts?.getTime()||0; bv = b.ts?.getTime()||0; }
    else if(sortCol === 'bookedOn') { av = a.bookedOn?.getTime()||0; bv = b.bookedOn?.getTime()||0; }
    else if(sortCol === 'invoiceValue') { av = a.invoiceValue||0; bv = b.invoiceValue||0; }
    else { av = String(a[sortCol]||'').toLowerCase(); bv = String(b[sortCol]||'').toLowerCase(); }
    return av < bv ? -sortDir : av > bv ? sortDir : 0;
  });
}

function changeUpcomingPage(d) { upcomingPage += d; renderUpcomingBookings(); }
function changeCompletedPage(d) { completedPage += d; renderCompletedBookings(); }
</script><script>
// ===================== KPIs =====================
function renderKpis() {
  const now = new Date();
  const yr = now.getFullYear();
  const mon = now.getMonth();
  const lastMon = mon === 0 ? 11 : mon - 1;
  const lastMonYr = mon === 0 ? yr - 1 : yr;
  const booked = allData.filter(r => r.status === 'Booked');
  const thisYear = booked.filter(r => r.bookedOn && r.bookedOn.getFullYear() === yr);
  const thisMonth = booked.filter(r => r.bookedOn && r.bookedOn.getFullYear() === yr && r.bookedOn.getMonth() === mon);
  const lastMonth = booked.filter(r => r.bookedOn && r.bookedOn.getFullYear() === lastMonYr && r.bookedOn.getMonth() === lastMon);
  const prevYear = booked.filter(r => r.bookedOn && r.bookedOn.getFullYear() === yr - 1);
  const revYear = thisYear.reduce((s,r) => s + (r.invoiceValue||0), 0);
  const revMonth = thisMonth.reduce((s,r) => s + (r.invoiceValue||0), 0);
  const revLastMonth = lastMonth.reduce((s,r) => s + (r.invoiceValue||0), 0);
  const daysYear = thisYear.reduce((s,r) => s + (r.trainingDays||1), 0);
  const daysMonth = thisMonth.reduce((s,r) => s + (r.trainingDays||1), 0);
  const avgFee = thisYear.length ? revYear / thisYear.length : 0;
  document.getElementById('kpiRevYear').textContent = fmtMoney(revYear);
  document.getElementById('kpiRevMonth').textContent = fmtMoney(revMonth);
  document.getElementById('kpiAvgFee').textContent = fmtMoney(avgFee);
  const daysLastMonth = lastMonth.reduce((s,r) => s + (r.trainingDays||1), 0);
  document.getElementById('kpiDaysYear').textContent = daysYear;
  document.getElementById('kpiDaysMonth').textContent = daysMonth + ' this month';
  document.getElementById('kpiDaysThisMonth').textContent = daysMonth;
  document.getElementById('kpiDaysLastMonthSub').textContent = daysLastMonth + ' last month';
  if(revLastMonth > 0) {
    const delta = Math.round(((revMonth - revLastMonth) / revLastMonth) * 100);
    const cls = delta >= 0 ? 'delta-up' : 'delta-down';
    document.getElementById('kpiRevMonthDelta').innerHTML = `<span class="kpi-card-delta ${cls}">${delta >= 0 ? '' : ''} ${Math.abs(delta)}% vs last month</span>`;
  }
  const months = Array.from({length:12},(_,i) => i);
  const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const thisYrData = months.map(m => thisYear.filter(r => r.bookedOn.getMonth()===m).reduce((s,r) => s+(r.invoiceValue||0),0));
  const prevYrData = months.map(m => prevYear.filter(r => r.bookedOn && r.bookedOn.getMonth()===m).reduce((s,r) => s+(r.invoiceValue||0),0));
  const tmLabel = monthNames[mon] + ' ' + yr;
  const lmLabel = monthNames[lastMon] + ' ' + lastMonYr;
  document.getElementById('thisMonthLabel').textContent = tmLabel;
  document.getElementById('lastMonthLabel').textContent = lmLabel;
  document.getElementById('thisMonthRev').textContent = fmtMoney(revMonth);
  document.getElementById('lastMonthRev').textContent = fmtMoney(revLastMonth);
  const OPT_KEYS = Object.keys(TRAINING_OPTIONS);
  const OPT_SHORTS = Object.values(TRAINING_OPTIONS).map(o => o.short);
  const optCounts = OPT_KEYS.map(key => thisYear.filter(r => (r.trainingOption||'').trim() === key).length);
  if(revenueChartInst) { revenueChartInst.destroy(); revenueChartInst = null; }
  if(optionChartInst) { optionChartInst.destroy(); optionChartInst = null; }
  const rc = document.getElementById('revenueChart');
  if(rc) {
    revenueChartInst = new Chart(rc, {type:'bar',data:{labels:monthNames,datasets:[{label:String(yr),data:thisYrData,backgroundColor:'rgba(33,71,244,0.7)',borderRadius:4},{label:String(yr-1),data:prevYrData,backgroundColor:'rgba(33,71,244,0.2)',borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{font:{size:10},boxWidth:10}}},scales:{y:{ticks:{callback:v=>''+v.toLocaleString('en-GB')},grid:{color:'rgba(0,0,0,0.04)'}},x:{grid:{display:false}}}}});
  }
  const oc = document.getElementById('optionChart');
  if(oc) {
    optionChartInst = new Chart(oc, {type:'doughnut',data:{labels:OPT_SHORTS,datasets:[{data:optCounts,backgroundColor:['#2147f4','#8b5cf6','#f59e0b','#22a06b','#ef4444','#6b7280'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{font:{size:10},boxWidth:10}}}}});
  }
}

function openKpiModal(type) {
  const overlay = document.getElementById('kpiModalOverlay');
  const title = document.getElementById('kpiModalTitle');
  const sub = document.getElementById('kpiModalSubtitle');
  const stats = document.getElementById('kpiStatGrid');
  const thead = document.getElementById('kpiModalTableHead');
  const tbody = document.getElementById('kpiModalTableBody');
  overlay.classList.add('open');
  const now = new Date(); const yr = now.getFullYear(); const mon = now.getMonth();
  if(type === 'revYear') {
    title.textContent = 'Revenue This Year  Booked Sessions';
    sub.textContent = `All booked sessions in ${yr} with invoice values`;
    const rows = allData.filter(r => r.status === 'Booked' && r.bookedOn && r.bookedOn.getFullYear() === yr && r.invoiceValue);
    const total = rows.reduce((s,r) => s+(r.invoiceValue||0),0);
    stats.innerHTML = `<div class="kpi-stat"><div class="kpi-stat-label">Total Revenue</div><div class="kpi-stat-value">${fmtMoney(total)}</div></div><div class="kpi-stat"><div class="kpi-stat-label">Sessions</div><div class="kpi-stat-value">${rows.length}</div></div><div class="kpi-stat"><div class="kpi-stat-label">Avg Fee</div><div class="kpi-stat-value">${rows.length?fmtMoney(total/rows.length):''}</div></div><div class="kpi-stat"><div class="kpi-stat-label">With Value</div><div class="kpi-stat-value">${rows.length}</div></div>`;
    thead.innerHTML = '<tr><th style="padding:8px 12px;font-size:11px;text-transform:uppercase;color:var(--text--dark--30);">Company</th><th style="padding:8px 12px;font-size:11px;text-transform:uppercase;color:var(--text--dark--30);">Booked</th><th style="padding:8px 12px;font-size:11px;text-transform:uppercase;color:var(--text--dark--30);">Trainer</th><th style="padding:8px 12px;font-size:11px;text-transform:uppercase;color:var(--text--dark--30);">Value</th></tr>';
    tbody.innerHTML = rows.sort((a,b) => (b.invoiceValue||0)-(a.invoiceValue||0)).map(r => `<tr style="border-bottom:1px solid #f3f4f6;"><td style="padding:8px 12px;">${escHtml(getCompanyName(r))}</td><td style="padding:8px 12px;">${fmtDate(r.bookedOn)}</td><td style="padding:8px 12px;">${escHtml(r.trainer||'')}</td><td style="padding:8px 12px;font-weight:600;">${fmtMoney(r.invoiceValue)}</td></tr>`).join('');
  } else if(type === 'days') {
    title.textContent = 'Training Days This Year';
    const rows = allData.filter(r => r.status === 'Booked' && r.bookedOn && r.bookedOn.getFullYear() === yr);
    const total = rows.reduce((s,r) => s+(r.trainingDays||1),0);
    stats.innerHTML = `<div class="kpi-stat"><div class="kpi-stat-label">Total Days</div><div class="kpi-stat-value">${total}</div></div><div class="kpi-stat"><div class="kpi-stat-label">Sessions</div><div class="kpi-stat-value">${rows.length}</div></div><div class="kpi-stat"><div class="kpi-stat-label">Avg Days/Session</div><div class="kpi-stat-value">${rows.length?(total/rows.length).toFixed(1):''}</div></div><div class="kpi-stat"><div class="kpi-stat-label">Busiest Month</div><div class="kpi-stat-value"></div></div>`;
    thead.innerHTML = '<tr><th style="padding:8px 12px;font-size:11px;text-transform:uppercase;color:var(--text--dark--30);">Company</th><th style="padding:8px 12px;font-size:11px;text-transform:uppercase;color:var(--text--dark--30);">Booked</th><th style="padding:8px 12px;font-size:11px;text-transform:uppercase;color:var(--text--dark--30);">Trainer</th><th style="padding:8px 12px;font-size:11px;text-transform:uppercase;color:var(--text--dark--30);">Days</th></tr>';
    tbody.innerHTML = rows.sort((a,b) => (b.trainingDays||1)-(a.trainingDays||1)).map(r => `<tr style="border-bottom:1px solid #f3f4f6;"><td style="padding:8px 12px;">${escHtml(getCompanyName(r))}</td><td style="padding:8px 12px;">${fmtDate(r.bookedOn)}</td><td style="padding:8px 12px;">${escHtml(r.trainer||'')}</td><td style="padding:8px 12px;font-weight:600;">${r.trainingDays||1}</td></tr>`).join('');
  } else if(type === 'daysMonth') {
    const lastMon2 = mon === 0 ? 11 : mon - 1;
    const lastMonYr2 = mon === 0 ? yr - 1 : yr;
    const monthNames2 = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    const tmRows = allData.filter(r => r.status === 'Booked' && r.bookedOn && r.bookedOn.getFullYear() === yr && r.bookedOn.getMonth() === mon);
    const lmRows = allData.filter(r => r.status === 'Booked' && r.bookedOn && r.bookedOn.getFullYear() === lastMonYr2 && r.bookedOn.getMonth() === lastMon2);
    const tmDays = tmRows.reduce((s,r) => s+(r.trainingDays||1),0);
    const lmDays = lmRows.reduce((s,r) => s+(r.trainingDays||1),0);
    const delta = lmDays > 0 ? Math.round(((tmDays - lmDays) / lmDays) * 100) : null;
    const deltaHtml = delta !== null ? `<div class="kpi-stat"><div class="kpi-stat-label">Change</div><div class="kpi-stat-value" style="color:${delta>=0?'#22a06b':'#c0303d'}">${delta>=0?'':''} ${Math.abs(delta)}%</div></div>` : '';
    title.textContent = 'Training Days  Month Comparison';
    sub.textContent = `${monthNames2[mon]} ${yr} vs ${monthNames2[lastMon2]} ${lastMonYr2}`;
    stats.innerHTML = `<div class="kpi-stat"><div class="kpi-stat-label">${monthNames2[mon]}</div><div class="kpi-stat-value">${tmDays} days</div></div><div class="kpi-stat"><div class="kpi-stat-label">${monthNames2[lastMon2]}</div><div class="kpi-stat-value">${lmDays} days</div></div>${deltaHtml}`;
    thead.innerHTML = '<tr><th style="padding:8px 12px;font-size:11px;text-transform:uppercase;color:var(--text--dark--30);">Company</th><th style="padding:8px 12px;font-size:11px;text-transform:uppercase;color:var(--text--dark--30);">Booked</th><th style="padding:8px 12px;font-size:11px;text-transform:uppercase;color:var(--text--dark--30);">Trainer</th><th style="padding:8px 12px;font-size:11px;text-transform:uppercase;color:var(--text--dark--30);">Month</th><th style="padding:8px 12px;font-size:11px;text-transform:uppercase;color:var(--text--dark--30);">Days</th></tr>';
    const allRows = [...tmRows.map(r => ({...r, _month: monthNames2[mon]})), ...lmRows.map(r => ({...r, _month: monthNames2[lastMon2]}))];
    tbody.innerHTML = allRows.sort((a,b) => b.bookedOn - a.bookedOn).map(r => `<tr style="border-bottom:1px solid #f3f4f6;"><td style="padding:8px 12px;">${escHtml(getCompanyName(r))}</td><td style="padding:8px 12px;">${fmtDate(r.bookedOn)}</td><td style="padding:8px 12px;">${escHtml(r.trainer||'')}</td><td style="padding:8px 12px;">${escHtml(r._month)}</td><td style="padding:8px 12px;font-weight:600;">${r.trainingDays||1}</td></tr>`).join('');
  } else if(type === 'revMonth') {
    const monthNames3 = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    const lastMon3  = mon === 0 ? 11 : mon - 1;
    const lastMonYr3 = mon === 0 ? yr - 1 : yr;
    const thisMonRows = allData.filter(r => r.status === 'Booked' && r.bookedOn && r.bookedOn.getFullYear() === yr && r.bookedOn.getMonth() === mon && r.invoiceValue);
    const lastMonRows = allData.filter(r => r.status === 'Booked' && r.bookedOn && r.bookedOn.getFullYear() === lastMonYr3 && r.bookedOn.getMonth() === lastMon3 && r.invoiceValue);
    const thisTotal = thisMonRows.reduce((s,r) => s+(r.invoiceValue||0),0);
    const lastTotal = lastMonRows.reduce((s,r) => s+(r.invoiceValue||0),0);
    const pctChange = lastTotal > 0 ? Math.round(((thisTotal - lastTotal)/lastTotal)*100) : null;
    const changeHtml = pctChange !== null
      ? `<div class="kpi-stat"><div class="kpi-stat-label">vs Last Month</div><div class="kpi-stat-value" style="color:${pctChange>=0?'#22a06b':'#c0303d'}">${pctChange>=0?'&#9650;':'&#9660;'} ${Math.abs(pctChange)}%</div></div>`
      : '';
    title.textContent = 'Revenue This Month  Booked Sessions';
    sub.textContent = `${monthNames3[mon]} ${yr} vs ${monthNames3[lastMon3]} ${lastMonYr3}`;
    stats.innerHTML = `
      <div class="kpi-stat"><div class="kpi-stat-label">${monthNames3[mon]} Revenue</div><div class="kpi-stat-value">${fmtMoney(thisTotal)}</div></div>
      <div class="kpi-stat"><div class="kpi-stat-label">${monthNames3[lastMon3]} Revenue</div><div class="kpi-stat-value">${fmtMoney(lastTotal)}</div></div>
      <div class="kpi-stat"><div class="kpi-stat-label">Sessions This Month</div><div class="kpi-stat-value">${thisMonRows.length}</div></div>
      ${changeHtml}`;
    thead.innerHTML = '<tr><th style="padding:8px 12px;font-size:11px;text-transform:uppercase;color:var(--text--dark--30);">Company</th><th style="padding:8px 12px;font-size:11px;text-transform:uppercase;color:var(--text--dark--30);">Booked</th><th style="padding:8px 12px;font-size:11px;text-transform:uppercase;color:var(--text--dark--30);">Trainer</th><th style="padding:8px 12px;font-size:11px;text-transform:uppercase;color:var(--text--dark--30);">Month</th><th style="padding:8px 12px;font-size:11px;text-transform:uppercase;color:var(--text--dark--30);">Value</th></tr>';
    const allMonRows = [
      ...thisMonRows.map(r => ({...r, _month: monthNames3[mon]})),
      ...lastMonRows.map(r => ({...r, _month: monthNames3[lastMon3]}))
    ];
    tbody.innerHTML = allMonRows.sort((a,b) => b.bookedOn - a.bookedOn).map(r =>
      `<tr style="border-bottom:1px solid #f3f4f6;">
        <td style="padding:8px 12px;">${escHtml(getCompanyName(r))}</td>
        <td style="padding:8px 12px;">${fmtDate(r.bookedOn)}</td>
        <td style="padding:8px 12px;">${escHtml(r.trainer||'')}</td>
        <td style="padding:8px 12px;">${escHtml(r._month)}</td>
        <td style="padding:8px 12px;font-weight:600;">${fmtMoney(r.invoiceValue)}</td>
      </tr>`).join('');

  } else if(type === 'avgFee') {
    const monthNames4 = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const bookedWithVal = allData.filter(r => r.status === 'Booked' && r.bookedOn && r.bookedOn.getFullYear() === yr && r.invoiceValue);
    const totalVal = bookedWithVal.reduce((s,r) => s+(r.invoiceValue||0), 0);
    const avgFee   = bookedWithVal.length ? totalVal / bookedWithVal.length : 0;
    // Per-trainer breakdown
    const byTrainer = {};
    bookedWithVal.forEach(r => {
      const t = r.trainer || 'Unassigned';
      if(!byTrainer[t]) byTrainer[t] = { total:0, count:0 };
      byTrainer[t].total += r.invoiceValue||0;
      byTrainer[t].count++;
    });
    const trainerRows = Object.entries(byTrainer)
      .map(([t, d]) => ({ trainer:t, avg: d.total/d.count, count: d.count, total: d.total }))
      .sort((a,b) => b.avg - a.avg);
    // Per-month average
    const byMonth = {};
    bookedWithVal.forEach(r => {
      const m = r.bookedOn.getMonth();
      if(!byMonth[m]) byMonth[m] = { total:0, count:0 };
      byMonth[m].total += r.invoiceValue||0;
      byMonth[m].count++;
    });
    title.textContent = 'Average Training Fee  ' + yr;
    sub.textContent = `Based on ${bookedWithVal.length} booked session${bookedWithVal.length!==1?'s':''} with invoice values recorded`;
    const highestFee = bookedWithVal.length ? Math.max(...bookedWithVal.map(r=>r.invoiceValue)) : 0;
    const lowestFee  = bookedWithVal.length ? Math.min(...bookedWithVal.map(r=>r.invoiceValue)) : 0;
    stats.innerHTML = `
      <div class="kpi-stat"><div class="kpi-stat-label">Avg Fee (Year)</div><div class="kpi-stat-value">${fmtMoney(avgFee)}</div></div>
      <div class="kpi-stat"><div class="kpi-stat-label">Highest Fee</div><div class="kpi-stat-value">${fmtMoney(highestFee)}</div></div>
      <div class="kpi-stat"><div class="kpi-stat-label">Lowest Fee</div><div class="kpi-stat-value">${fmtMoney(lowestFee)}</div></div>
      <div class="kpi-stat"><div class="kpi-stat-label">Total Revenue</div><div class="kpi-stat-value">${fmtMoney(totalVal)}</div></div>`;
    // Show per-trainer averages
    thead.innerHTML = '<tr><th style="padding:8px 12px;font-size:11px;text-transform:uppercase;color:var(--text--dark--30);">Trainer</th><th style="padding:8px 12px;font-size:11px;text-transform:uppercase;color:var(--text--dark--30);">Sessions</th><th style="padding:8px 12px;font-size:11px;text-transform:uppercase;color:var(--text--dark--30);">Total</th><th style="padding:8px 12px;font-size:11px;text-transform:uppercase;color:var(--text--dark--30);">Avg Fee</th></tr>';
    tbody.innerHTML = trainerRows.map(r =>
      `<tr style="border-bottom:1px solid #f3f4f6;">
        <td style="padding:8px 12px;font-weight:600;">${escHtml(r.trainer)}</td>
        <td style="padding:8px 12px;">${r.count}</td>
        <td style="padding:8px 12px;">${fmtMoney(r.total)}</td>
        <td style="padding:8px 12px;font-weight:700;color:var(--action-primary-blue);">${fmtMoney(r.avg)}</td>
      </tr>`).join('');
    if(!bookedWithVal.length) {
      tbody.innerHTML = '<tr><td colspan="4" style="padding:24px;text-align:center;color:var(--text--dark--30);">No booked sessions with invoice values recorded yet.</td></tr>';
    }

  } else {
    stats.innerHTML = ''; thead.innerHTML = ''; tbody.innerHTML = '';
  }
}

// ===================== REFERRAL LEADERBOARD =====================
function renderReferralLeaderboard() {
  const board = document.getElementById('referralLeaderboard');
  const counts = {};
  allData.forEach(r => {
    if(!r.referredBy || !r.referredBy.name) return;
    const key = r.referredBy.name;
    if(!counts[key]) counts[key] = { name: r.referredBy.name, team: r.referredBy.team, count: 0, bookedCount: 0, bookedValue: 0 };
    counts[key].count++;
    if(r.status === 'Booked') { counts[key].bookedCount++; counts[key].bookedValue += r.invoiceValue || 0; }
  });
  const entries = Object.values(counts).sort((a,b) => b.count - a.count);
  if(!entries.length) {
    board.innerHTML = '<div style="text-align:center;padding:32px;color:var(--text--dark--30);font-size:12px;">No referrals recorded yet. Referrals are logged when the Request Training form is submitted with a referrer name.</div>';
    return;
  }
  const TOP = 5;

  function entryHtml(e, i) {
    const rank = i + 1;
    const rankCls = rank === 1 ? 'referral-rank-1' : rank === 2 ? 'referral-rank-2' : rank === 3 ? 'referral-rank-3' : 'referral-rank-other';
    return `<div class="referral-entry" onclick="openReferralModal('${escHtml(e.name)}')">
      <div class="referral-rank ${rankCls}">${rank <= 3 ? ['','',''][rank-1] : rank}</div>
      <div style="flex:1;min-width:0;">
        <div style="font-size:13px;font-weight:600;color:var(--text--dark--50);">${escHtml(e.name)}</div>
        <div style="font-size:11px;color:var(--text--dark--30);">${escHtml(e.team) || 'No team recorded'}</div>
      </div>
      <div style="text-align:right;">
        <div style="font-size:14px;font-weight:700;color:var(--text--dark--50);">${e.count} <span style="font-size:11px;font-weight:400;color:var(--text--dark--30);">referral${e.count!==1?'s':''}</span></div>
        <div style="font-size:11px;color:var(--text--dark--30);">${e.bookedCount} booked &middot; ${e.bookedValue > 0 ? fmtMoney(e.bookedValue) : '0'}</div>
      </div>
      <div style="color:var(--text--dark--20);font-size:14px;"></div>
    </div>`;
  }

  const topHtml = entries.slice(0, TOP).map((e, i) => entryHtml(e, i)).join('');

  let rightContent;
  if (entries.length > TOP) {
    const restItems = entries.slice(TOP).map((e, i) => entryHtml(e, TOP + i)).join('');
    rightContent = `
      <div class="referral-board-right-header">Others &mdash; ${entries.length - TOP} more</div>
      <div class="referral-board-right-scroll">${restItems}</div>`;
  } else {
    rightContent = `<div class="referral-board-empty-right">All referrers<br>in top 5</div>`;
  }

  board.innerHTML = `
    <div class="referral-board-left">${topHtml}</div>
    <div class="referral-board-right">${rightContent}</div>`;
}

function openReferralModal(name) {
  currentReferralPerson = name;
  const personData = allData.filter(r => r.referredBy && r.referredBy.name === name);
  const team = personData[0]?.referredBy?.team || '';
  document.getElementById('referralModalTitle').textContent = name + (team ? ` (${team})` : '');
  document.getElementById('referralModalSub').textContent = `${personData.length} referral${personData.length!==1?'s':''} total`;
  const booked = personData.filter(r => r.status === 'Booked');
  const totalVal = booked.reduce((s,r) => s+(r.invoiceValue||0),0);
  document.getElementById('referralModalStats').innerHTML = `<div style="display:flex;gap:16px;flex-wrap:wrap;">
    <div><div style="font-size:10px;font-weight:600;text-transform:uppercase;color:var(--text--dark--30);letter-spacing:0.5px;margin-bottom:3px;">Total Referrals</div><div style="font-size:20px;font-weight:700;color:var(--text--dark--50);">${personData.length}</div></div>
    <div><div style="font-size:10px;font-weight:600;text-transform:uppercase;color:var(--text--dark--30);letter-spacing:0.5px;margin-bottom:3px;">Booked</div><div style="font-size:20px;font-weight:700;color:#2147f4;">${booked.length}</div></div>
    <div><div style="font-size:10px;font-weight:600;text-transform:uppercase;color:var(--text--dark--30);letter-spacing:0.5px;margin-bottom:3px;">Total Booked Value</div><div style="font-size:20px;font-weight:700;color:#22a06b;">${fmtMoney(totalVal)}</div></div>
  </div>`;
  document.getElementById('referralFilterDateFrom').value = '';
  document.getElementById('referralFilterDateTo').value = '';
  document.getElementById('referralFilterStatus').value = '';
  renderReferralModalTable();
  document.getElementById('referralModalOverlay').classList.add('open');
}

function renderReferralModalTable() {
  if(!currentReferralPerson) return;
  let rows = allData.filter(r => r.referredBy && r.referredBy.name === currentReferralPerson);
  const fFrom = document.getElementById('referralFilterDateFrom').value;
  const fTo = document.getElementById('referralFilterDateTo').value;
  const fStatus = document.getElementById('referralFilterStatus').value;
  if(fFrom) rows = rows.filter(r => r.ts && r.ts.toISOString().split('T')[0] >= fFrom);
  if(fTo) rows = rows.filter(r => r.ts && r.ts.toISOString().split('T')[0] <= fTo);
  if(fStatus) rows = rows.filter(r => r.status === fStatus);
  document.getElementById('referralModalBody').innerHTML = rows.length ? rows.map(r => `<tr style="border-bottom:1px solid #f3f4f6;">
    <td style="padding:9px 12px;">${fmtDate(r.ts)}</td>
    <td style="padding:9px 12px;font-weight:600;">${escHtml(getCompanyName(r))}</td>
    <td style="padding:9px 12px;">${optionBadge(r.trainingOption)}</td>
    <td style="padding:9px 12px;">${fmtDate(r.bookedOn)}</td>
    <td style="padding:9px 12px;">${r.invoiceValue!==null?fmtMoney(r.invoiceValue):''}</td>
    <td style="padding:9px 12px;">${statusBadge(r.status)}</td>
  </tr>`).join('') : '<tr><td colspan="6" style="padding:20px;text-align:center;color:var(--text--dark--30);">No referrals match the filters</td></tr>';
}

function clearReferralFilters() {
  document.getElementById('referralFilterDateFrom').value = '';
  document.getElementById('referralFilterDateTo').value = '';
  document.getElementById('referralFilterStatus').value = '';
  renderReferralModalTable();
}

function closeReferralModal() {
  document.getElementById('referralModalOverlay').classList.remove('open');
  currentReferralPerson = null;
}

// ===================== PROFILE SIDEBAR =====================
function openProfileSidebar(idx) {
  const r = allData.find(x => x._idx === idx);
  if(!r) return;
  currentProfileRow = r;
  document.getElementById('profileCompany').textContent = getCompanyName(r);
  const meta = document.getElementById('profileMeta');
  meta.innerHTML = `${statusBadge(r.status)} ${optionBadge(r.trainingOption)} <span style="font-size:11px;color:rgba(255,255,255,0.5);">Submitted ${fmtDate(r.ts)}</span>`;
  const sections = [
    { title: ' Enquiry Overview', icon: '', fields: [
      ['Status', statusBadge(r.status)],
      ['Company', escHtml(r.company) || ''],
      ['Training Type', optionBadge(r.trainingOption)],
      ['Submitted', fmtDate(r.ts)],
      ['Preferred Date', r.preferredDate ? fmtDate(new Date(r.preferredDate)) : ''],
      ['Target Go-Live', r.goLiveDate || '']
    ]},
    { title: ' Contact Details', icon: '', fields: [
      ['Email', r.email ? `<a href="mailto:${escHtml(r.email)}" style="color:var(--action-primary-blue);">${escHtml(r.email)}</a>` : ''],
      ['Stakeholder', r.contact || ''],
      ['Attendees', r.attendeesRaw || '']
    ]},
    { title: ' Training Details', icon: '', fields: [
      ['Team Familiarity', r.teamFamiliarity || ''],
      ['Areas to Cover', r.areas || ''],
      ['Priorities', r.priorities || ''],
      ['Features & Challenges', r.features || '']
    ]},
    { title: ' Logistics', icon: '', fields: [
      ['Location', r.locationRaw || ''],
      ['Parking / Access', r.parking || ''],
      ['Venue Setup', r.venueSetup || ''],
      ['Follow-Up Preferences', r.followUp || ''],
      ['Anything Else', r.anythingElse || '']
    ]},
    { title: ' Financials', icon: '', fields: [
      ['Invoice Value', r.invoiceValue !== null ? `<strong>${fmtMoney(r.invoiceValue)}</strong>` : ''],
      ['Booked Date', fmtDate(r.bookedOn)],
      ['Training Days', r.trainingDays || ''],
      ['Trainer', r.trainer || '']
    ]}
  ];
  if(r.referredBy) {
    sections.push({ title: ' Referral Info', icon: '', fields: [
      ['Referred By', r.referredBy.name || ''],
      ['Team / Dept', r.referredBy.team || ''],
      ['Referral Notes', r.referredBy.notes || r.referralNotes || '']
    ]});
  }
  const sectionsHtml = sections.map((s, si) => {
    const open = si === 0;
    return `<div class="profile-section">
      <div class="profile-section-hdr" onclick="toggleProfileSection(${si})">
        <div class="profile-section-title">${s.icon} ${s.title.replace(/^[^\s]+\s/, '')}</div>
        <span class="profile-chevron ${open?'open':''}" id="profileChevron${si}">${open?'':''}</span>
      </div>
      <div class="profile-section-body ${open?'open':''}" id="profileSection${si}">
        ${s.fields.map(([label, val]) => `<div class="profile-field"><span class="profile-field-label">${label}</span><span class="profile-field-value">${val}</span></div>`).join('')}
      </div>
    </div>`;
  }).join('');
  document.getElementById('profileSections').innerHTML = sectionsHtml;
  renderProfileNotes(r);
  document.getElementById('profileOverlay').classList.add('open');
  document.getElementById('profilePanel').classList.add('open');
  // Hide note input for users without permission
  const noteInput = document.getElementById('profileNoteInput');
  if(noteInput) noteInput.style.display = canDo('addNotes') ? 'flex' : 'none';
}

function toggleProfileSection(idx) {
  const body = document.getElementById(`profileSection${idx}`);
  const chev = document.getElementById(`profileChevron${idx}`);
  const isOpen = body.classList.toggle('open');
  chev.classList.toggle('open', isOpen);
  chev.textContent = isOpen ? '' : '';
}

function renderProfileNotes(r) {
  const list = document.getElementById('profileNotesList');
  const notes = r.notes || [];
  if(!notes.length) { list.innerHTML = '<div style="font-size:11px;color:var(--text--dark--30);padding:4px 0;">No notes yet.</div>'; return; }
  list.innerHTML = notes.map(n => {
    // ts can be a ms number (local) or a "dd/mm/yyyy, hh:mm:ss" string (from sheet)
    let tsDisplay = '';
    if(n.ts) {
      if(typeof n.ts === 'number') {
        tsDisplay = fmtDate(new Date(n.ts));
      } else {
        // Already formatted by Apps Script - use as-is
        tsDisplay = String(n.ts);
      }
    }
    const roleTag = n.role ? ` <span style="font-size:9px;background:#f3f4f6;padding:1px 5px;border-radius:4px;color:var(--text--dark--30);">${escHtml(n.role)}</span>` : '';
    return `<div class="profile-note-item">
      <div class="profile-note-meta">${escHtml(n.author || 'Unknown')}${roleTag} &mdash; ${tsDisplay}</div>
      <div class="profile-note-text">${escHtml(n.text)}</div>
    </div>`;
  }).join('');
}

async function saveProfileNote() {
  const textarea = document.getElementById('profileNewNote');
  const btn      = document.querySelector('#profileNotesList ~ * button, .profile-note-add button') ||
                   document.getElementById('profileAddNoteBtn');
  const text = textarea.value.trim();
  if(!text || !currentProfileRow) return;

  // Immediately show locally so UI feels instant
  const note = { text, author: currentUser?.name || 'Unknown', ts: Date.now() };
  if(!currentProfileRow.notes) currentProfileRow.notes = [];
  currentProfileRow.notes.push(note);
  textarea.value = '';
  renderProfileNotes(currentProfileRow);

  // Persist to Progress Notes sheet
  showToast('Saving note...', 'info');
  await writeNoteToSheet(currentProfileRow._rowNum, getCompanyName(currentProfileRow), text, 'Client Profile');

  logNote(currentUser?.name || '?', 'Note added', getCompanyName(currentProfileRow), text.slice(0, 120));
  writeActivityLog({
    actionType:  'Note Added',
    description: 'Progress note added to client profile',
    module:      'Client Profile',
    recordType:  'Enquiry',
    recordId:    String(currentProfileRow._rowNum),
    before:      '',
    after:       text.slice(0, 200),
    reason:      'Manual entry',
    source:      'Dashboard Button',
    company:     getCompanyName(currentProfileRow),
    trainer:     currentProfileRow.trainer || '',
  });
  showToast('Note saved', 'success');
}

function closeProfileSidebar() {
  document.getElementById('profileOverlay').classList.remove('open');
  document.getElementById('profilePanel').classList.remove('open');
  currentProfileRow = null;
}

// ===================== CALENDAR =====================
function updateCalTrainerFilter() {
  const sel = document.getElementById('calFilterTrainer');
  if(!sel) return;
  sel.innerHTML = '<option value="">All Trainers</option>';
  trainers.filter(u => u.role === 'trainer' || u.role === 'admin').forEach(t => sel.innerHTML += `<option value="${t.name}">${t.name}</option>`);
}

function calChangeMonth(dir) { currentCalMonth.setMonth(currentCalMonth.getMonth() + dir); renderCalendar(); }

function renderCalendar() {
  const year = currentCalMonth.getFullYear();
  const month = currentCalMonth.getMonth();
  const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('calMonthTitle').textContent = `${monthNames[month]} ${year}`;
  const firstDay = new Date(year, month, 1);
  let startDow = firstDay.getDay(); if(startDow === 0) startDow = 7; startDow--;
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const today = new Date(); today.setHours(0,0,0,0);
  const trainerFilter = document.getElementById('calFilterTrainer')?.value || '';
  // Widen query: include any booking whose training days, travel day, or admin day
  // could touch the displayed month ( 1 month buffer is sufficient)
  const prevMonth = new Date(year, month - 1, 1);
  const nextMonth = new Date(year, month + 2, 0); // last day of month+1
  const bookedRows = allData.filter(r =>
    r.status === 'Booked' && r.bookedOn &&
    r.bookedOn >= prevMonth && r.bookedOn <= nextMonth &&
    (!trainerFilter || r.trainer === trainerFilter)
  );
  const eventsByDay = {};
  function addCalEvent(dateObj, event) {
    if (dateObj.getFullYear() !== year || dateObj.getMonth() !== month) return;
    const day = dateObj.getDate();
    if (!eventsByDay[day]) eventsByDay[day] = [];
    eventsByDay[day].push(event);
  }
  bookedRows.forEach(r => {
    const days = r.trainingDays || 1;
    const t = trainers.find(u => u.name === r.trainer);
    const color = t ? t.color : '#2147f4';
    const start = new Date(r.bookedOn); start.setHours(0,0,0,0);
    // Training days
    for (let i = 0; i < days; i++) {
      const d = new Date(start); d.setDate(d.getDate() + i);
      addCalEvent(d, { label: getCompanyName(r), color, type: 'training', rowIdx: r._idx });
    }
    // Travel day = last working day before training (respects bank holidays & weekends)
    const travel = prevWorkingDay(start);
    addCalEvent(travel, { label: 'Travel  ' + r.trainer, color: '#fef3c7', textColor: '#92400e', type: 'travel', rowIdx: r._idx });
    // Admin day = first working day after training ends (respects bank holidays & weekends)
    const trainingEnd = new Date(start); trainingEnd.setDate(trainingEnd.getDate() + days - 1);
    const admin = nextWorkingDay(trainingEnd);
    addCalEvent(admin, { label: 'Admin  ' + r.trainer, color: '#e0e7ff', textColor: '#3730a3', type: 'admin', rowIdx: r._idx });
  });
  // Bank holidays from ICS  show on each day within range
  calIcsEvents.forEach(ev => {
    if(!ev.start) return;
    const evStart = new Date(ev.start); evStart.setHours(0,0,0,0);
    // DTEND is exclusive for all-day events, so go up to (end - 1 day)
    const evEnd = ev.end ? new Date(ev.end) : new Date(evStart.getTime() + 86400000);
    evEnd.setHours(0,0,0,0);
    for(let d = new Date(evStart); d < evEnd; d.setDate(d.getDate() + 1)) {
      addCalEvent(new Date(d), { label: ev.summary, color: '#fef9c3', textColor: '#92400e', type: 'holiday' });
    }
  });
  // Team leave  only show for trainers + admins, greyed out style
  // Match by checking if any trainer/admin's full name appears anywhere in the summary
  const calendarUsers = trainers.filter(u => u.role === 'trainer' || u.role === 'admin');
  calLeaveEvents.forEach(ev => {
    if(!ev.start || !ev.summary) return;
    const summaryLower = ev.summary.toLowerCase();
    const matchedUser = calendarUsers.find(u => summaryLower.includes(u.name.toLowerCase()));
    if(!matchedUser) return; // not a trainer/admin  skip
    const evStart = new Date(ev.start); evStart.setHours(0,0,0,0);
    const evEnd   = ev.end ? new Date(ev.end) : new Date(evStart.getTime() + 86400000);
    evEnd.setHours(0,0,0,0);
    for(let d = new Date(evStart); d < evEnd; d.setDate(d.getDate() + 1)) {
      addCalEvent(new Date(d), { label: ev.summary, color: '#e5e7eb', textColor: '#6b7280', type: 'leave' });
    }
  });
  // Provisional dates  dashed amber pill, non-blocking
  Object.values(provisionalDates).forEach(prov => {
    if(!prov.date) return;
    const d = new Date(prov.date + 'T00:00:00');
    addCalEvent(d, {
      label:     ' ' + prov.company + ' (' + prov.trainer + ')',
      color:     '#fffbeb',
      textColor: '#92400e',
      type:      'provisional',
      provisional: true,
    });
  });
  let html = '';
  for(let i = 0; i < startDow; i++) html += '<div class="cal-day cal-day-empty"></div>';
  for(let d = 1; d <= daysInMonth; d++) {
    const date = new Date(year, month, d);
    const isToday = date.getTime() === today.getTime();
    const isPast = date < today;
    const isWeekend = date.getDay() === 0 || date.getDay() === 6;
    const isHol = isBankHoliday(date);
    const events = eventsByDay[d] || [];
    const max = 3;
    let cls = 'cal-day';
    if(isWeekend) cls += ' cal-day-weekend';
    if(isToday) cls += ' cal-day-today';
    if(isPast) cls += ' cal-day-past';
    if(isHol) cls += ' cal-day-holiday';
    let evHtml = events.slice(0,max).map(ev => {
      const bg = ev.color || ev.c; const tc = ev.textColor || '#fff';
      const onclick = ev.rowIdx !== undefined ? `onclick="openCalEventModal(${ev.rowIdx})"` : '';
      const extraCls = ev.provisional ? ' provisional' : '';
      return `<span class="cal-event${extraCls}" style="background:${bg};color:${tc};" ${onclick} title="${escHtml(ev.label)}">${escHtml(ev.label)}</span>`;
    }).join('');
    if(events.length > max) evHtml += `<span class="cal-event-more">+${events.length-max} more</span>`;
    html += `<div class="${cls}"><span class="cal-day-num">${isToday ? `<span style="background:var(--action-primary-blue);color:#fff;width:20px;height:20px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;">${d}</span>` : d}</span>${evHtml}</div>`;
  }
  document.getElementById('calDays').innerHTML = html;
  renderCalUpcoming(bookedRows);
}

function renderCalUpcoming(bookedRows) {
  const today = new Date(); today.setHours(0,0,0,0);
  const upcoming = allData.filter(r => r.status === 'Booked' && r.bookedOn && r.bookedOn >= today).sort((a,b) => a.bookedOn - b.bookedOn).slice(0,8);
  document.getElementById('calUpcomingCount').textContent = upcoming.length + ' sessions';
  if(!upcoming.length) { document.getElementById('calUpcomingBody').innerHTML = '<div class="cal-upcoming-empty">No upcoming booked sessions</div>'; return; }
  const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  document.getElementById('calUpcomingBody').innerHTML = upcoming.map(r => {
    const d = r.bookedOn;
    const t = trainers.find(u => u.name === r.trainer);
    const color = t ? t.color : '#888';
    return `<div class="cal-upcoming-item">
      <div class="cal-upcoming-date"><div class="cal-upcoming-date-day">${d.getDate()}</div><div class="cal-upcoming-date-mon">${monthNames[d.getMonth()]}</div></div>
      <div class="cal-upcoming-body-text">
        <div class="cal-upcoming-company">${escHtml(getCompanyName(r))}</div>
        <div class="cal-upcoming-meta" style="display:flex;align-items:center;gap:6px;"><span class="trainer-pill" style="background:${color}22;color:${color};font-size:10px;padding:1px 6px;">${escHtml(r.trainer||'TBC')}</span> ${r.trainingDays||1} day${(r.trainingDays||1)!==1?'s':''}</div>
      </div>
    </div>`;
  }).join('');
}

function openCalEventModal(idx) {
  const r = allData.find(x => x._idx === idx);
  if(!r) return;
  document.getElementById('calEventTitle').textContent = getCompanyName(r);
  document.getElementById('calEventSubtitle').textContent = fmtDate(r.bookedOn) + (r.trainer ? '  ' + r.trainer : '');
  document.getElementById('calEventBody').innerHTML = `<div style="display:flex;flex-direction:column;gap:10px;font-size:13px;">
    <div class="profile-field"><span class="profile-field-label">Trainer</span><span>${trainerPill(r.trainer)}</span></div>
    <div class="profile-field"><span class="profile-field-label">Booked Date</span><span>${fmtDate(r.bookedOn)}</span></div>
    <div class="profile-field"><span class="profile-field-label">Days</span><span>${r.trainingDays||1}</span></div>
    <div class="profile-field"><span class="profile-field-label">Option</span><span>${optionBadge(r.trainingOption)}</span></div>
    <div class="profile-field"><span class="profile-field-label">Value</span><span>${r.invoiceValue!==null?fmtMoney(r.invoiceValue):''}</span></div>
    <div class="profile-field"><span class="profile-field-label">Status</span><span>${statusBadge(r.status)}</span></div>
  </div>`;
  document.getElementById('calEventFooter').innerHTML = `<button class="btn btn-ghost" onclick="closeCalEventModal()">Close</button><button class="btn btn-primary btn-sm" onclick="closeCalEventModal();openProfileSidebar(${idx})">View Full Profile </button>`;
  document.getElementById('calEventOverlay').classList.add('open');
}

function closeCalEventModal() { document.getElementById('calEventOverlay').classList.remove('open'); }

// ===================== ASSIGN MODAL =====================
function openAssignModal(idx) {
  const r = allData.find(x => x._idx === idx);
  if(!r) return;
  currentAssignRow = r;
  document.getElementById('assignModalCompany').textContent = getCompanyName(r);
  document.getElementById('assignModalContact').textContent = r.contact + '  ' + r.email;
  document.getElementById('assignModalOption').innerHTML = optionBadge(r.trainingOption) + ' ' + (r.preferredDate ? ' Preferred: ' + fmtDate(new Date(r.preferredDate)) : '');
  const unassignedRows = allData.filter(x => x.status === 'Unassigned');
  const rowPos = unassignedRows.findIndex(x => x._idx === idx);
  const suggested = suggestTrainer(rowPos >= 0 ? rowPos : 0);
  const sel = document.getElementById('assignTrainerSel');
  sel.innerHTML = '<option value=""> Select trainer </option>';
  trainers.filter(u => u.role === 'trainer' || u.role === 'admin').forEach(t => {
    const isSugg = suggested && t.name === suggested.name;
    sel.innerHTML += `<option value="${t.name}" ${isSugg ? 'selected' : ''}>${t.name}${isSugg ? '  Suggested' : ''}</option>`;
  });
  // Show suggestion callout inside modal
  const existingCallout = document.getElementById('assignSuggCallout');
  if (existingCallout) existingCallout.remove();
  if (suggested) {
    const callout = document.createElement('div');
    callout.id = 'assignSuggCallout';
    callout.style.cssText = 'display:flex;align-items:center;gap:8px;padding:9px 12px;border-radius:6px;background:' + (suggested.color||'#2147f4') + '12;border:1px solid ' + (suggested.color||'#2147f4') + '30;font-size:12px;font-weight:600;color:' + (suggested.color||'#2147f4') + ';margin-bottom:12px;';
    callout.innerHTML = '<span style="font-size:15px;"></span><span>Suggested based on workload: <strong>' + escHtml(suggested.name) + '</strong></span>';
    const formRow = document.querySelector('#assignOverlay .form-row');
    if (formRow) formRow.parentNode.insertBefore(callout, formRow);
  }
  document.getElementById('assignOverlay').classList.add('open');
}

function closeAssignModal() { document.getElementById('assignOverlay').classList.remove('open'); currentAssignRow = null; }

async function confirmAssign() {
  const trainer = document.getElementById('assignTrainerSel').value;
  if(!trainer || !currentAssignRow) return;
  const params = new URLSearchParams({ action: 'assign', row: currentAssignRow._rowNum, status: 'Pending', trainer });
  try {
    await fetch(SCRIPT_URL + '?' + params.toString(), { method: 'GET', redirect: 'follow' });
    logActivity(currentUser?.name||'?', 'Assigned trainer', getCompanyName(currentAssignRow), `Trainer: ${trainer}  Pending`);
    writeActivityLog({
      actionType:  'Assignment',
      description: 'Trainer assigned - status set to Pending',
      module:      'Dashboard',
      recordType:  'Enquiry',
      recordId:    String(currentAssignRow._rowNum),
      before:      currentAssignRow.status || 'Unassigned',
      after:       'Pending - Trainer: ' + trainer,
      reason:      'Manual',
      source:      'Dashboard Button',
      company:     getCompanyName(currentAssignRow),
      trainer,
    });
    showToast(`Assigned to ${trainer}  status set to Pending`, 'success');
    closeAssignModal();
    await loadData();
  } catch(e) { showToast('Error updating  try again', 'error'); }
}

// ===================== BOOK MODAL =====================
function openBookModal(idx) {
  const r = allData.find(x => x._idx === idx);
  if(!r) return;
  currentBookRow = r;
  document.getElementById('bookModalCompany').textContent = getCompanyName(r) + '  ' + r.contact;
  document.getElementById('bookDate').value = r.preferredDate || '';
  document.getElementById('bookDays').value = r.trainingDays || 1;
  document.getElementById('bookValue').value = r.invoiceValue || '';
  document.getElementById('bookValueHint').textContent = r.quotedValue ? 'Quoted: ' + fmtMoney(r.quotedValue) : 'No quoted value on record';

  // Pre-fill training type  clear it if it's "Help me choose" so admin must pick a real one
  const typeEl   = document.getElementById('bookTrainingType');
  const hintEl   = document.getElementById('bookTypeHint');
  const HELP_VAL = 'Not sure yet - please help me choose';
  const currentType = (r.trainingOption || '').trim();
  if(currentType && currentType !== HELP_VAL && TRAINING_OPTIONS[currentType]) {
    typeEl.value = currentType;
    hintEl.textContent = '';
  } else {
    typeEl.value = '';
    hintEl.textContent = currentType === HELP_VAL
      ? ' Client selected "Help me choose"  please confirm the actual type before booking.'
      : 'No training type selected yet.';
    hintEl.style.color = '#c0303d';
  }

  const sel = document.getElementById('bookTrainer');
  sel.innerHTML = '<option value=""> Select trainer </option>';
  trainers.filter(u => u.role === 'trainer' || u.role === 'admin').forEach(t => sel.innerHTML += `<option value="${t.name}" ${r.trainer===t.name?'selected':''}>${t.name}</option>`);
  document.getElementById('bookWarnings').innerHTML = '';
  document.getElementById('bookingOverrideRow').style.display = 'none';
  document.getElementById('bookingBlockMsg').style.display = 'none';
  document.getElementById('confirmBookBtn').disabled = false;
  // Gate: if skipped sections exist, block booking date until trainer completes them
  const skipped = getSkippedSections(r);
  const blockMsg = document.getElementById('bookingBlockMsg');
  const confirmBtn = document.getElementById('confirmBookBtn');
  if(skipped.length) {
    blockMsg.style.display = 'block';
    blockMsg.textContent = ' Cannot set a booking date until the following sections are completed: ' + skipped.join(', ') + '. Open the enquiry profile to fill them in.';
    confirmBtn.disabled = true;
    document.getElementById('bookDate').disabled = true;
  } else {
    document.getElementById('bookDate').disabled = false;
  }
  document.getElementById('bookOverlay').classList.add('open');
}

function closeBookModal() { document.getElementById('bookOverlay').classList.remove('open'); document.getElementById('bookDate').disabled = false; currentBookRow = null; }

function checkBookingWarnings() {
  if(!currentBookRow) return;
  const date     = document.getElementById('bookDate').value;
  const days     = parseInt(document.getElementById('bookDays').value) || 1;
  const trainer  = document.getElementById('bookTrainer').value;
  const typeVal  = document.getElementById('bookTrainingType').value;
  const override = document.getElementById('bookingOverride')?.checked;
  const warnEl     = document.getElementById('bookWarnings');
  const overrideRow = document.getElementById('bookingOverrideRow');
  const blockMsg   = document.getElementById('bookingBlockMsg');
  const btn        = document.getElementById('confirmBookBtn');
  warnEl.innerHTML = '';
  overrideRow.style.display = 'none';
  blockMsg.style.display = 'none';
  btn.disabled = false;

  // Training type is always required  block immediately if not set
  if(!typeVal) {
    blockMsg.textContent = ' Please select a training type before confirming.';
    blockMsg.style.display = 'block';
    btn.disabled = true;
    return;
  }

  if(!date || !trainer) return;

  const bookD = new Date(date);
  let warnings = [];
  let blocking  = false;

  // 1. Double-booking check (existing bookings)
  const conflicts = allData.filter(r => r.trainer === trainer && r.status === 'Booked' && r.bookedOn && r._idx !== currentBookRow._idx);
  conflicts.forEach(r => {
    const rStart = new Date(r.bookedOn); rStart.setHours(0,0,0,0);
    const rEnd   = new Date(rStart); rEnd.setDate(rEnd.getDate() + (r.trainingDays||1));
    if(bookD >= rStart && bookD < rEnd) {
      warnings.push(`<div class="warning-box warn"><span></span><span>${trainer} already has a booking on or around ${fmtDate(bookD)}.</span></div>`);
      blocking = true;
    }
  });

  // 2. Trainer leave check across all training days
  let leaveDays = [];
  for(let i = 0; i < days; i++) {
    const d = new Date(bookD); d.setDate(d.getDate() + i);
    const iso = d.toISOString().split('T')[0];
    if(isTrainerOnLeave(trainer, iso)) leaveDays.push(fmtDate(d));
  }
  if(leaveDays.length) {
    warnings.push(`<div class="warning-box warn" style="border-color:#c0303d;background:#fff0f0;"><span></span><span><strong>${trainer} is on leave</strong> on: ${leaveDays.join(', ')}. Check their Humaans calendar before confirming.</span></div>`);
    blocking = true;
  }

  // 3. Provisional date soft warning  non-blocking, just a heads-up
  Object.entries(provisionalDates).forEach(([rowNum, prov]) => {
    if(prov.date === date && prov.trainer === trainer && String(rowNum) !== String(currentBookRow._rowNum)) {
      warnings.push(`<div class="warning-box warn" style="background:#fffbeb;border-color:#f59e0b;">
        <span></span>
        <span>This date is currently being <strong>discussed provisionally</strong> with <strong>${escHtml(prov.company)}</strong> for ${escHtml(trainer)}${prov.note ? '  ' + escHtml(prov.note) : ''}. Are you sure you want to confirm a different booking here?</span>
      </div>`);
      // Soft warning only  does not block or require override
    }
  });

  // 4. Bank holiday info
  if(isBankHoliday(bookD)) {
    warnings.push(`<div class="warning-box info"><span></span><span>${fmtDate(bookD)} is a UK bank holiday.</span></div>`);
  }

  warnEl.innerHTML = warnings.join('');
  if(blocking) {
    overrideRow.style.display = 'block';
    if(!override) {
      blockMsg.textContent = 'Tick the override box to confirm despite the conflict above';
      blockMsg.style.display = 'block';
      btn.disabled = true;
    }
  }
}

async function confirmBook() {
  const date      = document.getElementById('bookDate').value;
  const days      = parseInt(document.getElementById('bookDays').value) || 1;
  const trainer   = document.getElementById('bookTrainer').value;
  const value     = document.getElementById('bookValue').value;
  const typeVal   = document.getElementById('bookTrainingType').value;
  if(!date || !trainer || !typeVal || !currentBookRow) return;
  const params = new URLSearchParams({
    action: 'assign', row: currentBookRow._rowNum,
    status: 'Booked', trainer, bookedOn: date,
    trainingDays: days, value: value || '',
    option: typeVal,   // save confirmed training type back to sheet
  });
  try {
    await fetch(SCRIPT_URL + '?' + params.toString(), { method: 'GET', redirect: 'follow' });
    logActivity(currentUser?.name||'?', 'Confirmed booking', getCompanyName(currentBookRow), `${trainer}  ${fmtDate(new Date(date))}  ${days}d  ${fmtMoney(parseFloat(value)||0)}`);
    writeActivityLog({
      actionType:  'Status Change',
      description: 'Status changed from ' + (currentBookRow.status||'Pending') + ' to Booked',
      module:      'Dashboard',
      recordType:  'Booking',
      recordId:    String(currentBookRow._rowNum),
      before:      currentBookRow.status || 'Pending',
      after:       `Booked  ${trainer}  ${fmtDate(new Date(date))}  ${days}d  ${fmtMoney(parseFloat(value)||0)}`,
      reason:      'Manual',
      source:      'Dashboard Button',
      company:     getCompanyName(currentBookRow),
      trainer,
    });
    showToast('Booking confirmed!', 'success');
    closeBookModal();
    await loadData();
  } catch(e) { showToast('Error confirming booking', 'error'); }
}

// ===================== EDIT BOOKING MODAL =====================
function openEditBookingModal(idx) {
  const r = allData.find(x => x._idx === idx);
  if(!r) return;
  currentEditRow = r;
  document.getElementById('editBookingCompany').textContent = getCompanyName(r);
  document.getElementById('editBookDate').value = r.bookedOn ? r.bookedOn.toISOString().split('T')[0] : '';
  document.getElementById('editBookDays').value = r.trainingDays || 1;
  document.getElementById('editBookValue').value = r.invoiceValue || '';
  document.getElementById('editBookReason').value = '';
  const sel = document.getElementById('editBookTrainer');
  sel.innerHTML = '<option value=""> Select trainer </option>';
  trainers.filter(u => u.role === 'trainer' || u.role === 'admin').forEach(t => sel.innerHTML += `<option value="${t.name}" ${r.trainer===t.name?'selected':''}>${t.name}</option>`);
  document.getElementById('editBookingWarnings').innerHTML = '';
  document.getElementById('editBookingOverrideRow').style.display = 'none';
  document.getElementById('editBookingBlockMsg').style.display = 'none';
  document.getElementById('confirmEditBookBtn').disabled = false;
  document.getElementById('editBookingOverlay').classList.add('open');
}

function closeEditBookingModal() { document.getElementById('editBookingOverlay').classList.remove('open'); currentEditRow = null; }

function checkEditWarnings() {
  if(!currentEditRow) return;
  const date = document.getElementById('editBookDate').value;
  const days = parseInt(document.getElementById('editBookDays').value) || 1;
  const trainer = document.getElementById('editBookTrainer').value;
  const override = document.getElementById('editBookingOverride')?.checked;
  const warnEl = document.getElementById('editBookingWarnings');
  const overrideRow = document.getElementById('editBookingOverrideRow');
  const blockMsg = document.getElementById('editBookingBlockMsg');
  const btn = document.getElementById('confirmEditBookBtn');
  warnEl.innerHTML = ''; overrideRow.style.display = 'none'; blockMsg.style.display = 'none'; btn.disabled = false;
  if(!date || !trainer) return;

  const bookD = new Date(date);
  let warnings = [];
  let blocking = false;

  // 1. Double-booking check
  const conflicts = allData.filter(r => r.trainer === trainer && r.status === 'Booked' && r.bookedOn && r._idx !== currentEditRow._idx);
  conflicts.forEach(r => {
    const rStart = new Date(r.bookedOn); rStart.setHours(0,0,0,0);
    const rEnd = new Date(rStart); rEnd.setDate(rEnd.getDate() + (r.trainingDays||1));
    if(bookD >= rStart && bookD < rEnd) {
      warnings.push(`<div class="warning-box warn"><span></span><span>${trainer} already has a booking on or around ${fmtDate(bookD)}.</span></div>`);
      blocking = true;
    }
  });

  // 2. Leave check across all training days
  let leaveDays = [];
  for(let i = 0; i < days; i++) {
    const d = new Date(bookD); d.setDate(d.getDate() + i);
    const iso = d.toISOString().split('T')[0];
    if(isTrainerOnLeave(trainer, iso)) leaveDays.push(fmtDate(d));
  }
  if(leaveDays.length) {
    warnings.push(`<div class="warning-box warn" style="border-color:#c0303d;background:#fff0f0;"><span></span><span><strong>${trainer} is on leave</strong> on: ${leaveDays.join(', ')}. Check their Humaans calendar before confirming.</span></div>`);
    blocking = true;
  }

  warnEl.innerHTML = warnings.join('');
  if(blocking) {
    overrideRow.style.display = 'block';
    if(!override) { blockMsg.textContent = 'Tick the override box to confirm despite the conflict above'; blockMsg.style.display = 'block'; btn.disabled = true; }
  }
}

async function confirmEditBooking() {
  const date = document.getElementById('editBookDate').value;
  const days = parseInt(document.getElementById('editBookDays').value) || 1;
  const trainer = document.getElementById('editBookTrainer').value;
  const value = document.getElementById('editBookValue').value;
  const reason = document.getElementById('editBookReason').value.trim();
  if(!date || !trainer || !currentEditRow) return;
  const params = new URLSearchParams({ action: 'assign', row: currentEditRow._rowNum, status: 'Booked', trainer, bookedOn: date, trainingDays: days, value: value || '' });
  try {
    // Auto-save amendment note into profile progress notes before fetch
    if(reason) {
      if(!currentEditRow.notes) currentEditRow.notes = [];
      const amendText = 'Amendment: ' + reason + ` (${trainer}, ${fmtDate(new Date(date))}, ${days}d)`;
      const amendNote = { text: amendText, author: currentUser?.name || 'Admin', ts: Date.now() };
      currentEditRow.notes.push(amendNote);
      writeNoteToSheet(currentEditRow._rowNum, getCompanyName(currentEditRow), amendText, 'Booking Edit');
    }
    await fetch(SCRIPT_URL + '?' + params.toString(), { method: 'GET', redirect: 'follow' });
    logActivity(currentUser?.name||'?', 'Edited booking', getCompanyName(currentEditRow), `${trainer}  ${fmtDate(new Date(date))}  ${days}d${reason?'  '+reason:''}`);
    if(reason) logNote(currentUser?.name||'?', 'Amendment note', getCompanyName(currentEditRow), reason + ` (${trainer}, ${fmtDate(new Date(date))}, ${days}d)`);
    writeActivityLog({
      actionType:  'Status Change',
      description: 'Booking edited',
      module:      'Dashboard',
      recordType:  'Booking',
      recordId:    String(currentEditRow._rowNum),
      before:      `${currentEditRow.trainer||'?'}  ${fmtDate(currentEditRow.bookedOn)}  ${currentEditRow.trainingDays||1}d  ${fmtMoney(currentEditRow.invoiceValue||0)}`,
      after:       `${trainer}  ${fmtDate(new Date(date))}  ${days}d  ${fmtMoney(parseFloat(value)||0)}`,
      reason:      reason || 'Manual edit',
      source:      'Dashboard Button',
      company:     getCompanyName(currentEditRow),
      trainer,
      notes:       reason || '',
    });
    showToast('Booking updated', 'success');
    closeEditBookingModal();
    await loadData();
  } catch(e) { showToast('Error updating booking', 'error'); }
}

// ===================== CANCEL MODAL =====================
function openCancelModal(idx) {
  const r = allData.find(x => x._idx === idx);
  if(!r) return;
  currentCancelRow = r;
  document.getElementById('cancelModalCompany').textContent = getCompanyName(r);
  document.getElementById('cancelReason').value = '';
  document.getElementById('cancelOverlay').classList.add('open');
}

function closeCancelModal() { document.getElementById('cancelOverlay').classList.remove('open'); currentCancelRow = null; }

// ===================== PROVISIONAL DATES =====================
let currentProvisionalRow = null;

function openProvisionalModal(idx) {
  const r = allData.find(x => x._idx === idx);
  if(!r) return;
  currentProvisionalRow = r;
  document.getElementById('provisionalModalCompany').textContent = getCompanyName(r) + '  ' + (r.trainer || 'No trainer assigned');
  // Pre-fill trainer from record
  const sel = document.getElementById('provisionalTrainer');
  sel.innerHTML = '<option value=""> Select trainer </option>';
  trainers.filter(u => u.role === 'trainer' || u.role === 'admin')
    .forEach(t => sel.innerHTML += `<option value="${t.name}" ${r.trainer===t.name?'selected':''}>${t.name}</option>`);
  // Pre-fill existing provisional if set
  const existing = provisionalDates[r._rowNum];
  if(existing) {
    document.getElementById('provisionalDate').value   = existing.date    || '';
    document.getElementById('provisionalNote').value   = existing.note    || '';
    sel.value = existing.trainer || (r.trainer || '');
    document.getElementById('provisionalClearBtn').style.display = 'inline-flex';
  } else {
    document.getElementById('provisionalDate').value   = r.preferredDate  || '';
    document.getElementById('provisionalNote').value   = '';
    document.getElementById('provisionalClearBtn').style.display = 'none';
  }
  document.getElementById('provisionalOverlay').classList.add('open');
}

function closeProvisionalModal() {
  document.getElementById('provisionalOverlay').classList.remove('open');
  currentProvisionalRow = null;
}

function saveProvisionalDate() {
  if(!currentProvisionalRow) return;
  const date    = document.getElementById('provisionalDate').value;
  const trainer = document.getElementById('provisionalTrainer').value;
  const note    = document.getElementById('provisionalNote').value.trim();
  if(!date || !trainer) { showToast('Please select a date and trainer', 'error'); return; }
  const rowNum  = currentProvisionalRow._rowNum;
  provisionalDates[rowNum] = {
    date, trainer, note,
    company: getCompanyName(currentProvisionalRow),
    rowIdx:  currentProvisionalRow._idx,
  };
  localStorage.setItem('provisionalDates', JSON.stringify(provisionalDates));
  showToast('Provisional date set  ' + fmtDate(new Date(date)) + ' with ' + trainer, 'success');
  closeProvisionalModal();
  renderActionNeeded();
  renderCalendar();
}

function clearProvisionalDate() {
  if(!currentProvisionalRow) return;
  delete provisionalDates[currentProvisionalRow._rowNum];
  localStorage.setItem('provisionalDates', JSON.stringify(provisionalDates));
  showToast('Provisional date removed', 'success');
  closeProvisionalModal();
  renderActionNeeded();
  renderCalendar();
}

async function confirmCancel() {
  const reason = document.getElementById('cancelReason').value.trim();
  if(!reason || !currentCancelRow) return;
  // Auto-save cancellation reason into profile progress notes
  if(!currentCancelRow.notes) currentCancelRow.notes = [];
  const cancelText = 'Cancellation: ' + reason;
  const cancelNote = { text: cancelText, author: currentUser?.name || 'Admin', ts: Date.now() };
  currentCancelRow.notes.push(cancelNote);
  writeNoteToSheet(currentCancelRow._rowNum, getCompanyName(currentCancelRow), cancelText, 'Cancellation');
  const params = new URLSearchParams({ action: 'assign', row: currentCancelRow._rowNum, status: 'Cancelled' });
  try {
    await fetch(SCRIPT_URL + '?' + params.toString(), { method: 'GET', redirect: 'follow' });
    logActivity(currentUser?.name||'?', 'Cancelled enquiry', getCompanyName(currentCancelRow), reason);
    logNote(currentUser?.name||'?', 'Cancellation note', getCompanyName(currentCancelRow), reason);
    writeActivityLog({
      actionType:  'Cancellation',
      description: 'Enquiry cancelled',
      module:      'Dashboard',
      recordType:  'Enquiry',
      recordId:    String(currentCancelRow._rowNum),
      before:      currentCancelRow.status || 'Active',
      after:       'Cancelled',
      reason:      reason,
      source:      'Dashboard Button',
      company:     getCompanyName(currentCancelRow),
      trainer:     currentCancelRow.trainer || '',
      notes:       reason,
    });
    showToast('Enquiry cancelled', 'success');
    closeCancelModal();
    await loadData();
  } catch(e) { showToast('Error cancelling', 'error'); }
}

// ===================== TRAINER MODAL =====================
// ===================== USER PERMISSIONS MODAL =====================
function openTrainerModal() { openPermModal(); }
function closeTrainerModal() { closePermModal(); }

function openPermModal() {
  selectedPermUserId = null;
  renderPermUserList();
  _populateDeptDropdowns();
  document.getElementById('permOverlay').classList.add('open');
  document.getElementById('permDetail').innerHTML = '<div style="padding:40px;text-align:center;color:var(--text--dark--30);font-size:12px;"> Select a user to configure their permissions</div>';
  document.getElementById('savePermBtn').style.display = 'none';
  document.getElementById('shadowPermBtn').style.display = 'none';
  document.getElementById('deactivatePermBtn').style.display = 'none';
}

function closePermModal() { document.getElementById('permOverlay').classList.remove('open'); }

function renderPermUserList() {
  const list = document.getElementById('permUserList');
  if(!trainers.length) { list.innerHTML = '<div style="padding:16px;font-size:12px;color:var(--text--dark--30);">No users.</div>'; return; }
  // Show active users first, then inactive
  const sorted = [...trainers].sort((a, b) => {
    const aActive = a.active !== false;
    const bActive = b.active !== false;
    if(aActive === bActive) return (a.name||'').localeCompare(b.name||'');
    return aActive ? -1 : 1;
  });
  list.innerHTML = sorted.map(t => {
    const isSelected = t.id === selectedPermUserId;
    const isActive   = t.active !== false;
    const roleTag    = `<span class="perm-user-role-tag ${t.role}">${t.role}</span>`;
    const inactiveTag = !isActive ? `<span style="font-size:9px;font-weight:700;padding:1px 5px;border-radius:4px;background:#fee2e2;color:#991b1b;margin-left:4px;">inactive</span>` : '';
    return `<div class="perm-user-row ${isSelected?'active':''}" onclick="selectPermUser('${t.id}')"
      style="${!isActive ? 'opacity:0.5;' : ''}">
      <div style="width:10px;height:10px;border-radius:50%;background:${isActive?(t.color||'#888'):'#ccc'};flex-shrink:0;"></div>
      <div style="flex:1;min-width:0;">
        <div class="perm-user-name">${escHtml(t.name)}</div>
        <div style="margin-top:2px;display:flex;align-items:center;flex-wrap:wrap;gap:2px;">${roleTag}${inactiveTag}</div>
      </div>
    </div>`;
  }).join('');
}

function selectPermUser(uid) {
  selectedPermUserId = uid;
  renderPermUserList();
  const t = trainers.find(u => u.id === uid);
  if(!t) return;
  const perms = userPerms(t);
  const defaults = ROLE_DEFAULTS[t.role] || ROLE_DEFAULTS.viewer;
  let html = `<div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;padding-bottom:14px;border-bottom:1px solid var(--ui--underline--light-grey);">
    <div style="width:36px;height:36px;border-radius:50%;background:${t.active!==false?(t.color||'#888'):'#ccc'};display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:700;color:#fff;flex-shrink:0;">${t.name.charAt(0).toUpperCase()}</div>
    <div style="flex:1;">
      <div style="font-size:14px;font-weight:700;color:var(--text--dark--50);">${escHtml(t.name)}</div>
      <div style="font-size:11px;color:var(--text--dark--30);margin-top:2px;">
        <strong>${t.role}</strong>
        ${t.department ? ' &middot; ' + escHtml(t.department) : ''}
        &middot; PIN: ${t.pin?'set':'none'}
        ${t.email ? ' &middot; ' + escHtml(t.email) : ''}
      </div>
    </div>
    <select style="border:1px solid var(--light-grey);border-radius:6px;padding:5px 10px;font-size:12px;font-family:Arial,sans-serif;" onchange="changePermUserRole('${uid}',this.value)">
      <option value="viewer"  ${t.role==='viewer' ?'selected':''}>Viewer</option>
      <option value="manager" ${t.role==='manager'?'selected':''}>Manager</option>
      <option value="trainer" ${t.role==='trainer'?'selected':''}>Trainer</option>
      <option value="admin"   ${t.role==='admin'  ?'selected':''}>Admin</option>
    </select>
    <input type="color" value="${t.color||'#2147f4'}" title="Colour" style="width:28px;height:28px;border:none;cursor:pointer;border-radius:50%;background:none;padding:0;" onchange="changeTrainerColor(trainers.findIndex(u=>u.id==='${uid}'),this.value)">
    <button class="btn btn-ghost btn-sm" onclick="setTrainerPin(trainers.findIndex(u=>u.id==='${uid}'))">PIN</button>
    <button class="btn btn-danger btn-sm" onclick="removeTrainerById('${uid}')"></button>
  </div>`;

  // Inactive banner
  if(t.active === false) {
    html += `<div style="background:#fee2e2;border:1px solid #fca5a5;border-radius:6px;padding:10px 14px;margin-bottom:16px;font-size:12px;color:#991b1b;font-weight:600;">
      &#9888; This user is deactivated and cannot log in. Use the Reactivate button below to restore access.
    </div>`;
  }

  Object.entries(PERM_SECTIONS).forEach(([section, keys]) => {
    html += `<div class="perm-section-title">${section}</div><div class="perm-grid">`;
    keys.forEach(key => {
      const info = PERM_LABELS[key] || { label: key, sub: '' };
      const checked = perms[key] ? 'checked' : '';
      const isDefault = perms[key] === defaults[key];
      html += `<div class="perm-toggle-row">
        <div>
          <div class="perm-toggle-label">${info.label}${!isDefault?'<span style="color:#f59e0b;font-size:9px;margin-left:4px;"></span>':''}</div>
          <div class="perm-toggle-sub">${info.sub}</div>
        </div>
        <label class="perm-toggle">
          <input type="checkbox" ${checked} onchange="setPermOverride('${uid}','${key}',this.checked)">
          <span class="perm-toggle-slider"></span>
        </label>
      </div>`;
    });
    html += '</div>';
  });

  html += `<div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--ui--underline--light-grey);">
    <button class="btn btn-ghost btn-sm" onclick="resetPermToRole('${uid}')" style="font-size:11px;"> Reset to role defaults</button>
  </div>`;

  document.getElementById('permDetail').innerHTML = html;
  document.getElementById('savePermBtn').style.display = 'inline-flex';
  // Don't allow shadowing yourself
  const isSelf = currentUser && currentUser.id === uid;
  document.getElementById('shadowPermBtn').style.display = isSelf ? 'none' : 'inline-flex';
  // Deactivate / Reactivate button
  const isActive = t.active !== false;
  const deactBtn = document.getElementById('deactivatePermBtn');
  deactBtn.style.display = isSelf ? 'none' : 'inline-flex';
  if(isActive) {
    deactBtn.textContent = 'Deactivate';
    deactBtn.style.background = '#fff';
    deactBtn.style.color = '#c0303d';
    deactBtn.style.border = '1.5px solid #c0303d';
  } else {
    deactBtn.textContent = 'Reactivate';
    deactBtn.style.background = '#fff';
    deactBtn.style.color = '#22a06b';
    deactBtn.style.border = '1.5px solid #22a06b';
  }
}

function changePermUserRole(uid, role) {
  const t = trainers.find(u => u.id === uid);
  if(!t) return;
  t.role = role;
  saveUsers();
  // Re-render with new defaults
  selectPermUser(uid);
  renderPermUserList();
}

function setPermOverride(uid, key, val) {
  const t = trainers.find(u => u.id === uid);
  if(!t) return;
  if(!t.customPerms) t.customPerms = {};
  const defaultVal = (ROLE_DEFAULTS[t.role] || ROLE_DEFAULTS.viewer)[key];
  if(val === defaultVal) {
    delete t.customPerms[key];
  } else {
    t.customPerms[key] = val;
  }

  // Auto-enable logic: if an action right is turned on, force the
  // relevant queue views on too so they can actually see what to act on.
  const ACTION_NEEDS_QUEUES = ['assignTrainer', 'confirmBooking', 'cancelBooking'];
  if(val === true && ACTION_NEEDS_QUEUES.includes(key)) {
    ['viewUnassigned', 'viewPending'].forEach(viewKey => {
      const viewDefault = (ROLE_DEFAULTS[t.role] || ROLE_DEFAULTS.viewer)[viewKey];
      if(!userPerms(t)[viewKey]) {
        t.customPerms[viewKey] = true;
        // Reflect in the UI immediately
        const chk = document.querySelector(`input[onchange*="'${viewKey}'"]`);
        if(chk) chk.checked = true;
      }
      // Clean up override if it now matches role default
      if(t.customPerms[viewKey] === viewDefault) delete t.customPerms[viewKey];
    });
  }
}

function savePermissions() {
  saveUsers();
  if(selectedPermUserId) {
    const t = trainers.find(u => u.id === selectedPermUserId);
    if(t) writeActivityLog({
      actionType:  'User Management',
      description: 'Permissions updated for ' + t.name,
      module:      'Settings',
      recordType:  'User',
      recordId:    t.id,
      before:      t.role + ' defaults',
      after:       Object.keys(t.customPerms||{}).length
        ? 'Custom: ' + JSON.stringify(t.customPerms).slice(0,120)
        : t.role + ' defaults (no overrides)',
      reason:      'Manual',
      source:      'Dashboard Button',
      notes:       'Role: ' + t.role,
    });
  }
  showToast('Permissions saved', 'success');
}

function resetPermToRole(uid) {
  const t = trainers.find(u => u.id === uid);
  if(!t) return;
  t.customPerms = {};
  saveUsers();
  selectPermUser(uid);
  showToast('Reset to role defaults', 'info');
}

async function toggleDeactivateUser() {
  if(!selectedPermUserId) return;
  const t = trainers.find(u => u.id === selectedPermUserId);
  if(!t) return;
  const isActive   = t.active !== false;
  const action     = isActive ? 'deactivate' : 'reactivate';
  const confirmMsg = isActive
    ? `Deactivate ${t.name}? They will not be able to log in until reactivated.`
    : `Reactivate ${t.name}? They will be able to log in again.`;
  if(!confirm(confirmMsg)) return;

  t.active = !isActive;

  // Write Active = TRUE/FALSE to col F on the Users sheet
  // saveUsers() calls saveUser for every user  but we want to be precise here.
  // Directly call saveUser with just the active flag change.
  try {
    const [fn, ...rest] = (t.name || '').split(' ');
    const params = new URLSearchParams({
      action:      'saveUser',
      userId:      t.id,
      firstName:   t.firstName || fn || t.name,
      lastName:    t.lastName  || rest.join(' ') || '',
      department:  t.department || t.jobTitle || '',
      role:        t.role || 'viewer',
      active:      t.active ? 'true' : 'false',
      addedBy:     currentUser?.name || '',
      notes:       t.notes || '',
      customPerms: (t.customPerms && Object.keys(t.customPerms).length) ? JSON.stringify(t.customPerms) : '',
      color:       t.color || '',
      pin:         t.pin   || '',
      email:       t.email || '',
    });
    await fetch(SCRIPT_URL + '?' + params.toString(), { method:'GET', redirect:'follow' });
  } catch(e) {
    console.warn('toggleDeactivateUser sheet write failed:', e.message);
  }

  // Keep local cache in sync
  localStorage.setItem('dashUsersCache', JSON.stringify(trainers));

  // Remove from login dropdown if deactivated
  populateLoginSelect();

  // Re-render so sidebar and detail panel reflect new state
  selectPermUser(selectedPermUserId);
  renderPermUserList();

  writeActivityLog({
    actionType:  'User Management',
    description: t.name + (t.active ? ' reactivated' : ' deactivated'),
    module:      'Settings',
    recordType:  'User',
    recordId:    t.id,
    before:      t.active ? 'Inactive' : 'Active',
    after:       t.active ? 'Active'   : 'Inactive',
    reason:      'Manual',
    source:      'Dashboard Button',
    company:     '',
    trainer:     t.role === 'trainer' ? t.name : '',
    notes:       'Role: ' + t.role,
  });
  showToast(
    t.name + (t.active ? ' reactivated' : ' deactivated'),
    t.active ? 'success' : 'info'
  );
}

function removeTrainerById(uid) {
  const t = trainers.find(u => u.id === uid);
  if(!t || !confirm('Remove ' + t.name + '?')) return;
  deleteUserFromSheet(uid);
  trainers.splice(trainers.findIndex(u => u.id === uid), 1);
  saveUsers();
  selectedPermUserId = null;
  document.getElementById('permDetail').innerHTML = '<div style="padding:40px;text-align:center;color:var(--text--dark--30);font-size:12px;"> Select a user to configure their permissions</div>';
  document.getElementById('savePermBtn').style.display = 'none';
  document.getElementById('shadowPermBtn').style.display = 'none';
  document.getElementById('deactivatePermBtn').style.display = 'none';
  renderPermUserList();
  populateLoginSelect();
}

function renderTrainerList() { renderPermUserList(); }

function changeTrainerRole(i, role) { trainers[i].role = role; saveUsers(); renderPermUserList(); }
function changeTrainerColor(i, color) { trainers[i].color = color; saveUsers(); }
function removeTrainer(i) { removeTrainerById(trainers[i]?.id); }
function addTrainer() {
  const name = document.getElementById('newTrainerName').value.trim();
  const role = document.getElementById('newTrainerRole').value;
  const dept = document.getElementById('permUserDept')?.value || '';
  if(!name) return;
  const [fn, ...rest] = name.split(' ');
  const newUser = {
    id: 'u_' + Date.now(),
    name,
    firstName: fn,
    lastName: rest.join(' '),
    role,
    color: TRAINER_COLORS[trainers.length % TRAINER_COLORS.length],
    pin: '', icsUrl: '', customPerms: {},
    department: dept, jobTitle: dept,
    active: true,
    addedBy: currentUser?.name || '',
    dateAdded: new Date().toISOString()
  };
  trainers.push(newUser);
  saveUsers();
  document.getElementById('newTrainerName').value = '';
  if(document.getElementById('permUserDept')) document.getElementById('permUserDept').value = '';
  renderPermUserList();
  populateLoginSelect();
  _populateDeptDropdowns();
  writeActivityLog({
    actionType:  'User Management',
    description: name + ' added as ' + role,
    module:      'Settings',
    recordType:  'User',
    recordId:    newUser.id,
    before:      '',
    after:       'Active  ' + role + (dept ? '  ' + dept : ''),
    reason:      'Manual',
    source:      'Dashboard Button',
    notes:       'Department: ' + (dept || 'not set'),
  });
  showToast(name + ' added as ' + role, 'success');
}

function setTrainerPin(i) {
  const pin = prompt(`Set PIN for ${trainers[i].name} (46 digits, leave blank to clear):`);
  if(pin === null) return;
  if(pin !== '' && (pin.length < 4 || pin.length > 6 || !/^\d+$/.test(pin))) { alert('PIN must be 46 digits'); return; }
  trainers[i].pin = pin;
  saveUsers();
  renderTrainerList();
  showToast(`PIN ${pin ? 'set' : 'cleared'} for ${trainers[i].name}`, 'success');
}

function changeMyPin() {
  if(!currentUser) return;
  const idx = trainers.findIndex(u => u.id === currentUser.id);
  if(idx < 0) return;
  const pin = prompt('Enter new PIN (46 digits, blank to clear):');
  if(pin === null) return;
  if(pin !== '' && (pin.length < 4 || pin.length > 6 || !/^\d+$/.test(pin))) { alert('PIN must be 46 digits'); return; }
  trainers[idx].pin = pin;
  currentUser.pin = pin;
  saveUsers();
  showToast('PIN updated', 'success');
}

// ===================== CAL SETTINGS =====================
function openCalSettings() {
  document.getElementById('calHolidayIcsInput').value = calSettingsHolidayIcs;
  document.getElementById('calLeaveIcsInput').value = calSettingsLeaveIcs;
  document.getElementById('calSettingsStatus').textContent = '';
  document.getElementById('calSettingsOverlay').classList.add('open');
}

function closeCalSettings() { document.getElementById('calSettingsOverlay').classList.remove('open'); }

function saveCalSettings() {
  calSettingsHolidayIcs = document.getElementById('calHolidayIcsInput').value.trim();
  calSettingsLeaveIcs = document.getElementById('calLeaveIcsInput').value.trim();
  localStorage.setItem('calHolidayIcs', calSettingsHolidayIcs);
  localStorage.setItem('calLeaveIcs', calSettingsLeaveIcs);
  document.getElementById('calSettingsStatus').textContent = 'Saved  syncing';
  closeCalSettings();
  loadIcsData().then(() => showToast('Calendar settings saved & synced', 'success'));
}

// ===================== NOTIFICATIONS =====================
function openNotifPanel() {
  // Mark unread items as read after a short delay (user has seen them)
  document.getElementById('notifPanel').classList.add('open');
  document.getElementById('notifPanelOverlay').classList.add('open');
  renderNotifPanel();
}

function closeNotifPanel() {
  document.getElementById('notifPanel').classList.remove('open');
  document.getElementById('notifPanelOverlay').classList.remove('open');
}

function switchNotifTab(tab) {
  notifCurrentTab = tab;
  document.getElementById('notifTabEvents').classList.toggle('active', tab === 'event');
  document.getElementById('notifTabNotes').classList.toggle('active', tab === 'note');
  renderNotifPanel();
}

// Save a log entry of type 'event' or 'note'
function _addNotif(type, who, what, company, detail) {
  const id = Date.now() + '_' + Math.random().toString(36).slice(2, 6);
  const entry = { id, type, who, what, company, detail, ts: Date.now() };
  activityLog.unshift(entry);
  if(activityLog.length > 200) activityLog = activityLog.slice(0, 200);
  notifUnread.add(id);
  localStorage.setItem('dashActivityLog', JSON.stringify(activityLog));
  localStorage.setItem('dashNotifUnread', JSON.stringify([...notifUnread]));
  updateBellBadge();
  renderNotifPanel();
  // Toast popup
  const typeLabel = type === 'note' ? ' Note' : ' Event';
  showToast(`${typeLabel}: ${what}${company ? '  ' + company : ''}`, 'info', 4000);
  // Nav dot
  const dot = document.getElementById('navActivityDot');
  if(dot) dot.style.display = 'block';
}

function logActivity(who, what, company, detail) { _addNotif('event', who, what, company, detail); }
function logNote(who, what, company, detail) { _addNotif('note', who, what, company, detail); }

function markNotifRead(id) {
  notifUnread.delete(id);
  localStorage.setItem('dashNotifUnread', JSON.stringify([...notifUnread]));
  updateBellBadge();
  renderNotifPanel();
}

function markAllNotifRead() {
  notifUnread.clear();
  localStorage.setItem('dashNotifUnread', '[]');
  updateBellBadge();
  renderNotifPanel();
}

function clearNotifLog() {
  const type = notifCurrentTab;
  activityLog = activityLog.filter(e => e.type !== type);
  // Clean up unread set for deleted entries
  const remaining = new Set(activityLog.map(e => e.id));
  notifUnread = new Set([...notifUnread].filter(id => remaining.has(id)));
  localStorage.setItem('dashActivityLog', JSON.stringify(activityLog));
  localStorage.setItem('dashNotifUnread', JSON.stringify([...notifUnread]));
  updateBellBadge();
  renderNotifPanel();
}

function updateBellBadge() {
  const unreadEvents = activityLog.filter(e => e.type === 'event' && notifUnread.has(e.id)).length;
  const unreadNotes  = activityLog.filter(e => e.type === 'note'  && notifUnread.has(e.id)).length;
  const total = unreadEvents + unreadNotes;
  const bellDot   = document.getElementById('bellDot');
  const bellCount = document.getElementById('bellCount');
  const unreadBadge = document.getElementById('notifUnreadBadge');
  const navDot    = document.getElementById('navActivityDot');
  if(bellDot)    { bellDot.style.display = total > 0 ? 'block' : 'none'; }
  if(bellCount)  { bellCount.style.display = total > 0 ? 'flex' : 'none'; bellCount.textContent = total > 99 ? '99+' : total; }
  if(unreadBadge){ unreadBadge.style.display = total > 0 ? 'inline-flex' : 'none'; unreadBadge.textContent = total; }
  if(navDot)     { navDot.style.display = total > 0 ? 'block' : 'none'; }
  // Tab badges
  const evBadge = document.getElementById('notifTabEventsBadge');
  const ntBadge = document.getElementById('notifTabNotesBadge');
  if(evBadge) { evBadge.style.display = unreadEvents > 0 ? 'inline' : 'none'; evBadge.textContent = unreadEvents; }
  if(ntBadge) { ntBadge.style.display = unreadNotes  > 0 ? 'inline' : 'none'; ntBadge.textContent = unreadNotes; }
}

function renderNotifPanel() {
  const body = document.getElementById('notifFeedBody');
  if(!body) return;
  const filtered = activityLog.filter(e => (e.type || 'event') === notifCurrentTab);
  const unreadInTab = filtered.filter(e => notifUnread.has(e.id)).length;
  document.getElementById('notifCount').textContent =
    filtered.length + ' ' + (notifCurrentTab === 'note' ? 'note' : 'event') + (filtered.length !== 1 ? 's' : '') +
    (unreadInTab > 0 ? `  ${unreadInTab} unread` : '');

  if(!filtered.length) {
    body.innerHTML = `<div class="notif-empty">${notifCurrentTab === 'note' ? '&#128221; No notes yet' : '&#128203; No events yet'}</div>`;
    return;
  }

  body.innerHTML = filtered.map(e => {
    const isUnread = notifUnread.has(e.id);
    const d = new Date(e.ts);
    const timeStr = fmtDate(d) + ' ' + d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
    return `<div class="notif-entry ${isUnread ? 'unread' : 'read'}" id="notif_${e.id}">
      <div class="notif-entry-top">
        <div style="display:flex;gap:8px;align-items:flex-start;min-width:0;">
          <div class="notif-type-dot ${e.type || 'event'}" style="margin-top:5px;"></div>
          <div style="min-width:0;">
            <div class="notif-who">${escHtml(e.who || '')}</div>
            <div class="notif-what">${escHtml(e.what || '')}${e.company ? ' &mdash; <strong>' + escHtml(e.company) + '</strong>' : ''}</div>
            ${e.detail ? `<div class="notif-detail">${escHtml(e.detail)}</div>` : ''}
            <div class="notif-time">${timeStr}</div>
          </div>
        </div>
        ${isUnread ? `<button class="notif-mark-read-btn" onclick="markNotifRead('${e.id}')" title="Mark as read"> Read</button>` : ''}
      </div>
    </div>`;
  }).join('');

  updateBellBadge();
}

// Legacy alias kept for compatibility
function openActivityPanel() { openNotifPanel(); }
function closeActivityPanel() { closeNotifPanel(); }
function renderActivityFeed() { renderNotifPanel(); }

// ===================== REQUEST FORM =====================
let reqCurrentStep = 1;
const REQ_TOTAL_STEPS = 4;
let reqSelectedLocation = '';
const REQ_SKIPPABLE_STEPS = new Set([3, 4]); // Training Details, Priorities & Logistics
const REQ_SKIP_LABELS = { 3: 'Training Details', 4: 'Priorities & Logistics' };
let reqSkippedSteps = new Set();

function openRequestForm() {
  reqCurrentStep = 1;
  reqSelectedLocation = '';
  reqSkippedSteps = new Set();
  document.getElementById('reqOverlay').classList.add('open');
  ['reqReferredByTeam','reqReferralNotes','reqEmail','reqCompany','reqStakeholder','reqAttendees','reqPriorities','reqFeatures','reqChallenges','reqLocAddress','reqLocParking','reqLocEquipOther','reqAnythingElse','reqDietaryReqs'].forEach(id => { const el = document.getElementById(id); if(el) el.value = ''; });
  document.getElementById('reqReferredByName').value = '';
  document.getElementById('reqQuotedValue').value = '';
  document.querySelectorAll('[name="trainingType"],[name="teamFamiliarity"],[name="areas"],[name="followUp"]').forEach(el => el.checked = false);
  document.getElementById('reqLocHQConfirm').style.display = 'none';
  document.getElementById('reqLocOtherFields').style.display = 'none';
  document.getElementById('reqLocHQBtn').classList.remove('selected');
  document.getElementById('reqLocOtherBtn').classList.remove('selected');
  document.getElementById('reqNewUserFields').style.display = 'none';
  document.getElementById('reqExistingTeamRow').style.display = 'none';
  document.querySelectorAll('#reqEquipGrid input').forEach(el => el.checked = false);
  // Reset and initialise search field
  const reqSearch = document.getElementById('reqUserSearch');
  if(reqSearch) reqSearch.value = '';
  document.getElementById('reqUserResults') && (document.getElementById('reqUserResults').style.display = 'none');
  document.getElementById('reqUserChip')    && (document.getElementById('reqUserChip').style.display = 'none');
  document.getElementById('reqUserSearchClear') && (document.getElementById('reqUserSearchClear').style.display = 'none');
  document.getElementById('reqUserPicker').value = '';

  // Pre-fill with current logged-in user
  if(currentUser) {
    reqSelectUser(currentUser.name);
  }
  updateReqStep();
}

function reqSearchFilter() {
  const q   = document.getElementById('reqUserSearch').value.trim().toLowerCase();
  const box = document.getElementById('reqUserResults');

  // If user already confirmed a selection, clear it when they type again
  if(document.getElementById('reqUserPicker').value && q !== document.getElementById('reqUserSearch').dataset.confirmed) {
    reqClearUser(true); // silent clear  don't wipe the input text
  }

  if(q.length < 1) { box.style.display = 'none'; return; }

  const matches = trainers
    .filter(u => u.active !== false && u.name.toLowerCase().includes(q))
    .slice(0, 8);

  // Build rows including "+ Add me" at the bottom
  let html = matches.map(u => {
    const initials = u.name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
    const dept = escHtml(u.department || u.jobTitle || u.role || '');
    return `<div class="req-user-result-row" data-name="${escHtml(u.name)}" tabindex="0"
      style="display:flex;align-items:center;gap:10px;padding:9px 12px;cursor:pointer;border-radius:6px;"
      onmousedown="reqSelectUser('${u.name.replace(/'/g,"\\'")}')">
      <div style="width:28px;height:28px;border-radius:50%;background:${u.color||'#2147f4'};display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;flex-shrink:0;">${initials}</div>
      <div>
        <div style="font-size:13px;font-weight:600;color:var(--text--dark--50);">${escHtml(u.name)}</div>
        <div style="font-size:11px;color:var(--text--dark--30);">${dept}</div>
      </div>
    </div>`;
  }).join('');

  // Always show "+ Add me as a new user" at the bottom
  html += `<div style="border-top:1px solid var(--ui--underline--light-grey);margin-top:2px;padding:8px 12px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:13px;font-weight:600;color:var(--action-primary-blue);"
    onmousedown="reqShowNewUser()">
    <span style="font-size:16px;">&#43;</span> Add me as a new user...
  </div>`;

  box.innerHTML = html;
  box.style.display = 'block';
}

function reqSearchKey(e) {
  const box  = document.getElementById('reqUserResults');
  const rows = box.querySelectorAll('.req-user-result-row');
  if(e.key === 'ArrowDown' && rows.length) { e.preventDefault(); rows[0].focus(); return; }
  if(e.key === 'Escape') { box.style.display = 'none'; return; }
  if(e.key === 'Enter' && rows.length === 1) reqSelectUser(rows[0].dataset.name);
}

function reqSelectUser(name) {
  const u = trainers.find(t => t.name === name);

  // Hide dropdown + show chip
  document.getElementById('reqUserResults').style.display = 'none';
  document.getElementById('reqUserSearch').value = name;
  document.getElementById('reqUserSearch').dataset.confirmed = name.toLowerCase();
  document.getElementById('reqUserSearchClear').style.display = 'block';

  if(u) {
    const initials = name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
    const chip  = document.getElementById('reqUserChip');
    document.getElementById('reqUserChipAvatar').textContent      = initials;
    document.getElementById('reqUserChipAvatar').style.background = u.color || '#2147f4';
    document.getElementById('reqUserChipName').textContent        = name;
    document.getElementById('reqUserChipSub').textContent         = (u.department||u.jobTitle||'') + (u.role ? '  ' + u.role : '');
    chip.style.display = 'flex';
  }

  // Set hidden fields
  document.getElementById('reqUserPicker').value     = name;
  document.getElementById('reqReferredByName').value = name;
  document.getElementById('reqNewUserFields').style.display = 'none';

  if(u) {
    document.getElementById('reqExistingTeamRow').style.display = '';
    const dept = u.department || u.jobTitle || '';
    document.getElementById('reqReferredByTeam').value = dept;
  }
}

function reqClearUser(silent) {
  document.getElementById('reqUserPicker').value     = '';
  document.getElementById('reqReferredByName').value = '';
  document.getElementById('reqUserChip').style.display = 'none';
  document.getElementById('reqExistingTeamRow').style.display = 'none';
  document.getElementById('reqNewUserFields').style.display = 'none';
  document.getElementById('reqUserSearchClear').style.display = 'none';
  document.getElementById('reqUserSearch').dataset.confirmed = '';
  if(!silent) {
    document.getElementById('reqUserSearch').value = '';
    document.getElementById('reqUserSearch').focus();
  }
}

function reqShowNewUser() {
  document.getElementById('reqUserResults').style.display = 'none';
  document.getElementById('reqUserPicker').value     = '__new__';
  document.getElementById('reqReferredByName').value = '';
  document.getElementById('reqUserChip').style.display = 'none';
  document.getElementById('reqExistingTeamRow').style.display = 'none';
  document.getElementById('reqNewUserFields').style.display = '';
  document.getElementById('reqUserSearch').value = '';
  document.getElementById('reqUserSearchClear').style.display = 'none';
  document.getElementById('reqNewFirstName').focus();
}

// Keep old handler name as alias (called by form validation)
function handleReqUserPicker() {}


function closeRequestForm() { document.getElementById('reqOverlay').classList.remove('open'); }

function selectLocation(type) {
  reqSelectedLocation = type;
  document.getElementById('reqLocHQBtn').classList.toggle('selected', type === 'hq');
  document.getElementById('reqLocOtherBtn').classList.toggle('selected', type === 'other');
  document.getElementById('reqLocHQConfirm').style.display = type === 'hq' ? 'block' : 'none';
  document.getElementById('reqLocOtherFields').style.display = type === 'other' ? 'block' : 'none';
}

function updateReqStep() {
  const total = REQ_TOTAL_STEPS;
  const stepLabels = ['Your Details', 'Contact Info', 'Training Details', 'Priorities & Logistics'];
  for(let i = 1; i <= total; i++) {
    const el = document.getElementById(`reqStep${i}`);
    if(el) el.classList.toggle('active', i === reqCurrentStep);
  }
  const isLast = reqCurrentStep === total;
  const isSuccess = reqCurrentStep > total;
  document.getElementById('reqStep5').classList.toggle('active', isSuccess);
  document.getElementById('reqFooter').style.display = isSuccess ? 'none' : '';
  if(!isSuccess) {
    document.getElementById('reqBackBtn').style.display = reqCurrentStep > 1 ? 'inline-flex' : 'none';
    document.getElementById('reqNextBtn').textContent = isLast ? ' Submit Request' : 'Continue ';
    document.getElementById('reqSkipBtn').style.display = (reqCurrentStep <= 2) ? 'none' : 'inline-flex';
  }
  const prog = document.getElementById('reqProgress');
  prog.innerHTML = '';
  stepLabels.forEach((label, i) => {
    const stepNum = i + 1;
    const isDone = stepNum < reqCurrentStep;
    const isActive = stepNum === reqCurrentStep;
    prog.innerHTML += `<div class="req-step-dot ${isDone?'done':''} ${isActive?'active':''}">${isDone ? '' : stepNum}<span class="req-step-label">${label}</span></div>`;
    if(i < stepLabels.length - 1) prog.innerHTML += `<div class="req-step-line ${isDone?'done':''}"></div>`;
  });
}

function reqValidateStep(step) {
  if(step === 1) {
    const picker = document.getElementById('reqUserPicker').value;
    if(!picker) { showToast('Please select who is submitting this request', 'error'); return false; }
    if(picker === '__new__') {
      const fn = document.getElementById('reqNewFirstName').value.trim();
      const ln = document.getElementById('reqNewLastName').value.trim();
      const dept = document.getElementById('reqNewDept').value.trim();
      if(!fn || !ln || !dept) { showToast('Please enter first name, last name and department', 'error'); return false; }
      // Create the new user as Viewer and add to trainers
      const fullName = fn + ' ' + ln;
      const newUser = { id: 'u_req_' + Date.now(), name: fullName, role: 'viewer', color: TRAINER_COLORS[trainers.length % TRAINER_COLORS.length], jobTitle: dept, pin: '', icsUrl: '' };
      trainers.push(newUser);
      document.getElementById('reqReferredByName').value = fullName;
      document.getElementById('reqReferredByTeam').value = dept;
      showToast(fullName + ' added as Viewer', 'success');
    }
    if(!document.getElementById('reqReferredByName').value.trim()) { showToast('Please select or enter your name', 'error'); return false; }
  }
  if(step === 2) {
    const email = document.getElementById('reqEmail').value.trim();
    const company = document.getElementById('reqCompany').value.trim();
    const stakeholder = document.getElementById('reqStakeholder').value.trim();
    const msgs = [];
    if(!email) msgs.push('Company email');
    if(!company) msgs.push('Business name');
    if(!stakeholder) msgs.push('Stakeholder name');
    if(msgs.length) { showToast('Required: ' + msgs.join(', '), 'error'); return false; }
    if(!/^[^@]+@[^@]+\.[^@]+$/.test(email)) { showToast('Please enter a valid email address', 'error'); return false; }
  }
  return true;
}

function reqNextStep() {
  if(!reqValidateStep(reqCurrentStep)) return;
  if(reqCurrentStep === REQ_TOTAL_STEPS) { submitRequest(); return; }
  reqCurrentStep++;
  updateReqStep();
}

function reqPrevStep() { if(reqCurrentStep > 1) { reqCurrentStep--; updateReqStep(); } }

function reqSkipStep() {
  if(reqCurrentStep < REQ_TOTAL_STEPS && REQ_SKIPPABLE_STEPS.has(reqCurrentStep)) {
    reqSkippedSteps.add(reqCurrentStep);
    reqCurrentStep++;
    updateReqStep();
  }
}

async function submitRequest() {
  const name = document.getElementById('reqReferredByName').value.trim();
  const team = document.getElementById('reqReferredByTeam').value.trim() || document.getElementById('reqNewDept')?.value.trim() || '';
  const notes = document.getElementById('reqReferralNotes').value.trim();
  const quotedVal = document.getElementById('reqQuotedValue').value.trim();
  const email = document.getElementById('reqEmail').value.trim();
  const company = document.getElementById('reqCompany').value.trim();
  const stakeholder = document.getElementById('reqStakeholder').value.trim();
  const attendees = document.getElementById('reqAttendees').value.trim();
  const goLive = document.getElementById('reqGoLive').value;
  const prefDate = document.getElementById('reqPreferredDate').value;
  const trainingType = document.querySelector('[name="trainingType"]:checked')?.value || '';
  const familiarity = document.querySelector('[name="teamFamiliarity"]:checked')?.value || '';
  const areas = [...document.querySelectorAll('[name="areas"]:checked')].map(el => el.value).join(', ');
  const priorities = document.getElementById('reqPriorities').value.trim();
  const features = document.getElementById('reqFeatures').value.trim();
  const challenges = document.getElementById('reqChallenges').value.trim();
  const locAddress = reqSelectedLocation === 'hq' ? 'Street HQ  North Square, 1113 Spear St, Manchester M1 1JU' : document.getElementById('reqLocAddress').value.trim();
  const parking = document.getElementById('reqLocParking').value.trim();
  const equip = [...document.querySelectorAll('#reqEquipGrid input:checked')].map(el => el.value).join(', ');
  const equipOther = document.getElementById('reqLocEquipOther').value.trim();
  const dietary = document.getElementById('reqDietaryReqs').value.trim();
  const followUp = [...document.querySelectorAll('[name="followUp"]:checked')].map(el => el.value).join(', ');
  const anythingElse = document.getElementById('reqAnythingElse').value.trim();
  const referredByStr = name ? `${name} (${team || 'Unknown'})${notes ? '  ' + notes : ''}` : '';
  const params = new URLSearchParams({
    action: 'submitRequest',
    email, company, stakeholder, attendees, preferredDate: prefDate, goLiveDate: goLive,
    trainingType, teamFamiliarity: familiarity, areas, priorities,
    features, challenges,
    location: locAddress, parking, venueSetup: '',
    dietaryReqs: dietary, followUp, anythingElse,
    quotedValue: quotedVal,
    referredByName: name, referredByTeam: team, referralNotes: notes,
    submittedBy: currentUser?.name || 'Dashboard',
    skippedSections: [...reqSkippedSteps].map(s => REQ_SKIP_LABELS[s]).join(','),
    timestamp: new Date().toISOString()
  });
  try {
    await fetch(SCRIPT_URL + '?' + params.toString(), { method: 'GET', redirect: 'follow' });
    document.getElementById('reqSuccessMsg').textContent = `Thanks ${name || ''}! Your request for ${company || 'the client'} has been submitted. We'll review it and assign a trainer shortly.`;
    reqCurrentStep = REQ_TOTAL_STEPS + 1;
    updateReqStep();
    logActivity(name || currentUser?.name || 'Form Submitter', 'Submitted training request', company, trainingType);
    writeActivityLog({
      actionType:  'Form Submission',
      description: 'New training request submitted',
      module:      'Training Requests',
      recordType:  'Enquiry',
      recordId:    company || '',
      before:      '',
      after:       'Status: Unassigned',
      reason:      'Form Submit',
      source:      'Dashboard Form',
      company:     company,
      trainer:     '',
      notes:       trainingType || '',
    });
    showToast('Training request submitted!', 'success');
    setTimeout(() => loadData(), 2000);
  } catch(e) { showToast('Error submitting request  try again', 'error'); }
}

// ===================== UTILITY =====================
function closeAllModals() {
  ['assignOverlay','bookOverlay','editBookingOverlay','cancelOverlay','calEventOverlay','kpiModalOverlay','referralModalOverlay','reqOverlay'].forEach(id => {
    const el = document.getElementById(id); if(el) el.classList.remove('open');
  });
}

function showToast(msg, type = 'info', duration = 3500) {
  const c = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.textContent = msg;
  c.appendChild(t);
  setTimeout(() => { t.style.opacity = '0'; t.style.transition = 'opacity 0.3s'; setTimeout(() => t.remove(), 300); }, duration);
}

async function testConnection(btn) {
  if(btn) { btn.textContent = ' Testing'; btn.disabled = true; }
  const diagEl = document.getElementById('connectionDiag');
  if(diagEl) diagEl.remove();
  try {
    console.log('Testing URL:', SCRIPT_URL);
    const r = await fetch(SCRIPT_URL + '?action=getData&t=' + Date.now(), {
      method: 'GET',
      redirect: 'follow'
    });
    console.log('Response status:', r.status, r.statusText);
    if(!r.ok) throw new Error('HTTP ' + r.status + ' ' + r.statusText);
    const text = await r.text();
    let j;
    try { j = JSON.parse(text); } catch(pe) { throw new Error('Response is not JSON. Got: ' + text.slice(0, 100)); }
    if(j.success) {
      const rowCount = j.data ? j.data.length - 1 : 0;
      showToast(' Connected  ' + rowCount + ' rows loaded from spreadsheet', 'success');
    } else {
      showToast(' Connected but error: ' + (j.error || JSON.stringify(j)), 'error');
    }
  } catch(e) {
    console.error('Connection test failed:', e);
    const diag = document.createElement('div');
    diag.id = 'connectionDiag';
    diag.style.cssText = 'position:fixed;bottom:80px;right:24px;z-index:9999;background:#fff;border:2px solid #c0303d;border-radius:8px;padding:16px;max-width:420px;box-shadow:0 8px 24px rgba(0,0,0,0.2);font-size:12px;line-height:1.6;';
    diag.innerHTML = '<div style="font-weight:700;color:#c0303d;margin-bottom:8px;font-size:13px;">&#10060; Connection Failed</div>'
      + '<div style="color:#555;margin-bottom:10px;"><strong>Error:</strong> ' + escHtml(e.message) + '</div>'
      + '<div style="color:#555;margin-bottom:6px;font-weight:600;">Checklist:</div>'
      + '<ol style="color:#555;padding-left:16px;margin:0 0 10px;">'
      + '<li>Open the Apps Script URL directly in a new tab &mdash; it should return JSON</li>'
      + '<li>In Apps Script &rarr; Deploy &rarr; Manage Deployments: confirm access is set to <strong>&ldquo;Anyone&rdquo;</strong></li>'
      + '<li>Make sure you are using the <strong>/exec</strong> URL (not /dev)</li>'
      + '<li>Check the browser console (F12) for CORS or network errors</li>'
      + '</ol>'
      + '<div style="display:flex;gap:8px;flex-wrap:wrap;">'
      + '<a href="' + SCRIPT_URL + '" target="_blank" style="background:#2147f4;color:#fff;padding:5px 10px;border-radius:4px;text-decoration:none;font-size:11px;font-weight:600;">Open Script URL &#8599;</a>'
      + '<button onclick="this.parentNode.parentNode.remove()" style="background:#f3f4f6;border:1px solid #ddd;border-radius:4px;padding:5px 10px;font-size:11px;cursor:pointer;font-family:Arial,sans-serif;">Dismiss</button>'
      + '</div>';
    document.body.appendChild(diag);
  }
  if(btn) { btn.innerHTML = '<span class="nav-item-icon"></span> Test Connection'; btn.disabled = false; }
}
</script>
  <script src="til-patch.js"></script>
</body>
</html>
