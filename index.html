<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Street Training Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <style>
        :root {
            --text--dark--50: #19191e;
            --brand--black: #242326;
            --text--dark--40: #4c4d57;
            --text--dark--30: #777989;
            --card-light-grey: #f8f8f8;
            --accent--blue--300: #527dff;
            --action-primary-blue: #2147f4;
            --success-green: #bde4b9;
            --brand--yellow: #f1c238;
            --brand-accent--mandarin-light: #f6be9d;
            --brand-accent--dusty-red-light: #f9b4bc;
            --ui--underline--light-grey: #e5e5e5;
            --white: #ffffff;
        }

        body { font-family: Segoe UI, Tahoma, Geneva, Verdana, sans-serif; background: #f4f4f7; color: var(--text--dark--50); margin: 0; }

        /* Existing Styles Retained + New Modal Styles */
        .header { background: var(--brand--black); color: white; padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; }
        .main { padding: 20px; max-width: 1400px; margin: 0 auto; }
        
        .section-header { display: flex; justify-content: space-between; align-items: center; margin: 25px 0 15px; }
        .section-title { font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .badge { background: var(--brand-accent--dusty-red-light); padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; }

        .requests-panel { background: white; border-radius: 8px; border: 1px solid var(--ui--underline--light-grey); overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: var(--card-light-grey); text-align: left; padding: 12px; border-bottom: 1px solid var(--ui--underline--light-grey); color: var(--text--dark--30); text-transform: uppercase; font-size: 0.75rem; }
        td { padding: 12px; border-bottom: 1px solid var(--ui--underline--light-grey); }

        /* Button Styles */
        .btn { padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; font-weight: 600; font-size: 0.8rem; transition: 0.2s; }
        .btn-assign { background: var(--action-primary-blue); color: white; }
        .btn-cancel { background: #f0f0f0; color: #666; }
        .btn-cancel:hover { background: #e0e0e0; }
        
        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 450px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-header { font-weight: 800; font-size: 1.2rem; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: var(--text--dark--30); }
        .form-group select, .form-group input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        
        /* Calendar UI Improvements */
        .cal-day { min-height: 100px; border: 1px solid #eee; background: white; position: relative; }
        .cal-event { font-size: 0.7rem; padding: 2px 4px; margin: 1px; border-radius: 3px; color: white; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .evt-training { background: var(--action-primary-blue); }
        .evt-travel { background: #607d8b; }
        .evt-admin { background: #9e9e9e; }
        .evt-holiday { background: #ff9800; }
        .clash-warning { color: #d32f2f; font-size: 0.75rem; font-weight: bold; margin-top: 5px; }

        /* Workload Grid */
        .trainer-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .trainer-card { background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd; }
    </style>
</head>
<body>

    <header class="header">
        <div style="font-weight: 900; letter-spacing: 1px;">STREET TRAINING DASHBOARD</div>
        <div id="lastUpdated">Last synced: Just now</div>
    </header>

    <main class="main">
        <section>
            <div class="section-header">
                <div class="section-title">üë§ Trainer Workload</div>
            </div>
            <div class="trainer-grid" id="trainerGrid">
                </div>
        </section>

        <section id="unassignedSection">
            <div class="section-header">
                <div class="section-title">üîî Unassigned Requests <span class="badge" id="unassignedCount">0</span></div>
            </div>
            <div class="requests-panel">
                <table>
                    <thead>
                        <tr>
                            <th>Enquiry Date</th>
                            <th>Company</th>
                            <th>Option</th>
                            <th>Contact</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="unassignedBody">
                        </tbody>
                </table>
            </div>
        </section>

        <section>
            <div class="section-header">
                <div class="section-title" style="color: var(--brand--yellow);">‚ö†Ô∏è Needs Action ‚Äî Assigned & Pending</div>
            </div>
            <div class="requests-panel">
                <table>
                    <thead>
                        <tr>
                            <th>Company</th>
                            <th>Trainer</th>
                            <th>Option</th>
                            <th>Value</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="pendingBody">
                        </tbody>
                </table>
            </div>
        </section>

        <section>
            <div class="section-header">
                <div class="section-title">üìÖ Training Calendar</div>
                <div id="calendarMonthDisplay" style="font-weight: bold;">February 2026</div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(7, 1fr); background: #eee; text-align: center; font-weight: bold; font-size: 0.8rem; padding: 10px 0;">
                <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
            </div>
            <div id="calendarGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); border: 1px solid #ddd;">
                </div>
        </section>

        <section style="margin-top: 40px;">
            <div class="section-header">
                <div class="section-title">üìã All Bookings</div>
            </div>
            <div class="requests-panel">
                <table id="allBookingsTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Company</th>
                            <th>Trainer</th>
                            <th>Option</th>
                            <th>Value</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="allBookingsBody"></tbody>
                </table>
            </div>
        </section>
    </main>

    <div class="modal-overlay" id="assignModal">
        <div class="modal-content">
            <div class="modal-header">Assign Trainer</div>
            <div class="form-group">
                <label>Trainer</label>
                <select id="modalTrainerSelect"></select>
            </div>
            <div class="form-group">
                <label>Package Option</label>
                <select id="modalOptionSelect">
                    <option value="1">Option 1</option>
                    <option value="2">Option 2 (1 Day)</option>
                    <option value="3">Option 3 (2 Days)</option>
                    <option value="4">Option 4</option>
                    <option value="5">Option 5</option>
                </select>
            </div>
            <div class="form-group">
                <label>Invoice Value (¬£)</label>
                <input type="number" id="modalValueInput">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-assign" style="flex: 1;" onclick="processAssignment()">Confirm Assignment</button>
                <button class="btn btn-cancel" onclick="closeModals()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="bookingModal">
        <div class="modal-content">
            <div class="modal-header">Confirm Booking Dates</div>
            <div id="bookingModalDetails" style="font-size: 0.85rem; margin-bottom: 15px; color: #444;"></div>
            
            <div class="form-group">
                <label>Training Start Date</label>
                <input type="date" id="trainingStartDate" onchange="validateBooking()">
            </div>
            
            <div id="bookingClashArea"></div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-assign" id="finalBookBtn" style="flex: 1;" disabled onclick="processFinalBooking()">Complete Booking</button>
                <button class="btn btn-cancel" onclick="closeModals()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & CONFIG ---
        let trainers = ["Amy", "Max", "John", "Sarah"];
        let enquiries = [
            { id: 101, company: "Acme Corp", contact: "Joe Bloggs", option: "2", status: "Unassigned", value: 0, trainer: "", date: null },
            { id: 102, company: "Global Tech", contact: "Jane Doe", option: "3", status: "Unassigned", value: 0, trainer: "", date: null }
        ];
        let bookings = []; // Finalised bookings for the calendar
        
        // Static Bank Holidays 2026 (Simplified for demo)
        const bankHolidays = ["2026-01-01", "2026-04-03", "2026-04-06", "2026-05-04", "2026-05-25", "2026-08-31", "2026-12-25", "2026-12-28"];

        let activeEnquiryId = null;

        // --- RENDER FUNCTIONS ---

        function init() {
            renderUnassigned();
            renderPending();
            renderWorkload();
            renderCalendar();
            renderAllBookings();
            populateTrainerDropdowns();
        }

        function populateTrainerDropdowns() {
            const selects = ["modalTrainerSelect"];
            selects.forEach(id => {
                const el = document.getElementById(id);
                el.innerHTML = trainers.map(t => `<option value="${t}">${t}</option>`).join('');
            });
        }

        function renderUnassigned() {
            const list = enquiries.filter(e => e.status === "Unassigned");
            document.getElementById('unassignedCount').innerText = list.length;
            const body = document.getElementById('unassignedBody');
            body.innerHTML = list.map(e => `
                <tr>
                    <td>Just Now</td>
                    <td><strong>${e.company}</strong></td>
                    <td>Option ${e.option}</td>
                    <td>${e.contact}</td>
                    <td>
                        <button class="btn btn-assign" onclick="openAssignModal(${e.id})">Assign</button>
                        <button class="btn btn-cancel" onclick="cancelEnquiry(${e.id})">Cancelled</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderPending() {
            const list = enquiries.filter(e => e.status === "Pending");
            const body = document.getElementById('pendingBody');
            body.innerHTML = list.map(e => `
                <tr>
                    <td><strong>${e.company}</strong></td>
                    <td>${e.trainer}</td>
                    <td>Option ${e.option}</td>
                    <td>¬£${e.value}</td>
                    <td>
                        <select onchange="handleStatusChange(${e.id}, this.value)">
                            <option value="Pending" selected>Pending</option>
                            <option value="Booked">Booked</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                    </td>
                </tr>
            `).join('');
        }

        function renderWorkload() {
            const grid = document.getElementById('trainerGrid');
            grid.innerHTML = trainers.map(t => {
                const count = bookings.filter(b => b.trainer === t).length;
                return `
                    <div class="trainer-card">
                        <div style="font-weight:bold;">${t}</div>
                        <div style="font-size:0.8rem; color:#666;">Active Bookings: ${count}</div>
                    </div>
                `;
            }).join('');
        }

        function renderAllBookings() {
            const body = document.getElementById('allBookingsBody');
            // Combine current enquiries and historical if any
            body.innerHTML = enquiries.filter(e => e.status === "Booked" || e.status === "Cancelled").map(e => `
                <tr>
                    <td>${e.bookedDate || '-'}</td>
                    <td>${e.company}</td>
                    <td>${e.trainer || 'Unassigned'}</td>
                    <td>Opt ${e.option}</td>
                    <td>¬£${e.value}</td>
                    <td><span class="badge" style="background:${e.status === 'Cancelled' ? '#eee' : '#bde4b9'}">${e.status}</span></td>
                </tr>
            `).join('');
        }

        // --- MODAL LOGIC ---

        function openAssignModal(id) {
            activeEnquiryId = id;
            const enquiry = enquiries.find(e => e.id === id);
            document.getElementById('modalOptionSelect').value = enquiry.option;
            document.getElementById('assignModal').classList.add('active');
        }

        function closeModals() {
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
            activeEnquiryId = null;
        }

        function processAssignment() {
            const trainer = document.getElementById('modalTrainerSelect').value;
            const value = document.getElementById('modalValueInput').value;
            const option = document.getElementById('modalOptionSelect').value;

            const enq = enquiries.find(e => e.id === activeEnquiryId);
            enq.trainer = trainer;
            enq.value = value;
            enq.option = option;
            enq.status = "Pending";

            closeModals();
            init();
        }

        function handleStatusChange(id, newStatus) {
            if (newStatus === "Cancelled") {
                cancelEnquiry(id);
            } else if (newStatus === "Booked") {
                openBookingModal(id);
            }
        }

        function cancelEnquiry(id) {
            const enq = enquiries.find(e => e.id === id);
            enq.status = "Cancelled";
            init();
        }

        function openBookingModal(id) {
            activeEnquiryId = id;
            const enq = enquiries.find(e => e.id === id);
            const days = enq.option === "3" ? 2 : 1;
            
            document.getElementById('bookingModalDetails').innerHTML = `
                Company: <strong>${enq.company}</strong><br>
                Trainer: <strong>${enq.trainer}</strong><br>
                Training Duration: <strong>${days} Day(s)</strong>
            `;
            document.getElementById('bookingModal').classList.add('active');
        }

        function validateBooking() {
            const startDate = document.getElementById('trainingStartDate').value;
            if (!startDate) return;

            const enq = enquiries.find(e => e.id === activeEnquiryId);
            const trainingDayCount = enq.option === "3" ? 2 : 1;
            const clashArea = document.getElementById('bookingClashArea');
            clashArea.innerHTML = "";
            let clashes = [];

            // Calculate sequence
            let start = new Date(startDate);
            
            // Travel Day
            let travelDay = new Date(start);
            travelDay.setDate(travelDay.getDate() - 1);
            
            // Training Days
            let trainingDays = [];
            for(let i=0; i<trainingDayCount; i++){
                let d = new Date(start);
                d.setDate(d.getDate() + i);
                trainingDays.push(d);
            }

            // Admin Day
            let adminDay = new Date(start);
            adminDay.setDate(adminDay.getDate() + trainingDayCount);

            const allSequence = [travelDay, ...trainingDays, adminDay];

            allSequence.forEach(date => {
                const dateISO = date.toISOString().split('T')[0];
                const dayNum = date.getDay();

                // 1. Weekend Check
                if (dayNum === 0 || dayNum === 6) {
                    clashes.push(`Clash: ${dateISO} falls on a Weekend.`);
                }

                // 2. Bank Holiday Check
                if (bankHolidays.includes(dateISO)) {
                    clashes.push(`Clash: ${dateISO} is a UK Bank Holiday üè¶.`);
                }

                // 3. Trainer Clash Check
                const isBooked = bookings.some(b => b.trainer === enq.trainer && b.date === dateISO);
                if (isBooked) {
                    clashes.push(`Hard Blocker: ${enq.trainer} is already booked on ${dateISO}.`);
                }
            });

            if (clashes.length > 0) {
                clashArea.innerHTML = clashes.map(c => `<div class="clash-warning">${c}</div>`).join('');
                document.getElementById('finalBookBtn').disabled = true;
            } else {
                clashArea.innerHTML = `<div style="color: green; font-size:0.8rem; margin-top:10px;">‚úÖ Schedule is clear.</div>`;
                document.getElementById('finalBookBtn').disabled = false;
            }
        }

        function processFinalBooking() {
            const startDateStr = document.getElementById('trainingStartDate').value;
            const enq = enquiries.find(e => e.id === activeEnquiryId);
            const trainingDayCount = enq.option === "3" ? 2 : 1;

            let start = new Date(startDateStr);

            // Add Travel Day
            let travelDate = new Date(start);
            travelDate.setDate(travelDate.getDate() - 1);
            bookings.push({ trainer: enq.trainer, date: travelDate.toISOString().split('T')[0], type: 'travel', label: 'üöå Travel' });

            // Add Training Days
            for(let i=0; i<trainingDayCount; i++) {
                let d = new Date(start);
                d.setDate(d.getDate() + i);
                bookings.push({ trainer: enq.trainer, date: d.toISOString().split('T')[0], type: 'training', label: `üìñ ${enq.company}` });
            }

            // Add Admin Day
            let adminDate = new Date(start);
            adminDate.setDate(adminDate.getDate() + trainingDayCount);
            bookings.push({ trainer: enq.trainer, date: adminDate.toISOString().split('T')[0], type: 'admin', label: 'üíª Admin' });

            enq.status = "Booked";
            enq.bookedDate = startDateStr;

            closeModals();
            init();
        }

        // --- CALENDAR RENDER ---
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = "";
            
            // Creating a simple view for Feb 2026 (Starts Sunday Feb 1)
            // To align Mon-Sun, Feb 1 is index 6
            for (let i = 0; i < 6; i++) {
                grid.innerHTML += `<div class="cal-day cal-day-empty" style="background:#f9f9f9"></div>`;
            }

            for (let day = 1; day <= 28; day++) {
                const dateISO = `2026-02-${day.toString().padStart(2, '0')}`;
                const isHoliday = bankHolidays.includes(dateISO);
                
                let dayEvents = bookings.filter(b => b.date === dateISO);
                
                grid.innerHTML += `
                    <div class="cal-day">
                        <div style="font-size:0.7rem; padding:2px;">${day}</div>
                        ${isHoliday ? `<div class="cal-event" style="background:#ffccbc; color:#e64a19">üè¶ Bank Holiday</div>` : ''}
                        ${dayEvents.map(e => `
                            <div class="cal-event evt-${e.type}">${e.label} (${e.trainer})</div>
                        `).join('')}
                    </div>
                `;
            }
        }

        // Run on load
        init();

    </script>
</body>
</html>
