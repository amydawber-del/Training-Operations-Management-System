<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Street Training Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --text--dark--50: #19191e;
    --brand--black: #242326;
    --text--dark--40: #4c4d57;
    --text--dark--30: #777989;
    --card-light-grey: #f8f8f8;
    --text--white--30: #979797;
    --text--light--40: #b2b2b2;
    --accent--blue--300: #527dff;
    --accent-blue--200: #7a9cff;
    --text--dark--20: #a8aabb;
    --action-primary-blue: #2147f4;
    --light-grey: #ccc;
    --text-dark-10: #dfe0ec;
    --ui--underline--light-grey: #e5e5e5;
    --success-green: #bde4b9;
    --brand--yellow: #f1c238;
    --brand-accent--mandarin-light: #f6be9d;
    --accent-blue--100: #a3baff;
    --brand-accent--dusty-red-light: #f9b4bc;
    --brand--secondary--lightgreen: #beffd8;
    --accent-blue--50: #b8caff;
    --white-smoke: #fde8eb;
    --brand-accent--cream: #f5ede5;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;
    font-size: 14px;
    line-height: 20px;
    color: #333;
    background-color: #fff;
    min-height: 100vh;
  }

  /* HEADER */
  .header {
    background: var(--brand--black);
    color: #fff;
    height: 52px;
    display: flex;
    align-items: center;
    padding: 0 24px;
    gap: 16px;
    position: sticky;
    top: 0;
    z-index: 100;
    border-bottom: 1px solid #3a3a3a;
  }

  /* HAMBURGER */
  .hamburger-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 6px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    border-radius: 4px;
    transition: background 0.15s;
  }
  .hamburger-btn:hover { background: rgba(255,255,255,0.1); }
  .hamburger-btn span {
    display: block;
    width: 18px;
    height: 2px;
    background: #fff;
    border-radius: 1px;
    transition: all 0.2s;
  }
  .hamburger-btn.open span:nth-child(1) { transform: rotate(45deg) translate(4px, 4px); }
  .hamburger-btn.open span:nth-child(2) { opacity: 0; }
  .hamburger-btn.open span:nth-child(3) { transform: rotate(-45deg) translate(4px, -4px); }

  /* STREET LOGO */
  .street-logo {
    display: flex;
    align-items: center;
    gap: 6px;
    text-decoration: none;
  }
  .street-logo-mark {
    font-size: 15px;
    font-weight: 700;
    letter-spacing: -0.5px;
    color: #fff;
    font-family: Arial, sans-serif;
    line-height: 1;
  }
  .street-logo-mark .logo-dot { color: var(--brand--yellow); }
  .street-logo-sub {
    font-size: 9px;
    color: var(--text--light--40);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-top: 1px;
  }

  .header-title {
    font-size: 15px;
    font-weight: 600;
    color: #fff;
    letter-spacing: -0.2px;
    flex: 1;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .refresh-btn {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.15);
    color: #fff;
    padding: 5px 12px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    transition: background 0.15s;
    font-family: Arial, sans-serif;
  }
  .refresh-btn:hover { background: rgba(255,255,255,0.2); }

  .last-updated {
    font-size: 11px;
    color: var(--text--light--40);
  }

  /* SIDE NAV DRAWER */
  .nav-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    z-index: 200;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }
  .nav-overlay.open { opacity: 1; pointer-events: all; }

  .nav-drawer {
    position: fixed;
    top: 0;
    left: -280px;
    width: 260px;
    height: 100vh;
    background: var(--brand--black);
    z-index: 201;
    transition: left 0.22s ease;
    display: flex;
    flex-direction: column;
    box-shadow: 2px 0 8px rgba(0,0,0,0.3);
  }
  .nav-drawer.open { left: 0; }

  .nav-drawer-header {
    padding: 16px 20px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 52px;
  }
  .nav-drawer-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--text--light--40);
    letter-spacing: 1px;
    text-transform: uppercase;
  }
  .nav-close {
    background: none;
    border: none;
    color: var(--text--light--40);
    cursor: pointer;
    font-size: 18px;
    line-height: 1;
    padding: 2px 6px;
    border-radius: 4px;
    transition: color 0.15s;
  }
  .nav-close:hover { color: #fff; }

  .nav-section-label {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 1.2px;
    text-transform: uppercase;
    color: var(--text--dark--30);
    padding: 16px 20px 8px;
  }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 20px;
    color: #ccc;
    text-decoration: none;
    font-size: 13px;
    transition: background 0.12s, color 0.12s;
    border-left: 3px solid transparent;
  }
  .nav-item:hover {
    background: rgba(255,255,255,0.06);
    color: #fff;
    border-left-color: var(--accent--blue--300);
  }
  .nav-item.active {
    background: rgba(33, 71, 244, 0.15);
    color: var(--accent-blue--200);
    border-left-color: var(--action-primary-blue);
  }
  .nav-item-icon { font-size: 15px; width: 20px; text-align: center; }

  .nav-divider {
    height: 1px;
    background: rgba(255,255,255,0.08);
    margin: 8px 20px;
  }

  /* MAIN CONTENT */
  .main {
    padding: 24px;
    max-width: 1400px;
    margin: 0 auto;
  }

  /* LOADING */
  .loading-bar {
    height: 3px;
    background: linear-gradient(90deg, var(--action-primary-blue), var(--accent--blue--300));
    animation: loading 1.2s ease infinite;
    display: none;
  }
  .loading-bar.active { display: block; }
  @keyframes loading {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(200%); }
  }

  /* SECTION */
  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }
  .section-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--text--dark--50);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .section-title .badge {
    background: var(--brand-accent--dusty-red-light);
    color: #c0303d;
    font-size: 11px;
    font-weight: 700;
    padding: 1px 7px;
    border-radius: 10px;
    min-width: 20px;
    text-align: center;
  }
  .section-title .badge.green {
    background: var(--success-green);
    color: #2a7a26;
  }

  /* NEW REQUESTS PANEL */
  .requests-panel {
    border: 1px solid var(--ui--underline--light-grey);
    border-radius: 4px;
    margin-bottom: 24px;
    overflow: hidden;
  }
  .requests-panel-header {
    background: var(--card-light-grey);
    padding: 12px 16px;
    border-bottom: 1px solid var(--ui--underline--light-grey);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .requests-panel-header-left {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .alert-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #e53935;
    animation: pulse-dot 1.5s ease infinite;
  }
  @keyframes pulse-dot {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.8); }
  }

  /* TABLE */
  .table-wrap { overflow-x: auto; }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }
  thead tr {
    background: var(--card-light-grey);
  }
  th {
    padding: 10px 14px;
    text-align: left;
    font-weight: 600;
    font-size: 11px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    color: var(--text--dark--30);
    border-bottom: 1px solid var(--ui--underline--light-grey);
    white-space: nowrap;
  }
  td {
    padding: 10px 14px;
    border-bottom: 1px solid var(--ui--underline--light-grey);
    color: var(--text--dark--40);
    vertical-align: middle;
  }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: #fafafa; }

  .option-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    white-space: nowrap;
  }
  .opt-1 { background: var(--accent-blue--50); color: #2147f4; }
  .opt-2 { background: var(--brand-accent--cream); color: #8a5a2a; }
  .opt-3 { background: var(--brand-accent--mandarin-light); color: #a04010; }
  .opt-4 { background: var(--success-green); color: #2a7a26; }
  .opt-5 { background: var(--brand--secondary--lightgreen); color: #1a6a40; }

  .status-badge {
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
  }
  .status-new { background: var(--white-smoke); color: #c0303d; }
  .status-unassigned { background: var(--white-smoke); color: #c0303d; }
  .status-assigned { background: var(--brand-accent--cream); color: #8a5a2a; }
  .status-booked { background: var(--accent-blue--50); color: #2147f4; }
  .status-pending { background: var(--brand--secondary--lightgreen); color: #1a6a40; }
  .status-cancelled { background: #f0f0f0; color: #999; text-decoration: line-through; }
  .status-complete { background: var(--success-green); color: #2a7a26; }

  /* ASSIGN CONTROLS */
  select.trainer-select, select.status-select {
    border: 1px solid var(--light-grey);
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 12px;
    font-family: Arial, sans-serif;
    color: #333;
    background: #fff;
    cursor: pointer;
  }
  select.trainer-select:focus, select.status-select:focus { outline: none; border-color: var(--action-primary-blue); }

  .btn {
    padding: 5px 12px;
    border-radius: 4px;
    font-size: 12px;
    font-family: Arial, sans-serif;
    cursor: pointer;
    border: none;
    font-weight: 600;
    transition: background 0.15s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .btn-primary {
    background: var(--action-primary-blue);
    color: #fff;
  }
  .btn-primary:hover { background: #1a39d4; }
  .btn-primary:disabled { background: var(--text--dark--20); cursor: not-allowed; }
  .btn-sm { padding: 4px 10px; font-size: 11px; }
  .btn-ghost {
    background: none;
    border: 1px solid var(--light-grey);
    color: var(--text--dark--30);
  }
  .btn-ghost:hover { background: var(--card-light-grey); color: #333; }
  .btn-danger {
    background: #fde8eb;
    color: #c0303d;
  }
  .btn-danger:hover { background: #fecaca; }

  /* KPI CARDS */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }
  .kpi-card {
    border: 1px solid var(--ui--underline--light-grey);
    border-radius: 4px;
    padding: 16px 20px;
    background: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  }
  .kpi-card-label {
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    color: var(--text--dark--30);
    margin-bottom: 8px;
  }
  .kpi-card-value {
    font-size: 28px;
    font-weight: 700;
    color: var(--text--dark--50);
    line-height: 1.1;
    letter-spacing: -0.5px;
  }
  .kpi-card-sub {
    font-size: 11px;
    color: var(--text--dark--30);
    margin-top: 4px;
  }
  .kpi-card-delta {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    font-size: 11px;
    font-weight: 600;
    padding: 1px 6px;
    border-radius: 4px;
    margin-top: 6px;
  }
  .delta-up { background: var(--success-green); color: #2a7a26; }
  .delta-down { background: var(--white-smoke); color: #c0303d; }
  .kpi-accent-left {
    border-left: 3px solid var(--action-primary-blue);
    padding-left: 14px;
  }
  .kpi-accent-yellow { border-left-color: var(--brand--yellow); }
  .kpi-accent-green { border-left-color: #4caf50; }
  .kpi-accent-orange { border-left-color: #ff7043; }

  /* CHARTS GRID */
  .charts-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 16px;
    margin-bottom: 24px;
  }
  @media (max-width: 900px) { .charts-grid { grid-template-columns: 1fr; } }

  .chart-card {
    border: 1px solid var(--ui--underline--light-grey);
    border-radius: 4px;
    padding: 20px;
    background: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  }
  .chart-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text--dark--50);
    margin-bottom: 4px;
  }
  .chart-subtitle {
    font-size: 11px;
    color: var(--text--dark--30);
    margin-bottom: 16px;
  }
  .chart-container { position: relative; }

  /* TRAINER WORKLOAD */
  .trainer-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 12px;
    margin-bottom: 24px;
  }
  .trainer-card {
    border: 1px solid var(--ui--underline--light-grey);
    border-radius: 4px;
    padding: 14px 16px;
    background: #fff;
  }
  .trainer-name {
    font-size: 13px;
    font-weight: 600;
    color: var(--text--dark--50);
    margin-bottom: 10px;
  }
  .trainer-stat {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    color: var(--text--dark--30);
    margin-bottom: 4px;
  }
  .trainer-stat-val { font-weight: 600; color: var(--text--dark--40); }
  .workload-bar-wrap {
    height: 4px;
    background: var(--ui--underline--light-grey);
    border-radius: 2px;
    margin-top: 8px;
    overflow: hidden;
  }
  .workload-bar {
    height: 100%;
    border-radius: 2px;
    background: var(--action-primary-blue);
    transition: width 0.4s ease;
  }
  .workload-bar.busy { background: #ff7043; }
  .workload-bar.medium { background: var(--brand--yellow); }

  .suggested-tag {
    display: inline-block;
    font-size: 10px;
    font-weight: 600;
    background: var(--brand--secondary--lightgreen);
    color: #1a6a40;
    padding: 1px 6px;
    border-radius: 4px;
    margin-top: 6px;
  }

  /* ALL BOOKINGS TABLE */
  .all-bookings {
    border: 1px solid var(--ui--underline--light-grey);
    border-radius: 4px;
    margin-bottom: 24px;
    overflow: hidden;
  }

  /* EMPTY STATE */
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text--dark--30);
  }
  .empty-state-icon { font-size: 32px; margin-bottom: 8px; }
  .empty-state-text { font-size: 13px; }

  /* TOAST */
  .toast-container {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 999;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .toast {
    background: var(--brand--black);
    color: #fff;
    padding: 10px 16px;
    border-radius: 4px;
    font-size: 13px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    animation: slideIn 0.2s ease;
    border-left: 3px solid var(--action-primary-blue);
  }
  .toast.success { border-left-color: #4caf50; }
  .toast.error { border-left-color: #e53935; }
  @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: none; opacity: 1; } }

  /* MONTH VS CARDS */
  .compare-cards {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
  }
  .compare-card {
    background: var(--card-light-grey);
    border-radius: 4px;
    padding: 12px 14px;
    text-align: center;
  }
  .compare-card-label { font-size: 10px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; color: var(--text--dark--30); margin-bottom: 4px; }
  .compare-card-value { font-size: 22px; font-weight: 700; color: var(--text--dark--50); }

  /* SPINNER */
  .spinner {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid var(--text-dark-10);
    border-top-color: var(--action-primary-blue);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* PAGINATION */
  .pagination {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    border-top: 1px solid var(--ui--underline--light-grey);
    background: var(--card-light-grey);
    font-size: 12px;
    color: var(--text--dark--30);
  }
  .page-btn {
    background: #fff;
    border: 1px solid var(--light-grey);
    border-radius: 4px;
    padding: 3px 10px;
    font-size: 12px;
    cursor: pointer;
    font-family: Arial, sans-serif;
    transition: background 0.12s;
  }
  .page-btn:hover:not(:disabled) { background: var(--card-light-grey); }
  .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  /* FILTER BAR */
  .filter-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }
  select.filter-select, input.filter-input {
    border: 1px solid var(--light-grey);
    border-radius: 4px;
    padding: 5px 10px;
    font-size: 12px;
    font-family: Arial, sans-serif;
    color: #333;
    background: #fff;
  }
  select.filter-select:focus, input.filter-input:focus { outline: none; border-color: var(--action-primary-blue); }

  .data-note {
    font-size: 11px;
    color: var(--text--dark--20);
    padding: 8px 16px;
    background: var(--card-light-grey);
    border-top: 1px solid var(--ui--underline--light-grey);
  }

  /* MODALS */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 300;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal {
    background: #fff;
    border-radius: 8px;
    width: 380px;
    max-width: 95vw;
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    overflow: hidden;
  }
  .modal-header {
    background: var(--brand--black);
    color: #fff;
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .modal-title { font-size: 14px; font-weight: 600; }
  .modal-close {
    background: none; border: none; color: #aaa; cursor: pointer;
    font-size: 18px; line-height: 1; padding: 2px 6px; border-radius: 4px;
  }
  .modal-close:hover { color: #fff; }
  .modal-body { padding: 20px; }
  
  /* Input grouping inside modals */
  .form-group { margin-bottom: 12px; }
  .form-group label { display: block; font-size: 11px; font-weight: 600; color: var(--text--dark--30); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
  .form-group input, .form-group select { width: 100%; border: 1px solid var(--light-grey); border-radius: 4px; padding: 8px 10px; font-size: 13px; font-family: Arial, sans-serif; box-sizing: border-box; }
  .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--action-primary-blue); }

  /* KPI DETAIL MODAL */
  .kpi-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.55);
    z-index: 400;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }
  .kpi-modal-overlay.open { opacity: 1; pointer-events: all; }
  .kpi-modal {
    background: #fff;
    border-radius: 8px;
    width: 860px;
    max-width: 96vw;
    max-height: 88vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 12px 48px rgba(0,0,0,0.25);
    overflow: hidden;
  }
  .kpi-modal-header {
    padding: 18px 24px 14px;
    border-bottom: 1px solid var(--ui--underline--light-grey);
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 16px;
    flex-shrink: 0;
  }
  .kpi-modal-header-left { flex: 1; }
  .kpi-modal-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--text--dark--50);
    margin-bottom: 2px;
  }
  .kpi-modal-subtitle {
    font-size: 12px;
    color: var(--text--dark--30);
  }
  .kpi-modal-headline {
    font-size: 28px;
    font-weight: 700;
    color: var(--text--dark--50);
    letter-spacing: -0.5px;
    margin-top: 8px;
  }
  .kpi-modal-close {
    background: var(--card-light-grey);
    border: 1px solid var(--ui--underline--light-grey);
    color: var(--text--dark--30);
    cursor: pointer;
    font-size: 18px;
    line-height: 1;
    padding: 6px 10px;
    border-radius: 4px;
    transition: background 0.12s, color 0.12s;
    flex-shrink: 0;
  }
  .kpi-modal-close:hover { background: var(--white-smoke); color: #c0303d; }
  .kpi-modal-stats {
    display: flex;
    gap: 24px;
    padding: 14px 24px;
    background: var(--card-light-grey);
    border-bottom: 1px solid var(--ui--underline--light-grey);
    flex-wrap: wrap;
    flex-shrink: 0;
  }
  .kpi-modal-stat {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .kpi-modal-stat-label {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.6px;
    color: var(--text--dark--30);
  }
  .kpi-modal-stat-value {
    font-size: 16px;
    font-weight: 700;
    color: var(--text--dark--50);
  }
  .kpi-modal-stat-sub {
    font-size: 10px;
    color: var(--text--dark--30);
  }
  .kpi-modal-body {
    overflow-y: auto;
    flex: 1;
  }
  .kpi-modal-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
  }
  .kpi-modal-table thead tr {
    background: var(--card-light-grey);
    position: sticky;
    top: 0;
    z-index: 1;
  }
  .kpi-modal-table th {
    padding: 9px 14px;
    text-align: left;
    font-weight: 600;
    font-size: 10px;
    letter-spacing: 0.6px;
    text-transform: uppercase;
    color: var(--text--dark--30);
    border-bottom: 2px solid var(--ui--underline--light-grey);
    white-space: nowrap;
  }
  .kpi-modal-table td {
    padding: 10px 14px;
    border-bottom: 1px solid var(--ui--underline--light-grey);
    color: var(--text--dark--40);
    vertical-align: middle;
  }
  .kpi-modal-table tr:last-child td { border-bottom: none; }
  .kpi-modal-table tr:hover td { background: #fafbff; }
  .kpi-modal-table .col-money { font-weight: 600; color: var(--text--dark--50); }
  .kpi-modal-table .col-highlight { font-weight: 600; color: var(--action-primary-blue); }
  .kpi-modal-footer {
    padding: 12px 24px;
    border-top: 1px solid var(--ui--underline--light-grey);
    background: var(--card-light-grey);
    display: flex;
    justify-content: flex-end;
    flex-shrink: 0;
  }
  .kpi-card.clickable {
    cursor: pointer;
    transition: box-shadow 0.15s, border-color 0.15s, background 0.15s;
    border: 1px solid var(--ui--underline--light-grey);
    position: relative;
  }
  .kpi-card.clickable:hover {
    box-shadow: 0 4px 16px rgba(33,71,244,0.10);
    border-color: rgba(33,71,244,0.35);
    background: #f6f8ff;
  }
  .kpi-card.clickable:active { background: #eef1ff; }
  .trainer-pill {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 600;
    background: var(--accent-blue--50);
    color: var(--action-primary-blue);
  }

  /* ‚îÄ‚îÄ ACTIVITY FEED ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .activity-btn {
    position: relative;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 5px 12px;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 5px;
    color: #ccc;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    font-family: Arial, sans-serif;
    transition: background 0.15s, color 0.15s;
    white-space: nowrap;
  }
  .activity-btn:hover { background: rgba(255,255,255,0.15); color: #fff; }
  .activity-btn-dot {
    position: absolute;
    top: -3px;
    right: -3px;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #f59e0b;
    border: 2px solid var(--text--dark--50);
    display: none;
  }
  .activity-btn-dot.visible { display: block; }

  .activity-panel {
    position: fixed;
    top: 0;
    right: 0;
    width: 380px;
    max-width: 95vw;
    height: 100vh;
    background: #fff;
    box-shadow: -4px 0 32px rgba(0,0,0,0.18);
    z-index: 600;
    display: flex;
    flex-direction: column;
    transform: translateX(100%);
    transition: transform 0.28s cubic-bezier(0.4,0,0.2,1);
  }
  .activity-panel.open { transform: translateX(0); }
  .activity-panel-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.35);
    z-index: 599;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s;
  }
  .activity-panel-overlay.open { opacity: 1; pointer-events: all; }
  .activity-panel-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--ui--underline--light-grey);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--text--dark--50);
    color: #fff;
    flex-shrink: 0;
  }
  .activity-panel-title { font-size: 14px; font-weight: 700; letter-spacing: 0.2px; }
  .activity-panel-sub { font-size: 11px; color: rgba(255,255,255,0.55); margin-top: 2px; }
  .activity-close {
    background: rgba(255,255,255,0.1); border: none; color: rgba(255,255,255,0.7);
    cursor: pointer; font-size: 16px; padding: 5px 9px; border-radius: 4px; transition: background 0.12s, color 0.12s;
  }
  .activity-close:hover { background: rgba(255,255,255,0.2); color: #fff; }

  /* ‚îÄ‚îÄ CALENDAR SECTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .cal-section { margin-bottom: 24px; }
  .cal-grid {
    display: grid;
    grid-template-columns: minmax(0, 1fr) 300px;
    gap: 16px;
    align-items: start;
    min-width: 0;
    width: 100%;
  }
  @media (max-width: 900px) { .cal-grid { grid-template-columns: 1fr; } }
  .cal-month-card {
    background: #fff;
    border: 1px solid var(--ui--underline--light-grey);
    border-radius: 8px;
    overflow: hidden;
    min-width: 0;
    width: 100%;
  }
  .cal-month-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 16px; background: var(--text--dark--50); color: #fff;
  }
  .cal-month-title { font-size: 14px; font-weight: 700; }
  .cal-nav-btn {
    background: rgba(255,255,255,0.12); border: none; color: #fff; cursor: pointer;
    padding: 4px 10px; border-radius: 4px; font-size: 14px; font-family: Arial, sans-serif; transition: background 0.12s;
  }
  .cal-nav-btn:hover { background: rgba(255,255,255,0.22); }
  .cal-dow-row {
    display: flex; width: 100%; box-sizing: border-box; background: var(--card-light-grey);
    border-bottom: 1px solid var(--ui--underline--light-grey);
  }
  .cal-dow {
    flex: 0 0 calc(100% / 7); width: calc(100% / 7); text-align: center;
    font-size: 10px; font-weight: 700; color: var(--text--dark--30); padding: 6px 0;
    letter-spacing: 0.5px; text-transform: uppercase; box-sizing: border-box; overflow: hidden;
  }
  .cal-days {
    display: flex; flex-wrap: wrap; width: 100%; box-sizing: border-box;
    border-top: 1px solid #f3f4f6; border-left: 1px solid #f3f4f6;
  }
  .cal-day {
    flex: 0 0 calc(100% / 7); width: calc(100% / 7); box-sizing: border-box;
    min-height: 90px; padding: 5px 4px 4px; border-right: 1px solid #f3f4f6;
    border-bottom: 1px solid #f3f4f6; cursor: default; transition: background 0.1s; overflow: hidden; 
  }
  .cal-day:hover:not(.cal-day-empty) { background: #f6f8ff; }
  .cal-day-empty { background: #fafafa; }
  .cal-day-num {
    font-size: 11px; font-weight: 600; color: var(--text--dark--30); display: block; margin-bottom: 3px; line-height: 1;
  }
  .cal-day-today .cal-day-num {
    background: var(--action-primary-blue); color: #fff; width: 20px; height: 20px;
    border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 10px; margin-bottom: 3px;
  }
  .cal-day-past { opacity: 0.5; }
  .cal-event {
    display: block; font-size: 9px; font-weight: 600; padding: 2px 5px; border-radius: 3px; margin-bottom: 2px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; max-width: 100%; box-sizing: border-box;
  }
  .cal-event-booking  { background: #b8caff; color: #1838c0; }
  .cal-event-travel   { background: #fde8eb; color: #c0303d; }
  .cal-event-admin    { background: #f5ede5; color: #8a5a2a; }
  .cal-event-blocked  { background: #fde8eb; color: #c0303d; }
  .cal-event-gcal     { background: #beffd8; color: #1a6a40; }

  /* Upcoming events sidebar */
  .cal-upcoming-card {
    background: #fff; border: 1px solid var(--ui--underline--light-grey); border-radius: 8px;
    overflow: hidden; max-height: 520px; display: flex; flex-direction: column;
  }
  .cal-upcoming-header {
    padding: 12px 16px; background: var(--card-light-grey); border-bottom: 1px solid var(--ui--underline--light-grey);
    font-size: 12px; font-weight: 700; color: var(--text--dark--40); display: flex; align-items: center; justify-content: space-between;
  }
  .cal-upcoming-body { flex: 1; overflow-y: auto; }
  .cal-upcoming-item {
    padding: 10px 14px; border-bottom: 1px solid #f3f4f6; display: flex; gap: 10px; align-items: flex-start;
  }
  .cal-upcoming-item:last-child { border-bottom: none; }
  .cal-upcoming-date {
    min-width: 38px; text-align: center; background: var(--card-light-grey); border-radius: 6px; padding: 4px 6px; flex-shrink: 0;
  }
  .cal-upcoming-date-day { font-size: 16px; font-weight: 700; color: var(--text--dark--50); line-height: 1; }
  .cal-upcoming-date-mon { font-size: 9px; font-weight: 600; color: var(--text--dark--30); text-transform: uppercase; letter-spacing: 0.5px; }
  .cal-upcoming-body-text { flex: 1; min-width: 0; }
  .cal-upcoming-company { font-size: 12px; font-weight: 600; color: var(--text--dark--50); }
  .cal-upcoming-meta { font-size: 11px; color: var(--text--dark--30); margin-top: 2px; }

  /* Cal filter row */
  .cal-filter-row {
    display: flex; align-items: center; gap: 8px; padding: 10px 14px; background: var(--card-light-grey); border-bottom: 1px solid var(--ui--underline--light-grey); flex-wrap: wrap;
  }
  .cal-legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
  .cal-legend-label { font-size: 11px; color: var(--text--dark--40); }

</style>
</head>
<body>

<div class="nav-overlay" id="navOverlay" onclick="closeNav()"></div>

<nav class="nav-drawer" id="navDrawer">
  <div class="nav-drawer-header">
    <span class="nav-drawer-title">Navigation</span>
    <button class="nav-close" onclick="closeNav()">‚úï</button>
  </div>
  <div class="nav-section-label">Dashboard</div>
  <a href="#" class="nav-item active" onclick="closeNav()">
    <span class="nav-item-icon">üìä</span> Training Dashboard
  </a>
</nav>

<header class="header">
  <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleNav()" aria-label="Menu">
    <span></span><span></span><span></span>
  </button>
  <a href="#" class="street-logo">
    <div>
      <div class="street-logo-mark">STREET<span class="logo-dot">.</span><span style="font-size:9px;font-weight:400;letter-spacing:0;">CO.UK</span></div>
    </div>
  </a>
  <div class="header-title">Training Dashboard</div>
  <div class="header-right">
    <span class="last-updated" id="lastUpdated">‚Äî</span>
    <button class="refresh-btn" onclick="loadData()">‚Üª Refresh</button>
  </div>
</header>

<div class="loading-bar" id="loadingBar"></div>

<main class="main">

  <div style="margin-bottom:24px;">
    <div class="section-header">
      <div class="section-title">üë§ Trainer Workload</div>
    </div>
    <div class="trainer-grid" id="trainerGrid">
      <div class="kpi-card" style="text-align:center;color:var(--text--dark--30);font-size:12px;grid-column:1/-1;">Loading trainer data...</div>
    </div>
  </div>

  <div style="margin-bottom:24px;">
    <div class="section-header">
      <div class="section-title">
        üîî Unassigned Requests
        <span class="badge" id="unassignedBadge">0</span>
      </div>
      <div class="filter-bar">
        <input class="filter-input" id="searchInput" type="text" placeholder="Search client, option..." oninput="filterRequests()" style="width:200px;">
      </div>
    </div>

    <div class="requests-panel">
      <div class="requests-panel-header">
        <div class="requests-panel-header-left">
          <div class="alert-dot" id="alertDot" style="display:none;"></div>
          <span style="font-size:12px;font-weight:600;color:var(--text--dark--40);">New training requests awaiting trainer assignment</span>
        </div>
      </div>
      <div class="table-wrap">
        <table id="newRequestsTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Company</th>
              <th>Contact</th>
              <th>Option</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="newRequestsBody">
            <tr><td colspan="5" style="padding:20px;text-align:center;color:var(--text--dark--30);">Connecting‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div style="margin-bottom:24px;">
    <div class="section-header">
      <div class="section-title" style="color:#8a5a2a;">
        ‚ö†Ô∏è Needs Action ‚Äî Assigned &amp; Pending
        <span class="badge" id="actionBadge" style="background:var(--brand-accent--mandarin-light);color:#a04010;">0</span>
      </div>
      <span style="font-size:11px;color:var(--text--dark--30);">These need to be confirmed as Booked or marked Cancelled</span>
    </div>
    <div class="requests-panel" style="border-color:var(--brand-accent--mandarin-light);">
      <div class="requests-panel-header" style="background:var(--brand-accent--cream);">
        <div class="requests-panel-header-left">
          <div class="alert-dot" id="actionDot" style="display:none;background:#f59e0b;"></div>
          <span style="font-size:12px;font-weight:600;color:var(--text--dark--40);">Assigned or pending bookings awaiting confirmation</span>
        </div>
      </div>
      <div class="table-wrap">
        <table id="actionRequestsTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Company</th>
              <th>Option</th>
              <th>Trainer</th>
              <th>Value</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="actionRequestsBody">
            <tr><td colspan="6" style="padding:20px;text-align:center;color:var(--text--dark--30);">Connecting‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="cal-section" id="calSection">
    <div class="section-header">
      <div class="section-title">üìÖ Training Calendar</div>
    </div>
    <div class="cal-grid">
      <div class="cal-month-card">
        <div class="cal-month-header">
          <button class="cal-nav-btn" onclick="calChangeMonth(-1)">‚Äπ</button>
          <div class="cal-month-title" id="calMonthTitle">‚Äî</div>
          <button class="cal-nav-btn" onclick="calChangeMonth(1)">‚Ä∫</button>
        </div>
        <div class="cal-filter-row">
          <div style="display:flex;align-items:center;gap:5px;">
            <div class="cal-legend-dot" style="background:#b8caff;"></div>
            <span class="cal-legend-label">Training</span>
          </div>
          <div style="display:flex;align-items:center;gap:5px;">
            <div class="cal-legend-dot" style="background:#fde8eb;"></div>
            <span class="cal-legend-label">Travel</span>
          </div>
          <div style="display:flex;align-items:center;gap:5px;">
            <div class="cal-legend-dot" style="background:#f5ede5;"></div>
            <span class="cal-legend-label">Admin</span>
          </div>
          <div style="margin-left:auto;">
            <select id="calFilterTrainer" onchange="renderCalendar()" style="font-size:11px;border:1px solid var(--ui--underline--light-grey);border-radius:4px;padding:3px 7px;font-family:Arial,sans-serif;background:#fff;">
              <option value="">All Trainers</option>
            </select>
          </div>
        </div>
        <div class="cal-dow-row">
          <div class="cal-dow">Mon</div><div class="cal-dow">Tue</div>
          <div class="cal-dow">Wed</div><div class="cal-dow">Thu</div>
          <div class="cal-dow">Fri</div><div class="cal-dow">Sat</div>
          <div class="cal-dow">Sun</div>
        </div>
        <div class="cal-days" id="calDays"></div>
      </div>

      <div class="cal-upcoming-card">
        <div class="cal-upcoming-header">
          <span>Upcoming Sessions</span>
          <span id="calUpcomingCount" style="font-size:10px;color:var(--text--dark--30);">‚Äî</span>
        </div>
        <div class="cal-upcoming-body" id="calUpcomingBody"></div>
      </div>
    </div>
  </div>

  <div>
    <div class="section-header" style="flex-wrap:wrap;gap:10px;">
      <div class="section-title">üìã All Bookings <span class="badge green" id="allBadge">0</span></div>
    </div>
    <div class="all-bookings">
      <div class="table-wrap">
        <table id="allBookingsTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Company</th>
              <th>Contact</th>
              <th>Option</th>
              <th>Trainer</th>
              <th>Value</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="allBookingsBody">
            <tr><td colspan="7"><div class="empty-state"><div class="spinner"></div><div class="empty-state-text" style="margin-top:8px;color:var(--text--dark--30);">Connecting to sheet‚Ä¶</div></div></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</main>


<div class="modal-overlay" id="assignModalOverlay">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">Assign Trainer</span>
      <button class="modal-close" onclick="closeAssignModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="assignRowIndex">
      <div style="font-size:13px; margin-bottom: 16px;">
        Assigning <strong id="assignCompanyName">Company</strong>
      </div>
      <div class="form-group">
        <label>Select Trainer</label>
        <select id="assignTrainerSelect">
          <option value="">‚Äî Select Trainer ‚Äî</option>
        </select>
      </div>
      <div class="form-group">
        <label>Confirm Option</label>
        <select id="assignOptionSelect">
          <option value="1">Option 1 ‚Äî On Demand</option>
          <option value="2">Option 2 ‚Äî 1 Day</option>
          <option value="3">Option 3 ‚Äî 2 Day</option>
          <option value="4">Option 4 ‚Äî Accounting</option>
          <option value="5">Option 5 ‚Äî HQ Session</option>
        </select>
      </div>
      <div class="form-group">
        <label>Invoice Value (¬£)</label>
        <input type="number" id="assignValueInput" placeholder="e.g. 1100" min="0">
      </div>
    </div>
    <div style="padding:12px 20px;border-top:1px solid var(--ui--underline--light-grey);background:var(--card-light-grey);display:flex;justify-content:flex-end;gap:8px;">
      <button class="btn btn-ghost" onclick="closeAssignModal()">Cancel</button>
      <button class="btn btn-primary" onclick="confirmAssignment()">Assign to Pending</button>
    </div>
  </div>
</div>


<div class="modal-overlay" id="bookModalOverlay">
  <div class="modal" style="width: 420px;">
    <div class="modal-header">
      <span class="modal-title">Confirm Booking Dates</span>
      <button class="modal-close" onclick="closeBookModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="bookRowIndex">
      <div style="font-size:13px; margin-bottom: 12px;">
        Booking <strong id="bookCompanyName">Company</strong>
      </div>
      
      <div class="form-group">
        <label>Trainer</label>
        <select id="bookTrainerSelect"></select>
      </div>

      <div style="display:flex; gap: 12px;">
        <div class="form-group" style="flex:1;">
          <label>Booked On Date (Start)</label>
          <input type="date" id="bookDateInput">
        </div>
        <div class="form-group" style="width: 100px;">
          <label>Training Days</label>
          <input type="number" id="bookDaysInput" min="1" max="10" value="1">
        </div>
      </div>
      
      <div class="form-group">
        <label>Invoice Value (¬£)</label>
        <input type="number" id="bookValueInput">
      </div>

      <div style="background: #f0f4ff; border: 1px solid #c2d2ff; padding: 10px; border-radius: 4px; font-size: 11px; color: #1a39d4; margin-top: 10px;">
        <strong>Calendar Generation:</strong><br>
        ‚Ä¢ Travel Day: 1 day before start date<br>
        ‚Ä¢ Admin Day: 1 day after end date<br>
        <em>System will check for clashes.</em>
      </div>
    </div>
    <div style="padding:12px 20px;border-top:1px solid var(--ui--underline--light-grey);background:var(--card-light-grey);display:flex;justify-content:flex-end;gap:8px;">
      <button class="btn btn-ghost" onclick="closeBookModal()">Cancel</button>
      <button class="btn btn-primary" onclick="confirmBooking()">Confirm Booking</button>
    </div>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
// =============================================
// CONFIG
// =============================================
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzCvBhFSPyyoaVsui0DCxvGQQa0V7e_UCJ5LfqvcSysTHTFlNRcx4ewlET5TyouJ0ZYow/exec';

// Hardcoded Holidays for Clashes
const UK_HOLIDAYS = [
  '2025-01-01', '2025-04-18', '2025-04-21', '2025-05-05', '2025-05-26', '2025-08-25', '2025-12-25', '2025-12-26',
  '2026-01-01', '2026-04-03', '2026-04-06', '2026-05-04', '2026-05-25', '2026-08-31', '2026-12-25', '2026-12-28'
];

const OPTION_PRICES = { '1': 0, '2': 1100, '3': 1850, '4': 1000, '5': 220 };
const OPTION_LABELS = { '1': 'On Demand', '2': 'Personalised 1 Day', '3': 'Personalised 2 Day', '4': 'Accounting + Go Live', '5': 'Live HQ Session' };
const OPTION_DAYS = { '1': 0, '2': 1, '3': 2, '4': 1, '5': 1 };

let USERS = [{ name: 'Admin', permissions: { manage_trainers: true } }];
let TRAINERS = ['James', 'Sarah', 'Michael', 'Emma'];
let allData = [];

let calState = { year: new Date().getFullYear(), month: new Date().getMonth(), gcalEvents: [] };

// =============================================
// TOAST & NAV
// =============================================
function showToast(msg, type = '') {
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.textContent = msg;
  document.getElementById('toastContainer').appendChild(t);
  setTimeout(() => t.remove(), 3500);
}
function toggleNav() {
  document.getElementById('navDrawer').classList.toggle('open');
  document.getElementById('navOverlay').classList.toggle('open');
}
function closeNav() {
  document.getElementById('navDrawer').classList.remove('open');
  document.getElementById('navOverlay').classList.remove('open');
}

// =============================================
// DATA FETCHING (MOCK FOR THIS EXAMPLE)
// =============================================
async function loadData() {
  document.getElementById('loadingBar').classList.add('active');
  document.getElementById('lastUpdated').textContent = 'Loading‚Ä¶';
  
  setTimeout(() => {
    allData = generateDemoData();
    processData();
    document.getElementById('lastUpdated').textContent = '‚úì Live ‚Äî ' + new Date().toLocaleTimeString();
    document.getElementById('loadingBar').classList.remove('active');
  }, 800);
}

function processData() {
  renderUnassigned();
  renderActionPanel();
  renderTrainerWorkload();
  renderAllBookings();
  populateTrainerDropdowns();
  renderCalendar();
  renderUpcoming();
}

function populateTrainerDropdowns() {
  const opts = '<option value="">‚Äî Select Trainer ‚Äî</option>' + TRAINERS.map(t => `<option value="${t}">${t}</option>`).join('');
  const assignSel = document.getElementById('assignTrainerSelect');
  const bookSel = document.getElementById('bookTrainerSelect');
  if (assignSel) assignSel.innerHTML = opts;
  if (bookSel) bookSel.innerHTML = opts;
}

// =============================================
// UNASSIGNED REQUESTS PANEL
// =============================================
function renderUnassigned() {
  const unassigned = allData.filter(r => !['Booked','Cancelled','Complete'].includes(r.status) && (!r.trainer || !r.trainer.trim()));
  const search = (document.getElementById('searchInput')?.value || '').toLowerCase();
  const filtered = search ? unassigned.filter(r => (r.company + r.contact).toLowerCase().includes(search)) : unassigned;

  document.getElementById('unassignedBadge').textContent = filtered.length;
  const tbody = document.getElementById('newRequestsBody');

  if (filtered.length === 0) {
    tbody.innerHTML = `<tr><td colspan="5"><div class="empty-state"><div class="empty-state-text">No unassigned requests!</div></div></td></tr>`;
    return;
  }

  tbody.innerHTML = filtered.map(r => `
    <tr>
      <td>${formatDate(r.date)}</td>
      <td><strong>${esc(r.company)}</strong></td>
      <td>${esc(r.contact)}</td>
      <td><span class="option-badge opt-${r.option}">Opt ${r.option}</span></td>
      <td>
        <button class="btn btn-primary btn-sm" onclick="openAssignModal(${r.rowIndex})">Assign</button>
        <button class="btn btn-danger btn-sm" onclick="cancelEnquiry(${r.rowIndex}, 'Unassigned')">Cancel</button>
      </td>
    </tr>
  `).join('');
}

function filterRequests() { renderUnassigned(); }

function openAssignModal(rowIndex) {
  const row = allData.find(r => r.rowIndex === rowIndex);
  if (!row) return;

  document.getElementById('assignRowIndex').value = rowIndex;
  document.getElementById('assignCompanyName').textContent = row.company;
  document.getElementById('assignOptionSelect').value = row.option;
  document.getElementById('assignValueInput').value = row.revenue || OPTION_PRICES[row.option] || 0;
  
  document.getElementById('assignModalOverlay').classList.add('open');
}

function closeAssignModal() {
  document.getElementById('assignModalOverlay').classList.remove('open');
}

function confirmAssignment() {
  const rowIndex = parseInt(document.getElementById('assignRowIndex').value);
  const trainer = document.getElementById('assignTrainerSelect').value;
  const option = document.getElementById('assignOptionSelect').value;
  const value = parseFloat(document.getElementById('assignValueInput').value) || 0;

  if (!trainer) { alert("Please select a trainer."); return; }

  const row = allData.find(r => r.rowIndex === rowIndex);
  if (row) {
    row.trainer = trainer;
    row.option = option;
    row.optionLabel = OPTION_LABELS[option];
    row.revenue = value;
    row.status = 'Pending';
  }

  closeAssignModal();
  showToast('Assigned to ' + trainer, 'success');
  processData();
}

function cancelEnquiry(rowIndex, source) {
  if (!confirm('Are you sure you want to cancel this enquiry? It will be moved to All Bookings.')) return;
  const row = allData.find(r => r.rowIndex === rowIndex);
  if (row) {
    row.status = 'Cancelled';
    row.trainer = ''; // unassign
  }
  showToast('Enquiry cancelled.', '');
  processData();
}

// =============================================
// NEEDS ACTION PANEL
// =============================================
function renderActionPanel() {
  const actionRows = allData.filter(r => r.status === 'Assigned' || r.status === 'Pending');
  document.getElementById('actionBadge').textContent = actionRows.length;
  const tbody = document.getElementById('actionRequestsBody');

  if (actionRows.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-state-text">Nothing needs action.</div></div></td></tr>`;
    return;
  }

  tbody.innerHTML = actionRows.map(r => `
    <tr>
      <td>${formatDate(r.date)}</td>
      <td><strong>${esc(r.company)}</strong></td>
      <td><span class="option-badge opt-${r.option}">Opt ${r.option}</span></td>
      <td><strong>${esc(r.trainer)}</strong></td>
      <td>¬£${r.revenue}</td>
      <td>
        <select class="status-select" onchange="handleActionStatus(${r.rowIndex}, this.value)">
          <option value="${r.status}" selected>${r.status}</option>
          <option value="Booked">Booked</option>
          <option value="Cancelled">Cancelled</option>
        </select>
      </td>
    </tr>
  `).join('');
}

function handleActionStatus(rowIndex, newStatus) {
  if (newStatus === 'Cancelled') {
    cancelEnquiry(rowIndex, 'Action');
  } else if (newStatus === 'Booked') {
    openBookModal(rowIndex);
  }
}

// =============================================
// BOOKING MODAL & CALENDAR LOGIC
// =============================================
function openBookModal(rowIndex) {
  const row = allData.find(r => r.rowIndex === rowIndex);
  if (!row) return;

  document.getElementById('bookRowIndex').value = rowIndex;
  document.getElementById('bookCompanyName').textContent = row.company;
  document.getElementById('bookTrainerSelect').value = row.trainer;
  document.getElementById('bookValueInput').value = row.revenue || OPTION_PRICES[row.option];
  document.getElementById('bookDaysInput').value = OPTION_DAYS[row.option] || 1;
  document.getElementById('bookDateInput').value = '';

  document.getElementById('bookModalOverlay').classList.add('open');
}

function closeBookModal() {
  document.getElementById('bookModalOverlay').classList.remove('open');
  processData(); // resets dropdown if cancelled
}

function confirmBooking() {
  const rowIndex = parseInt(document.getElementById('bookRowIndex').value);
  const dateStr = document.getElementById('bookDateInput').value;
  const trainer = document.getElementById('bookTrainerSelect').value;
  const value = parseFloat(document.getElementById('bookValueInput').value) || 0;
  const days = parseInt(document.getElementById('bookDaysInput').value) || 1;

  if (!dateStr || !trainer) { alert("Please fill in all fields."); return; }

  // Clash Logic & Calendar Block Calculation
  const blockDates = generateDateBlock(dateStr, days);
  
  // 1. Check Weekends & UK Holidays
  const hasWeekend = blockDates.some(d => new Date(d).getDay() === 0 || new Date(d).getDay() === 6);
  const hasHoliday = blockDates.some(d => UK_HOLIDAYS.includes(d));
  if (hasWeekend || hasHoliday) {
    if(!confirm("Warning: These dates overlap with a weekend or a UK Bank Holiday. Proceed?")) return;
  }

  // 2. HARD BLOCKER: Clash detection
  if (checkTrainerClash(trainer, blockDates, rowIndex)) {
    alert(`üö® HARD BLOCKER: ${trainer} is already booked on one or more of these required dates (including Travel/Admin). You cannot double book.`);
    return;
  }

  // Update Data
  const row = allData.find(r => r.rowIndex === rowIndex);
  if (row) {
    row.status = 'Booked';
    row.bookedOn = dateStr;
    row.trainingDays = days;
    row.trainer = trainer;
    row.revenue = value;
    // Save generated block dates to row for calendar rendering
    row.calendarBlock = blockDates;
  }

  closeBookModal();
  showToast('Booking Confirmed!', 'success');
  processData();
}

function generateDateBlock(startDateStr, days) {
  const dates = [];
  const startObj = new Date(startDateStr);
  
  // Travel Day (-1)
  const travel = new Date(startObj); travel.setDate(travel.getDate() - 1);
  dates.push(travel.toISOString().slice(0,10));

  // Training Days
  for(let i=0; i<days; i++) {
    const t = new Date(startObj); t.setDate(t.getDate() + i);
    dates.push(t.toISOString().slice(0,10));
  }

  // Admin Day (+days)
  const admin = new Date(startObj); admin.setDate(admin.getDate() + days);
  dates.push(admin.toISOString().slice(0,10));

  return dates;
}

function checkTrainerClash(trainer, requiredDates, ignoreRowIndex) {
  for (let r of allData) {
    if (r.status === 'Booked' && r.trainer === trainer && r.rowIndex !== ignoreRowIndex) {
      if (r.calendarBlock) {
        const clash = r.calendarBlock.some(d => requiredDates.includes(d));
        if (clash) return true;
      }
    }
  }
  return false;
}

// =============================================
// CALENDAR & WORKLOAD RENDERING
// =============================================
function renderCalendar() {
  const { year, month } = calState;
  const tf = document.getElementById('calFilterTrainer')?.value || '';
  const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('calMonthTitle').textContent = months[month] + ' ' + year;

  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  let startDow = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;

  let cells = '';
  for (let i = 0; i < startDow; i++) cells += '<div class="cal-day cal-day-empty"></div>';

  for (let d = 1; d <= lastDay.getDate(); d++) {
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dayDate = new Date(year, month, d);
    const isWeekend = dayDate.getDay() === 0 || dayDate.getDay() === 6;
    
    // Find events for this day
    const events = [];
    allData.forEach(r => {
      if (r.status === 'Booked' && r.calendarBlock && (!tf || r.trainer === tf)) {
        if (r.calendarBlock[0] === dateStr) events.push({ type: 'travel', title: r.company }); // travel
        else if (r.calendarBlock[r.calendarBlock.length-1] === dateStr) events.push({ type: 'admin', title: r.company }); // admin
        else if (r.calendarBlock.includes(dateStr)) events.push({ type: 'booking', title: r.company }); // training
      }
    });

    cells += `<div class="cal-day ${isWeekend?'cal-day-empty':''}">
      <span class="cal-day-num">${d}</span>
      ${events.map(e => `<span class="cal-event cal-event-${e.type}">${esc(e.title)}</span>`).join('')}
    </div>`;
  }
  document.getElementById('calDays').innerHTML = cells;
}

function calChangeMonth(dir) {
  calState.month += dir;
  if (calState.month > 11) { calState.month = 0; calState.year++; }
  if (calState.month < 0) { calState.month = 11; calState.year--; }
  renderCalendar();
}

function renderTrainerWorkload() {
  const grid = document.getElementById('trainerGrid');
  grid.innerHTML = TRAINERS.map(t => {
    const count = allData.filter(r => r.trainer === t && ['Assigned','Pending','Booked'].includes(r.status)).length;
    return `<div class="trainer-card">
      <div class="trainer-name">${t}</div>
      <div class="trainer-stat"><span>Active Bookings</span> <span class="trainer-stat-val">${count}</span></div>
      <div class="workload-bar-wrap"><div class="workload-bar" style="width:${count*10}%"></div></div>
    </div>`;
  }).join('');
}

function renderAllBookings() {
  const tbody = document.getElementById('allBookingsBody');
  document.getElementById('allBadge').textContent = allData.length;
  tbody.innerHTML = allData.map(r => `
    <tr>
      <td>${formatDate(r.date)}</td>
      <td><strong>${esc(r.company)}</strong></td>
      <td>${esc(r.contact)}</td>
      <td>Opt ${r.option}</td>
      <td>${esc(r.trainer || 'Unassigned')}</td>
      <td>¬£${r.revenue || 0}</td>
      <td><span class="status-badge status-${(r.status||'').toLowerCase()}">${r.status}</span></td>
    </tr>
  `).join('');
}

function renderUpcoming() {
  const body = document.getElementById('calUpcomingBody');
  const items = allData.filter(r => r.status === 'Booked' && r.bookedOn).slice(0, 5);
  body.innerHTML = items.length === 0 ? '<div class="empty-state">No upcoming bookings</div>' : items.map(r => `
    <div class="cal-upcoming-item">
      <div class="cal-upcoming-date"><div class="cal-upcoming-date-day">${r.bookedOn.slice(8,10)}</div></div>
      <div class="cal-upcoming-body-text">
        <div class="cal-upcoming-company">${esc(r.company)}</div>
        <div class="cal-upcoming-meta">${esc(r.trainer)}</div>
      </div>
    </div>
  `).join('');
}

// =============================================
// UTILS & DEMO DATA
// =============================================
function formatDate(d) {
  if (!d) return '‚Äî';
  const dt = new Date(d);
  return isNaN(dt.getTime()) ? d : dt.toLocaleDateString('en-GB', { day:'2-digit', month:'short' });
}
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/[<]/g,'&lt;').replace(/[>]/g,'&gt;'); }

function generateDemoData() {
  return [
    { rowIndex: 1, date: '2026-03-01', company: 'Acorn Estates', contact: 'James', option: '2', status: 'Unassigned', trainer: '', revenue: 0 },
    { rowIndex: 2, date: '2026-03-02', company: 'Bridgewater', contact: 'Sarah', option: '3', status: 'Assigned', trainer: 'James', revenue: 1850 },
    { rowIndex: 3, date: '2026-03-03', company: 'Chapman & Co', contact: 'Mike', option: '4', status: 'Pending', trainer: 'Sarah', revenue: 1000 },
    { rowIndex: 4, date: '2026-03-04', company: 'Dalton Lettings', contact: 'Emma', option: '5', status: 'Booked', trainer: 'Emma', revenue: 220, bookedOn: '2026-03-10', trainingDays: 1, calendarBlock: ['2026-03-09','2026-03-10','2026-03-11'] }
  ];
}

window.onload = loadData;
</script>
</body>
</html>
