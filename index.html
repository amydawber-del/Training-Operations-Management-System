<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Street Training Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --text--dark--50: #19191e;
    --brand--black: #242326;
    --text--dark--40: #4c4d57;
    --text--dark--30: #777989;
    --card-light-grey: #f8f8f8;
    --text--white--30: #979797;
    --text--light--40: #b2b2b2;
    --accent--blue--300: #527dff;
    --accent-blue--200: #7a9cff;
    --text--dark--20: #a8aabb;
    --action-primary-blue: #2147f4;
    --light-grey: #ccc;
    --text-dark-10: #dfe0ec;
    --ui--underline--light-grey: #e5e5e5;
    --success-green: #bde4b9;
    --brand--yellow: #f1c238;
    --brand-accent--mandarin-light: #f6be9d;
    --accent-blue--100: #a3baff;
    --brand-accent--dusty-red-light: #f9b4bc;
    --brand--secondary--lightgreen: #beffd8;
    --accent-blue--50: #b8caff;
    --white-smoke: #fde8eb;
    --brand-accent--cream: #f5ede5;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;
    font-size: 14px;
    line-height: 20px;
    color: #333;
    background-color: #fff;
    min-height: 100vh;
  }

  /* HEADER */
  .header {
    background: var(--brand--black);
    color: #fff;
    height: 52px;
    display: flex;
    align-items: center;
    padding: 0 24px;
    gap: 16px;
    position: sticky;
    top: 0;
    z-index: 100;
    border-bottom: 1px solid #3a3a3a;
  }

  /* HAMBURGER */
  .hamburger-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 6px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    border-radius: 4px;
    transition: background 0.15s;
  }
  .hamburger-btn:hover { background: rgba(255,255,255,0.1); }
  .hamburger-btn span {
    display: block;
    width: 18px;
    height: 2px;
    background: #fff;
    border-radius: 1px;
    transition: all 0.2s;
  }
  .hamburger-btn.open span:nth-child(1) { transform: rotate(45deg) translate(4px, 4px); }
  .hamburger-btn.open span:nth-child(2) { opacity: 0; }
  .hamburger-btn.open span:nth-child(3) { transform: rotate(-45deg) translate(4px, -4px); }

  /* STREET LOGO */
  .street-logo {
    display: flex;
    align-items: center;
    gap: 6px;
    text-decoration: none;
  }
  .street-logo-mark {
    font-size: 15px;
    font-weight: 700;
    letter-spacing: -0.5px;
    color: #fff;
    font-family: Arial, sans-serif;
    line-height: 1;
  }
  .street-logo-mark .logo-dot { color: var(--brand--yellow); }
  .street-logo-sub {
    font-size: 9px;
    color: var(--text--light--40);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-top: 1px;
  }

  .header-title {
    font-size: 15px;
    font-weight: 600;
    color: #fff;
    letter-spacing: -0.2px;
    flex: 1;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .refresh-btn {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.15);
    color: #fff;
    padding: 5px 12px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    transition: background 0.15s;
    font-family: Arial, sans-serif;
  }
  .refresh-btn:hover { background: rgba(255,255,255,0.2); }

  .last-updated {
    font-size: 11px;
    color: var(--text--light--40);
  }

  /* SIDE NAV DRAWER */
  .nav-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    z-index: 200;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }
  .nav-overlay.open { opacity: 1; pointer-events: all; }

  .nav-drawer {
    position: fixed;
    top: 0;
    left: -280px;
    width: 260px;
    height: 100vh;
    background: var(--brand--black);
    z-index: 201;
    transition: left 0.22s ease;
    display: flex;
    flex-direction: column;
    box-shadow: 2px 0 8px rgba(0,0,0,0.3);
  }
  .nav-drawer.open { left: 0; }

  .nav-drawer-header {
    padding: 16px 20px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 52px;
  }
  .nav-drawer-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--text--light--40);
    letter-spacing: 1px;
    text-transform: uppercase;
  }
  .nav-close {
    background: none;
    border: none;
    color: var(--text--light--40);
    cursor: pointer;
    font-size: 18px;
    line-height: 1;
    padding: 2px 6px;
    border-radius: 4px;
    transition: color 0.15s;
  }
  .nav-close:hover { color: #fff; }

  .nav-section-label {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 1.2px;
    text-transform: uppercase;
    color: var(--text--dark--30);
    padding: 16px 20px 8px;
  }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 20px;
    color: #ccc;
    text-decoration: none;
    font-size: 13px;
    transition: background 0.12s, color 0.12s;
    border-left: 3px solid transparent;
  }
  .nav-item:hover {
    background: rgba(255,255,255,0.06);
    color: #fff;
    border-left-color: var(--accent--blue--300);
  }
  .nav-item.active {
    background: rgba(33, 71, 244, 0.15);
    color: var(--accent-blue--200);
    border-left-color: var(--action-primary-blue);
  }
  .nav-item-icon { font-size: 15px; width: 20px; text-align: center; }

  .nav-divider {
    height: 1px;
    background: rgba(255,255,255,0.08);
    margin: 8px 20px;
  }

  /* MAIN CONTENT */
  .main {
    padding: 24px;
    max-width: 1400px;
    margin: 0 auto;
  }

  /* LOADING */
  .loading-bar {
    height: 3px;
    background: linear-gradient(90deg, var(--action-primary-blue), var(--accent--blue--300));
    animation: loading 1.2s ease infinite;
    display: none;
  }
  .loading-bar.active { display: block; }
  @keyframes loading {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(200%); }
  }

  /* SECTION */
  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }
  .section-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--text--dark--50);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .section-title .badge {
    background: var(--brand-accent--dusty-red-light);
    color: #c0303d;
    font-size: 11px;
    font-weight: 700;
    padding: 1px 7px;
    border-radius: 10px;
    min-width: 20px;
    text-align: center;
  }
  .section-title .badge.green {
    background: var(--success-green);
    color: #2a7a26;
  }

  /* NEW REQUESTS PANEL */
  .requests-panel {
    border: 1px solid var(--ui--underline--light-grey);
    border-radius: 4px;
    margin-bottom: 24px;
    overflow: hidden;
  }
  .requests-panel-header {
    background: var(--card-light-grey);
    padding: 12px 16px;
    border-bottom: 1px solid var(--ui--underline--light-grey);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .requests-panel-header-left {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .alert-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #e53935;
    animation: pulse-dot 1.5s ease infinite;
  }
  @keyframes pulse-dot {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.8); }
  }

  /* TABLE */
  .table-wrap { overflow-x: auto; }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }
  thead tr {
    background: var(--card-light-grey);
  }
  th {
    padding: 10px 14px;
    text-align: left;
    font-weight: 600;
    font-size: 11px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    color: var(--text--dark--30);
    border-bottom: 1px solid var(--ui--underline--light-grey);
    white-space: nowrap;
  }
  td {
    padding: 10px 14px;
    border-bottom: 1px solid var(--ui--underline--light-grey);
    color: var(--text--dark--40);
    vertical-align: middle;
  }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: #fafafa; }

  .option-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    white-space: nowrap;
  }
  .opt-1 { background: var(--accent-blue--50); color: #2147f4; }
  .opt-2 { background: var(--brand-accent--cream); color: #8a5a2a; }
  .opt-3 { background: var(--brand-accent--mandarin-light); color: #a04010; }
  .opt-4 { background: var(--success-green); color: #2a7a26; }
  .opt-5 { background: var(--brand--secondary--lightgreen); color: #1a6a40; }

  .status-badge {
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
  }
  .status-new { background: var(--white-smoke); color: #c0303d; }
  .status-unassigned { background: var(--white-smoke); color: #c0303d; }
  .status-assigned { background: var(--brand-accent--cream); color: #8a5a2a; }
  .status-booked { background: var(--accent-blue--50); color: #2147f4; }
  .status-pending { background: var(--brand--secondary--lightgreen); color: #1a6a40; }
  .status-cancelled { background: #f0f0f0; color: #999; text-decoration: line-through; }
  .status-complete { background: var(--success-green); color: #2a7a26; }

  /* ASSIGN CONTROLS */
  .assign-row {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .suggested-trainer {
    font-size: 11px;
    color: var(--action-primary-blue);
    background: rgba(33,71,244,0.08);
    padding: 2px 8px;
    border-radius: 4px;
    white-space: nowrap;
  }
  select.trainer-select {
    border: 1px solid var(--light-grey);
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 12px;
    font-family: Arial, sans-serif;
    color: #333;
    background: #fff;
    cursor: pointer;
  }
  select.trainer-select:focus { outline: none; border-color: var(--action-primary-blue); }

  .btn {
    padding: 5px 12px;
    border-radius: 4px;
    font-size: 12px;
    font-family: Arial, sans-serif;
    cursor: pointer;
    border: none;
    font-weight: 600;
    transition: background 0.15s;
  }
  .btn-primary {
    background: var(--action-primary-blue);
    color: #fff;
  }
  .btn-primary:hover { background: #1a39d4; }
  .btn-primary:disabled { background: var(--text--dark--20); cursor: not-allowed; }
  .btn-sm { padding: 4px 10px; font-size: 11px; }
  .btn-ghost {
    background: none;
    border: 1px solid var(--light-grey);
    color: var(--text--dark--30);
  }
  .btn-ghost:hover { background: var(--card-light-grey); color: #333; }

  /* KPI CARDS */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }
  .kpi-card {
    border: 1px solid var(--ui--underline--light-grey);
    border-radius: 4px;
    padding: 16px 20px;
    background: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  }
  .kpi-card-label {
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    color: var(--text--dark--30);
    margin-bottom: 8px;
  }
  .kpi-card-value {
    font-size: 28px;
    font-weight: 700;
    color: var(--text--dark--50);
    line-height: 1.1;
    letter-spacing: -0.5px;
  }
  .kpi-card-sub {
    font-size: 11px;
    color: var(--text--dark--30);
    margin-top: 4px;
  }
  .kpi-card-delta {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    font-size: 11px;
    font-weight: 600;
    padding: 1px 6px;
    border-radius: 4px;
    margin-top: 6px;
  }
  .delta-up { background: var(--success-green); color: #2a7a26; }
  .delta-down { background: var(--white-smoke); color: #c0303d; }
  .kpi-accent-left {
    border-left: 3px solid var(--action-primary-blue);
    padding-left: 14px;
  }
  .kpi-accent-yellow { border-left-color: var(--brand--yellow); }
  .kpi-accent-green { border-left-color: #4caf50; }
  .kpi-accent-orange { border-left-color: #ff7043; }

  /* CHARTS GRID */
  .charts-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 16px;
    margin-bottom: 24px;
  }
  @media (max-width: 900px) { .charts-grid { grid-template-columns: 1fr; } }

  .chart-card {
    border: 1px solid var(--ui--underline--light-grey);
    border-radius: 4px;
    padding: 20px;
    background: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  }
  .chart-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text--dark--50);
    margin-bottom: 4px;
  }
  .chart-subtitle {
    font-size: 11px;
    color: var(--text--dark--30);
    margin-bottom: 16px;
  }
  .chart-container { position: relative; }

  /* TRAINER WORKLOAD */
  .trainer-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 12px;
    margin-bottom: 24px;
  }
  .trainer-card {
    border: 1px solid var(--ui--underline--light-grey);
    border-radius: 4px;
    padding: 14px 16px;
    background: #fff;
  }
  .trainer-name {
    font-size: 13px;
    font-weight: 600;
    color: var(--text--dark--50);
    margin-bottom: 10px;
  }
  .trainer-stat {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    color: var(--text--dark--30);
    margin-bottom: 4px;
  }
  .trainer-stat-val { font-weight: 600; color: var(--text--dark--40); }
  .workload-bar-wrap {
    height: 4px;
    background: var(--ui--underline--light-grey);
    border-radius: 2px;
    margin-top: 8px;
    overflow: hidden;
  }
  .workload-bar {
    height: 100%;
    border-radius: 2px;
    background: var(--action-primary-blue);
    transition: width 0.4s ease;
  }
  .workload-bar.busy { background: #ff7043; }
  .workload-bar.medium { background: var(--brand--yellow); }

  .suggested-tag {
    display: inline-block;
    font-size: 10px;
    font-weight: 600;
    background: var(--brand--secondary--lightgreen);
    color: #1a6a40;
    padding: 1px 6px;
    border-radius: 4px;
    margin-top: 6px;
  }

  /* ALL BOOKINGS TABLE */
  .all-bookings {
    border: 1px solid var(--ui--underline--light-grey);
    border-radius: 4px;
    margin-bottom: 24px;
    overflow: hidden;
  }

  /* EMPTY STATE */
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text--dark--30);
  }
  .empty-state-icon { font-size: 32px; margin-bottom: 8px; }
  .empty-state-text { font-size: 13px; }

  /* TOAST */
  .toast-container {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 999;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .toast {
    background: var(--brand--black);
    color: #fff;
    padding: 10px 16px;
    border-radius: 4px;
    font-size: 13px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    animation: slideIn 0.2s ease;
    border-left: 3px solid var(--action-primary-blue);
  }
  .toast.success { border-left-color: #4caf50; }
  .toast.error { border-left-color: #e53935; }
  @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: none; opacity: 1; } }

  /* MONTH VS CARDS */
  .compare-cards {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
  }
  .compare-card {
    background: var(--card-light-grey);
    border-radius: 4px;
    padding: 12px 14px;
    text-align: center;
  }
  .compare-card-label { font-size: 10px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; color: var(--text--dark--30); margin-bottom: 4px; }
  .compare-card-value { font-size: 22px; font-weight: 700; color: var(--text--dark--50); }

  /* SPINNER */
  .spinner {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid var(--text-dark-10);
    border-top-color: var(--action-primary-blue);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* PAGINATION */
  .pagination {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    border-top: 1px solid var(--ui--underline--light-grey);
    background: var(--card-light-grey);
    font-size: 12px;
    color: var(--text--dark--30);
  }
  .page-btn {
    background: #fff;
    border: 1px solid var(--light-grey);
    border-radius: 4px;
    padding: 3px 10px;
    font-size: 12px;
    cursor: pointer;
    font-family: Arial, sans-serif;
    transition: background 0.12s;
  }
  .page-btn:hover:not(:disabled) { background: var(--card-light-grey); }
  .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  /* FILTER BAR */
  .filter-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }
  select.filter-select, input.filter-input {
    border: 1px solid var(--light-grey);
    border-radius: 4px;
    padding: 5px 10px;
    font-size: 12px;
    font-family: Arial, sans-serif;
    color: #333;
    background: #fff;
  }
  select.filter-select:focus, input.filter-input:focus { outline: none; border-color: var(--action-primary-blue); }

  .data-note {
    font-size: 11px;
    color: var(--text--dark--20);
    padding: 8px 16px;
    background: var(--card-light-grey);
    border-top: 1px solid var(--ui--underline--light-grey);
  }

  /* ‚îÄ‚îÄ Generic Modal Overlay ‚îÄ‚îÄ */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:500;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s;}
  .modal-overlay.open{opacity:1;pointer-events:all;}
  .modal{background:#fff;border-radius:8px;width:420px;max-width:96vw;box-shadow:0 8px 32px rgba(0,0,0,.2);overflow:hidden;}
  .modal-header{background:var(--brand--black);color:#fff;padding:16px 20px;display:flex;align-items:center;justify-content:space-between;}
  .modal-title{font-size:14px;font-weight:600;}
  .modal-close{background:none;border:none;color:#aaa;cursor:pointer;font-size:18px;line-height:1;padding:2px 6px;border-radius:4px;}
  .modal-close:hover{color:#fff;}
  .modal-body{padding:20px;}
  .trainer-list{display:flex;flex-direction:column;gap:6px;}
  .trainer-add-input{border:1px solid var(--light-grey);border-radius:4px;padding:7px 10px;font-size:13px;font-family:Arial,sans-serif;}
  /* ‚îÄ‚îÄ Login Screen ‚îÄ‚îÄ */
  .login-screen{position:fixed;inset:0;background:linear-gradient(135deg,#0d1526 0%,#1a2a4a 50%,#0d1526 100%);z-index:9999;display:flex;align-items:center;justify-content:center;}
  .login-screen.hidden{display:none;}
  .login-card{background:#fff;border-radius:14px;padding:36px 36px 28px;width:480px;max-width:96vw;box-shadow:0 24px 80px rgba(0,0,0,.4);}
  .login-logo{font-size:13px;font-weight:800;letter-spacing:2px;color:var(--text--dark--50);text-transform:uppercase;margin-bottom:4px;}
  .login-logo span{color:var(--action-primary-blue);}
  .login-title{font-size:22px;font-weight:700;color:var(--text--dark--50);margin-bottom:4px;margin-top:20px;}
  .login-sub{font-size:13px;color:var(--text--dark--30);margin-bottom:28px;}
  .login-user-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;max-height:320px;overflow-y:auto;}
  .login-user-btn{display:flex;flex-direction:column;align-items:center;gap:8px;padding:16px 12px;border:1.5px solid var(--ui--underline--light-grey);border-radius:10px;background:#fff;cursor:pointer;transition:all .15s;font-family:Arial,sans-serif;text-align:center;}
  .login-user-btn:hover{border-color:var(--action-primary-blue);background:#f6f8ff;box-shadow:0 2px 12px rgba(33,71,244,.12);}
  .login-user-avatar{width:44px;height:44px;border-radius:50%;background:var(--action-primary-blue);color:#fff;font-size:16px;font-weight:700;display:flex;align-items:center;justify-content:center;}
  .login-user-name{font-size:13px;font-weight:600;color:var(--text--dark--50);}
  .login-user-role{font-size:10px;color:var(--text--dark--30);text-transform:uppercase;letter-spacing:.6px;}
  .login-user-badge{display:inline-flex;align-items:center;gap:3px;font-size:9px;font-weight:700;padding:2px 6px;border-radius:8px;letter-spacing:.5px;text-transform:uppercase;}
  .login-user-badge.admin{background:#fde8eb;color:#c0303d;}
  .login-user-badge.editor{background:#e8f0ff;color:#2147f4;}
  .login-user-badge.viewer{background:#f0f0f0;color:#888;}
  /* ‚îÄ‚îÄ PIN Screen ‚îÄ‚îÄ */
  .pin-screen{position:fixed;inset:0;background:linear-gradient(135deg,#0d1526 0%,#1a2a4a 50%,#0d1526 100%);z-index:9998;display:flex;align-items:center;justify-content:center;}
  .pin-screen.hidden{display:none;}
  .pin-card{background:#fff;border-radius:14px;padding:32px 32px 26px;width:340px;max-width:96vw;box-shadow:0 24px 80px rgba(0,0,0,.4);text-align:center;}
  .pin-avatar{width:56px;height:56px;border-radius:50%;background:var(--action-primary-blue);color:#fff;font-size:20px;font-weight:700;display:flex;align-items:center;justify-content:center;margin:0 auto 10px;}
  .pin-user-name{font-size:18px;font-weight:700;color:var(--text--dark--50);margin-bottom:4px;}
  .pin-label{font-size:13px;color:var(--text--dark--30);margin-bottom:20px;}
  .pin-dots{display:flex;justify-content:center;gap:12px;margin-bottom:24px;}
  .pin-dot{width:16px;height:16px;border-radius:50%;border:2px solid #ccc;background:transparent;transition:all .15s;}
  .pin-dot.filled{background:var(--action-primary-blue);border-color:var(--action-primary-blue);}
  .pin-dot.error{background:#c0303d;border-color:#c0303d;}
  .pin-keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px;}
  .pin-key{padding:14px 0;border:1.5px solid #e5e7eb;border-radius:8px;background:#fff;font-size:18px;font-weight:600;color:var(--text--dark--50);cursor:pointer;font-family:Arial,sans-serif;transition:all .1s;user-select:none;}
  .pin-key:hover{background:#f0f4ff;border-color:var(--action-primary-blue);}
  .pin-key:active{transform:scale(.94);background:#e0e8ff;}
  .pin-key.del{font-size:15px;color:#888;}
  .pin-error-msg{font-size:12px;color:#c0303d;min-height:18px;margin-bottom:6px;}
  .pin-back-btn{background:none;border:none;color:var(--text--dark--30);font-size:12px;cursor:pointer;font-family:Arial,sans-serif;padding:4px 8px;border-radius:4px;transition:color .12s;text-decoration:underline;}
  .pin-back-btn:hover{color:var(--action-primary-blue);}
  .pin-setup-info{font-size:11px;color:var(--text--dark--30);margin-bottom:18px;line-height:1.5;padding:8px 10px;background:#f6f8ff;border-radius:6px;border:1px solid #e0e8ff;}
  /* ‚îÄ‚îÄ Shadow Banner ‚îÄ‚îÄ */
  .shadow-banner{display:none;position:fixed;top:0;left:0;right:0;z-index:950;background:linear-gradient(90deg,#7c3aed,#5b21b6);color:#fff;padding:9px 20px;font-size:12px;font-weight:600;align-items:center;justify-content:space-between;gap:12px;box-shadow:0 2px 12px rgba(124,58,237,.4);}
  .shadow-banner.active{display:flex;}
  body.shadow-mode .header,.body.shadow-mode .loading-bar,.body.shadow-mode .main{margin-top:37px;}
  /* ‚îÄ‚îÄ Activity Panel ‚îÄ‚îÄ */
  .activity-btn{position:relative;display:flex;align-items:center;gap:6px;padding:5px 12px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:5px;color:#ccc;cursor:pointer;font-size:12px;font-weight:600;font-family:Arial,sans-serif;transition:all .15s;white-space:nowrap;}
  .activity-btn:hover{background:rgba(255,255,255,.15);color:#fff;}
  .activity-btn-dot{position:absolute;top:-3px;right:-3px;width:8px;height:8px;border-radius:50%;background:#f59e0b;border:2px solid var(--text--dark--50);display:none;}
  .activity-btn-dot.visible{display:block;}
  .activity-panel{position:fixed;top:0;right:0;width:380px;max-width:95vw;height:100vh;background:#fff;box-shadow:-4px 0 32px rgba(0,0,0,.18);z-index:600;display:flex;flex-direction:column;transform:translateX(100%);transition:transform .28s cubic-bezier(.4,0,.2,1);}
  .activity-panel.open{transform:translateX(0);}
  .activity-panel-overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:599;opacity:0;pointer-events:none;transition:opacity .25s;}
  .activity-panel-overlay.open{opacity:1;pointer-events:all;}
  .activity-panel-header{padding:16px 20px;border-bottom:1px solid var(--ui--underline--light-grey);display:flex;align-items:center;justify-content:space-between;background:var(--text--dark--50);color:#fff;flex-shrink:0;}
  .activity-item{display:flex;gap:12px;padding:11px 16px;border-bottom:1px solid #f3f4f6;transition:background .1s;}
  .activity-item:hover{background:#fafbff;}
  .activity-date-divider{padding:6px 16px 3px;font-size:10px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;color:var(--text--dark--20);background:var(--card-light-grey);border-bottom:1px solid var(--ui--underline--light-grey);border-top:1px solid var(--ui--underline--light-grey);}
  /* ‚îÄ‚îÄ Permissions ‚îÄ‚îÄ */
  .perm-toggle{position:relative;width:36px;height:20px;flex-shrink:0;}
  .perm-toggle input{opacity:0;width:0;height:0;}
  .perm-toggle-slider{position:absolute;inset:0;background:#ccc;border-radius:20px;cursor:pointer;transition:background .2s;}
  .perm-toggle-slider::before{content:'';position:absolute;width:14px;height:14px;left:3px;top:3px;background:#fff;border-radius:50%;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.2);}
  .perm-toggle input:checked + .perm-toggle-slider{background:var(--action-primary-blue);}
  .perm-toggle input:checked + .perm-toggle-slider::before{transform:translateX(16px);}
  .perm-preset-btn{flex:1;padding:6px 4px;border-radius:5px;border:1.5px solid var(--ui--underline--light-grey);background:#fff;font-size:11px;font-weight:600;cursor:pointer;font-family:Arial,sans-serif;transition:all .12s;}
  .perm-preset-btn:hover{border-color:var(--action-primary-blue);background:#f0f4ff;}
  .perm-preset-btn.active{border-color:var(--action-primary-blue);background:var(--action-primary-blue);color:#fff;}
  /* ‚îÄ‚îÄ Calendar ‚îÄ‚îÄ */
  .cal-section{margin-bottom:24px;}
  .cal-grid{display:grid;grid-template-columns:minmax(0,1fr) 300px;gap:16px;align-items:start;}
  @media(max-width:900px){.cal-grid{grid-template-columns:1fr;}}
  .cal-month-card{background:#fff;border:1px solid var(--ui--underline--light-grey);border-radius:8px;overflow:hidden;min-width:0;}
  .cal-month-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--text--dark--50);color:#fff;}
  .cal-month-title{font-size:14px;font-weight:700;}
  .cal-nav-btn{background:rgba(255,255,255,.12);border:none;color:#fff;cursor:pointer;padding:4px 10px;border-radius:4px;font-size:14px;font-family:Arial,sans-serif;transition:background .12s;}
  .cal-nav-btn:hover{background:rgba(255,255,255,.22);}
  .cal-dow-row{display:flex;width:100%;background:var(--card-light-grey);border-bottom:1px solid var(--ui--underline--light-grey);}
  .cal-dow{flex:0 0 calc(100% / 7);text-align:center;font-size:10px;font-weight:700;color:var(--text--dark--30);padding:6px 0;letter-spacing:.5px;text-transform:uppercase;}
  .cal-days{display:flex;flex-wrap:wrap;width:100%;border-top:1px solid #f3f4f6;border-left:1px solid #f3f4f6;}
  .cal-day{flex:0 0 calc(100% / 7);min-height:80px;padding:5px 4px 4px;border-right:1px solid #f3f4f6;border-bottom:1px solid #f3f4f6;overflow:hidden;}
  .cal-day:hover:not(.cal-day-empty){background:#f6f8ff;}
  .cal-day-empty{background:#fafafa;}
  .cal-day-num{font-size:11px;font-weight:600;color:var(--text--dark--30);display:block;margin-bottom:3px;line-height:1;}
  .cal-day-today .cal-day-num{background:var(--action-primary-blue);color:#fff;width:20px;height:20px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:10px;}
  .cal-event{display:block;font-size:9px;font-weight:600;padding:2px 5px;border-radius:3px;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer;}
  .cal-event-booking{background:#b8caff;color:#1838c0;}
  .cal-event-blocked{background:#fde8eb;color:#c0303d;}
  .cal-event-gcal{background:#beffd8;color:#1a6a40;}
  .cal-upcoming-card{background:#fff;border:1px solid var(--ui--underline--light-grey);border-radius:8px;overflow:hidden;max-height:500px;display:flex;flex-direction:column;}
  .cal-upcoming-header{padding:12px 16px;background:var(--card-light-grey);border-bottom:1px solid var(--ui--underline--light-grey);font-size:12px;font-weight:700;color:var(--text--dark--40);}
  .cal-upcoming-item{padding:10px 14px;border-bottom:1px solid #f3f4f6;display:flex;gap:10px;align-items:flex-start;}
  .cal-upcoming-date{min-width:38px;text-align:center;background:var(--card-light-grey);border-radius:6px;padding:4px 6px;flex-shrink:0;}
  /* ‚îÄ‚îÄ Booked Date Modal ‚îÄ‚îÄ */
  .booked-date-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1200;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .15s;}
  .booked-date-modal-overlay.open{opacity:1;pointer-events:all;}
  .booked-date-modal{background:#fff;border-radius:12px;width:400px;max-width:94vw;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.25);transform:translateY(12px);transition:transform .15s;}
  .booked-date-modal-overlay.open .booked-date-modal{transform:translateY(0);}
  .bd-days-btn{flex:1;padding:8px 4px;border:2px solid var(--ui--underline--light-grey);border-radius:6px;background:#fff;color:var(--text--dark--40);font-size:12px;font-weight:600;font-family:Arial,sans-serif;cursor:pointer;transition:all .12s;}
  .bd-days-btn:hover{border-color:var(--action-primary-blue);color:var(--action-primary-blue);}
  .bd-days-btn.active{border-color:var(--action-primary-blue);background:var(--action-primary-blue);color:#fff;}
  /* ‚îÄ‚îÄ KPI Modal ‚îÄ‚îÄ */
  .kpi-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:400;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s;}
  .kpi-modal-overlay.open{opacity:1;pointer-events:all;}
  .kpi-modal{background:#fff;border-radius:8px;width:860px;max-width:96vw;max-height:88vh;display:flex;flex-direction:column;box-shadow:0 12px 48px rgba(0,0,0,.25);overflow:hidden;}
  .kpi-card.clickable{cursor:pointer;transition:box-shadow .15s,border-color .15s,background .15s;}
  .kpi-card.clickable:hover{box-shadow:0 4px 16px rgba(33,71,244,.10);border-color:rgba(33,71,244,.35);background:#f6f8ff;}
  /* ‚îÄ‚îÄ Nav jump ‚îÄ‚îÄ */
  .nav-jump-item{display:flex;align-items:center;gap:10px;padding:7px 20px;font-size:12px;color:var(--text--dark--40);cursor:pointer;text-decoration:none;transition:all .15s;border:none;background:none;width:100%;text-align:left;font-family:Arial,sans-serif;}
  .nav-jump-item:hover{background:rgba(33,71,244,.06);color:var(--action-primary-blue);}
  /* ‚îÄ‚îÄ Username modal ‚îÄ‚îÄ */
  .username-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:700;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s;}
  .username-modal-overlay.open{opacity:1;pointer-events:all;}
  .username-modal{background:#fff;border-radius:10px;width:360px;max-width:94vw;padding:28px 28px 22px;box-shadow:0 12px 48px rgba(0,0,0,.25);text-align:center;}
</style>
</head>
<body>

<!-- NAV OVERLAY -->
<div class="nav-overlay" id="navOverlay" onclick="closeNav()"></div>

<!-- SIDE DRAWER -->
<nav class="nav-drawer" id="navDrawer">
  <div class="nav-drawer-header">
    <span class="nav-drawer-title">Navigation</span>
    <button class="nav-close" onclick="closeNav()">‚úï</button>
  </div>
  <div class="nav-section-label">Dashboard</div>
  <a href="#" class="nav-item active" onclick="closeNav()"><span class="nav-item-icon">üìä</span> Training Dashboard</a>
  <div class="nav-divider"></div>
  <div style="padding:8px 20px 4px;font-size:9px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;color:var(--text--dark--20);">Jump to section</div>
  <button class="nav-jump-item" onclick="scrollToSection('sectionWorkload')"><span style="font-size:13px;width:20px;text-align:center;">üë§</span><span style="flex:1;">Trainer Workload</span><span style="font-size:10px;color:var(--text--dark--20);">‚Üì</span></button>
  <button class="nav-jump-item" onclick="scrollToSection('sectionUnassigned')"><span style="font-size:13px;width:20px;text-align:center;">üîî</span><span style="flex:1;">Unassigned Requests</span><span style="font-size:10px;color:var(--text--dark--20);">‚Üì</span></button>
  <button class="nav-jump-item" id="navJumpCalendar" onclick="scrollToSection('calSection')"><span style="font-size:13px;width:20px;text-align:center;">üìÖ</span><span style="flex:1;">Training Calendar</span><span style="font-size:10px;color:var(--text--dark--20);">‚Üì</span></button>
  <button class="nav-jump-item" onclick="scrollToSection('sectionNeedsAction')"><span style="font-size:13px;width:20px;text-align:center;">‚ö†Ô∏è</span><span style="flex:1;">Needs Action</span><span style="font-size:10px;color:var(--text--dark--20);">‚Üì</span></button>
  <button class="nav-jump-item" onclick="scrollToSection('sectionPerformance')"><span style="font-size:13px;width:20px;text-align:center;">üìà</span><span style="flex:1;">Performance Review</span><span style="font-size:10px;color:var(--text--dark--20);">‚Üì</span></button>
  <button class="nav-jump-item" onclick="scrollToSection('sectionAllBookings')"><span style="font-size:13px;width:20px;text-align:center;">üìã</span><span style="flex:1;">All Bookings</span><span style="font-size:10px;color:var(--text--dark--20);">‚Üì</span></button>
  <div class="nav-divider"></div>
  <div class="nav-section-label">Tools</div>
  <a href="https://amydawber-del.github.io/TrainingCSAT/dashboard.html" class="nav-item" target="_blank" id="navFeedback"><span class="nav-item-icon">‚≠ê</span> Training Feedback Dashboard</a>
  <a href="https://amydawber-del.github.io/TilTracker/" class="nav-item" target="_blank" id="navTil"><span class="nav-item-icon">üìö</span> TIL Tracker</a>
  <a href="https://amydawber-del.github.io/TrainingCSAT/" class="nav-item" target="_blank" id="navSurvey"><span class="nav-item-icon">üìã</span> Client Feedback Survey</a>
  <div class="nav-divider"></div>
  <div class="nav-section-label">Resources</div>
  <a href="https://docs.google.com/spreadsheets/d/1r_HODYw7kIMpWm8TNcXwJmZQuk0lsjVR6SEl2teytJM/edit" class="nav-item" target="_blank" id="navSpreadsheet"><span class="nav-item-icon">üìÑ</span> Bookings Spreadsheet</a>
  <a href="https://docs.google.com/forms/d/e/1FAIpQLSe-s3SWoPSaIanCZLMLYNnVmu3NU-LY4Lm7Db12gHLv6LzVuQ/viewform" class="nav-item" target="_blank" id="navRequestForm"><span class="nav-item-icon">üìù</span> Training Request Form</a>
</nav>

<!-- LOGIN SCREEN -->
<div class="login-screen hidden" id="loginScreen">
  <div class="login-card">
    <div class="login-logo">STREET<span>.</span>CO.UK</div>
    <div class="login-title">Training Dashboard</div>
    <div class="login-sub">Select your name to continue</div>
    <div class="login-user-grid" id="loginUserGrid"></div>
    <div style="text-align:center;font-size:11px;color:var(--text--dark--20);margin-top:8px;">Permissions are managed in Trainer settings</div>
  </div>
</div>

<!-- PIN SCREEN -->
<div class="pin-screen hidden" id="pinScreen">
  <div class="pin-card">
    <div class="pin-avatar" id="pinAvatar">?</div>
    <div class="pin-user-name" id="pinUserName">‚Äî</div>
    <div class="pin-label" id="pinLabel">Enter your 4-digit passcode</div>
    <div id="pinSetupInfo" class="pin-setup-info" style="display:none;">Choose a 4-digit passcode to protect your account.</div>
    <div class="pin-dots">
      <div class="pin-dot" id="pd0"></div><div class="pin-dot" id="pd1"></div>
      <div class="pin-dot" id="pd2"></div><div class="pin-dot" id="pd3"></div>
    </div>
    <div class="pin-error-msg" id="pinError"></div>
    <div class="pin-keypad">
      <button class="pin-key" onclick="pinKey('1')">1</button><button class="pin-key" onclick="pinKey('2')">2</button><button class="pin-key" onclick="pinKey('3')">3</button>
      <button class="pin-key" onclick="pinKey('4')">4</button><button class="pin-key" onclick="pinKey('5')">5</button><button class="pin-key" onclick="pinKey('6')">6</button>
      <button class="pin-key" onclick="pinKey('7')">7</button><button class="pin-key" onclick="pinKey('8')">8</button><button class="pin-key" onclick="pinKey('9')">9</button>
      <button class="pin-key" onclick="pinKey('0')" style="grid-column:2;">0</button>
      <button class="pin-key del" onclick="pinDel()">‚å´</button>
    </div>
    <div id="pinForgotWrap"><button class="pin-back-btn" onclick="pinForgot()">Forgot passcode?</button></div>
    <div style="margin-top:10px;"><button class="pin-back-btn" onclick="pinBack()">‚Üê Back to user select</button></div>
  </div>
</div>

<!-- SHADOW MODE BANNER -->
<div class="shadow-banner" id="shadowBanner">
  <div style="display:flex;align-items:center;gap:10px;">
    <span style="background:rgba(255,255,255,.18);border-radius:20px;padding:2px 10px;font-size:11px;letter-spacing:.4px;text-transform:uppercase;">üëÅ Preview Mode</span>
    <span>Viewing as</span>
    <strong id="shadowBannerName">‚Äî</strong>
  </div>
  <div style="display:flex;align-items:center;gap:8px;">
    <button onclick="exitShadowMode()" style="background:rgba(255,255,255,.15);border:1.5px solid rgba(255,255,255,.35);color:#fff;border-radius:6px;padding:5px 14px;font-size:11px;font-weight:700;cursor:pointer;font-family:Arial,sans-serif;">‚Üê Exit Preview</button>
    <button onclick="saveShadowAndExit()" style="background:#fff;border:none;color:#5b21b6;border-radius:6px;padding:5px 14px;font-size:11px;font-weight:700;cursor:pointer;font-family:Arial,sans-serif;">‚úì Save &amp; Back</button>
  </div>
</div>

<!-- HEADER -->
<header class="header">
  <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleNav()" aria-label="Menu">
    <span></span><span></span><span></span>
  </button>
  <a href="#" class="street-logo">
    <div class="street-logo-mark">STREET<span class="logo-dot">.</span><span style="font-size:9px;font-weight:400;letter-spacing:0;">CO.UK</span></div>
  </a>
  <div class="header-title">Training Dashboard</div>
  <div class="header-right">
    <span class="last-updated" id="lastUpdated">‚Äî</span>
    <div id="headerUserChip" style="display:none;align-items:center;gap:7px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:20px;padding:4px 12px 4px 6px;">
      <div id="headerUserAvatar" style="width:24px;height:24px;border-radius:50%;background:var(--action-primary-blue);color:#fff;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;">?</div>
      <span id="headerUserName" style="font-size:12px;font-weight:600;color:#ddd;">‚Äî</span>
    </div>
    <button class="activity-btn" onclick="openActivityPanel()" title="Activity Feed">
      <span>üïê</span> Activity
      <span class="activity-btn-dot" id="activityBtnDot"></span>
    </button>
    <button class="activity-btn" id="logoutBtn" onclick="logout()" style="display:none;border-color:rgba(192,48,61,.4);color:#f88;background:rgba(192,48,61,.15);">‚èè Log out</button>
    <button class="refresh-btn" onclick="testConnection(this)" style="background:rgba(255,200,0,.15);border-color:rgba(255,200,0,.3);">üîç Test</button>
    <button class="refresh-btn" onclick="loadData()">‚Üª Refresh</button>
  </div>
</header>

<div class="loading-bar" id="loadingBar"></div>

<!-- MAIN -->
<main class="main">

  <!-- TRAINER WORKLOAD -->
  <div id="sectionWorkload" style="margin-bottom:24px;">
    <div class="section-header">
      <div class="section-title">üë§ Trainer Workload</div>
      <div style="display:flex;align-items:center;gap:10px;">
        <span style="font-size:11px;color:var(--text--dark--30);">Last 30 days + upcoming</span>
        <button class="refresh-btn" onclick="openTrainerModal()" style="background:rgba(33,71,244,.1);border-color:rgba(33,71,244,.3);color:var(--action-primary-blue);font-size:11px;">+ Manage Trainers</button>
      </div>
    </div>
    <div class="trainer-grid" id="trainerGrid">
      <div class="kpi-card" style="text-align:center;color:var(--text--dark--30);font-size:12px;grid-column:1/-1;">Loading trainer data...</div>
    </div>
  </div>

  <!-- NEW REQUESTS SECTION -->
  <div id="sectionUnassigned" style="margin-bottom:24px;">
    <div class="section-header">
      <div class="section-title">
        üîî Unassigned Requests
        <span class="badge" id="unassignedBadge">0</span>
      </div>
      <div class="filter-bar">
        <input class="filter-input" id="searchInput" type="text" placeholder="Search client, option..." oninput="filterRequests()" style="width:200px;">
      </div>
    </div>

    <div class="requests-panel">
      <div class="requests-panel-header">
        <div class="requests-panel-header-left">
          <div class="alert-dot" id="alertDot" style="display:none;"></div>
          <span style="font-size:12px;font-weight:600;color:var(--text--dark--40);">New training requests awaiting trainer assignment</span>
        </div>
        <span style="font-size:11px;color:var(--text--dark--30);">Round-robin suggestion shown in blue</span>
      </div>
      <div class="table-wrap">
        <table id="newRequestsTable">
          <thead>
            <tr>
              <th>Submitted</th>
              <th>Company</th>
              <th>Contact</th>
              <th>Training Option</th>
              <th>Booked Date</th>
              <th>Attendees</th>
              <th>Value</th>
              <th>Suggested Trainer</th>
              <th>Assign To</th>
              <th>Status</th>
              <th>Save</th>
            </tr>
          </thead>
          <tbody id="newRequestsBody">
            <tr><td colspan="11"><div class="empty-state"><div class="spinner"></div><div class="empty-state-text" style="margin-top:8px;color:var(--text--dark--30);">Connecting to sheet‚Ä¶</div></div></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- NEEDS ACTION PANEL -->
  <div id="sectionNeedsAction" style="margin-bottom:24px;">
    <div class="section-header">
      <div class="section-title" style="color:#8a5a2a;">
        ‚ö†Ô∏è Needs Action ‚Äî Assigned &amp; Pending
        <span class="badge" id="actionBadge" style="background:var(--brand-accent--mandarin-light);color:#a04010;">0</span>
      </div>
      <span style="font-size:11px;color:var(--text--dark--30);">These need to be confirmed as Booked or marked Cancelled</span>
    </div>
    <div class="requests-panel" style="border-color:var(--brand-accent--mandarin-light);">
      <div class="requests-panel-header" style="background:var(--brand-accent--cream);">
        <div class="requests-panel-header-left">
          <div class="alert-dot" id="actionDot" style="display:none;background:#f59e0b;"></div>
          <span style="font-size:12px;font-weight:600;color:var(--text--dark--40);">Assigned or pending bookings awaiting confirmation</span>
        </div>
        <span style="font-size:11px;color:var(--text--dark--30);">Update status directly from this panel</span>
      </div>
      <div class="table-wrap">
        <table id="actionRequestsTable">
          <thead>
            <tr>
              <th>Submitted</th>
              <th>Company</th>
              <th>Contact</th>
              <th>Training Option</th>
              <th>Booked Date</th>
              <th>Value</th>
              <th>Trainer</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="actionRequestsBody">
            <tr><td colspan="8"><div class="empty-state"><div class="spinner"></div><div class="empty-state-text" style="margin-top:8px;color:var(--text--dark--30);">Connecting to sheet‚Ä¶</div></div></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- CALENDAR SECTION -->
  <div class="cal-section" id="calSection">
    <div class="section-header">
      <div class="section-title">üìÖ Training Calendar</div>
      <div style="display:flex;align-items:center;gap:10px;">
        <span style="font-size:11px;color:var(--text--dark--30);" id="calGcalStatus">
          <span id="calGcalDot" style="display:inline-block;width:7px;height:7px;border-radius:50%;background:#ccc;margin-right:4px;vertical-align:middle;"></span>Calendar not connected
        </span>
        <button class="refresh-btn" onclick="loadCalendarData(true)" style="font-size:11px;">‚Üª Sync</button>
        <button class="refresh-btn" onclick="openCalSettings()" style="font-size:11px;background:rgba(33,71,244,.1);border-color:rgba(33,71,244,.3);color:var(--action-primary-blue);">‚öô Calendar Settings</button>
      </div>
    </div>
    <div class="cal-grid">
      <div class="cal-month-card">
        <div class="cal-month-header">
          <button class="cal-nav-btn" onclick="calChangeMonth(-1)">‚Äπ</button>
          <div class="cal-month-title" id="calMonthTitle">‚Äî</div>
          <button class="cal-nav-btn" onclick="calChangeMonth(1)">‚Ä∫</button>
        </div>
        <div style="display:flex;align-items:center;gap:12px;padding:8px 14px;background:var(--card-light-grey);border-bottom:1px solid var(--ui--underline--light-grey);flex-wrap:wrap;">
          <div style="display:flex;align-items:center;gap:5px;"><div style="width:10px;height:10px;border-radius:50%;background:#b8caff;"></div><span style="font-size:11px;color:var(--text--dark--40);">Bookings</span></div>
          <div style="display:flex;align-items:center;gap:5px;"><div style="width:10px;height:10px;border-radius:50%;background:#beffd8;"></div><span style="font-size:11px;color:var(--text--dark--40);">Google Calendar</span></div>
          <div style="display:flex;align-items:center;gap:5px;"><div style="width:10px;height:10px;border-radius:50%;background:#fde8eb;"></div><span style="font-size:11px;color:var(--text--dark--40);">Blocked</span></div>
          <div style="margin-left:auto;">
            <select id="calFilterTrainer" onchange="renderCalendar()" style="font-size:11px;border:1px solid var(--ui--underline--light-grey);border-radius:4px;padding:3px 7px;font-family:Arial,sans-serif;background:#fff;">
              <option value="">All Trainers</option>
            </select>
          </div>
        </div>
        <div class="cal-dow-row">
          <div class="cal-dow">Mon</div><div class="cal-dow">Tue</div><div class="cal-dow">Wed</div>
          <div class="cal-dow">Thu</div><div class="cal-dow">Fri</div><div class="cal-dow">Sat</div><div class="cal-dow">Sun</div>
        </div>
        <div class="cal-days" id="calDays"></div>
      </div>
      <div class="cal-upcoming-card">
        <div class="cal-upcoming-header"><span>Upcoming Sessions</span><span id="calUpcomingCount" style="font-size:10px;color:var(--text--dark--30);float:right;">‚Äî</span></div>
        <div style="flex:1;overflow-y:auto;" id="calUpcomingBody"><div style="padding:24px;text-align:center;color:var(--text--dark--30);font-size:12px;">Loading...</div></div>
      </div>
    </div>
  </div>

  <!-- KPI CARDS -->
  <div id="sectionPerformance" style="margin-bottom:16px;">
    <div class="section-title" style="margin-bottom:14px;">üìà Performance Overview</div>
  </div>
  <div class="kpi-grid">
    <div class="kpi-card kpi-accent-left clickable" onclick="openKpiModal('revYear')">
      <div class="kpi-card-label">Total Revenue This Year <span style="font-weight:400;color:var(--accent--blue--300);">(Booked)</span></div>
      <div class="kpi-card-value" id="kpiRevYear">¬£‚Äî</div>
      <div class="kpi-card-sub">Exc. VAT ¬∑ click for detail</div>
    </div>
    <div class="kpi-card kpi-accent-left kpi-accent-yellow clickable" onclick="openKpiModal('revMonth')">
      <div class="kpi-card-label">Revenue This Month <span style="font-weight:400;color:var(--accent--blue--300);">(Booked)</span></div>
      <div class="kpi-card-value" id="kpiRevMonth">¬£‚Äî</div>
      <div id="kpiRevMonthDelta"></div>
    </div>
    <div class="kpi-card kpi-accent-left kpi-accent-green clickable" onclick="openKpiModal('avgFee')">
      <div class="kpi-card-label">Avg Training Fee (Year) <span style="font-weight:400;color:var(--accent--blue--300);">(Booked)</span></div>
      <div class="kpi-card-value" id="kpiAvgFee">¬£‚Äî</div>
      <div class="kpi-card-sub">Per booking ¬∑ click for detail</div>
    </div>
    <div class="kpi-card kpi-accent-left kpi-accent-orange clickable" onclick="openKpiModal('days')">
      <div class="kpi-card-label">Training Days This Year</div>
      <div class="kpi-card-value" id="kpiDaysYear">‚Äî</div>
      <div class="kpi-card-sub" id="kpiDaysMonth">‚Äî this month</div>
    </div>
    <div class="kpi-card kpi-accent-left clickable" style="border-left-color:#9c27b0;" onclick="openKpiModal('bookings')">
      <div class="kpi-card-label">Total Bookings (Year)</div>
      <div class="kpi-card-value" id="kpiBookingsYear">‚Äî</div>
      <div class="kpi-card-sub" id="kpiBookingsMonth">‚Äî this month</div>
    </div>
  </div>

  <!-- CHARTS -->
  <div class="charts-grid">
    <div class="chart-card">
      <div class="chart-title">Monthly Revenue</div>
      <div class="chart-subtitle">This year vs last year (exc. VAT)</div>
      <div class="chart-container" style="height:240px;">
        <canvas id="revenueChart"></canvas>
      </div>
    </div>
    <div class="chart-card">
      <div class="chart-title">Month Comparison</div>
      <div class="chart-subtitle">This month vs last month</div>
      <div class="compare-cards">
        <div class="compare-card">
          <div class="compare-card-label" id="thisMonthLabel">This Month</div>
          <div class="compare-card-value" id="thisMonthRev">¬£‚Äî</div>
        </div>
        <div class="compare-card">
          <div class="compare-card-label" id="lastMonthLabel">Last Month</div>
          <div class="compare-card-value" id="lastMonthRev">¬£‚Äî</div>
        </div>
      </div>
      <div class="chart-container" style="height:150px;">
        <canvas id="optionChart"></canvas>
      </div>
      <div class="chart-subtitle" style="margin-top:10px;margin-bottom:0;">Bookings by training option (this year)</div>
    </div>
  </div>

  <!-- ALL BOOKINGS -->
  <div id="sectionAllBookings">
    <div class="section-header">
      <div class="section-title">
        üìã All Bookings
        <span class="badge green" id="allBadge">0</span>
      </div>
      <div class="filter-bar">
        <select class="filter-select" id="filterStatus" onchange="renderAllBookings()">
          <option value="">All Statuses</option>
          <option value="Unassigned">Unassigned</option>
          <option value="Assigned">Assigned</option>
          <option value="Booked">Booked</option>
          <option value="Pending">Pending</option>
          <option value="Cancelled">Cancelled</option>
        </select>
        <select class="filter-select" id="filterTrainer" onchange="renderAllBookings()">
          <option value="">All Trainers</option>
        </select>
        <select class="filter-select" id="filterOption" onchange="renderAllBookings()">
          <option value="">All Options</option>
          <option value="1">Option 1</option>
          <option value="2">Option 2</option>
          <option value="3">Option 3</option>
          <option value="4">Option 4</option>
          <option value="5">Option 5</option>
        </select>
      </div>
    </div>
    <div class="all-bookings">
      <div class="table-wrap">
        <table id="allBookingsTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Company</th>
              <th>Contact</th>
              <th>Option</th>
              <th>Attendees</th>
              <th>Trainer</th>
              <th>Value</th>
              <th>Status</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody id="allBookingsBody">
            <tr><td colspan="9"><div class="empty-state"><div class="spinner"></div><div class="empty-state-text" style="margin-top:8px;color:var(--text--dark--30);">Connecting to sheet‚Ä¶</div></div></td></tr>
          </tbody>
        </table>
      </div>
      <div class="pagination" id="paginationBar">
        <button class="page-btn" id="prevBtn" onclick="changePage(-1)">‚Üê Prev</button>
        <span id="pageInfo">Page 1</span>
        <button class="page-btn" id="nextBtn" onclick="changePage(1)">Next ‚Üí</button>
        <span style="margin-left:auto;" id="rowCount"></span>
      </div>
      <div class="data-note">Data pulled from Google Sheets via Apps Script. Click Refresh to get latest data.</div>
    </div>
  </div>

</main>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toastContainer"></div>

<!-- ACTIVITY PANEL OVERLAY + PANEL -->
<div class="activity-panel-overlay" id="activityPanelOverlay" onclick="closeActivityPanel()"></div>
<div class="activity-panel" id="activityPanel">
  <div class="activity-panel-header">
    <div><div style="font-size:14px;font-weight:700;">üïê Activity Feed</div><div style="font-size:11px;color:rgba(255,255,255,.55);margin-top:2px;">All changes made on this dashboard</div></div>
    <button onclick="closeActivityPanel()" style="background:rgba(255,255,255,.1);border:none;color:rgba(255,255,255,.7);cursor:pointer;font-size:16px;padding:5px 9px;border-radius:4px;">‚úï</button>
  </div>
  <div style="padding:10px 14px;background:#f6f8ff;border-bottom:1px solid var(--ui--underline--light-grey);display:flex;align-items:center;gap:10px;flex-shrink:0;">
    <div id="activityAvatar" style="width:30px;height:30px;border-radius:50%;background:var(--action-primary-blue);color:#fff;font-size:12px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;">?</div>
    <span id="activityUserDisplay" style="font-size:12px;font-weight:600;color:var(--text--dark--50);flex:1;">Not set</span>
    <button onclick="changeSelfPin()" style="font-size:11px;background:none;border:none;color:var(--action-primary-blue);cursor:pointer;font-family:Arial,sans-serif;padding:0;text-decoration:underline;">Change PIN</button>
  </div>
  <div style="padding:8px 14px;border-bottom:1px solid var(--ui--underline--light-grey);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;">
    <span id="activityCount" style="font-size:11px;font-weight:600;color:var(--text--dark--30);">0 events</span>
    <button onclick="clearActivityLog()" style="font-size:11px;color:#c0303d;background:none;border:none;cursor:pointer;padding:3px 7px;border-radius:4px;font-family:Arial,sans-serif;">üóë Clear log</button>
  </div>
  <div style="flex:1;overflow-y:auto;" id="activityFeedBody">
    <div style="padding:48px 24px;text-align:center;color:var(--text--dark--30);font-size:13px;"><div style="font-size:32px;margin-bottom:10px;">üìã</div>No activity yet</div>
  </div>
</div>

<!-- USERNAME MODAL -->
<div class="username-modal-overlay" id="usernameModalOverlay">
  <div class="username-modal">
    <div style="font-size:36px;margin-bottom:10px;">üë§</div>
    <div style="font-size:17px;font-weight:700;color:var(--text--dark--50);margin-bottom:6px;">Who are you?</div>
    <div style="font-size:12px;color:var(--text--dark--30);margin-bottom:20px;line-height:1.5;">Your name will be shown in the activity feed.</div>
    <input type="text" id="usernameInput" placeholder="Enter your name‚Ä¶" maxlength="40" onkeydown="if(event.key==='Enter')saveUsername()" style="width:100%;box-sizing:border-box;border:1.5px solid var(--ui--underline--light-grey);border-radius:6px;padding:10px 14px;font-size:14px;font-family:Arial,sans-serif;color:var(--text--dark--50);margin-bottom:14px;">
    <button class="btn btn-primary" style="width:100%;" onclick="saveUsername()">Set Name &amp; Continue</button>
  </div>
</div>

<!-- TRAINER MANAGEMENT MODAL -->
<div class="modal-overlay" id="trainerModalOverlay" onclick="if(event.target===this)closeTrainerModal()">
  <div class="modal" style="max-width:560px;width:96vw;">
    <div class="modal-header"><span class="modal-title">üë§ Manage Trainers &amp; Permissions</span><button class="modal-close" onclick="closeTrainerModal()">‚úï</button></div>
    <div class="modal-body" style="padding:0;">
      <div style="padding:16px 20px 0;"><div class="trainer-list" id="trainerModalList"></div></div>
      <div style="padding:16px 20px;border-top:1px solid var(--ui--underline--light-grey);background:var(--card-light-grey);">
        <div style="font-size:11px;font-weight:700;letter-spacing:.6px;text-transform:uppercase;color:var(--text--dark--30);margin-bottom:10px;">Add New Trainer</div>
        <div style="display:flex;gap:8px;margin-bottom:12px;">
          <input class="trainer-add-input" id="newTrainerInput" type="text" placeholder="Trainer name‚Ä¶" style="flex:1;border:1px solid var(--light-grey);border-radius:4px;padding:7px 10px;font-size:13px;font-family:Arial,sans-serif;" onkeydown="if(event.key==='Enter')addTrainer()">
        </div>
        <div style="font-size:11px;font-weight:600;color:var(--text--dark--40);margin-bottom:6px;">Permission Preset</div>
        <div style="display:flex;gap:6px;margin-bottom:12px;" id="presetBtns">
          <button class="perm-preset-btn" onclick="applyPreset('admin')">üëë Admin</button>
          <button class="perm-preset-btn" onclick="applyPreset('editor')">‚úèÔ∏è Editor</button>
          <button class="perm-preset-btn" onclick="applyPreset('viewer')">üëÅ View Only</button>
        </div>
        <div id="newTrainerPermissions" style="background:#fff;border:1px solid var(--ui--underline--light-grey);border-radius:6px;padding:10px 14px;margin-bottom:12px;max-height:200px;overflow-y:auto;"></div>
        <button class="btn btn-primary" onclick="addTrainer()" style="width:100%;">+ Add Trainer</button>
      </div>
    </div>
  </div>
</div>

<!-- REASSIGN MODAL -->
<div class="modal-overlay" id="reassignModalOverlay">
  <div class="modal" style="max-width:480px;">
    <div class="modal-header" style="background:#fef3f2;border-bottom:1px solid #fecaca;">
      <span class="modal-title" style="color:#c0303d;">‚ö†Ô∏è Trainer Has Active Enquiries</span>
    </div>
    <div class="modal-body">
      <div id="reassignWarningText" style="font-size:13px;color:var(--text--dark--50);margin-bottom:16px;line-height:1.5;"></div>
      <div style="background:var(--card-light-grey);border-radius:6px;padding:12px;margin-bottom:16px;">
        <div id="reassignEnquiryList" style="font-size:12px;max-height:180px;overflow-y:auto;"></div>
      </div>
      <label style="font-size:12px;font-weight:600;color:var(--text--dark--40);display:block;margin-bottom:6px;">Reassign all to:</label>
      <select id="reassignTargetSelect" style="width:100%;border:1px solid var(--ui--underline--light-grey);border-radius:6px;padding:8px 10px;font-size:13px;font-family:Arial,sans-serif;background:#fff;">
        <option value="">‚Äî Select a trainer ‚Äî</option>
      </select>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;padding:14px 20px;border-top:1px solid var(--ui--underline--light-grey);background:var(--card-light-grey);">
      <button class="btn btn-ghost" onclick="closeReassignModal()">Cancel</button>
      <button class="btn" onclick="confirmReassignAndDelete()" style="background:#c0303d;color:#fff;border:none;">Reassign &amp; Remove</button>
    </div>
  </div>
</div>

<!-- KPI DETAIL MODAL -->
<div class="kpi-modal-overlay" id="kpiModalOverlay" onclick="if(event.target===this)closeKpiModal()">
  <div class="kpi-modal">
    <div style="padding:18px 24px 14px;border-bottom:1px solid var(--ui--underline--light-grey);display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-shrink:0;">
      <div style="flex:1;">
        <div style="font-size:16px;font-weight:700;color:var(--text--dark--50);margin-bottom:2px;" id="kpiModalTitle">‚Äî</div>
        <div style="font-size:12px;color:var(--text--dark--30);" id="kpiModalSubtitle">‚Äî</div>
        <div style="font-size:28px;font-weight:700;color:var(--text--dark--50);letter-spacing:-.5px;margin-top:8px;" id="kpiModalHeadline">‚Äî</div>
      </div>
      <button onclick="closeKpiModal()" style="background:var(--card-light-grey);border:1px solid var(--ui--underline--light-grey);color:var(--text--dark--30);cursor:pointer;font-size:18px;padding:6px 10px;border-radius:4px;">‚úï</button>
    </div>
    <div style="display:flex;gap:24px;padding:14px 24px;background:var(--card-light-grey);border-bottom:1px solid var(--ui--underline--light-grey);flex-wrap:wrap;flex-shrink:0;" id="kpiModalStats"></div>
    <div style="overflow-y:auto;flex:1;"><table style="width:100%;border-collapse:collapse;font-size:12px;"><thead id="kpiModalTableHead"></thead><tbody id="kpiModalTableBody"></tbody></table></div>
    <div style="padding:12px 24px;border-top:1px solid var(--ui--underline--light-grey);background:var(--card-light-grey);display:flex;justify-content:flex-end;flex-shrink:0;"><button class="btn btn-ghost" onclick="closeKpiModal()">‚úï Close</button></div>
  </div>
</div>

<!-- EDIT PERMISSIONS MODAL -->
<div class="username-modal-overlay" id="editPermOverlay" style="z-index:800;">
  <div class="username-modal" style="width:520px;max-width:96vw;padding:0;text-align:left;border-radius:10px;overflow:hidden;">
    <div style="padding:18px 22px 14px;background:var(--text--dark--50);color:#fff;display:flex;align-items:center;justify-content:space-between;">
      <div><div style="font-size:14px;font-weight:700;">Edit Permissions</div><div style="font-size:11px;color:rgba(255,255,255,.6);margin-top:2px;" id="editPermName">‚Äî</div></div>
      <button onclick="closeEditPermModal()" style="background:rgba(255,255,255,.1);border:none;color:#fff;cursor:pointer;padding:5px 9px;border-radius:4px;font-size:16px;">‚úï</button>
    </div>
    <div style="padding:10px 20px;background:#f6f8ff;border-bottom:1px solid #e0e8ff;display:flex;align-items:center;gap:10px;">
      <span style="font-size:12px;color:var(--text--dark--40);flex:1;">Preview the dashboard exactly as this user sees it.</span>
      <button id="shadowPreviewBtn" onclick="enterShadowMode()" style="background:#7c3aed;color:#fff;border:none;font-size:12px;padding:6px 14px;border-radius:4px;cursor:pointer;font-family:Arial,sans-serif;font-weight:600;">
        üëÅ Preview as <span id="shadowBtnName">‚Äî</span>
      </button>
    </div>
    <div id="editPermBody" style="padding:16px 20px;max-height:340px;overflow-y:auto;"></div>
    <div style="padding:12px 20px;border-top:1px solid var(--ui--underline--light-grey);background:var(--card-light-grey);display:flex;justify-content:flex-end;gap:8px;">
      <button class="btn btn-ghost" onclick="closeEditPermModal()">Cancel</button>
      <button class="btn btn-primary" id="editPermSaveBtn">Save Permissions</button>
    </div>
  </div>
</div>

<!-- CALENDAR SETTINGS MODAL -->
<div class="username-modal-overlay" id="calSettingsOverlay" onclick="if(event.target===this)closeCalSettings()">
  <div class="username-modal" style="width:480px;max-width:96vw;padding:0;text-align:left;border-radius:10px;overflow:hidden;">
    <div style="padding:18px 22px 14px;background:var(--text--dark--50);color:#fff;display:flex;align-items:center;justify-content:space-between;">
      <div><div style="font-size:14px;font-weight:700;">üìÖ Google Calendar Settings</div><div style="font-size:11px;color:rgba(255,255,255,.6);margin-top:2px;">Connect your shared team calendar</div></div>
      <button onclick="closeCalSettings()" style="background:rgba(255,255,255,.1);border:none;color:#fff;cursor:pointer;padding:5px 9px;border-radius:4px;font-size:16px;">‚úï</button>
    </div>
    <div style="padding:20px;">
      <div style="font-size:12px;color:var(--text--dark--40);margin-bottom:16px;line-height:1.6;background:#f6f8ff;padding:10px 12px;border-radius:6px;border:1px solid #e0e8ff;">
        <strong>Find your Calendar ID:</strong> Google Calendar ‚Üí Settings ‚Üí Click your calendar ‚Üí Integrate calendar ‚Üí Copy Calendar ID
      </div>
      <label style="font-size:12px;font-weight:600;color:var(--text--dark--40);display:block;margin-bottom:6px;">Shared Team Calendar ID</label>
      <input type="text" id="calIdInput" placeholder="e.g. abc123@group.calendar.google.com" style="width:100%;box-sizing:border-box;border:1.5px solid var(--ui--underline--light-grey);border-radius:6px;padding:9px 12px;font-size:13px;font-family:Arial,sans-serif;margin-bottom:16px;">
    </div>
    <div style="padding:12px 20px;border-top:1px solid var(--ui--underline--light-grey);background:var(--card-light-grey);display:flex;justify-content:space-between;gap:8px;align-items:center;">
      <span id="calSettingsStatus" style="font-size:11px;color:var(--text--dark--30);"></span>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-ghost" onclick="closeCalSettings()">Cancel</button>
        <button class="btn btn-primary" onclick="saveCalSettings()">Save &amp; Sync</button>
      </div>
    </div>
  </div>
</div>

<!-- BOOKED DATE MODAL -->
<div class="booked-date-modal-overlay" id="bookedDateModal">
  <div class="booked-date-modal">
    <div style="padding:18px 22px 14px;background:var(--action-primary-blue);color:#fff;">
      <div style="font-size:15px;font-weight:700;margin-bottom:3px;">üìÖ Confirm Training Booking</div>
      <div style="font-size:12px;opacity:.8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" id="bdModalCompany">‚Äî</div>
    </div>
    <div style="padding:22px;">
      <label style="display:block;font-size:12px;font-weight:600;color:var(--text--dark--40);margin-bottom:8px;">How many training days?</label>
      <div style="display:flex;gap:8px;margin-bottom:16px;" id="bdModalDaysBtns">
        <button type="button" class="bd-days-btn active" onclick="bdSelectDays(1)">1 Day</button>
        <button type="button" class="bd-days-btn" onclick="bdSelectDays(2)">2 Days</button>
        <button type="button" class="bd-days-btn" onclick="bdSelectDays(3)">3 Days</button>
        <button type="button" class="bd-days-btn" onclick="bdSelectDays(4)">4 Days</button>
        <button type="button" class="bd-days-btn" onclick="bdSelectDays(5)">5 Days</button>
      </div>
      <label style="display:block;font-size:12px;font-weight:600;color:var(--text--dark--40);margin-bottom:8px;">First day of training</label>
      <input type="date" id="bdModalDateInput" style="width:100%;box-sizing:border-box;border:2px solid var(--action-primary-blue);border-radius:7px;padding:10px 12px;font-size:14px;font-family:Arial,sans-serif;color:var(--text--dark--50);margin-bottom:10px;outline:none;" onchange="bdUpdateSummary()">
      <div id="bdModalSummary" style="display:none;background:#f6f8ff;border:1px solid #dde6ff;border-radius:7px;padding:10px 12px;margin-bottom:4px;font-size:11px;line-height:1.7;color:var(--text--dark--40);"></div>
      <div style="font-size:11px;color:var(--text--dark--30);margin-top:6px;margin-bottom:16px;">Weekends and UK bank holidays excluded. Day before blocked for travel, day after for admin.</div>
      <div style="border-top:1px solid var(--ui--underline--light-grey);padding-top:14px;">
        <label style="display:block;font-size:12px;font-weight:600;color:var(--text--dark--40);margin-bottom:8px;">Confirm Invoice Value</label>
        <div style="display:flex;align-items:center;gap:0;">
          <span style="background:var(--card-light-grey);border:2px solid var(--action-primary-blue);border-right:none;border-radius:7px 0 0 7px;padding:9px 12px;font-size:14px;font-weight:700;color:var(--text--dark--40);">¬£</span>
          <input type="number" id="bdModalValueInput" min="0" step="50" placeholder="0" style="flex:1;border:2px solid var(--action-primary-blue);border-left:none;border-radius:0 7px 7px 0;padding:10px 12px;font-size:14px;font-family:Arial,sans-serif;color:var(--text--dark--50);outline:none;">
        </div>
      </div>
    </div>
    <div style="padding:14px 22px;border-top:1px solid var(--ui--underline--light-grey);background:var(--card-light-grey);display:flex;justify-content:flex-end;gap:8px;align-items:center;">
      <span id="bdModalError" style="flex:1;font-size:11px;color:#c0303d;display:none;"></span>
      <button class="btn btn-ghost" onclick="cancelBookedDateModal()">Cancel</button>
      <button class="btn btn-primary" onclick="confirmBookedDateModal()">‚úì Confirm Booked</button>
    </div>
  </div>
</div>

<script>
// =============================================
// CONFIG
// =============================================
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzCvBhFSPyyoaVsui0DCxvGQQa0V7e_UCJ5LfqvcSysTHTFlNRcx4ewlET5TyouJ0ZYow/exec';
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSvPvb_WzFGr6SKflZEob3RFpuh44lKckD4DcsoAXxKUwtYBGCtGGEqA9YkSnvBKh3pQc9nwdbfh9B2/pub?gid=1792679763&single=true&output=csv';

// Training option prices (exc. VAT)
const OPTION_PRICES = { '1': 0, '2': 1100, '3': 1850, '4': 1000, '5': 220 };
const OPTION_LABELS = {
  '1': 'On Demand + Help Centre',
  '2': 'Personalised 1 Day',
  '3': 'Personalised 2 Day',
  '4': 'Accounting + Go Live',
  '5': 'Live HQ Session'
};
const OPTION_DAYS = { '1': 0, '2': 1, '3': 2, '4': 1, '5': 1 };

// Trainers ‚Äî update these to match your actual team
const TRAINERS = ['Amy', 'Max'];

// =============================================
// STATE
// =============================================
let allData = [];
let currentPage = 1;
const PAGE_SIZE = 15;
let revenueChart = null;
let optionChart = null;

// =============================================
// LOCAL OVERRIDE CACHE
// Persists user edits across refreshes so sheet
// latency doesn't reset fields the user changed.
// =============================================
const OVERRIDE_KEY = 'streetDashboardOverrides';

function getOverrides() {
  try { return JSON.parse(sessionStorage.getItem(OVERRIDE_KEY) || '{}'); } catch(e) { return {}; }
}

function saveOverride(rowIndex, fields) {
  const overrides = getOverrides();
  overrides[rowIndex] = Object.assign(overrides[rowIndex] || {}, fields);
  try { sessionStorage.setItem(OVERRIDE_KEY, JSON.stringify(overrides)); } catch(e) {}
}

function applyOverrides(rows) {
  const overrides = getOverrides();
  return rows.map(r => {
    const ov = overrides[r.rowIndex];
    if (!ov) return r;
    return Object.assign({}, r, ov);
  });
}

// =============================================
// NAV
// =============================================
function toggleNav() {
  const drawer = document.getElementById('navDrawer');
  const overlay = document.getElementById('navOverlay');
  const btn = document.getElementById('hamburgerBtn');
  const isOpen = drawer.classList.contains('open');
  if (isOpen) { closeNav(); } else {
    drawer.classList.add('open');
    overlay.classList.add('open');
    btn.classList.add('open');
  }
}
function closeNav() {
  document.getElementById('navDrawer').classList.remove('open');
  document.getElementById('navOverlay').classList.remove('open');
  document.getElementById('hamburgerBtn').classList.remove('open');
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeNav(); });

// =============================================
// TOAST
// =============================================
function showToast(msg, type = '') {
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.textContent = msg;
  document.getElementById('toastContainer').appendChild(t);
  setTimeout(() => t.remove(), 3500);
}

// =============================================
// LOADING
// =============================================
function setLoading(on) {
  document.getElementById('loadingBar').classList.toggle('active', on);
}

// =============================================
// DATA FETCHING
// =============================================


// Quick connection test
async function testConnection() {
  const btn = event.target;
  btn.textContent = '‚è≥‚Ä¶';
  btn.disabled = true;
  try {
    const url = APPS_SCRIPT_URL + '?action=getData';
    const res = await fetch(url);
    const text = await res.text();
    const isJSON = text.trim().startsWith('{');
    let info = 'Status: ' + res.status + '\nIs JSON: ' + isJSON;
    if (isJSON) {
      const json = JSON.parse(text);
      info += '\nRows: ' + (json.data ? json.data.length : 'none');
      info += '\nSuccess: ' + json.success;
      if (json.error) info += '\nError: ' + json.error;
    } else {
      info += '\nResponse (first 200 chars):\n' + text.slice(0, 200);
    }
    alert(info);
  } catch(e) {
    alert('FAILED: ' + e.message + '\n\nMake sure Apps Script is deployed as:\n‚Ä¢ Execute as: Me\n‚Ä¢ Who has access: Anyone');
  }
  btn.textContent = 'üîç Test';
  btn.disabled = false;
}

async function loadData() {
  setLoading(true);
  document.getElementById('lastUpdated').textContent = 'Loading‚Ä¶';

  // ‚îÄ‚îÄ Hard 10-second timeout on every fetch ‚Äî ALWAYS resolves ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function _fetch(url, ms) {
    const ctrl  = new AbortController();
    const timer = setTimeout(() => ctrl.abort(), ms);
    try {
      const res = await fetch(url, { signal: ctrl.signal });
      clearTimeout(timer);
      return res;
    } catch(e) {
      clearTimeout(timer);
      throw e;
    }
  }

  // ‚îÄ‚îÄ Safely run processData and always clear loading ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function finish(data, label) {
    allData = applyOverrides(data);
    try { processData(); } catch(e) { console.error('[Dashboard] processData error:', e); }
    document.getElementById('lastUpdated').textContent = label;
    setLoading(false);
    try { applyPermissions(); } catch(e) {}
  }

  // ‚îÄ‚îÄ 1. Apps Script (10s timeout) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  try {
    document.getElementById('lastUpdated').textContent = 'Connecting to sheet‚Ä¶';
    const res  = await _fetch(APPS_SCRIPT_URL + '?action=getData', 10000);
    const text = await res.text();
    console.log('[Dashboard] Apps Script response start:', text.slice(0, 100));

    if (text && text.trim().startsWith('{')) {
      const json = JSON.parse(text);
      if (json && json.data && json.data.length >= 1) {
        const parsed = parseAppsScriptData(json.data);
        console.log('[Dashboard] Parsed', parsed.length, 'rows from Apps Script');
        finish(parsed, '‚úì Live ‚Äî ' + parsed.length + ' rows ‚Äî ' + new Date().toLocaleTimeString('en-GB'));
        return;
      }
      if (json && json.error) {
        console.warn('[Dashboard] Apps Script error:', json.error);
        document.getElementById('lastUpdated').textContent = '‚ö† Sheet error: ' + json.error;
      }
    } else if (text.includes('<!DOCTYPE') || text.includes('<html')) {
      console.warn('[Dashboard] Got HTML ‚Äî Apps Script needs redeploying (Deploy ‚Üí New Deployment ‚Üí Anyone)');
      document.getElementById('lastUpdated').textContent = '‚ö† Auth error ‚Äî redeploy Apps Script';
    }
  } catch(e) {
    const reason = e.name === 'AbortError' ? 'Timed out (10s)' : e.message;
    console.warn('[Dashboard] Apps Script fetch failed:', reason);
    document.getElementById('lastUpdated').textContent = '‚ö† Apps Script unreachable ‚Äî trying CSV‚Ä¶';
  }

  // ‚îÄ‚îÄ 2. CSV fallback (10s timeout) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  try {
    document.getElementById('lastUpdated').textContent = 'Trying CSV fallback‚Ä¶';
    const res2  = await _fetch(CSV_URL, 10000);
    const text2 = await res2.text();

    if (text2 && text2.length > 200 && text2.includes(',')) {
      const parsed2 = parseCSV(text2);
      console.log('[Dashboard] Parsed', parsed2.length, 'rows from CSV');
      if (parsed2.length > 0) {
        finish(parsed2, '‚ö† CSV mode ‚Äî ' + parsed2.length + ' rows ‚Äî ' + new Date().toLocaleTimeString('en-GB'));
        showToast('Loaded via CSV. Some features limited ‚Äî check Apps Script deployment.', '');
        return;
      }
    }
  } catch(e) {
    const reason = e.name === 'AbortError' ? 'Timed out' : e.message;
    console.warn('[Dashboard] CSV failed:', reason);
  }

  // ‚îÄ‚îÄ 3. Demo data ‚Äî always succeeds ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  console.warn('[Dashboard] Both sources failed ‚Äî using demo data');
  finish(generateDemoData(), '‚ö† Demo data ‚Äî sheet unreachable');
  showToast('Could not reach the sheet. Showing demo data. Click üîç Test to diagnose.', 'error');
}


function fetchWithTimeout(url, ms) {
  const ctrl = new AbortController();
  setTimeout(() => ctrl.abort(), ms);
  return fetch(url, { signal: ctrl.signal, redirect: 'follow' });
}

// Parse Apps Script JSON response
// Expected: { data: [ [col1, col2, ...], ... ] } where row 0 is headers
function parseAppsScriptData(rows) {
  if (!rows || rows.length < 2) return [];
  const headers = rows[0].map(h => String(h).trim().toLowerCase());
  return rows.slice(1).map((row, i) => {
    const obj = {};
    headers.forEach((h, j) => { obj[h] = row[j] || ''; });
    return normaliseRow(obj, i + 2); // +2 for header row + 1-indexed
  }).filter(r => r.company || r.contact);
}

// Parse CSV text
function parseCSV(text) {
  const lines = text.split('\n').filter(l => l.trim());
  if (lines.length < 2) return [];
  const headers = parseCSVRow(lines[0]).map(h => h.trim().toLowerCase());
  return lines.slice(1).map((line, i) => {
    const vals = parseCSVRow(line);
    const obj = {};
    headers.forEach((h, j) => { obj[h] = (vals[j] || '').trim(); });
    return normaliseRow(obj, i + 2);
  }).filter(r => r.company || r.contact);
}

function parseCSVRow(line) {
  const result = [];
  let cur = '';
  let inQ = false;
  for (let i = 0; i < line.length; i++) {
    const c = line[i];
    if (c === '"') { inQ = !inQ; }
    else if (c === ',' && !inQ) { result.push(cur); cur = ''; }
    else { cur += c; }
  }
  result.push(cur);
  return result;
}

// Normalise a row object into our standard shape
// Column names guessed from common Google Form exports ‚Äî adjust if needed
function normaliseRow(obj, rowIndex) {
  // Exact match first, then partial ‚Äî prevents greedy matches like 'date' hitting 'booked date'
  const get = (...keys) => {
    for (const k of keys) {
      for (const ok of Object.keys(obj)) {
        if (ok === k) return obj[ok]; // exact
      }
    }
    for (const k of keys) {
      for (const ok of Object.keys(obj)) {
        if (ok.includes(k)) return obj[ok]; // partial fallback
      }
    }
    return '';
  };

  const timestamp = get('timestamp');
  // Keys ordered from most-specific to least-specific to avoid greedy partial matches
  const company     = get('company / business name:', 'company / business name', 'company name', 'company', 'organisation', 'business', 'agency');
  const contact     = get('client stakeholder name and phone number (authorising training)', 'client stakeholder name', 'stakeholder', 'authorising training', 'contact', 'name');
  const email       = get('email address', 'email');
  const optionRaw   = get('what type of training are you interested in?', 'what type of training', 'training option', 'type of training', 'option', 'training type', 'package');
  const preferredDate = get('preferred training date(s)', 'preferred training date', 'preferred date');
  const attendees   = get('attendees', 'delegates', 'number of');
  const trainer     = get('assigned trainer', 'trainer');
  const status      = get('status');
  const notes       = get('are there specific features or workflows', 'specific features', 'notes', 'additional', 'comments');
  const invoiceValue = get('invoice value', 'invoice');

  // Extract option ‚Äî keyword checks FIRST, digit match only as last resort
  let option = '2';
  const _optL = String(optionRaw).toLowerCase();
  if (_optL.includes('account') || _optL.includes('go-live') || _optL.includes('go live') || _optL.includes('lettings accounting')) {
    option = '4';
  } else if (_optL.includes('hq') || _optL.includes('manchester') || _optL.includes('live training at street') || (_optL.includes('live') && _optL.includes('street'))) {
    option = '5';
  } else if (_optL.includes('2 day') || _optL.includes('2 days') || _optL.includes('back to back') || _optL.includes('two day')) {
    option = '3';
  } else if (_optL.includes('on demand') || _optL.includes('help centre') || _optL.includes('online sales') || _optL.includes('video tutorial')) {
    option = '1';
  } else if (_optL.includes('1 day') || _optL.includes('1/2 day') || _optL.includes('personalised') || _optL.includes('in office')) {
    option = '2';
  } else {
    // Last resort: look for explicit "option N" pattern only
    const optNumMatch = String(optionRaw).match(/option\s*([1-5])/i);
    if (optNumMatch) option = optNumMatch[1];
  }

  const numAttendees = parseInt(attendees) || 1;
  const basePrice = parseInt(OPTION_PRICES[option]) || 0;

  // Use Invoice Value from sheet (col U) if present, else fall back to option price
  const parsedInvoice = invoiceValue ? parseFloat(String(invoiceValue).replace(/[¬£,\s]/g, '')) : NaN;
  const revenue = !isNaN(parsedInvoice) && parsedInvoice > 0
    ? parsedInvoice
    : (option === '5' ? basePrice * numAttendees : basePrice);

  const parsedDate = parseDate(timestamp || preferredDate);

  return {
    rowIndex,
    timestamp: timestamp || '',
    date: parsedDate,
    company: company || obj['company name'] || '',
    contact: contact || '',
    email: email || '',
    option,
    optionLabel: OPTION_LABELS[option] || `Option ${option}`,
    preferredDate: preferredDate || '',
    attendees: numAttendees,
    trainer: trainer || '',
    status: status || (trainer ? 'Assigned' : 'Unassigned'),
    notes: notes || '',
    bookedOn: formatDateInput(get('booked on date', 'booked on', 'date booked')) || '',
    revenue
  };
}

function parseDate(str) {
  if (!str) return null;
  const s = String(str).trim();
  // Handle DD/MM/YYYY or DD/MM/YYYY HH:MM:SS (UK / Google Sheets format)
  const dmyMatch = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
  if (dmyMatch) {
    const d = new Date(Number(dmyMatch[3]), Number(dmyMatch[2]) - 1, Number(dmyMatch[1]));
    return isNaN(d.getTime()) ? null : d;
  }
  const d = new Date(s);
  return isNaN(d.getTime()) ? null : d;
}

// =============================================
// DEMO DATA GENERATOR
// =============================================
function generateDemoData() {
  const now = new Date();
  const year = now.getFullYear();
  const lastYear = year - 1;
  const rows = [];
  let rowIdx = 2;

  const companies = ['Acorn Estates', 'Bridgewater Properties', 'Chapman & Co', 'Dalton Lettings',
    'Elara Homes', 'Foxcroft Realty', 'Grange Lettings', 'Harfield & Sons',
    'Ivory Keys Properties', 'Jameson Estate Agents', 'Keystone Lettings', 'Lakewood Homes'];
  const contacts = ['James Wilson', 'Sarah Brown', 'Michael Davies', 'Emma Jones',
    'Oliver Smith', 'Charlotte Taylor', 'Harry White', 'Amelia Harris',
    'George Clark', 'Lily Walker', 'Noah Robinson', 'Sophia Lewis'];

  // This year - spread across months up to now
  for (let m = 0; m <= now.getMonth(); m++) {
    const count = 3 + Math.floor(Math.random() * 5);
    for (let i = 0; i < count; i++) {
      const day = 1 + Math.floor(Math.random() * 28);
      const dateObj = new Date(year, m, day);
      if (dateObj > now) continue;
      const opt = ['2','2','3','3','4','5','1'][Math.floor(Math.random() * 7)];
      const compIdx = (m * 3 + i) % companies.length;
      const trainerIdx = Math.floor(Math.random() * TRAINERS.length);
      const isNew = (m === now.getMonth() && i >= 2);
      const numAtt = opt === '5' ? (2 + Math.floor(Math.random() * 4)) : 1;
      rows.push({
        rowIndex: rowIdx++,
        timestamp: dateObj.toISOString(),
        date: dateObj,
        company: companies[compIdx],
        contact: contacts[compIdx],
        email: contacts[compIdx].toLowerCase().replace(' ','.')+`@${companies[compIdx].toLowerCase().replace(/[^a-z]/g,'')}.com`,
        option: opt,
        optionLabel: OPTION_LABELS[opt],
        preferredDate: new Date(year, m, day + 14).toLocaleDateString('en-GB'),
        attendees: numAtt,
        trainer: isNew ? '' : TRAINERS[trainerIdx],
        status: isNew ? 'New' : (Math.random() > 0.3 ? 'Complete' : 'Assigned'),
        notes: '',
        revenue: opt === '5' ? OPTION_PRICES[opt] * numAtt : OPTION_PRICES[opt]
      });
    }
  }

  // Last year data (for chart comparison)
  for (let m = 0; m < 12; m++) {
    const count = 2 + Math.floor(Math.random() * 4);
    for (let i = 0; i < count; i++) {
      const day = 1 + Math.floor(Math.random() * 28);
      const dateObj = new Date(lastYear, m, day);
      const opt = ['2','2','3','4','5'][Math.floor(Math.random() * 5)];
      const compIdx = (m * 2 + i) % companies.length;
      const trainerIdx = Math.floor(Math.random() * TRAINERS.length);
      const numAtt = opt === '5' ? (2 + Math.floor(Math.random() * 3)) : 1;
      rows.push({
        rowIndex: rowIdx++,
        timestamp: dateObj.toISOString(),
        date: dateObj,
        company: companies[compIdx] + ' (LY)',
        contact: contacts[compIdx],
        email: '',
        option: opt,
        optionLabel: OPTION_LABELS[opt],
        preferredDate: '',
        attendees: numAtt,
        trainer: TRAINERS[trainerIdx],
        status: 'Complete',
        notes: '',
        revenue: opt === '5' ? OPTION_PRICES[opt] * numAtt : OPTION_PRICES[opt]
      });
    }
  }

  return rows;
}

// =============================================
// PROCESS & RENDER
// =============================================
function processData() {
  renderUnassigned();
  renderActionPanel();
  renderKPIs();
  renderCharts();
  renderTrainerWorkload();
  renderAllBookings();
  populateTrainerFilter();
  populateCalTrainerFilter();
  renderCalendar();
  renderUpcoming();
  updateTrainerAvailability();
}

// =============================================
// UNASSIGNED REQUESTS
// =============================================
function renderUnassigned() {
  const now = new Date();
  const year = now.getFullYear();
  const unassigned = allData.filter(r => {
    // Hide if already actioned
    if (['Booked','Cancelled','Complete'].includes(r.status)) return false;
    // Hide if trainer assigned (they go to Needs Action panel)
    if (r.trainer && r.trainer.trim()) return false;
    // Hide old records
    if (r.date && r.date < new Date('2026-01-01')) return false;
    return true;
  });

  const search = (document.getElementById('searchInput')?.value || '').toLowerCase();
  const filtered = search
    ? unassigned.filter(r => (r.company + r.contact + r.option + r.optionLabel).toLowerCase().includes(search))
    : unassigned;

  document.getElementById('unassignedBadge').textContent = filtered.length;
  document.getElementById('alertDot').style.display = filtered.length > 0 ? 'block' : 'none';

  const suggested = getSuggestedTrainer();
  const tbody = document.getElementById('newRequestsBody');

  if (filtered.length === 0) {
    tbody.innerHTML = `<tr><td colspan="10"><div class="empty-state">
      <div class="empty-state-icon">‚úÖ</div>
      <div class="empty-state-text">No unassigned requests ‚Äî all up to date!</div>
    </div></td></tr>`;
    return;
  }

  tbody.innerHTML = filtered.map(r => `
    <tr id="req-row-${r.rowIndex}">
      <td style="white-space:nowrap;">${formatDate(r.date || r.timestamp)}</td>
      <td><strong>${esc(r.company)}</strong></td>
      <td>${esc(r.contact)}<br><span style="color:var(--text--dark--30);font-size:11px;">${esc(r.email)}</span></td>
      <td><span class="option-badge opt-${r.option}">Opt ${r.option} ‚Äî ${esc(r.optionLabel)}</span></td>
      <td style="white-space:nowrap;">${esc(r.preferredDate) || '‚Äî'}</td>
      <td>${r.attendees}</td>
      <td>
        <div style="display:flex;align-items:center;gap:4px;">
          <span style="color:var(--text--dark--30);font-size:12px;">¬£</span>
          <input type="number" id="req-value-${r.rowIndex}" value="${r.revenue || ''}" placeholder="0" min="0" step="50"
            oninput="onReqValueInput(${r.rowIndex})"
            style="width:80px;border:1px solid var(--light-grey);border-radius:4px;padding:4px 6px;font-size:12px;font-family:Arial,sans-serif;color:#333;">
        </div>
      </td>
      <td><span class="suggested-trainer">‚ö° ${suggested}</span></td>
      <td>
        <select class="trainer-select" id="select-${r.rowIndex}" onchange="onReqTrainerChange(${r.rowIndex})">
          <option value="" selected>‚Äî Leave unassigned ‚Äî</option>
          ${TRAINERS.map(t => `<option value="${t}">${t}</option>`).join('')}
        </select>
      </td>
      <td>
        <select id="req-status-${r.rowIndex}" style="border:1px solid #ccc;border-radius:4px;padding:4px 7px;font-size:12px;font-family:Arial,sans-serif;font-weight:600;cursor:pointer;min-width:100px;"
          onchange="applyReqStatusStyle(${r.rowIndex})">
          <option value="Assigned">Assigned</option>
          <option value="Booked">Booked</option>
          <option value="Pending">Pending</option>
          <option value="Cancelled" selected>Cancelled</option>
        </select>
      </td>
      <td>
        <button class="btn btn-primary btn-sm" id="req-save-${r.rowIndex}" onclick="saveUnassigned(${r.rowIndex})">Save</button>
      </td>
    </tr>
  `).join('');

  // Apply status colours after render ‚Äî default to Cancelled style since no trainer selected yet
  filtered.forEach(r => applyReqStatusStyle(r.rowIndex));
}

function filterRequests() { renderUnassigned(); }

function getSuggestedTrainer() {
  // Count assignments in last 30 days + upcoming
  const cutoff = new Date();
  cutoff.setDate(cutoff.getDate() - 30);

  const counts = {};
  TRAINERS.forEach(t => { counts[t] = 0; });
  allData.forEach(r => {
    if (r.trainer && counts.hasOwnProperty(r.trainer)) {
      if (!r.date || r.date >= cutoff) counts[r.trainer]++;
    }
  });

  // Return trainer with fewest recent assignments
  return TRAINERS.reduce((a, b) => counts[a] <= counts[b] ? a : b);
}

// Update allData value immediately as user types in unassigned panel
function onReqValueInput(rowIndex) {
  const inp = document.getElementById('req-value-' + rowIndex);
  const newValue = parseFloat(inp ? inp.value : 0) || 0;
  const row = allData.find(r => r.rowIndex === rowIndex);
  if (row) row.revenue = newValue;
}

// Apply colour to status dropdown in unassigned panel
function applyReqStatusStyle(rowIndex) {
  const sel = document.getElementById('req-status-' + rowIndex);
  if (!sel) return;
  applyStatusStyle(sel, sel.value);
}

// When trainer changes in unassigned panel, suggest appropriate status
function onReqTrainerChange(rowIndex) {
  const trainerSel = document.getElementById('select-' + rowIndex);
  const statusSel  = document.getElementById('req-status-' + rowIndex);
  if (!statusSel) return;

  if (trainerSel && trainerSel.value) {
    // Trainer selected ‚Äî suggest Assigned
    statusSel.value = 'Assigned';
  } else {
    // No trainer ‚Äî suggest Cancelled
    statusSel.value = 'Cancelled';
  }
  applyReqStatusStyle(rowIndex);
}

async function saveUnassigned(rowIndex) {
  const trainerSel = document.getElementById('select-' + rowIndex);
  const statusSel  = document.getElementById('req-status-' + rowIndex);
  const valueInp   = document.getElementById('req-value-' + rowIndex);
  const btn        = document.getElementById('req-save-' + rowIndex);

  const trainer  = trainerSel ? trainerSel.value : '';
  const newStatus = statusSel ? statusSel.value : 'Cancelled';
  const newValue  = valueInp ? (parseFloat(valueInp.value) || 0) : 0;

  // No trainer + not Cancelled = warn user
  if (!trainer && !['Cancelled'].includes(newStatus)) {
    showToast('Select a trainer or set status to Cancelled', 'error');
    return;
  }

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>';

  // Update local data + persist override
  const row = allData.find(r => r.rowIndex === rowIndex);
  if (row) {
    row.trainer = trainer;
    row.status  = newStatus;
    if (newValue > 0) row.revenue = newValue;
  }
  const ov = { trainer, status: newStatus };
  if (newValue > 0) ov.revenue = newValue;
  saveOverride(rowIndex, ov);

  // Build URL with all changed fields
  let url = APPS_SCRIPT_URL + '?action=assign&row=' + rowIndex
    + '&status=' + encodeURIComponent(newStatus);
  if (trainer) url += '&trainer=' + encodeURIComponent(trainer);
  if (newValue > 0) url += '&value=' + newValue;

  try {
    const res  = await fetch(url);
    const json = await res.json();
    showToast(json.success ? '‚úì Saved' : '‚úì Saved locally (sync sheet manually)', json.success ? 'success' : '');
  } catch(e) {
    showToast('‚úì Saved locally (sync sheet manually)', '');
  }

  btn.disabled = false;
  btn.textContent = 'Save';

  renderUnassigned();
  renderActionPanel();
  renderTrainerWorkload();
  renderAllBookings();
  renderKPIs();
}

// =============================================
// KPIs
// =============================================
function renderKPIs() {
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth();
  const lastMonth = month === 0 ? 11 : month - 1;
  const lastMonthYear = month === 0 ? year - 1 : year;

  const thisYearRows = allData.filter(r => r.date && r.date.getFullYear() === year && r.option !== '1' && r.status === 'Booked');
  const thisMonthRows = allData.filter(r => r.date && r.date.getFullYear() === year && r.date.getMonth() === month && r.option !== '1' && r.status === 'Booked');
  const lastMonthRows = allData.filter(r => r.date && r.date.getFullYear() === lastMonthYear && r.date.getMonth() === lastMonth && r.option !== '1' && r.status === 'Booked');

  const revYear = thisYearRows.reduce((s,r) => s + r.revenue, 0);
  const revMonth = thisMonthRows.reduce((s,r) => s + r.revenue, 0);
  const revLastMonth = lastMonthRows.reduce((s,r) => s + r.revenue, 0);
  const avgFee = thisYearRows.length ? Math.round(revYear / thisYearRows.filter(r=>r.revenue>0).length) : 0;

  // Training days
  const daysYear = thisYearRows.reduce((s,r) => s + (OPTION_DAYS[r.option] || 0), 0);
  const daysMonth = thisMonthRows.reduce((s,r) => s + (OPTION_DAYS[r.option] || 0), 0);

  document.getElementById('kpiRevYear').textContent = '¬£' + revYear.toLocaleString();
  document.getElementById('kpiRevMonth').textContent = '¬£' + revMonth.toLocaleString();
  document.getElementById('kpiAvgFee').textContent = avgFee ? '¬£' + avgFee.toLocaleString() : '‚Äî';
  document.getElementById('kpiDaysYear').textContent = daysYear;
  document.getElementById('kpiDaysMonth').textContent = daysMonth + ' this month';
  document.getElementById('kpiBookingsYear').textContent = thisYearRows.length;
  document.getElementById('kpiBookingsMonth').textContent = thisMonthRows.length + ' this month';

  // Delta
  const deltaEl = document.getElementById('kpiRevMonthDelta');
  if (revLastMonth > 0) {
    const pct = Math.round(((revMonth - revLastMonth) / revLastMonth) * 100);
    const up = pct >= 0;
    deltaEl.innerHTML = `<span class="kpi-card-delta ${up?'delta-up':'delta-down'}">${up?'‚ñ≤':'‚ñº'} ${Math.abs(pct)}% vs last month</span>`;
  }

  // Month labels
  const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  document.getElementById('thisMonthLabel').textContent = MONTHS[month];
  document.getElementById('lastMonthLabel').textContent = MONTHS[lastMonth];
  document.getElementById('thisMonthRev').textContent = '¬£' + revMonth.toLocaleString();
  document.getElementById('lastMonthRev').textContent = '¬£' + revLastMonth.toLocaleString();
}

// =============================================
// CHARTS
// =============================================
function renderCharts() {
  renderRevenueChart();
  renderOptionChart();
}

function renderRevenueChart() {
  const now = new Date();
  const year = now.getFullYear();
  const lastYear = year - 1;
  const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

  const thisYearByMonth = Array(12).fill(0);
  const lastYearByMonth = Array(12).fill(0);

  allData.forEach(r => {
    if (!r.date || r.option === '1') return;
    const y = r.date.getFullYear();
    const m = r.date.getMonth();
    if (y === year) thisYearByMonth[m] += r.revenue;
    else if (y === lastYear) lastYearByMonth[m] += r.revenue;
  });

  const ctx = document.getElementById('revenueChart').getContext('2d');
  if (revenueChart) revenueChart.destroy();

  revenueChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: MONTHS,
      datasets: [
        {
          label: String(year),
          data: thisYearByMonth,
          backgroundColor: 'rgba(33,71,244,0.7)',
          borderRadius: 3,
          borderSkipped: false,
        },
        {
          label: String(lastYear),
          data: lastYearByMonth,
          backgroundColor: 'rgba(163,186,255,0.5)',
          borderRadius: 3,
          borderSkipped: false,
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { labels: { font: { family: 'Arial', size: 11 }, boxWidth: 12 } },
        tooltip: {
          callbacks: {
            label: ctx => ` ¬£${ctx.parsed.y.toLocaleString()}`
          },
          bodyFont: { family: 'Arial', size: 12 }
        }
      },
      scales: {
        x: { grid: { display: false }, ticks: { font: { family:'Arial', size:11 } } },
        y: {
          ticks: {
            font: { family:'Arial', size:11 },
            callback: v => '¬£' + (v >= 1000 ? (v/1000).toFixed(0)+'k' : v)
          },
          grid: { color: '#f0f0f0' }
        }
      }
    }
  });
}

function renderOptionChart() {
  const now = new Date();
  const year = now.getFullYear();
  const counts = {'1':0,'2':0,'3':0,'4':0,'5':0};
  allData.filter(r => r.date && r.date.getFullYear() === year).forEach(r => { if (counts[r.option] !== undefined) counts[r.option]++; });

  const ctx = document.getElementById('optionChart').getContext('2d');
  if (optionChart) optionChart.destroy();

  optionChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Opt 1','Opt 2','Opt 3','Opt 4','Opt 5'],
      datasets: [{
        data: [counts['1'],counts['2'],counts['3'],counts['4'],counts['5']],
        backgroundColor: ['#b8caff','#2147f4','#f6be9d','#bde4b9','#beffd8'],
        borderWidth: 1,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom', labels: { font:{family:'Arial',size:10}, boxWidth:10, padding:8 } },
        tooltip: { bodyFont:{family:'Arial',size:11} }
      },
      cutout: '60%'
    }
  });
}

// =============================================
// TRAINER WORKLOAD
// =============================================
function renderTrainerWorkload() {
  const now = new Date();
  const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - 30);
  const today = new Date(); today.setHours(0,0,0,0);
  const future = new Date(); future.setDate(future.getDate() + 30);

  const suggested = getSuggestedTrainer();
  const counts = {};
  const upcoming = {};
  TRAINERS.forEach(t => { counts[t] = 0; upcoming[t] = 0; });

  allData.forEach(r => {
    if (r.trainer && counts.hasOwnProperty(r.trainer)) {
      if (r.date) {
        if (r.date >= cutoff && r.date <= today) counts[r.trainer]++;
        if (r.date >= today && r.date <= future) upcoming[r.trainer]++;
      } else {
        counts[r.trainer]++;
      }
    }
  });

  const maxCount = Math.max(...Object.values(counts), 1);
  const grid = document.getElementById('trainerGrid');

  grid.innerHTML = TRAINERS.map(t => {
    const pct = Math.round((counts[t] / maxCount) * 100);
    const barClass = pct > 75 ? 'busy' : pct > 40 ? 'medium' : '';
    const isSuggested = t === suggested;
    return `
      <div class="trainer-card">
        <div class="trainer-name">${t}</div>
        <div class="trainer-stat">
          <span>Last 30 days</span>
          <span class="trainer-stat-val">${counts[t]}</span>
        </div>
        <div class="trainer-stat">
          <span>Upcoming (30d)</span>
          <span class="trainer-stat-val">${upcoming[t]}</span>
        </div>
        <div class="workload-bar-wrap">
          <div class="workload-bar ${barClass}" style="width:${pct}%"></div>
        </div>
        ${isSuggested ? '<div class="suggested-tag">‚ö° Next in rotation</div>' : ''}
      </div>
    `;
  }).join('');
}


// =============================================
// NEEDS ACTION PANEL (Assigned + Pending)
// =============================================
function renderActionPanel() {
  const actionRows = allData.filter(r => {
    if (!r.date || r.date < new Date('2026-01-01')) return false;
    return r.status === 'Assigned' || r.status === 'Pending';
  });

  document.getElementById('actionBadge').textContent = actionRows.length;
  const dot = document.getElementById('actionDot');
  dot.style.display = actionRows.length > 0 ? 'block' : 'none';

  const tbody = document.getElementById('actionRequestsBody');

  if (actionRows.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8"><div class="empty-state">'
      + '<div class="empty-state-icon">‚úÖ</div>'
      + '<div class="empty-state-text">Nothing needs action right now</div>'
      + '</div></td></tr>';
    return;
  }

  tbody.innerHTML = actionRows.map(r => {
    const status = r.status || 'Assigned';
    const statuses = ['Assigned', 'Booked', 'Pending', 'Cancelled'];
    const opts = statuses.map(s =>
      '<option value="' + s + '"' + (status === s ? ' selected' : '') + '>' + s + '</option>'
    ).join('');

    return '<tr id="action-row-' + r.rowIndex + '">'
      + '<td style="white-space:nowrap;">' + formatDate(r.date || r.timestamp) + '</td>'
      + '<td><strong>' + esc(r.company) + '</strong></td>'
      + '<td>' + esc(r.contact) + '</td>'
      + '<td><span class="option-badge opt-' + r.option + '">Opt ' + r.option + '</span></td>'
      + '<td style="white-space:nowrap;">' + (esc(r.preferredDate) || '‚Äî') + '</td>'
      + '<td style="font-weight:600;">' + (r.revenue ? '¬£' + r.revenue.toLocaleString() : '‚Äî') + '</td>'
      + '<td>' + (esc(r.trainer) || '<span style="color:var(--text--dark--20)">‚Äî</span>') + '</td>'
      + '<td>'
        + '<select id="action-status-' + r.rowIndex + '" '
        + 'onchange="onActionStatusChange(' + r.rowIndex + ')" '
        + 'style="border:1px solid #ccc;border-radius:4px;padding:4px 7px;font-size:12px;'
        + 'font-family:Arial,sans-serif;font-weight:600;cursor:pointer;min-width:100px;">'
        + opts
        + '</select>'
      + '</td>'
      + '</tr>';
  }).join('');

  // Apply colours
  actionRows.forEach(r => {
    const sel = document.getElementById('action-status-' + r.rowIndex);
    if (sel) applyStatusStyle(sel, r.status || 'Assigned');
  });
}

async function onActionStatusChange(rowIndex) {
  const sel = document.getElementById('action-status-' + rowIndex);
  const newStatus = sel ? sel.value : '';
  if (!newStatus) return;

  const row = allData.find(r => r.rowIndex === rowIndex);
  if (row) row.status = newStatus;
  if (sel) applyStatusStyle(sel, newStatus);
  saveOverride(rowIndex, { status: newStatus });

  // Also sync status dropdown in main table if visible
  const mainSel = document.getElementById('sel-status-' + rowIndex);
  if (mainSel) { mainSel.value = newStatus; applyStatusStyle(mainSel, newStatus); }

  // Show inline date picker in action panel row if Booked
  const actionDateWrap = document.getElementById('action-date-wrap-' + rowIndex);
  if (actionDateWrap) actionDateWrap.style.display = newStatus === 'Booked' ? 'flex' : 'none';

  // Also show/hide in main bookings table
  const mainDateWrap = document.getElementById('booked-date-wrap-' + rowIndex);
  if (mainDateWrap) mainDateWrap.style.display = newStatus === 'Booked' ? 'flex' : 'none';

  let url = APPS_SCRIPT_URL + '?action=assign&row=' + rowIndex + '&status=' + encodeURIComponent(newStatus);
  showToast('Status ‚Üí ' + newStatus, 'success');
  try { await fetch(url); } catch(e) {}

  renderActionPanel();
  renderUnassigned();
  renderKPIs();
  renderCharts();
}

// Fires when booked-on date picked from action panel
async function onActionBookedDateChange(rowIndex) {
  const dateInp = document.getElementById('action-booked-date-' + rowIndex);
  const bookedOn = dateInp ? dateInp.value : '';

  const row = allData.find(r => r.rowIndex === rowIndex);
  if (row) row.bookedOn = bookedOn;

  // Sync to main table date input if present
  const mainInp = document.getElementById('inp-booked-date-' + rowIndex);
  if (mainInp) mainInp.value = bookedOn;

  showToast('Booked on date saved', 'success');
  try {
    await fetch(APPS_SCRIPT_URL + '?action=assign&row=' + rowIndex + '&bookedOn=' + encodeURIComponent(bookedOn));
  } catch(e) {}
}

// =============================================
// ALL BOOKINGS TABLE
// =============================================

const STATUS_COLOURS = {
  'Unassigned': { bg: '#fde8eb', color: '#c0303d', border: '#c0303d' },
  'Assigned':   { bg: '#f5ede5', color: '#8a5a2a', border: '#8a5a2a' },
  'Booked':     { bg: '#b8caff', color: '#2147f4', border: '#2147f4' },
  'Pending':    { bg: '#beffd8', color: '#1a6a40', border: '#1a6a40' },
  'Cancelled':  { bg: '#f0f0f0', color: '#999',    border: '#ccc'    }
};

function applyStatusStyle(sel, status) {
  const c = STATUS_COLOURS[status] || {};
  sel.style.background   = c.bg     || '#fff';
  sel.style.color        = c.color  || '#333';
  sel.style.borderColor  = c.border || 'var(--light-grey)';
  sel.style.fontWeight   = '600';
}

function buildStatusSelect(rowIndex, current, bookedOn) {
  const statuses = ['Unassigned','Assigned','Booked','Pending','Cancelled'];
  const opts = statuses.map(s =>
    '<option value="' + s + '"' + (current === s ? ' selected' : '') + '>' + s + '</option>'
  ).join('');
  const showDate = current === 'Booked';
  const dateVal  = bookedOn || '';
  return '<div style="display:flex;flex-direction:column;gap:5px;">'
    + '<select id="sel-status-' + rowIndex + '" '
    + 'onchange="onStatusChange(' + rowIndex + ')" '
    + 'style="border:1px solid #ccc;border-radius:4px;padding:4px 7px;font-size:12px;'
    + 'font-family:Arial,sans-serif;font-weight:600;cursor:pointer;min-width:100px;">'
    + opts + '</select>'
    + '<div id="booked-date-wrap-' + rowIndex + '" style="display:' + (showDate ? 'flex' : 'none') + ';align-items:center;gap:4px;">'
    + '<input type="date" id="inp-booked-date-' + rowIndex + '" value="' + dateVal + '" '
    + 'onchange="onBookedDateChange(' + rowIndex + ')" '
    + 'style="border:1px solid #2147f4;border-radius:4px;padding:3px 6px;font-size:11px;'
    + 'font-family:Arial,sans-serif;color:#2147f4;background:#f0f4ff;width:130px;" '
    + 'placeholder="Booked on date">'
    + '</div>'
    + '</div>';
}

function renderAllBookings() {
  const statusF  = document.getElementById('filterStatus')?.value  || '';
  const trainerF = document.getElementById('filterTrainer')?.value || '';
  const optionF  = document.getElementById('filterOption')?.value  || '';

  let filtered = allData.filter(r => {
    if (statusF  && r.status  !== statusF)  return false;
    if (trainerF && r.trainer !== trainerF) return false;
    if (optionF  && r.option  !== optionF)  return false;
    return true;
  });

  // Sort: Unassigned first (excluding Booked/Cancelled), then everything else newest-first
  filtered.sort((a, b) => {
    const aTop = (!a.status || a.status === 'Unassigned');
    const bTop = (!b.status || b.status === 'Unassigned');
    if (aTop && !bTop) return -1;
    if (!aTop && bTop) return 1;
    return (b.date || 0) - (a.date || 0);
  });

  document.getElementById('allBadge').textContent  = filtered.length;
  document.getElementById('rowCount').textContent  = filtered.length + ' records';

  const total = Math.ceil(filtered.length / PAGE_SIZE);
  if (currentPage > total) currentPage = 1;
  const page = filtered.slice((currentPage - 1) * PAGE_SIZE, currentPage * PAGE_SIZE);

  document.getElementById('prevBtn').disabled  = currentPage <= 1;
  document.getElementById('nextBtn').disabled  = currentPage >= total;
  document.getElementById('pageInfo').textContent = 'Page ' + currentPage + ' of ' + (total || 1);

  const tbody = document.getElementById('allBookingsBody');

  if (page.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8"><div class="empty-state">'
      + '<div class="empty-state-icon">üì≠</div>'
      + '<div class="empty-state-text">No records match your filters</div>'
      + '</div></td></tr>';
    return;
  }

  tbody.innerHTML = page.map(r => {
    const trainerOpts = '<option value="">Unassigned</option>'
      + TRAINERS.map(t => '<option value="' + t + '"' + (r.trainer === t ? ' selected' : '') + '>' + t + '</option>').join('');

    const status = r.status || 'Unassigned';

    return '<tr id="book-row-' + r.rowIndex + '">'
      + '<td style="white-space:nowrap;">' + formatDate(r.date || r.timestamp) + '</td>'
      + '<td><strong>' + esc(r.company) + '</strong></td>'
      + '<td>' + esc(r.contact) + '</td>'
      + '<td><span class="option-badge opt-' + r.option + '">Opt ' + r.option + '</span></td>'
      + '<td>' + r.attendees + '</td>'
      + '<td>'
        + '<select id="sel-trainer-' + r.rowIndex + '" '
        + 'onchange="onTrainerChange(' + r.rowIndex + ')" '
        + 'style="min-width:90px;border:1px solid #ccc;border-radius:4px;padding:4px 7px;font-size:12px;font-family:Arial,sans-serif;">'
        + trainerOpts
        + '</select>'
      + '</td>'
      + '<td>'
        + '<div style="display:flex;align-items:center;gap:4px;">'
        + '<span style="color:var(--text--dark--30);font-size:12px;">¬£</span>'
        + '<input type="number" id="inp-value-' + r.rowIndex + '" '
        + 'value="' + (r.revenue || '') + '" placeholder="0" min="0" step="50" '
        + 'oninput="onValueInput(' + r.rowIndex + ')" '
        + 'style="width:80px;border:1px solid #ccc;border-radius:4px;padding:4px 6px;font-size:12px;font-family:Arial,sans-serif;color:#333;">'
        + '</div>'
      + '</td>'
      + '<td>' + buildStatusSelect(r.rowIndex, status, r.bookedOn || '') + '</td>'
      + '<td style="max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="' + esc(r.notes) + '">' + (esc(r.notes) || '‚Äî') + '</td>'
      + '</tr>';
  }).join('');

  // Apply colour styling to all status dropdowns after render
  page.forEach(r => {
    const sel = document.getElementById('sel-status-' + r.rowIndex);
    if (sel) applyStatusStyle(sel, r.status || 'Unassigned');
  });
}

// Fires immediately when status dropdown changes
async function onStatusChange(rowIndex) {
  const sel = document.getElementById('sel-status-' + rowIndex);
  const newStatus = sel ? sel.value : '';
  if (!newStatus) return;

  const row = allData.find(r => r.rowIndex === rowIndex);
  if (row) row.status = newStatus;
  if (sel) applyStatusStyle(sel, newStatus);
  saveOverride(rowIndex, { status: newStatus });

  // Show/hide booked-on date picker
  const dateWrap = document.getElementById('booked-date-wrap-' + rowIndex);
  if (dateWrap) dateWrap.style.display = newStatus === 'Booked' ? 'flex' : 'none';

  // If switching away from Booked, clear the date
  if (newStatus !== 'Booked') {
    const dateInp = document.getElementById('inp-booked-date-' + rowIndex);
    if (dateInp) dateInp.value = '';
    if (row) row.bookedOn = '';
  }

  // Build URL ‚Äî include bookedOn date if Booked and date already set
  let url = APPS_SCRIPT_URL + '?action=assign&row=' + rowIndex + '&status=' + encodeURIComponent(newStatus);
  if (newStatus === 'Booked') {
    const dateInp = document.getElementById('inp-booked-date-' + rowIndex);
    if (dateInp && dateInp.value) url += '&bookedOn=' + encodeURIComponent(dateInp.value);
  }

  showToast('Status ‚Üí ' + newStatus, 'success');
  try { await fetch(url); } catch(e) {}

  renderUnassigned();
  renderActionPanel();
  renderTrainerWorkload();
  renderKPIs();
  renderCharts();
}

// Fires when booked-on date is picked
async function onBookedDateChange(rowIndex) {
  const dateInp = document.getElementById('inp-booked-date-' + rowIndex);
  const bookedOn = dateInp ? dateInp.value : '';

  const row = allData.find(r => r.rowIndex === rowIndex);
  if (row) row.bookedOn = bookedOn;
  saveOverride(rowIndex, { bookedOn });

  showToast('Booked on date saved', 'success');
  try {
    await fetch(APPS_SCRIPT_URL + '?action=assign&row=' + rowIndex + '&bookedOn=' + encodeURIComponent(bookedOn));
  } catch(e) {}
}

// Fires when trainer dropdown changes ‚Äî auto-saves immediately
async function onTrainerChange(rowIndex) {
  const sel = document.getElementById('sel-trainer-' + rowIndex);
  const newTrainer = sel ? sel.value : '';

  const row = allData.find(r => r.rowIndex === rowIndex);
  if (row) {
    row.trainer = newTrainer;
    saveOverride(rowIndex, { trainer: newTrainer });
    if (newTrainer && (!row.status || row.status === 'Unassigned')) {
      row.status = 'Assigned';
      // Update status dropdown to match
      const statusSel = document.getElementById('sel-status-' + rowIndex);
      if (statusSel) { statusSel.value = 'Assigned'; applyStatusStyle(statusSel, 'Assigned'); }
    }
    if (!newTrainer) {
      row.status = 'Unassigned';
      const statusSel = document.getElementById('sel-status-' + rowIndex);
      if (statusSel) { statusSel.value = 'Unassigned'; applyStatusStyle(statusSel, 'Unassigned'); }
    }
  }

  showToast('Trainer ‚Üí ' + (newTrainer || 'Unassigned'), 'success');

  try {
    await fetch(APPS_SCRIPT_URL + '?action=assign&row=' + rowIndex
      + '&trainer=' + encodeURIComponent(newTrainer)
      + '&status=' + encodeURIComponent(row ? row.status : 'Assigned'),
      );
  } catch(e) {}

  renderUnassigned();
  renderActionPanel();
  renderTrainerWorkload();
}

// Fires when value input changes ‚Äî auto-saves immediately
// Debounce timers for value saves
const _valueSaveTimers = {};

function onValueInput(rowIndex) {
  const inp = document.getElementById('inp-value-' + rowIndex);
  const newValue = parseFloat(inp ? inp.value : 0) || 0;

  // Update allData immediately so re-renders use the correct value
  const row = allData.find(r => r.rowIndex === rowIndex);
  if (row) row.revenue = newValue;

  // Debounce: wait 800ms after last keystroke before saving to sheet
  clearTimeout(_valueSaveTimers[rowIndex]);
  saveOverride(rowIndex, { revenue: newValue });
  _valueSaveTimers[rowIndex] = setTimeout(async () => {
    showToast('Value ‚Üí ¬£' + newValue.toLocaleString(), 'success');
    try {
      await fetch(APPS_SCRIPT_URL + '?action=assign&row=' + rowIndex + '&value=' + newValue);
    } catch(e) {}
    renderKPIs();
    renderCharts();
  }, 800);
}

function populateTrainerFilter() {
  const sel = document.getElementById('filterTrainer');
  const current = sel.value;
  sel.innerHTML = '<option value="">All Trainers</option>' +
    TRAINERS.map(t => `<option value="${t}" ${t===current?'selected':''}>${t}</option>`).join('');
}

function changePage(dir) {
  currentPage += dir;
  renderAllBookings();
}

// =============================================
// UTILS
// =============================================
function formatDate(d) {
  if (!d) return '‚Äî';
  const dt = d instanceof Date ? d : new Date(d);
  if (isNaN(dt.getTime())) return String(d).slice(0,10) || '‚Äî';
  return dt.toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric' });
}

function esc(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/[<]/g,'&lt;').replace(/[>]/g,'&gt;').replace(/"/g,'&quot;');
}

// =============================================
// PERMISSIONS & USERS
// =============================================
const USERS_KEY   = 'streetDashboardUsers_v2';
const SESSION_KEY = 'streetDashboardSession';
const ACTIVITY_KEY = 'streetDashboardActivity_v2';
const CAL_KEY = 'streetDashboardCalSettings';

const ALL_PERMISSIONS = {
  edit_status:       { label:'Edit Booking Status',          desc:'Change status on any booking',                          group:'Bookings'    },
  edit_trainer:      { label:'Edit Trainer Assignment',      desc:'Assign or change the trainer on a booking',             group:'Bookings'    },
  edit_value:        { label:'Edit Invoice Value',           desc:'Change the ¬£ value of any booking',                     group:'Bookings'    },
  edit_booked_date:  { label:'Edit Booked Date',             desc:'Set or change the confirmed training date',             group:'Bookings'    },
  view_workload:     { label:'View Trainer Workload',        desc:'See trainer workload cards and availability',           group:'Sections'    },
  view_calendar:     { label:'View Training Calendar',       desc:'See the training calendar and sync Google Calendar',   group:'Sections'    },
  view_unassigned:   { label:'View Unassigned Requests',     desc:'See and action new unassigned booking requests',       group:'Sections'    },
  view_needs_action: { label:'View Needs Action',            desc:'See assigned/pending bookings awaiting confirmation',  group:'Sections'    },
  view_performance:  { label:'View Performance Overview',    desc:'See KPI cards and revenue charts',                     group:'Sections'    },
  view_all_bookings: { label:'View All Bookings',            desc:'See and filter the full bookings table',               group:'Sections'    },
  manage_trainers:   { label:'Manage Trainers',              desc:'Add, remove trainers and edit their permissions',      group:'Admin'       },
  reassign_trainers: { label:'Reassign Enquiries',           desc:'Bulk-reassign enquiries between trainers',             group:'Admin'       },
  refresh_data:      { label:'Refresh Data',                 desc:'Reload data from Google Sheets',                      group:'Admin'       },
  clear_activity:    { label:'Clear Activity Log',           desc:'Permanently delete the activity feed history',         group:'Admin'       },
  view_activity:     { label:'View Activity Feed',           desc:'See the log of all dashboard changes',                 group:'Admin'       },
  nav_feedback:      { label:'Training Feedback Dashboard',  desc:'Access to Training CSAT/Feedback Dashboard link',     group:'Navigation'  },
  nav_til:           { label:'TIL Tracker',                  desc:'Access to TIL Tracker link',                          group:'Navigation'  },
  nav_survey:        { label:'Client Feedback Survey',       desc:'Access to Client Feedback Survey link',               group:'Navigation'  },
  nav_spreadsheet:   { label:'Bookings Spreadsheet',         desc:'Access to Google Sheets bookings spreadsheet',        group:'Navigation'  },
  nav_request_form:  { label:'Training Request Form',        desc:'Access to the training request form link',            group:'Navigation'  },
};

const PERMISSION_PRESETS = {
  admin: {
    edit_status:true,edit_trainer:true,edit_value:true,edit_booked_date:true,
    view_workload:true,view_calendar:true,view_unassigned:true,view_needs_action:true,
    view_performance:true,view_all_bookings:true,
    manage_trainers:true,reassign_trainers:true,refresh_data:true,
    clear_activity:true,view_activity:true,
    nav_feedback:true,nav_til:true,nav_survey:true,nav_spreadsheet:true,nav_request_form:true,
  },
  editor: {
    edit_status:true,edit_trainer:true,edit_value:true,edit_booked_date:true,
    view_workload:true,view_calendar:true,view_unassigned:true,view_needs_action:true,
    view_performance:true,view_all_bookings:true,
    manage_trainers:false,reassign_trainers:true,refresh_data:true,
    clear_activity:false,view_activity:true,
    nav_feedback:true,nav_til:true,nav_survey:true,nav_spreadsheet:true,nav_request_form:true,
  },
  viewer: {
    edit_status:false,edit_trainer:false,edit_value:false,edit_booked_date:false,
    view_workload:false,view_calendar:false,view_unassigned:false,view_needs_action:false,
    view_performance:false,view_all_bookings:false,
    manage_trainers:false,reassign_trainers:false,refresh_data:false,
    clear_activity:false,view_activity:false,
    nav_feedback:false,nav_til:false,nav_survey:false,nav_spreadsheet:false,nav_request_form:true,
  },
};

const BOOKINGS_ONLY_PRESET = {
  edit_status:true,edit_trainer:true,edit_value:true,edit_booked_date:true,
  view_workload:true,view_calendar:true,view_unassigned:true,view_needs_action:true,
  view_performance:false,view_all_bookings:true,
  manage_trainers:false,reassign_trainers:true,refresh_data:true,
  clear_activity:false,view_activity:false,
  nav_feedback:true,nav_til:true,nav_survey:false,nav_spreadsheet:false,nav_request_form:true,
};

function getUsers() {
  let users = [];
  try { const s = localStorage.getItem(USERS_KEY); if (s) users = JSON.parse(s) || []; } catch(e) {}
  let amy = users.find(u => u.name === 'Amy');
  if (!amy) { amy = { name:'Amy', permissions:{} }; users.unshift(amy); }
  amy.permissions = { ...PERMISSION_PRESETS.admin };
  let max = users.find(u => u.name === 'Max');
  if (!max) { max = { name:'Max', permissions:{} }; users.splice(users.findIndex(u=>u.name==='Amy')+1,0,max); }
  max.permissions = { ...BOOKINGS_ONLY_PRESET };
  try { localStorage.setItem(USERS_KEY, JSON.stringify(users)); } catch(e) {}
  return users;
}
function saveUsers(arr) { try { localStorage.setItem(USERS_KEY, JSON.stringify(arr)); } catch(e) {} }
function getCurrentUser() { try { const s = localStorage.getItem(SESSION_KEY); return s ? JSON.parse(s) : null; } catch(e) { return null; } }
function setCurrentUser(u) { try { localStorage.setItem(SESSION_KEY, JSON.stringify(u)); localStorage.setItem('streetDashboardUser', u.name); } catch(e) {} }
function hasPerm(k) { const u = getCurrentUser(); return u && u.permissions && u.permissions[k] === true; }

// =============================================
// PERMISSIONS UI
// =============================================
function applyPermissions() {
  const u = getCurrentUser(); if (!u) return;
  const p = u.permissions || {};
  // Sections
  const show = (id, key) => { const el = document.getElementById(id); if (el) el.style.display = p[key] ? '' : 'none'; };
  show('sectionWorkload','view_workload');
  show('calSection','view_calendar');
  show('sectionUnassigned','view_unassigned');
  show('sectionNeedsAction','view_needs_action');
  show('sectionPerformance','view_performance');
  show('sectionAllBookings','view_all_bookings');
  // Navigation items
  const navShow = (id, key) => { const el = document.getElementById(id); if (el) el.style.display = p[key] ? '' : 'none'; };
  navShow('navFeedback','nav_feedback');
  navShow('navTil','nav_til');
  navShow('navSurvey','nav_survey');
  navShow('navSpreadsheet','nav_spreadsheet');
  navShow('navRequestForm','nav_request_form');
  // Nav jump links
  const jumpShow = (id, key) => { const el = document.getElementById(id); if (el) el.style.display = p[key] ? '' : 'none'; };
  jumpShow('navJumpCalendar','view_calendar');
  // Header
  const chip = document.getElementById('headerUserChip');
  if (chip) { chip.style.display = 'flex'; chip.querySelector('#headerUserAvatar').textContent = u.name[0].toUpperCase(); chip.querySelector('#headerUserName').textContent = u.name; }
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) logoutBtn.style.display = 'flex';
  // Charts section (part of performance)
  const charts = document.querySelector('.charts-grid');
  if (charts) charts.style.display = p['view_performance'] ? '' : 'none';
  const kpiGrid = document.querySelector('.kpi-grid');
  if (kpiGrid) kpiGrid.style.display = p['view_performance'] ? '' : 'none';
  // Manage trainers button
  const manageBtn = document.querySelector('[onclick="openTrainerModal()"]');
  if (manageBtn) manageBtn.style.display = p['manage_trainers'] ? '' : 'none';
  // Refresh button
  const refreshBtn = document.querySelector('[onclick="loadData()"]');
  if (refreshBtn) refreshBtn.style.display = p['refresh_data'] ? '' : 'none';
  // Activity button
  const actBtn = document.querySelector('.activity-btn[onclick="openActivityPanel()"]');
  if (actBtn) actBtn.style.display = p['view_activity'] ? 'flex' : 'none';
  // Update activity display
  const actDisp = document.getElementById('activityUserDisplay');
  if (actDisp) actDisp.textContent = u.name;
  const av = document.getElementById('activityAvatar');
  if (av) av.textContent = u.name[0].toUpperCase();
}

// =============================================
// LOGIN SYSTEM
// =============================================
function renderLoginScreen() {
  USERS = getUsers(); TRAINERS = USERS.map(u => u.name);
  const grid = document.getElementById('loginUserGrid');
  if (!grid) return;
  if (USERS.length === 0) { grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:24px;color:var(--text--dark--30);font-size:13px;">No users yet. Add trainers in the dashboard first.</div>'; return; }
  grid.innerHTML = USERS.map(u => {
    const perms = u.permissions || {};
    const isAdmin = Object.keys(PERMISSION_PRESETS.admin).every(k => perms[k]);
    const isViewer = !perms['edit_status'] && !perms['manage_trainers'];
    const roleLabel = isAdmin ? '<span class="login-user-badge admin">Admin</span>' : isViewer ? '<span class="login-user-badge viewer">Viewer</span>' : '<span class="login-user-badge editor">Editor</span>';
    return `<button class="login-user-btn" onclick="loginAs('${esc(u.name)}')">
      <div class="login-user-avatar">${u.name[0].toUpperCase()}</div>
      <div class="login-user-name">${esc(u.name)}</div>
      ${roleLabel}
    </button>`;
  }).join('');
  document.getElementById('loginScreen').classList.remove('hidden');
}

function loginAs(name) {
  USERS = getUsers();
  const user = USERS.find(u => u.name === name);
  if (!user) return;
  // Check if user has a PIN
  const pinKey = 'streetPin_' + name;
  const storedPin = localStorage.getItem(pinKey);
  _pendingLoginUser = user;
  if (storedPin) {
    openPinScreen(name, false);
  } else {
    openPinScreen(name, true); // setup mode
  }
}

function logout() {
  try { localStorage.removeItem(SESSION_KEY); } catch(e) {}
  renderLoginScreen();
  document.getElementById('headerUserChip').style.display = 'none';
  document.getElementById('logoutBtn').style.display = 'none';
}

// =============================================
// PIN SYSTEM
// =============================================
let _pendingLoginUser = null;
let _pinBuffer = '';
let _pinMode = 'enter'; // 'enter' | 'setup' | 'setup2' | 'change'
let _pinFirstEntry = '';

function openPinScreen(name, isSetup) {
  _pinBuffer = ''; _pinMode = isSetup ? 'setup' : 'enter'; _pinFirstEntry = '';
  const screen = document.getElementById('pinScreen');
  document.getElementById('pinAvatar').textContent = name[0].toUpperCase();
  document.getElementById('pinUserName').textContent = name;
  document.getElementById('pinLabel').textContent = isSetup ? 'Create a 4-digit passcode' : 'Enter your 4-digit passcode';
  document.getElementById('pinSetupInfo').style.display = isSetup ? 'block' : 'none';
  document.getElementById('pinError').textContent = '';
  document.getElementById('pinForgotWrap').style.display = isSetup ? 'none' : 'block';
  _updatePinDots();
  document.getElementById('loginScreen').classList.add('hidden');
  screen.classList.remove('hidden');
}

function changeSelfPin() {
  closeActivityPanel();
  const u = getCurrentUser(); if (!u) return;
  _pendingLoginUser = u; _pinMode = 'change'; _pinBuffer = ''; _pinFirstEntry = '';
  openPinScreen(u.name, true);
}

function pinKey(d) {
  if (_pinBuffer.length >= 4) return;
  _pinBuffer += d;
  _updatePinDots();
  if (_pinBuffer.length === 4) setTimeout(_pinSubmit, 120);
}

function pinDel() {
  _pinBuffer = _pinBuffer.slice(0, -1);
  _updatePinDots();
  document.getElementById('pinError').textContent = '';
}

function _updatePinDots() {
  for (let i = 0; i < 4; i++) {
    const dot = document.getElementById('pd' + i);
    if (dot) { dot.className = 'pin-dot' + (_pinBuffer.length > i ? ' filled' : ''); }
  }
}

function _pinError(msg) {
  document.getElementById('pinError').textContent = msg;
  for (let i = 0; i < 4; i++) { const d = document.getElementById('pd'+i); if (d) d.className = 'pin-dot error'; }
  setTimeout(() => { _pinBuffer = ''; _updatePinDots(); }, 700);
}

function _pinSubmit() {
  if (!_pendingLoginUser) return;
  const pinKey = 'streetPin_' + _pendingLoginUser.name;
  if (_pinMode === 'enter') {
    const stored = localStorage.getItem(pinKey);
    if (_pinBuffer === stored) {
      _completePinLogin();
    } else {
      _pinError('Incorrect passcode');
    }
  } else if (_pinMode === 'setup' || _pinMode === 'change') {
    _pinFirstEntry = _pinBuffer; _pinBuffer = '';
    document.getElementById('pinLabel').textContent = 'Confirm your passcode';
    document.getElementById('pinSetupInfo').style.display = 'none';
    _updatePinDots();
    _pinMode = 'setup2';
  } else if (_pinMode === 'setup2') {
    if (_pinBuffer === _pinFirstEntry) {
      try { localStorage.setItem(pinKey, _pinBuffer); } catch(e) {}
      _completePinLogin();
    } else {
      _pinError("Passcodes don't match");
      _pinMode = 'setup';
      _pinFirstEntry = '';
      setTimeout(() => { document.getElementById('pinLabel').textContent = 'Create a 4-digit passcode'; document.getElementById('pinSetupInfo').style.display = 'block'; }, 800);
    }
  }
}

function _completePinLogin() {
  setCurrentUser(_pendingLoginUser);
  document.getElementById('pinScreen').classList.add('hidden');
  document.getElementById('loginScreen').classList.add('hidden');
  applyPermissions();
  showToast('Welcome, ' + _pendingLoginUser.name + '! üëã', 'success');
  _pendingLoginUser = null;
}

function pinForgot() {
  if (!_pendingLoginUser) return;
  if (confirm('This will remove your current passcode. You will need to set a new one.\n\nContinue?')) {
    try { localStorage.removeItem('streetPin_' + _pendingLoginUser.name); } catch(e) {}
    _pinMode = 'setup'; _pinBuffer = ''; _pinFirstEntry = '';
    document.getElementById('pinLabel').textContent = 'Create a new 4-digit passcode';
    document.getElementById('pinSetupInfo').style.display = 'block';
    document.getElementById('pinForgotWrap').style.display = 'none';
    document.getElementById('pinError').textContent = '';
    _updatePinDots();
  }
}

function pinBack() {
  document.getElementById('pinScreen').classList.add('hidden');
  renderLoginScreen();
  _pendingLoginUser = null;
}

// =============================================
// SHADOW MODE
// =============================================
let _shadowFromUser = null;
let _shadowTargetUser = null;

function enterShadowMode() {
  const target = _editPermTarget;
  if (!target) return;
  _shadowFromUser = getCurrentUser();
  _shadowTargetUser = target;
  closeEditPermModal();
  setCurrentUser(target);
  document.getElementById('shadowBanner').classList.add('active');
  document.getElementById('shadowBannerName').textContent = target.name;
  document.body.classList.add('shadow-mode');
  applyPermissions();
  showToast('üëÅ Previewing as ' + target.name, '');
}

function exitShadowMode() {
  if (_shadowFromUser) setCurrentUser(_shadowFromUser);
  document.getElementById('shadowBanner').classList.remove('active');
  document.body.classList.remove('shadow-mode');
  applyPermissions();
  _shadowFromUser = null; _shadowTargetUser = null;
}

function saveShadowAndExit() {
  if (_shadowFromUser) setCurrentUser(_shadowFromUser);
  document.getElementById('shadowBanner').classList.remove('active');
  document.body.classList.remove('shadow-mode');
  applyPermissions();
  if (_shadowTargetUser) openEditPermModal(_shadowTargetUser.name);
  _shadowFromUser = null; _shadowTargetUser = null;
}

// =============================================
// ACTIVITY FEED
// =============================================
function getActivityLog() { try { return JSON.parse(localStorage.getItem(ACTIVITY_KEY) || '[]'); } catch(e) { return []; } }
function saveActivityLog(log) { try { localStorage.setItem(ACTIVITY_KEY, JSON.stringify(log.slice(0, 200))); } catch(e) {} }

function logActivity(type, company, action, detail) {
  const u = getCurrentUser();
  const entry = { type, company, action, detail, user: u ? u.name : 'Unknown', ts: new Date().toISOString() };
  const log = getActivityLog();
  log.unshift(entry);
  saveActivityLog(log);
  // Show dot
  const dot = document.getElementById('activityBtnDot');
  if (dot) dot.classList.add('visible');
  renderActivityFeed();
}

function renderActivityFeed() {
  const log = getActivityLog();
  const body = document.getElementById('activityFeedBody');
  if (!body) return;
  document.getElementById('activityCount').textContent = log.length + ' event' + (log.length !== 1 ? 's' : '');
  if (log.length === 0) {
    body.innerHTML = '<div style="padding:48px 24px;text-align:center;color:var(--text--dark--30);font-size:13px;"><div style="font-size:32px;margin-bottom:10px;">üìã</div>No activity yet</div>';
    return;
  }
  const typeConfig = {
    trainer:  { icon:'üë§', bg:'#e8f0ff', label:'Assigned' },
    status:   { icon:'üìã', bg:'#fef3f2', label:'Status'   },
    value:    { icon:'¬£',  bg:'#f0fdf4', label:'Value'    },
    date:     { icon:'üìÖ', bg:'#fffbeb', label:'Date'     },
    trainer_deleted: { icon:'üóë', bg:'#fde8eb', label:'Removed' },
    trainer_added:   { icon:'‚ûï', bg:'#f0fdf4', label:'Added'   },
  };
  let html = ''; let lastDate = '';
  log.forEach(e => {
    const d = new Date(e.ts);
    const dayStr = d.toLocaleDateString('en-GB', { weekday:'short', day:'numeric', month:'long' });
    if (dayStr !== lastDate) { html += `<div class="activity-date-divider">${dayStr}</div>`; lastDate = dayStr; }
    const cfg = typeConfig[e.type] || { icon:'üìù', bg:'#f6f6f6', label:'Update' };
    const time = d.toLocaleTimeString('en-GB', { hour:'2-digit', minute:'2-digit' });
    html += `<div class="activity-item">
      <div style="width:30px;height:30px;border-radius:50%;background:${cfg.bg};display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;">${cfg.icon}</div>
      <div style="flex:1;min-width:0;">
        <div style="font-size:12px;color:var(--text--dark--50);line-height:1.45;">
          ${e.action}${e.detail ? ' ‚Äî <strong>' + esc(String(e.detail)) + '</strong>' : ''}
          <span style="color:var(--action-primary-blue);font-weight:600;"> ¬∑ ${esc(e.company)}</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px;margin-top:4px;">
          <span style="font-size:10px;font-weight:700;color:var(--text--dark--30);text-transform:uppercase;">${esc(e.user || 'Unknown')}</span>
          <span style="font-size:10px;color:var(--text--dark--20);">${time}</span>
        </div>
      </div>
    </div>`;
  });
  body.innerHTML = html;
}

function openActivityPanel() {
  document.getElementById('activityPanel').classList.add('open');
  document.getElementById('activityPanelOverlay').classList.add('open');
  document.getElementById('activityBtnDot').classList.remove('visible');
  renderActivityFeed();
}

function closeActivityPanel() {
  document.getElementById('activityPanel').classList.remove('open');
  document.getElementById('activityPanelOverlay').classList.remove('open');
}

function clearActivityLog() {
  if (!confirm('Clear all activity? This cannot be undone.')) return;
  saveActivityLog([]);
  renderActivityFeed();
  showToast('Activity log cleared', '');
}

// =============================================
// TRAINER MANAGEMENT MODAL
// =============================================
let _newTrainerPerms = { ...PERMISSION_PRESETS.editor };

function openTrainerModal() {
  USERS = getUsers();
  renderTrainerModalList();
  renderNewTrainerPerms();
  document.getElementById('trainerModalOverlay').classList.add('open');
}

function closeTrainerModal() {
  document.getElementById('trainerModalOverlay').classList.remove('open');
}

function renderTrainerModalList() {
  const list = document.getElementById('trainerModalList');
  if (!list) return;
  list.innerHTML = USERS.map(u => {
    const isProtected = u.name === 'Amy' || u.name === 'Max';
    const perms = u.permissions || {};
    const isAdmin = Object.keys(PERMISSION_PRESETS.admin).every(k => perms[k]);
    const isViewer = !perms['edit_status'];
    const badge = isAdmin ? 'üëë Admin' : isViewer ? 'üëÅ Viewer' : '‚úèÔ∏è Editor';
    return `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--card-light-grey);border-radius:4px;border:1px solid var(--ui--underline--light-grey);font-size:13px;font-weight:600;margin-bottom:6px;">
      <div style="display:flex;align-items:center;gap:8px;">
        <div style="width:28px;height:28px;border-radius:50%;background:var(--action-primary-blue);color:#fff;font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center;">${u.name[0].toUpperCase()}</div>
        <span>${esc(u.name)}</span>
        <span style="font-size:11px;font-weight:600;background:${isAdmin?'#fde8eb':isViewer?'#f0f0f0':'#e8f0ff'};color:${isAdmin?'#c0303d':isViewer?'#888':'#2147f4'};padding:2px 8px;border-radius:10px;">${badge}</span>
      </div>
      <div style="display:flex;gap:6px;">
        <button class="btn btn-ghost btn-sm" onclick="openEditPermModal('${esc(u.name)}')">‚úèÔ∏è Edit Perms</button>
        ${isProtected ? '' : `<button style="background:none;border:none;color:var(--text--dark--20);cursor:pointer;font-size:16px;padding:2px 6px;border-radius:4px;transition:color .12s;" onmouseover="this.style.color='#c0303d'" onmouseout="this.style.color='var(--text--dark--20)'" onclick="deleteTrainer('${esc(u.name)}')">‚úï</button>`}
      </div>
    </div>`;
  }).join('');
}

function applyPreset(preset) {
  _newTrainerPerms = preset === 'bookings' ? { ...BOOKINGS_ONLY_PRESET } : { ...(PERMISSION_PRESETS[preset] || PERMISSION_PRESETS.editor) };
  document.querySelectorAll('#presetBtns .perm-preset-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  renderNewTrainerPerms();
}

function renderNewTrainerPerms() {
  const container = document.getElementById('newTrainerPermissions');
  if (!container) return;
  container.innerHTML = renderPermissionToggles(_newTrainerPerms, 'newPerm');
}

function renderPermissionToggles(perms, prefix) {
  const groups = {};
  Object.entries(ALL_PERMISSIONS).forEach(([k, v]) => { (groups[v.group] = groups[v.group] || []).push([k, v]); });
  return Object.entries(groups).map(([group, items]) => `
    <div style="margin-bottom:12px;">
      <div style="font-size:10px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;color:var(--text--dark--30);margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid var(--ui--underline--light-grey);">${group}</div>
      ${items.map(([k, v]) => `
        <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:6px 0;gap:10px;border-bottom:1px solid #f3f4f6;">
          <div style="flex:1;"><div style="font-size:12px;font-weight:600;color:var(--text--dark--50);">${v.label}</div><div style="font-size:11px;color:var(--text--dark--30);margin-top:1px;">${v.desc}</div></div>
          <label class="perm-toggle" style="margin-top:2px;"><input type="checkbox" id="${prefix}_${k}" ${perms[k] ? 'checked' : ''} onchange="onPermToggle('${prefix}','${k}',this.checked)"><span class="perm-toggle-slider"></span></label>
        </div>`).join('')}
    </div>`).join('');
}

function onPermToggle(prefix, key, val) {
  if (prefix === 'newPerm') { _newTrainerPerms[key] = val; }
  else if (prefix === 'editPerm' && _editPermTarget) { _editPermTarget.permissions[key] = val; }
}

function addTrainer() {
  const input = document.getElementById('newTrainerInput');
  const name = (input.value || '').trim();
  if (!name) { showToast('Please enter a trainer name', 'error'); return; }
  USERS = getUsers();
  if (USERS.find(u => u.name.toLowerCase() === name.toLowerCase())) { showToast('A trainer with that name already exists', 'error'); return; }
  USERS.push({ name, permissions: { ..._newTrainerPerms } });
  saveUsers(USERS); syncTrainersFromUsers();
  input.value = '';
  renderTrainerModalList();
  populateTrainerFilter();
  renderTrainerWorkload();
  logActivity('trainer_added', name, 'Trainer added to system', '');
  showToast('‚úì ' + name + ' added', 'success');
}

function deleteTrainer(name) {
  USERS = getUsers();
  const active = allData.filter(r => r.trainer === name && !['Booked','Cancelled','Complete'].includes(r.status));
  if (active.length > 0) {
    _pendingDeleteTrainer = name;
    document.getElementById('reassignWarningText').textContent = name + ' has ' + active.length + ' active enquiry(s). Reassign them before removing.';
    const list = document.getElementById('reassignEnquiryList');
    list.innerHTML = active.map(r => `<div style="display:flex;align-items:center;gap:8px;padding:5px 0;border-bottom:1px solid var(--ui--underline--light-grey);font-size:12px;"><strong style="flex:1;">${esc(r.company)}</strong><span style="color:var(--text--dark--30);">${r.optionLabel}</span></div>`).join('');
    const sel = document.getElementById('reassignTargetSelect');
    sel.innerHTML = '<option value="">‚Äî Select trainer ‚Äî</option>' + USERS.filter(u => u.name !== name).map(u => `<option value="${esc(u.name)}">${esc(u.name)}</option>`).join('');
    document.getElementById('reassignModalOverlay').classList.add('open');
    return;
  }
  if (!confirm('Remove ' + name + ' from the trainer list?')) return;
  _doDeleteTrainer(name);
}

let _pendingDeleteTrainer = null;

function closeReassignModal() { document.getElementById('reassignModalOverlay').classList.remove('open'); _pendingDeleteTrainer = null; }

function confirmReassignAndDelete() {
  const target = document.getElementById('reassignTargetSelect').value;
  if (!target) { showToast('Select a trainer to reassign to', 'error'); return; }
  if (!_pendingDeleteTrainer) return;
  allData.forEach(r => { if (r.trainer === _pendingDeleteTrainer && !['Booked','Cancelled','Complete'].includes(r.status)) r.trainer = target; });
  closeReassignModal();
  _doDeleteTrainer(_pendingDeleteTrainer);
  processData();
}

function _doDeleteTrainer(name) {
  USERS = USERS.filter(u => u.name !== name);
  saveUsers(USERS); syncTrainersFromUsers();
  renderTrainerModalList();
  populateTrainerFilter();
  renderTrainerWorkload();
  logActivity('trainer_deleted', name, 'Trainer removed from system', '');
  showToast('‚úì ' + name + ' removed', 'success');
}

function syncTrainersFromUsers() { USERS = getUsers(); TRAINERS = USERS.map(u => u.name); }

// =============================================
// EDIT PERMISSIONS MODAL
// =============================================
let _editPermTarget = null;

function openEditPermModal(name) {
  USERS = getUsers();
  const user = USERS.find(u => u.name === name);
  if (!user) return;
  _editPermTarget = JSON.parse(JSON.stringify(user)); // deep copy
  document.getElementById('editPermName').textContent = name;
  document.getElementById('shadowBtnName').textContent = name;
  document.getElementById('editPermBody').innerHTML = renderPermissionToggles(_editPermTarget.permissions, 'editPerm');
  document.getElementById('editPermSaveBtn').onclick = () => saveEditPermissions(name);
  document.getElementById('editPermOverlay').classList.add('open');
  // Close trainer modal if open
  document.getElementById('trainerModalOverlay').classList.remove('open');
}

function closeEditPermModal() {
  document.getElementById('editPermOverlay').classList.remove('open');
  _editPermTarget = null;
}

function saveEditPermissions(name) {
  if (!_editPermTarget) return;
  USERS = getUsers();
  const idx = USERS.findIndex(u => u.name === name);
  if (idx >= 0) { USERS[idx].permissions = { ..._editPermTarget.permissions }; saveUsers(USERS); }
  const cur = getCurrentUser();
  if (cur && cur.name === name) { setCurrentUser(USERS[idx]); applyPermissions(); }
  closeEditPermModal();
  showToast('‚úì Permissions saved for ' + name, 'success');
  logActivity('status', name, 'Permissions updated', '');
  // Re-open trainer modal
  openTrainerModal();
}

// =============================================
// CALENDAR
// =============================================
let calCurrentMonth = new Date().getMonth();
let calCurrentYear  = new Date().getFullYear();
let calEvents = []; // google calendar events

const UK_BANK_HOLIDAYS = {
  '2024': ['2024-01-01','2024-03-29','2024-04-01','2024-05-06','2024-05-27','2024-08-26','2024-12-25','2024-12-26'],
  '2025': ['2025-01-01','2025-04-18','2025-04-21','2025-05-05','2025-05-26','2025-08-25','2025-12-25','2025-12-26'],
  '2026': ['2026-01-01','2026-04-03','2026-04-06','2026-05-04','2026-05-25','2026-08-31','2026-12-25','2026-12-26'],
  '2027': ['2027-01-01','2027-03-26','2027-03-29','2027-05-03','2027-05-31','2027-08-30','2027-12-27','2027-12-28'],
};

function isUKBankHoliday(dateStr) {
  const yr = dateStr.slice(0,4);
  const hols = UK_BANK_HOLIDAYS[yr] || [];
  return hols.includes(dateStr);
}

function isWorkday(date) {
  const dow = date.getDay(); // 0=Sun,6=Sat
  if (dow === 0 || dow === 6) return false;
  const ds = date.toISOString().slice(0,10);
  return !isUKBankHoliday(ds);
}

function addWorkdays(startDate, days) {
  const result = []; let d = new Date(startDate);
  while (result.length < days) {
    if (isWorkday(d)) result.push(new Date(d));
    d.setDate(d.getDate() + 1);
  }
  return result;
}

function getBlockedDatesForBooking(firstDay, numDays) {
  // Day before training (travel)
  const before = new Date(firstDay); before.setDate(before.getDate() - 1);
  // Training days
  const trainingDays = addWorkdays(firstDay, numDays);
  // Day after last training day (admin)
  const lastDay = trainingDays[trainingDays.length - 1];
  const after = new Date(lastDay); after.setDate(after.getDate() + 1);
  return { before, trainingDays, after };
}

function calChangeMonth(dir) {
  calCurrentMonth += dir;
  if (calCurrentMonth > 11) { calCurrentMonth = 0; calCurrentYear++; }
  if (calCurrentMonth < 0)  { calCurrentMonth = 11; calCurrentYear--; }
  renderCalendar();
}

function populateCalTrainerFilter() {
  const sel = document.getElementById('calFilterTrainer'); if (!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">All Trainers</option>' + TRAINERS.map(t => `<option value="${esc(t)}" ${cur===t?'selected':''}>${esc(t)}</option>`).join('');
}

function renderCalendar() {
  const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('calMonthTitle').textContent = MONTHS[calCurrentMonth] + ' ' + calCurrentYear;

  const filterTrainer = (document.getElementById('calFilterTrainer') || {}).value || '';
  const today = new Date(); today.setHours(0,0,0,0);

  // Build event map: dateStr ‚Üí [{type, label, trainer}]
  const eventMap = {};
  const addEv = (ds, ev) => { (eventMap[ds] = eventMap[ds] || []).push(ev); };

  // Bookings
  allData.forEach(r => {
    if (!r.bookedOn) return;
    if (r.status === 'Cancelled') return;
    if (filterTrainer && r.trainer !== filterTrainer) return;
    const ds = r.bookedOn.slice(0,10);
    const [y,m] = ds.split('-').map(Number);
    if (y !== calCurrentYear || m-1 !== calCurrentMonth) return;
    addEv(ds, { type:'booking', label: r.company.slice(0,18) + (r.trainer ? ' ¬∑ '+r.trainer : ''), trainer: r.trainer });

    // Blocked: day before (travel), day after last training day (admin)
    if (r.bookedOn) {
      const fd = new Date(ds);
      const numDays = OPTION_DAYS[r.option] || 1;
      const { before, after } = getBlockedDatesForBooking(fd, numDays);
      const bds = before.toISOString().slice(0,10);
      const ads = after.toISOString().slice(0,10);
      const [by,bm] = bds.split('-').map(Number);
      const [ay,am] = ads.split('-').map(Number);
      if (by === calCurrentYear && bm-1 === calCurrentMonth) addEv(bds, { type:'blocked', label:'Travel: ' + r.trainer });
      if (ay === calCurrentYear && am-1 === calCurrentMonth) addEv(ads, { type:'blocked', label:'Admin: ' + r.trainer });
    }
  });

  // Google Calendar events
  calEvents.forEach(e => {
    if (filterTrainer && e.trainer && e.trainer !== filterTrainer) return;
    const ds = e.start.slice(0,10);
    const [y,m] = ds.split('-').map(Number);
    if (y !== calCurrentYear || m-1 !== calCurrentMonth) return;
    addEv(ds, { type: e.blocked ? 'blocked' : 'gcal', label: e.title.slice(0,20) });
  });

  // Render grid
  const first = new Date(calCurrentYear, calCurrentMonth, 1);
  const startDow = (first.getDay() + 6) % 7; // Mon=0
  const daysInMonth = new Date(calCurrentYear, calCurrentMonth+1, 0).getDate();

  let html = '';
  for (let i = 0; i < startDow; i++) html += '<div class="cal-day cal-day-empty"></div>';
  for (let d = 1; d <= daysInMonth; d++) {
    const dt = new Date(calCurrentYear, calCurrentMonth, d);
    const ds = dt.toISOString().slice(0,10);
    const isToday = dt.getTime() === today.getTime();
    const isPast  = dt < today;
    const events  = eventMap[ds] || [];
    const classes = ['cal-day', isToday ? 'cal-day-today' : '', isPast ? 'cal-day-past' : ''].filter(Boolean).join(' ');
    const evHtml = events.slice(0,3).map(e => {
      const cls = e.type === 'blocked' ? 'cal-event cal-event-blocked' : e.type === 'gcal' ? 'cal-event cal-event-gcal' : 'cal-event cal-event-booking';
      return `<span class="${cls}" title="${esc(e.label)}">${esc(e.label)}</span>`;
    }).join('');
    const more = events.length > 3 ? `<span style="display:block;font-size:9px;color:var(--text--dark--30);padding:1px 4px;">+${events.length-3} more</span>` : '';
    html += `<div class="${classes}"><span class="cal-day-num">${d}</span>${evHtml}${more}</div>`;
  }
  document.getElementById('calDays').innerHTML = html;
}

function renderUpcoming() {
  const now = new Date(); now.setHours(0,0,0,0);
  const filterTrainer = (document.getElementById('calFilterTrainer') || {}).value || '';
  const upcoming = allData
    .filter(r => r.bookedOn && !['Cancelled'].includes(r.status) && (!filterTrainer || r.trainer === filterTrainer))
    .map(r => ({ ...r, _d: new Date(r.bookedOn) }))
    .filter(r => r._d >= now)
    .sort((a,b) => a._d - b._d)
    .slice(0, 20);
  document.getElementById('calUpcomingCount').textContent = upcoming.length + ' upcoming';
  const body = document.getElementById('calUpcomingBody');
  if (!body) return;
  if (!upcoming.length) { body.innerHTML = '<div style="padding:32px 20px;text-align:center;color:var(--text--dark--30);font-size:12px;">No upcoming booked sessions</div>'; return; }
  const MONTHS_S = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  body.innerHTML = upcoming.map(r => {
    const d = r._d;
    return `<div class="cal-upcoming-item">
      <div class="cal-upcoming-date"><div style="font-size:16px;font-weight:700;color:var(--text--dark--50);line-height:1;">${d.getDate()}</div><div style="font-size:9px;font-weight:600;color:var(--text--dark--30);text-transform:uppercase;">${MONTHS_S[d.getMonth()]}</div></div>
      <div style="flex:1;min-width:0;">
        <div style="font-size:12px;font-weight:600;color:var(--text--dark--50);">${esc(r.company)}</div>
        <div style="font-size:11px;color:var(--text--dark--30);margin-top:2px;">${r.optionLabel}${r.trainer ? ' ¬∑ ' + esc(r.trainer) : ''}</div>
      </div>
    </div>`;
  }).join('');
}

async function loadCalendarData(force) {
  const settings = getCalSettings();
  if (!settings.calendarId) { updateCalStatus(false); return; }
  const cacheKey = 'streetCalCache';
  const cached = !force && (() => { try { return JSON.parse(sessionStorage.getItem(cacheKey) || 'null'); } catch(e) { return null; } })();
  if (cached && cached.ts && Date.now() - cached.ts < 5 * 60 * 1000) { calEvents = cached.events || []; updateCalStatus(true); renderCalendar(); renderUpcoming(); return; }
  try {
    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth()-1, 1).toISOString().slice(0,10);
    const end   = new Date(now.getFullYear(), now.getMonth()+3, 0).toISOString().slice(0,10);
    const url = APPS_SCRIPT_URL + '?action=getCalendarEvents&calendarId=' + encodeURIComponent(settings.calendarId) + '&start=' + start + '&end=' + end;
    const res = await fetch(url);
    const json = await res.json();
    if (json.success && json.events) {
      calEvents = json.events;
      try { sessionStorage.setItem(cacheKey, JSON.stringify({ events: calEvents, ts: Date.now() })); } catch(e) {}
      updateCalStatus(true);
    } else { updateCalStatus(false, json.error || 'Calendar error'); }
  } catch(e) { updateCalStatus(false, e.message); }
  renderCalendar(); renderUpcoming();
}

function updateCalStatus(connected, err) {
  const dot = document.getElementById('calGcalDot');
  const txt = document.getElementById('calGcalStatus');
  if (!dot || !txt) return;
  if (connected) {
    dot.style.background = '#4caf50';
    txt.innerHTML = '<span id="calGcalDot" style="display:inline-block;width:7px;height:7px;border-radius:50%;background:#4caf50;margin-right:4px;vertical-align:middle;"></span>Google Calendar connected';
  } else {
    dot.style.background = err ? '#e53935' : '#ccc';
    txt.innerHTML = '<span id="calGcalDot" style="display:inline-block;width:7px;height:7px;border-radius:50%;background:'+(err?'#e53935':'#ccc')+';margin-right:4px;vertical-align:middle;"></span>' + (err || 'Calendar not connected');
  }
}

function getCalSettings() { try { return JSON.parse(localStorage.getItem(CAL_KEY) || '{}'); } catch(e) { return {}; } }
function saveCalSettings_() { localStorage.setItem(CAL_KEY, JSON.stringify(_calSettings)); }

function openCalSettings() {
  const s = getCalSettings();
  document.getElementById('calIdInput').value = s.calendarId || '';
  document.getElementById('calSettingsOverlay').classList.add('open');
}

function closeCalSettings() { document.getElementById('calSettingsOverlay').classList.remove('open'); }

function saveCalSettings() {
  const calId = document.getElementById('calIdInput').value.trim();
  const s = getCalSettings();
  s.calendarId = calId;
  try { localStorage.setItem(CAL_KEY, JSON.stringify(s)); } catch(e) {}
  document.getElementById('calSettingsStatus').textContent = '‚úì Saved';
  closeCalSettings();
  if (calId) loadCalendarData(true);
  showToast('Calendar settings saved', 'success');
}

// =============================================
// KPI DETAIL MODALS
// =============================================
function openKpiModal(type) {
  const now = new Date(), year = now.getFullYear(), month = now.getMonth();
  const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  let title, subtitle, headline, stats, rows, headCols;

  const thisYearBooked = allData.filter(r => { const d = kpiDate(r); return d && d.getFullYear()===year && r.status==='Booked' && r.option!=='1'; });
  const thisMonthBooked = thisYearBooked.filter(r => { const d = kpiDate(r); return d && d.getMonth()===month; });

  if (type === 'revYear') {
    const total = thisYearBooked.reduce((s,r) => s+r.revenue, 0);
    const byMonthArr = Array(12).fill(0); thisYearBooked.forEach(r => { const d = kpiDate(r); if (d) byMonthArr[d.getMonth()] += r.revenue; });
    title = 'Total Revenue This Year'; subtitle = year + ' ¬∑ Booked only ¬∑ exc. VAT';
    headline = '¬£' + total.toLocaleString();
    stats = byMonthArr.map((v,i) => v > 0 ? `<div style="display:flex;flex-direction:column;gap:2px;"><div style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.6px;color:var(--text--dark--30);">${MONTHS[i]}</div><div style="font-size:15px;font-weight:700;color:var(--text--dark--50);">¬£${v.toLocaleString()}</div></div>` : '').filter(Boolean).join('');
    headCols = ['Date','Company','Option','Trainer','Value','Status'];
    rows = thisYearBooked.sort((a,b) => (kpiDate(b)||0)-(kpiDate(a)||0)).map(r =>
      `<tr><td>${formatDate(kpiDate(r))}</td><td><strong>${esc(r.company)}</strong></td><td><span class="option-badge opt-${r.option}">Opt ${r.option}</span></td><td>${esc(r.trainer||'‚Äî')}</td><td class="col-money">¬£${r.revenue.toLocaleString()}</td><td><span class="status-badge status-${r.status.toLowerCase()}">${r.status}</span></td></tr>`);
  } else if (type === 'revMonth') {
    const total = thisMonthBooked.reduce((s,r) => s+r.revenue, 0);
    title = 'Revenue This Month'; subtitle = MONTHS[month] + ' ' + year + ' ¬∑ Booked only ¬∑ exc. VAT';
    headline = '¬£' + total.toLocaleString();
    stats = `<div style="display:flex;flex-direction:column;gap:2px;"><div style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.6px;color:var(--text--dark--30);">Bookings</div><div style="font-size:15px;font-weight:700;color:var(--text--dark--50);">${thisMonthBooked.length}</div></div>`;
    headCols = ['Date','Company','Option','Trainer','Value'];
    rows = thisMonthBooked.sort((a,b) => (kpiDate(b)||0)-(kpiDate(a)||0)).map(r =>
      `<tr><td>${formatDate(kpiDate(r))}</td><td><strong>${esc(r.company)}</strong></td><td><span class="option-badge opt-${r.option}">Opt ${r.option}</span></td><td>${esc(r.trainer||'‚Äî')}</td><td class="col-money">¬£${r.revenue.toLocaleString()}</td></tr>`);
  } else if (type === 'avgFee') {
    const withRev = thisYearBooked.filter(r => r.revenue > 0);
    const avg = withRev.length ? Math.round(withRev.reduce((s,r) => s+r.revenue,0)/withRev.length) : 0;
    title = 'Average Training Fee'; subtitle = year + ' ¬∑ Booked with value recorded';
    headline = avg ? '¬£' + avg.toLocaleString() : '‚Äî';
    stats = `<div style="display:flex;flex-direction:column;gap:2px;"><div style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.6px;color:var(--text--dark--30);">Bookings with value</div><div style="font-size:15px;font-weight:700;color:var(--text--dark--50);">${withRev.length}</div></div>`;
    headCols = ['Date','Company','Option','Trainer','Value'];
    rows = withRev.sort((a,b) => b.revenue-a.revenue).map(r =>
      `<tr><td>${formatDate(kpiDate(r))}</td><td><strong>${esc(r.company)}</strong></td><td><span class="option-badge opt-${r.option}">Opt ${r.option}</span></td><td>${esc(r.trainer||'‚Äî')}</td><td class="col-money">¬£${r.revenue.toLocaleString()}</td></tr>`);
  } else if (type === 'days') {
    const days = thisYearBooked.reduce((s,r) => s+(OPTION_DAYS[r.option]||0),0);
    const daysMonth = thisMonthBooked.reduce((s,r) => s+(OPTION_DAYS[r.option]||0),0);
    title = 'Training Days This Year'; subtitle = year + ' ¬∑ Booked sessions only';
    headline = days + ' days';
    stats = `<div style="display:flex;flex-direction:column;gap:2px;"><div style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.6px;color:var(--text--dark--30);">This Month</div><div style="font-size:15px;font-weight:700;color:var(--text--dark--50);">${daysMonth}</div></div>`;
    headCols = ['Date','Company','Option','Trainer','Days'];
    rows = thisYearBooked.sort((a,b) => (kpiDate(b)||0)-(kpiDate(a)||0)).map(r =>
      `<tr><td>${formatDate(kpiDate(r))}</td><td><strong>${esc(r.company)}</strong></td><td><span class="option-badge opt-${r.option}">Opt ${r.option}</span></td><td>${esc(r.trainer||'‚Äî')}</td><td class="col-highlight">${OPTION_DAYS[r.option]||0}</td></tr>`);
  } else if (type === 'bookings') {
    title = 'Total Bookings This Year'; subtitle = year + ' ¬∑ Booked only';
    headline = thisYearBooked.length + ' bookings';
    const byTrainer = {}; TRAINERS.forEach(t => { byTrainer[t] = 0; }); thisYearBooked.forEach(r => { if (r.trainer) byTrainer[r.trainer] = (byTrainer[r.trainer]||0)+1; });
    stats = Object.entries(byTrainer).filter(([,v])=>v>0).map(([t,v]) => `<div style="display:flex;flex-direction:column;gap:2px;"><div style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.6px;color:var(--text--dark--30);">${esc(t)}</div><div style="font-size:15px;font-weight:700;color:var(--text--dark--50);">${v}</div></div>`).join('');
    headCols = ['Date','Company','Option','Trainer','Value','Status'];
    rows = thisYearBooked.sort((a,b) => (kpiDate(b)||0)-(kpiDate(a)||0)).map(r =>
      `<tr><td>${formatDate(kpiDate(r))}</td><td><strong>${esc(r.company)}</strong></td><td><span class="option-badge opt-${r.option}">Opt ${r.option}</span></td><td>${esc(r.trainer||'‚Äî')}</td><td class="col-money">¬£${r.revenue.toLocaleString()}</td><td><span class="status-badge status-${r.status.toLowerCase()}">${r.status}</span></td></tr>`);
  }

  document.getElementById('kpiModalTitle').textContent = title;
  document.getElementById('kpiModalSubtitle').textContent = subtitle;
  document.getElementById('kpiModalHeadline').textContent = headline;
  document.getElementById('kpiModalStats').innerHTML = stats;
  document.getElementById('kpiModalTableHead').innerHTML = '<tr>' + headCols.map(c => `<th style="padding:9px 14px;text-align:left;font-size:10px;letter-spacing:.6px;text-transform:uppercase;color:var(--text--dark--30);border-bottom:2px solid var(--ui--underline--light-grey);white-space:nowrap;">${c}</th>`).join('') + '</tr>';
  document.getElementById('kpiModalTableBody').innerHTML = (rows||[]).join('');
  document.getElementById('kpiModalOverlay').classList.add('open');
}

function closeKpiModal() { document.getElementById('kpiModalOverlay').classList.remove('open'); }

// =============================================
// BOOKED DATE MODAL
// =============================================
let _bdRowIndex = null;
let _bdNumDays = 1;

function openBookedDateModal(rowIndex) {
  if (!hasPerm('edit_booked_date')) { showToast('You do not have permission to edit booked dates', 'error'); return; }
  const row = allData.find(r => r.rowIndex === rowIndex); if (!row) return;
  _bdRowIndex = rowIndex; _bdNumDays = OPTION_DAYS[row.option] || 1;
  document.getElementById('bdModalCompany').textContent = row.company;
  document.getElementById('bdModalDateInput').value = row.bookedOn ? formatDateInput(row.bookedOn) : '';
  document.getElementById('bdModalValueInput').value = row.revenue || '';
  document.getElementById('bdModalError').style.display = 'none';
  // Set days buttons
  document.querySelectorAll('#bdModalDaysBtns .bd-days-btn').forEach(b => { b.className = 'bd-days-btn' + (parseInt(b.textContent) === _bdNumDays ? ' active' : ''); });
  bdUpdateSummary();
  document.getElementById('bookedDateModal').classList.add('open');
}

function cancelBookedDateModal() { document.getElementById('bookedDateModal').classList.remove('open'); _bdRowIndex = null; }

function bdSelectDays(n) {
  _bdNumDays = n;
  document.querySelectorAll('#bdModalDaysBtns .bd-days-btn').forEach(b => { b.className = 'bd-days-btn' + (parseInt(b.textContent) === n ? ' active' : ''); });
  bdUpdateSummary();
}

function bdUpdateSummary() {
  const dateVal = document.getElementById('bdModalDateInput').value;
  const sumEl = document.getElementById('bdModalSummary');
  if (!dateVal) { sumEl.style.display = 'none'; return; }
  const first = new Date(dateVal);
  if (isNaN(first.getTime())) { sumEl.style.display = 'none'; return; }
  const { before, trainingDays, after } = getBlockedDatesForBooking(first, _bdNumDays);
  const fmt = d => d.toLocaleDateString('en-GB', { weekday:'short', day:'numeric', month:'short' });
  let html = `<strong>Training:</strong> ${trainingDays.map(fmt).join(', ')}<br>`;
  html += `<strong>Travel blocked:</strong> ${fmt(before)}<br>`;
  html += `<strong>Admin blocked:</strong> ${fmt(after)}`;
  sumEl.innerHTML = html; sumEl.style.display = 'block';
}

async function confirmBookedDateModal() {
  const dateVal = document.getElementById('bdModalDateInput').value;
  const errEl = document.getElementById('bdModalError');
  if (!dateVal) { errEl.textContent = 'Please select a date'; errEl.style.display = 'block'; return; }
  const valueInp = document.getElementById('bdModalValueInput');
  const newValue = parseFloat(valueInp.value) || 0;
  const row = allData.find(r => r.rowIndex === _bdRowIndex); if (!row) return;
  row.bookedOn = dateVal; row.status = 'Booked';
  if (newValue) row.revenue = newValue;
  saveOverride(_bdRowIndex, { bookedOn: dateVal, status: 'Booked', revenue: newValue || row.revenue });
  let url = APPS_SCRIPT_URL + '?action=assign&row=' + _bdRowIndex + '&status=Booked&bookedOn=' + encodeURIComponent(dateVal);
  if (newValue) url += '&value=' + newValue;
  try { await fetch(url, { method:'GET', redirect:'follow', mode:'no-cors' }); } catch(e) {}
  logActivity('date', row.company, 'Booked date confirmed', dateVal + ' (' + _bdNumDays + ' day' + (_bdNumDays>1?'s':'') + ')');
  if (newValue) logActivity('value', row.company, 'Invoice value confirmed', '¬£' + newValue.toLocaleString());
  cancelBookedDateModal();
  processData();
  showToast('‚úì Booking confirmed: ' + row.company, 'success');
}

// =============================================
// SECTION SCROLL
// =============================================
function scrollToSection(id) {
  const el = document.getElementById(id);
  if (el) { el.scrollIntoView({ behavior:'smooth', block:'start' }); closeNav(); }
}

function updateTrainerAvailability() { /* placeholder for future calendar cross-check */ }

// =============================================
// INIT
// =============================================
loadData();
setInterval(loadData, 5 * 60 * 1000);

// Show login screen on startup
window.addEventListener('DOMContentLoaded', () => {
  const cur = getCurrentUser();
  if (!cur) {
    renderLoginScreen();
  } else {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('pinScreen').classList.add('hidden');
    applyPermissions();
  }
  renderActivityFeed();
  loadCalendarData(false);
});
</script>
</body>
</html>
