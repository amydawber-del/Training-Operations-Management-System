<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Street Training Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root {
  --text--dark--50: #19191e;
  --brand--black: #242326;
  --text--dark--40: #4c4d57;
  --text--dark--30: #777989;
  --card-light-grey: #f8f8f8;
  --text--light--40: #b2b2b2;
  --accent--blue--300: #527dff;
  --text--dark--20: #a8aabb;
  --action-primary-blue: #2147f4;
  --light-grey: #ccc;
  --text-dark-10: #dfe0ec;
  --ui--underline--light-grey: #e5e5e5;
  --success-green: #bde4b9;
  --brand--yellow: #f1c238;
  --brand-accent--mandarin-light: #f6be9d;
  --accent-blue--100: #a3baff;
  --brand-accent--dusty-red-light: #f9b4bc;
  --brand--secondary--lightgreen: #beffd8;
  --accent-blue--50: #b8caff;
  --white-smoke: #fde8eb;
  --brand-accent--cream: #f5ede5;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: Arial, "Helvetica Neue", Helvetica, sans-serif; font-size: 14px; line-height: 20px; color: #333; background: #fff; min-height: 100vh; }

/* HEADER */
.header { background: var(--brand--black); color: #fff; height: 52px; display: flex; align-items: center; padding: 0 24px; gap: 16px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #3a3a3a; }
.hamburger-btn { background: none; border: none; cursor: pointer; padding: 6px; display: flex; flex-direction: column; gap: 4px; border-radius: 4px; transition: background 0.15s; }
.hamburger-btn:hover { background: rgba(255,255,255,0.1); }
.hamburger-btn span { display: block; width: 18px; height: 2px; background: #fff; border-radius: 1px; transition: all 0.2s; }
.hamburger-btn.open span:nth-child(1) { transform: rotate(45deg) translate(4px,4px); }
.hamburger-btn.open span:nth-child(2) { opacity: 0; }
.hamburger-btn.open span:nth-child(3) { transform: rotate(-45deg) translate(4px,-4px); }
.street-logo-mark { font-size: 15px; font-weight: 700; letter-spacing: -0.5px; color: #fff; font-family: Arial, sans-serif; line-height: 1; }
.street-logo-mark .logo-dot { color: var(--brand--yellow); }
.header-title { font-size: 15px; font-weight: 600; color: #fff; letter-spacing: -0.2px; flex: 1; }
.header-right { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
.last-updated { font-size: 11px; color: var(--text--light--40); }
.refresh-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15); color: #fff; padding: 5px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; transition: background 0.15s; font-family: Arial, sans-serif; }
.refresh-btn:hover { background: rgba(255,255,255,0.2); }
.user-selector-wrap { display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 20px; padding: 3px 10px 3px 6px; }
.user-avatar { width: 24px; height: 24px; border-radius: 50%; background: var(--action-primary-blue); color: #fff; font-size: 10px; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.user-select { background: none; border: none; color: #ddd; font-size: 12px; font-weight: 600; font-family: Arial, sans-serif; cursor: pointer; outline: none; padding: 0 2px; }
.user-select option { background: #333; color: #fff; }
.admin-badge { font-size: 9px; font-weight: 700; background: var(--brand--yellow); color: #333; padding: 1px 5px; border-radius: 3px; }

/* NAV */
.nav-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
.nav-overlay.open { opacity: 1; pointer-events: all; }
.nav-drawer { position: fixed; top: 0; left: -280px; width: 260px; height: 100vh; background: var(--brand--black); z-index: 201; transition: left 0.22s ease; display: flex; flex-direction: column; box-shadow: 2px 0 8px rgba(0,0,0,0.3); overflow-y: auto; }
.nav-drawer.open { left: 0; }
.nav-drawer-header { padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: space-between; height: 52px; flex-shrink: 0; }
.nav-drawer-title { font-size: 12px; font-weight: 600; color: var(--text--light--40); letter-spacing: 1px; text-transform: uppercase; }
.nav-close { background: none; border: none; color: var(--text--light--40); cursor: pointer; font-size: 18px; line-height: 1; padding: 2px 6px; border-radius: 4px; }
.nav-close:hover { color: #fff; }
.nav-section-label { font-size: 10px; font-weight: 600; letter-spacing: 1.2px; text-transform: uppercase; color: var(--text--dark--30); padding: 16px 20px 8px; }
.nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 20px; color: #ccc; text-decoration: none; font-size: 13px; transition: background 0.12s,color 0.12s; border-left: 3px solid transparent; cursor: pointer; }
.nav-item:hover { background: rgba(255,255,255,0.06); color: #fff; border-left-color: var(--accent--blue--300); }
.nav-item-icon { font-size: 15px; width: 20px; text-align: center; }
.nav-divider { height: 1px; background: rgba(255,255,255,0.08); margin: 8px 20px; }

/* LOADING */
.loading-bar { height: 3px; background: linear-gradient(90deg,var(--action-primary-blue),var(--accent--blue--300)); animation: loading 1.2s ease infinite; display: none; }
.loading-bar.active { display: block; }
@keyframes loading { 0%{transform:translateX(-100%)} 100%{transform:translateX(200%)} }

/* MAIN */
.main { padding: 24px; max-width: 1400px; margin: 0 auto; }
.section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; flex-wrap: wrap; gap: 8px; }
.section-title { font-size: 15px; font-weight: 600; color: var(--text--dark--50); display: flex; align-items: center; gap: 8px; }
.section-title .badge { background: var(--brand-accent--dusty-red-light); color: #c0303d; font-size: 11px; font-weight: 700; padding: 1px 7px; border-radius: 10px; min-width: 20px; text-align: center; }
.section-title .badge.green { background: var(--success-green); color: #2a7a26; }
.section-title .badge.orange { background: var(--brand-accent--mandarin-light); color: #a04010; }

/* PANELS & TABLE */
.requests-panel { border: 1px solid var(--ui--underline--light-grey); border-radius: 4px; margin-bottom: 24px; overflow: hidden; }
.requests-panel-header { background: var(--card-light-grey); padding: 12px 16px; border-bottom: 1px solid var(--ui--underline--light-grey); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px; }
.alert-dot { width: 8px; height: 8px; border-radius: 50%; background: #e53935; animation: pulse-dot 1.5s ease infinite; }
@keyframes pulse-dot { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.5;transform:scale(0.8)} }
.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: 13px; }
thead tr { background: var(--card-light-grey); }
th { padding: 10px 14px; text-align: left; font-weight: 600; font-size: 11px; letter-spacing: 0.5px; text-transform: uppercase; color: var(--text--dark--30); border-bottom: 1px solid var(--ui--underline--light-grey); white-space: nowrap; }
td { padding: 10px 14px; border-bottom: 1px solid var(--ui--underline--light-grey); color: var(--text--dark--40); vertical-align: middle; }
tr:last-child td { border-bottom: none; }
tr:hover td { background: #fafafa; }

/* STALE ROW */
.row-stale { background: #fffbf0 !important; }
.row-stale td { background: #fffbf0 !important; }
.stale-badge { display: inline-flex; align-items: center; gap: 3px; font-size: 10px; font-weight: 600; background: #fef3c7; color: #92400e; padding: 1px 6px; border-radius: 4px; border: 1px solid #fde68a; white-space: nowrap; }

/* BADGES */
.option-badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; white-space: nowrap; }
.opt-1 { background: var(--accent-blue--50); color: #2147f4; }
.opt-2 { background: var(--brand-accent--cream); color: #8a5a2a; }
.opt-3 { background: var(--brand-accent--mandarin-light); color: #a04010; }
.opt-4 { background: var(--success-green); color: #2a7a26; }
.opt-5 { background: var(--brand--secondary--lightgreen); color: #1a6a40; }
.status-badge { padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
.status-unassigned { background: var(--white-smoke); color: #c0303d; }
.status-pending { background: var(--brand--secondary--lightgreen); color: #1a6a40; }
.status-booked { background: var(--accent-blue--50); color: #2147f4; }
.status-cancelled { background: #f0f0f0; color: #999; text-decoration: line-through; }
.trainer-pill { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }

/* BUTTONS */
.btn { padding: 5px 12px; border-radius: 4px; font-size: 12px; font-family: Arial, sans-serif; cursor: pointer; border: none; font-weight: 600; transition: background 0.15s; display: inline-flex; align-items: center; gap: 4px; }
.btn-primary { background: var(--action-primary-blue); color: #fff; }
.btn-primary:hover { background: #1a39d4; }
.btn-primary:disabled { background: var(--text--dark--20); cursor: not-allowed; }
.btn-sm { padding: 4px 10px; font-size: 11px; }
.btn-ghost { background: none; border: 1px solid var(--light-grey); color: var(--text--dark--30); }
.btn-ghost:hover { background: var(--card-light-grey); color: #333; }
.btn-danger { background: #c0303d; color: #fff; }
.btn-danger:hover { background: #a02030; }
.btn-success { background: #22a06b; color: #fff; }
.btn-success:hover { background: #1a8055; }
.btn-warning { background: #f59e0b; color: #fff; }
.btn-warning:hover { background: #d97706; }

/* KPI */
.kpi-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap: 16px; margin-bottom: 24px; }
.kpi-card { border: 1px solid var(--ui--underline--light-grey); border-radius: 4px; padding: 16px 20px; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
.kpi-card.clickable { cursor: pointer; transition: box-shadow 0.15s; }
.kpi-card.clickable:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.08); }
.kpi-card-label { font-size: 11px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; color: var(--text--dark--30); margin-bottom: 8px; }
.kpi-card-value { font-size: 28px; font-weight: 700; color: var(--text--dark--50); line-height: 1.1; letter-spacing: -0.5px; }
.kpi-card-sub { font-size: 11px; color: var(--text--dark--30); margin-top: 4px; }
.kpi-card-delta { display: inline-flex; align-items: center; gap: 3px; font-size: 11px; font-weight: 600; padding: 1px 6px; border-radius: 4px; margin-top: 6px; }
.delta-up { background: var(--success-green); color: #2a7a26; }
.delta-down { background: var(--white-smoke); color: #c0303d; }
.kpi-accent-left { border-left: 3px solid var(--action-primary-blue); padding-left: 14px; }
.kpi-accent-yellow { border-left-color: var(--brand--yellow); }
.kpi-accent-green { border-left-color: #4caf50; }
.kpi-accent-orange { border-left-color: #ff7043; }

/* CHARTS */
.charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; margin-bottom: 24px; }
@media (max-width: 900px) { .charts-grid { grid-template-columns: 1fr; } }
.chart-card { border: 1px solid var(--ui--underline--light-grey); border-radius: 4px; padding: 20px; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
.chart-title { font-size: 13px; font-weight: 600; color: var(--text--dark--50); margin-bottom: 4px; }
.chart-subtitle { font-size: 11px; color: var(--text--dark--30); margin-bottom: 16px; }
.compare-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
.compare-card { background: var(--card-light-grey); border-radius: 4px; padding: 12px 14px; text-align: center; }
.compare-card-label { font-size: 10px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; color: var(--text--dark--30); margin-bottom: 4px; }
.compare-card-value { font-size: 22px; font-weight: 700; color: var(--text--dark--50); }

/* TRAINER WORKLOAD */
.trainer-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); gap: 12px; margin-bottom: 24px; }
.trainer-card { border: 1px solid var(--ui--underline--light-grey); border-radius: 4px; padding: 14px 16px; background: #fff; }
.trainer-name { font-size: 13px; font-weight: 600; color: var(--text--dark--50); margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
.trainer-color-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.trainer-stat { display: flex; justify-content: space-between; font-size: 11px; color: var(--text--dark--30); margin-bottom: 4px; }
.trainer-stat-val { font-weight: 600; color: var(--text--dark--40); }
.workload-bar-wrap { height: 4px; background: var(--ui--underline--light-grey); border-radius: 2px; margin-top: 8px; overflow: hidden; }
.workload-bar { height: 100%; border-radius: 2px; transition: width 0.4s ease; }
.next-free-tag { margin-top: 8px; padding: 5px 8px; background: #f0fdf4; border-radius: 5px; border: 1px solid #bbf7d0; font-size: 11px; color: #1a6a40; font-weight: 600; }
.next-free-tag.busy { background: #fde8eb; border-color: #fecaca; color: #c0303d; }

/* CALENDAR */
.cal-grid { display: grid; grid-template-columns: 1fr 280px; gap: 16px; margin-bottom: 24px; }
@media (max-width: 900px) { .cal-grid { grid-template-columns: 1fr; } }
.cal-month-card { background: #fff; border: 1px solid var(--ui--underline--light-grey); border-radius: 8px; overflow: hidden; }
.cal-month-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: var(--text--dark--50); color: #fff; gap: 8px; flex-wrap: wrap; }
.cal-month-title { font-size: 14px; font-weight: 700; }
.cal-nav-btn { background: rgba(255,255,255,0.12); border: none; color: #fff; cursor: pointer; padding: 4px 10px; border-radius: 4px; font-size: 14px; font-family: Arial, sans-serif; transition: background 0.12s; }
.cal-nav-btn:hover { background: rgba(255,255,255,0.22); }
.cal-filter-row { display: flex; align-items: center; gap: 8px; padding: 8px 14px; background: var(--card-light-grey); border-bottom: 1px solid var(--ui--underline--light-grey); flex-wrap: wrap; }
.cal-legend-item { display: flex; align-items: center; gap: 4px; }
.cal-legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.cal-legend-label { font-size: 10px; color: var(--text--dark--40); }
.cal-dow-row { display: flex; width: 100%; background: var(--card-light-grey); border-bottom: 1px solid var(--ui--underline--light-grey); }
.cal-dow { flex: 0 0 calc(100%/7); text-align: center; font-size: 10px; font-weight: 700; color: var(--text--dark--30); padding: 6px 0; letter-spacing: 0.5px; text-transform: uppercase; }
.cal-days { display: flex; flex-wrap: wrap; width: 100%; border-top: 1px solid #f3f4f6; border-left: 1px solid #f3f4f6; }
.cal-day { flex: 0 0 calc(100%/7); min-height: 80px; padding: 4px 3px 3px; border-right: 1px solid #f3f4f6; border-bottom: 1px solid #f3f4f6; overflow: hidden; transition: background 0.1s; }
.cal-day:hover:not(.cal-day-empty) { background: #f6f8ff; cursor: pointer; }
.cal-day-empty { background: #fafafa; }
.cal-day-weekend { background: #fafbff; }
.cal-day-today .cal-day-num { background: var(--action-primary-blue); color: #fff; width: 20px; height: 20px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 10px; }
.cal-day-holiday { background: #fffbf0; }
.cal-day-num { font-size: 11px; font-weight: 600; color: var(--text--dark--30); display: block; margin-bottom: 2px; line-height: 1; }
.cal-day-past { opacity: 0.55; }
.cal-event { display: block; font-size: 9px; font-weight: 600; padding: 2px 5px; border-radius: 3px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; max-width: 100%; }
.cal-event-travel { background: #fef3c7; color: #92400e; }
.cal-event-training { color: #fff; }
.cal-event-admin { background: #e0e7ff; color: #3730a3; }
.cal-event-more { display: block; font-size: 9px; color: var(--text--dark--30); padding: 1px 4px; cursor: pointer; }

.cal-upcoming-card { background: #fff; border: 1px solid var(--ui--underline--light-grey); border-radius: 8px; overflow: hidden; max-height: 520px; display: flex; flex-direction: column; }
.cal-upcoming-header { padding: 12px 16px; background: var(--card-light-grey); border-bottom: 1px solid var(--ui--underline--light-grey); font-size: 12px; font-weight: 700; color: var(--text--dark--40); display: flex; align-items: center; justify-content: space-between; }
.cal-upcoming-body { flex: 1; overflow-y: auto; }
.cal-upcoming-item { padding: 10px 14px; border-bottom: 1px solid #f3f4f6; display: flex; gap: 10px; align-items: flex-start; }
.cal-upcoming-item:last-child { border-bottom: none; }
.cal-upcoming-date { min-width: 38px; text-align: center; background: var(--card-light-grey); border-radius: 6px; padding: 4px 6px; flex-shrink: 0; }
.cal-upcoming-date-day { font-size: 16px; font-weight: 700; color: var(--text--dark--50); line-height: 1; }
.cal-upcoming-date-mon { font-size: 9px; font-weight: 600; color: var(--text--dark--30); text-transform: uppercase; letter-spacing: 0.5px; }
.cal-upcoming-body-text { flex: 1; min-width: 0; }
.cal-upcoming-company { font-size: 12px; font-weight: 600; color: var(--text--dark--50); }
.cal-upcoming-meta { font-size: 11px; color: var(--text--dark--30); margin-top: 2px; }
.cal-upcoming-empty { padding: 32px 20px; text-align: center; color: var(--text--dark--30); font-size: 12px; }

/* ALL BOOKINGS */
.all-bookings { border: 1px solid var(--ui--underline--light-grey); border-radius: 4px; margin-bottom: 24px; overflow: hidden; }
.filter-bar { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
select.filter-select, input.filter-input { border: 1px solid var(--light-grey); border-radius: 4px; padding: 5px 10px; font-size: 12px; font-family: Arial, sans-serif; color: #333; background: #fff; }
select.filter-select:focus, input.filter-input:focus { outline: none; border-color: var(--action-primary-blue); }
.pagination { display: flex; align-items: center; gap: 8px; padding: 12px 16px; border-top: 1px solid var(--ui--underline--light-grey); background: var(--card-light-grey); font-size: 12px; color: var(--text--dark--30); }
.page-btn { background: #fff; border: 1px solid var(--light-grey); border-radius: 4px; padding: 3px 10px; font-size: 12px; cursor: pointer; font-family: Arial, sans-serif; transition: background 0.12s; }
.page-btn:hover:not(:disabled) { background: var(--card-light-grey); }
.page-btn:disabled { opacity: 0.4; cursor: not-allowed; }
.empty-state { text-align: center; padding: 40px 20px; color: var(--text--dark--30); }
.empty-state-icon { font-size: 32px; margin-bottom: 8px; }
.empty-state-text { font-size: 13px; }

/* TOAST */
.toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 999; display: flex; flex-direction: column; gap: 8px; }
.toast { background: var(--brand--black); color: #fff; padding: 10px 16px; border-radius: 4px; font-size: 13px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); animation: slideIn 0.2s ease; border-left: 3px solid var(--action-primary-blue); }
.toast.success { border-left-color: #4caf50; }
.toast.error { border-left-color: #e53935; }
.toast.warning { border-left-color: #f59e0b; }
@keyframes slideIn { from{transform:translateX(20px);opacity:0} to{transform:none;opacity:1} }

/* SPINNER */
.spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid var(--text-dark-10); border-top-color: var(--action-primary-blue); border-radius: 50%; animation: spin 0.6s linear infinite; }
@keyframes spin { to{transform:rotate(360deg)} }

/* MODAL OVERLAYS */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.55); z-index: 400; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
.modal-overlay.open { opacity: 1; pointer-events: all; }
.modal { background: #fff; border-radius: 10px; width: 480px; max-width: 96vw; box-shadow: 0 12px 48px rgba(0,0,0,0.25); overflow: hidden; max-height: 90vh; display: flex; flex-direction: column; }
.modal-lg { width: 560px; }
.modal-header { background: var(--brand--black); color: #fff; padding: 16px 20px; display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; flex-shrink: 0; }
.modal-title { font-size: 14px; font-weight: 600; }
.modal-subtitle { font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 3px; }
.modal-close { background: rgba(255,255,255,0.12); border: none; color: rgba(255,255,255,0.7); cursor: pointer; font-size: 16px; padding: 5px 9px; border-radius: 4px; line-height: 1; transition: background 0.12s; flex-shrink: 0; }
.modal-close:hover { background: rgba(255,255,255,0.2); color: #fff; }
.modal-body { padding: 20px; overflow-y: auto; flex: 1; }
.modal-footer { padding: 14px 20px; border-top: 1px solid var(--ui--underline--light-grey); background: var(--card-light-grey); display: flex; justify-content: flex-end; gap: 8px; flex-shrink: 0; align-items: center; }
.form-row { margin-bottom: 16px; }
.form-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; color: var(--text--dark--30); margin-bottom: 6px; display: block; }
.form-label.required::after { content: ' *'; color: #c0303d; }
.form-input, .form-select { width: 100%; box-sizing: border-box; border: 1.5px solid var(--ui--underline--light-grey); border-radius: 6px; padding: 9px 12px; font-size: 13px; font-family: Arial, sans-serif; color: var(--text--dark--50); background: #fff; transition: border-color 0.15s; }
.form-input:focus, .form-select:focus { outline: none; border-color: var(--action-primary-blue); }
.form-input.error, .form-select.error { border-color: #c0303d; background: #fff5f5; }
.form-hint { font-size: 11px; color: var(--text--dark--30); margin-top: 4px; }
.form-2col { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

/* WARNING BOXES */
.warning-box { padding: 10px 14px; border-radius: 6px; font-size: 12px; margin-bottom: 12px; display: flex; gap: 8px; align-items: flex-start; }
.warning-box.warn { background: #fffbeb; border: 1px solid #fde68a; color: #92400e; }
.warning-box.error { background: #fff5f5; border: 1px solid #fecaca; color: #991b1b; }
.warning-box.info { background: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af; }

/* STATUS PREVIEW */
.status-preview { display: inline-flex; align-items: center; gap: 6px; padding: 5px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; border: 1px solid transparent; margin-top: 8px; }
.status-preview.pending { background: var(--brand--secondary--lightgreen); color: #1a6a40; border-color: #a8f0c8; }
.status-preview.booked { background: var(--accent-blue--50); color: #2147f4; border-color: #93c5fd; }

/* COMPANY LINK */
.company-link { font-weight: 600; cursor: pointer; color: var(--text--dark--50); text-decoration: none; border-bottom: 1px dashed var(--text--dark--20); transition: color 0.12s, border-color 0.12s; }
.company-link:hover { color: var(--action-primary-blue); border-color: var(--action-primary-blue); }

/* NOTES */
.notes-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
.note-item { background: var(--card-light-grey); border-radius: 6px; padding: 10px 12px; border-left: 3px solid var(--action-primary-blue); }
.note-meta { font-size: 11px; color: var(--text--dark--30); margin-bottom: 4px; }
.note-text { font-size: 12px; color: var(--text--dark--50); }

/* ACTIVITY PANEL */
.activity-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15); color: #fff; padding: 5px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; font-family: Arial, sans-serif; position: relative; transition: background 0.15s; }
.activity-btn:hover { background: rgba(255,255,255,0.2); }
.activity-btn-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: #e53935; position: absolute; top: 4px; right: 4px; opacity: 0; transition: opacity 0.2s; }
.activity-btn-dot.visible { opacity: 1; }
.activity-panel-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 300; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
.activity-panel-overlay.open { opacity: 1; pointer-events: all; }
.activity-panel { position: fixed; top: 0; right: -380px; width: 360px; height: 100vh; background: #fff; z-index: 301; transition: right 0.25s ease; box-shadow: -4px 0 24px rgba(0,0,0,0.12); display: flex; flex-direction: column; }
.activity-panel.open { right: 0; }
.activity-panel-header { padding: 16px 18px; background: var(--brand--black); color: #fff; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
.activity-panel-title { font-size: 14px; font-weight: 700; }
.activity-panel-sub { font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 2px; }
.activity-close { background: rgba(255,255,255,0.12); border: none; color: rgba(255,255,255,0.7); cursor: pointer; font-size: 16px; padding: 5px 9px; border-radius: 4px; }
.activity-close:hover { background: rgba(255,255,255,0.2); color: #fff; }
.activity-toolbar { padding: 10px 16px; background: var(--card-light-grey); border-bottom: 1px solid var(--ui--underline--light-grey); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
.activity-count { font-size: 11px; font-weight: 600; color: var(--text--dark--30); }
.activity-clear-btn { font-size: 11px; background: none; border: none; cursor: pointer; color: #c0303d; font-family: Arial, sans-serif; }
.activity-feed-body { flex: 1; overflow-y: auto; }
.activity-entry { padding: 12px 16px; border-bottom: 1px solid var(--ui--underline--light-grey); }
.activity-entry:last-child { border-bottom: none; }
.activity-who { font-size: 11px; font-weight: 700; color: var(--action-primary-blue); }
.activity-what { font-size: 12px; color: var(--text--dark--50); margin: 2px 0; }
.activity-detail { font-size: 11px; color: var(--text--dark--30); }
.activity-time { font-size: 10px; color: var(--text--dark--20); margin-top: 3px; }
.activity-empty { padding: 40px 20px; text-align: center; color: var(--text--dark--30); }

/* MANAGE TRAINERS MODAL */
.trainer-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
.trainer-list-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: var(--card-light-grey); border-radius: 6px; border: 1px solid var(--ui--underline--light-grey); }
.trainer-list-name { font-size: 13px; font-weight: 600; color: var(--text--dark--50); display: flex; align-items: center; gap: 8px; }

/* CAL SETTINGS */
.cal-settings-body { padding: 20px; }

/* KPI MODAL */
.kpi-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 500; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
.kpi-modal-overlay.open { opacity: 1; pointer-events: all; }
.kpi-modal { background: #fff; border-radius: 10px; width: 680px; max-width: 97vw; max-height: 88vh; display: flex; flex-direction: column; box-shadow: 0 12px 48px rgba(0,0,0,0.25); overflow: hidden; }
.kpi-modal-header { background: var(--text--dark--50); color: #fff; padding: 16px 20px; display: flex; align-items: flex-start; justify-content: space-between; flex-shrink: 0; }
.kpi-modal-body { overflow-y: auto; flex: 1; padding: 0; }
.kpi-stat-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 0; border-bottom: 1px solid var(--ui--underline--light-grey); }
.kpi-stat { padding: 14px 16px; border-right: 1px solid var(--ui--underline--light-grey); }
.kpi-stat:last-child { border-right: none; }
.kpi-stat-label { font-size: 10px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; color: var(--text--dark--30); margin-bottom: 4px; }
.kpi-stat-value { font-size: 20px; font-weight: 700; color: var(--text--dark--50); }
.kpi-stat-sub { font-size: 11px; color: var(--text--dark--30); }
</style>
</head>
<body>

<!-- NAV OVERLAY -->
<div class="nav-overlay" id="navOverlay" onclick="closeNav()"></div>

<!-- SIDE DRAWER -->
<nav class="nav-drawer" id="navDrawer">
  <div class="nav-drawer-header">
    <span class="nav-drawer-title">Navigation</span>
    <button class="nav-close" onclick="closeNav()">&#10005;</button>
  </div>
  <div class="nav-section-label">Dashboard</div>
  <a href="#" class="nav-item" onclick="closeNav()"><span class="nav-item-icon">&#128202;</span> Training Dashboard</a>
  <div class="nav-divider"></div>
  <div class="nav-section-label">Tools</div>
  <a href="https://amydawber-del.github.io/TrainingCSAT/dashboard.html" class="nav-item" target="_blank"><span class="nav-item-icon">&#11088;</span> Training Feedback Dashboard</a>
  <a href="https://amydawber-del.github.io/TilTracker/" class="nav-item" target="_blank"><span class="nav-item-icon">&#128218;</span> TIL Tracker</a>
  <a href="https://amydawber-del.github.io/TrainingCSAT/" class="nav-item" target="_blank"><span class="nav-item-icon">&#128203;</span> Client Feedback Survey</a>
  <div class="nav-divider"></div>
  <div class="nav-section-label">Resources</div>
  <a href="https://docs.google.com/spreadsheets/d/1r_HODYw7kIMpWm8TNcXwJmZQuk0lsjVR6SEl2teytJM/edit" class="nav-item" target="_blank"><span class="nav-item-icon">&#128196;</span> Bookings Spreadsheet</a>
  <a href="https://docs.google.com/forms/d/e/1FAIpQLSe-s3SWoPSaIanCZLMLYNnVmu3NU-LY4Lm7Db12gHLv6LzVuQ/viewform" class="nav-item" target="_blank"><span class="nav-item-icon">&#128221;</span> Training Request Form</a>
</nav>

<!-- HEADER -->
<header class="header">
  <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleNav()"><span></span><span></span><span></span></button>
  <div class="street-logo-mark">STREET<span class="logo-dot">.</span><span style="font-size:9px;font-weight:400;">CO.UK</span></div>
  <div class="header-title">Training Dashboard</div>
  <div class="header-right">
    <span class="last-updated" id="lastUpdated">&#8212;</span>
    <!-- User selector -->
    <div class="user-selector-wrap">
      <div class="user-avatar" id="headerAvatar">?</div>
      <select class="user-select" id="userSelect" onchange="onUserChange()">
        <option value="">&#8212; Select user &#8212;</option>
      </select>
      <span class="admin-badge" id="adminBadge" style="display:none;">ADMIN</span>
    </div>
    <button class="activity-btn" id="activityNavBtn" onclick="openActivityPanel()" title="Activity Feed">&#128336; Activity<span class="activity-btn-dot" id="activityBtnDot"></span></button>
    <button class="refresh-btn admin-only" id="testBtn" onclick="testConnection(this)" style="background:rgba(255,200,0,0.15);border-color:rgba(255,200,0,0.3);">&#128269; Test</button>
    <button class="refresh-btn admin-only" onclick="loadData()">&#8635; Refresh</button>
  </div>
</header>

<div class="loading-bar" id="loadingBar"></div>

<!-- MAIN -->
<main class="main">

  <!-- 1. TRAINER WORKLOAD -->
  <div style="margin-bottom:24px;">
    <div class="section-header">
      <div class="section-title">&#128100; Trainer Workload</div>
      <div style="display:flex;align-items:center;gap:10px;">
        <span style="font-size:11px;color:var(--text--dark--30);">Last 30 days + upcoming</span>
        <button class="refresh-btn admin-only" onclick="openTrainerModal()" style="background:rgba(33,71,244,0.1);border-color:rgba(33,71,244,0.3);color:var(--action-primary-blue);font-size:11px;">+ Manage Trainers</button>
      </div>
    </div>
    <div class="trainer-grid" id="trainerGrid">
      <div class="kpi-card" style="text-align:center;color:var(--text--dark--30);font-size:12px;grid-column:1/-1;">Loading trainer data...</div>
    </div>
  </div>

  <!-- 2. UNASSIGNED REQUESTS -->
  <div style="margin-bottom:24px;">
    <div class="section-header">
      <div class="section-title">&#128276; Unassigned Requests<span class="badge" id="unassignedBadge">0</span></div>
    </div>
    <div class="requests-panel">
      <div class="requests-panel-header">
        <div style="display:flex;align-items:center;gap:8px;">
          <div class="alert-dot" id="unassignedDot" style="display:none;"></div>
          <span style="font-size:12px;font-weight:600;color:var(--text--dark--40);">New training requests awaiting trainer assignment</span>
        </div>
        <span style="font-size:11px;color:var(--text--dark--30);">Click <strong>Assign</strong> to open the assignment panel</span>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>Submitted</th><th>Company</th><th>Contact</th><th>Option</th><th>Preferred Date</th><th>Actions</th></tr>
          </thead>
          <tbody id="unassignedBody">
            <tr><td colspan="6" style="padding:20px;text-align:center;color:var(--text--dark--30);">Connecting&#8230;</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 3. CALENDAR -->
  <div style="margin-bottom:24px;">
    <div class="section-header">
      <div class="section-title">&#128197; Training Calendar</div>
      <button class="refresh-btn admin-only" onclick="openCalSettings()" style="background:rgba(33,71,244,0.1);border-color:rgba(33,71,244,0.3);color:var(--action-primary-blue);font-size:11px;">&#9881; Cal Settings</button>
    </div>
    <div class="cal-grid">
      <div class="cal-month-card">
        <div class="cal-month-header">
          <button class="cal-nav-btn" onclick="calChangeMonth(-1)">&#8592;</button>
          <span class="cal-month-title" id="calMonthTitle">&#8212;</span>
          <div style="display:flex;align-items:center;gap:8px;">
            <select id="calFilterTrainer" onchange="renderCalendar()" style="font-size:11px;border:1px solid rgba(255,255,255,0.3);border-radius:4px;padding:3px 7px;font-family:Arial,sans-serif;background:rgba(255,255,255,0.1);color:#fff;">
              <option value="">All Trainers</option>
            </select>
            <button class="cal-nav-btn" onclick="calChangeMonth(1)">&#8594;</button>
          </div>
        </div>
        <div class="cal-filter-row">
          <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#fef3c7;border:1px solid #fde68a;"></div><span class="cal-legend-label">Travel</span></div>
          <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#2147f4;"></div><span class="cal-legend-label">Training</span></div>
          <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#e0e7ff;border:1px solid #a5b4fc;"></div><span class="cal-legend-label">Admin</span></div>
          <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#fef9c3;border:1px solid #fde047;"></div><span class="cal-legend-label">Bank Holiday</span></div>
          <span id="calGcalStatus" style="font-size:11px;color:var(--text--dark--30);margin-left:auto;"></span>
        </div>
        <div class="cal-dow-row">
          <div class="cal-dow">Mon</div><div class="cal-dow">Tue</div><div class="cal-dow">Wed</div>
          <div class="cal-dow">Thu</div><div class="cal-dow">Fri</div><div class="cal-dow">Sat</div><div class="cal-dow">Sun</div>
        </div>
        <div class="cal-days" id="calDays"></div>
      </div>
      <div class="cal-upcoming-card">
        <div class="cal-upcoming-header">
          <span>Upcoming Sessions</span>
          <span id="calUpcomingCount" style="font-size:10px;color:var(--text--dark--30);">&#8212;</span>
        </div>
        <div class="cal-upcoming-body" id="calUpcomingBody"><div class="cal-upcoming-empty">Loading&#8230;</div></div>
      </div>
    </div>
  </div>

  <!-- 4. NEEDS ACTION -->
  <div style="margin-bottom:24px;">
    <div class="section-header">
      <div class="section-title" style="color:#8a5a2a;">&#9888;&#65039; Needs Action &#8212; Pending<span class="badge orange" id="actionBadge">0</span></div>
      <span style="font-size:11px;color:var(--text--dark--30);">Update status to Booked or Cancelled &#8212; admin only</span>
    </div>
    <div class="requests-panel" style="border-color:var(--brand-accent--mandarin-light);">
      <div class="requests-panel-header" style="background:var(--brand-accent--cream);">
        <div style="display:flex;align-items:center;gap:8px;">
          <div class="alert-dot" id="actionDot" style="display:none;background:#f59e0b;"></div>
          <span style="font-size:12px;font-weight:600;color:var(--text--dark--40);">Pending bookings awaiting confirmation</span>
        </div>
        <span style="font-size:11px;color:var(--text--dark--30);">Only status can be changed from this panel</span>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>Submitted</th><th>Company</th><th>Contact</th><th>Option</th><th>Preferred Date</th><th>Trainer</th><th>Status</th></tr>
          </thead>
          <tbody id="actionBody">
            <tr><td colspan="7" style="padding:20px;text-align:center;color:var(--text--dark--30);">Connecting&#8230;</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 5. KPI CARDS -->
  <div style="margin-bottom:16px;"><div class="section-title" style="margin-bottom:14px;">&#128200; Performance Overview</div></div>
  <div class="kpi-grid">
    <div class="kpi-card kpi-accent-left clickable" onclick="openKpiModal('revYear')">
      <div class="kpi-card-label">Total Revenue This Year <span style="font-weight:400;color:var(--accent--blue--300);">(Booked)</span></div>
      <div class="kpi-card-value" id="kpiRevYear">&#163;&#8212;</div>
      <div class="kpi-card-sub">Exc. VAT &middot; click for detail</div>
    </div>
    <div class="kpi-card kpi-accent-left kpi-accent-yellow clickable" onclick="openKpiModal('revMonth')">
      <div class="kpi-card-label">Revenue This Month <span style="font-weight:400;color:var(--accent--blue--300);">(Booked)</span></div>
      <div class="kpi-card-value" id="kpiRevMonth">&#163;&#8212;</div>
      <div id="kpiRevMonthDelta"></div>
    </div>
    <div class="kpi-card kpi-accent-left kpi-accent-green clickable" onclick="openKpiModal('avgFee')">
      <div class="kpi-card-label">Avg Training Fee (Year)</div>
      <div class="kpi-card-value" id="kpiAvgFee">&#163;&#8212;</div>
      <div class="kpi-card-sub">Per booking &middot; click for detail</div>
    </div>
    <div class="kpi-card kpi-accent-left kpi-accent-orange clickable" onclick="openKpiModal('days')">
      <div class="kpi-card-label">Training Days This Year</div>
      <div class="kpi-card-value" id="kpiDaysYear">&#8212;</div>
      <div class="kpi-card-sub" id="kpiDaysMonth">&#8212; this month</div>
    </div>
    <div class="kpi-card kpi-accent-left clickable" style="border-left-color:#9c27b0;" onclick="openKpiModal('bookings')">
      <div class="kpi-card-label">Total Bookings (Year)</div>
      <div class="kpi-card-value" id="kpiBookingsYear">&#8212;</div>
      <div class="kpi-card-sub" id="kpiBookingsMonth">&#8212; this month</div>
    </div>
  </div>

  <!-- 6. CHARTS -->
  <div class="charts-grid">
    <div class="chart-card">
      <div class="chart-title">Monthly Revenue</div>
      <div class="chart-subtitle">This year vs last year (exc. VAT)</div>
      <div style="height:240px;"><canvas id="revenueChart"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">Month Comparison</div>
      <div class="chart-subtitle">This month vs last month</div>
      <div class="compare-cards">
        <div class="compare-card"><div class="compare-card-label" id="thisMonthLabel">This Month</div><div class="compare-card-value" id="thisMonthRev">&#163;&#8212;</div></div>
        <div class="compare-card"><div class="compare-card-label" id="lastMonthLabel">Last Month</div><div class="compare-card-value" id="lastMonthRev">&#163;&#8212;</div></div>
      </div>
      <div style="height:150px;"><canvas id="optionChart"></canvas></div>
      <div class="chart-subtitle" style="margin-top:10px;margin-bottom:0;">Bookings by training option (this year)</div>
    </div>
  </div>

  <!-- 7. ALL BOOKINGS -->
  <div>
    <div class="section-header" style="flex-wrap:wrap;gap:10px;">
      <div class="section-title">&#128203; All Bookings<span class="badge green" id="allBadge">0</span></div>
      <div class="filter-bar">
        <input class="filter-input" id="bookingSearch" type="text" placeholder="Search company or contact&#8230;" oninput="resetPageAndRender()" style="width:200px;">
        <select class="filter-select" id="filterStatus" onchange="resetPageAndRender()">
          <option value="">All Statuses</option>
          <option value="Pending">Pending</option>
          <option value="Booked">Booked</option>
          <option value="Cancelled">Cancelled</option>
        </select>
        <select class="filter-select" id="filterTrainer" onchange="resetPageAndRender()"><option value="">All Trainers</option></select>
        <select class="filter-select" id="filterOption" onchange="resetPageAndRender()">
          <option value="">All Options</option>
          <option value="1">Option 1</option><option value="2">Option 2</option>
          <option value="3">Option 3</option><option value="4">Option 4</option><option value="5">Option 5</option>
        </select>
        <input class="filter-input" id="filterDateFrom" type="date" onchange="resetPageAndRender()" style="width:130px;">
        <input class="filter-input" id="filterDateTo" type="date" onchange="resetPageAndRender()" style="width:130px;">
        <button class="btn btn-ghost btn-sm" onclick="clearBookingFilters()">&#10005; Clear</button>
      </div>
    </div>
    <div class="all-bookings">
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>Date</th><th>Company</th><th>Contact</th><th>Option</th><th>Trainer</th><th>Days</th><th>Value</th><th>Status</th></tr>
          </thead>
          <tbody id="allBookingsBody">
            <tr><td colspan="8" style="padding:20px;text-align:center;color:var(--text--dark--30);">Connecting&#8230;</td></tr>
          </tbody>
        </table>
      </div>
      <div class="pagination" id="allBookingsPagination" style="display:none;">
        <button class="page-btn" id="prevPageBtn" onclick="changePage(-1)">&#8592; Prev</button>
        <span id="pageInfo">Page 1</span>
        <button class="page-btn" id="nextPageBtn" onclick="changePage(1)">Next &#8594;</button>
        <span style="margin-left:auto;" id="rowCount">0 bookings</span>
      </div>
    </div>
  </div>

</main>

<!-- ============================================================ -->
<!-- MODALS -->
<!-- ============================================================ -->

<!-- ASSIGN MODAL (trainer only) -->
<div class="modal-overlay" id="assignOverlay" onclick="if(event.target===this)closeAssignModal()">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-title" id="assignModalCompany">Assign Trainer</div>
        <div class="modal-subtitle" id="assignModalContact">&#8212;</div>
      </div>
      <button class="modal-close" onclick="closeAssignModal()">&#10005;</button>
    </div>
    <div class="modal-body">
      <div id="assignModalOption" style="margin-bottom:14px;font-size:12px;color:var(--text--dark--30);"></div>
      <div class="form-row">
        <label class="form-label required">Assign Trainer</label>
        <select class="form-select" id="assignTrainerSel">
          <option value="">&#8212; Select trainer &#8212;</option>
        </select>
      </div>
      <div class="status-preview pending">&#128203; Enquiry will move to <strong>Pending</strong> status</div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeAssignModal()">Cancel</button>
      <button class="btn btn-primary" onclick="confirmAssign()">&#10003; Assign &amp; Set Pending</button>
    </div>
  </div>
</div>

<!-- BOOK MODAL (Needs Action &#8594; Booked) -->
<div class="modal-overlay" id="bookOverlay" onclick="if(event.target===this)closeBookModal()">
  <div class="modal modal-lg">
    <div class="modal-header">
      <div>
        <div class="modal-title">&#128200; Confirm Booking</div>
        <div class="modal-subtitle" id="bookModalCompany">&#8212;</div>
      </div>
      <button class="modal-close" onclick="closeBookModal()">&#10005;</button>
    </div>
    <div class="modal-body">
      <div id="bookWarnings"></div>
      <div class="form-2col">
        <div class="form-row">
          <label class="form-label required">Booked On Date</label>
          <input type="date" class="form-input" id="bookDate" oninput="checkBookingWarnings()">
          <div class="form-hint">Date training takes place</div>
        </div>
        <div class="form-row">
          <label class="form-label required">Number of Training Days</label>
          <input type="number" class="form-input" id="bookDays" min="1" max="14" value="1" oninput="checkBookingWarnings()">
          <div class="form-hint">Used to block the calendar</div>
        </div>
      </div>
      <div class="form-row">
        <label class="form-label required">Trainer</label>
        <select class="form-select" id="bookTrainer" onchange="checkBookingWarnings()">
          <option value="">&#8212; Select trainer &#8212;</option>
        </select>
      </div>
      <div class="form-row">
        <label class="form-label required">Invoice Value (&#163;)</label>
        <input type="number" class="form-input" id="bookValue" min="0" step="50" placeholder="e.g. 1100">
        <div class="form-hint" id="bookValueHint">&#8212;</div>
      </div>
      <div class="status-preview booked">&#128200; Status will be set to <strong>Booked</strong></div>
    </div>
    <div class="modal-footer">
      <span id="bookingBlockMsg" style="font-size:12px;color:#c0303d;font-weight:600;margin-right:auto;display:none;"></span>
      <button class="btn btn-ghost" onclick="closeBookModal()">Cancel</button>
      <button class="btn btn-success" id="confirmBookBtn" onclick="confirmBook()">&#10003; Confirm Booking</button>
    </div>
  </div>
</div>

<!-- CANCEL MODAL -->
<div class="modal-overlay" id="cancelOverlay" onclick="if(event.target===this)closeCancelModal()">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-title">&#10007; Cancel Enquiry</div>
        <div class="modal-subtitle" id="cancelModalCompany">&#8212;</div>
      </div>
      <button class="modal-close" onclick="closeCancelModal()">&#10005;</button>
    </div>
    <div class="modal-body">
      <div class="warning-box warn" style="margin-bottom:16px;">
        <span>&#9888;&#65039;</span>
        <span>Cancelling will move this enquiry to All Bookings. This action can be undone by an admin.</span>
      </div>
      <div class="form-row">
        <label class="form-label required">Cancellation Reason</label>
        <textarea class="form-input" id="cancelReason" rows="3" placeholder="Enter the reason for cancellation&#8230;" style="resize:vertical;"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeCancelModal()">Go Back</button>
      <button class="btn btn-danger" onclick="confirmCancel()">&#10007; Confirm Cancellation</button>
    </div>
  </div>
</div>

<!-- NOTES MODAL -->
<div class="modal-overlay" id="notesOverlay" onclick="if(event.target===this)closeNotesModal()">
  <div class="modal modal-lg">
    <div class="modal-header">
      <div>
        <div class="modal-title">&#128221; Progress Notes</div>
        <div class="modal-subtitle" id="notesModalCompany">&#8212;</div>
      </div>
      <button class="modal-close" onclick="closeNotesModal()">&#10005;</button>
    </div>
    <div class="modal-body">
      <div class="notes-list" id="notesList">
        <div style="text-align:center;color:var(--text--dark--30);padding:20px;">No notes yet.</div>
      </div>
      <div style="border-top:1px solid var(--ui--underline--light-grey);padding-top:16px;margin-top:8px;">
        <div class="form-row">
          <label class="form-label required">Add Note</label>
          <textarea class="form-input" id="newNoteText" rows="3" placeholder="Enter your note here&#8230;" style="resize:vertical;"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeNotesModal()">Close</button>
      <button class="btn btn-primary" onclick="saveNote()">&#10003; Add Note</button>
    </div>
  </div>
</div>

<!-- CALENDAR EVENT PREVIEW MODAL -->
<div class="modal-overlay" id="calEventOverlay" onclick="if(event.target===this)closeCalEventModal()">
  <div class="modal">
    <div class="modal-header" id="calEventHeader">
      <div>
        <div class="modal-title" id="calEventTitle">Booking Details</div>
        <div class="modal-subtitle" id="calEventSubtitle">&#8212;</div>
      </div>
      <button class="modal-close" onclick="closeCalEventModal()">&#10005;</button>
    </div>
    <div class="modal-body" id="calEventBody"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeCalEventModal()">Close</button>
    </div>
  </div>
</div>

<!-- MANAGE TRAINERS MODAL -->
<div class="modal-overlay" id="trainerModalOverlay" onclick="if(event.target===this)closeTrainerModal()">
  <div class="modal">
    <div class="modal-header">
      <div><div class="modal-title">&#128100; Manage Trainers</div><div class="modal-subtitle">Add or remove team members</div></div>
      <button class="modal-close" onclick="closeTrainerModal()">&#10005;</button>
    </div>
    <div class="modal-body">
      <div class="trainer-list" id="trainerList"></div>
      <div style="display:flex;gap:8px;margin-top:8px;">
        <input type="text" class="form-input" id="newTrainerName" placeholder="New trainer name&#8230;" style="flex:1;" onkeydown="if(event.key==='Enter')addTrainer()">
        <button class="btn btn-primary" onclick="addTrainer()">+ Add</button>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeTrainerModal()">Close</button>
    </div>
  </div>
</div>

<!-- CALENDAR SETTINGS MODAL -->
<div class="modal-overlay" id="calSettingsOverlay" onclick="if(event.target===this)closeCalSettings()">
  <div class="modal">
    <div class="modal-header">
      <div><div class="modal-title">&#128197; Google Calendar Settings</div><div class="modal-subtitle">Connect your shared team calendar</div></div>
      <button class="modal-close" onclick="closeCalSettings()">&#10005;</button>
    </div>
    <div class="modal-body">
      <div class="warning-box info" style="margin-bottom:16px;">
        <span>&#8505;&#65039;</span>
        <span>Google Calendar &rarr; Settings &rarr; Click your calendar &rarr; "Integrate calendar" &rarr; Copy the Calendar ID</span>
      </div>
      <div class="form-row">
        <label class="form-label">Shared Team Calendar ID</label>
        <input type="text" class="form-input" id="calIdInput" placeholder="e.g. abc123@group.calendar.google.com">
      </div>
      <div id="calSettingsPerTrainer" style="margin-top:8px;"></div>
    </div>
    <div class="modal-footer">
      <span id="calSettingsStatus" style="font-size:11px;color:var(--text--dark--30);margin-right:auto;"></span>
      <button class="btn btn-ghost" onclick="closeCalSettings()">Cancel</button>
      <button class="btn btn-primary" onclick="saveCalSettings()">Save &amp; Sync</button>
    </div>
  </div>
</div>

<!-- KPI MODAL -->
<div class="kpi-modal-overlay" id="kpiModalOverlay" onclick="if(event.target===this)document.getElementById('kpiModalOverlay').classList.remove('open')">
  <div class="kpi-modal">
    <div class="kpi-modal-header">
      <div>
        <div class="modal-title" id="kpiModalTitle">&#8212;</div>
        <div class="modal-subtitle" id="kpiModalSubtitle">&#8212;</div>
      </div>
      <button class="modal-close" onclick="document.getElementById('kpiModalOverlay').classList.remove('open')">&#10005;</button>
    </div>
    <div class="kpi-modal-body">
      <div class="kpi-stat-grid" id="kpiStatGrid"></div>
      <div style="padding:16px;">
        <table style="width:100%;font-size:12px;border-collapse:collapse;">
          <thead id="kpiModalTableHead"></thead>
          <tbody id="kpiModalTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ACTIVITY PANEL -->
<div class="activity-panel-overlay" id="activityPanelOverlay" onclick="closeActivityPanel()"></div>
<div class="activity-panel" id="activityPanel">
  <div class="activity-panel-header">
    <div><div class="activity-panel-title">&#128336; Activity Feed</div><div class="activity-panel-sub">All changes made on this dashboard</div></div>
    <button class="activity-close" onclick="closeActivityPanel()">&#10005;</button>
  </div>
  <div class="activity-toolbar">
    <span class="activity-count" id="activityCount">0 events</span>
    <button class="activity-clear-btn" onclick="clearActivityLog()">&#128465; Clear log</button>
  </div>
  <div class="activity-feed-body" id="activityFeedBody">
    <div class="activity-empty">&#128203; No activity yet</div>
  </div>
</div>

<!-- TOAST -->
<div class="toast-container" id="toastContainer"></div>

<script>
// =============================================
// CONSTANTS
// =============================================
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzCvBhFSPyyoaVsui0DCxvGQQa0V7e_UCJ5LfqvcSysTHTFlNRcx4ewlET5TyouJ0ZYow/exec';
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSvPvb_WzFGr6SKflZEob3RFpuh44lKckD4DcsoAXxKUwtYBGCtGGEqA9YkSnvBKh3pQc9nwdbfh9B2/pub?gid=1792679763&single=true&output=csv';

const OPTION_LABELS = { '1':'On Demand + Help Centre', '2':'Personalised 1 Day', '3':'Personalised 2 Day', '4':'Accounting + Go Live', '5':'Live HQ Session' };
const OPTION_PRICES = { '1':0, '2':1100, '3':1850, '4':1000, '5':220 };
const OPTION_DAYS   = { '1':0, '2':1,    '3':2,    '4':1,    '5':1   };

// Trainer calendar colours (index maps to trainer position)
const TRAINER_PALETTE = ['#2147f4','#22a06b','#e67e22','#9b59b6','#0891b2','#dc2626','#d97706','#0d9488','#7c3aed','#db2777'];

// UK Bank Holidays 20242026
const UK_BANK_HOLIDAYS = new Set([
  '2024-01-01','2024-03-29','2024-04-01','2024-05-06','2024-05-27','2024-08-26','2024-12-25','2024-12-26',
  '2025-01-01','2025-04-18','2025-04-21','2025-05-05','2025-05-26','2025-08-25','2025-12-25','2025-12-26',
  '2026-01-01','2026-04-03','2026-04-06','2026-05-04','2026-05-25','2026-08-31','2026-12-25','2026-12-28'
]);

// =============================================
// USER SYSTEM (simple  no PIN)
// =============================================
const USERS_KEY = 'streetDashboardUsers_v3';
const CUR_USER_KEY = 'streetDashboardCurrentUser';

function getUsers() {
  let users = [];
  try { const s = JSON.parse(localStorage.getItem(USERS_KEY) || 'null'); if (Array.isArray(s)) users = s; } catch(e) {}
  // Ensure Amy (admin) and Max exist
  if (!users.find(u => u.name === 'Amy')) users.unshift({ name:'Amy', role:'admin' });
  if (!users.find(u => u.name === 'Max'))  users.push({ name:'Max',  role:'trainer' });
  // Ensure all have role
  users.forEach(u => { if (!u.role) u.role = 'trainer'; });
  try { localStorage.setItem(USERS_KEY, JSON.stringify(users)); } catch(e) {}
  return users;
}
function saveUsers(arr) { try { localStorage.setItem(USERS_KEY, JSON.stringify(arr)); } catch(e) {} }
function getCurrentUser() { try { return JSON.parse(localStorage.getItem(CUR_USER_KEY) || 'null'); } catch(e) { return null; } }
function setCurrentUser(u) { try { localStorage.setItem(CUR_USER_KEY, JSON.stringify(u)); } catch(e) {} }
function isAdmin() { const u = getCurrentUser(); return u && u.role === 'admin'; }

let USERS = getUsers();
let TRAINERS = USERS.map(u => u.name);

function syncTrainers() { USERS = getUsers(); TRAINERS = USERS.map(u => u.name); }

function getTrainerColor(name) {
  const idx = TRAINERS.indexOf(name);
  return idx >= 0 ? TRAINER_PALETTE[idx % TRAINER_PALETTE.length] : '#777';
}

function initUserSelector() {
  const sel = document.getElementById('userSelect');
  sel.innerHTML = '<option value=""> Select user </option>' + USERS.map(u => '<option value="'+u.name+'">'+u.name+(u.role==='admin'?' ':'')+'</option>').join('');
  const cur = getCurrentUser();
  if (cur) sel.value = cur.name;
  updateHeaderUser();
}

function onUserChange() {
  const sel = document.getElementById('userSelect');
  const name = sel.value;
  if (!name) { setCurrentUser(null); updateHeaderUser(); applyPermissions(); return; }
  const user = USERS.find(u => u.name === name);
  if (user) { setCurrentUser(user); updateHeaderUser(); applyPermissions(); logActivity('login', null, name + ' switched to this user', ''); }
}

function updateHeaderUser() {
  const u = getCurrentUser();
  const avatar = document.getElementById('headerAvatar');
  const badge = document.getElementById('adminBadge');
  if (u) {
    avatar.textContent = u.name[0].toUpperCase();
    avatar.style.background = getTrainerColor(u.name);
    badge.style.display = u.role === 'admin' ? 'inline-block' : 'none';
  } else {
    avatar.textContent = '?';
    avatar.style.background = '#777';
    badge.style.display = 'none';
  }
}

function applyPermissions() {
  const admin = isAdmin();
  document.querySelectorAll('.admin-only').forEach(el => {
    el.style.display = admin ? '' : 'none';
  });
  // Re-render panels that depend on permissions
  renderActionPanel();
}

// =============================================
// STATE
// =============================================
let allData = [];
let currentPage = 1;
const PAGE_SIZE = 15;
let revenueChart = null;
let optionChart = null;

// Calendar state
const calState = { year: new Date().getFullYear(), month: new Date().getMonth(), gcalEvents: [], isFetching: false };

// Modal state
let _assignRowIndex = null;
let _bookRowIndex = null;
let _cancelRowIndex = null;
let _notesRowIndex = null;

// =============================================
// OVERRIDE CACHE
// =============================================
const OVERRIDE_KEY = 'streetDashboardOverrides_v2';
function getOverrides() { try { return JSON.parse(sessionStorage.getItem(OVERRIDE_KEY) || '{}'); } catch(e) { return {}; } }
function saveOverride(rowIndex, fields) { const o = getOverrides(); o[rowIndex] = Object.assign(o[rowIndex]||{}, fields); try { sessionStorage.setItem(OVERRIDE_KEY, JSON.stringify(o)); } catch(e) {} }
function applyOverrides(rows) { const o = getOverrides(); return rows.map(r => { const ov = o[r.rowIndex]; return ov ? Object.assign({}, r, ov) : r; }); }

// Notes cache (stored in localStorage by rowIndex)
const NOTES_KEY = 'streetDashboardNotes_v2';
function getAllNotes() { try { return JSON.parse(localStorage.getItem(NOTES_KEY) || '{}'); } catch(e) { return {}; } }
function getNotesForRow(rowIndex) { return getAllNotes()[rowIndex] || []; }
function saveNoteForRow(rowIndex, text, author) {
  const all = getAllNotes();
  if (!all[rowIndex]) all[rowIndex] = [];
  all[rowIndex].push({ text, author, time: new Date().toISOString() });
  try { localStorage.setItem(NOTES_KEY, JSON.stringify(all)); } catch(e) {}
}

// =============================================
// NAV
// =============================================
function toggleNav() { const d=document.getElementById('navDrawer'),o=document.getElementById('navOverlay'),b=document.getElementById('hamburgerBtn'); if(d.classList.contains('open')){closeNav();}else{d.classList.add('open');o.classList.add('open');b.classList.add('open');} }
function closeNav() { document.getElementById('navDrawer').classList.remove('open'); document.getElementById('navOverlay').classList.remove('open'); document.getElementById('hamburgerBtn').classList.remove('open'); }

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    closeNav(); closeAssignModal(); closeBookModal(); closeCancelModal(); closeNotesModal(); closeCalEventModal();
    document.getElementById('kpiModalOverlay').classList.remove('open');
  }
});

// =============================================
// TOAST / LOADING
// =============================================
function showToast(msg, type='') { const t=document.createElement('div'); t.className='toast '+type; t.textContent=msg; document.getElementById('toastContainer').appendChild(t); setTimeout(()=>t.remove(),3500); }
function setLoading(on) { document.getElementById('loadingBar').classList.toggle('active',on); }
function esc(s) { if (!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function formatDate(d) { if(!d) return ''; const dt=d instanceof Date?d:new Date(d); if(isNaN(dt.getTime())) return ''; return dt.toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}); }

// =============================================
// DATE HELPERS
// =============================================
function isWeekend(d) { const day=d.getDay(); return day===0||day===6; }
function isBankHoliday(d) { return UK_BANK_HOLIDAYS.has(toDateStr(d)); }
function isWorkday(d) { return !isWeekend(d) && !isBankHoliday(d); }
function toDateStr(d) { return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0'); }
function addDays(d, n) { const r=new Date(d); r.setDate(r.getDate()+n); return r; }

// Given a training date and number of days, return all blocked dates
function getBlockedDates(trainingDateStr, numDays) {
  if (!trainingDateStr) return { travel:[], training:[], admin:[] };
  const start = new Date(trainingDateStr+'T00:00:00');
  const travel = addDays(start, -1);
  const training = [];
  for (let i=0;i<numDays;i++) training.push(addDays(start, i));
  const lastTraining = training[training.length-1] || start;
  const admin = addDays(lastTraining, 1);
  return { travel:[toDateStr(travel)], training:training.map(toDateStr), admin:[toDateStr(admin)] };
}

// =============================================
// DATA FETCHING
// =============================================

// Fetch with timeout helper
function fetchWithTimeout(url, options={}, timeoutMs=10000) {
  const fetchPromise = fetch(url, { ...options, redirect: 'follow' });
  const timeoutPromise = new Promise((_, reject) =>
    setTimeout(() => reject(new Error('Timed out after ' + timeoutMs + 'ms')), timeoutMs)
  );
  return Promise.race([fetchPromise, timeoutPromise]);
}

async function testConnection(btn) {
  btn.textContent = ''; btn.disabled = true;
  let info = '';
  // Try Apps Script
  try {
    const res = await fetchWithTimeout(APPS_SCRIPT_URL+'?action=getData', {}, 10000);
    const text = await res.text();
    const isJSON = text.trim().startsWith('{');
    info += '--- Apps Script ---\nStatus: '+res.status+'\nIs JSON: '+isJSON;
    if (isJSON) {
      const json = JSON.parse(text);
      info += '\nRows: '+(json.data?json.data.length:'none')+'\nSuccess: '+json.success;
      if (json.error) info += '\nError: '+json.error;
    } else {
      info += '\nResponse preview:\n'+text.slice(0,200);
    }
  } catch(e) {
    info += '--- Apps Script ---\nFAILED: '+e.message+'\n\nThis is usually a CORS or deployment issue.\nCheck your Apps Script is deployed as:\n  Execute as: Me\n  Who has access: Anyone';
  }
  // Try CSV
  try {
    const res2 = await fetchWithTimeout(CSV_URL, {}, 8000);
    const text2 = await res2.text();
    info += '\n\n--- CSV Fallback ---\nStatus: '+res2.status+'\nLength: '+text2.length+' chars\nLooks valid: '+(text2.includes(',')&&text2.length>100);
  } catch(e) {
    info += '\n\n--- CSV Fallback ---\nFAILED: '+e.message;
  }
  alert(info);
  btn.textContent = ' Test'; btn.disabled = false;
}

async function loadData() {
  setLoading(true);
  document.getElementById('lastUpdated').textContent = 'Loading';

  // Try Apps Script first
  try {
    const res = await fetchWithTimeout(APPS_SCRIPT_URL+'?action=getData', {}, 10000);
    const text = await res.text();
    if (text && text.trim().startsWith('{')) {
      const json = JSON.parse(text);
      if (json && json.data && json.data.length > 1) {
        allData = applyOverrides(parseAppsScriptData(json.data));
        processData();
        document.getElementById('lastUpdated').textContent = ' Live  '+new Date().toLocaleTimeString();
        setLoading(false);
        return;
      }
      if (json && json.error) {
        console.warn('Apps Script error:', json.error);
      }
    }
  } catch(e) {
    // Silently fall through to CSV  fetch failures are normal when Apps Script
    // isn't deployed or the network blocks the request
  }

  // Try CSV fallback
  try {
    const res2 = await fetchWithTimeout(CSV_URL, {}, 8000);
    const text2 = await res2.text();
    if (text2 && text2.length > 100 && text2.includes(',')) {
      allData = applyOverrides(parseCSV(text2));
      processData();
      document.getElementById('lastUpdated').textContent = ' CSV mode  '+new Date().toLocaleTimeString();
      setLoading(false);
      return;
    }
  } catch(e) {
    console.warn('CSV fetch failed:', e.message);
  }

  // Fall back to demo data
  allData = applyOverrides(generateDemoData());
  processData();
  document.getElementById('lastUpdated').textContent = ' Demo data  sheet unreachable';
  showToast('Cannot reach Google Sheet. Showing demo data.', 'error');
  setLoading(false);
}

function parseAppsScriptData(rows) {
  if (!rows||rows.length<2) return [];
  const headers = rows[0].map(h=>String(h).trim().toLowerCase());
  return rows.slice(1).map((row,i)=>{ const obj={}; headers.forEach((h,j)=>{obj[h]=row[j]||'';}); return normaliseRow(obj,i+2); }).filter(r=>r.company||r.contact);
}
function parseCSV(text) {
  const lines=text.split('\n').filter(l=>l.trim());
  if (lines.length<2) return [];
  const headers=parseCSVRow(lines[0]).map(h=>h.trim().toLowerCase());
  return lines.slice(1).map((line,i)=>{ const vals=parseCSVRow(line); const obj={}; headers.forEach((h,j)=>{obj[h]=(vals[j]||'').trim();}); return normaliseRow(obj,i+2); }).filter(r=>r.company||r.contact);
}
function parseCSVRow(line) {
  const result=[]; let cur='',inQ=false;
  for (let i=0;i<line.length;i++) { const c=line[i]; if(c==='"'){inQ=!inQ;}else if(c===','&&!inQ){result.push(cur);cur='';}else{cur+=c;} }
  result.push(cur); return result;
}

function normaliseRow(obj, rowIndex) {
  const get = (...keys) => {
    for (const k of keys) for (const ok of Object.keys(obj)) if (ok===k) return obj[ok];
    for (const k of keys) for (const ok of Object.keys(obj)) if (ok.includes(k)) return obj[ok];
    return '';
  };
  const timestamp = get('timestamp');
  const company = get('company / business name:','company / business name','company name','company','organisation','business','agency');
  const contact = get('client stakeholder name and phone number (authorising training)','client stakeholder name','stakeholder','contact','name','your name');
  const email = get('email address','email');
  const optionRaw = get('what type of training are you interested in?','what type of training','training option','type of training','option','training type','package');
  const numAttendeesRaw = get('how many delegates will be attending the hq session?','delegates','attendees','how many');
  const numAttendees = parseInt(numAttendeesRaw) || 1;
  const bookedDate = get('preferred training date','preferred date','training date','date');
  const trainer = get('trainer','assigned trainer');
  const rawStatus = get('status');
  const notes = get('notes','admin notes','comments');
  const revenueRaw = get('invoice value','value','revenue','amount','fee','price');
  const option = String(optionRaw).match(/\d/)?String(optionRaw).match(/\d/)[0]:'2';
  const basePrice = parseInt(OPTION_PRICES[option])||0;
  let revenue = parseFloat(String(revenueRaw).replace(/[^0-9.]/g,''))||0;
  if (!revenue && option) revenue = option==='5'?basePrice*numAttendees:basePrice;
  const parsedDate = parseDate(timestamp||bookedDate);

  // Normalise status to 3-state system
  let status = rawStatus || (trainer ? 'Pending' : 'Unassigned');
  // Map legacy statuses
  if (['New','Assigned','Complete','new','assigned','complete'].includes(status)) status = trainer ? 'Pending' : 'Unassigned';
  if (['booked','BOOKED'].includes(status)) status = 'Booked';
  if (['cancelled','CANCELLED','Canceled','canceled'].includes(status)) status = 'Cancelled';
  if (!['Pending','Booked','Cancelled','Unassigned'].includes(status)) status = trainer ? 'Pending' : 'Unassigned';

  return {
    rowIndex, timestamp: timestamp||'', date: parsedDate,
    company: company||'', contact: contact||'', email: email||'',
    option, optionLabel: OPTION_LABELS[option]||('Option '+option),
    preferredDate: bookedDate||'', attendees: numAttendees,
    trainer: trainer||'', status,
    notes: notes||'',
    bookedOn: formatDateInput(get('booked on date','booked on','date booked'))||'',
    trainingDays: parseInt(get('training days','days'))||OPTION_DAYS[option]||1,
    revenue
  };
}

function parseDate(str) {
  if (!str) return null;
  const s = String(str).trim();
  const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
  if (m) { const d=new Date(Number(m[3]),Number(m[2])-1,Number(m[1])); return isNaN(d.getTime())?null:d; }
  const d = new Date(s); return isNaN(d.getTime())?null:d;
}
function formatDateInput(val) {
  if (!val) return '';
  const s=String(val).trim();
  if (/^\d{4}-\d{2}-\d{2}/.test(s)) return s.slice(0,10);
  const m=s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
  if (m) return m[3]+'-'+m[2].padStart(2,'0')+'-'+m[1].padStart(2,'0');
  const d=new Date(s); if(!isNaN(d.getTime())) return d.toISOString().slice(0,10);
  return '';
}

// =============================================
// DEMO DATA
// =============================================
function generateDemoData() {
  const now=new Date(), year=now.getFullYear(), lastYear=year-1;
  const rows=[]; let rowIdx=2;
  const companies=['Acorn Estates','Bridgewater Properties','Chapman & Co','Dalton Lettings','Elara Homes','Foxcroft Realty','Grange Lettings','Harfield & Sons','Ivory Keys','Jameson Estate Agents','Keystone Lettings','Lakewood Homes'];
  const contacts=['James Wilson','Sarah Brown','Michael Davies','Emma Jones','Oliver Smith','Charlotte Taylor','Harry White','Amelia Harris','George Clark','Lily Walker','Noah Robinson','Sophia Lewis'];
  for (let m=0;m<=now.getMonth();m++) {
    const count=3+Math.floor(Math.random()*5);
    for (let i=0;i<count;i++) {
      const day=1+Math.floor(Math.random()*28);
      const dateObj=new Date(year,m,day);
      if (dateObj>now) continue;
      const opt=['2','2','3','3','4','5','1'][Math.floor(Math.random()*7)];
      const compIdx=(m*3+i)%companies.length;
      const trainerIdx=Math.floor(Math.random()*TRAINERS.length);
      const isNew=(m===now.getMonth()&&i>=2);
      const isUnassigned=(m===now.getMonth()&&i>=3);
      const numAtt=opt==='5'?(2+Math.floor(Math.random()*4)):1;
      const bookedDateObj=new Date(year,m,day+14);
      const trainer=isUnassigned?'':TRAINERS[trainerIdx];
      const status=isUnassigned?'Unassigned':(isNew?'Pending':'Booked');
      rows.push({
        rowIndex:rowIdx++, timestamp:dateObj.toISOString(), date:dateObj,
        company:companies[compIdx], contact:contacts[compIdx],
        email:contacts[compIdx].toLowerCase().replace(' ','.')+'@'+companies[compIdx].toLowerCase().replace(/[^a-z]/g,'')+'.com',
        option:opt, optionLabel:OPTION_LABELS[opt],
        preferredDate:bookedDateObj.toLocaleDateString('en-GB'), attendees:numAtt,
        trainer, status, notes:'',
        bookedOn:status==='Booked'?toDateStr(bookedDateObj):'',
        trainingDays:OPTION_DAYS[opt]||1,
        revenue:opt==='5'?OPTION_PRICES[opt]*numAtt:OPTION_PRICES[opt]
      });
    }
  }
  for (let m=0;m<12;m++) {
    const count=2+Math.floor(Math.random()*4);
    for (let i=0;i<count;i++) {
      const day=1+Math.floor(Math.random()*28);
      const dateObj=new Date(lastYear,m,day);
      const opt=['2','2','3','4','5'][Math.floor(Math.random()*5)];
      const compIdx=(m*2+i)%companies.length;
      const numAtt=opt==='5'?(2+Math.floor(Math.random()*3)):1;
      const bookedDateObj=new Date(lastYear,m,day+7);
      rows.push({
        rowIndex:rowIdx++, timestamp:dateObj.toISOString(), date:dateObj,
        company:companies[compIdx]+' (LY)', contact:contacts[compIdx], email:'',
        option:opt, optionLabel:OPTION_LABELS[opt],
        preferredDate:'', attendees:numAtt,
        trainer:TRAINERS[Math.floor(Math.random()*TRAINERS.length)],
        status:'Booked', notes:'', bookedOn:toDateStr(bookedDateObj),
        trainingDays:OPTION_DAYS[opt]||1,
        revenue:opt==='5'?OPTION_PRICES[opt]*numAtt:OPTION_PRICES[opt]
      });
    }
  }
  return rows;
}

// =============================================
// PROCESS & RENDER
// =============================================
function processData() {
  renderUnassigned();
  renderActionPanel();
  renderKPIs();
  renderCharts();
  renderTrainerWorkload();
  renderAllBookings();
  populateTrainerFilter();
  populateCalTrainerFilter();
  renderCalendar();
  renderUpcoming();
}

// =============================================
// STALE ROW HELPER
// =============================================
function isStale(row) {
  if (!row.date && !row.timestamp) return false;
  const d = row.date || parseDate(row.timestamp);
  if (!d) return false;
  return (Date.now() - d.getTime()) > 7*24*60*60*1000;
}
function staleTag() { return '<span class="stale-badge">&#9200; 7+ days</span>'; }
function daysAgo(row) {
  const d = row.date || parseDate(row.timestamp); if (!d) return null;
  return Math.floor((Date.now()-d.getTime())/(24*60*60*1000));
}

function companyCell(row) {
  const notesCount = getNotesForRow(row.rowIndex).length;
  const noteIcon = notesCount>0 ? ' <span style="font-size:10px;background:var(--action-primary-blue);color:#fff;border-radius:10px;padding:1px 6px;cursor:pointer;" onclick="openNotesModal('+row.rowIndex+')" title="View notes">'+notesCount+' note'+(notesCount>1?'s':'')+'</span>' : '';
  return '<span class="company-link" onclick="openNotesModal('+row.rowIndex+')">'+esc(row.company)+'</span>'+noteIcon;
}

// =============================================
// UNASSIGNED REQUESTS
// =============================================
function renderUnassigned() {
  const rows = allData.filter(r => !r.trainer || !r.trainer.trim() || r.status === 'Unassigned');
  document.getElementById('unassignedBadge').textContent = rows.length;
  document.getElementById('unassignedDot').style.display = rows.length>0?'block':'none';
  const tbody = document.getElementById('unassignedBody');
  if (rows.length===0) {
    tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon">&#9989;</div><div class="empty-state-text">No unassigned requests</div></div></td></tr>';
    return;
  }
  tbody.innerHTML = rows.map(r => {
    const stale = isStale(r);
    return '<tr class="'+(stale?'row-stale':'')+'">'
      +'<td style="white-space:nowrap;font-size:12px;color:var(--text--dark--30);">'+formatDate(r.date||r.timestamp)+(stale?'<br>'+staleTag():'')+'</td>'
      +'<td>'+companyCell(r)+'<br><span style="font-size:11px;color:var(--text--dark--30);">'+esc(r.contact||'')+'</span></td>'
      +'<td style="font-size:12px;color:var(--text--dark--40);">'+esc(r.contact||'')+'</td>'
      +'<td><span class="option-badge opt-'+r.option+'">Opt '+r.option+'  '+esc(r.optionLabel)+'</span></td>'
      +'<td style="font-size:12px;color:var(--text--dark--30);">'+esc(r.preferredDate||'')+'</td>'
      +'<td><div style="display:flex;gap:6px;align-items:center;">'
        +'<button class="btn btn-primary btn-sm" onclick="openAssignModal('+r.rowIndex+')">&#10003; Assign</button>'
        +'<button class="btn btn-ghost btn-sm" onclick="openNotesModal('+r.rowIndex+')">&#128221; Notes</button>'
      +'</div></td>'
      +'</tr>';
  }).join('');
}

// =============================================
// ASSIGN MODAL
// =============================================
function openAssignModal(rowIndex) {
  const row = allData.find(r=>r.rowIndex===rowIndex); if (!row) return;
  _assignRowIndex = rowIndex;
  document.getElementById('assignModalCompany').textContent = row.company||'Assign Trainer';
  document.getElementById('assignModalContact').textContent = (row.contact||'') + (row.option?'  Opt '+row.option+'  '+row.optionLabel:'');
  document.getElementById('assignModalOption').innerHTML = '<span class="option-badge opt-'+row.option+'">Opt '+row.option+'  '+esc(row.optionLabel)+'</span>  Preferred: '+esc(row.preferredDate||'Not specified');
  const sel = document.getElementById('assignTrainerSel');
  sel.innerHTML = '<option value=""> Select trainer </option>' + TRAINERS.map(t=>'<option value="'+t+'">'+t+'</option>').join('');
  document.getElementById('assignOverlay').classList.add('open');
  setTimeout(()=>sel.focus(),100);
}
function closeAssignModal() { document.getElementById('assignOverlay').classList.remove('open'); _assignRowIndex=null; }

async function confirmAssign() {
  const trainer = document.getElementById('assignTrainerSel').value;
  if (!trainer) { showToast('Please select a trainer','error'); return; }
  const rowIndex = _assignRowIndex;
  const row = allData.find(r=>r.rowIndex===rowIndex);
  if (!row) return;
  row.trainer = trainer;
  row.status = 'Pending';
  saveOverride(rowIndex, {trainer, status:'Pending'});
  closeAssignModal();
  logActivity('assign', row.company, 'Assigned to '+trainer+', set to Pending', getCurrentUser()?.name||'Unknown');
  showToast(' Assigned to '+trainer,'success');
  const url = APPS_SCRIPT_URL+'?action=assign&row='+rowIndex+'&trainer='+encodeURIComponent(trainer)+'&status=Pending';
  try { await fetch(url,{method:'GET',redirect:'follow',mode:'no-cors'}); } catch(e) {}
  processData();
}

// =============================================
// NEEDS ACTION (PENDING)
// =============================================
function renderActionPanel() {
  const rows = allData.filter(r => r.status==='Pending');
  document.getElementById('actionBadge').textContent = rows.length;
  document.getElementById('actionDot').style.display = rows.length>0?'block':'none';
  const tbody = document.getElementById('actionBody');
  if (rows.length===0) {
    tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">&#9989;</div><div class="empty-state-text">Nothing needs action right now</div></div></td></tr>';
    return;
  }
  const admin = isAdmin();
  tbody.innerHTML = rows.map(r => {
    const stale = isStale(r);
    const color = getTrainerColor(r.trainer);
    const trainerHtml = r.trainer
      ? '<span class="trainer-pill" style="background:'+color+'22;color:'+color+';">'+esc(r.trainer)+'</span>'
      : '<span style="color:var(--text--dark--20);font-size:12px;"></span>';
    const statusHtml = admin
      ? '<div style="display:flex;gap:6px;">'
          +'<button class="btn btn-success btn-sm" onclick="openBookModal('+r.rowIndex+')">&#128200; Book</button>'
          +'<button class="btn btn-danger btn-sm" onclick="openCancelModal('+r.rowIndex+')">&#10007; Cancel</button>'
        +'</div>'
      : '<span class="status-badge status-pending">Pending</span>';
    return '<tr class="'+(stale?'row-stale':'')+'">'
      +'<td style="white-space:nowrap;font-size:12px;color:var(--text--dark--30);">'+formatDate(r.date||r.timestamp)+(stale?'<br>'+staleTag():'')+'</td>'
      +'<td>'+companyCell(r)+'</td>'
      +'<td style="font-size:12px;">'+esc(r.contact||'')+'</td>'
      +'<td><span class="option-badge opt-'+r.option+'">Opt '+r.option+'</span></td>'
      +'<td style="font-size:12px;color:var(--text--dark--30);">'+esc(r.preferredDate||'')+'</td>'
      +'<td>'+trainerHtml+'</td>'
      +'<td>'+statusHtml+'<div style="margin-top:4px;"><button class="btn btn-ghost btn-sm" onclick="openNotesModal('+r.rowIndex+')">&#128221; Notes</button></div></td>'
      +'</tr>';
  }).join('');
}

// =============================================
// BOOKING MODAL
// =============================================
function openBookModal(rowIndex) {
  if (!isAdmin()) { showToast('Admin access required','error'); return; }
  const row = allData.find(r=>r.rowIndex===rowIndex); if (!row) return;
  _bookRowIndex = rowIndex;
  document.getElementById('bookModalCompany').textContent = row.company + (row.contact?'  '+row.contact:'');
  document.getElementById('bookDate').value = row.bookedOn||row.preferredDate||'';
  document.getElementById('bookDays').value = row.trainingDays||OPTION_DAYS[row.option]||1;
  document.getElementById('bookValue').value = row.revenue||OPTION_PRICES[row.option]||'';
  document.getElementById('bookValueHint').textContent = 'Default for Opt '+row.option+': '+(OPTION_PRICES[row.option]||0).toLocaleString();
  // Populate trainer dropdown
  const sel = document.getElementById('bookTrainer');
  sel.innerHTML = '<option value=""> Select trainer </option>' + TRAINERS.map(t=>'<option value="'+t+'"'+(t===row.trainer?' selected':'')+'>'+t+'</option>').join('');
  document.getElementById('bookWarnings').innerHTML = '';
  document.getElementById('bookingBlockMsg').style.display='none';
  document.getElementById('confirmBookBtn').disabled=false;
  document.getElementById('bookOverlay').classList.add('open');
  checkBookingWarnings();
}
function closeBookModal() { document.getElementById('bookOverlay').classList.remove('open'); _bookRowIndex=null; }

function checkBookingWarnings() {
  const dateStr = document.getElementById('bookDate').value;
  const numDays = parseInt(document.getElementById('bookDays').value)||1;
  const trainer = document.getElementById('bookTrainer').value;
  const warnings = [];
  let hardBlock = false;

  if (dateStr) {
    const d = new Date(dateStr+'T00:00:00');
    if (isWeekend(d)) warnings.push({type:'warn', msg:' Training date falls on a weekend.'});
    if (isBankHoliday(dateStr)) warnings.push({type:'warn', msg:' Training date is a UK bank holiday.'});
    // Check all blocked dates
    const blocked = getBlockedDates(dateStr, numDays);
    [...blocked.training].forEach(ds => {
      const bd = new Date(ds+'T00:00:00');
      if (isWeekend(bd)) warnings.push({type:'warn', msg:' Training day '+ds+' falls on a weekend.'});
      if (isBankHoliday(ds)) warnings.push({type:'warn', msg:' Training day '+ds+' is a bank holiday.'});
    });
    // Check double booking (hard block)
    if (trainer) {
      const allBlocked = [...blocked.travel, ...blocked.training, ...blocked.admin];
      const conflict = allData.find(r => {
        if (r.rowIndex===_bookRowIndex) return false;
        if (r.status!=='Booked') return false;
        if (r.trainer!==trainer) return false;
        if (!r.bookedOn) return false;
        const otherBlocked = getBlockedDates(r.bookedOn, r.trainingDays||OPTION_DAYS[r.option]||1);
        const otherAll = [...otherBlocked.travel,...otherBlocked.training,...otherBlocked.admin];
        return allBlocked.some(d=>otherAll.includes(d));
      });
      if (conflict) {
        warnings.push({type:'error', msg:' DOUBLE BOOKING: '+trainer+' is already assigned to '+conflict.company+' on overlapping dates. You cannot book this trainer here.'});
        hardBlock = true;
      }
    }
  }

  const wrap = document.getElementById('bookWarnings');
  wrap.innerHTML = warnings.map(w=>'<div class="warning-box '+w.type+'"><span>'+(w.type==='error'?'':'')+'</span><span>'+esc(w.msg.replace(/^ |^ /,''))+'</span></div>').join('');
  const blockMsg = document.getElementById('bookingBlockMsg');
  const btn = document.getElementById('confirmBookBtn');
  if (hardBlock) {
    blockMsg.textContent='Cannot confirm  trainer double booking detected';
    blockMsg.style.display='';
    btn.disabled=true;
  } else {
    blockMsg.style.display='none';
    btn.disabled=false;
  }
}

async function confirmBook() {
  if (!isAdmin()) { showToast('Admin access required','error'); return; }
  const dateStr = document.getElementById('bookDate').value;
  const numDays = parseInt(document.getElementById('bookDays').value)||1;
  const trainer = document.getElementById('bookTrainer').value;
  const value   = parseFloat(document.getElementById('bookValue').value)||0;
  // Validate
  if (!dateStr) { document.getElementById('bookDate').classList.add('error'); showToast('Please enter a booking date','error'); return; }
  if (!trainer) { document.getElementById('bookTrainer').classList.add('error'); showToast('Please select a trainer','error'); return; }
  if (!value)   { document.getElementById('bookValue').classList.add('error'); showToast('Please enter an invoice value','error'); return; }
  // Double-check no double booking
  const blocked = getBlockedDates(dateStr, numDays);
  const allBlocked = [...blocked.travel,...blocked.training,...blocked.admin];
  const conflict = allData.find(r => {
    if (r.rowIndex===_bookRowIndex||r.status!=='Booked'||r.trainer!==trainer||!r.bookedOn) return false;
    const ob = getBlockedDates(r.bookedOn, r.trainingDays||OPTION_DAYS[r.option]||1);
    const oa = [...ob.travel,...ob.training,...ob.admin];
    return allBlocked.some(d=>oa.includes(d));
  });
  if (conflict) { showToast('Cannot book  trainer '+trainer+' has a conflict with '+conflict.company,'error'); return; }

  const rowIndex = _bookRowIndex;
  const row = allData.find(r=>r.rowIndex===rowIndex);
  if (!row) return;
  row.status='Booked'; row.bookedOn=dateStr; row.trainer=trainer; row.revenue=value; row.trainingDays=numDays;
  saveOverride(rowIndex, {status:'Booked', bookedOn:dateStr, trainer, revenue:value, trainingDays:numDays});
  closeBookModal();
  logActivity('book', row.company, 'Booked on '+dateStr+' with '+trainer+' ('+numDays+'d, '+value.toLocaleString()+')', getCurrentUser()?.name||'Unknown');
  showToast(' Booking confirmed  '+row.company,'success');
  const url=APPS_SCRIPT_URL+'?action=assign&row='+rowIndex+'&status=Booked&bookedOn='+encodeURIComponent(dateStr)+'&trainer='+encodeURIComponent(trainer)+'&value='+value+'&trainingDays='+numDays;
  try { await fetch(url,{method:'GET',redirect:'follow',mode:'no-cors'}); } catch(e) {}
  processData();
}

// =============================================
// CANCEL MODAL
// =============================================
function openCancelModal(rowIndex) {
  if (!isAdmin()) { showToast('Admin access required','error'); return; }
  const row = allData.find(r=>r.rowIndex===rowIndex); if (!row) return;
  _cancelRowIndex = rowIndex;
  document.getElementById('cancelModalCompany').textContent = row.company + (row.contact?'  '+row.contact:'');
  document.getElementById('cancelReason').value = '';
  document.getElementById('cancelOverlay').classList.add('open');
}
function closeCancelModal() { document.getElementById('cancelOverlay').classList.remove('open'); _cancelRowIndex=null; }

async function confirmCancel() {
  if (!isAdmin()) { showToast('Admin access required','error'); return; }
  const reason = document.getElementById('cancelReason').value.trim();
  if (!reason) { document.getElementById('cancelReason').classList.add('error'); showToast('Please enter a cancellation reason','error'); return; }
  const rowIndex = _cancelRowIndex;
  const row = allData.find(r=>r.rowIndex===rowIndex);
  if (!row) return;
  const who = getCurrentUser()?.name||'Unknown';
  // Save reason to notes
  saveNoteForRow(rowIndex, '[CANCELLED] '+reason, who);
  row.status='Cancelled'; row.trainer=row.trainer||'';
  saveOverride(rowIndex, {status:'Cancelled'});
  closeCancelModal();
  logActivity('cancel', row.company, 'Cancelled  '+reason, who);
  showToast('Enquiry cancelled','');
  const url=APPS_SCRIPT_URL+'?action=assign&row='+rowIndex+'&status=Cancelled';
  try { await fetch(url,{method:'GET',redirect:'follow',mode:'no-cors'}); } catch(e) {}
  processData();
}

// =============================================
// NOTES MODAL
// =============================================
function openNotesModal(rowIndex) {
  const row = allData.find(r=>r.rowIndex===rowIndex); if (!row) return;
  _notesRowIndex = rowIndex;
  document.getElementById('notesModalCompany').textContent = row.company + (row.contact?'  '+row.contact:'') + '  '+row.optionLabel;
  document.getElementById('newNoteText').value = '';
  renderNotesList(rowIndex);
  document.getElementById('notesOverlay').classList.add('open');
}
function closeNotesModal() { document.getElementById('notesOverlay').classList.remove('open'); _notesRowIndex=null; }

function renderNotesList(rowIndex) {
  const notes = getNotesForRow(rowIndex);
  const el = document.getElementById('notesList');
  if (!notes.length) {
    el.innerHTML = '<div style="text-align:center;color:var(--text--dark--30);padding:20px;">No notes yet. Add one below.</div>';
    return;
  }
  const MONTHS=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  el.innerHTML = notes.map(n => {
    const d=new Date(n.time);
    const timeStr = d.getDate()+' '+MONTHS[d.getMonth()]+' '+d.getFullYear()+', '+d.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
    const isCancelled = n.text.startsWith('[CANCELLED]');
    const borderColor = isCancelled ? '#c0303d' : 'var(--action-primary-blue)';
    return '<div class="note-item" style="border-left-color:'+borderColor+';">'
      +'<div class="note-meta">'+esc(n.author)+' &middot; '+timeStr+'</div>'
      +'<div class="note-text">'+esc(n.text)+'</div>'
      +'</div>';
  }).join('');
}

function saveNote() {
  const text = document.getElementById('newNoteText').value.trim();
  if (!text) { showToast('Please enter a note','error'); return; }
  const who = getCurrentUser()?.name||'Unknown';
  saveNoteForRow(_notesRowIndex, text, who);
  document.getElementById('newNoteText').value='';
  renderNotesList(_notesRowIndex);
  logActivity('note', allData.find(r=>r.rowIndex===_notesRowIndex)?.company||'', 'Note added by '+who, text.slice(0,80));
  showToast('Note saved','success');
  renderUnassigned(); renderActionPanel();
}

// =============================================
// CALENDAR EVENT MODAL
// =============================================
function openCalEventModal(eventData) {
  const header = document.getElementById('calEventHeader');
  const trainerColor = eventData.trainer ? getTrainerColor(eventData.trainer) : '#777';
  header.style.background = eventData.type==='travel'?'#92400e':eventData.type==='admin'?'#3730a3':trainerColor;
  document.getElementById('calEventTitle').textContent = eventData.title;
  document.getElementById('calEventSubtitle').textContent = eventData.dateStr + (eventData.trainer?'  '+eventData.trainer:'');
  let body='';
  if (eventData.type==='training'||eventData.type==='booking') {
    body += '<div style="margin-bottom:12px;"><strong>'+esc(eventData.company||eventData.title)+'</strong></div>';
    if (eventData.contact) body += '<div style="margin-bottom:8px;font-size:12px;color:var(--text--dark--40);">Contact: '+esc(eventData.contact)+'</div>';
    if (eventData.option) body += '<div style="margin-bottom:8px;"><span class="option-badge opt-'+eventData.option+'">Opt '+eventData.option+'  '+esc(eventData.optionLabel)+'</span></div>';
    if (eventData.trainer) body += '<div style="margin-bottom:8px;font-size:12px;"><span class="trainer-pill" style="background:'+trainerColor+'22;color:'+trainerColor+';">'+esc(eventData.trainer)+'</span></div>';
    if (eventData.revenue) body += '<div style="font-size:13px;font-weight:600;color:var(--action-primary-blue);">&#163;'+Number(eventData.revenue).toLocaleString()+'</div>';
    if (eventData.trainingDays) body += '<div style="font-size:12px;color:var(--text--dark--30);margin-top:4px;">'+eventData.trainingDays+' training day'+(eventData.trainingDays>1?'s':'')+'</div>';
  } else {
    body = '<div style="font-size:12px;color:var(--text--dark--40);">'+esc(eventData.description||eventData.title)+'</div>';
    if (eventData.type==='travel') body += '<div style="margin-top:8px;font-size:12px;color:#92400e;">Travel day for: <strong>'+esc(eventData.forCompany||'')+'</strong></div>';
    if (eventData.type==='admin') body += '<div style="margin-top:8px;font-size:12px;color:#3730a3;">Admin day after: <strong>'+esc(eventData.forCompany||'')+'</strong></div>';
  }
  document.getElementById('calEventBody').innerHTML = body;
  document.getElementById('calEventOverlay').classList.add('open');
}
function closeCalEventModal() { document.getElementById('calEventOverlay').classList.remove('open'); }

// =============================================
// CALENDAR
// =============================================
const CAL_SETTINGS_KEY = 'streetDashboardCalSettings';
function getCalSettings() { try { return JSON.parse(localStorage.getItem(CAL_SETTINGS_KEY)||'{}'); } catch(e) { return {}; } }
function saveCalSettingsData(d) { try { localStorage.setItem(CAL_SETTINGS_KEY,JSON.stringify(d)); } catch(e) {} }

function calChangeMonth(dir) {
  calState.month+=dir;
  if (calState.month>11){calState.month=0;calState.year++;}
  if (calState.month<0){calState.month=11;calState.year--;}
  renderCalendar(); renderUpcoming();
}

function populateCalTrainerFilter() {
  const sel = document.getElementById('calFilterTrainer'); if (!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">All Trainers</option>' + TRAINERS.map(t=>'<option value="'+t+'"'+(t===cur?' selected':'')+'>'+t+'</option>').join('');
}

// Build calendar events from allData (Booked only)
function buildCalEvents(trainerFilter) {
  const events = {}; // dateStr -> [{type,title,color,trainer,company,...}]
  const addEvent = (dateStr, ev) => {
    if (!events[dateStr]) events[dateStr] = [];
    events[dateStr].push(ev);
  };
  allData.forEach(r => {
    if (r.status!=='Booked'||!r.bookedOn) return;
    if (trainerFilter && r.trainer!==trainerFilter) return;
    const numDays = r.trainingDays||OPTION_DAYS[r.option]||1;
    const blocked = getBlockedDates(r.bookedOn, numDays);
    const color = getTrainerColor(r.trainer);
    // Travel
    blocked.travel.forEach(ds => addEvent(ds, {type:'travel',title:'Travel  '+r.company,dateStr:ds,trainer:r.trainer,company:r.company,forCompany:r.company}));
    // Training days
    blocked.training.forEach((ds,i) => addEvent(ds, {type:'training',title:(numDays>1?'Day '+(i+1)+': ':'')+r.company,dateStr:ds,trainer:r.trainer,company:r.company,contact:r.contact,option:r.option,optionLabel:r.optionLabel,revenue:r.revenue,trainingDays:numDays,color}));
    // Admin
    blocked.admin.forEach(ds => addEvent(ds, {type:'admin',title:'Admin  '+r.company,dateStr:ds,trainer:r.trainer,company:r.company,forCompany:r.company}));
  });
  return events;
}

function renderCalendar() {
  const {year,month}=calState;
  const tf = document.getElementById('calFilterTrainer')?.value||'';
  const MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('calMonthTitle').textContent = MONTHS[month]+' '+year;
  const firstDay=new Date(year,month,1), lastDay=new Date(year,month+1,0);
  const todayStr=toDateStr(new Date());
  let startDow=firstDay.getDay(); startDow=startDow===0?6:startDow-1;
  const calEvents = buildCalEvents(tf);
  const container=document.getElementById('calDays'); if(!container) return;
  let cells='';
  for(let i=0;i<startDow;i++) cells+='<div class="cal-day cal-day-empty"></div>';
  for(let d=1;d<=lastDay.getDate();d++) {
    const ds=year+'-'+String(month+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
    const dt=new Date(ds+'T00:00:00');
    const isToday=ds===todayStr, isPast=ds<todayStr;
    const isWE=isWeekend(dt), isBH=isBankHoliday(ds);
    const dayEvts=calEvents[ds]||[];
    const shown=dayEvts.slice(0,3), extra=dayEvts.length-shown.length;
    let cls='cal-day';
    if(isToday) cls+=' cal-day-today';
    if(isPast) cls+=' cal-day-past';
    if(isWE) cls+=' cal-day-weekend';
    if(isBH) cls+=' cal-day-holiday';
    cells+='<div class="'+cls+'">'
      +'<span class="cal-day-num">'+d+(isBH?' ':'')+'</span>'
      +shown.map(ev => {
        const bg=ev.type==='travel'?'#fef3c7':ev.type==='admin'?'#e0e7ff':(ev.color||'#b8caff');
        const tc=ev.type==='travel'?'#92400e':ev.type==='admin'?'#3730a3':'#fff';
        const evtJson=encodeURIComponent(JSON.stringify(ev));
        return '<span class="cal-event" style="background:'+bg+';color:'+tc+';" onclick="openCalEventModal(JSON.parse(decodeURIComponent(\''+evtJson+'\')))" title="'+esc(ev.title)+(ev.trainer?' ('+ev.trainer+')':'')+'">'+esc(ev.title)+'</span>';
      }).join('')
      +(extra>0?'<span class="cal-event-more">+'+extra+' more</span>':'')
      +'</div>';
  }
  container.innerHTML=cells;
}

function renderUpcoming() {
  const body=document.getElementById('calUpcomingBody'), count=document.getElementById('calUpcomingCount');
  if (!body) return;
  const todayStr=toDateStr(new Date()), limit=new Date(Date.now()+60*86400*1000);
  const limitStr=toDateStr(limit);
  const items=[];
  allData.forEach(r => {
    if(r.status!=='Booked'||!r.bookedOn) return;
    if(r.bookedOn<todayStr||r.bookedOn>limitStr) return;
    items.push({date:r.bookedOn,company:r.company,trainer:r.trainer,option:r.option,optionLabel:r.optionLabel,trainingDays:r.trainingDays||OPTION_DAYS[r.option]||1});
  });
  items.sort((a,b)=>a.date.localeCompare(b.date));
  if(count) count.textContent=items.length+' sessions in next 60 days';
  if(!items.length){body.innerHTML='<div class="cal-upcoming-empty">No upcoming sessions</div>';return;}
  const MS=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  body.innerHTML=items.map(item=>{
    const dt=new Date(item.date+'T00:00:00'),day=dt.getDate(),mon=MS[dt.getMonth()];
    const color=getTrainerColor(item.trainer);
    return '<div class="cal-upcoming-item">'
      +'<div class="cal-upcoming-date"><div class="cal-upcoming-date-day">'+day+'</div><div class="cal-upcoming-date-mon">'+mon+'</div></div>'
      +'<div class="cal-upcoming-body-text">'
        +'<div class="cal-upcoming-company">'+esc(item.company)+'</div>'
        +'<div class="cal-upcoming-meta">'+(item.trainer?'<span style="color:'+color+';font-weight:600;">'+esc(item.trainer)+'</span> &middot; ':'')+item.trainingDays+' day'+(item.trainingDays>1?'s':'')+'  Opt '+item.option+'</div>'
      +'</div>'
      +'</div>';
  }).join('');
}

// =============================================
// TRAINER WORKLOAD
// =============================================
function renderTrainerWorkload() {
  const cutoff=new Date(); cutoff.setDate(cutoff.getDate()-30);
  const counts={},upcoming={};
  TRAINERS.forEach(t=>{counts[t]=0;upcoming[t]=0;});
  const now=new Date();
  allData.forEach(r=>{
    if(!r.trainer||!counts.hasOwnProperty(r.trainer)||r.status==='Cancelled') return;
    const d=r.date;
    if(d&&d>=cutoff&&d<=now) counts[r.trainer]++;
    if(r.status==='Booked'&&r.bookedOn){const bd=new Date(r.bookedOn+'T00:00:00');if(bd>=now) upcoming[r.trainer]++;}
    if(r.status==='Pending') upcoming[r.trainer]++;
  });
  const maxCount=Math.max(1,...Object.values(counts));
  const grid=document.getElementById('trainerGrid');
  if (!TRAINERS.length){grid.innerHTML='<div style="text-align:center;color:var(--text--dark--30);font-size:12px;grid-column:1/-1;">No trainers configured. Use Manage Trainers to add team members.</div>';return;}
  grid.innerHTML=TRAINERS.map((t,i)=>{
    const color=TRAINER_PALETTE[i%TRAINER_PALETTE.length];
    const pct=Math.round((counts[t]/maxCount)*100);
    const nextFree=getNextFreeDate(t,1);
    const nextFreeHtml=nextFree
      ?'<div class="next-free-tag"> Next free: <strong>'+nextFree+'</strong></div>'
      :'<div class="next-free-tag busy"> Busy  no free days in 21 days</div>';
    return '<div class="trainer-card">'
      +'<div class="trainer-name"><div class="trainer-color-dot" style="background:'+color+'"></div>'+esc(t)+'</div>'
      +'<div class="trainer-stat"><span>Last 30 days</span><span class="trainer-stat-val">'+counts[t]+'</span></div>'
      +'<div class="trainer-stat"><span>Upcoming</span><span class="trainer-stat-val">'+upcoming[t]+'</span></div>'
      +'<div class="workload-bar-wrap"><div class="workload-bar" style="width:'+pct+'%;background:'+color+';"></div></div>'
      +nextFreeHtml
      +'</div>';
  }).join('');
}

// Find next free date for a trainer (travel+training+admin all clear of weekends, bank holidays, other bookings)
function getNextFreeDate(trainer, numTrainingDays) {
  for (let i=1;i<=21;i++) {
    const start=addDays(new Date(),i);
    if (!isWorkday(start)) continue;
    const blocked=getBlockedDates(toDateStr(start),numTrainingDays);
    const allDs=[...blocked.travel,...blocked.training,...blocked.admin];
    // Check none of these days are weekends/BH
    if (allDs.some(ds=>{const d=new Date(ds+'T00:00:00');return isWeekend(d)||isBankHoliday(ds);})) continue;
    // Check no conflicts with existing bookings
    const hasConflict=allData.some(r=>{
      if(r.trainer!==trainer||r.status!=='Booked'||!r.bookedOn) return false;
      const ob=getBlockedDates(r.bookedOn,r.trainingDays||OPTION_DAYS[r.option]||1);
      const oa=[...ob.travel,...ob.training,...ob.admin];
      return allDs.some(d=>oa.includes(d));
    });
    if (!hasConflict) return start.toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'});
  }
  return null;
}

// =============================================
// KPIs
// =============================================
function kpiDate(r) {
  if(r.bookedOn){const d=parseDate(r.bookedOn);if(d&&!isNaN(d))return d;} return r.date||null;
}

function renderKPIs() {
  const now=new Date(),year=now.getFullYear(),month=now.getMonth();
  const lastMonth=month===0?11:month-1,lastMonthYear=month===0?year-1:year;
  const thisYearRows=allData.filter(r=>{const d=kpiDate(r);return d&&d.getFullYear()===year&&r.option!=='1'&&r.status==='Booked';});
  const thisMonthRows=allData.filter(r=>{const d=kpiDate(r);return d&&d.getFullYear()===year&&d.getMonth()===month&&r.option!=='1'&&r.status==='Booked';});
  const lastMonthRows=allData.filter(r=>{const d=kpiDate(r);return d&&d.getFullYear()===lastMonthYear&&d.getMonth()===lastMonth&&r.option!=='1'&&r.status==='Booked';});
  const revYear=thisYearRows.reduce((s,r)=>s+r.revenue,0);
  const revMonth=thisMonthRows.reduce((s,r)=>s+r.revenue,0);
  const revLastMonth=lastMonthRows.reduce((s,r)=>s+r.revenue,0);
  const avgFee=thisYearRows.filter(r=>r.revenue>0).length?Math.round(revYear/thisYearRows.filter(r=>r.revenue>0).length):0;
  const daysYear=thisYearRows.reduce((s,r)=>s+(r.trainingDays||OPTION_DAYS[r.option]||0),0);
  const daysMonth=thisMonthRows.reduce((s,r)=>s+(r.trainingDays||OPTION_DAYS[r.option]||0),0);
  document.getElementById('kpiRevYear').textContent=''+revYear.toLocaleString();
  document.getElementById('kpiRevMonth').textContent=''+revMonth.toLocaleString();
  document.getElementById('kpiAvgFee').textContent=avgFee?''+avgFee.toLocaleString():'';
  document.getElementById('kpiDaysYear').textContent=daysYear;
  document.getElementById('kpiDaysMonth').textContent=daysMonth+' this month';
  document.getElementById('kpiBookingsYear').textContent=thisYearRows.length;
  document.getElementById('kpiBookingsMonth').textContent=thisMonthRows.length+' this month';
  const deltaEl=document.getElementById('kpiRevMonthDelta');
  if(revLastMonth>0){const pct=Math.round(((revMonth-revLastMonth)/revLastMonth)*100),up=pct>=0;deltaEl.innerHTML='<span class="kpi-card-delta '+(up?'delta-up':'delta-down')+'">'+(up?'':'')+' '+Math.abs(pct)+'% vs last month</span>';}
  const MONTHS=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  document.getElementById('thisMonthLabel').textContent=MONTHS[month];
  document.getElementById('lastMonthLabel').textContent=MONTHS[lastMonth];
  document.getElementById('thisMonthRev').textContent=''+revMonth.toLocaleString();
  document.getElementById('lastMonthRev').textContent=''+revLastMonth.toLocaleString();
}

// =============================================
// KPI MODAL
// =============================================
function openKpiModal(type) {
  const now=new Date(),year=now.getFullYear(),month=now.getMonth();
  const rows=allData.filter(r=>r.status==='Booked'&&r.option!=='1');
  const MONTHS_SHORT=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  let config={};
  if(type==='revYear'){
    const yr=rows.filter(r=>{const d=kpiDate(r);return d&&d.getFullYear()===year;});
    const total=yr.reduce((s,r)=>s+r.revenue,0);
    config={title:'Total Revenue '+year,subtitle:'All booked sessions',headline:''+total.toLocaleString(),
      stats:[{label:'Sessions',value:yr.length},{label:'Revenue',value:''+total.toLocaleString()},{label:'Best Trainer',value:topByRevenue(yr)},{label:'Avg Fee',value:''+(yr.filter(r=>r.revenue>0).length?Math.round(total/yr.filter(r=>r.revenue>0).length).toLocaleString():'')}],
      rows:yr.sort((a,b)=>(kpiDate(b)||0)-(kpiDate(a)||0))};
  } else if(type==='revMonth'){
    const mr=rows.filter(r=>{const d=kpiDate(r);return d&&d.getFullYear()===year&&d.getMonth()===month;});
    config={title:'Revenue '+MONTHS_SHORT[month]+' '+year,subtitle:'Booked sessions this month',headline:''+mr.reduce((s,r)=>s+r.revenue,0).toLocaleString(),
      stats:[{label:'Sessions',value:mr.length},{label:'Revenue',value:''+mr.reduce((s,r)=>s+r.revenue,0).toLocaleString()},{label:'Top Trainer',value:topByRevenue(mr)},{label:'Days',value:mr.reduce((s,r)=>s+(r.trainingDays||OPTION_DAYS[r.option]||0),0)}],
      rows:mr};
  } else if(type==='avgFee'){
    const yr=rows.filter(r=>{const d=kpiDate(r);return d&&d.getFullYear()===year;});
    const avg=yr.filter(r=>r.revenue>0).length?Math.round(yr.reduce((s,r)=>s+r.revenue,0)/yr.filter(r=>r.revenue>0).length):0;
    config={title:'Average Fee '+year,subtitle:'Per confirmed booking',headline:''+avg.toLocaleString(),
      stats:[{label:'Sessions',value:yr.length},{label:'Avg Fee',value:''+avg.toLocaleString()},{label:'Highest',value:''+(yr.length?Math.max(...yr.map(r=>r.revenue)).toLocaleString():'')},{label:'Lowest',value:''+(yr.filter(r=>r.revenue>0).length?Math.min(...yr.filter(r=>r.revenue>0).map(r=>r.revenue)).toLocaleString():'')}],
      rows:yr.sort((a,b)=>b.revenue-a.revenue)};
  } else if(type==='days'){
    const yr=rows.filter(r=>{const d=kpiDate(r);return d&&d.getFullYear()===year;});
    const totalDays=yr.reduce((s,r)=>s+(r.trainingDays||OPTION_DAYS[r.option]||0),0);
    config={title:'Training Days '+year,subtitle:'Based on confirmed bookings',headline:totalDays+' days',
      stats:[{label:'Sessions',value:yr.length},{label:'Total Days',value:totalDays},{label:'Top Trainer',value:topByDays(yr)},{label:'Avg Days',value:yr.length?(totalDays/yr.length).toFixed(1):''}],
      rows:yr.sort((a,b)=>(b.trainingDays||0)-(a.trainingDays||0))};
  } else if(type==='bookings'){
    const yr=rows.filter(r=>{const d=kpiDate(r);return d&&d.getFullYear()===year;});
    config={title:'Bookings '+year,subtitle:'All confirmed sessions',headline:yr.length+' bookings',
      stats:[{label:'Total',value:yr.length},{label:'This Month',value:yr.filter(r=>{const d=kpiDate(r);return d&&d.getMonth()===month;}).length},{label:'Top Trainer',value:topByCount(yr)},{label:'Revenue',value:''+yr.reduce((s,r)=>s+r.revenue,0).toLocaleString()}],
      rows:yr.sort((a,b)=>(kpiDate(b)||0)-(kpiDate(a)||0))};
  }
  document.getElementById('kpiModalTitle').textContent=config.title||'';
  document.getElementById('kpiModalSubtitle').textContent=config.subtitle||'';
  const statGrid=document.getElementById('kpiStatGrid');
  statGrid.innerHTML=(config.stats||[]).map(s=>'<div class="kpi-stat"><div class="kpi-stat-label">'+esc(s.label)+'</div><div class="kpi-stat-value">'+esc(String(s.value))+'</div></div>').join('');
  document.getElementById('kpiModalTableHead').innerHTML='<tr style="background:var(--card-light-grey);"><th style="padding:8px 12px;font-size:11px;font-weight:700;text-transform:uppercase;color:var(--text--dark--30);">Date</th><th style="padding:8px 12px;font-size:11px;font-weight:700;text-transform:uppercase;color:var(--text--dark--30);">Company</th><th style="padding:8px 12px;font-size:11px;font-weight:700;text-transform:uppercase;color:var(--text--dark--30);">Trainer</th><th style="padding:8px 12px;font-size:11px;font-weight:700;text-transform:uppercase;color:var(--text--dark--30);">Days</th><th style="padding:8px 12px;text-align:right;font-size:11px;font-weight:700;text-transform:uppercase;color:var(--text--dark--30);">Revenue</th></tr>';
  document.getElementById('kpiModalTableBody').innerHTML=(config.rows||[]).slice(0,50).map(r=>'<tr style="border-bottom:1px solid var(--ui--underline--light-grey);"><td style="padding:8px 12px;font-size:12px;white-space:nowrap;">'+formatDate(kpiDate(r))+'</td><td style="padding:8px 12px;font-size:12px;font-weight:600;">'+esc(r.company)+'</td><td style="padding:8px 12px;font-size:12px;">'+esc(r.trainer||'')+'</td><td style="padding:8px 12px;font-size:12px;text-align:center;">'+(r.trainingDays||OPTION_DAYS[r.option]||0)+'</td><td style="padding:8px 12px;font-size:12px;text-align:right;font-weight:600;">'+r.revenue.toLocaleString()+'</td></tr>').join('');
  document.getElementById('kpiModalOverlay').classList.add('open');
}
function topByRevenue(rows){const t={};rows.forEach(r=>{if(r.trainer){if(!t[r.trainer])t[r.trainer]=0;t[r.trainer]+=r.revenue;}});const s=Object.entries(t).sort((a,b)=>b[1]-a[1]);return s.length?s[0][0]:'';}
function topByDays(rows){const t={};rows.forEach(r=>{if(r.trainer){if(!t[r.trainer])t[r.trainer]=0;t[r.trainer]+=(r.trainingDays||OPTION_DAYS[r.option]||0);}});const s=Object.entries(t).sort((a,b)=>b[1]-a[1]);return s.length?s[0][0]:'';}
function topByCount(rows){const t={};rows.forEach(r=>{if(r.trainer){if(!t[r.trainer])t[r.trainer]=0;t[r.trainer]++;}});const s=Object.entries(t).sort((a,b)=>b[1]-a[1]);return s.length?s[0][0]:'';}

// =============================================
// CHARTS
// =============================================
function renderCharts() { renderRevenueChart(); renderOptionChart(); }
function renderRevenueChart() {
  const now=new Date(),year=now.getFullYear(),lastYear=year-1;
  const MONTHS=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const ty=Array(12).fill(0),ly=Array(12).fill(0);
  allData.forEach(r=>{if(r.option==='1'||r.status!=='Booked')return;const d=kpiDate(r);if(!d)return;const y=d.getFullYear(),m=d.getMonth();if(y===year)ty[m]+=r.revenue;else if(y===lastYear)ly[m]+=r.revenue;});
  const ctx=document.getElementById('revenueChart').getContext('2d');
  if(revenueChart)revenueChart.destroy();
  revenueChart=new Chart(ctx,{type:'bar',data:{labels:MONTHS,datasets:[{label:String(year),data:ty,backgroundColor:'rgba(33,71,244,0.7)',borderRadius:3,borderSkipped:false},{label:String(lastYear),data:ly,backgroundColor:'rgba(33,71,244,0.2)',borderRadius:3,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{font:{size:11},boxWidth:12}},tooltip:{callbacks:{label:ctx=>''+ctx.raw.toLocaleString()}}},scales:{y:{ticks:{callback:v=>''+v.toLocaleString(),font:{size:11}},grid:{color:'#f3f4f6'}},x:{grid:{display:false},ticks:{font:{size:11}}}}}});
}
function renderOptionChart() {
  const now=new Date(),year=now.getFullYear();
  const counts={'2':0,'3':0,'4':0,'5':0};
  allData.forEach(r=>{if(r.option==='1'||r.status!=='Booked')return;const d=kpiDate(r);if(d&&d.getFullYear()===year&&counts.hasOwnProperty(r.option))counts[r.option]++;});
  const labels=['Opt 2','Opt 3','Opt 4','Opt 5'];
  const values=[counts['2'],counts['3'],counts['4'],counts['5']];
  const ctx=document.getElementById('optionChart').getContext('2d');
  if(optionChart)optionChart.destroy();
  optionChart=new Chart(ctx,{type:'doughnut',data:{labels,datasets:[{data:values,backgroundColor:['#b8caff','#f6be9d','#bde4b9','#beffd8'],borderWidth:2,borderColor:'#fff'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{font:{size:11},boxWidth:12}}}}});
}

// =============================================
// ALL BOOKINGS TABLE
// =============================================
function populateTrainerFilter() {
  const sel=document.getElementById('filterTrainer');if(!sel)return;
  const cur=sel.value;
  sel.innerHTML='<option value="">All Trainers</option>'+TRAINERS.map(t=>'<option value="'+t+'"'+(t===cur?' selected':'')+'>'+t+'</option>').join('');
}

function resetPageAndRender(){currentPage=1;renderAllBookings();}
function changePage(dir){currentPage=Math.max(1,currentPage+dir);renderAllBookings();}
function clearBookingFilters(){document.getElementById('bookingSearch').value='';document.getElementById('filterStatus').value='';document.getElementById('filterTrainer').value='';document.getElementById('filterOption').value='';document.getElementById('filterDateFrom').value='';document.getElementById('filterDateTo').value='';currentPage=1;renderAllBookings();}

function renderAllBookings() {
  const search=(document.getElementById('bookingSearch')?.value||'').toLowerCase();
  const statusF=document.getElementById('filterStatus')?.value||'';
  const trainerF=document.getElementById('filterTrainer')?.value||'';
  const optionF=document.getElementById('filterOption')?.value||'';
  const dateFrom=document.getElementById('filterDateFrom')?.value||'';
  const dateTo=document.getElementById('filterDateTo')?.value||'';
  let filtered=allData.filter(r=>{
    if(statusF&&r.status!==statusF)return false;
    if(trainerF&&r.trainer!==trainerF)return false;
    if(optionF&&r.option!==optionF)return false;
    if(search&&!(r.company+r.contact+r.email).toLowerCase().includes(search))return false;
    const d=kpiDate(r);
    if(dateFrom&&(!d||toDateStr(d)<dateFrom))return false;
    if(dateTo&&(!d||toDateStr(d)>dateTo))return false;
    return true;
  });
  filtered.sort((a,b)=>(kpiDate(b)||new Date(0))-(kpiDate(a)||new Date(0)));
  document.getElementById('allBadge').textContent=filtered.length;
  const total=filtered.length, totalPages=Math.max(1,Math.ceil(total/PAGE_SIZE));
  currentPage=Math.min(currentPage,totalPages);
  const start=(currentPage-1)*PAGE_SIZE, pageRows=filtered.slice(start,start+PAGE_SIZE);
  const tbody=document.getElementById('allBookingsBody');
  if(!pageRows.length){tbody.innerHTML='<tr><td colspan="8"><div class="empty-state"><div class="empty-state-icon">&#128203;</div><div class="empty-state-text">No bookings found</div></div></td></tr>';document.getElementById('allBookingsPagination').style.display='none';return;}
  tbody.innerHTML=pageRows.map(r=>{
    const color=getTrainerColor(r.trainer);
    const tPill=r.trainer?'<span class="trainer-pill" style="background:'+color+'22;color:'+color+';">'+esc(r.trainer)+'</span>':'';
    const days=(r.trainingDays||OPTION_DAYS[r.option]||0);
    return '<tr>'
      +'<td style="white-space:nowrap;font-size:12px;">'+formatDate(kpiDate(r))+'</td>'
      +'<td>'+companyCell(r)+'<br><span style="font-size:11px;color:var(--text--dark--30);">'+esc(r.email||'')+'</span></td>'
      +'<td style="font-size:12px;">'+esc(r.contact||'')+'</td>'
      +'<td><span class="option-badge opt-'+r.option+'">Opt '+r.option+'</span></td>'
      +'<td>'+tPill+'</td>'
      +'<td style="font-size:12px;text-align:center;">'+days+'</td>'
      +'<td style="font-size:13px;font-weight:600;">'+( r.revenue?''+r.revenue.toLocaleString():'')+'</td>'
      +'<td><span class="status-badge status-'+r.status.toLowerCase()+'">'+r.status+'</span></td>'
      +'</tr>';
  }).join('');
  const pag=document.getElementById('allBookingsPagination');
  pag.style.display=total>PAGE_SIZE?'flex':'none';
  document.getElementById('pageInfo').textContent='Page '+currentPage+' of '+totalPages;
  document.getElementById('rowCount').textContent=total+' bookings';
  document.getElementById('prevPageBtn').disabled=currentPage===1;
  document.getElementById('nextPageBtn').disabled=currentPage===totalPages;
}

// =============================================
// TRAINER MANAGEMENT MODAL
// =============================================
function openTrainerModal() {
  if(!isAdmin()){showToast('Admin access required','error');return;}
  renderTrainerList();
  document.getElementById('trainerModalOverlay').classList.add('open');
}
function closeTrainerModal(){document.getElementById('trainerModalOverlay').classList.remove('open');}
function renderTrainerList() {
  const el=document.getElementById('trainerList');
  el.innerHTML=USERS.map((u,i)=>{
    const color=TRAINER_PALETTE[i%TRAINER_PALETTE.length];
    return '<div class="trainer-list-item">'
      +'<div class="trainer-list-name"><div class="trainer-color-dot" style="background:'+color+'"></div>'+esc(u.name)+'<span style="font-size:10px;font-weight:400;color:var(--text--dark--30);">('+u.role+')</span></div>'
      +'<div style="display:flex;gap:6px;align-items:center;">'
        +'<select onchange="changeUserRole(\''+u.name+'\',this.value)" style="font-size:11px;border:1px solid var(--light-grey);border-radius:4px;padding:3px 6px;font-family:Arial,sans-serif;">'
          +'<option value="trainer"'+(u.role==='trainer'?' selected':'')+'>Trainer</option>'
          +'<option value="admin"'+(u.role==='admin'?' selected':'')+'>Admin</option>'
        +'</select>'
        +(USERS.length>1?'<button class="btn btn-danger btn-sm" onclick="removeTrainer(\''+u.name+'\')">Remove</button>':'')
      +'</div>'
      +'</div>';
  }).join('');
}
function changeUserRole(name, role) {
  const u=USERS.find(u=>u.name===name); if(!u) return;
  u.role=role; saveUsers(USERS);
  const cur=getCurrentUser(); if(cur&&cur.name===name){cur.role=role;setCurrentUser(cur);updateHeaderUser();applyPermissions();}
  logActivity('admin',null,name+' role changed to '+role,getCurrentUser()?.name||'');
}
function addTrainer() {
  const inp=document.getElementById('newTrainerName');
  const name=inp.value.trim();
  if(!name){showToast('Enter a trainer name','error');return;}
  if(USERS.find(u=>u.name.toLowerCase()===name.toLowerCase())){showToast('Trainer already exists','error');return;}
  USERS.push({name,role:'trainer'});
  saveUsers(USERS); syncTrainers();
  inp.value='';
  renderTrainerList(); renderTrainerWorkload(); populateTrainerFilter(); populateCalTrainerFilter();
  logActivity('admin',null,'Added trainer: '+name,getCurrentUser()?.name||'');
  showToast('Trainer added','success');
}
function removeTrainer(name) {
  if(!confirm('Remove '+name+' from the trainer list? Their existing bookings will be retained.')) return;
  USERS=USERS.filter(u=>u.name!==name); saveUsers(USERS); syncTrainers();
  renderTrainerList(); renderTrainerWorkload(); populateTrainerFilter(); populateCalTrainerFilter();
  logActivity('admin',null,'Removed trainer: '+name,getCurrentUser()?.name||'');
  showToast('Trainer removed','');
}

// =============================================
// CALENDAR SETTINGS MODAL
// =============================================
function openCalSettings() {
  if(!isAdmin()){showToast('Admin access required','error');return;}
  const s=getCalSettings();
  document.getElementById('calIdInput').value=s.calendarId||'';
  document.getElementById('calSettingsStatus').textContent='';
  document.getElementById('calSettingsOverlay').classList.add('open');
}
function closeCalSettings(){document.getElementById('calSettingsOverlay').classList.remove('open');}
function saveCalSettings(){
  const calId=document.getElementById('calIdInput').value.trim();
  saveCalSettingsData({calendarId:calId});
  document.getElementById('calSettingsStatus').textContent=' Saved';
  setTimeout(closeCalSettings,800);
}

// =============================================
// ACTIVITY FEED
// =============================================
const ACTIVITY_KEY='streetDashboardActivity_v2';
function getActivity(){try{return JSON.parse(localStorage.getItem(ACTIVITY_KEY)||'[]');}catch(e){return[];}}
function logActivity(type,company,what,detail){
  const who=getCurrentUser()?.name||'Unknown';
  const entry={type,company:company||'',what,detail:detail||'',who,time:new Date().toISOString()};
  const log=getActivity();log.unshift(entry);if(log.length>200)log.splice(200);
  try{localStorage.setItem(ACTIVITY_KEY,JSON.stringify(log));}catch(e){}
  initActivityFeed();
  const dot=document.getElementById('activityBtnDot');if(dot)dot.classList.add('visible');
}
function clearActivityLog(){if(!isAdmin()){showToast('Admin access required','error');return;}try{localStorage.removeItem(ACTIVITY_KEY);}catch(e){}initActivityFeed();showToast('Activity log cleared','');}
function initActivityFeed(){
  const log=getActivity();
  const body=document.getElementById('activityFeedBody');
  const countEl=document.getElementById('activityCount');
  if(!body)return;
  if(countEl)countEl.textContent=log.length+' event'+(log.length!==1?'s':'');
  if(!log.length){body.innerHTML='<div class="activity-empty">&#128203; No activity yet</div>';return;}
  const MONTHS=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  body.innerHTML=log.slice(0,80).map(e=>{
    const d=new Date(e.time);
    const timeStr=d.getDate()+' '+MONTHS[d.getMonth()]+', '+d.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
    return '<div class="activity-entry">'
      +'<div class="activity-who">'+esc(e.who)+(e.company?' &middot; '+esc(e.company):'')+'</div>'
      +'<div class="activity-what">'+esc(e.what)+'</div>'
      +(e.detail?'<div class="activity-detail">'+esc(e.detail)+'</div>':'')
      +'<div class="activity-time">'+timeStr+'</div>'
      +'</div>';
  }).join('');
}
function openActivityPanel(){document.getElementById('activityPanel').classList.add('open');document.getElementById('activityPanelOverlay').classList.add('open');const dot=document.getElementById('activityBtnDot');if(dot)dot.classList.remove('visible');}
function closeActivityPanel(){document.getElementById('activityPanel').classList.remove('open');document.getElementById('activityPanelOverlay').classList.remove('open');}

// =============================================
// INIT
// =============================================
syncTrainers();
initUserSelector();
applyPermissions();
initActivityFeed();
loadData();
setInterval(loadData, 5*60*1000);
</script>
</body>
</html>
