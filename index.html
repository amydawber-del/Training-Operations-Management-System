<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Street Training Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --text--dark--50: #19191e;
    --brand--black: #242326;
    --text--dark--40: #4c4d57;
    --text--dark--30: #777989;
    --card-light-grey: #f8f8f8;
    --text--white--30: #979797;
    --text--light--40: #b2b2b2;
    --accent--blue--300: #527dff;
    --accent-blue--200: #7a9cff;
    --text--dark--20: #a8aabb;
    --action-primary-blue: #2147f4;
    --light-grey: #ccc;
    --text-dark-10: #dfe0ec;
    --ui--underline--light-grey: #e5e5e5;
    --success-green: #bde4b9;
    --brand--yellow: #f1c238;
    --brand-accent--mandarin-light: #f6be9d;
    --accent-blue--100: #a3baff;
    --brand-accent--dusty-red-light: #f9b4bc;
    --brand--secondary--lightgreen: #beffd8;
    --accent-blue--50: #b8caff;
    --white-smoke: #fde8eb;
    --brand-accent--cream: #f5ede5;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;
    font-size: 14px;
    line-height: 20px;
    color: #333;
    background-color: #fff;
    min-height: 100vh;
  }

  /* HEADER */
  .header {
    background: var(--brand--black);
    color: #fff;
    height: 52px;
    display: flex;
    align-items: center;
    padding: 0 24px;
    gap: 16px;
    position: sticky;
    top: 0;
    z-index: 100;
    border-bottom: 1px solid #3a3a3a;
  }

  /* HAMBURGER */
  .hamburger-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 6px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    border-radius: 4px;
    transition: background 0.15s;
  }
  .hamburger-btn:hover { background: rgba(255,255,255,0.1); }
  .hamburger-btn span {
    display: block;
    width: 18px;
    height: 2px;
    background: #fff;
    border-radius: 1px;
    transition: all 0.2s;
  }
  .hamburger-btn.open span:nth-child(1) { transform: rotate(45deg) translate(4px, 4px); }
  .hamburger-btn.open span:nth-child(2) { opacity: 0; }
  .hamburger-btn.open span:nth-child(3) { transform: rotate(-45deg) translate(4px, -4px); }

  /* STREET LOGO */
  .street-logo {
    display: flex;
    align-items: center;
    gap: 6px;
    text-decoration: none;
  }
  .street-logo-mark {
    font-size: 15px;
    font-weight: 700;
    letter-spacing: -0.5px;
    color: #fff;
    font-family: Arial, sans-serif;
    line-height: 1;
  }
  .street-logo-mark .logo-dot { color: var(--brand--yellow); }
  .street-logo-sub {
    font-size: 9px;
    color: var(--text--light--40);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-top: 1px;
  }

  .header-title {
    font-size: 15px;
    font-weight: 600;
    color: #fff;
    letter-spacing: -0.2px;
    flex: 1;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .refresh-btn {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.15);
    color: #fff;
    padding: 5px 12px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    transition: background 0.15s;
    font-family: Arial, sans-serif;
  }
  .refresh-btn:hover { background: rgba(255,255,255,0.2); }

  .last-updated {
    font-size: 11px;
    color: var(--text--light--40);
  }

  /* SIDE NAV DRAWER */
  .nav-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    z-index: 200;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }
  .nav-overlay.open { opacity: 1; pointer-events: all; }

  .nav-drawer {
    position: fixed;
    top: 0;
    left: -280px;
    width: 260px;
    height: 100vh;
    background: var(--brand--black);
    z-index: 201;
    transition: left 0.22s ease;
    display: flex;
    flex-direction: column;
    box-shadow: 2px 0 8px rgba(0,0,0,0.3);
  }
  .nav-drawer.open { left: 0; }

  .nav-drawer-header {
    padding: 16px 20px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 52px;
  }
  .nav-drawer-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--text--light--40);
    letter-spacing: 1px;
    text-transform: uppercase;
  }
  .nav-close {
    background: none;
    border: none;
    color: var(--text--light--40);
    cursor: pointer;
    font-size: 18px;
    line-height: 1;
    padding: 2px 6px;
    border-radius: 4px;
    transition: color 0.15s;
  }
  .nav-close:hover { color: #fff; }

  .nav-section-label {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 1.2px;
    text-transform: uppercase;
    color: var(--text--dark--30);
    padding: 16px 20px 8px;
  }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 20px;
    color: #ccc;
    text-decoration: none;
    font-size: 13px;
    transition: background 0.12s, color 0.12s;
    border-left: 3px solid transparent;
  }
  .nav-item:hover {
    background: rgba(255,255,255,0.06);
    color: #fff;
    border-left-color: var(--accent--blue--300);
  }
  .nav-item.active {
    background: rgba(33, 71, 244, 0.15);
    color: var(--accent-blue--200);
    border-left-color: var(--action-primary-blue);
  }
  .nav-item-icon { font-size: 15px; width: 20px; text-align: center; }

  .nav-divider {
    height: 1px;
    background: rgba(255,255,255,0.08);
    margin: 8px 20px;
  }

  /* MAIN CONTENT */
  .main {
    padding: 24px;
    max-width: 1400px;
    margin: 0 auto;
  }

  /* LOADING */
  .loading-bar {
    height: 3px;
    background: linear-gradient(90deg, var(--action-primary-blue), var(--accent--blue--300));
    animation: loading 1.2s ease infinite;
    display: none;
  }
  .loading-bar.active { display: block; }
  @keyframes loading {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(200%); }
  }

  /* SECTION */
  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }
  .section-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--text--dark--50);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .section-title .badge {
    background: var(--brand-accent--dusty-red-light);
    color: #c0303d;
    font-size: 11px;
    font-weight: 700;
    padding: 1px 7px;
    border-radius: 10px;
    min-width: 20px;
    text-align: center;
  }
  .section-title .badge.green {
    background: var(--success-green);
    color: #2a7a26;
  }

  /* NEW REQUESTS PANEL */
  .requests-panel {
    border: 1px solid var(--ui--underline--light-grey);
    border-radius: 4px;
    margin-bottom: 24px;
    overflow: hidden;
  }
  .requests-panel-header {
    background: var(--card-light-grey);
    padding: 12px 16px;
    border-bottom: 1px solid var(--ui--underline--light-grey);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .requests-panel-header-left {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .alert-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #e53935;
    animation: pulse-dot 1.5s ease infinite;
  }
  @keyframes pulse-dot {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.8); }
  }

  /* TABLE */
  .table-wrap { overflow-x: auto; }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }
  thead tr {
    background: var(--card-light-grey);
  }
  th {
    padding: 10px 14px;
    text-align: left;
    font-weight: 600;
    font-size: 11px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    color: var(--text--dark--30);
    border-bottom: 1px solid var(--ui--underline--light-grey);
    white-space: nowrap;
  }
  td {
    padding: 10px 14px;
    border-bottom: 1px solid var(--ui--underline--light-grey);
    color: var(--text--dark--40);
    vertical-align: middle;
  }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: #fafafa; }

  .option-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    white-space: nowrap;
  }
  .opt-1 { background: var(--accent-blue--50); color: #2147f4; }
  .opt-2 { background: var(--brand-accent--cream); color: #8a5a2a; }
  .opt-3 { background: var(--brand-accent--mandarin-light); color: #a04010; }
  .opt-4 { background: var(--success-green); color: #2a7a26; }
  .opt-5 { background: var(--brand--secondary--lightgreen); color: #1a6a40; }

  .status-badge {
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
  }
  .status-new { background: var(--white-smoke); color: #c0303d; }
  .status-unassigned { background: var(--white-smoke); color: #c0303d; }
  .status-assigned { background: var(--brand-accent--cream); color: #8a5a2a; }
  .status-booked { background: var(--accent-blue--50); color: #2147f4; }
  .status-pending { background: var(--brand--secondary--lightgreen); color: #1a6a40; }
  .status-cancelled { background: #f0f0f0; color: #999; text-decoration: line-through; }
  .status-complete { background: var(--success-green); color: #2a7a26; }

  /* ASSIGN CONTROLS */
  .assign-row {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .suggested-trainer {
    font-size: 11px;
    color: var(--action-primary-blue);
    background: rgba(33,71,244,0.08);
    padding: 2px 8px;
    border-radius: 4px;
    white-space: nowrap;
  }
  select.trainer-select {
    border: 1px solid var(--light-grey);
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 12px;
    font-family: Arial, sans-serif;
    color: #333;
    background: #fff;
    cursor: pointer;
  }
  select.trainer-select:focus { outline: none; border-color: var(--action-primary-blue); }

  .btn {
    padding: 5px 12px;
    border-radius: 4px;
    font-size: 12px;
    font-family: Arial, sans-serif;
    cursor: pointer;
    border: none;
    font-weight: 600;
    transition: background 0.15s;
  }
  .btn-primary {
    background: var(--action-primary-blue);
    color: #fff;
  }
  .btn-primary:hover { background: #1a39d4; }
  .btn-primary:disabled { background: var(--text--dark--20); cursor: not-allowed; }
  .btn-sm { padding: 4px 10px; font-size: 11px; }
  .btn-ghost {
    background: none;
    border: 1px solid var(--light-grey);
    color: var(--text--dark--30);
  }
  .btn-ghost:hover { background: var(--card-light-grey); color: #333; }

  /* KPI CARDS */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }
  .kpi-card {
    border: 1px solid var(--ui--underline--light-grey);
    border-radius: 4px;
    padding: 16px 20px;
    background: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  }
  .kpi-card-label {
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    color: var(--text--dark--30);
    margin-bottom: 8px;
  }
  .kpi-card-value {
    font-size: 28px;
    font-weight: 700;
    color: var(--text--dark--50);
    line-height: 1.1;
    letter-spacing: -0.5px;
  }
  .kpi-card-sub {
    font-size: 11px;
    color: var(--text--dark--30);
    margin-top: 4px;
  }
  .kpi-card-delta {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    font-size: 11px;
    font-weight: 600;
    padding: 1px 6px;
    border-radius: 4px;
    margin-top: 6px;
  }
  .delta-up { background: var(--success-green); color: #2a7a26; }
  .delta-down { background: var(--white-smoke); color: #c0303d; }
  .kpi-accent-left {
    border-left: 3px solid var(--action-primary-blue);
    padding-left: 14px;
  }
  .kpi-accent-yellow { border-left-color: var(--brand--yellow); }
  .kpi-accent-green { border-left-color: #4caf50; }
  .kpi-accent-orange { border-left-color: #ff7043; }

  /* CHARTS GRID */
  .charts-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 16px;
    margin-bottom: 24px;
  }
  @media (max-width: 900px) { .charts-grid { grid-template-columns: 1fr; } }

  .chart-card {
    border: 1px solid var(--ui--underline--light-grey);
    border-radius: 4px;
    padding: 20px;
    background: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  }
  .chart-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text--dark--50);
    margin-bottom: 4px;
  }
  .chart-subtitle {
    font-size: 11px;
    color: var(--text--dark--30);
    margin-bottom: 16px;
  }
  .chart-container { position: relative; }

  /* TRAINER WORKLOAD */
  .trainer-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 12px;
    margin-bottom: 24px;
  }
  .trainer-card {
    border: 1px solid var(--ui--underline--light-grey);
    border-radius: 4px;
    padding: 14px 16px;
    background: #fff;
  }
  .trainer-name {
    font-size: 13px;
    font-weight: 600;
    color: var(--text--dark--50);
    margin-bottom: 10px;
  }
  .trainer-stat {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    color: var(--text--dark--30);
    margin-bottom: 4px;
  }
  .trainer-stat-val { font-weight: 600; color: var(--text--dark--40); }
  .workload-bar-wrap {
    height: 4px;
    background: var(--ui--underline--light-grey);
    border-radius: 2px;
    margin-top: 8px;
    overflow: hidden;
  }
  .workload-bar {
    height: 100%;
    border-radius: 2px;
    background: var(--action-primary-blue);
    transition: width 0.4s ease;
  }
  .workload-bar.busy { background: #ff7043; }
  .workload-bar.medium { background: var(--brand--yellow); }

  .suggested-tag {
    display: inline-block;
    font-size: 10px;
    font-weight: 600;
    background: var(--brand--secondary--lightgreen);
    color: #1a6a40;
    padding: 1px 6px;
    border-radius: 4px;
    margin-top: 6px;
  }

  /* ALL BOOKINGS TABLE */
  .all-bookings {
    border: 1px solid var(--ui--underline--light-grey);
    border-radius: 4px;
    margin-bottom: 24px;
    overflow: hidden;
  }

  /* EMPTY STATE */
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text--dark--30);
  }
  .empty-state-icon { font-size: 32px; margin-bottom: 8px; }
  .empty-state-text { font-size: 13px; }

  /* TOAST */
  .toast-container {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 999;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .toast {
    background: var(--brand--black);
    color: #fff;
    padding: 10px 16px;
    border-radius: 4px;
    font-size: 13px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    animation: slideIn 0.2s ease;
    border-left: 3px solid var(--action-primary-blue);
  }
  .toast.success { border-left-color: #4caf50; }
  .toast.error { border-left-color: #e53935; }
  @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: none; opacity: 1; } }

  /* MONTH VS CARDS */
  .compare-cards {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
  }
  .compare-card {
    background: var(--card-light-grey);
    border-radius: 4px;
    padding: 12px 14px;
    text-align: center;
  }
  .compare-card-label { font-size: 10px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; color: var(--text--dark--30); margin-bottom: 4px; }
  .compare-card-value { font-size: 22px; font-weight: 700; color: var(--text--dark--50); }

  /* SPINNER */
  .spinner {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid var(--text-dark-10);
    border-top-color: var(--action-primary-blue);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* PAGINATION */
  .pagination {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    border-top: 1px solid var(--ui--underline--light-grey);
    background: var(--card-light-grey);
    font-size: 12px;
    color: var(--text--dark--30);
  }
  .page-btn {
    background: #fff;
    border: 1px solid var(--light-grey);
    border-radius: 4px;
    padding: 3px 10px;
    font-size: 12px;
    cursor: pointer;
    font-family: Arial, sans-serif;
    transition: background 0.12s;
  }
  .page-btn:hover:not(:disabled) { background: var(--card-light-grey); }
  .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  /* FILTER BAR */
  .filter-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }
  select.filter-select, input.filter-input {
    border: 1px solid var(--light-grey);
    border-radius: 4px;
    padding: 5px 10px;
    font-size: 12px;
    font-family: Arial, sans-serif;
    color: #333;
    background: #fff;
  }
  select.filter-select:focus, input.filter-input:focus { outline: none; border-color: var(--action-primary-blue); }

  .data-note {
    font-size: 11px;
    color: var(--text--dark--20);
    padding: 8px 16px;
    background: var(--card-light-grey);
    border-top: 1px solid var(--ui--underline--light-grey);
  }

  /* TRAINER MANAGEMENT MODAL */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 300;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal {
    background: #fff;
    border-radius: 8px;
    width: 380px;
    max-width: 95vw;
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    overflow: hidden;
  }
  .modal-header {
    background: var(--brand--black);
    color: #fff;
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .modal-title { font-size: 14px; font-weight: 600; }
  .modal-close {
    background: none; border: none; color: #aaa; cursor: pointer;
    font-size: 18px; line-height: 1; padding: 2px 6px; border-radius: 4px;
  }
  .modal-close:hover { color: #fff; }
  .modal-body { padding: 20px; }
  .trainer-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
  .trainer-list-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 12px;
    background: var(--card-light-grey);
    border-radius: 4px;
    border: 1px solid var(--ui--underline--light-grey);
    font-size: 13px; font-weight: 600;
  }
  .trainer-delete-btn {
    background: none; border: none; color: var(--text--dark--20); cursor: pointer;
    font-size: 16px; line-height: 1; padding: 2px 6px; border-radius: 4px;
    transition: color 0.12s, background 0.12s;
  }
  .trainer-delete-btn:hover { color: #e53935; background: var(--white-smoke); }
  .trainer-add-row { display: flex; gap: 8px; }
  .trainer-add-input {
    flex: 1; border: 1px solid var(--light-grey); border-radius: 4px;
    padding: 7px 10px; font-size: 13px; font-family: Arial, sans-serif;
  }
  .trainer-add-input:focus { outline: none; border-color: var(--action-primary-blue); }

  /* KPI DETAIL MODAL */
  .kpi-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.55);
    z-index: 400;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }
  .kpi-modal-overlay.open { opacity: 1; pointer-events: all; }
  .kpi-modal {
    background: #fff;
    border-radius: 8px;
    width: 860px;
    max-width: 96vw;
    max-height: 88vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 12px 48px rgba(0,0,0,0.25);
    overflow: hidden;
  }
  .kpi-modal-header {
    padding: 18px 24px 14px;
    border-bottom: 1px solid var(--ui--underline--light-grey);
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 16px;
    flex-shrink: 0;
  }
  .kpi-modal-header-left { flex: 1; }
  .kpi-modal-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--text--dark--50);
    margin-bottom: 2px;
  }
  .kpi-modal-subtitle {
    font-size: 12px;
    color: var(--text--dark--30);
  }
  .kpi-modal-headline {
    font-size: 28px;
    font-weight: 700;
    color: var(--text--dark--50);
    letter-spacing: -0.5px;
    margin-top: 8px;
  }
  .kpi-modal-close {
    background: var(--card-light-grey);
    border: 1px solid var(--ui--underline--light-grey);
    color: var(--text--dark--30);
    cursor: pointer;
    font-size: 18px;
    line-height: 1;
    padding: 6px 10px;
    border-radius: 4px;
    transition: background 0.12s, color 0.12s;
    flex-shrink: 0;
  }
  .kpi-modal-close:hover { background: var(--white-smoke); color: #c0303d; }
  .kpi-modal-stats {
    display: flex;
    gap: 24px;
    padding: 14px 24px;
    background: var(--card-light-grey);
    border-bottom: 1px solid var(--ui--underline--light-grey);
    flex-wrap: wrap;
    flex-shrink: 0;
  }
  .kpi-modal-stat {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .kpi-modal-stat-label {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.6px;
    color: var(--text--dark--30);
  }
  .kpi-modal-stat-value {
    font-size: 16px;
    font-weight: 700;
    color: var(--text--dark--50);
  }
  .kpi-modal-stat-sub {
    font-size: 10px;
    color: var(--text--dark--30);
  }
  .kpi-modal-body {
    overflow-y: auto;
    flex: 1;
  }
  .kpi-modal-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
  }
  .kpi-modal-table thead tr {
    background: var(--card-light-grey);
    position: sticky;
    top: 0;
    z-index: 1;
  }
  .kpi-modal-table th {
    padding: 9px 14px;
    text-align: left;
    font-weight: 600;
    font-size: 10px;
    letter-spacing: 0.6px;
    text-transform: uppercase;
    color: var(--text--dark--30);
    border-bottom: 2px solid var(--ui--underline--light-grey);
    white-space: nowrap;
  }
  .kpi-modal-table td {
    padding: 10px 14px;
    border-bottom: 1px solid var(--ui--underline--light-grey);
    color: var(--text--dark--40);
    vertical-align: middle;
  }
  .kpi-modal-table tr:last-child td { border-bottom: none; }
  .kpi-modal-table tr:hover td { background: #fafbff; }
  .kpi-modal-table .col-money { font-weight: 600; color: var(--text--dark--50); }
  .kpi-modal-table .col-highlight { font-weight: 600; color: var(--action-primary-blue); }
  .kpi-modal-footer {
    padding: 12px 24px;
    border-top: 1px solid var(--ui--underline--light-grey);
    background: var(--card-light-grey);
    display: flex;
    justify-content: flex-end;
    flex-shrink: 0;
  }
  /* Make KPI cards look clickable */
  .kpi-card.clickable {
    cursor: pointer;
    transition: box-shadow 0.15s, border-color 0.15s, background 0.15s;
    border: 1px solid var(--ui--underline--light-grey);
    position: relative;
  }
  .kpi-card.clickable:hover {
    box-shadow: 0 4px 16px rgba(33,71,244,0.10);
    border-color: rgba(33,71,244,0.35);
    background: #f6f8ff;
  }
  .kpi-card.clickable:active {
    background: #eef1ff;
  }
  .trainer-pill {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 600;
    background: var(--accent-blue--50);
    color: var(--action-primary-blue);
  }

  /* Reassign modal overlay */
  #reassignModalOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.55);
    z-index: 500;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }
  #reassignModalOverlay.open { opacity: 1; pointer-events: all; }
  .reassign-enquiry-row {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 5px 0;
    border-bottom: 1px solid var(--ui--underline--light-grey);
    font-size: 12px;
  }
  .reassign-enquiry-row:last-child { border-bottom: none; }
  .reassign-enquiry-company { font-weight: 600; color: var(--text--dark--50); flex: 1; }
  .reassign-enquiry-status { font-size: 11px; padding: 2px 7px; border-radius: 10px; background: #fde8eb; color: #c0303d; }


  /* ── ACTIVITY FEED ──────────────────────────────────────────── */
  .activity-btn {
    position: relative;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 5px 12px;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 5px;
    color: #ccc;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    font-family: Arial, sans-serif;
    transition: background 0.15s, color 0.15s;
    white-space: nowrap;
  }
  .activity-btn:hover { background: rgba(255,255,255,0.15); color: #fff; }
  .activity-btn-dot {
    position: absolute;
    top: -3px;
    right: -3px;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #f59e0b;
    border: 2px solid var(--text--dark--50);
    display: none;
  }
  .activity-btn-dot.visible { display: block; }

  .activity-panel {
    position: fixed;
    top: 0;
    right: 0;
    width: 380px;
    max-width: 95vw;
    height: 100vh;
    background: #fff;
    box-shadow: -4px 0 32px rgba(0,0,0,0.18);
    z-index: 600;
    display: flex;
    flex-direction: column;
    transform: translateX(100%);
    transition: transform 0.28s cubic-bezier(0.4,0,0.2,1);
  }
  .activity-panel.open { transform: translateX(0); }

  .activity-panel-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.35);
    z-index: 599;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s;
  }
  .activity-panel-overlay.open { opacity: 1; pointer-events: all; }

  .activity-panel-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--ui--underline--light-grey);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--text--dark--50);
    color: #fff;
    flex-shrink: 0;
  }
  .activity-panel-title {
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 0.2px;
  }
  .activity-panel-sub {
    font-size: 11px;
    color: rgba(255,255,255,0.55);
    margin-top: 2px;
  }
  .activity-close {
    background: rgba(255,255,255,0.1);
    border: none;
    color: rgba(255,255,255,0.7);
    cursor: pointer;
    font-size: 16px;
    padding: 5px 9px;
    border-radius: 4px;
    transition: background 0.12s, color 0.12s;
  }
  .activity-close:hover { background: rgba(255,255,255,0.2); color: #fff; }

  .activity-user-bar {
    padding: 12px 16px;
    background: #f6f8ff;
    border-bottom: 1px solid var(--ui--underline--light-grey);
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
  }
  .activity-user-avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: var(--action-primary-blue);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 700;
    flex-shrink: 0;
  }
  .activity-user-name {
    font-size: 12px;
    font-weight: 600;
    color: var(--text--dark--50);
    flex: 1;
  }
  .activity-user-change {
    font-size: 11px;
    color: var(--action-primary-blue);
    cursor: pointer;
    text-decoration: underline;
  }
  .activity-user-change:hover { color: #1538c7; }

  .activity-toolbar {
    padding: 8px 14px;
    border-bottom: 1px solid var(--ui--underline--light-grey);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
    gap: 8px;
  }
  .activity-count {
    font-size: 11px;
    font-weight: 600;
    color: var(--text--dark--30);
  }
  .activity-clear-btn {
    font-size: 11px;
    color: #c0303d;
    background: none;
    border: none;
    cursor: pointer;
    padding: 3px 7px;
    border-radius: 4px;
    font-family: Arial, sans-serif;
    transition: background 0.12s;
  }
  .activity-clear-btn:hover { background: #fde8eb; }

  .activity-feed-body {
    flex: 1;
    overflow-y: auto;
    padding: 8px 0;
  }
  .activity-empty {
    padding: 48px 24px;
    text-align: center;
    color: var(--text--dark--30);
    font-size: 13px;
  }
  .activity-empty-icon { font-size: 32px; margin-bottom: 10px; }

  .activity-item {
    display: flex;
    gap: 12px;
    padding: 11px 16px;
    border-bottom: 1px solid #f3f4f6;
    transition: background 0.1s;
  }
  .activity-item:hover { background: #fafbff; }
  .activity-item:last-child { border-bottom: none; }
  .activity-item-icon {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    flex-shrink: 0;
    margin-top: 1px;
  }
  .activity-item-body { flex: 1; min-width: 0; }
  .activity-item-text {
    font-size: 12px;
    color: var(--text--dark--50);
    line-height: 1.45;
  }
  .activity-item-text strong { color: var(--text--dark--50); }
  .activity-item-text .act-company {
    color: var(--action-primary-blue);
    font-weight: 600;
  }
  .activity-item-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 4px;
  }
  .activity-item-user {
    font-size: 10px;
    font-weight: 700;
    color: var(--text--dark--30);
    letter-spacing: 0.4px;
    text-transform: uppercase;
  }
  .activity-item-time {
    font-size: 10px;
    color: var(--text--dark--20);
  }
  .activity-date-divider {
    padding: 6px 16px 3px;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    color: var(--text--dark--20);
    background: var(--card-light-grey);
    border-bottom: 1px solid var(--ui--underline--light-grey);
    border-top: 1px solid var(--ui--underline--light-grey);
  }

  /* User name prompt modal */
  .username-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }
  .username-modal-overlay.open { opacity: 1; pointer-events: all; }
  .username-modal {
    background: #fff;
    border-radius: 10px;
    width: 360px;
    max-width: 94vw;
    padding: 28px 28px 22px;
    box-shadow: 0 12px 48px rgba(0,0,0,0.25);
    text-align: center;
  }
  .username-modal-icon { font-size: 36px; margin-bottom: 10px; }
  .username-modal-title { font-size: 17px; font-weight: 700; color: var(--text--dark--50); margin-bottom: 6px; }
  .username-modal-sub { font-size: 12px; color: var(--text--dark--30); margin-bottom: 20px; line-height: 1.5; }
  .username-modal input {
    width: 100%;
    box-sizing: border-box;
    border: 1.5px solid var(--ui--underline--light-grey);
    border-radius: 6px;
    padding: 10px 14px;
    font-size: 14px;
    font-family: Arial, sans-serif;
    color: var(--text--dark--50);
    margin-bottom: 14px;
    transition: border-color 0.15s;
  }
  .username-modal input:focus { outline: none; border-color: var(--action-primary-blue); }


  /* ── LOGIN SCREEN ─────────────────────────────────────────────── */
  .login-screen {
    position: fixed;
    inset: 0;
    background: linear-gradient(135deg, #0d1526 0%, #1a2a4a 50%, #0d1526 100%);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 0;
  }
  .login-screen.hidden { display: none; }

  .login-card {
    background: #fff;
    border-radius: 14px;
    padding: 36px 36px 28px;
    width: 480px;
    max-width: 96vw;
    box-shadow: 0 24px 80px rgba(0,0,0,0.4);
  }
  .login-logo {
    font-size: 13px;
    font-weight: 800;
    letter-spacing: 2px;
    color: var(--text--dark--50);
    text-transform: uppercase;
    margin-bottom: 4px;
  }
  .login-logo span { color: var(--action-primary-blue); }
  .login-title {
    font-size: 22px;
    font-weight: 700;
    color: var(--text--dark--50);
    margin-bottom: 4px;
    margin-top: 20px;
  }
  .login-sub {
    font-size: 13px;
    color: var(--text--dark--30);
    margin-bottom: 28px;
  }
  .login-user-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 20px;
    max-height: 320px;
    overflow-y: auto;
  }
  .login-user-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 16px 12px;
    border: 1.5px solid var(--ui--underline--light-grey);
    border-radius: 10px;
    background: #fff;
    cursor: pointer;
    transition: border-color 0.15s, background 0.15s, box-shadow 0.15s;
    font-family: Arial, sans-serif;
    text-align: center;
  }
  .login-user-btn:hover {
    border-color: var(--action-primary-blue);
    background: #f6f8ff;
    box-shadow: 0 2px 12px rgba(33,71,244,0.12);
  }
  .login-user-avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: var(--action-primary-blue);
    color: #fff;
    font-size: 16px;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .login-user-name {
    font-size: 13px;
    font-weight: 600;
    color: var(--text--dark--50);
  }
  .login-user-role {
    font-size: 10px;
    color: var(--text--dark--30);
    text-transform: uppercase;
    letter-spacing: 0.6px;
  }
  .login-user-badge {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    font-size: 9px;
    font-weight: 700;
    padding: 2px 6px;
    border-radius: 8px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }
  .login-user-badge.admin { background: #fde8eb; color: #c0303d; }
  .login-user-badge.editor { background: #e8f0ff; color: #2147f4; }
  .login-user-badge.viewer { background: #f0f0f0; color: #888; }
  .login-no-users {
    grid-column: 1/-1;
    text-align: center;
    padding: 24px;
    color: var(--text--dark--30);
    font-size: 13px;
  }

  /* ── PERMISSIONS PANEL ──────────────────────────────────────────── */
  .perm-section {
    margin-bottom: 16px;
  }
  .perm-section-title {
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    color: var(--text--dark--30);
    margin-bottom: 8px;
    padding-bottom: 4px;
    border-bottom: 1px solid var(--ui--underline--light-grey);
  }
  .perm-row {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    padding: 7px 0;
    gap: 12px;
    border-bottom: 1px solid #f3f4f6;
  }
  .perm-row:last-child { border-bottom: none; }
  .perm-row-left { flex: 1; }
  .perm-row-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text--dark--50);
  }
  .perm-row-desc {
    font-size: 11px;
    color: var(--text--dark--30);
    margin-top: 1px;
  }
  .perm-toggle {
    position: relative;
    width: 36px;
    height: 20px;
    flex-shrink: 0;
    margin-top: 1px;
  }
  .perm-toggle input { opacity: 0; width: 0; height: 0; }
  .perm-toggle-slider {
    position: absolute;
    inset: 0;
    background: #ccc;
    border-radius: 20px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .perm-toggle-slider::before {
    content: '';
    position: absolute;
    width: 14px;
    height: 14px;
    left: 3px;
    top: 3px;
    background: #fff;
    border-radius: 50%;
    transition: transform 0.2s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  }
  .perm-toggle input:checked + .perm-toggle-slider { background: var(--action-primary-blue); }
  .perm-toggle input:checked + .perm-toggle-slider::before { transform: translateX(16px); }
  .perm-preset-row {
    display: flex;
    gap: 6px;
    margin-bottom: 14px;
  }
  .perm-preset-btn {
    flex: 1;
    padding: 6px 4px;
    border-radius: 5px;
    border: 1.5px solid var(--ui--underline--light-grey);
    background: #fff;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    font-family: Arial, sans-serif;
    transition: all 0.12s;
  }
  .perm-preset-btn:hover { border-color: var(--action-primary-blue); background: #f0f4ff; }
  .perm-preset-btn.active { border-color: var(--action-primary-blue); background: var(--action-primary-blue); color: #fff; }

  /* ── PERMISSION-GATED UI ─────────────────────────────────────────── */
  .perm-hidden { display: none !important; }
  .perm-disabled {
    opacity: 0.45;
    pointer-events: none;
    cursor: not-allowed;
  }
  .perm-lock-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 10px;
    color: var(--text--dark--30);
    background: var(--card-light-grey);
    border: 1px solid var(--ui--underline--light-grey);
    padding: 2px 7px;
    border-radius: 10px;
    font-weight: 600;
  }


  /* ── PIN PAD ──────────────────────────────────────────────────── */
  .pin-screen {
    position: fixed;
    inset: 0;
    background: linear-gradient(135deg, #0d1526 0%, #1a2a4a 50%, #0d1526 100%);
    z-index: 9998;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
  }
  .pin-screen.hidden { display: none; }
  .pin-card {
    background: #fff;
    border-radius: 14px;
    padding: 32px 32px 26px;
    width: 340px;
    max-width: 96vw;
    box-shadow: 0 24px 80px rgba(0,0,0,0.4);
    text-align: center;
  }
  .pin-avatar {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: var(--action-primary-blue);
    color: #fff;
    font-size: 20px;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 10px;
  }
  .pin-user-name { font-size: 18px; font-weight: 700; color: var(--text--dark--50); margin-bottom: 4px; }
  .pin-label { font-size: 13px; color: var(--text--dark--30); margin-bottom: 20px; }
  .pin-dots {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-bottom: 24px;
  }
  .pin-dot {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    border: 2px solid #ccc;
    background: transparent;
    transition: all 0.15s;
  }
  .pin-dot.filled { background: var(--action-primary-blue); border-color: var(--action-primary-blue); }
  .pin-dot.error  { background: #c0303d; border-color: #c0303d; }
  .pin-keypad {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 14px;
  }
  .pin-key {
    padding: 14px 0;
    border: 1.5px solid #e5e7eb;
    border-radius: 8px;
    background: #fff;
    font-size: 18px;
    font-weight: 600;
    color: var(--text--dark--50);
    cursor: pointer;
    font-family: Arial, sans-serif;
    transition: background 0.1s, border-color 0.1s, transform 0.08s;
    user-select: none;
  }
  .pin-key:hover  { background: #f0f4ff; border-color: var(--action-primary-blue); }
  .pin-key:active { transform: scale(0.94); background: #e0e8ff; }
  .pin-key.wide   { grid-column: span 1; }
  .pin-key.del    { font-size: 15px; color: #888; }
  .pin-error-msg  { font-size: 12px; color: #c0303d; min-height: 18px; margin-bottom: 6px; }
  .pin-back-btn {
    background: none;
    border: none;
    color: var(--text--dark--30);
    font-size: 12px;
    cursor: pointer;
    font-family: Arial, sans-serif;
    padding: 4px 8px;
    border-radius: 4px;
    transition: color 0.12s;
    text-decoration: underline;
  }
  .pin-back-btn:hover { color: var(--action-primary-blue); }
  .pin-setup-info {
    font-size: 11px;
    color: var(--text--dark--30);
    margin-bottom: 18px;
    line-height: 1.5;
    padding: 8px 10px;
    background: #f6f8ff;
    border-radius: 6px;
    border: 1px solid #e0e8ff;
  }


  /* ── SHADOW / PREVIEW MODE ────────────────────────────────────── */
  .shadow-banner {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 950;
    background: linear-gradient(90deg, #7c3aed, #5b21b6);
    color: #fff;
    padding: 9px 20px;
    font-size: 12px;
    font-weight: 600;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    box-shadow: 0 2px 12px rgba(124,58,237,0.4);
    letter-spacing: 0.2px;
  }
  .shadow-banner.active {
    display: flex;
  }
  .shadow-banner-left {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .shadow-banner-pill {
    background: rgba(255,255,255,0.18);
    border-radius: 20px;
    padding: 2px 10px;
    font-size: 11px;
    letter-spacing: 0.4px;
    text-transform: uppercase;
  }
  .shadow-banner-name {
    font-size: 13px;
    font-weight: 700;
  }
  .shadow-banner-right {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .shadow-exit-btn {
    background: rgba(255,255,255,0.15);
    border: 1.5px solid rgba(255,255,255,0.35);
    color: #fff;
    border-radius: 6px;
    padding: 5px 14px;
    font-size: 11px;
    font-weight: 700;
    cursor: pointer;
    font-family: Arial, sans-serif;
    transition: background 0.12s;
    letter-spacing: 0.3px;
  }
  .shadow-exit-btn:hover { background: rgba(255,255,255,0.28); }
  .shadow-save-btn {
    background: #fff;
    border: none;
    color: #5b21b6;
    border-radius: 6px;
    padding: 5px 14px;
    font-size: 11px;
    font-weight: 700;
    cursor: pointer;
    font-family: Arial, sans-serif;
    transition: background 0.12s;
    letter-spacing: 0.3px;
  }
  .shadow-save-btn:hover { background: #ede9fe; }

  /* Push main content down when banner active */
  body.shadow-mode .header,
  body.shadow-mode .loading-bar,
  body.shadow-mode .main {
    margin-top: 37px;
  }

  /* Dim & flash the perm toggles being previewed */
  .shadow-perm-row {
    background: #fdf4ff;
    border-radius: 4px;
  }


  /* ── CALENDAR SECTION ──────────────────────────────────────────── */
  .cal-section { margin-bottom: 24px; }

  .cal-grid {
    display: grid;
    grid-template-columns: minmax(0, 1fr) 300px;
    gap: 16px;
    align-items: start;
    min-width: 0;
    width: 100%;
  }
  @media (max-width: 900px) { .cal-grid { grid-template-columns: 1fr; } }

  /* Mini month calendar */
  .cal-month-card {
    background: #fff;
    border: 1px solid var(--ui--underline--light-grey);
    border-radius: 8px;
    overflow: hidden;
    min-width: 0;
    width: 100%;
  }
  .cal-month-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    background: var(--text--dark--50);
    color: #fff;
  }
  .cal-month-title { font-size: 14px; font-weight: 700; }
  .cal-nav-btn {
    background: rgba(255,255,255,0.12);
    border: none;
    color: #fff;
    cursor: pointer;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 14px;
    font-family: Arial, sans-serif;
    transition: background 0.12s;
  }
  .cal-nav-btn:hover { background: rgba(255,255,255,0.22); }
  /* DOW header row — flex with fixed 1/7 columns */
  .cal-dow-row {
    display: flex;
    width: 100%;
    box-sizing: border-box;
    background: var(--card-light-grey);
    border-bottom: 1px solid var(--ui--underline--light-grey);
  }
  .cal-dow {
    flex: 0 0 calc(100% / 7);
    width: calc(100% / 7);
    text-align: center;
    font-size: 10px;
    font-weight: 700;
    color: var(--text--dark--30);
    padding: 6px 0;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    box-sizing: border-box;
    overflow: hidden;
  }
  /* Days grid — flex wrap with fixed 1/7 cells */
  .cal-days {
    display: flex;
    flex-wrap: wrap;
    width: 100%;
    box-sizing: border-box;
    border-top: 1px solid #f3f4f6;
    border-left: 1px solid #f3f4f6;
  }
  .cal-day {
    flex: 0 0 calc(100% / 7);
    width: calc(100% / 7);
    box-sizing: border-box;
    min-height: 90px;
    padding: 5px 4px 4px;
    border-right: 1px solid #f3f4f6;
    border-bottom: 1px solid #f3f4f6;
    cursor: default;
    transition: background 0.1s;
    overflow: hidden;      /* clip any overflowing content */
  }
  .cal-day:hover:not(.cal-day-empty) { background: #f6f8ff; }
  .cal-day-empty { background: #fafafa; }
  .cal-day-num {
    font-size: 11px;
    font-weight: 600;
    color: var(--text--dark--30);
    display: block;
    margin-bottom: 3px;
    line-height: 1;
  }
  .cal-day-today .cal-day-num {
    background: var(--action-primary-blue);
    color: #fff;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    margin-bottom: 3px;
  }
  .cal-day-past { opacity: 0.5; }
  /* Events — constrained to parent cell width */
  .cal-event {
    display: block;
    font-size: 9px;
    font-weight: 600;
    padding: 2px 5px;
    border-radius: 3px;
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    cursor: pointer;
    /* Use max-width so it never expands the cell */
    max-width: 100%;
    box-sizing: border-box;
  }
  .cal-event-booking  { background: #b8caff; color: #1838c0; }
  .cal-event-blocked  { background: #fde8eb; color: #c0303d; }
  .cal-event-gcal     { background: #beffd8; color: #1a6a40; }
  .cal-event-more {
    display: block;
    font-size: 9px;
    color: var(--text--dark--30);
    padding: 1px 4px;
    cursor: pointer;
  }

  /* Upcoming events sidebar */
  .cal-upcoming-card {
    background: #fff;
    border: 1px solid var(--ui--underline--light-grey);
    border-radius: 8px;
    overflow: hidden;
    max-height: 520px;
    display: flex;
    flex-direction: column;
  }
  .cal-upcoming-header {
    padding: 12px 16px;
    background: var(--card-light-grey);
    border-bottom: 1px solid var(--ui--underline--light-grey);
    font-size: 12px;
    font-weight: 700;
    color: var(--text--dark--40);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .cal-upcoming-body { flex: 1; overflow-y: auto; }
  .cal-upcoming-item {
    padding: 10px 14px;
    border-bottom: 1px solid #f3f4f6;
    display: flex;
    gap: 10px;
    align-items: flex-start;
  }
  .cal-upcoming-item:last-child { border-bottom: none; }
  .cal-upcoming-date {
    min-width: 38px;
    text-align: center;
    background: var(--card-light-grey);
    border-radius: 6px;
    padding: 4px 6px;
    flex-shrink: 0;
  }
  .cal-upcoming-date-day { font-size: 16px; font-weight: 700; color: var(--text--dark--50); line-height: 1; }
  .cal-upcoming-date-mon { font-size: 9px; font-weight: 600; color: var(--text--dark--30); text-transform: uppercase; letter-spacing: 0.5px; }
  .cal-upcoming-body-text { flex: 1; min-width: 0; }
  .cal-upcoming-company { font-size: 12px; font-weight: 600; color: var(--text--dark--50); }
  .cal-upcoming-meta { font-size: 11px; color: var(--text--dark--30); margin-top: 2px; }
  .cal-upcoming-empty { padding: 32px 20px; text-align: center; color: var(--text--dark--30); font-size: 12px; }

  /* Availability badge on trainer cards */
  .trainer-availability {
    margin-top: 8px;
    padding: 6px 8px;
    background: #f0fdf4;
    border-radius: 5px;
    border: 1px solid #bbf7d0;
    font-size: 11px;
    color: #1a6a40;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .trainer-availability.loading { background: var(--card-light-grey); border-color: var(--ui--underline--light-grey); color: var(--text--dark--30); }
  .trainer-availability.busy { background: #fde8eb; border-color: #fecaca; color: #c0303d; }
  .trainer-availability.unknown { background: var(--card-light-grey); border-color: var(--ui--underline--light-grey); color: var(--text--dark--30); }

  /* Cal filter row */
  .cal-filter-row {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 14px;
    background: var(--card-light-grey);
    border-bottom: 1px solid var(--ui--underline--light-grey);
    flex-wrap: wrap;
  }
  .cal-legend-dot {
    width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;
  }
  .cal-legend-label { font-size: 11px; color: var(--text--dark--40); }

</style>
</head>
<body>

<!-- NAV OVERLAY -->
<div class="nav-overlay" id="navOverlay" onclick="closeNav()"></div>

<!-- SIDE DRAWER -->
<!-- LOGIN SCREEN -->
<div class="login-screen" id="loginScreen">
  <div class="login-card">
    <div class="login-logo">STREET<span>.</span>CO.UK</div>
    <div class="login-title">Training Dashboard</div>
    <div class="login-sub">Select your name to continue</div>
    <div class="login-user-grid" id="loginUserGrid">
      <div class="login-no-users">No users set up yet.<br>An admin needs to add trainers first.</div>
    </div>
    <div style="text-align:center;font-size:11px;color:var(--text--dark--20);margin-top:8px;">
      Permissions are managed in the Trainer settings
    </div>
  </div>
</div>

<!-- PIN ENTRY SCREEN -->
<div class="pin-screen hidden" id="pinScreen">
  <div class="pin-card">
    <div class="pin-avatar" id="pinAvatar">?</div>
    <div class="pin-user-name" id="pinUserName">—</div>
    <div class="pin-label" id="pinLabel">Enter your 4-digit passcode</div>
    <div id="pinSetupInfo" class="pin-setup-info" style="display:none;">
      Choose a 4-digit passcode to protect your account.<br>You'll need this every time you log in.
    </div>
    <div class="pin-dots">
      <div class="pin-dot" id="pd0"></div>
      <div class="pin-dot" id="pd1"></div>
      <div class="pin-dot" id="pd2"></div>
      <div class="pin-dot" id="pd3"></div>
    </div>
    <div class="pin-error-msg" id="pinError"></div>
    <div class="pin-keypad">
      <button class="pin-key" onclick="pinKey('1')">1</button>
      <button class="pin-key" onclick="pinKey('2')">2</button>
      <button class="pin-key" onclick="pinKey('3')">3</button>
      <button class="pin-key" onclick="pinKey('4')">4</button>
      <button class="pin-key" onclick="pinKey('5')">5</button>
      <button class="pin-key" onclick="pinKey('6')">6</button>
      <button class="pin-key" onclick="pinKey('7')">7</button>
      <button class="pin-key" onclick="pinKey('8')">8</button>
      <button class="pin-key" onclick="pinKey('9')">9</button>
      <button class="pin-key" onclick="pinKey('0')" style="grid-column:2;">0</button>
      <button class="pin-key del" onclick="pinDel()">⌫</button>
    </div>
    <div id="pinForgotWrap" style="margin-top:4px;">
      <button class="pin-back-btn" onclick="pinForgot()">Forgot passcode?</button>
    </div>
    <div style="margin-top:10px;">
      <button class="pin-back-btn" onclick="pinBack()">← Back to user select</button>
    </div>
  </div>
</div>


<!-- SHADOW MODE BANNER -->
<div class="shadow-banner" id="shadowBanner">
  <div class="shadow-banner-left">
    <span class="shadow-banner-pill">👁 Preview Mode</span>
    <span>Viewing dashboard as</span>
    <span class="shadow-banner-name" id="shadowBannerName">—</span>
  </div>
  <div class="shadow-banner-right">
    <span style="font-size:11px;opacity:0.75;">Changes to permissions apply live — exit to save</span>
    <button class="shadow-exit-btn" onclick="exitShadowMode()">← Exit Preview</button>
    <button class="shadow-save-btn" onclick="saveShadowAndExit()">✓ Save &amp; Back to Edit</button>
  </div>
</div>

<nav class="nav-drawer" id="navDrawer">
  <div class="nav-drawer-header">
    <span class="nav-drawer-title">Navigation</span>
    <button class="nav-close" onclick="closeNav()">✕</button>
  </div>
  <div class="nav-section-label">Dashboard</div>
  <a href="#" class="nav-item active" onclick="closeNav()">
    <span class="nav-item-icon">📊</span> Training Dashboard
  </a>
  <div class="nav-divider"></div>
  <div class="nav-section-label">Tools</div>
  <a href="https://amydawber-del.github.io/TrainingCSAT/dashboard.html" class="nav-item" target="_blank">
    <span class="nav-item-icon">⭐</span> Training Feedback Dashboard
  </a>
  <a href="https://amydawber-del.github.io/TilTracker/" class="nav-item" target="_blank">
    <span class="nav-item-icon">📚</span> TIL Tracker
  </a>
  <a href="https://amydawber-del.github.io/TrainingCSAT/" class="nav-item" target="_blank">
    <span class="nav-item-icon">📋</span> Client Feedback Survey
  </a>
  <div class="nav-divider"></div>
  <div class="nav-section-label">Resources</div>
  <a href="https://docs.google.com/spreadsheets/d/1r_HODYw7kIMpWm8TNcXwJmZQuk0lsjVR6SEl2teytJM/edit" class="nav-item" target="_blank">
    <span class="nav-item-icon">📄</span> Bookings Spreadsheet
  </a>
  <a href="https://docs.google.com/forms/d/e/1FAIpQLSe-s3SWoPSaIanCZLMLYNnVmu3NU-LY4Lm7Db12gHLv6LzVuQ/viewform" class="nav-item" target="_blank">
    <span class="nav-item-icon">📝</span> Training Request Form
  </a>
</nav>

<!-- HEADER -->
<header class="header">
  <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleNav()" aria-label="Menu">
    <span></span><span></span><span></span>
  </button>

  <a href="#" class="street-logo">
    <div>
      <div class="street-logo-mark">STREET<span class="logo-dot">.</span><span style="font-size:9px;font-weight:400;letter-spacing:0;">CO.UK</span></div>
    </div>
  </a>

  <div class="header-title">Training Dashboard</div>

  <div class="header-right">
    <span class="last-updated" id="lastUpdated">—</span>
    <div id="headerUserChip" style="display:none;align-items:center;gap:7px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:20px;padding:4px 12px 4px 6px;">
      <div id="headerUserAvatar" style="width:24px;height:24px;border-radius:50%;background:var(--action-primary-blue);color:#fff;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;">?</div>
      <span id="headerUserName" style="font-size:12px;font-weight:600;color:#ddd;">—</span>
    </div>
    <button class="activity-btn" onclick="openActivityPanel()" title="Activity Feed" id="activityNavBtn">
      <span>🕐</span> Activity
      <span class="activity-btn-dot" id="activityBtnDot"></span>
    </button>
    <button class="activity-btn" onclick="logout()" id="logoutBtn" style="display:none;border-color:rgba(192,48,61,0.4);color:#f88;background:rgba(192,48,61,0.15);" title="Log out">
      ⏏ Log out
    </button>
    <button class="refresh-btn" onclick="testConnection(this)" style="background:rgba(255,200,0,0.15);border-color:rgba(255,200,0,0.3);">🔍 Test</button>
    <button class="refresh-btn" onclick="loadData()">↻ Refresh</button>
  </div>
</header>

<div class="loading-bar" id="loadingBar"></div>

<!-- MAIN -->
<main class="main">

  <!-- TRAINER WORKLOAD -->
  <div style="margin-bottom:24px;">
    <div class="section-header">
      <div class="section-title">👤 Trainer Workload</div>
      <div style="display:flex;align-items:center;gap:10px;">
        <span style="font-size:11px;color:var(--text--dark--30);">Last 30 days + upcoming</span>
        <button class="refresh-btn" onclick="openTrainerModal()" style="background:rgba(33,71,244,0.1);border-color:rgba(33,71,244,0.3);color:var(--action-primary-blue);font-size:11px;">+ Manage Trainers</button>
      </div>
    </div>
    <div class="trainer-grid" id="trainerGrid">
      <div class="kpi-card" style="text-align:center;color:var(--text--dark--30);font-size:12px;grid-column:1/-1;">Loading trainer data...</div>
    </div>
  </div>

  <!-- CALENDAR SECTION -->
  <div class="cal-section" id="calSection">
    <div class="section-header">
      <div class="section-title">📅 Training Calendar</div>
      <div style="display:flex;align-items:center;gap:10px;">
        <span style="font-size:11px;color:var(--text--dark--30);" id="calGcalStatus">
          <span id="calGcalDot" style="display:inline-block;width:7px;height:7px;border-radius:50%;background:#ccc;margin-right:4px;vertical-align:middle;"></span>
          Calendar not connected
        </span>
        <button class="refresh-btn" onclick="loadCalendarData(true)" style="font-size:11px;">↻ Sync Calendar</button>
        <button class="refresh-btn" onclick="openCalSettings()" style="font-size:11px;background:rgba(33,71,244,0.1);border-color:rgba(33,71,244,0.3);color:var(--action-primary-blue);">⚙ Calendar Settings</button>
      </div>
    </div>

    <div class="cal-grid">
      <!-- Month view -->
      <div class="cal-month-card">
        <div class="cal-month-header">
          <button class="cal-nav-btn" onclick="calChangeMonth(-1)">‹</button>
          <div class="cal-month-title" id="calMonthTitle">—</div>
          <button class="cal-nav-btn" onclick="calChangeMonth(1)">›</button>
        </div>
        <div class="cal-filter-row">
          <div style="display:flex;align-items:center;gap:5px;">
            <div class="cal-legend-dot" style="background:#b8caff;"></div>
            <span class="cal-legend-label">Bookings</span>
          </div>
          <div style="display:flex;align-items:center;gap:5px;">
            <div class="cal-legend-dot" style="background:#beffd8;"></div>
            <span class="cal-legend-label">Google Calendar</span>
          </div>
          <div style="display:flex;align-items:center;gap:5px;">
            <div class="cal-legend-dot" style="background:#fde8eb;"></div>
            <span class="cal-legend-label">Blocked / Busy</span>
          </div>
          <div style="margin-left:auto;">
            <select id="calFilterTrainer" onchange="renderCalendar()"
              style="font-size:11px;border:1px solid var(--ui--underline--light-grey);border-radius:4px;padding:3px 7px;font-family:Arial,sans-serif;background:#fff;">
              <option value="">All Trainers</option>
            </select>
          </div>
        </div>
        <div class="cal-dow-row">
          <div class="cal-dow">Mon</div><div class="cal-dow">Tue</div>
          <div class="cal-dow">Wed</div><div class="cal-dow">Thu</div>
          <div class="cal-dow">Fri</div><div class="cal-dow">Sat</div>
          <div class="cal-dow">Sun</div>
        </div>
        <div class="cal-days" id="calDays"></div>
      </div>

      <!-- Upcoming sidebar -->
      <div class="cal-upcoming-card">
        <div class="cal-upcoming-header">
          <span>Upcoming Sessions</span>
          <span id="calUpcomingCount" style="font-size:10px;color:var(--text--dark--30);">—</span>
        </div>
        <div class="cal-upcoming-body" id="calUpcomingBody">
          <div class="cal-upcoming-empty">Loading...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- NEW REQUESTS SECTION -->
  <div style="margin-bottom:24px;">
    <div class="section-header">
      <div class="section-title">
        🔔 Unassigned Requests
        <span class="badge" id="unassignedBadge">0</span>
      </div>
      <div class="filter-bar">
        <input class="filter-input" id="searchInput" type="text" placeholder="Search client, option..." oninput="filterRequests()" style="width:200px;">
      </div>
    </div>

    <div class="requests-panel">
      <div class="requests-panel-header">
        <div class="requests-panel-header-left">
          <div class="alert-dot" id="alertDot" style="display:none;"></div>
          <span style="font-size:12px;font-weight:600;color:var(--text--dark--40);">New training requests awaiting trainer assignment</span>
        </div>
        <span style="font-size:11px;color:var(--text--dark--30);">Round-robin suggestion shown in blue</span>
      </div>
      <div class="table-wrap">
        <table id="newRequestsTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Company</th>
              <th>Contact</th>
              <th>Option</th>
              <th>Trainer</th>
              <th>Value</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="newRequestsBody">
            <tr><td colspan="7" style="padding:20px;text-align:center;color:var(--text--dark--30);">Connecting…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- NEEDS ACTION PANEL -->
  <div style="margin-bottom:24px;">
    <div class="section-header">
      <div class="section-title" style="color:#8a5a2a;">
        ⚠️ Needs Action — Assigned &amp; Pending
        <span class="badge" id="actionBadge" style="background:var(--brand-accent--mandarin-light);color:#a04010;">0</span>
      </div>
      <span style="font-size:11px;color:var(--text--dark--30);">These need to be confirmed as Booked or marked Cancelled</span>
    </div>
    <div class="requests-panel" style="border-color:var(--brand-accent--mandarin-light);">
      <div class="requests-panel-header" style="background:var(--brand-accent--cream);">
        <div class="requests-panel-header-left">
          <div class="alert-dot" id="actionDot" style="display:none;background:#f59e0b;"></div>
          <span style="font-size:12px;font-weight:600;color:var(--text--dark--40);">Assigned or pending bookings awaiting confirmation</span>
        </div>
        <span style="font-size:11px;color:var(--text--dark--30);">Update status directly from this panel</span>
      </div>
      <div class="table-wrap">
        <table id="actionRequestsTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Company</th>
              <th>Contact</th>
              <th>Option</th>
              <th>Trainer</th>
              <th>Value</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="actionRequestsBody">
            <tr><td colspan="7" style="padding:20px;text-align:center;color:var(--text--dark--30);">Connecting…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- KPI CARDS -->
  <div style="margin-bottom:16px;">
    <div class="section-title" style="margin-bottom:14px;">📈 Performance Overview</div>
  </div>
  <div class="kpi-grid">
    <div class="kpi-card kpi-accent-left clickable" onclick="openKpiModal('revYear')" title="Click for breakdown">
      <div class="kpi-card-label">Total Revenue This Year <span style="font-weight:400;color:var(--accent--blue--300);">(Booked)</span></div>
      <div class="kpi-card-value" id="kpiRevYear">£—</div>
      <div class="kpi-card-sub">Exc. VAT · click for detail</div>
    </div>
    <div class="kpi-card kpi-accent-left kpi-accent-yellow clickable" onclick="openKpiModal('revMonth')" title="Click for breakdown">
      <div class="kpi-card-label">Revenue This Month <span style="font-weight:400;color:var(--accent--blue--300);">(Booked)</span></div>
      <div class="kpi-card-value" id="kpiRevMonth">£—</div>
      <div id="kpiRevMonthDelta"></div>
    </div>
    <div class="kpi-card kpi-accent-left kpi-accent-green clickable" onclick="openKpiModal('avgFee')" title="Click for breakdown">
      <div class="kpi-card-label">Avg Training Fee (Year) <span style="font-weight:400;color:var(--accent--blue--300);">(Booked)</span></div>
      <div class="kpi-card-value" id="kpiAvgFee">£—</div>
      <div class="kpi-card-sub">Per booking · click for detail</div>
    </div>
    <div class="kpi-card kpi-accent-left kpi-accent-orange clickable" onclick="openKpiModal('days')" title="Click for breakdown">
      <div class="kpi-card-label">Training Days This Year</div>
      <div class="kpi-card-value" id="kpiDaysYear">—</div>
      <div class="kpi-card-sub" id="kpiDaysMonth">— this month</div>
    </div>
    <div class="kpi-card kpi-accent-left clickable" style="border-left-color:#9c27b0;" onclick="openKpiModal('bookings')" title="Click for breakdown">
      <div class="kpi-card-label">Total Bookings (Year)</div>
      <div class="kpi-card-value" id="kpiBookingsYear">—</div>
      <div class="kpi-card-sub" id="kpiBookingsMonth">— this month</div>
    </div>
  </div>

  <!-- CHARTS -->
  <div class="charts-grid">
    <div class="chart-card">
      <div class="chart-title">Monthly Revenue</div>
      <div class="chart-subtitle">This year vs last year (exc. VAT)</div>
      <div class="chart-container" style="height:240px;">
        <canvas id="revenueChart"></canvas>
      </div>
    </div>
    <div class="chart-card">
      <div class="chart-title">Month Comparison</div>
      <div class="chart-subtitle">This month vs last month</div>
      <div class="compare-cards">
        <div class="compare-card">
          <div class="compare-card-label" id="thisMonthLabel">This Month</div>
          <div class="compare-card-value" id="thisMonthRev">£—</div>
        </div>
        <div class="compare-card">
          <div class="compare-card-label" id="lastMonthLabel">Last Month</div>
          <div class="compare-card-value" id="lastMonthRev">£—</div>
        </div>
      </div>
      <div class="chart-container" style="height:150px;">
        <canvas id="optionChart"></canvas>
      </div>
      <div class="chart-subtitle" style="margin-top:10px;margin-bottom:0;">Bookings by training option (this year)</div>
    </div>
  </div>

  <!-- ALL BOOKINGS -->
  <div>
    <div class="section-header" style="flex-wrap:wrap;gap:10px;">
      <div class="section-title">
        📋 All Bookings
        <span class="badge green" id="allBadge">0</span>
      </div>
      <div class="filter-bar" style="flex-wrap:wrap;gap:6px;">
        <div style="position:relative;display:flex;align-items:center;">
          <span style="position:absolute;left:9px;font-size:13px;color:var(--text--dark--30);pointer-events:none;">🔍</span>
          <input class="filter-input" id="bookingSearch" type="text" placeholder="Search company or contact…"
            oninput="resetPageAndRender()"
            style="width:210px;padding-left:30px;">
        </div>
        <select class="filter-select" id="filterStatus" onchange="resetPageAndRender()">
          <option value="">All Statuses</option>
          <option value="Unassigned">Unassigned</option>
          <option value="Assigned">Assigned</option>
          <option value="Booked">Booked</option>
          <option value="Pending">Pending</option>
          <option value="Cancelled">Cancelled</option>
        </select>
        <select class="filter-select" id="filterTrainer" onchange="resetPageAndRender()">
          <option value="">All Trainers</option>
        </select>
        <select class="filter-select" id="filterOption" onchange="resetPageAndRender()">
          <option value="">All Options</option>
          <option value="1">Option 1</option>
          <option value="2">Option 2</option>
          <option value="3">Option 3</option>
          <option value="4">Option 4</option>
          <option value="5">Option 5</option>
        </select>
        <div style="display:flex;align-items:center;gap:4px;">
          <label style="font-size:11px;color:var(--text--dark--30);white-space:nowrap;">From</label>
          <input class="filter-input" id="filterDateFrom" type="date"
            onchange="resetPageAndRender()" style="width:130px;">
        </div>
        <div style="display:flex;align-items:center;gap:4px;">
          <label style="font-size:11px;color:var(--text--dark--30);white-space:nowrap;">To</label>
          <input class="filter-input" id="filterDateTo" type="date"
            onchange="resetPageAndRender()" style="width:130px;">
        </div>
        <button class="btn btn-ghost btn-sm" id="clearFiltersBtn" onclick="clearBookingFilters()" style="display:none;white-space:nowrap;">✕ Clear</button>
      </div>
    </div>
    <div class="all-bookings">
      <div class="table-wrap">
        <table id="allBookingsTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Company</th>
              <th>Contact</th>
              <th>Option</th>
              <th>Trainer</th>
              <th>Value</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="allBookingsBody">
            <tr><td colspan="7"><div class="empty-state"><div class="spinner"></div><div class="empty-state-text" style="margin-top:8px;color:var(--text--dark--30);">Connecting to sheet…</div></div></td></tr>
          </tbody>
        </table>
      </div>
      <div class="pagination" id="paginationBar">
        <button class="page-btn" id="prevBtn" onclick="changePage(-1)">← Prev</button>
        <span id="pageInfo">Page 1</span>
        <button class="page-btn" id="nextBtn" onclick="changePage(1)">Next →</button>
        <span style="margin-left:auto;" id="rowCount"></span>
      </div>
      <div class="data-note">Data pulled from Google Sheets via Apps Script. Click Refresh to get latest data.</div>
    </div>
  </div>

</main>


<!-- TRAINER MANAGEMENT MODAL -->
<div class="modal-overlay" id="trainerModalOverlay" onclick="closeTrainerModal(event)">
  <div class="modal" style="max-width:600px;width:96vw;">
    <div class="modal-header">
      <span class="modal-title">👤 Manage Trainers &amp; Permissions</span>
      <button class="modal-close" onclick="closeTrainerModal()">✕</button>
    </div>
    <div class="modal-body" style="padding:0;">
      <!-- Trainer list -->
      <div style="padding:16px 20px 0;">
        <div class="trainer-list" id="trainerModalList"></div>
      </div>
      <!-- Add new trainer section -->
      <div style="padding:16px 20px;border-top:1px solid var(--ui--underline--light-grey);background:var(--card-light-grey);">
        <div style="font-size:11px;font-weight:700;letter-spacing:0.6px;text-transform:uppercase;color:var(--text--dark--30);margin-bottom:10px;">Add New Trainer</div>
        <div style="display:flex;gap:8px;margin-bottom:12px;">
          <input class="trainer-add-input" id="newTrainerInput" type="text" placeholder="Trainer name…"
            style="flex:1;" onkeydown="if(event.key==='Enter') addTrainer()">
        </div>
        <!-- Permission presets -->
        <div style="font-size:11px;font-weight:600;color:var(--text--dark--40);margin-bottom:6px;">Permission Preset</div>
        <div class="perm-preset-row" id="presetBtns">
          <button class="perm-preset-btn" onclick="applyPreset('admin')">👑 Admin</button>
          <button class="perm-preset-btn" onclick="applyPreset('editor')">✏️ Editor</button>
          <button class="perm-preset-btn" onclick="applyPreset('viewer')">👁 View Only</button>
        </div>
        <!-- Permissions -->
        <div id="newTrainerPermissions" style="background:#fff;border:1px solid var(--ui--underline--light-grey);border-radius:6px;padding:10px 14px;margin-bottom:12px;max-height:260px;overflow-y:auto;">
          <!-- Rendered by JS -->
        </div>
        <button class="btn btn-primary" onclick="addTrainer()" style="width:100%;justify-content:center;">+ Add Trainer</button>
      </div>
    </div>
  </div>
</div>


<!-- REASSIGN TRAINER MODAL -->
<div class="modal-overlay" id="reassignModalOverlay">
  <div class="modal" style="max-width:480px;">
    <div class="modal-header" style="background:#fef3f2;border-bottom:1px solid #fecaca;">
      <span class="modal-title" style="color:#c0303d;">⚠️ Trainer Has Active Enquiries</span>
    </div>
    <div class="modal-body">
      <div id="reassignWarningText" style="font-size:13px;color:var(--text--dark--50);margin-bottom:16px;line-height:1.5;"></div>
      <div style="background:var(--card-light-grey);border-radius:6px;padding:12px;margin-bottom:16px;">
        <div id="reassignEnquiryList" style="font-size:12px;max-height:180px;overflow-y:auto;"></div>
      </div>
      <div style="margin-bottom:6px;">
        <label style="font-size:12px;font-weight:600;color:var(--text--dark--40);display:block;margin-bottom:6px;">Reassign all enquiries to:</label>
        <select id="reassignTargetSelect" style="width:100%;border:1px solid var(--ui--underline--light-grey);border-radius:6px;padding:8px 10px;font-size:13px;font-family:Arial,sans-serif;background:#fff;">
          <option value="">— Select a trainer —</option>
        </select>
      </div>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;padding:14px 20px;border-top:1px solid var(--ui--underline--light-grey);background:var(--card-light-grey);">
      <button class="btn btn-ghost" onclick="closeReassignModal()">Cancel</button>
      <button class="btn" id="confirmReassignBtn"
        onclick="confirmReassignAndDelete()"
        style="background:#c0303d;color:#fff;border:none;">
        Reassign &amp; Remove Trainer
      </button>
    </div>
  </div>
</div>

<!-- KPI DETAIL MODAL -->
<div class="kpi-modal-overlay" id="kpiModalOverlay" onclick="closeKpiModal(event)">
  <div class="kpi-modal">
    <div class="kpi-modal-header">
      <div class="kpi-modal-header-left">
        <div class="kpi-modal-title" id="kpiModalTitle">—</div>
        <div class="kpi-modal-subtitle" id="kpiModalSubtitle">—</div>
        <div class="kpi-modal-headline" id="kpiModalHeadline">—</div>
      </div>
      <button class="kpi-modal-close" onclick="closeKpiModal()">✕ Close</button>
    </div>
    <div class="kpi-modal-stats" id="kpiModalStats"></div>
    <div class="kpi-modal-body">
      <table class="kpi-modal-table">
        <thead id="kpiModalTableHead"></thead>
        <tbody id="kpiModalTableBody"></tbody>
      </table>
    </div>
    <div class="kpi-modal-footer">
      <button class="btn btn-ghost" onclick="closeKpiModal()">✕ Close</button>
    </div>
  </div>
</div>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toastContainer"></div>

<script>
// =============================================
// CONFIG
// =============================================
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzCvBhFSPyyoaVsui0DCxvGQQa0V7e_UCJ5LfqvcSysTHTFlNRcx4ewlET5TyouJ0ZYow/exec';
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSvPvb_WzFGr6SKflZEob3RFpuh44lKckD4DcsoAXxKUwtYBGCtGGEqA9YkSnvBKh3pQc9nwdbfh9B2/pub?gid=1792679763&single=true&output=csv';

// Training option prices (exc. VAT)
const OPTION_PRICES = { '1': 0, '2': 1100, '3': 1850, '4': 1000, '5': 220 };
const OPTION_LABELS = {
  '1': 'On Demand + Help Centre',
  '2': 'Personalised 1 Day',
  '3': 'Personalised 2 Day',
  '4': 'Accounting + Go Live',
  '5': 'Live HQ Session'
};
const OPTION_DAYS = { '1': 0, '2': 1, '3': 2, '4': 1, '5': 1 };

// =============================================
// PERMISSIONS SYSTEM
// =============================================
const USERS_KEY   = 'streetDashboardUsers_v2';
const SESSION_KEY = 'streetDashboardSession';

const ALL_PERMISSIONS = {
  edit_status:       { label: 'Edit Booking Status',     desc: 'Change status of any booking',             group: 'Bookings'   },
  edit_trainer:      { label: 'Edit Trainer Assignment', desc: 'Assign or change the trainer on a booking', group: 'Bookings'   },
  edit_value:        { label: 'Edit Invoice Value',      desc: 'Change the £ value of any booking',         group: 'Bookings'   },
  edit_booked_date:  { label: 'Edit Booked Date',        desc: 'Set or change the confirmed training date', group: 'Bookings'   },
  manage_trainers:   { label: 'Manage Trainers',         desc: 'Add, remove and edit trainer permissions',  group: 'Admin'      },
  reassign_trainers: { label: 'Reassign Enquiries',      desc: 'Bulk-reassign enquiries between trainers',  group: 'Admin'      },
  clear_activity:    { label: 'Clear Activity Log',      desc: 'Permanently delete the activity feed',      group: 'Admin'      },
  refresh_data:      { label: 'Refresh Data',            desc: 'Reload data from Google Sheets',            group: 'Admin'      },
  view_kpis:         { label: 'View Performance KPIs',  desc: 'See revenue, bookings and training days',    group: 'Analytics'  },
  view_charts:       { label: 'View Charts',             desc: 'Monthly revenue and option charts',         group: 'Analytics'  },
  view_activity:     { label: 'View Activity Feed',      desc: 'See the log of all dashboard changes',      group: 'Analytics'  },
};

const PERMISSION_PRESETS = {
  admin:  { edit_status:true, edit_trainer:true, edit_value:true, edit_booked_date:true, manage_trainers:true,  reassign_trainers:true,  clear_activity:true,  refresh_data:true,  view_kpis:true, view_charts:true, view_activity:true  },
  editor: { edit_status:true, edit_trainer:true, edit_value:true, edit_booked_date:true, manage_trainers:false, reassign_trainers:true,  clear_activity:false, refresh_data:true,  view_kpis:true, view_charts:true, view_activity:true  },
  viewer: { edit_status:false,edit_trainer:false,edit_value:false,edit_booked_date:false,manage_trainers:false, reassign_trainers:false, clear_activity:false, refresh_data:false, view_kpis:true, view_charts:true, view_activity:true  },
};

// Bookings-only preset for Max
const BOOKINGS_ONLY_PRESET = { edit_status:true, edit_trainer:true, edit_value:true, edit_booked_date:true, manage_trainers:false, reassign_trainers:false, clear_activity:false, refresh_data:false, view_kpis:false, view_charts:false, view_activity:false };

function getUsers() {
  let users = [];
  try {
    const saved = JSON.parse(localStorage.getItem(USERS_KEY) || 'null');
    if (Array.isArray(saved)) users = saved;
  } catch(e) {}

  // Always enforce Amy exists with full admin — no matter what localStorage holds
  let amy = users.find(u => u.name === 'Amy');
  if (!amy) {
    amy = { name: 'Amy', permissions: {} };
    users.unshift(amy);
  }
  amy.permissions = { ...PERMISSION_PRESETS.admin }; // always force all perms on

  // Always enforce Max exists with bookings-only
  let max = users.find(u => u.name === 'Max');
  if (!max) {
    max = { name: 'Max', permissions: {} };
    const amyIdx = users.findIndex(u => u.name === 'Amy');
    users.splice(amyIdx + 1, 0, max);
  }
  max.permissions = { ...BOOKINGS_ONLY_PRESET }; // always force bookings-only

  // Persist so next call reads correctly
  try { localStorage.setItem(USERS_KEY, JSON.stringify(users)); } catch(e) {}

  return users;
}

function saveUsers(arr) {
  try { localStorage.setItem(USERS_KEY, JSON.stringify(arr)); } catch(e) {}
}

function getCurrentUser() {
  try { const s = localStorage.getItem(SESSION_KEY); return s ? JSON.parse(s) : null; } catch(e) { return null; }
}

function setCurrentUser(userObj) {
  try { localStorage.setItem(SESSION_KEY, JSON.stringify(userObj)); } catch(e) {}
  try { localStorage.setItem('streetDashboardUser', userObj.name); } catch(e) {}
}

function hasPerm(key) {
  const u = getCurrentUser();
  return u && u.permissions && u.permissions[key] === true;
}

// TRAINERS array derived from users (used throughout for assignment dropdowns)
let USERS    = getUsers();
let TRAINERS = USERS.map(u => u.name);

function syncTrainersFromUsers() {
  USERS    = getUsers();
  TRAINERS = USERS.map(u => u.name);
}

// Migration: always enforce Amy = full admin, Max = bookings-only.
// Adds them if missing. Refreshes any active session for these users.
function migrateUsers() {
  let changed = false;

  // ── Amy: must exist with ALL permissions on ───────────────────
  let amy = USERS.find(u => u.name === 'Amy');
  if (!amy) {
    USERS.unshift({ name: 'Amy', permissions: { ...PERMISSION_PRESETS.admin } });
    changed = true;
  } else {
    const allOn = Object.keys(PERMISSION_PRESETS.admin).every(k => amy.permissions[k] === true);
    if (!allOn) {
      amy.permissions = { ...PERMISSION_PRESETS.admin };
      changed = true;
    }
  }

  // ── Max: must exist with Bookings group only ──────────────────
  let max = USERS.find(u => u.name === 'Max');
  if (!max) {
    // Insert Max after Amy
    const amyIdx = USERS.findIndex(u => u.name === 'Amy');
    USERS.splice(amyIdx + 1, 0, { name: 'Max', permissions: { ...BOOKINGS_ONLY_PRESET } });
    changed = true;
  } else {
    const correct = Object.keys(BOOKINGS_ONLY_PRESET).every(k => max.permissions[k] === BOOKINGS_ONLY_PRESET[k]);
    if (!correct) {
      max.permissions = { ...BOOKINGS_ONLY_PRESET };
      changed = true;
    }
  }

  if (changed) {
    saveUsers(USERS);
    syncTrainersFromUsers();
  }

  // Always refresh active session in case perms changed
  const cur = getCurrentUser();
  if (cur && (cur.name === 'Amy' || cur.name === 'Max')) {
    const fresh = USERS.find(u => u.name === cur.name);
    if (fresh) setCurrentUser(fresh);
  }
}

// =============================================
// STATE
// =============================================
let allData = [];
let currentPage = 1;
const PAGE_SIZE = 15;
let revenueChart = null;
let optionChart = null;

// =============================================
// LOCAL OVERRIDE CACHE
// Persists user edits across refreshes so sheet
// latency doesn't reset fields the user changed.
// =============================================
const OVERRIDE_KEY = 'streetDashboardOverrides';

function getOverrides() {
  try { return JSON.parse(sessionStorage.getItem(OVERRIDE_KEY) || '{}'); } catch(e) { return {}; }
}

function saveOverride(rowIndex, fields) {
  const overrides = getOverrides();
  overrides[rowIndex] = Object.assign(overrides[rowIndex] || {}, fields);
  try { sessionStorage.setItem(OVERRIDE_KEY, JSON.stringify(overrides)); } catch(e) {}
}

function applyOverrides(rows) {
  const overrides = getOverrides();
  return rows.map(r => {
    const ov = overrides[r.rowIndex];
    if (!ov) return r;
    return Object.assign({}, r, ov);
  });
}

// =============================================
// NAV
// =============================================
function toggleNav() {
  const drawer = document.getElementById('navDrawer');
  const overlay = document.getElementById('navOverlay');
  const btn = document.getElementById('hamburgerBtn');
  const isOpen = drawer.classList.contains('open');
  if (isOpen) { closeNav(); } else {
    drawer.classList.add('open');
    overlay.classList.add('open');
    btn.classList.add('open');
  }
}
function closeNav() {
  document.getElementById('navDrawer').classList.remove('open');
  document.getElementById('navOverlay').classList.remove('open');
  document.getElementById('hamburgerBtn').classList.remove('open');
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeNav(); });

// =============================================
// TOAST
// =============================================
function showToast(msg, type = '') {
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.textContent = msg;
  document.getElementById('toastContainer').appendChild(t);
  setTimeout(() => t.remove(), 3500);
}

// =============================================
// LOADING
// =============================================
function setLoading(on) {
  document.getElementById('loadingBar').classList.toggle('active', on);
}

// =============================================
// DATA FETCHING
// =============================================


// Quick connection test
async function testConnection() {
  const btn = event.target;
  btn.textContent = '⏳…';
  btn.disabled = true;
  try {
    const url = APPS_SCRIPT_URL + '?action=getData';
    const res = await fetch(url);
    const text = await res.text();
    const isJSON = text.trim().startsWith('{');
    let info = 'Status: ' + res.status + '\nIs JSON: ' + isJSON;
    if (isJSON) {
      const json = JSON.parse(text);
      info += '\nRows: ' + (json.data ? json.data.length : 'none');
      info += '\nSuccess: ' + json.success;
      if (json.error) info += '\nError: ' + json.error;
    } else {
      info += '\nResponse (first 200 chars):\n' + text.slice(0, 200);
    }
    alert(info);
  } catch(e) {
    alert('FAILED: ' + e.message + '\n\nMake sure Apps Script is deployed as:\n• Execute as: Me\n• Who has access: Anyone');
  }
  btn.textContent = '🔍 Test';
  btn.disabled = false;
}

async function loadData() {
  setLoading(true);
  document.getElementById('lastUpdated').textContent = 'Loading…';

  // Safety net — never leave spinners forever
  const safetyTimer = setTimeout(() => {
    if (allData.length === 0) {
      allData = applyOverrides(generateDemoData());
      processData();
      document.getElementById('lastUpdated').textContent = '⚠ Timed out';
      showToast('Sheet unreachable. Click 🔍 Test to diagnose.', 'error');
      setLoading(false);
    }
  }, 14000);

  // ── 1. Apps Script ──
  try {
    const res = await fetch(APPS_SCRIPT_URL + '?action=getData');
    const text = await res.text();
    if (text && text.trim().startsWith('{')) {
      const json = JSON.parse(text);
      if (json && json.data && json.data.length > 1) {
        clearTimeout(safetyTimer);
        allData = applyOverrides(parseAppsScriptData(json.data));
        processData();
        document.getElementById('lastUpdated').textContent = '✓ Live — ' + new Date().toLocaleTimeString();
        setLoading(false);
        return;
      }
      if (json && json.error) showToast('Sheet error: ' + json.error, 'error');
    } else {
      console.warn('Apps Script non-JSON response:', text.slice(0, 150));
    }
  } catch(e) {
    console.warn('Apps Script failed:', e.message);
  }

  // ── 2. CSV fallback ──
  try {
    const res2 = await fetch(CSV_URL);
    const text2 = await res2.text();
    if (text2 && text2.length > 100 && text2.includes(',')) {
      clearTimeout(safetyTimer);
      allData = applyOverrides(parseCSV(text2));
      processData();
      document.getElementById('lastUpdated').textContent = '⚠ CSV — ' + new Date().toLocaleTimeString();
      showToast('Loaded via CSV. Apps Script write-back may not work — check deployment.', '');
      setLoading(false);
      return;
    }
  } catch(e) {
    console.warn('CSV failed:', e.message);
  }

  // ── 3. Demo data ──
  clearTimeout(safetyTimer);
  allData = applyOverrides(generateDemoData());
  processData();
  document.getElementById('lastUpdated').textContent = '⚠ Demo data';
  showToast('Cannot reach sheet. Click 🔍 Test to diagnose.', 'error');
  setLoading(false);
}


function fetchWithTimeout(url, ms) {
  const ctrl = new AbortController();
  setTimeout(() => ctrl.abort(), ms);
  return fetch(url, { signal: ctrl.signal, redirect: 'follow' });
}

// Parse Apps Script JSON response
// Expected: { data: [ [col1, col2, ...], ... ] } where row 0 is headers
function parseAppsScriptData(rows) {
  if (!rows || rows.length < 2) return [];
  const headers = rows[0].map(h => String(h).trim().toLowerCase());
  return rows.slice(1).map((row, i) => {
    const obj = {};
    headers.forEach((h, j) => { obj[h] = row[j] || ''; });
    return normaliseRow(obj, i + 2); // +2 for header row + 1-indexed
  }).filter(r => r.company || r.contact);
}

// Parse CSV text
function parseCSV(text) {
  const lines = text.split('\n').filter(l => l.trim());
  if (lines.length < 2) return [];
  const headers = parseCSVRow(lines[0]).map(h => h.trim().toLowerCase());
  return lines.slice(1).map((line, i) => {
    const vals = parseCSVRow(line);
    const obj = {};
    headers.forEach((h, j) => { obj[h] = (vals[j] || '').trim(); });
    return normaliseRow(obj, i + 2);
  }).filter(r => r.company || r.contact);
}

function parseCSVRow(line) {
  const result = [];
  let cur = '';
  let inQ = false;
  for (let i = 0; i < line.length; i++) {
    const c = line[i];
    if (c === '"') { inQ = !inQ; }
    else if (c === ',' && !inQ) { result.push(cur); cur = ''; }
    else { cur += c; }
  }
  result.push(cur);
  return result;
}

// Normalise a row object into our standard shape
// Column names guessed from common Google Form exports — adjust if needed
function normaliseRow(obj, rowIndex) {
  // Exact match first, then partial — prevents greedy matches like 'date' hitting 'booked date'
  const get = (...keys) => {
    for (const k of keys) {
      for (const ok of Object.keys(obj)) {
        if (ok === k) return obj[ok]; // exact
      }
    }
    for (const k of keys) {
      for (const ok of Object.keys(obj)) {
        if (ok.includes(k)) return obj[ok]; // partial fallback
      }
    }
    return '';
  };

  const timestamp = get('timestamp');
  // Exact sheet column headers from Training Form Response
  const company = get('company / business name:', 'company / business name', 'company name', 'company', 'organisation', 'business', 'agency');
  const contact = get('client stakeholder name and phone number (authorising training)', 'client stakeholder name', 'stakeholder', 'contact', 'name', 'your name');
  const email = get('email address', 'email');
  const optionRaw = get('what type of training are you interested in?', 'what type of training', 'training option', 'type of training', 'option', 'training type', 'package');
  const bookedDate = get('preferred training date(s)', 'booked date', 'booking date', 'date of training', 'preferred date', 'when');
  const preferredDate = bookedDate;
  const attendees = get('attendees', 'delegates', 'number of');
  const trainer = get('assigned trainer', 'trainer', 'assigned');
  const status = get('status');
  const notes = get('are there specific features or workflows you want to cover?', 'notes', 'additional', 'comments');
  const invoiceValue = get(' invoice value ', 'invoice value', 'invoice', 'value', 'fee', 'cost', 'price');

  // Extract option number from actual form values
  let option = '2'; // default
  const optLower = String(optionRaw).toLowerCase();
  if (optLower.includes('on demand') || optLower.includes('help centre') || optLower.includes('online sales')) {
    option = '1';
  } else if (optLower.includes('account') || optLower.includes('go-live') || optLower.includes('go live')) {
    option = '4';
  } else if (optLower.includes('hq') || optLower.includes('live training') || optLower.includes('manchester')) {
    option = '5';
  } else if (optLower.includes('2 day') || optLower.includes('2 days') || optLower.includes('back to back')) {
    option = '3';
  } else if (optLower.includes('1 day') || optLower.includes('1/2 day') || optLower.includes('personalised')) {
    option = '2';
  } else {
    const om = String(optionRaw).match(/(\d)/);
    if (om) option = om[1];
  }

  const numAttendees = parseInt(attendees) || 1;
  const basePrice = parseInt(OPTION_PRICES[option]) || 0;

  // Use Invoice Value from sheet (col U) if present, else fall back to option price
  const parsedInvoice = (invoiceValue !== '' && invoiceValue !== null && invoiceValue !== undefined) ? parseFloat(String(invoiceValue).replace(/[£,\s]/g, '')) : NaN;
  const revenue = !isNaN(parsedInvoice) && parsedInvoice > 0
    ? parsedInvoice
    : (option === '5' ? basePrice * numAttendees : basePrice);

  const parsedDate = parseDate(timestamp || preferredDate);

  return {
    rowIndex,
    timestamp: timestamp || '',
    date: parsedDate,
    company: company || obj['company name'] || '',
    contact: contact || '',
    email: email || '',
    option,
    optionLabel: OPTION_LABELS[option] || `Option ${option}`,
    preferredDate: preferredDate || '',
    attendees: numAttendees,
    trainer: trainer || '',
    status: status || (trainer ? 'Assigned' : 'Unassigned'),
    notes: notes || '',
    bookedOn: formatDateInput(get('booked on date', 'booked on', 'date booked')) || '',
    revenue
  };
}

function parseDate(str) {
  if (!str) return null;
  const s = String(str).trim();
  // Handle DD/MM/YYYY or DD/MM/YYYY HH:MM:SS (Google Sheets UK date format)
  const dmyMatch = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
  if (dmyMatch) {
    const d = new Date(Number(dmyMatch[3]), Number(dmyMatch[2]) - 1, Number(dmyMatch[1]));
    return isNaN(d.getTime()) ? null : d;
  }
  const d = new Date(s);
  return isNaN(d.getTime()) ? null : d;
}

function formatDateInput(val) {
  // Ensure value is in YYYY-MM-DD for <input type="date">
  if (!val) return '';
  const s = String(val).trim();
  // Already ISO-like (YYYY-MM-DD)
  if (/^\d{4}-\d{2}-\d{2}/.test(s)) return s.slice(0, 10);
  // DD/MM/YYYY
  const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
  if (m) return m[3] + '-' + m[2].padStart(2,'0') + '-' + m[1].padStart(2,'0');
  // Try via Date object
  const d = new Date(s);
  if (!isNaN(d.getTime())) return d.toISOString().slice(0, 10);
  return '';
}

// =============================================
// DEMO DATA GENERATOR
// =============================================
function generateDemoData() {
  const now = new Date();
  const year = now.getFullYear();
  const lastYear = year - 1;
  const rows = [];
  let rowIdx = 2;

  const companies = ['Acorn Estates', 'Bridgewater Properties', 'Chapman & Co', 'Dalton Lettings',
    'Elara Homes', 'Foxcroft Realty', 'Grange Lettings', 'Harfield & Sons',
    'Ivory Keys Properties', 'Jameson Estate Agents', 'Keystone Lettings', 'Lakewood Homes'];
  const contacts = ['James Wilson', 'Sarah Brown', 'Michael Davies', 'Emma Jones',
    'Oliver Smith', 'Charlotte Taylor', 'Harry White', 'Amelia Harris',
    'George Clark', 'Lily Walker', 'Noah Robinson', 'Sophia Lewis'];

  // This year - spread across months up to now
  for (let m = 0; m <= now.getMonth(); m++) {
    const count = 3 + Math.floor(Math.random() * 5);
    for (let i = 0; i < count; i++) {
      const day = 1 + Math.floor(Math.random() * 28);
      const dateObj = new Date(year, m, day);
      if (dateObj > now) continue;
      const opt = ['2','2','3','3','4','5','1'][Math.floor(Math.random() * 7)];
      const compIdx = (m * 3 + i) % companies.length;
      const trainerIdx = Math.floor(Math.random() * TRAINERS.length);
      const isNew = (m === now.getMonth() && i >= 2);
      const numAtt = opt === '5' ? (2 + Math.floor(Math.random() * 4)) : 1;
      rows.push({
        rowIndex: rowIdx++,
        timestamp: dateObj.toISOString(),
        date: dateObj,
        company: companies[compIdx],
        contact: contacts[compIdx],
        email: contacts[compIdx].toLowerCase().replace(' ','.')+`@${companies[compIdx].toLowerCase().replace(/[^a-z]/g,'')}.com`,
        option: opt,
        optionLabel: OPTION_LABELS[opt],
        preferredDate: new Date(year, m, day + 14).toLocaleDateString('en-GB'),
        attendees: numAtt,
        trainer: isNew ? '' : TRAINERS[trainerIdx],
        status: isNew ? 'New' : (Math.random() > 0.3 ? 'Complete' : 'Assigned'),
        notes: '',
        revenue: opt === '5' ? OPTION_PRICES[opt] * numAtt : OPTION_PRICES[opt]
      });
    }
  }

  // Last year data (for chart comparison)
  for (let m = 0; m < 12; m++) {
    const count = 2 + Math.floor(Math.random() * 4);
    for (let i = 0; i < count; i++) {
      const day = 1 + Math.floor(Math.random() * 28);
      const dateObj = new Date(lastYear, m, day);
      const opt = ['2','2','3','4','5'][Math.floor(Math.random() * 5)];
      const compIdx = (m * 2 + i) % companies.length;
      const trainerIdx = Math.floor(Math.random() * TRAINERS.length);
      const numAtt = opt === '5' ? (2 + Math.floor(Math.random() * 3)) : 1;
      rows.push({
        rowIndex: rowIdx++,
        timestamp: dateObj.toISOString(),
        date: dateObj,
        company: companies[compIdx] + ' (LY)',
        contact: contacts[compIdx],
        email: '',
        option: opt,
        optionLabel: OPTION_LABELS[opt],
        preferredDate: '',
        attendees: numAtt,
        trainer: TRAINERS[trainerIdx],
        status: 'Complete',
        notes: '',
        revenue: opt === '5' ? OPTION_PRICES[opt] * numAtt : OPTION_PRICES[opt]
      });
    }
  }

  return rows;
}

// =============================================
// PROCESS & RENDER
// =============================================
function processData() {
  renderUnassigned();
  renderActionPanel();
  renderKPIs();
  renderCharts();
  renderTrainerWorkload();
  renderAllBookings();
  populateTrainerFilter();
  populateCalTrainerFilter();
  renderCalendar();
  renderUpcoming();
  updateTrainerAvailability();
}

// =============================================
// UNASSIGNED REQUESTS
// =============================================
function renderUnassigned() {
  const now = new Date();
  const year = now.getFullYear();
  const unassigned = allData.filter(r => {
    // Hide if already actioned
    if (['Booked','Cancelled','Complete'].includes(r.status)) return false;
    // Hide if trainer assigned (they go to Needs Action panel)
    if (r.trainer && r.trainer.trim()) return false;
    // Hide records confirmed older than 2025
    if (r.date && r.date < new Date('2025-01-01')) return false;
    return true;
  });

  const search = (document.getElementById('searchInput')?.value || '').toLowerCase();
  const filtered = search
    ? unassigned.filter(r => (r.company + r.contact + r.option + r.optionLabel).toLowerCase().includes(search))
    : unassigned;

  document.getElementById('unassignedBadge').textContent = filtered.length;
  document.getElementById('alertDot').style.display = filtered.length > 0 ? 'block' : 'none';

  const suggested = getSuggestedTrainer();
  const tbody = document.getElementById('newRequestsBody');

  if (filtered.length === 0) {
    tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state">
      <div class="empty-state-icon">✅</div>
      <div class="empty-state-text">No unassigned requests — all up to date!</div>
    </div></td></tr>`;
    return;
  }

  tbody.innerHTML = filtered.map(r => {
    const trainerOpts = '<option value="">— Unassigned —</option>'
      + TRAINERS.map(t => '<option value="' + t + '"' + (r.trainer === t ? ' selected' : '') + '>' + t + '</option>').join('');
    const curStatus = r.status || 'Unassigned';
    const statusOpts = ['Unassigned','Assigned','Booked','Pending','Cancelled']
      .map(s => '<option value="' + s + '"' + (curStatus === s ? ' selected' : '') + '>' + s + '</option>').join('');
    const showDate = curStatus === 'Booked';
    const dateVal = r.bookedOn ? formatDateInput(r.bookedOn) : '';
    return '<tr id="req-row-' + r.rowIndex + '">'
      + '<td style="white-space:nowrap;">' + formatDate(r.date || r.timestamp) + '</td>'
      + '<td><strong>' + esc(r.company) + '</strong><br><span style="color:var(--text--dark--30);font-size:11px;">' + esc(r.email||'') + '</span></td>'
      + '<td>' + esc(r.contact||'') + '</td>'
      + '<td><span class="option-badge opt-' + r.option + '">Opt ' + r.option + ' — ' + esc(r.optionLabel) + '</span></td>'
      + '<td><select id="ua-trainer-' + r.rowIndex + '" onchange="onUaField(' + r.rowIndex + ')" style="min-width:90px;border:1px solid #ccc;border-radius:4px;padding:4px 7px;font-size:12px;font-family:Arial,sans-serif;">' + trainerOpts + '</select></td>'
      + '<td><div style="display:flex;align-items:center;gap:4px;"><span style="color:var(--text--dark--30);font-size:12px;">£</span>'
        + '<input type="number" id="ua-value-' + r.rowIndex + '" value="' + (r.revenue || '') + '" placeholder="0" min="0" step="50" oninput="onUaValueInput(' + r.rowIndex + ')" style="width:75px;border:1px solid #ccc;border-radius:4px;padding:4px 6px;font-size:12px;font-family:Arial,sans-serif;color:#333;"></div></td>'
      + '<td><div style="display:flex;flex-direction:column;gap:4px;">'
        + '<select id="ua-status-' + r.rowIndex + '" onchange="onUaField(' + r.rowIndex + ')" style="border:1px solid #ccc;border-radius:4px;padding:4px 7px;font-size:12px;font-family:Arial,sans-serif;font-weight:600;cursor:pointer;min-width:105px;">' + statusOpts + '</select>'
        + '<div id="ua-date-wrap-' + r.rowIndex + '" style="display:' + (showDate ? 'flex' : 'none') + ';align-items:center;">'
          + '<input type="date" id="ua-booked-date-' + r.rowIndex + '" value="' + dateVal + '" onchange="onUaField(' + r.rowIndex + ')" style="border:1px solid #2147f4;border-radius:4px;padding:3px 6px;font-size:11px;font-family:Arial,sans-serif;color:#2147f4;background:#f0f4ff;width:130px;">'
        + '</div>'
      + '</div></td>'
      + '</tr>';
  }).join('');

  filtered.forEach(r => {
    const sel = document.getElementById('ua-status-' + r.rowIndex);
    if (sel) applyStatusStyle(sel, r.status || 'Unassigned');
  });
}

function filterRequests() { renderUnassigned(); }

function getSuggestedTrainer() {
  // Count assignments in last 30 days + upcoming
  const cutoff = new Date();
  cutoff.setDate(cutoff.getDate() - 30);

  const counts = {};
  TRAINERS.forEach(t => { counts[t] = 0; });
  allData.forEach(r => {
    if (r.trainer && counts.hasOwnProperty(r.trainer)) {
      if (!r.date || r.date >= cutoff) counts[r.trainer]++;
    }
  });

  // Return trainer with fewest recent assignments
  return TRAINERS.reduce((a, b) => counts[a] <= counts[b] ? a : b);
}

// onReqValueInput removed — replaced by onUaValueInput

// ── UNASSIGNED PANEL AUTO-SAVE ─────────────────────────────────────────────

// Value input: update local state immediately (debounced save on blur)
function onUaValueInput(rowIndex) {
  const inp = document.getElementById('ua-value-' + rowIndex);
  const row = allData.find(r => r.rowIndex === rowIndex);
  if (row && inp) row.revenue = parseFloat(inp.value) || 0;
  // Debounced save
  clearTimeout(inp._saveTimer);
  inp._saveTimer = setTimeout(() => onUaField(rowIndex), 1200);
}

// Any field change in unassigned panel → auto-save
async function onUaField(rowIndex) {
  const trainerSel  = document.getElementById('ua-trainer-' + rowIndex);
  const statusSel   = document.getElementById('ua-status-' + rowIndex);
  const valueInp    = document.getElementById('ua-value-' + rowIndex);
  const dateInp     = document.getElementById('ua-booked-date-' + rowIndex);
  const dateWrap    = document.getElementById('ua-date-wrap-' + rowIndex);

  const trainer   = trainerSel  ? trainerSel.value  : '';
  const newStatus = statusSel   ? statusSel.value   : 'Unassigned';
  const newValue  = valueInp    ? (parseFloat(valueInp.value) || 0) : 0;
  const bookedOn  = dateInp     ? dateInp.value     : '';

  // Show/hide booked date field
  if (dateWrap) dateWrap.style.display = newStatus === 'Booked' ? 'flex' : 'none';
  if (statusSel) applyStatusStyle(statusSel, newStatus);

  // Update local data
  const row = allData.find(r => r.rowIndex === rowIndex);
  if (row) {
    row.trainer  = trainer;
    row.status   = newStatus;
    row.revenue  = newValue || row.revenue;
    if (bookedOn) row.bookedOn = bookedOn;
  }
  saveOverride(rowIndex, { trainer, status: newStatus, revenue: newValue || undefined, bookedOn: bookedOn || undefined });

  // Sync to All Bookings table if rendered
  const mainTrainer = document.getElementById('sel-trainer-' + rowIndex);
  if (mainTrainer) mainTrainer.value = trainer;
  const mainStatus = document.getElementById('sel-status-' + rowIndex);
  if (mainStatus) { mainStatus.value = newStatus; applyStatusStyle(mainStatus, newStatus); }
  const mainValue = document.getElementById('inp-value-' + rowIndex);
  if (mainValue && newValue) mainValue.value = newValue;

  let url = APPS_SCRIPT_URL + '?action=assign&row=' + rowIndex + '&status=' + encodeURIComponent(newStatus);
  if (trainer)  url += '&trainer='  + encodeURIComponent(trainer);
  if (newValue) url += '&value='    + newValue;
  if (bookedOn) url += '&bookedOn=' + encodeURIComponent(bookedOn);

  showToast('Saving…', '');
  try {
    await fetch(url, { method: 'GET', redirect: 'follow', mode: 'no-cors' });
    showToast('✓ Saved', 'success');
  } catch(e) {
    showToast('✓ Saved locally', '');
  }

  // Log to activity feed
  const _uaRow = allData.find(r => r.rowIndex === rowIndex);
  const _uaCo  = _uaRow ? _uaRow.company : 'Row ' + rowIndex;
  if (trainer)   logActivity('trainer', _uaCo, 'Trainer assigned to "' + newStatus + '"', 'Assigned to ' + trainer);
  else           logActivity('status',  _uaCo, 'Status set to "' + newStatus + '"', '');
  if (newValue)  logActivity('value',   _uaCo, 'Value set to £' + newValue.toLocaleString(), '');
  if (bookedOn)  logActivity('date',    _uaCo, 'Booked date set', bookedOn);

  // Re-render other panels so counts stay accurate
  renderActionPanel();
  renderTrainerWorkload();
  renderKPIs();
  renderAllBookings();
}

// =============================================
// KPIs
// =============================================
function kpiDate(r) {
  // Use Booked On Date (col W) as primary; fall back to submission date
  if (r.bookedOn) { const d = parseDate(r.bookedOn); if (d && !isNaN(d)) return d; }
  return r.date || null;
}

function renderKPIs() {
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth();
  const lastMonth = month === 0 ? 11 : month - 1;
  const lastMonthYear = month === 0 ? year - 1 : year;

  const thisYearRows  = allData.filter(r => { const d = kpiDate(r); return d && d.getFullYear() === year && r.option !== '1' && r.status === 'Booked'; });
  const thisMonthRows = allData.filter(r => { const d = kpiDate(r); return d && d.getFullYear() === year && d.getMonth() === month && r.option !== '1' && r.status === 'Booked'; });
  const lastMonthRows = allData.filter(r => { const d = kpiDate(r); return d && d.getFullYear() === lastMonthYear && d.getMonth() === lastMonth && r.option !== '1' && r.status === 'Booked'; });

  const revYear = thisYearRows.reduce((s,r) => s + r.revenue, 0);
  const revMonth = thisMonthRows.reduce((s,r) => s + r.revenue, 0);
  const revLastMonth = lastMonthRows.reduce((s,r) => s + r.revenue, 0);
  const avgFee = thisYearRows.length ? Math.round(revYear / thisYearRows.filter(r=>r.revenue>0).length) : 0;

  // Training days
  const daysYear = thisYearRows.reduce((s,r) => s + (OPTION_DAYS[r.option] || 0), 0);
  const daysMonth = thisMonthRows.reduce((s,r) => s + (OPTION_DAYS[r.option] || 0), 0);

  document.getElementById('kpiRevYear').textContent = '£' + revYear.toLocaleString();
  document.getElementById('kpiRevMonth').textContent = '£' + revMonth.toLocaleString();
  document.getElementById('kpiAvgFee').textContent = avgFee ? '£' + avgFee.toLocaleString() : '—';
  document.getElementById('kpiDaysYear').textContent = daysYear;
  document.getElementById('kpiDaysMonth').textContent = daysMonth + ' this month';
  document.getElementById('kpiBookingsYear').textContent = thisYearRows.length;
  document.getElementById('kpiBookingsMonth').textContent = thisMonthRows.length + ' this month';

  // Delta
  const deltaEl = document.getElementById('kpiRevMonthDelta');
  if (revLastMonth > 0) {
    const pct = Math.round(((revMonth - revLastMonth) / revLastMonth) * 100);
    const up = pct >= 0;
    deltaEl.innerHTML = `<span class="kpi-card-delta ${up?'delta-up':'delta-down'}">${up?'▲':'▼'} ${Math.abs(pct)}% vs last month</span>`;
  }

  // Month labels
  const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  document.getElementById('thisMonthLabel').textContent = MONTHS[month];
  document.getElementById('lastMonthLabel').textContent = MONTHS[lastMonth];
  document.getElementById('thisMonthRev').textContent = '£' + revMonth.toLocaleString();
  document.getElementById('lastMonthRev').textContent = '£' + revLastMonth.toLocaleString();
}

// =============================================
// CHARTS
// =============================================
function renderCharts() {
  renderRevenueChart();
  renderOptionChart();
}

function renderRevenueChart() {
  const now = new Date();
  const year = now.getFullYear();
  const lastYear = year - 1;
  const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

  const thisYearByMonth = Array(12).fill(0);
  const lastYearByMonth = Array(12).fill(0);

  allData.forEach(r => {
    if (r.option === '1') return;
    const d = kpiDate(r);
    if (!d) return;
    const y = d.getFullYear();
    const m = d.getMonth();
    if (y === year) thisYearByMonth[m] += r.revenue;
    else if (y === lastYear) lastYearByMonth[m] += r.revenue;
  });

  const ctx = document.getElementById('revenueChart').getContext('2d');
  if (revenueChart) revenueChart.destroy();

  // Store per-month row lists so onClick can reference them
  const thisYearRowsByMonth  = Array.from({length:12}, () => []);
  const lastYearRowsByMonth  = Array.from({length:12}, () => []);
  allData.forEach(r => {
    if (r.option === '1') return;
    const d = kpiDate(r);
    if (!d) return;
    const y = d.getFullYear(), m = d.getMonth();
    if (y === year)     thisYearRowsByMonth[m].push(r);
    else if (y === lastYear) lastYearRowsByMonth[m].push(r);
  });

  revenueChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: MONTHS,
      datasets: [
        {
          label: String(year),
          data: thisYearByMonth,
          backgroundColor: 'rgba(33,71,244,0.7)',
          hoverBackgroundColor: 'rgba(33,71,244,1)',
          borderRadius: 3,
          borderSkipped: false,
        },
        {
          label: String(lastYear),
          data: lastYearByMonth,
          backgroundColor: 'rgba(163,186,255,0.5)',
          hoverBackgroundColor: 'rgba(163,186,255,0.9)',
          borderRadius: 3,
          borderSkipped: false,
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      onHover: (e, els) => { e.native.target.style.cursor = els.length ? 'pointer' : 'default'; },
      onClick: (e, els) => {
        if (!els.length) return;
        const el = els[0];
        const monthIdx = el.index;
        const isThisYear = el.datasetIndex === 0;
        openChartMonthModal(
          monthIdx,
          isThisYear ? year : lastYear,
          isThisYear ? thisYearRowsByMonth[monthIdx] : lastYearRowsByMonth[monthIdx],
          isThisYear ? lastYearRowsByMonth[monthIdx] : thisYearRowsByMonth[monthIdx],
          isThisYear ? lastYear : year
        );
      },
      plugins: {
        legend: { labels: { font: { family: 'Arial', size: 11 }, boxWidth: 12 } },
        tooltip: {
          callbacks: {
            label: ctx => ` £${ctx.parsed.y.toLocaleString()} — click for detail`
          },
          bodyFont: { family: 'Arial', size: 12 }
        }
      },
      scales: {
        x: { grid: { display: false }, ticks: { font: { family:'Arial', size:11 } } },
        y: {
          ticks: {
            font: { family:'Arial', size:11 },
            callback: v => '£' + (v >= 1000 ? (v/1000).toFixed(0)+'k' : v)
          },
          grid: { color: '#f0f0f0' }
        }
      }
    }
  });
}

function renderOptionChart() {
  const now = new Date();
  const year = now.getFullYear();
  const counts = {'1':0,'2':0,'3':0,'4':0,'5':0};
  const optionRowMap = {'1':[],'2':[],'3':[],'4':[],'5':[]};
  allData.filter(r => { const d = kpiDate(r); return d && d.getFullYear() === year; }).forEach(r => {
    if (counts[r.option] !== undefined) { counts[r.option]++; optionRowMap[r.option].push(r); }
  });

  const ctx = document.getElementById('optionChart').getContext('2d');
  if (optionChart) optionChart.destroy();

  const optionKeys = ['1','2','3','4','5'];

  optionChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Opt 1 — On Demand','Opt 2 — 1 Day','Opt 3 — 2 Day','Opt 4 — Accounting','Opt 5 — HQ Session'],
      datasets: [{
        data: [counts['1'],counts['2'],counts['3'],counts['4'],counts['5']],
        backgroundColor: ['#b8caff','#2147f4','#f6be9d','#bde4b9','#beffd8'],
        hoverBackgroundColor: ['#93aaff','#1538c7','#f0a06e','#9dd898','#9dffca'],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      onHover: (e, els) => { e.native.target.style.cursor = els.length ? 'pointer' : 'default'; },
      onClick: (e, els) => {
        if (!els.length) return;
        const optKey = optionKeys[els[0].index];
        openChartOptionModal(optKey, optionRowMap[optKey], year);
      },
      plugins: {
        legend: { position: 'bottom', labels: { font:{family:'Arial',size:10}, boxWidth:10, padding:8 } },
        tooltip: {
          callbacks: { label: ctx => ` ${ctx.parsed} bookings — click for detail` },
          bodyFont:{family:'Arial',size:11}
        }
      },
      cutout: '60%'
    }
  });
}

// =============================================
// TRAINER WORKLOAD
// =============================================
function renderTrainerWorkload() {
  const now = new Date();
  const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - 30);
  const today = new Date(); today.setHours(0,0,0,0);
  const future = new Date(); future.setDate(future.getDate() + 30);

  const suggested = getSuggestedTrainer();
  const counts = {};
  const upcoming = {};
  TRAINERS.forEach(t => { counts[t] = 0; upcoming[t] = 0; });

  allData.forEach(r => {
    if (r.trainer && counts.hasOwnProperty(r.trainer)) {
      if (r.date) {
        if (r.date >= cutoff && r.date <= today) counts[r.trainer]++;
        if (r.date >= today && r.date <= future) upcoming[r.trainer]++;
      } else {
        counts[r.trainer]++;
      }
    }
  });

  const maxCount = Math.max(...Object.values(counts), 1);
  const grid = document.getElementById('trainerGrid');

  grid.innerHTML = TRAINERS.map(t => {
    const pct = Math.round((counts[t] / maxCount) * 100);
    const barClass = pct > 75 ? 'busy' : pct > 40 ? 'medium' : '';
    const isSuggested = t === suggested;
    return `
      <div class="trainer-card">
        <div class="trainer-name">${t}</div>
        <div class="trainer-stat">
          <span>Last 30 days</span>
          <span class="trainer-stat-val">${counts[t]}</span>
        </div>
        <div class="trainer-stat">
          <span>Upcoming (30d)</span>
          <span class="trainer-stat-val">${upcoming[t]}</span>
        </div>
        <div class="workload-bar-wrap">
          <div class="workload-bar ${barClass}" style="width:${pct}%"></div>
        </div>
        <div class="trainer-availability loading" id="avail-${t.replace(/\s/g,'_')}">
          📅 Checking availability…
        </div>
        ${isSuggested ? '<div class="suggested-tag">⚡ Next in rotation</div>' : ''}
      </div>
    `;
  }).join('');
}


// =============================================
// NEEDS ACTION PANEL (Assigned + Pending)
// =============================================
function renderActionPanel() {
  const actionRows = allData.filter(r => {
    return r.status === 'Assigned' || r.status === 'Pending';
  });

  document.getElementById('actionBadge').textContent = actionRows.length;
  const dot = document.getElementById('actionDot');
  dot.style.display = actionRows.length > 0 ? 'block' : 'none';

  const tbody = document.getElementById('actionRequestsBody');

  if (actionRows.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state">'
      + '<div class="empty-state-icon">✅</div>'
      + '<div class="empty-state-text">Nothing needs action right now</div>'
      + '</div></td></tr>';
    return;
  }

  tbody.innerHTML = actionRows.map(r => {
    const trainerOpts = '<option value="">— Unassigned —</option>'
      + TRAINERS.map(t => '<option value="' + t + '"' + (r.trainer === t ? ' selected' : '') + '>' + t + '</option>').join('');
    const curStatus = r.status || 'Assigned';
    const statusOpts = ['Unassigned','Assigned','Booked','Pending','Cancelled']
      .map(s => '<option value="' + s + '"' + (curStatus === s ? ' selected' : '') + '>' + s + '</option>').join('');
    const showDate = curStatus === 'Booked';
    const dateVal = r.bookedOn ? formatDateInput(r.bookedOn) : '';
    return '<tr id="act-row-' + r.rowIndex + '">'
      + '<td style="white-space:nowrap;">' + formatDate(r.date || r.timestamp) + '</td>'
      + '<td><strong>' + esc(r.company) + '</strong><br><span style="color:var(--text--dark--30);font-size:11px;">' + esc(r.email||'') + '</span></td>'
      + '<td>' + esc(r.contact||'') + '</td>'
      + '<td><span class="option-badge opt-' + r.option + '">Opt ' + r.option + ' — ' + esc(r.optionLabel) + '</span></td>'
      + '<td><select id="act-trainer-' + r.rowIndex + '" onchange="onActField(' + r.rowIndex + ')" style="min-width:90px;border:1px solid #ccc;border-radius:4px;padding:4px 7px;font-size:12px;font-family:Arial,sans-serif;">' + trainerOpts + '</select></td>'
      + '<td><div style="display:flex;align-items:center;gap:4px;"><span style="color:var(--text--dark--30);font-size:12px;">£</span>'
        + '<input type="number" id="act-value-' + r.rowIndex + '" value="' + (r.revenue || '') + '" placeholder="0" min="0" step="50" oninput="onActValueInput(' + r.rowIndex + ')" style="width:75px;border:1px solid #ccc;border-radius:4px;padding:4px 6px;font-size:12px;font-family:Arial,sans-serif;color:#333;"></div></td>'
      + '<td><div style="display:flex;flex-direction:column;gap:4px;">'
        + '<select id="act-status-' + r.rowIndex + '" onchange="onActField(' + r.rowIndex + ')" style="border:1px solid #ccc;border-radius:4px;padding:4px 7px;font-size:12px;font-family:Arial,sans-serif;font-weight:600;cursor:pointer;min-width:105px;">' + statusOpts + '</select>'
        + '<div id="act-date-wrap-' + r.rowIndex + '" style="display:' + (showDate ? 'flex' : 'none') + ';align-items:center;">'
          + '<input type="date" id="act-booked-date-' + r.rowIndex + '" value="' + dateVal + '" onchange="onActField(' + r.rowIndex + ')" style="border:1px solid #2147f4;border-radius:4px;padding:3px 6px;font-size:11px;font-family:Arial,sans-serif;color:#2147f4;background:#f0f4ff;width:130px;">'
        + '</div>'
      + '</div></td>'
      + '</tr>';
  }).join('');

  actionRows.forEach(r => {
    const sel = document.getElementById('act-status-' + r.rowIndex);
    if (sel) applyStatusStyle(sel, r.status || 'Assigned');
  });
}

// ── NEEDS ACTION PANEL AUTO-SAVE ─────────────────────────────────────────────

function onActValueInput(rowIndex) {
  const inp = document.getElementById('act-value-' + rowIndex);
  const row = allData.find(r => r.rowIndex === rowIndex);
  if (row && inp) row.revenue = parseFloat(inp.value) || 0;
  clearTimeout(inp._saveTimer);
  inp._saveTimer = setTimeout(() => onActField(rowIndex), 1200);
}

async function onActField(rowIndex) {
  const trainerSel = document.getElementById('act-trainer-' + rowIndex);
  const statusSel  = document.getElementById('act-status-'  + rowIndex);
  const valueInp   = document.getElementById('act-value-'   + rowIndex);
  const dateInp    = document.getElementById('act-booked-date-' + rowIndex);
  const dateWrap   = document.getElementById('act-date-wrap-' + rowIndex);

  const trainer   = trainerSel ? trainerSel.value  : '';
  const newStatus = statusSel  ? statusSel.value   : 'Assigned';
  const newValue  = valueInp   ? (parseFloat(valueInp.value) || 0) : 0;
  const bookedOn  = dateInp    ? dateInp.value     : '';

  if (dateWrap) dateWrap.style.display = newStatus === 'Booked' ? 'flex' : 'none';
  if (statusSel) applyStatusStyle(statusSel, newStatus);

  const row = allData.find(r => r.rowIndex === rowIndex);
  if (row) {
    row.trainer  = trainer;
    row.status   = newStatus;
    row.revenue  = newValue || row.revenue;
    if (bookedOn) row.bookedOn = bookedOn;
  }
  saveOverride(rowIndex, { trainer, status: newStatus, revenue: newValue || undefined, bookedOn: bookedOn || undefined });

  // Sync to All Bookings table
  const mainTrainer = document.getElementById('sel-trainer-' + rowIndex);
  if (mainTrainer) mainTrainer.value = trainer;
  const mainStatus = document.getElementById('sel-status-' + rowIndex);
  if (mainStatus) { mainStatus.value = newStatus; applyStatusStyle(mainStatus, newStatus); }
  const mainValue = document.getElementById('inp-value-' + rowIndex);
  if (mainValue && newValue) mainValue.value = newValue;
  const mainDateWrap = document.getElementById('booked-date-wrap-' + rowIndex);
  if (mainDateWrap) mainDateWrap.style.display = newStatus === 'Booked' ? 'flex' : 'none';

  let url = APPS_SCRIPT_URL + '?action=assign&row=' + rowIndex + '&status=' + encodeURIComponent(newStatus);
  if (trainer)  url += '&trainer='  + encodeURIComponent(trainer);
  if (newValue) url += '&value='    + newValue;
  if (bookedOn) url += '&bookedOn=' + encodeURIComponent(bookedOn);

  showToast('Saving…', '');
  try {
    await fetch(url, { method: 'GET', redirect: 'follow', mode: 'no-cors' });
    showToast('✓ Saved', 'success');
  } catch(e) {
    showToast('✓ Saved locally', '');
  }

  // Log to activity feed
  const _actRow = allData.find(r => r.rowIndex === rowIndex);
  const _actCo  = _actRow ? _actRow.company : 'Row ' + rowIndex;
  logActivity('status', _actCo, 'Status updated to "' + newStatus + '"', trainer ? 'Trainer: ' + trainer : '');
  if (newValue)  logActivity('value',   _actCo, 'Value updated to £' + newValue.toLocaleString(), '');
  if (bookedOn)  logActivity('date',    _actCo, 'Booked date updated', bookedOn);

  renderUnassigned();
  renderTrainerWorkload();
  renderKPIs();
  renderCharts();
  renderAllBookings();
}

// =============================================
// ALL BOOKINGS TABLE
// =============================================

const STATUS_COLOURS = {
  'Unassigned': { bg: '#fde8eb', color: '#c0303d', border: '#c0303d' },
  'Assigned':   { bg: '#f5ede5', color: '#8a5a2a', border: '#8a5a2a' },
  'Booked':     { bg: '#b8caff', color: '#2147f4', border: '#2147f4' },
  'Pending':    { bg: '#beffd8', color: '#1a6a40', border: '#1a6a40' },
  'Cancelled':  { bg: '#f0f0f0', color: '#999',    border: '#ccc'    }
};

function applyStatusStyle(sel, status) {
  const c = STATUS_COLOURS[status] || {};
  sel.style.background   = c.bg     || '#fff';
  sel.style.color        = c.color  || '#333';
  sel.style.borderColor  = c.border || 'var(--light-grey)';
  sel.style.fontWeight   = '600';
}

function buildStatusSelect(rowIndex, current, bookedOn) {
  const statuses = ['Unassigned','Assigned','Booked','Pending','Cancelled'];
  const opts = statuses.map(s =>
    '<option value="' + s + '"' + (current === s ? ' selected' : '') + '>' + s + '</option>'
  ).join('');
  const showDate = current === 'Booked';
  const dateVal  = bookedOn || '';
  return '<div style="display:flex;flex-direction:column;gap:5px;">'
    + '<select id="sel-status-' + rowIndex + '" '
    + 'onchange="onStatusChange(' + rowIndex + ')" '
    + 'style="border:1px solid #ccc;border-radius:4px;padding:4px 7px;font-size:12px;'
    + 'font-family:Arial,sans-serif;font-weight:600;cursor:pointer;min-width:100px;">'
    + opts + '</select>'
    + '<div id="booked-date-wrap-' + rowIndex + '" style="display:' + (showDate ? 'flex' : 'none') + ';align-items:center;gap:4px;">'
    + '<input type="date" id="inp-booked-date-' + rowIndex + '" value="' + dateVal + '" '
    + 'onchange="onBookedDateChange(' + rowIndex + ')" '
    + 'style="border:1px solid #2147f4;border-radius:4px;padding:3px 6px;font-size:11px;'
    + 'font-family:Arial,sans-serif;color:#2147f4;background:#f0f4ff;width:130px;" '
    + 'placeholder="Booked on date">'
    + '</div>'
    + '</div>';
}

function resetPageAndRender() {
  currentPage = 1;
  renderAllBookings();
}

function clearBookingFilters() {
  document.getElementById('bookingSearch').value  = '';
  document.getElementById('filterStatus').value   = '';
  document.getElementById('filterTrainer').value  = '';
  document.getElementById('filterOption').value   = '';
  document.getElementById('filterDateFrom').value = '';
  document.getElementById('filterDateTo').value   = '';
  currentPage = 1;
  renderAllBookings();
}

function renderAllBookings() {
  const statusF  = document.getElementById('filterStatus')?.value  || '';
  const trainerF = document.getElementById('filterTrainer')?.value || '';
  const optionF  = document.getElementById('filterOption')?.value  || '';
  const searchQ  = (document.getElementById('bookingSearch')?.value || '').trim().toLowerCase();
  const dateFrom = document.getElementById('filterDateFrom')?.value || '';
  const dateTo   = document.getElementById('filterDateTo')?.value   || '';

  // Parse date boundaries (YYYY-MM-DD input → Date at start/end of day)
  const fromDate = dateFrom ? new Date(dateFrom + 'T00:00:00') : null;
  const toDate   = dateTo   ? new Date(dateTo   + 'T23:59:59') : null;

  // Show/hide clear button whenever any filter is active
  const anyActive = statusF || trainerF || optionF || searchQ || dateFrom || dateTo;
  const clearBtn = document.getElementById('clearFiltersBtn');
  if (clearBtn) clearBtn.style.display = anyActive ? 'inline-block' : 'none';

  let filtered = allData.filter(r => {
    if (statusF  && r.status  !== statusF)  return false;
    if (trainerF && r.trainer !== trainerF) return false;
    if (optionF  && r.option  !== optionF)  return false;
    // Search: company name, contact, email
    if (searchQ) {
      const haystack = ((r.company||'') + ' ' + (r.contact||'') + ' ' + (r.email||'')).toLowerCase();
      if (!haystack.includes(searchQ)) return false;
    }
    // Date range — uses kpiDate (Booked On Date) then falls back to submission date
    if (fromDate || toDate) {
      const d = kpiDate(r) || r.date;
      if (!d) return false;
      if (fromDate && d < fromDate) return false;
      if (toDate   && d > toDate)   return false;
    }
    return true;
  });

  // Sort: Unassigned first (excluding Booked/Cancelled), then everything else newest-first
  filtered.sort((a, b) => {
    const aTop = (!a.status || a.status === 'Unassigned');
    const bTop = (!b.status || b.status === 'Unassigned');
    if (aTop && !bTop) return -1;
    if (!aTop && bTop) return 1;
    return (b.date || 0) - (a.date || 0);
  });

  document.getElementById('allBadge').textContent  = filtered.length;
  document.getElementById('rowCount').textContent  = filtered.length + ' records';

  const total = Math.ceil(filtered.length / PAGE_SIZE);
  if (currentPage > total) currentPage = 1;
  const page = filtered.slice((currentPage - 1) * PAGE_SIZE, currentPage * PAGE_SIZE);

  document.getElementById('prevBtn').disabled  = currentPage <= 1;
  document.getElementById('nextBtn').disabled  = currentPage >= total;
  document.getElementById('pageInfo').textContent = 'Page ' + currentPage + ' of ' + (total || 1);

  const tbody = document.getElementById('allBookingsBody');

  if (page.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state">'
      + '<div class="empty-state-icon">📭</div>'
      + '<div class="empty-state-text">No records match your filters</div>'
      + '</div></td></tr>';
    return;
  }

  tbody.innerHTML = page.map(r => {
    const trainerOpts = '<option value="">Unassigned</option>'
      + TRAINERS.map(t => '<option value="' + t + '"' + (r.trainer === t ? ' selected' : '') + '>' + t + '</option>').join('');

    const status = r.status || 'Unassigned';

    return '<tr id="book-row-' + r.rowIndex + '">'
      + '<td style="white-space:nowrap;">' + formatDate(r.date || r.timestamp) + '</td>'
      + '<td><strong>' + esc(r.company) + '</strong></td>'
      + '<td>' + esc(r.contact) + '</td>'
      + '<td><span class="option-badge opt-' + r.option + '">Opt ' + r.option + '</span></td>'
      + '<td>'
        + '<select id="sel-trainer-' + r.rowIndex + '" '
        + 'onchange="onTrainerChange(' + r.rowIndex + ')" '
        + 'style="min-width:90px;border:1px solid #ccc;border-radius:4px;padding:4px 7px;font-size:12px;font-family:Arial,sans-serif;">'
        + trainerOpts
        + '</select>'
      + '</td>'
      + '<td>'
        + '<div style="display:flex;align-items:center;gap:4px;">'
        + '<span style="color:var(--text--dark--30);font-size:12px;">£</span>'
        + '<input type="number" id="inp-value-' + r.rowIndex + '" '
        + 'value="' + (r.revenue || '') + '" placeholder="0" min="0" step="50" '
        + 'oninput="onValueInput(' + r.rowIndex + ')" '
        + 'style="width:80px;border:1px solid #ccc;border-radius:4px;padding:4px 6px;font-size:12px;font-family:Arial,sans-serif;color:#333;">'
        + '</div>'
      + '</td>'
      + '<td>' + buildStatusSelect(r.rowIndex, status, r.bookedOn || '') + '</td>'
      + '</tr>';
  }).join('');

  // Apply colour styling to all status dropdowns after render
  page.forEach(r => {
    const sel = document.getElementById('sel-status-' + r.rowIndex);
    if (sel) applyStatusStyle(sel, r.status || 'Unassigned');
  });
}

// Fires immediately when status dropdown changes
async function onStatusChange(rowIndex) {
  const sel = document.getElementById('sel-status-' + rowIndex);
  const newStatus = sel ? sel.value : '';
  if (!newStatus) return;

  const row = allData.find(r => r.rowIndex === rowIndex);
  const co  = row ? row.company : 'Row ' + rowIndex;
  if (row) row.status = newStatus;
  if (sel) applyStatusStyle(sel, newStatus);
  saveOverride(rowIndex, { status: newStatus });
  logActivity('status', co, 'Status changed to "' + newStatus + '"', '');

  // Show/hide booked-on date picker
  const dateWrap = document.getElementById('booked-date-wrap-' + rowIndex);
  if (dateWrap) dateWrap.style.display = newStatus === 'Booked' ? 'flex' : 'none';

  // If switching away from Booked, clear the date
  if (newStatus !== 'Booked') {
    const dateInp = document.getElementById('inp-booked-date-' + rowIndex);
    if (dateInp) dateInp.value = '';
    if (row) row.bookedOn = '';
  }

  // Build URL — include bookedOn date if Booked and date already set
  let url = APPS_SCRIPT_URL + '?action=assign&row=' + rowIndex + '&status=' + encodeURIComponent(newStatus);
  if (newStatus === 'Booked') {
    const dateInp = document.getElementById('inp-booked-date-' + rowIndex);
    if (dateInp && dateInp.value) url += '&bookedOn=' + encodeURIComponent(dateInp.value);
  }

  showToast('Status → ' + newStatus, 'success');
  try { await fetch(url, { method: "GET", redirect: "follow", mode: "no-cors" }); } catch(e) {}

  renderUnassigned();
  renderActionPanel();
  renderTrainerWorkload();
  renderKPIs();
  renderCharts();
}

// Fires when booked-on date is picked
async function onBookedDateChange(rowIndex) {
  const dateInp = document.getElementById('inp-booked-date-' + rowIndex);
  const bookedOn = dateInp ? dateInp.value : '';

  const row = allData.find(r => r.rowIndex === rowIndex);
  if (row) row.bookedOn = bookedOn;
  saveOverride(rowIndex, { bookedOn });

  showToast('Booked on date saved', 'success');
  try {
    await fetch(APPS_SCRIPT_URL + '?action=assign&row=' + rowIndex + '&bookedOn=' + encodeURIComponent(bookedOn), { method: 'GET', redirect: 'follow', mode: 'no-cors' });
  } catch(e) {}
}

// Fires when trainer dropdown changes — auto-saves immediately
async function onTrainerChange(rowIndex) {
  const sel = document.getElementById('sel-trainer-' + rowIndex);
  const newTrainer = sel ? sel.value : '';

  const row = allData.find(r => r.rowIndex === rowIndex);
  if (row) {
    row.trainer = newTrainer;
    saveOverride(rowIndex, { trainer: newTrainer });
    if (newTrainer && (!row.status || row.status === 'Unassigned')) {
      row.status = 'Assigned';
      // Update status dropdown to match
      const statusSel = document.getElementById('sel-status-' + rowIndex);
      if (statusSel) { statusSel.value = 'Assigned'; applyStatusStyle(statusSel, 'Assigned'); }
    }
    if (!newTrainer) {
      row.status = 'Unassigned';
      const statusSel = document.getElementById('sel-status-' + rowIndex);
      if (statusSel) { statusSel.value = 'Unassigned'; applyStatusStyle(statusSel, 'Unassigned'); }
    }
  }

  showToast('Trainer → ' + (newTrainer || 'Unassigned'), 'success');

  try {
    await fetch(APPS_SCRIPT_URL + '?action=assign&row=' + rowIndex
      + '&trainer=' + encodeURIComponent(newTrainer)
      + '&status=' + encodeURIComponent(row ? row.status : 'Assigned'),
      { method: 'GET', redirect: 'follow', mode: 'no-cors' });
  } catch(e) {}

  renderUnassigned();
  renderActionPanel();
  renderTrainerWorkload();
}

// Fires when value input changes — auto-saves immediately
// Debounce timers for value saves
const _valueSaveTimers = {};

function onValueInput(rowIndex) {
  const inp = document.getElementById('inp-value-' + rowIndex);
  const newValue = parseFloat(inp ? inp.value : 0) || 0;

  // Update allData immediately so re-renders use the correct value
  const row = allData.find(r => r.rowIndex === rowIndex);
  if (row) row.revenue = newValue;

  // Debounce: wait 800ms after last keystroke before saving to sheet
  clearTimeout(_valueSaveTimers[rowIndex]);
  saveOverride(rowIndex, { revenue: newValue });
  _valueSaveTimers[rowIndex] = setTimeout(async () => {
    showToast('Value → £' + newValue.toLocaleString(), 'success');
    try {
      await fetch(APPS_SCRIPT_URL + '?action=assign&row=' + rowIndex + '&value=' + newValue, { method: 'GET', redirect: 'follow', mode: 'no-cors' });
    } catch(e) {}
    renderKPIs();
    renderCharts();
  }, 800);
}

function populateTrainerFilter() {
  const sel = document.getElementById('filterTrainer');
  const current = sel.value;
  sel.innerHTML = '<option value="">All Trainers</option>' +
    TRAINERS.map(t => `<option value="${t}" ${t===current?'selected':''}>${t}</option>`).join('');
  sel.onchange = () => resetPageAndRender();
}

function changePage(dir) {
  currentPage += dir;
  renderAllBookings();
}

// =============================================
// UTILS
// =============================================
function formatDate(d) {
  if (!d) return '—';
  const dt = d instanceof Date ? d : new Date(d);
  if (isNaN(dt.getTime())) return String(d).slice(0,10) || '—';
  return dt.toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric' });
}

function esc(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/[<]/g,'&lt;').replace(/[>]/g,'&gt;').replace(/"/g,'&quot;');
}


// =============================================
// TRAINER MANAGEMENT
// =============================================
// ── NEW PERMISSION-AWARE TRAINER MODAL ───────────────────────────────────────

let _newTrainerPerms = { ...PERMISSION_PRESETS.editor };

function openTrainerModal() {
  if (!hasPerm('manage_trainers')) { showToast('You do not have permission to manage trainers', 'error'); return; }
  _newTrainerPerms = { ...PERMISSION_PRESETS.editor };
  renderTrainerModalList();
  renderNewTrainerPermissions();
  highlightPreset('editor');
  document.getElementById('trainerModalOverlay').classList.add('open');
  setTimeout(() => document.getElementById('newTrainerInput').focus(), 100);
}

function closeTrainerModal(event) {
  if (event && event.target !== document.getElementById('trainerModalOverlay')) return;
  document.getElementById('trainerModalOverlay').classList.remove('open');
  document.getElementById('newTrainerInput').value = '';
}

function applyPreset(preset) {
  _newTrainerPerms = { ...PERMISSION_PRESETS[preset] };
  highlightPreset(preset);
  renderNewTrainerPermissions();
}

function highlightPreset(active) {
  document.querySelectorAll('.perm-preset-btn').forEach(btn => btn.classList.remove('active'));
  const map = { admin: 0, editor: 1, viewer: 2 };
  const btns = document.querySelectorAll('#presetBtns .perm-preset-btn');
  if (btns[map[active]]) btns[map[active]].classList.add('active');
}

function renderNewTrainerPermissions() {
  const container = document.getElementById('newTrainerPermissions');
  if (!container) return;
  // Group permissions by group
  const groups = {};
  Object.entries(ALL_PERMISSIONS).forEach(([key, meta]) => {
    if (!groups[meta.group]) groups[meta.group] = [];
    groups[meta.group].push({ key, ...meta });
  });
  container.innerHTML = Object.entries(groups).map(([group, perms]) => `
    <div class="perm-section">
      <div class="perm-section-title">${group}</div>
      ${perms.map(p => `
        <div class="perm-row">
          <div class="perm-row-left">
            <div class="perm-row-label">${p.label}</div>
            <div class="perm-row-desc">${p.desc}</div>
          </div>
          <label class="perm-toggle">
            <input type="checkbox" id="np-${p.key}" ${_newTrainerPerms[p.key] ? 'checked' : ''} onchange="onPermToggle('${p.key}', this.checked)">
            <span class="perm-toggle-slider"></span>
          </label>
        </div>
      `).join('')}
    </div>
  `).join('');
}

function onPermToggle(key, checked) {
  _newTrainerPerms[key] = checked;
  // Remove active preset highlight since user customised
  document.querySelectorAll('.perm-preset-btn').forEach(btn => btn.classList.remove('active'));
}

function renderTrainerModalList() {
  const list = document.getElementById('trainerModalList');
  if (!USERS.length) {
    list.innerHTML = '<div style="text-align:center;color:var(--text--dark--30);font-size:12px;padding:16px;">No trainers added yet</div>';
    return;
  }
  const roleLabel = (u) => {
    const p = u.permissions || {};
    if (p.manage_trainers) return { label: 'Admin', cls: 'admin' };
    if (p.edit_status || p.edit_trainer || p.edit_value) return { label: 'Editor', cls: 'editor' };
    return { label: 'View Only', cls: 'viewer' };
  };
  const curUser = getCurrentUser();
  list.innerHTML = USERS.map(u => {
    const role = roleLabel(u);
    const isSelf = curUser && curUser.name === u.name;
    const isAdmin = curUser && curUser.permissions && curUser.permissions.manage_trainers;
    const pinSet = hasPin(u.name);
    return `<div class="trainer-list-item" style="align-items:center;gap:8px;flex-wrap:wrap;">
      <div class="activity-user-avatar" style="width:28px;height:28px;font-size:11px;flex-shrink:0;background:var(--action-primary-blue);">
        ${u.name.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase()}
      </div>
      <span style="flex:1;min-width:80px;font-size:13px;font-weight:600;color:var(--text--dark--50);">${esc(u.name)}${isSelf ? ' <span style="font-size:10px;color:var(--text--dark--30);font-weight:400;">(you)</span>' : ''}</span>
      <span class="login-user-badge ${role.cls}">${role.label}</span>
      <span style="font-size:10px;color:${pinSet ? '#1a6a40' : '#c0303d'};font-weight:600;">${pinSet ? '🔒 PIN set' : '⚠ No PIN'}</span>
      ${isSelf ? `<button class="perm-preset-btn" style="padding:4px 8px;font-size:11px;flex:none;" onclick="changeSelfPin()">Change PIN</button>` : ''}
      ${isAdmin && !isSelf ? `<button class="perm-preset-btn" style="padding:4px 8px;font-size:11px;flex:none;color:#8a5a2a;border-color:#e0b87a;" onclick="adminResetPin('${esc(u.name)}')">Reset PIN</button>` : ''}
      <button class="perm-preset-btn" style="padding:4px 10px;font-size:11px;flex:none;" onclick="editTrainerPerms('${esc(u.name)}')">Edit</button>
      <button class="trainer-delete-btn" onclick="deleteTrainer('${esc(u.name)}')" title="Remove trainer">✕</button>
    </div>`;
  }).join('');
}

function editTrainerPerms(name) {
  const user = USERS.find(u => u.name === name);
  if (!user) return;

  // Use livePerms if we're returning from a shadow session for this user
  const perms = (_shadowState.targetName === name && _shadowState.livePerms)
    ? _shadowState.livePerms
    : (user.permissions || {});

  const groups = {};
  Object.entries(ALL_PERMISSIONS).forEach(([key, meta]) => {
    if (!groups[meta.group]) groups[meta.group] = [];
    groups[meta.group].push({ key, ...meta });
  });
  const html = Object.entries(groups).map(([group, ps]) => `
    <div class="perm-section">
      <div class="perm-section-title">${group}</div>
      ${ps.map(p => `
        <div class="perm-row">
          <div class="perm-row-left">
            <div class="perm-row-label">${p.label}</div>
            <div class="perm-row-desc">${p.desc}</div>
          </div>
          <label class="perm-toggle">
            <input type="checkbox" id="ep-${esc(name)}-${p.key}"
              ${perms[p.key] ? 'checked' : ''}
              onchange="onPermToggleEdit('${esc(name)}', '${p.key}', this.checked)">
            <span class="perm-toggle-slider"></span>
          </label>
        </div>
      `).join('')}
    </div>
  `).join('');

  const win = document.getElementById('editPermOverlay');
  document.getElementById('editPermName').textContent = name;
  document.getElementById('editPermBody').innerHTML = html;
  document.getElementById('editPermSaveBtn').onclick = () => saveEditedPerms(name);

  // Update Preview button label
  const btnName = document.getElementById('shadowBtnName');
  if (btnName) btnName.textContent = name;

  // Hide preview button for self (admin previewing themselves is pointless)
  const cur = getCurrentUser();
  const previewBtn = document.getElementById('shadowPreviewBtn');
  if (previewBtn) previewBtn.style.display = (cur && cur.name === name) ? 'none' : '';

  win.classList.add('open');
}

// Called on every toggle change inside the edit modal
function onPermToggleEdit(name, key, checked) {
  // If we're currently in shadow mode for this user, live-update the preview
  onShadowPermToggle(name, key, checked);
  // Also clear any preset highlight
  document.querySelectorAll('.perm-preset-btn').forEach(btn => btn.classList.remove('active'));
}

function closeEditPermModal() { document.getElementById('editPermOverlay').classList.remove('open'); }

function saveEditedPerms(name) {
  const user = USERS.find(u => u.name === name);
  if (!user) return;
  const newPerms = {};
  Object.keys(ALL_PERMISSIONS).forEach(key => {
    const cb = document.getElementById('ep-' + name + '-' + key);
    if (cb) newPerms[key] = cb.checked;
  });
  user.permissions = newPerms;
  saveUsers(USERS);
  // If editing self, refresh session
  const cur = getCurrentUser();
  if (cur && cur.name === name) setCurrentUser(user);
  closeEditPermModal();
  renderTrainerModalList();
  applyPermissions();
  logActivity('trainer', null, 'Permissions updated for ' + name, '');
  showToast('✓ Permissions saved for ' + name, 'success');
}

function addTrainer() {
  const inp  = document.getElementById('newTrainerInput');
  const name = (inp.value || '').trim();
  if (!name) { inp.focus(); return; }
  if (USERS.map(u => u.name.toLowerCase()).includes(name.toLowerCase())) {
    showToast('Trainer already exists', 'error');
    return;
  }
  USERS.push({ name, permissions: { ..._newTrainerPerms } });
  saveUsers(USERS);
  syncTrainersFromUsers();
  inp.value = '';
  renderTrainerModalList();
  renderNewTrainerPermissions();
  highlightPreset('editor');
  renderTrainerWorkload();
  populateTrainerFilter();
  renderAllBookings();
  renderUnassigned();
  logActivity('trainer_added', null, 'Trainer added: ' + name, Object.keys(_newTrainerPerms).filter(k=>_newTrainerPerms[k]).join(', '));
  showToast('✓ ' + name + ' added', 'success');
}

// Which trainer is pending deletion (held while reassign modal is open)
let _pendingDeleteTrainer = null;

function deleteTrainer(name) {
  // Check if this trainer has any active (non-Cancelled) enquiries
  const assigned = allData.filter(r => r.trainer === name && r.status !== 'Cancelled');

  if (assigned.length === 0) {
    // Safe to delete directly — no open enquiries
    if (!confirm('Remove ' + name + ' from the trainer list? They have no active enquiries.')) return;
    _executeTrainerDelete(name);
    return;
  }

  // HARD BLOCK — show reassignment modal instead
  _pendingDeleteTrainer = name;

  const others = TRAINERS.filter(t => t !== name);
  const sel = document.getElementById('reassignTargetSelect');
  sel.innerHTML = '<option value="">— Select a trainer —</option>'
    + others.map(t => '<option value="' + esc(t) + '">' + esc(t) + '</option>').join('');
  sel.value = '';

  document.getElementById('reassignWarningText').innerHTML =
    '<strong>' + esc(name) + '</strong> is currently assigned to <strong>' + assigned.length
    + ' active enquir' + (assigned.length === 1 ? 'y' : 'ies') + '</strong>. '
    + 'You must reassign them before this trainer can be removed.';

  document.getElementById('reassignEnquiryList').innerHTML = assigned.map(r => {
    const statusColours = {
      'Assigned': { bg: '#f5ede5', color: '#8a5a2a' },
      'Booked':   { bg: '#b8caff', color: '#2147f4' },
      'Pending':  { bg: '#beffd8', color: '#1a6a40' },
      'Unassigned': { bg: '#fde8eb', color: '#c0303d' },
    };
    const sc = statusColours[r.status] || { bg: '#f0f0f0', color: '#999' };
    return '<div class="reassign-enquiry-row">'
      + '<span class="reassign-enquiry-company">' + esc(r.company) + '</span>'
      + '<span style="font-size:11px;color:var(--text--dark--30);">' + (r.optionLabel ? 'Opt ' + r.option : '') + '</span>'
      + '<span style="font-size:11px;padding:2px 7px;border-radius:10px;background:' + sc.bg + ';color:' + sc.color + ';font-weight:600;">' + esc(r.status) + '</span>'
      + '</div>';
  }).join('');

  document.getElementById('reassignModalOverlay').classList.add('open');
}

function closeReassignModal() {
  document.getElementById('reassignModalOverlay').classList.remove('open');
  _pendingDeleteTrainer = null;
}

async function confirmReassignAndDelete() {
  const newTrainer = document.getElementById('reassignTargetSelect').value;
  if (!newTrainer) {
    showToast('Please select a trainer to reassign to', 'error');
    document.getElementById('reassignTargetSelect').focus();
    return;
  }

  const name = _pendingDeleteTrainer;
  if (!name) return;

  const btn = document.getElementById('confirmReassignBtn');
  btn.disabled = true;
  btn.textContent = 'Saving…';

  // Reassign all active enquiries to new trainer in local data
  const toReassign = allData.filter(r => r.trainer === name && r.status !== 'Cancelled');
  const savePromises = toReassign.map(async r => {
    r.trainer = newTrainer;
    saveOverride(r.rowIndex, { trainer: newTrainer });
    const url = APPS_SCRIPT_URL + '?action=assign&row=' + r.rowIndex + '&trainer=' + encodeURIComponent(newTrainer);
    try { await fetch(url, { method: 'GET', redirect: 'follow', mode: 'no-cors' }); } catch(e) {}
  });

  await Promise.all(savePromises);

  // Now safe to delete
  _executeTrainerDelete(name);
  closeReassignModal();
  logActivity('reassign', null, toReassign.length + ' enquir' + (toReassign.length === 1 ? 'y' : 'ies') + ' reassigned from ' + name + ' → ' + newTrainer, name + ' removed from trainer list');
  showToast('✓ ' + toReassign.length + ' enquir' + (toReassign.length === 1 ? 'y' : 'ies') + ' reassigned to ' + newTrainer + ', ' + name + ' removed', 'success');
}

function _executeTrainerDelete(name) {
  USERS = USERS.filter(u => u.name !== name);
  saveUsers(USERS);
  syncTrainersFromUsers();
  renderTrainerModalList();
  renderTrainerWorkload();
  populateTrainerFilter();
  renderAllBookings();
  renderUnassigned();
  renderActionPanel();
  logActivity('trainer_removed', null, 'Trainer removed: ' + name, '');
  if (!document.getElementById('reassignModalOverlay').classList.contains('open')) {
    showToast(name + ' removed', '');
  }
}


// =============================================
// KPI DETAIL MODALS
// =============================================
const MONTHS_FULL = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const MONTHS_SHORT = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

function openKpiModal(type) {
  const overlay = document.getElementById('kpiModalOverlay');
  overlay.classList.add('open');

  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth();
  const lastMonth = month === 0 ? 11 : month - 1;
  const lastMonthYear = month === 0 ? year - 1 : year;

  // Base datasets — keyed on Booked On Date (col W) with submission date fallback
  const bookedYear  = allData.filter(r => { const d = kpiDate(r); return d && d.getFullYear() === year && r.option !== '1' && r.status === 'Booked'; });
  const bookedMonth = allData.filter(r => { const d = kpiDate(r); return d && d.getFullYear() === year && d.getMonth() === month && r.option !== '1' && r.status === 'Booked'; });
  const bookedLast  = allData.filter(r => { const d = kpiDate(r); return d && d.getFullYear() === lastMonthYear && d.getMonth() === lastMonth && r.option !== '1' && r.status === 'Booked'; });

  const configs = {

    // ── Total Revenue This Year ──────────────────────────────────────────────
    revYear: () => {
      const rows = [...bookedYear].sort((a,b) => (kpiDate(b)||0) - (kpiDate(a)||0));
      const total = rows.reduce((s,r) => s+r.revenue, 0);
      const byTrainer = {};
      const byOption  = {};
      const byMonth   = Array(12).fill(0);
      rows.forEach(r => {
        byTrainer[r.trainer||'Unassigned'] = (byTrainer[r.trainer||'Unassigned']||0) + r.revenue;
        byOption[r.optionLabel||r.option]  = (byOption[r.optionLabel||r.option]||0) + r.revenue;
        const md = kpiDate(r); if (md) byMonth[md.getMonth()] += r.revenue;
      });
      const topTrainer = Object.entries(byTrainer).sort((a,b)=>b[1]-a[1])[0];
      const topMonth   = byMonth.indexOf(Math.max(...byMonth));

      return {
        title: 'Total Revenue — ' + year,
        subtitle: 'All confirmed Booked sessions, excluding Option 1 (On Demand)',
        headline: '£' + total.toLocaleString(),
        stats: [
          { label: 'Bookings', value: rows.length, sub: 'contributing' },
          { label: 'Exc. VAT total', value: '£' + total.toLocaleString(), sub: '' },
          { label: 'Best month', value: MONTHS_SHORT[topMonth], sub: '£' + byMonth[topMonth].toLocaleString() },
          { label: 'Top trainer', value: topTrainer ? topTrainer[0] : '—', sub: topTrainer ? '£' + topTrainer[1].toLocaleString() : '' },
        ],
        head: '<tr><th>Booked Date</th><th>Company</th><th>Contact</th><th>Option</th><th>Trainer</th><th>Days</th><th style="text-align:right;">Revenue</th></tr>',
        body: rows.map(r => `<tr>
          <td style="white-space:nowrap;">${formatDate(kpiDate(r))}</td>
          <td><strong>${esc(r.company)}</strong></td>
          <td>${esc(r.contact)||'—'}</td>
          <td><span class="option-badge opt-${r.option}">${esc(r.optionLabel)}</span></td>
          <td>${r.trainer ? '<span class="trainer-pill">'+esc(r.trainer)+'</span>' : '<span style="color:var(--text--dark--20)">—</span>'}</td>
          <td>${OPTION_DAYS[r.option]||0}d</td>
          <td style="text-align:right;" class="col-money">£${r.revenue.toLocaleString()}</td>
        </tr>`).join('') +
        `<tr style="background:var(--card-light-grey);font-weight:700;">
          <td colspan="6" style="text-align:right;font-size:11px;letter-spacing:0.4px;text-transform:uppercase;color:var(--text--dark--30);">Total</td>
          <td style="text-align:right;font-size:15px;">£${total.toLocaleString()}</td>
        </tr>`
      };
    },

    // ── Revenue This Month ───────────────────────────────────────────────────
    revMonth: () => {
      const rows = [...bookedMonth].sort((a,b) => (kpiDate(b)||0) - (kpiDate(a)||0));
      const total = rows.reduce((s,r) => s+r.revenue, 0);
      const totalLast = bookedLast.reduce((s,r) => s+r.revenue, 0);
      const pctChange = totalLast > 0 ? Math.round(((total - totalLast) / totalLast) * 100) : null;
      const byTrainer = {};
      rows.forEach(r => { byTrainer[r.trainer||'Unassigned'] = (byTrainer[r.trainer||'Unassigned']||0) + r.revenue; });
      const topTrainer = Object.entries(byTrainer).sort((a,b)=>b[1]-a[1])[0];

      return {
        title: 'Revenue — ' + MONTHS_FULL[month] + ' ' + year,
        subtitle: 'Booked sessions submitted or dated in ' + MONTHS_FULL[month],
        headline: '£' + total.toLocaleString(),
        stats: [
          { label: 'Bookings', value: rows.length, sub: 'this month' },
          { label: 'Last month', value: '£' + totalLast.toLocaleString(), sub: MONTHS_SHORT[lastMonth] },
          { label: 'vs Last month', value: pctChange !== null ? (pctChange >= 0 ? '▲ +' : '▼ ') + pctChange + '%' : '—', sub: pctChange >= 0 ? 'improvement' : 'decline' },
          { label: 'Top trainer', value: topTrainer ? topTrainer[0] : '—', sub: topTrainer ? '£' + topTrainer[1].toLocaleString() : '' },
        ],
        head: '<tr><th>Booked Date</th><th>Company</th><th>Contact</th><th>Option</th><th>Trainer</th><th style="text-align:right;">Revenue</th></tr>',
        body: rows.length === 0
          ? '<tr><td colspan="6" style="text-align:center;padding:32px;color:var(--text--dark--30);">No booked sessions this month yet</td></tr>'
          : rows.map(r => `<tr>
          <td style="white-space:nowrap;">${formatDate(kpiDate(r))}</td>
          <td><strong>${esc(r.company)}</strong></td>
          <td>${esc(r.contact)||'—'}</td>
          <td><span class="option-badge opt-${r.option}">${esc(r.optionLabel)}</span></td>
          <td>${r.trainer ? '<span class="trainer-pill">'+esc(r.trainer)+'</span>' : '<span style="color:var(--text--dark--20)">—</span>'}</td>
          <td style="text-align:right;" class="col-money">£${r.revenue.toLocaleString()}</td>
        </tr>`).join('') +
        (rows.length > 0 ? `<tr style="background:var(--card-light-grey);font-weight:700;">
          <td colspan="5" style="text-align:right;font-size:11px;letter-spacing:0.4px;text-transform:uppercase;color:var(--text--dark--30);">Total</td>
          <td style="text-align:right;font-size:15px;">£${total.toLocaleString()}</td>
        </tr>` : '')
      };
    },

    // ── Average Training Fee ─────────────────────────────────────────────────
    avgFee: () => {
      const rows = [...bookedYear].filter(r => r.revenue > 0).sort((a,b) => b.revenue - a.revenue);
      const total = rows.reduce((s,r) => s+r.revenue, 0);
      const avg = rows.length ? Math.round(total / rows.length) : 0;
      const highest = rows[0];
      const lowest = rows[rows.length-1];

      return {
        title: 'Average Training Fee — ' + year,
        subtitle: 'Per booking average, all Booked sessions with a value set',
        headline: '£' + avg.toLocaleString(),
        stats: [
          { label: 'Bookings included', value: rows.length, sub: 'with a fee set' },
          { label: 'Total revenue', value: '£' + total.toLocaleString(), sub: 'exc. VAT' },
          { label: 'Highest fee', value: highest ? '£' + highest.revenue.toLocaleString() : '—', sub: highest ? esc(highest.company) : '' },
          { label: 'Lowest fee', value: lowest ? '£' + lowest.revenue.toLocaleString() : '—', sub: lowest ? esc(lowest.company) : '' },
        ],
        head: '<tr><th>Company</th><th>Contact</th><th>Date</th><th>Option</th><th>Trainer</th><th style="text-align:right;">Fee</th><th style="text-align:right;">vs Avg</th></tr>',
        body: rows.map(r => {
          const diff = r.revenue - avg;
          const diffStr = (diff >= 0 ? '+' : '') + '£' + Math.abs(diff).toLocaleString();
          const diffCol = diff > 0 ? '#2a7a26' : diff < 0 ? '#c0303d' : '#999';
          return `<tr>
            <td><strong>${esc(r.company)}</strong></td>
            <td>${esc(r.contact)||'—'}</td>
            <td style="white-space:nowrap;">${formatDate(kpiDate(r))}</td>
            <td><span class="option-badge opt-${r.option}">${esc(r.optionLabel)}</span></td>
            <td>${r.trainer ? '<span class="trainer-pill">'+esc(r.trainer)+'</span>' : '<span style="color:var(--text--dark--20)">—</span>'}</td>
            <td style="text-align:right;" class="col-money">£${r.revenue.toLocaleString()}</td>
            <td style="text-align:right;font-weight:600;color:${diffCol};">${diffStr}</td>
          </tr>`;
        }).join('')
      };
    },

    // ── Training Days ────────────────────────────────────────────────────────
    days: () => {
      const rows = [...bookedYear].sort((a,b) => (kpiDate(b)||0) - (kpiDate(a)||0));
      const totalDays = rows.reduce((s,r) => s + (OPTION_DAYS[r.option]||0), 0);
      const monthDays = bookedMonth.reduce((s,r) => s + (OPTION_DAYS[r.option]||0), 0);
      const byTrainer = {};
      TRAINERS.forEach(t => { byTrainer[t] = { days: 0, bookings: 0 }; });
      rows.forEach(r => {
        const t = r.trainer || 'Unassigned';
        if (!byTrainer[t]) byTrainer[t] = { days: 0, bookings: 0 };
        byTrainer[t].days += OPTION_DAYS[r.option]||0;
        byTrainer[t].bookings++;
      });
      const topTrainer = Object.entries(byTrainer).sort((a,b)=>b[1].days-a[1].days)[0];

      return {
        title: 'Training Days — ' + year,
        subtitle: 'Based on session type: 1 Day = 1, 2 Day = 2, Accounting = 1, HQ = 1, On Demand = 0',
        headline: totalDays + ' days',
        stats: [
          { label: 'Total sessions', value: rows.length, sub: 'booked this year' },
          { label: 'This month', value: monthDays + 'd', sub: MONTHS_SHORT[month] + ' booked days' },
          { label: 'Top trainer', value: topTrainer ? topTrainer[0] : '—', sub: topTrainer ? topTrainer[1].days + ' days' : '' },
          { label: 'Avg days / booking', value: rows.length ? (totalDays / rows.length).toFixed(1) : '—', sub: 'per session' },
        ],
        head: '<tr><th>Booked Date</th><th>Company</th><th>Contact</th><th>Option</th><th>Trainer</th><th style="text-align:center;">Days</th><th style="text-align:right;">Revenue</th></tr>',
        body: rows.map(r => `<tr>
          <td style="white-space:nowrap;">${formatDate(kpiDate(r))}</td>
          <td><strong>${esc(r.company)}</strong></td>
          <td>${esc(r.contact)||'—'}</td>
          <td><span class="option-badge opt-${r.option}">${esc(r.optionLabel)}</span></td>
          <td>${r.trainer ? '<span class="trainer-pill">'+esc(r.trainer)+'</span>' : '<span style="color:var(--text--dark--20)">—</span>'}</td>
          <td style="text-align:center;" class="col-highlight">${OPTION_DAYS[r.option]||0}</td>
          <td style="text-align:right;" class="col-money">£${r.revenue.toLocaleString()}</td>
        </tr>`).join('') +
        `<tr style="background:var(--card-light-grey);font-weight:700;">
          <td colspan="5" style="text-align:right;font-size:11px;letter-spacing:0.4px;text-transform:uppercase;color:var(--text--dark--30);">Total days</td>
          <td style="text-align:center;font-size:15px;" class="col-highlight">${totalDays}</td>
          <td style="text-align:right;font-size:15px;">£${rows.reduce((s,r)=>s+r.revenue,0).toLocaleString()}</td>
        </tr>`
      };
    },

    // ── Total Bookings ───────────────────────────────────────────────────────
    bookings: () => {
      const rows = [...bookedYear].sort((a,b) => (kpiDate(b)||0) - (kpiDate(a)||0));
      const byOption = {};
      const byTrainer = {};
      const byMonth = Array(12).fill(0);
      rows.forEach(r => {
        byOption[r.optionLabel||r.option] = (byOption[r.optionLabel||r.option]||0) + 1;
        const t = r.trainer || 'Unassigned';
        byTrainer[t] = (byTrainer[t]||0) + 1;
        const bmd = kpiDate(r); if (bmd) byMonth[bmd.getMonth()]++;
      });
      const topOption  = Object.entries(byOption).sort((a,b)=>b[1]-a[1])[0];
      const topTrainer = Object.entries(byTrainer).sort((a,b)=>b[1]-a[1])[0];
      const busyMonth  = byMonth.indexOf(Math.max(...byMonth));

      return {
        title: 'All Bookings — ' + year,
        subtitle: 'Every confirmed Booked session this year, newest first',
        headline: rows.length + ' bookings',
        stats: [
          { label: 'This month', value: bookedMonth.length, sub: MONTHS_SHORT[month] },
          { label: 'Most popular option', value: topOption ? topOption[0].replace(' Day','d').replace('Personalised ','') : '—', sub: topOption ? topOption[1] + ' bookings' : '' },
          { label: 'Busiest month', value: MONTHS_SHORT[busyMonth], sub: byMonth[busyMonth] + ' bookings' },
          { label: 'Top trainer', value: topTrainer ? topTrainer[0] : '—', sub: topTrainer ? topTrainer[1] + ' bookings' : '' },
        ],
        head: '<tr><th>Booked Date</th><th>Company</th><th>Contact</th><th>Email</th><th>Option</th><th>Trainer</th><th>Days</th><th style="text-align:right;">Revenue</th></tr>',
        body: rows.map(r => `<tr>
          <td style="white-space:nowrap;">${formatDate(kpiDate(r))}</td>
          <td><strong>${esc(r.company)}</strong></td>
          <td>${esc(r.contact)||'—'}</td>
          <td style="font-size:11px;color:var(--text--dark--30);">${esc(r.email)||'—'}</td>
          <td><span class="option-badge opt-${r.option}">${esc(r.optionLabel)}</span></td>
          <td>${r.trainer ? '<span class="trainer-pill">'+esc(r.trainer)+'</span>' : '<span style="color:var(--text--dark--20)">—</span>'}</td>
          <td>${OPTION_DAYS[r.option]||0}d</td>
          <td style="text-align:right;" class="col-money">£${r.revenue.toLocaleString()}</td>
        </tr>`).join('') +
        `<tr style="background:var(--card-light-grey);font-weight:700;">
          <td colspan="7" style="text-align:right;font-size:11px;letter-spacing:0.4px;text-transform:uppercase;color:var(--text--dark--30);">Total revenue</td>
          <td style="text-align:right;font-size:15px;">£${rows.reduce((s,r)=>s+r.revenue,0).toLocaleString()}</td>
        </tr>`
      };
    }
  };

  const cfg = configs[type] ? configs[type]() : null;
  if (!cfg) return;

  document.getElementById('kpiModalTitle').textContent    = cfg.title;
  document.getElementById('kpiModalSubtitle').textContent = cfg.subtitle;
  document.getElementById('kpiModalHeadline').textContent = cfg.headline;
  document.getElementById('kpiModalTableHead').innerHTML  = cfg.head;
  document.getElementById('kpiModalTableBody').innerHTML  = cfg.body;

  // Stats bar
  document.getElementById('kpiModalStats').innerHTML = cfg.stats.map(s => `
    <div class="kpi-modal-stat">
      <span class="kpi-modal-stat-label">${s.label}</span>
      <span class="kpi-modal-stat-value">${s.value}</span>
      ${s.sub ? '<span class="kpi-modal-stat-sub">'+s.sub+'</span>' : ''}
    </div>
  `).join('');
}

function closeKpiModal(event) {
  if (event && event.target !== document.getElementById('kpiModalOverlay')) return;
  document.getElementById('kpiModalOverlay').classList.remove('open');
}

// Also close on Escape key
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    document.getElementById('kpiModalOverlay').classList.remove('open');
  }
});


// =============================================
// CHART CLICK MODALS
// =============================================

function openChartMonthModal(monthIdx, clickedYear, rows, compareRows, compareYear) {
  const overlay = document.getElementById('kpiModalOverlay');
  overlay.classList.add('open');

  const MONTHS_FULL_LOCAL = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  const MONTHS_S = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

  const sorted = [...rows].sort((a,b) => (kpiDate(b)||0) - (kpiDate(a)||0));
  const total  = sorted.reduce((s,r) => s+r.revenue, 0);
  const compareTotal = compareRows.reduce((s,r) => s+r.revenue, 0);
  const pctChange = compareTotal > 0 ? Math.round(((total - compareTotal) / compareTotal) * 100) : null;

  // Breakdown by trainer
  const byTrainer = {};
  sorted.forEach(r => {
    const t = r.trainer || 'Unassigned';
    if (!byTrainer[t]) byTrainer[t] = { count: 0, revenue: 0 };
    byTrainer[t].count++;
    byTrainer[t].revenue += r.revenue;
  });
  const topTrainer = Object.entries(byTrainer).sort((a,b) => b[1].revenue - a[1].revenue)[0];

  // Breakdown by option
  const byOption = {};
  sorted.forEach(r => {
    const lbl = r.optionLabel || ('Option ' + r.option);
    if (!byOption[lbl]) byOption[lbl] = { count: 0, revenue: 0 };
    byOption[lbl].count++;
    byOption[lbl].revenue += r.revenue;
  });

  document.getElementById('kpiModalTitle').textContent    = MONTHS_FULL_LOCAL[monthIdx] + ' ' + clickedYear + ' — Revenue Breakdown';
  document.getElementById('kpiModalSubtitle').textContent = 'Booked sessions with training date in ' + MONTHS_FULL_LOCAL[monthIdx] + ' ' + clickedYear + '. Click bars on the chart to explore any month.';
  document.getElementById('kpiModalHeadline').textContent = '£' + total.toLocaleString();

  document.getElementById('kpiModalStats').innerHTML = [
    { label: 'Bookings', value: sorted.length, sub: MONTHS_S[monthIdx] + ' ' + clickedYear },
    { label: compareYear + ' (same month)', value: '£' + compareTotal.toLocaleString(), sub: compareRows.length + ' bookings' },
    { label: 'Year-on-year', value: pctChange !== null ? (pctChange >= 0 ? '▲ +' : '▼ ') + Math.abs(pctChange) + '%' : (compareTotal === 0 ? 'No prior data' : '—'), sub: pctChange !== null ? (pctChange >= 0 ? 'up vs ' : 'down vs ') + compareYear : '' },
    { label: 'Top trainer', value: topTrainer ? topTrainer[0] : '—', sub: topTrainer ? '£' + topTrainer[1].revenue.toLocaleString() + ' · ' + topTrainer[1].count + ' sessions' : '' },
  ].map(s => `<div class="kpi-modal-stat">
    <span class="kpi-modal-stat-label">${s.label}</span>
    <span class="kpi-modal-stat-value">${s.value}</span>
    ${s.sub ? '<span class="kpi-modal-stat-sub">'+s.sub+'</span>' : ''}
  </div>`).join('');

  // Option summary mini-table above main table
  const optSummaryRows = Object.entries(byOption).sort((a,b) => b[1].revenue-a[1].revenue)
    .map(([lbl, v]) => `<tr>
      <td>${esc(lbl)}</td>
      <td style="text-align:center;">${v.count}</td>
      <td style="text-align:right;font-weight:600;">£${v.revenue.toLocaleString()}</td>
    </tr>`).join('');

  // Compare section rows
  const compareSection = compareRows.length > 0 ? `
    <tr style="background:var(--card-light-grey);">
      <td colspan="7" style="padding:10px 14px;font-size:11px;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;color:var(--text--dark--30);">
        ↔ ${MONTHS_S[monthIdx]} ${compareYear} — for comparison (${compareRows.length} booking${compareRows.length!==1?'s':''}, £${compareTotal.toLocaleString()})
      </td>
    </tr>` +
    [...compareRows].sort((a,b) => (kpiDate(b)||0)-(kpiDate(a)||0)).map(r => `<tr style="opacity:0.7;">
      <td style="white-space:nowrap;">${formatDate(kpiDate(r))}</td>
      <td><strong>${esc(r.company)}</strong></td>
      <td>${esc(r.contact)||'—'}</td>
      <td><span class="option-badge opt-${r.option}">${esc(r.optionLabel)}</span></td>
      <td>${r.trainer ? '<span class="trainer-pill">'+esc(r.trainer)+'</span>' : '<span style="color:var(--text--dark--20)">—</span>'}</td>
      <td style="text-align:center;">${OPTION_DAYS[r.option]||0}d</td>
      <td style="text-align:right;font-weight:600;">£${r.revenue.toLocaleString()}</td>
    </tr>`).join('') : '';

  document.getElementById('kpiModalTableHead').innerHTML =
    '<tr><th>Booked Date</th><th>Company</th><th>Contact</th><th>Option</th><th>Trainer</th><th style="text-align:center;">Days</th><th style="text-align:right;">Revenue</th></tr>';

  document.getElementById('kpiModalTableBody').innerHTML =
    (sorted.length === 0
      ? `<tr><td colspan="7" style="text-align:center;padding:32px;color:var(--text--dark--30);">No booked sessions in ${MONTHS_FULL_LOCAL[monthIdx]} ${clickedYear}</td></tr>`
      : sorted.map(r => `<tr>
          <td style="white-space:nowrap;">${formatDate(kpiDate(r))}</td>
          <td><strong>${esc(r.company)}</strong></td>
          <td>${esc(r.contact)||'—'}</td>
          <td><span class="option-badge opt-${r.option}">${esc(r.optionLabel)}</span></td>
          <td>${r.trainer ? '<span class="trainer-pill">'+esc(r.trainer)+'</span>' : '<span style="color:var(--text--dark--20)">—</span>'}</td>
          <td style="text-align:center;">${OPTION_DAYS[r.option]||0}d</td>
          <td style="text-align:right;font-weight:600;">£${r.revenue.toLocaleString()}</td>
        </tr>`).join('') +
        `<tr style="background:var(--card-light-grey);font-weight:700;">
          <td colspan="6" style="text-align:right;font-size:11px;letter-spacing:0.4px;text-transform:uppercase;color:var(--text--dark--30);">${MONTHS_S[monthIdx]} ${clickedYear} Total</td>
          <td style="text-align:right;font-size:15px;">£${total.toLocaleString()}</td>
        </tr>`
    ) + compareSection;
}

function openChartOptionModal(optKey, rows, year) {
  const overlay = document.getElementById('kpiModalOverlay');
  overlay.classList.add('open');

  const sorted  = [...rows].sort((a,b) => (kpiDate(b)||0) - (kpiDate(a)||0));
  const total   = sorted.reduce((s,r) => s+r.revenue, 0);
  const label   = OPTION_LABELS[optKey] || ('Option ' + optKey);
  const days    = sorted.reduce((s,r) => s + (OPTION_DAYS[r.option]||0), 0);

  const byTrainer = {};
  sorted.forEach(r => {
    const t = r.trainer || 'Unassigned';
    if (!byTrainer[t]) byTrainer[t] = { count: 0, revenue: 0 };
    byTrainer[t].count++;
    byTrainer[t].revenue += r.revenue;
  });
  const byTrainerSorted = Object.entries(byTrainer).sort((a,b) => b[1].count - a[1].count);
  const topTrainer = byTrainerSorted[0];
  const avgFee = sorted.filter(r=>r.revenue>0).length
    ? Math.round(total / sorted.filter(r=>r.revenue>0).length) : 0;

  document.getElementById('kpiModalTitle').textContent    = 'Option ' + optKey + ' — ' + label;
  document.getElementById('kpiModalSubtitle').textContent = 'All bookings for this training option in ' + year + '. Click a different segment to switch option.';
  document.getElementById('kpiModalHeadline').textContent = sorted.length + ' booking' + (sorted.length !== 1 ? 's' : '');

  document.getElementById('kpiModalStats').innerHTML = [
    { label: 'Total revenue', value: '£' + total.toLocaleString(), sub: 'exc. VAT' },
    { label: 'Training days', value: days + 'd', sub: (OPTION_DAYS[optKey]||0) + ' day' + ((OPTION_DAYS[optKey]||0)!==1?'s':'') + ' per session' },
    { label: 'Avg fee', value: avgFee ? '£' + avgFee.toLocaleString() : '—', sub: 'per booking' },
    { label: 'Top trainer', value: topTrainer ? topTrainer[0] : '—', sub: topTrainer ? topTrainer[1].count + ' session' + (topTrainer[1].count!==1?'s':'') : '' },
  ].map(s => `<div class="kpi-modal-stat">
    <span class="kpi-modal-stat-label">${s.label}</span>
    <span class="kpi-modal-stat-value">${s.value}</span>
    ${s.sub ? '<span class="kpi-modal-stat-sub">'+s.sub+'</span>' : ''}
  </div>`).join('');

  // Trainer breakdown rows
  const trainerBreakdown = byTrainerSorted.length > 0 ? `
    <tr style="background:var(--card-light-grey);">
      <td colspan="6" style="padding:10px 14px;font-size:11px;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;color:var(--text--dark--30);">
        Trainer Breakdown
      </td>
    </tr>` + byTrainerSorted.map(([name, v]) => {
      const pct = sorted.length ? Math.round((v.count/sorted.length)*100) : 0;
      return `<tr style="background:#fafbff;">
        <td colspan="3"><span class="trainer-pill">${esc(name)}</span></td>
        <td>${v.count} session${v.count!==1?'s':''} (${pct}%)</td>
        <td colspan="2" style="text-align:right;font-weight:600;">£${v.revenue.toLocaleString()}</td>
      </tr>`;
    }).join('') : '';

  document.getElementById('kpiModalTableHead').innerHTML =
    '<tr><th>Booked Date</th><th>Company</th><th>Contact</th><th>Status</th><th>Trainer</th><th style="text-align:right;">Revenue</th></tr>';

  document.getElementById('kpiModalTableBody').innerHTML =
    (sorted.length === 0
      ? `<tr><td colspan="6" style="text-align:center;padding:32px;color:var(--text--dark--30);">No bookings for this option in ${year}</td></tr>`
      : sorted.map(r => `<tr>
          <td style="white-space:nowrap;">${formatDate(kpiDate(r))}</td>
          <td><strong>${esc(r.company)}</strong></td>
          <td>${esc(r.contact)||'—'}</td>
          <td><span class="status-badge status-${(r.status||'').toLowerCase()}">${esc(r.status)||'—'}</span></td>
          <td>${r.trainer ? '<span class="trainer-pill">'+esc(r.trainer)+'</span>' : '<span style="color:var(--text--dark--20)">—</span>'}</td>
          <td style="text-align:right;font-weight:600;">£${r.revenue.toLocaleString()}</td>
        </tr>`).join('') +
        `<tr style="background:var(--card-light-grey);font-weight:700;">
          <td colspan="5" style="text-align:right;font-size:11px;letter-spacing:0.4px;text-transform:uppercase;color:var(--text--dark--30);">Total</td>
          <td style="text-align:right;font-size:15px;">£${total.toLocaleString()}</td>
        </tr>`
    ) + trainerBreakdown;
}


// =============================================
// ACTIVITY FEED
// =============================================
const ACTIVITY_KEY = 'streetDashboardActivity';
const USERNAME_KEY  = 'streetDashboardUser';
const MAX_ACTIVITY  = 200; // keep last 200 events

const ACTIVITY_ICONS = {
  status:   { icon: '🔄', bg: '#eef1ff', color: '#2147f4' },
  trainer:  { icon: '👤', bg: '#f5ede5', color: '#8a5a2a' },
  value:    { icon: '£',  bg: '#f0fdf4', color: '#1a6a40' },
  date:     { icon: '📅', bg: '#f6f8ff', color: '#2147f4' },
  trainer_added:   { icon: '➕', bg: '#f0fdf4', color: '#1a6a40' },
  trainer_removed: { icon: '✕',  bg: '#fde8eb', color: '#c0303d' },
  reassign: { icon: '↔',  bg: '#f5ede5', color: '#8a5a2a' },
  refresh:  { icon: '↻',  bg: '#f6f8ff', color: '#2147f4' },
};

function getUsername() {
  return localStorage.getItem(USERNAME_KEY) || '';
}

function initActivityFeed() {
  const cur = getCurrentUser();
  if (cur) updateUserDisplay(cur.name);
  renderActivityFeed();
}

function promptUsername(isChange = false) {
  const overlay = document.getElementById('usernameModalOverlay');
  const inp     = document.getElementById('usernameInput');
  if (isChange) {
    inp.value = getUsername();
    // Close activity panel while prompting
    closeActivityPanel();
  } else {
    inp.value = '';
  }
  overlay.classList.add('open');
  setTimeout(() => inp.focus(), 120);
}

function saveUsername() {
  const inp  = document.getElementById('usernameInput');
  const name = (inp.value || '').trim();
  if (!name) { inp.focus(); return; }
  localStorage.setItem(USERNAME_KEY, name);
  document.getElementById('usernameModalOverlay').classList.remove('open');
  updateUserDisplay(name);
  logActivity('meta', null, 'Signed in as ' + name, '');
  renderActivityFeed();
}

function updateUserDisplay(name) {
  const initials = name.split(' ').map(w => w[0]).join('').slice(0,2).toUpperCase();
  const avatarEl = document.getElementById('activityAvatar');
  const nameEl   = document.getElementById('activityUserDisplay');
  if (avatarEl) avatarEl.textContent = initials;
  if (nameEl)   nameEl.textContent   = name;
}

function getActivityLog() {
  try {
    const raw = localStorage.getItem(ACTIVITY_KEY);
    return raw ? JSON.parse(raw) : [];
  } catch(e) { return []; }
}

function saveActivityLog(log) {
  try {
    localStorage.setItem(ACTIVITY_KEY, JSON.stringify(log.slice(0, MAX_ACTIVITY)));
  } catch(e) {}
}

/**
 * logActivity(type, company, description, detail)
 * type: 'status' | 'trainer' | 'value' | 'date' | 'trainer_added' | 'trainer_removed' | 'reassign' | 'refresh' | 'meta'
 */
function logActivity(type, company, description, detail) {
  const log = getActivityLog();
  log.unshift({
    id: Date.now() + Math.random(),
    type,
    company:     company || null,
    description,
    detail:      detail || '',
    user:        getUsername() || 'Unknown',
    timestamp:   new Date().toISOString(),
  });
  saveActivityLog(log);
  renderActivityFeed();
  // Flash the dot on the activity button
  const dot = document.getElementById('activityBtnDot');
  if (dot) {
    dot.classList.add('visible');
    clearTimeout(dot._clearTimer);
    dot._clearTimer = setTimeout(() => dot.classList.remove('visible'), 8000);
  }
}

function clearActivityLog() {
  if (!confirm('Clear the entire activity log? This cannot be undone.')) return;
  localStorage.removeItem(ACTIVITY_KEY);
  renderActivityFeed();
  showToast('Activity log cleared', '');
}

function openActivityPanel() {
  document.getElementById('activityPanel').classList.add('open');
  document.getElementById('activityPanelOverlay').classList.add('open');
  document.getElementById('activityBtnDot').classList.remove('visible');
  renderActivityFeed();
}

function closeActivityPanel() {
  document.getElementById('activityPanel').classList.remove('open');
  document.getElementById('activityPanelOverlay').classList.remove('open');
}

function renderActivityFeed() {
  const log   = getActivityLog();
  const body  = document.getElementById('activityFeedBody');
  const count = document.getElementById('activityCount');
  if (!body) return;

  if (count) count.textContent = log.length + ' event' + (log.length !== 1 ? 's' : '');

  if (log.length === 0) {
    body.innerHTML = '<div class="activity-empty"><div class="activity-empty-icon">📋</div>No activity yet — changes you make will appear here</div>';
    return;
  }

  // Group by calendar date
  let lastDate = null;
  body.innerHTML = log.map(item => {
    const ts   = new Date(item.timestamp);
    const dateKey = ts.toDateString();
    let divider = '';
    if (dateKey !== lastDate) {
      lastDate = dateKey;
      const isToday = dateKey === new Date().toDateString();
      const isYest  = dateKey === new Date(Date.now()-86400000).toDateString();
      const label   = isToday ? 'Today' : isYest ? 'Yesterday'
        : ts.toLocaleDateString('en-GB', { weekday:'long', day:'numeric', month:'long', year:'numeric' });
      divider = `<div class="activity-date-divider">${label}</div>`;
    }

    const meta   = ACTIVITY_ICONS[item.type] || ACTIVITY_ICONS.status;
    const timeStr = ts.toLocaleTimeString('en-GB', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
    const companyBit = item.company
      ? `<span class="act-company">${esc(item.company)}</span> — ` : '';

    return divider + `<div class="activity-item">
      <div class="activity-item-icon" style="background:${meta.bg};color:${meta.color};font-size:${item.type==='value'?'11px':'14px'};font-weight:700;">
        ${meta.icon}
      </div>
      <div class="activity-item-body">
        <div class="activity-item-text">${companyBit}${esc(item.description)}${item.detail ? '<br><span style="color:var(--text--dark--30);font-size:11px;">'+esc(item.detail)+'</span>' : ''}</div>
        <div class="activity-item-meta">
          <span class="activity-item-user">${esc(item.user)}</span>
          <span class="activity-item-time">${timeStr}</span>
        </div>
      </div>
    </div>`;
  }).join('');
}

// Escape for activity log display (already have esc() globally)


// =============================================
// PIN / PASSCODE SYSTEM
// =============================================
const PIN_KEY = 'streetDashboardPins_v1'; // { [name]: hashedPin }

// Simple hash — not cryptographic, just obfuscation in localStorage
function hashPin(pin) {
  let h = 0;
  for (let i = 0; i < pin.length; i++) h = (Math.imul(31, h) + pin.charCodeAt(i)) | 0;
  return 'p' + Math.abs(h).toString(36) + pin.length;
}

function getPins() {
  try { return JSON.parse(localStorage.getItem(PIN_KEY) || '{}'); } catch(e) { return {}; }
}

function savePin(name, pin) {
  const pins = getPins();
  pins[name] = hashPin(pin);
  localStorage.setItem(PIN_KEY, JSON.stringify(pins));
}

function verifyPin(name, pin) {
  const pins = getPins();
  return pins[name] && pins[name] === hashPin(pin);
}

function hasPin(name) {
  const pins = getPins();
  return !!pins[name];
}

function removePin(name) {
  const pins = getPins();
  delete pins[name];
  localStorage.setItem(PIN_KEY, JSON.stringify(pins));
}

// ── PIN state machine ──────────────────────────────────────────────────────
// modes: 'enter' | 'setup' | 'setup-confirm' | 'change-old' | 'change-new' | 'change-confirm' | 'admin-reset'
let _pinState = {
  mode:        'enter',
  targetUser:  null,    // user object being authenticated
  digits:      [],
  firstEntry:  '',      // for setup confirm step
  adminTarget: null,    // for admin resetting another user's pin
};

function openPinScreen(userName, mode = 'enter') {
  const user = USERS.find(u => u.name === userName);
  if (!user) return;

  _pinState = { mode, targetUser: user, digits: [], firstEntry: '', adminTarget: null };

  // Populate UI
  const initials = userName.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
  document.getElementById('pinAvatar').textContent = initials;
  document.getElementById('pinUserName').textContent = userName;

  _updatePinUI();

  document.getElementById('pinScreen').classList.remove('hidden');
  document.getElementById('loginScreen').classList.add('hidden');
}

function closePinScreen() {
  document.getElementById('pinScreen').classList.add('hidden');
}

function _updatePinUI() {
  const { mode } = _pinState;
  const labels = {
    'enter':          'Enter your 4-digit passcode',
    'setup':          'Create a 4-digit passcode',
    'setup-confirm':  'Confirm your passcode',
    'change-old':     'Enter your current passcode',
    'change-new':     'Enter your new passcode',
    'change-confirm': 'Confirm your new passcode',
    'admin-reset':    'Set new passcode for ' + (_pinState.adminTarget || ''),
    'admin-confirm':  'Confirm new passcode for ' + (_pinState.adminTarget || ''),
  };
  document.getElementById('pinLabel').textContent = labels[mode] || 'Enter passcode';
  document.getElementById('pinSetupInfo').style.display = mode === 'setup' ? 'block' : 'none';
  document.getElementById('pinForgotWrap').style.display = (mode === 'enter') ? 'block' : 'none';
  document.getElementById('pinError').textContent = '';
  _refreshDots();
}

function _refreshDots() {
  for (let i = 0; i < 4; i++) {
    const dot = document.getElementById('pd' + i);
    dot.classList.toggle('filled', i < _pinState.digits.length);
    dot.classList.remove('error');
  }
}

function pinKey(digit) {
  if (_pinState.digits.length >= 4) return;
  _pinState.digits.push(digit);
  _refreshDots();
  if (_pinState.digits.length === 4) {
    setTimeout(_pinSubmit, 120); // tiny delay so last dot shows
  }
}

function pinDel() {
  _pinState.digits.pop();
  _refreshDots();
  document.getElementById('pinError').textContent = '';
}

function pinBack() {
  closePinScreen();
  renderLoginScreen();
  document.getElementById('loginScreen').classList.remove('hidden');
}

function _pinError(msg) {
  for (let i = 0; i < 4; i++) {
    const dot = document.getElementById('pd' + i);
    dot.classList.add('error');
    dot.classList.remove('filled');
  }
  document.getElementById('pinError').textContent = msg;
  // Shake then clear
  setTimeout(() => {
    _pinState.digits = [];
    _refreshDots();
  }, 700);
}

function _pinSubmit() {
  const pin    = _pinState.digits.join('');
  const { mode, targetUser } = _pinState;

  if (mode === 'enter') {
    if (verifyPin(targetUser.name, pin)) {
      _pinSuccess();
    } else {
      _pinError('Incorrect passcode — try again');
    }
  }
  else if (mode === 'setup') {
    _pinState.firstEntry = pin;
    _pinState.digits = [];
    _pinState.mode = 'setup-confirm';
    _updatePinUI();
  }
  else if (mode === 'setup-confirm') {
    if (pin === _pinState.firstEntry) {
      savePin(targetUser.name, pin);
      _pinSuccess();
    } else {
      _pinError("Passcodes don't match — try again");
      _pinState.firstEntry = '';
      setTimeout(() => { _pinState.mode = 'setup'; _updatePinUI(); }, 800);
    }
  }
  else if (mode === 'change-old') {
    if (verifyPin(targetUser.name, pin)) {
      _pinState.digits = [];
      _pinState.mode = 'change-new';
      _updatePinUI();
    } else {
      _pinError('Incorrect current passcode');
    }
  }
  else if (mode === 'change-new') {
    _pinState.firstEntry = pin;
    _pinState.digits = [];
    _pinState.mode = 'change-confirm';
    _updatePinUI();
  }
  else if (mode === 'change-confirm') {
    if (pin === _pinState.firstEntry) {
      savePin(targetUser.name, pin);
      closePinScreen();
      showToast('✓ Passcode updated for ' + targetUser.name, 'success');
      logActivity('meta', null, 'Passcode changed for ' + targetUser.name, '');
      // Return to dashboard or login
      if (getCurrentUser()) {
        // Was already logged in (changing own PIN from settings)
      } else {
        renderLoginScreen();
        document.getElementById('loginScreen').classList.remove('hidden');
      }
    } else {
      _pinError("Passcodes don't match — try again");
      _pinState.firstEntry = '';
      setTimeout(() => { _pinState.mode = 'change-new'; _updatePinUI(); }, 800);
    }
  }
  else if (mode === 'admin-reset') {
    _pinState.firstEntry = pin;
    _pinState.digits = [];
    _pinState.mode = 'admin-confirm';
    _updatePinUI();
  }
  else if (mode === 'admin-confirm') {
    if (pin === _pinState.firstEntry) {
      savePin(_pinState.adminTarget, pin);
      closePinScreen();
      showToast('✓ Passcode reset for ' + _pinState.adminTarget, 'success');
      logActivity('meta', null, 'Admin reset passcode for ' + _pinState.adminTarget, 'Reset by ' + (getCurrentUser() ? getCurrentUser().name : 'Admin'));
    } else {
      _pinError("Passcodes don't match — try again");
      _pinState.firstEntry = '';
      setTimeout(() => { _pinState.mode = 'admin-reset'; _updatePinUI(); }, 800);
    }
  }
}

function _pinSuccess() {
  closePinScreen();
  const user = _pinState.targetUser;
  setCurrentUser(user);
  hideLoginScreen();
  applyPermissions();
  updateHeaderUser(user.name);
  updateUserDisplay(user.name);
  logActivity('meta', null, user.name + ' logged in', '');
  renderActivityFeed();
}

function pinForgot() {
  const name = _pinState.targetUser ? _pinState.targetUser.name : '';
  // Check if there's an admin who can reset
  const admins = USERS.filter(u => u.permissions && u.permissions.manage_trainers && u.name !== name);
  if (admins.length > 0) {
    const adminNames = admins.map(a => a.name).join(', ');
    if (confirm('Your passcode has been forgotten.\n\nAn admin (' + adminNames + ') can reset it for you in Manage Trainers.\n\nPress OK to go back to the user select screen.')) {
      pinBack();
    }
  } else {
    if (confirm('No admin is available to reset your passcode.\n\nReset passcode for ' + name + '?')) {
      _pinState.firstEntry = '';
      _pinState.digits = [];
      _pinState.mode = 'setup';
      _updatePinUI();
    }
  }
}

// Called by admin from Manage Trainers modal to reset another user's PIN

function changeSelfPin() {
  const cur = getCurrentUser();
  if (!cur) return;
  document.getElementById('trainerModalOverlay').classList.remove('open');
  const mode = hasPin(cur.name) ? 'change-old' : 'setup';
  openPinScreen(cur.name, mode);
}

function adminResetPin(targetName) {
  const cur = getCurrentUser();
  if (!cur || !cur.permissions.manage_trainers) {
    showToast('Only admins can reset passcodes', 'error');
    return;
  }
  _pinState = { mode: 'admin-reset', targetUser: cur, digits: [], firstEntry: '', adminTarget: targetName };
  document.getElementById('pinAvatar').textContent = targetName.slice(0,2).toUpperCase();
  document.getElementById('pinUserName').textContent = 'Reset for: ' + targetName;
  document.getElementById('pinSetupInfo').style.display = 'block';
  document.getElementById('pinSetupInfo').textContent = 'You are resetting the passcode for ' + targetName + '. They will use this new passcode next time they log in.';
  document.getElementById('pinForgotWrap').style.display = 'none';
  document.getElementById('pinLabel').textContent = 'Set new passcode for ' + targetName;
  document.getElementById('pinError').textContent = '';
  _refreshDots();
  // Close trainer modal while PIN entry happens
  document.getElementById('trainerModalOverlay').classList.remove('open');
  document.getElementById('pinScreen').classList.remove('hidden');
}

function updateHeaderUser(name) {
  const chip   = document.getElementById('headerUserChip');
  const avatar = document.getElementById('headerUserAvatar');
  const nameEl = document.getElementById('headerUserName');
  const logoutBtn = document.getElementById('logoutBtn');
  if (chip)    { chip.style.display = 'flex'; }
  if (avatar)  { avatar.textContent = name.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase(); }
  if (nameEl)  { nameEl.textContent = name; }
  if (logoutBtn) { logoutBtn.style.display = ''; }
}


// =============================================
// SHADOW / PREVIEW MODE
// =============================================
let _shadowState = {
  active:       false,
  targetName:   null,    // user being previewed
  adminUser:    null,    // actual logged-in admin
  livePerms:    null,    // current perm object being edited
};

// Called from "Preview as X" button inside editTrainerPerms modal
function enterShadowMode() {
  const name = document.getElementById('editPermName').textContent;
  if (!name || name === '—') return;

  // Snapshot current toggle state from the modal as the live perms to preview
  const livePerms = {};
  Object.keys(ALL_PERMISSIONS).forEach(key => {
    const cb = document.getElementById('ep-' + name + '-' + key);
    if (cb) livePerms[key] = cb.checked;
  });

  _shadowState = {
    active:     true,
    targetName: name,
    adminUser:  getCurrentUser(),
    livePerms,
  };

  // Close modals & trainer modal
  closeEditPermModal();
  document.getElementById('trainerModalOverlay').classList.remove('open');

  // Temporarily swap the current user session to the shadow user
  const shadowUser = { ...USERS.find(u => u.name === name), permissions: livePerms };
  setCurrentUser(shadowUser);

  // Show banner
  document.getElementById('shadowBannerName').textContent = name;
  document.getElementById('shadowBanner').classList.add('active');
  document.body.classList.add('shadow-mode');

  // Apply the preview permissions to the UI
  applyPermissions();
  showToast('👁 Previewing as ' + name, '');
}

// Live-update the preview when a toggle changes inside the modal
function onShadowPermToggle(name, key, checked) {
  if (!_shadowState.active || _shadowState.targetName !== name) return;
  _shadowState.livePerms[key] = checked;
  const shadowUser = { ...USERS.find(u => u.name === name), permissions: { ..._shadowState.livePerms } };
  setCurrentUser(shadowUser);
  applyPermissions();
}

// Exit preview — restore admin session, re-open edit modal
function exitShadowMode() {
  if (!_shadowState.active) return;
  const targetName = _shadowState.targetName;

  // Restore admin
  setCurrentUser(_shadowState.adminUser);
  document.getElementById('shadowBanner').classList.remove('active');
  document.body.classList.remove('shadow-mode');
  _shadowState.active = false;

  applyPermissions();

  // Re-open edit modal with whatever the current livePerms are
  editTrainerPerms(targetName);
}

// Save the current livePerms as the real permissions and exit shadow
function saveShadowAndExit() {
  if (!_shadowState.active) return;
  const targetName = _shadowState.targetName;
  const livePerms  = { ..._shadowState.livePerms };

  // Persist to USERS
  const user = USERS.find(u => u.name === targetName);
  if (user) {
    user.permissions = livePerms;
    saveUsers(USERS);
  }

  // Restore admin session
  setCurrentUser(_shadowState.adminUser);
  document.getElementById('shadowBanner').classList.remove('active');
  document.body.classList.remove('shadow-mode');
  _shadowState.active = false;

  applyPermissions();
  logActivity('trainer', null, 'Permissions updated for ' + targetName + ' via preview', '');
  showToast('✓ Permissions saved for ' + targetName, 'success');

  // Re-open edit modal to confirm the saved state
  editTrainerPerms(targetName);
}

// =============================================
// LOGIN SYSTEM
// =============================================
function showLoginScreen() {
  const screen = document.getElementById('loginScreen');
  if (screen) screen.classList.remove('hidden');
}

function hideLoginScreen() {
  const screen = document.getElementById('loginScreen');
  if (screen) screen.classList.add('hidden');
}

function renderLoginScreen() {
  const grid = document.getElementById('loginUserGrid');
  if (!grid) return;
  if (!USERS.length) {
    grid.innerHTML = '<div class="login-no-users">No users set up yet.<br>Check back with your admin.</div>';
    return;
  }
  const roleInfo = (u) => {
    const p = u.permissions || {};
    if (p.manage_trainers) return { label: 'Admin', cls: 'admin' };
    if (p.edit_status || p.edit_trainer) return { label: 'Editor', cls: 'editor' };
    return { label: 'View Only', cls: 'viewer' };
  };
  grid.innerHTML = USERS.map(u => {
    const role = roleInfo(u);
    const initials = u.name.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
    return `<button class="login-user-btn" onclick="loginAs('${esc(u.name)}')">
      <div class="login-user-avatar">${initials}</div>
      <div class="login-user-name">${esc(u.name)}</div>
      <span class="login-user-badge ${role.cls}">${role.label}</span>
    </button>`;
  }).join('');
}

function loginAs(name) {
  const user = USERS.find(u => u.name === name);
  if (!user) return;
  if (!hasPin(name)) {
    // First time — route to PIN setup
    openPinScreen(name, 'setup');
  } else {
    // Has PIN — route to PIN entry
    openPinScreen(name, 'enter');
  }
}

function logout() {
  const cur = getCurrentUser();
  const name = cur ? cur.name : '';
  localStorage.removeItem(SESSION_KEY);
  localStorage.removeItem('streetDashboardUser');
  // Hide header user chip + logout button
  const chip = document.getElementById('headerUserChip');
  const logoutBtn = document.getElementById('logoutBtn');
  if (chip) chip.style.display = 'none';
  if (logoutBtn) logoutBtn.style.display = 'none';
  // Close panels
  closeActivityPanel();
  // Re-render login
  renderLoginScreen();
  showLoginScreen();
  if (name) logActivity('meta', null, name + ' logged out', '');
}

// =============================================
// PERMISSION GATING
// =============================================
function applyPermissions() {
  const u = getCurrentUser();
  if (!u) return;

  const canEditBookings   = hasPerm('edit_status') || hasPerm('edit_trainer') || hasPerm('edit_value') || hasPerm('edit_booked_date');
  const canManageTrainers = hasPerm('manage_trainers');
  const canRefresh        = hasPerm('refresh_data');
  const canViewKPIs       = hasPerm('view_kpis');
  const canViewCharts     = hasPerm('view_charts');
  const canViewActivity   = hasPerm('view_activity');
  const canClearActivity  = hasPerm('clear_activity');

  // Manage Trainers button
  const manageBtn = document.querySelector('button[onclick="openTrainerModal()"]');
  if (manageBtn) {
    manageBtn.style.display = canManageTrainers ? '' : 'none';
  }

  // Refresh + Test buttons
  document.querySelectorAll('.refresh-btn').forEach(btn => {
    if (btn.textContent.includes('Refresh') || btn.textContent.includes('Test')) {
      btn.classList.toggle('perm-hidden', !canRefresh);
    }
  });

  // KPI section
  const kpiGrid = document.querySelector('.kpi-grid');
  if (kpiGrid) kpiGrid.classList.toggle('perm-hidden', !canViewKPIs);
  const kpiTitle = [...document.querySelectorAll('.section-title')].find(el => el.textContent.includes('Performance Overview'));
  if (kpiTitle) kpiTitle.parentElement.classList.toggle('perm-hidden', !canViewKPIs);

  // Charts section
  const chartsGrid = document.querySelector('.charts-grid');
  if (chartsGrid) chartsGrid.classList.toggle('perm-hidden', !canViewCharts);

  // Activity button
  const actBtn = document.getElementById('activityNavBtn');
  if (actBtn) actBtn.classList.toggle('perm-hidden', !canViewActivity);

  // Update user display in activity panel
  const cur = getCurrentUser();
  if (cur) updateUserDisplay(cur.name);
}

// =============================================
// EDIT PERMISSIONS MODAL (for existing users)
// =============================================
function closeEditPermModal() {
  document.getElementById('editPermOverlay').classList.remove('open');
}


// =============================================
// GOOGLE CALENDAR INTEGRATION
// =============================================
const CAL_SETTINGS_KEY = 'streetCalSettings';

let calState = {
  year:      new Date().getFullYear(),
  month:     new Date().getMonth(),  // 0-indexed
  gcalEvents: [],   // fetched from Apps Script / GCal
  isFetching: false,
};

function getCalSettings() {
  try { return JSON.parse(localStorage.getItem(CAL_SETTINGS_KEY) || '{}'); } catch(e) { return {}; }
}
function saveCalSettingsData(obj) {
  try { localStorage.setItem(CAL_SETTINGS_KEY, JSON.stringify(obj)); } catch(e) {}
}

// ── Calendar Settings modal ──────────────────────────────────────────────────
function openCalSettings() {
  const s = getCalSettings();
  document.getElementById('calIdInput').value = s.calendarId || '';
  document.getElementById('calSettingsStatus').textContent = '';

  // Per-trainer optional calendar IDs
  const wrap = document.getElementById('calSettingsPerTrainer');
  if (TRAINERS.length) {
    wrap.innerHTML = '<div style="font-size:11px;font-weight:600;color:var(--text--dark--30);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.6px;">Optional: per-trainer calendar IDs</div>'
      + TRAINERS.map(t => `
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
          <span style="width:70px;font-size:12px;font-weight:600;color:var(--text--dark--40);flex-shrink:0;">${esc(t)}</span>
          <input type="text" id="calId-${esc(t)}" value="${esc((s.trainerCals||{})[t]||'')}"
            placeholder="Leave blank to use shared calendar"
            style="flex:1;border:1px solid var(--ui--underline--light-grey);border-radius:5px;padding:5px 8px;font-size:11px;font-family:Arial,sans-serif;">
        </div>`).join('');
  } else {
    wrap.innerHTML = '';
  }

  document.getElementById('calSettingsOverlay').classList.add('open');
}

function closeCalSettings() {
  document.getElementById('calSettingsOverlay').classList.remove('open');
}

function saveCalSettings() {
  const calId = document.getElementById('calIdInput').value.trim();
  const trainerCals = {};
  TRAINERS.forEach(t => {
    const inp = document.getElementById('calId-' + t);
    if (inp && inp.value.trim()) trainerCals[t] = inp.value.trim();
  });
  saveCalSettingsData({ calendarId: calId, trainerCals });
  document.getElementById('calSettingsStatus').textContent = '✓ Saved — syncing…';
  closeCalSettings();
  loadCalendarData(true);
}

// ── Fetch calendar events from Apps Script ────────────────────────────────────
async function loadCalendarData(force = false) {
  const s = getCalSettings();
  if (!s.calendarId && !Object.keys(s.trainerCals || {}).length) {
    // No calendar configured — just render with booking data only
    setCalStatus(false, 'No calendar connected — click ⚙ to add your Calendar ID');
    renderCalendar();
    renderUpcoming();
    populateCalTrainerFilter();
    return;
  }

  if (calState.isFetching && !force) return;
  calState.isFetching = true;
  setCalStatus(null, 'Syncing…');

  try {
    const params = new URLSearchParams({ action: 'getCalendarEvents' });
    if (s.calendarId) params.append('calendarId', s.calendarId);

    // Fetch 3-month window around current cal month
    const start = new Date(calState.year, calState.month - 1, 1);
    const end   = new Date(calState.year, calState.month + 2, 0);
    params.append('start', start.toISOString().slice(0,10));
    params.append('end',   end.toISOString().slice(0,10));

    const res  = await fetch(APPS_SCRIPT_URL + '?' + params.toString());
    const json = await res.json();

    if (json.success && json.events) {
      calState.gcalEvents = json.events.map(e => ({
        ...e,
        start: new Date(e.start),
        end:   new Date(e.end),
      }));
      setCalStatus(true, 'Synced — ' + calState.gcalEvents.length + ' events');
      logActivity('refresh', null, 'Calendar synced — ' + calState.gcalEvents.length + ' events loaded', '');
    } else {
      calState.gcalEvents = [];
      setCalStatus(false, json.error || 'Could not read calendar');
    }
  } catch(e) {
    calState.gcalEvents = [];
    setCalStatus(false, 'Could not reach Apps Script');
  }

  calState.isFetching = false;
  renderCalendar();
  renderUpcoming();
  populateCalTrainerFilter();
  updateTrainerAvailability();
}

function setCalStatus(ok, msg) {
  const dot   = document.getElementById('calGcalDot');
  const label = document.getElementById('calGcalStatus');
  if (!dot || !label) return;
  if (ok === true)  { dot.style.background = '#22c55e'; }
  else if (ok === null) { dot.style.background = '#f59e0b'; }
  else              { dot.style.background = '#e5e7eb'; }
  label.innerHTML = `<span id="calGcalDot" style="display:inline-block;width:7px;height:7px;border-radius:50%;background:${ok===true?'#22c55e':ok===null?'#f59e0b':'#e5e7eb'};margin-right:4px;vertical-align:middle;"></span>${esc(msg)}`;
}

// ── Calendar render ───────────────────────────────────────────────────────────
function calChangeMonth(dir) {
  calState.month += dir;
  if (calState.month > 11) { calState.month = 0;  calState.year++; }
  if (calState.month <  0) { calState.month = 11; calState.year--; }
  renderCalendar();
  renderUpcoming();
  loadCalendarData(); // fetch new window if needed
}

function populateCalTrainerFilter() {
  const sel = document.getElementById('calFilterTrainer');
  if (!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">All Trainers</option>'
    + TRAINERS.map(t => `<option value="${t}" ${t===cur?'selected':''}>${t}</option>`).join('');
}

function getCalDayEvents(dateStr, trainerFilter) {
  const events = [];
  // From bookings data
  allData.forEach(r => {
    if (r.status === 'Cancelled') return;
    const d = r.bookedOn
      ? (r.bookedOn.length >= 10 ? r.bookedOn.slice(0,10) : null)
      : (r.date ? r.date.toISOString().slice(0,10) : null);
    if (!d || d !== dateStr) return;
    if (trainerFilter && r.trainer !== trainerFilter) return;
    events.push({ type: 'booking', title: r.company || 'Booking', trainer: r.trainer, option: r.option, status: r.status });
  });
  // From Google Calendar
  calState.gcalEvents.forEach(e => {
    const es = e.start instanceof Date ? e.start.toISOString().slice(0,10) : String(e.start).slice(0,10);
    if (es !== dateStr) return;
    if (trainerFilter && e.trainer && e.trainer !== trainerFilter) return;
    events.push({ type: e.blocked ? 'blocked' : 'gcal', title: e.title || 'Event', trainer: e.trainer || '' });
  });
  return events;
}

function renderCalendar() {
  const { year, month } = calState;
  const tf = document.getElementById('calFilterTrainer')?.value || '';
  const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('calMonthTitle').textContent = months[month] + ' ' + year;

  const firstDay = new Date(year, month, 1);
  const lastDay  = new Date(year, month + 1, 0);
  const todayStr = new Date().toISOString().slice(0,10);

  // Start on Monday (ISO week)
  let startDow = firstDay.getDay(); // 0=Sun
  startDow = startDow === 0 ? 6 : startDow - 1; // convert to Mon=0

  const container = document.getElementById('calDays');
  if (!container) return;

  let cells = '';

  // Empty cells before first day
  for (let i = 0; i < startDow; i++) {
    cells += '<div class="cal-day cal-day-empty"></div>';
  }

  for (let d = 1; d <= lastDay.getDate(); d++) {
    const dateStr = year + '-' + String(month+1).padStart(2,'0') + '-' + String(d).padStart(2,'0');
    const isToday = dateStr === todayStr;
    const isPast  = dateStr < todayStr;
    const dayDate = new Date(year, month, d);
    const isWeekend = dayDate.getDay() === 0 || dayDate.getDay() === 6;
    const events  = getCalDayEvents(dateStr, tf);

    const shown = events.slice(0, 3);
    const extra = events.length - shown.length;

    cells += `<div class="cal-day${isToday?' cal-day-today':''}${isPast?' cal-day-past':''}${isWeekend?' cal-day-weekend':''}" data-date="${dateStr}">
      <span class="cal-day-num">${d}</span>
      ${shown.map(e => `<span class="cal-event cal-event-${e.type}" title="${esc(e.trainer?e.trainer+': ':'')}${esc(e.title)}">${esc(e.trainer?e.trainer+' – ':'')}${esc(e.title)}</span>`).join('')}
      ${extra > 0 ? `<span class="cal-event-more">+${extra} more</span>` : ''}
    </div>`;
  }

  container.innerHTML = cells;
}

// ── Upcoming sessions sidebar ─────────────────────────────────────────────────
function renderUpcoming() {
  const body = document.getElementById('calUpcomingBody');
  const count = document.getElementById('calUpcomingCount');
  if (!body) return;

  const todayStr = new Date().toISOString().slice(0,10);
  const limitStr = new Date(Date.now() + 60*86400*1000).toISOString().slice(0,10);

  // Collect all booked sessions in the next 60 days
  const items = [];
  allData.forEach(r => {
    if (r.status !== 'Booked') return;
    const d = r.bookedOn ? r.bookedOn.slice(0,10) : (r.date ? r.date.toISOString().slice(0,10) : null);
    if (!d || d < todayStr || d > limitStr) return;
    items.push({ date: d, company: r.company, trainer: r.trainer, option: r.option, optionLabel: r.optionLabel, source: 'booking' });
  });
  // Google Calendar events
  calState.gcalEvents.forEach(e => {
    const d = e.start instanceof Date ? e.start.toISOString().slice(0,10) : String(e.start).slice(0,10);
    if (d < todayStr || d > limitStr) return;
    items.push({ date: d, company: e.title, trainer: e.trainer||'', option: '', optionLabel: '', source: 'gcal' });
  });

  items.sort((a,b) => a.date.localeCompare(b.date));

  if (count) count.textContent = items.length + ' in next 60 days';

  if (!items.length) {
    body.innerHTML = '<div class="cal-upcoming-empty">No upcoming sessions found</div>';
    return;
  }

  const MONTHS_S = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  body.innerHTML = items.map(item => {
    const dt  = new Date(item.date + 'T00:00:00');
    const day = dt.getDate();
    const mon = MONTHS_S[dt.getMonth()];
    const dotColor = item.source === 'gcal' ? '#22c55e' : '#2147f4';
    return `<div class="cal-upcoming-item">
      <div class="cal-upcoming-date">
        <div class="cal-upcoming-date-day">${day}</div>
        <div class="cal-upcoming-date-mon">${mon}</div>
      </div>
      <div class="cal-upcoming-body-text">
        <div class="cal-upcoming-company">${esc(item.company||'—')}</div>
        <div class="cal-upcoming-meta">
          ${item.trainer ? `<span style="color:var(--action-primary-blue);font-weight:600;">${esc(item.trainer)}</span> · ` : ''}
          ${item.optionLabel ? 'Opt '+item.option+' · ' : ''}
          <span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:${dotColor};vertical-align:middle;margin-right:3px;"></span>
          ${item.source === 'gcal' ? 'Google Calendar' : 'Booking'}
        </div>
      </div>
    </div>`;
  }).join('');
}

// ── Trainer availability badges on workload cards ─────────────────────────────
function updateTrainerAvailability() {
  const todayStr = new Date().toISOString().slice(0,10);
  const lookahead = 21; // days to scan for next free day

  TRAINERS.forEach(trainer => {
    const el = document.getElementById('avail-' + trainer.replace(/\s/g,'_'));
    if (!el) return;

    // Collect busy dates (bookings + gcal events for this trainer)
    const busyDates = new Set();
    allData.forEach(r => {
      if (r.trainer !== trainer || r.status === 'Cancelled') return;
      const d = r.bookedOn ? r.bookedOn.slice(0,10) : (r.date ? r.date.toISOString().slice(0,10) : null);
      if (d) busyDates.add(d);
    });
    calState.gcalEvents.forEach(e => {
      if (e.trainer && e.trainer !== trainer) return;
      const d = e.start instanceof Date ? e.start.toISOString().slice(0,10) : String(e.start).slice(0,10);
      busyDates.add(d);
    });

    // Find next free weekday
    let nextFree = null;
    for (let i = 1; i <= lookahead; i++) {
      const d = new Date(Date.now() + i * 86400000);
      if (d.getDay() === 0 || d.getDay() === 6) continue; // skip weekends
      const ds = d.toISOString().slice(0,10);
      if (!busyDates.has(ds)) { nextFree = d; break; }
    }

    if (nextFree) {
      const label = nextFree.toLocaleDateString('en-GB', { weekday:'short', day:'numeric', month:'short' });
      el.className = 'trainer-availability';
      el.innerHTML = '📅 Next free: <strong>' + label + '</strong>';
    } else {
      el.className = 'trainer-availability busy';
      el.innerHTML = '🔴 Busy next ' + lookahead + ' days';
    }
  });
}

// =============================================
// INIT
// =============================================
syncTrainersFromUsers();
migrateUsers();
renderLoginScreen();

const _sessionUser = getCurrentUser();
if (_sessionUser) {
  hideLoginScreen();
  updateHeaderUser(_sessionUser.name);
  initActivityFeed();
  applyPermissions();
} else {
  showLoginScreen();
  initActivityFeed();
}

loadData();
loadCalendarData();
// Auto-refresh every 5 minutes
setInterval(loadData, 5 * 60 * 1000);
// Auto-refresh calendar every 10 minutes
setInterval(() => loadCalendarData(true), 10 * 60 * 1000);
</script>

<!-- ACTIVITY PANEL OVERLAY -->
<div class="activity-panel-overlay" id="activityPanelOverlay" onclick="closeActivityPanel()"></div>

<!-- ACTIVITY PANEL -->
<div class="activity-panel" id="activityPanel">
  <div class="activity-panel-header">
    <div>
      <div class="activity-panel-title">🕐 Activity Feed</div>
      <div class="activity-panel-sub">All changes made on this dashboard</div>
    </div>
    <button class="activity-close" onclick="closeActivityPanel()">✕</button>
  </div>
  <div class="activity-user-bar">
    <div class="activity-user-avatar" id="activityAvatar">?</div>
    <div class="activity-user-name" id="activityUserDisplay">Not set</div>
    <button onclick="changeSelfPin()" style="font-size:11px;background:none;border:none;color:var(--action-primary-blue);cursor:pointer;font-family:Arial,sans-serif;padding:0;text-decoration:underline;">Change PIN</button>
  </div>
  <div class="activity-toolbar">
    <span class="activity-count" id="activityCount">0 events</span>
    <button class="activity-clear-btn" onclick="clearActivityLog()">🗑 Clear log</button>
  </div>
  <div class="activity-feed-body" id="activityFeedBody">
    <div class="activity-empty">
      <div class="activity-empty-icon">📋</div>
      No activity yet — changes you make will appear here
    </div>
  </div>
</div>

<!-- USERNAME PROMPT MODAL -->
<div class="username-modal-overlay" id="usernameModalOverlay">
  <div class="username-modal">
    <div class="username-modal-icon">👤</div>
    <div class="username-modal-title">Who are you?</div>
    <div class="username-modal-sub">Your name will be recorded in the activity feed whenever you make a change to the dashboard.</div>
    <input type="text" id="usernameInput" placeholder="Enter your name…" maxlength="40"
      onkeydown="if(event.key==='Enter') saveUsername()">
    <button class="btn btn-primary" style="width:100%;justify-content:center;" onclick="saveUsername()">Set Name &amp; Continue</button>
  </div>
</div>


<!-- EDIT PERMISSIONS MODAL -->
<div class="username-modal-overlay" id="editPermOverlay" style="z-index:800;">
  <div class="username-modal" style="width:520px;max-width:96vw;padding:0;text-align:left;border-radius:10px;overflow:hidden;">
    <div style="padding:18px 22px 14px;background:var(--text--dark--50);color:#fff;display:flex;align-items:center;justify-content:space-between;">
      <div>
        <div style="font-size:14px;font-weight:700;">Edit Permissions</div>
        <div style="font-size:11px;color:rgba(255,255,255,0.6);margin-top:2px;" id="editPermName">—</div>
      </div>
      <button onclick="closeEditPermModal()" style="background:rgba(255,255,255,0.1);border:none;color:#fff;cursor:pointer;padding:5px 9px;border-radius:4px;font-size:16px;">✕</button>
    </div>
    <div style="padding:10px 20px;background:#f6f8ff;border-bottom:1px solid #e0e8ff;display:flex;align-items:center;gap:10px;">
      <span style="font-size:12px;color:var(--text--dark--40);flex:1;">Adjust toggles below, then preview the dashboard exactly as this user would see it.</span>
      <button class="btn" id="shadowPreviewBtn" onclick="enterShadowMode()"
        style="background:#7c3aed;color:#fff;border:none;font-size:12px;padding:6px 14px;gap:6px;">
        👁 Preview as <span id="shadowBtnName">—</span>
      </button>
    </div>
    <div id="editPermBody" style="padding:16px 20px;max-height:340px;overflow-y:auto;"></div>
    <div style="padding:12px 20px;border-top:1px solid var(--ui--underline--light-grey);background:var(--card-light-grey);display:flex;justify-content:flex-end;gap:8px;">
      <button class="btn btn-ghost" onclick="closeEditPermModal()">Cancel</button>
      <button class="btn btn-primary" id="editPermSaveBtn">Save Permissions</button>
    </div>
  </div>
</div>


<!-- CALENDAR SETTINGS MODAL -->
<div class="username-modal-overlay" id="calSettingsOverlay" onclick="if(event.target===this)closeCalSettings()">
  <div class="username-modal" style="width:480px;max-width:96vw;padding:0;text-align:left;border-radius:10px;overflow:hidden;">
    <div style="padding:18px 22px 14px;background:var(--text--dark--50);color:#fff;display:flex;align-items:center;justify-content:space-between;">
      <div>
        <div style="font-size:14px;font-weight:700;">📅 Google Calendar Settings</div>
        <div style="font-size:11px;color:rgba(255,255,255,0.6);margin-top:2px;">Connect your shared team calendar</div>
      </div>
      <button onclick="closeCalSettings()" style="background:rgba(255,255,255,0.1);border:none;color:#fff;cursor:pointer;padding:5px 9px;border-radius:4px;font-size:16px;">✕</button>
    </div>
    <div style="padding:20px;">
      <div style="font-size:12px;color:var(--text--dark--40);margin-bottom:16px;line-height:1.6;background:#f6f8ff;padding:10px 12px;border-radius:6px;border:1px solid #e0e8ff;">
        <strong>How to find your Calendar ID:</strong><br>
        Google Calendar → Settings → Click your calendar → Scroll to "Integrate calendar" → Copy the Calendar ID
      </div>
      <label style="font-size:12px;font-weight:600;color:var(--text--dark--40);display:block;margin-bottom:6px;">Shared Team Calendar ID</label>
      <input type="text" id="calIdInput" placeholder="e.g. abc123@group.calendar.google.com"
        style="width:100%;box-sizing:border-box;border:1.5px solid var(--ui--underline--light-grey);border-radius:6px;padding:9px 12px;font-size:13px;font-family:Arial,sans-serif;margin-bottom:16px;">
      <div style="font-size:11px;color:var(--text--dark--30);margin-bottom:10px;">
        💡 The calendar must also be accessible from your Apps Script (the script owner needs to be shared on the calendar).
      </div>
      <div id="calSettingsPerTrainer" style="margin-bottom:16px;"></div>
    </div>
    <div style="padding:12px 20px;border-top:1px solid var(--ui--underline--light-grey);background:var(--card-light-grey);display:flex;justify-content:space-between;gap:8px;align-items:center;">
      <span id="calSettingsStatus" style="font-size:11px;color:var(--text--dark--30);"></span>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-ghost" onclick="closeCalSettings()">Cancel</button>
        <button class="btn btn-primary" onclick="saveCalSettings()">Save &amp; Sync</button>
      </div>
    </div>
  </div>
</div>

</body>
</html>
